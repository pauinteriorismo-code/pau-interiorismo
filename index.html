<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAU INTERIORISMO ¬∑ Gesti√≥n</title>
<style>
:root{--navy:#1a2a3a;--navy-mid:#27405b;--navy-light:#3d5a78;--blue-soft:#b8cce4;--blue-light:#e8f4ff;--cream:#f7f4ef;--sand:#ede8df;--copper:#b87333;--copper-light:#f4e8da;--green:#1e6b3d;--green-soft:#d5e8d4;--amber:#7d6608;--amber-soft:#fff2cc;--red:#7b241c;--red-soft:#fce8e6;--white:#fff;--text:#1a2a3a;--text-mid:#4a5f72;--text-soft:#8a9aaa;--border:#dce6f0;--radius:8px;--radius-sm:4px;--shadow:0 1px 3px rgba(26,42,58,.08),0 4px 16px rgba(26,42,58,.06);--shadow-lg:0 8px 32px rgba(26,42,58,.14);--sidebar:220px;--header:56px}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;color:var(--text);background:var(--cream)}
button,input,select,textarea{font-family:inherit}button{cursor:pointer}
/* LOGIN */
.login-screen{position:fixed;inset:0;background:var(--navy);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:var(--white);border-radius:var(--radius);padding:40px;width:340px;box-shadow:var(--shadow-lg);text-align:center}
.login-logo{font-size:15px;font-weight:700;color:var(--navy);letter-spacing:.06em;margin-bottom:4px}
.login-sub{font-size:10px;color:var(--text-soft);margin-bottom:28px;letter-spacing:.08em;text-transform:uppercase}
.login-error{background:var(--red-soft);color:var(--red);font-size:12px;padding:8px 12px;border-radius:var(--radius-sm);margin-bottom:12px;display:none}
/* APP */
.app{display:flex;height:100vh;overflow:hidden}
/* SIDEBAR */
.sidebar{width:var(--sidebar);background:var(--navy);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;z-index:10}
.sidebar-logo{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-size:13px;font-weight:700;color:#fff;letter-spacing:.04em}
.brand-sub{font-size:10px;color:rgba(255,255,255,.35);letter-spacing:.08em;text-transform:uppercase;margin-top:2px}
.nav-section{padding:12px 0 4px}
.nav-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.3);padding:0 16px 5px}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 16px;cursor:pointer;font-size:12px;color:rgba(255,255,255,.6);border-left:2px solid transparent;transition:all .15s;white-space:nowrap}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:var(--copper)}
.nav-item .ni{font-size:13px;width:16px;text-align:center}
.nav-badge{margin-left:auto;background:var(--copper);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px}
.sidebar-bottom{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.08)}
.user-card{display:flex;align-items:center;gap:8px}
.user-av{width:28px;height:28px;border-radius:50%;background:var(--copper);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.user-name{font-size:12px;color:rgba(255,255,255,.8);font-weight:600}
.user-role{font-size:10px;color:rgba(255,255,255,.35)}
/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:var(--header);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:10px;flex-shrink:0}
.topbar-title{font-size:14px;font-weight:700;color:var(--navy)}
.topbar-bc{font-size:11px;color:var(--text-soft);margin-top:1px}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:7px}
.content{flex:1;overflow-y:auto;padding:18px 20px}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;border:none;transition:all .15s;cursor:pointer}
.btn-primary{background:var(--navy-mid);color:#fff}.btn-primary:hover{background:var(--navy)}
.btn-ghost{background:transparent;color:var(--text-mid);border:1px solid var(--border)}.btn-ghost:hover{background:var(--sand)}
.btn-copper{background:var(--copper);color:#fff}.btn-copper:hover{background:#9a6028}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#621a14}
.btn-sm{padding:4px 9px;font-size:11px}
.btn-icon{padding:5px;width:28px;height:28px;justify-content:center}
/* CARDS */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;border-bottom:1px solid var(--border)}
.card-title{font-size:13px;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:7px}
.card-body{padding:14px 16px}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.kpi{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:13px 15px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.kpi.blue::before{background:var(--navy-mid)}.kpi.green::before{background:var(--green)}
.kpi.amber::before{background:var(--copper)}.kpi.red::before{background:var(--red)}
.kpi.purple::before{background:#6b3fa0}
.kpi-label{font-size:11px;color:var(--text-soft);font-weight:500}
.kpi-value{font-size:19px;font-weight:700;color:var(--navy);margin:3px 0;font-variant-numeric:tabular-nums}
.kpi-sub{font-size:11px;color:var(--text-soft)}
/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--navy);color:#fff;padding:8px 10px;text-align:left;font-size:11px;font-weight:600;letter-spacing:.04em;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--blue-light)}
tbody td{padding:7px 10px;vertical-align:middle}
.td-mono{font-family:'Courier New',monospace;font-size:11px}
.td-actions{display:flex;gap:3px}
/* BADGES */
.badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap}
.b-green{background:var(--green-soft);color:var(--green)}.b-amber{background:var(--amber-soft);color:var(--amber)}
.b-red{background:var(--red-soft);color:var(--red)}.b-blue{background:var(--blue-light);color:var(--navy-mid)}
.b-navy{background:var(--navy);color:#fff}.b-copper{background:var(--copper-light);color:var(--copper)}
.b-gray{background:var(--sand);color:var(--text-mid)}
/* VIEWS */
.view{display:none}.view.active{display:block}
/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-full{grid-column:1/-1}.fg-3{grid-column:span 1}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:11px;font-weight:600;color:var(--text-mid)}
.form-input{padding:7px 9px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;width:100%}
.form-input:focus{border-color:var(--navy-mid);box-shadow:0 0 0 3px rgba(39,64,91,.1)}
.form-input[readonly]{background:var(--sand);color:var(--text-soft)}
.form-input.calc{background:var(--green-soft);color:var(--green);font-weight:700}
.form-input.winner{background:var(--green-soft);color:var(--green);font-weight:700}
/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--white);border-radius:var(--radius);width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);transform:translateY(10px);transition:transform .2s}
.overlay.open .modal{transform:translateY(0)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:1}
.modal-title{font-size:14px;font-weight:700;color:var(--navy)}
.modal-close{background:none;border:none;font-size:22px;color:var(--text-soft);line-height:1;padding:0}
.modal-body{padding:20px}
.modal-foot{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;position:sticky;bottom:0;background:var(--white)}
.modal-section{font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.08em;margin:16px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
/* INFO BOX */
.info-box{background:var(--blue-light);border:1px solid var(--blue-soft);border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--navy-mid);margin-bottom:14px}
.warn-box{background:var(--amber-soft);border:1px solid #e6c80a;border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--amber);margin-bottom:14px}
/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px}
.search-wrap input{padding-left:30px}
.search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-soft);font-size:12px;pointer-events:none}
/* EMPTY / LOADING */
.loading{text-align:center;padding:35px;color:var(--text-soft);font-size:13px}
.empty{text-align:center;padding:45px 20px;color:var(--text-soft)}
.empty-icon{font-size:38px;margin-bottom:10px}.empty-text{font-size:13px;margin-bottom:14px}
/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:11px 18px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:999;box-shadow:var(--shadow-lg);transform:translateY(20px);opacity:0;transition:all .3s;max-width:300px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green)}.toast.error{background:var(--red)}
/* CONFIRM */
.confirm-overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:var(--white);border-radius:var(--radius);padding:26px;width:330px;box-shadow:var(--shadow-lg);text-align:center}
.confirm-title{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:8px}
.confirm-text{font-size:13px;color:var(--text-mid);margin-bottom:18px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
/* CONTROL HORARIO */
.horario-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
.horario-day{background:var(--white);border:1px solid var(--border);border-radius:4px;padding:5px;text-align:center;font-size:11px;cursor:pointer;min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .15s}
.horario-day:hover{border-color:var(--navy-mid);background:var(--blue-light)}
.horario-day.weekend{background:var(--sand)}.horario-day.festivo{background:var(--amber-soft)}
.horario-day.trabajado{background:var(--green-soft);border-color:var(--green)}
.horario-day.ausente{background:var(--red-soft);border-color:var(--red)}
.horario-day-num{font-weight:700;font-size:12px;color:var(--navy)}
.horario-day-h{font-size:10px;color:var(--green);font-weight:600}
.day-header{background:var(--navy);color:#fff;padding:5px;text-align:center;font-size:10px;font-weight:700;border-radius:4px}
/* COMPARATIVA */
.oferta-col{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative}
.oferta-col.ganadora{border-color:var(--green);background:var(--green-soft)}
.oferta-col.ganadora::before{content:'‚úÖ ELEGIDA';position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;font-size:10px;font-weight:700;padding:2px 10px;border-radius:10px}
.oferta-title{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px;text-align:center}
/* TABS */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px}
.tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--text-soft);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--navy)}.tab.active{color:var(--navy);border-bottom-color:var(--copper)}
.tab-content{display:none}.tab-content.active{display:block}
/* CONTABILIDAD */
.cuenta-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.cuenta-row.header{background:var(--navy);color:#fff;font-weight:700;border-radius:4px 4px 0 0}
.cuenta-row.total{background:var(--sand);font-weight:700}
.cuenta-row.result{background:var(--green-soft);font-weight:700;color:var(--green)}
.cuenta-row.result.neg{background:var(--red-soft);color:var(--red)}
/* PROG BAR */
.prog-wrap{background:var(--sand);border-radius:4px;height:16px;overflow:hidden;margin:6px 0}
.prog-bar{height:100%;border-radius:4px;transition:width .5s}
.lista-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--sand);border-radius:var(--radius-sm);font-size:12px;margin-bottom:5px}
.lista-item:hover{background:var(--blue-light)}
@media(max-width:768px){.sidebar{width:52px}.brand,.brand-sub,.nav-label,.nav-item span:not(.ni),.nav-badge,.user-name,.user-role{display:none}.nav-item{justify-content:center;padding:9px}.kpi-grid,.kpi-grid-3{grid-template-columns:1fr 1fr}.form-grid{grid-template-columns:1fr}.fg-full{grid-column:1}.content{padding:12px}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT STYLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media print {
  /* Hide everything except the document */
  .sidebar, .topbar, .search-bar, .btn, 
  .nav-item, .overlay, .toast, .confirm-overlay,
  #login-screen { display: none !important; }
  
  /* Reset layout */
  body { background: white !important; }
  .app { display: block !important; }
  .main { display: block !important; overflow: visible !important; }
  .content { padding: 0 !important; overflow: visible !important; }
  
  /* Hide all views except the active one */
  .view { display: none !important; }
  .view.active { display: block !important; }
  
  /* Hide search bar and controls inside active view */
  .view.active .search-bar { display: none !important; }
  .view.active .kpi, .view.active .card:not(#pf-doc):not(#ct-doc):not(#pd-doc) { display: none !important; }
  
  /* Show ONLY the document div */
  #pf-doc, #ct-doc, #pd-doc {
    display: block !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    padding: 20mm !important;
    max-width: 100% !important;
    width: 210mm !important;
    min-height: 297mm !important;
    font-size: 11pt !important;
    page-break-after: always;
  }

  /* Page setup */
  @page {
    size: A4;
    margin: 0;
  }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">PAU INTERIORISMO S.L.</div>
    <div class="login-sub">Sistema de gesti√≥n ¬∑ Acceso privado</div>
    <div class="login-error" id="login-error">Usuario o contrase√±a incorrectos</div>
    <div class="form-group" style="margin-bottom:11px;text-align:left"><label class="form-label">Usuario</label><input class="form-input" id="login-user" placeholder="usuario" autocomplete="username"></div>
    <div class="form-group" style="margin-bottom:18px;text-align:left"><label class="form-label">Contrase√±a</label><input class="form-input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px" onclick="doLogin()">Entrar ‚Üí</button>
  </div>
</div>

<!-- APP -->
<div class="app">
<nav class="sidebar">
  <div class="sidebar-logo"><div class="brand">PAU INTERIORISMO</div><div class="brand-sub">Sistema de gesti√≥n</div></div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" data-view="gerencia"><span class="ni">üè†</span><span>Gerencia</span></div>
    <div class="nav-item" data-view="clientes"><span class="ni">ü§ù</span><span>Clientes</span></div>
    <div class="nav-item" data-view="proyectos"><span class="ni">üìÅ</span><span>Proyectos</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Presupuestaci√≥n</div>
    <div class="nav-item" data-view="presupuesto"><span class="ni">üí∞</span><span>Presupuesto</span></div>
    <div class="nav-item" data-view="comparativa"><span class="ni">‚öñÔ∏è</span><span>Comparativa ofertas</span></div>
    <div class="nav-item" data-view="tarifario"><span class="ni">üìã</span><span>Tarifario</span></div>
    <div class="nav-item" data-view="cype"><span class="ni">üìê</span><span>CYPE 2026</span><span class="nav-badge" id="cype-badge">524</span></div>
    <div class="nav-item" data-view="interiorismo"><span class="ni">üõã</span><span>Interiorismo</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Ejecuci√≥n</div>
    <div class="nav-item" data-view="compras"><span class="ni">üõí</span><span>Compras</span></div>
    <div class="nav-item" data-view="subcontratas"><span class="ni">üë∑</span><span>Subcontratas</span></div>
    <div class="nav-item" data-view="horas"><span class="ni">‚è±</span><span>Horas</span></div>
    <div class="nav-item" data-view="pedidos"><span class="ni">üì¶</span><span>Pedidos</span></div>
    <div class="nav-item" data-view="control_horario"><span class="ni">üìÖ</span><span>Control horario</span></div>
    <div class="nav-item" data-view="proveedores"><span class="ni">üè≠</span><span>Proveedores</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Cierre</div>
    <div class="nav-item" data-view="rentabilidad"><span class="ni">üìà</span><span>Rentabilidad</span></div>
    <div class="nav-item" data-view="facturas"><span class="ni">üßæ</span><span>Facturas</span></div>
    <div class="nav-item" data-view="contabilidad"><span class="ni">üìä</span><span>Contabilidad</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Sistema</div>
    <div class="nav-item" data-view="pres_final"><span class="ni">üìÑ</span><span>Presupuesto final</span></div>
    <div class="nav-item" data-view="contrato"><span class="ni">üìù</span><span>Contrato</span></div>
    <div class="nav-item" data-view="pedido_doc"><span class="ni">üìã</span><span>Doc. Pedido</span></div>
    <div class="nav-item" data-view="listas"><span class="ni">üóÇ</span><span>Listas</span></div>
    <div class="nav-item" data-view="configuracion"><span class="ni">‚öôÔ∏è</span><span>Configuraci√≥n</span></div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card"><div class="user-av" id="user-av">JA</div><div><div class="user-name" id="user-name">Jose</div><div class="user-role">Administrador</div></div></div>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <div><div class="topbar-title" id="tb-title">Gerencia ¬∑ Panel ejecutivo</div><div class="topbar-bc" id="tb-bc">Datos en tiempo real</div></div>
    <div class="topbar-right">
      <div id="conn-status" style="font-size:11px;padding:3px 9px;border-radius:10px;background:var(--amber-soft);color:var(--amber);font-weight:600">‚è≥ Conectando‚Ä¶</div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('m-quick')">Ôºã Nuevo</button>
    </div>
  </div>

  <div class="content">


    <!-- ‚ïê‚ïê‚ïê PRESUPUESTO FINAL ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pres_final">
      <div class="search-bar">
        <select class="form-input" style="width:270px" id="pf-proyecto-sel" onchange="loadPresupuestoFinal()"><option value="">Seleccionar proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:75px" id="pf-version-sel" onchange="loadPresupuestoFinal()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="pf-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-family:Arial,sans-serif;font-size:12px">
        <!-- Cabecera empresa -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;margin-top:3px">C/ Tom√°s y Valiente N¬∫ 6 Bajo, 46290 Alc√†sser (Valencia)</div>
            <div style="color:#666">Tel: 961 20 01 87 ¬∑ info@pauinteriorismo.com</div>
            <div style="color:#666">CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333;letter-spacing:.05em">PRESUPUESTO</div>
            <div id="pf-num" style="font-size:13px;color:#1a2a3a;margin-top:4px"></div>
            <div id="pf-fecha" style="color:#666;font-size:11px"></div>
          </div>
        </div>
        <!-- Datos cliente -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">CLIENTE</div>
            <div id="pf-cliente-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-cliente-cif" style="color:#666"></div>
            <div id="pf-cliente-dir" style="color:#666"></div>
          </div>
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">PROYECTO</div>
            <div id="pf-proyecto-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-proyecto-dir" style="color:#666"></div>
          </div>
        </div>
        <!-- Tabla l√≠neas -->
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px">
          <thead>
            <tr style="background:#1a2a3a;color:white">
              <th style="padding:8px;text-align:left">Descripci√≥n</th>
              <th style="padding:8px;text-align:center;width:40px">Ud.</th>
              <th style="padding:8px;text-align:right;width:60px">Cant.</th>
              <th style="padding:8px;text-align:right;width:90px">P.Unitario</th>
              <th style="padding:8px;text-align:right;width:90px">Subtotal</th>
            </tr>
          </thead>
          <tbody id="pf-lineas"></tbody>
        </table>
        <!-- Totales -->
        <div style="display:flex;justify-content:flex-end">
          <div style="width:250px">
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>Base imponible</span><span id="pf-base">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>IVA (10%)</span><span id="pf-iva">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between;padding:9px 0;font-size:14px;font-weight:700;color:#1a2a3a"><span>TOTAL</span><span id="pf-total">‚Äî</span></div>
          </div>
        </div>
        <!-- Condiciones -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid #ddd;color:#888;font-size:10px">
          <strong style="color:#333">Condiciones:</strong> Presupuesto v√°lido por 30 d√≠as desde su emisi√≥n. Los precios incluyen mano de obra y materiales salvo indicaci√≥n contraria. IVA no incluido salvo indicaci√≥n. 
          En caso de aceptaci√≥n, s√≠rvase firmar y devolver una copia.
        </div>
        <div style="margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:30px">
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma PAU INTERIORISMO S.L.</div></div>
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma y conformidad del cliente</div></div>
        </div>
        <div id="pf-empty" class="empty" style="display:none"><div class="empty-icon">üìÑ</div><div class="empty-text">Selecciona un proyecto para generar el presupuesto</div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTRATO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-contrato">
      <div class="search-bar">
        <select class="form-input" style="width:270px" id="ct-proyecto-sel" onchange="loadContrato()"><option value="">Seleccionar proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:180px" id="ct-pres-sel"><option value="">Presupuesto vinculado‚Ä¶</option></select>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="ct-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;line-height:1.7;font-family:Arial,sans-serif">
        <div style="text-align:center;margin-bottom:24px">
          <div style="font-size:16px;font-weight:700;color:#1a2a3a;border-bottom:2px solid #b87333;padding-bottom:8px">CONTRATO DE OBRA CIVIL Y SERVICIOS DE INTERIORISMO</div>
        </div>
        <div style="text-align:right;color:#666;margin-bottom:18px">En Valencia, a <span id="ct-fecha">[FECHA]</span></div>
        <div style="margin-bottom:16px"><strong>REUNIDOS</strong></div>
        <div style="margin-bottom:12px">De una parte: <strong>PAU INTERIORISMO S.L.</strong>, con CIF <strong>B-56909641</strong>, domicilio en C/ Tom√°s y Valiente N¬∫ 6 Bajo, 46290 Alc√†sser (Valencia), en adelante <em>LA EMPRESA</em>.</div>
        <div style="margin-bottom:18px">De otra parte: <strong id="ct-cliente-nombre">[CLIENTE]</strong>, con CIF/NIF <strong id="ct-cliente-cif">[CIF]</strong>, domicilio en <span id="ct-cliente-dir">[DIRECCI√ìN]</span>, en adelante <em>EL CLIENTE</em>.</div>
        <div style="margin-bottom:12px"><strong>EXPONEN</strong></div>
        <div style="margin-bottom:8px">I. Que LA EMPRESA se dedica profesionalmente a la ejecuci√≥n de obras de reforma y proyectos de interiorismo.</div>
        <div style="margin-bottom:18px">II. Que EL CLIENTE est√° interesado en contratar los servicios de LA EMPRESA para la realizaci√≥n de los trabajos descritos en el presupuesto aceptado.</div>
        <div style="margin-bottom:12px"><strong>ACUERDAN</strong></div>
        <div style="margin-bottom:8px"><strong>PRIMERA. OBJETO DEL CONTRATO</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA se compromete a ejecutar los trabajos de reforma e interiorismo descritos en el presupuesto n¬∫ <strong id="ct-pres-id">[PRES]</strong> para el proyecto <strong id="ct-proyecto-nombre">[PROYECTO]</strong>, sito en <span id="ct-proyecto-dir">[DIRECCI√ìN OBRA]</span>.</div>
        <div style="margin-bottom:8px"><strong>SEGUNDA. PRECIO</strong></div>
        <div style="margin-bottom:14px">El precio total de los trabajos asciende a <strong id="ct-importe">[IMPORTE]</strong> (IVA incluido), seg√∫n el presupuesto aceptado por el cliente.</div>
        <div style="margin-bottom:8px"><strong>TERCERA. FORMA DE PAGO</strong></div>
        <div style="margin-bottom:4px">El pago se realizar√° de la siguiente forma:</div>
        <div style="margin-left:16px;margin-bottom:14px">
          <div>‚Äî 40% a la firma del presente contrato</div>
          <div>‚Äî 30% al inicio de los trabajos</div>
          <div>‚Äî 30% a la finalizaci√≥n y entrega de la obra</div>
        </div>
        <div style="margin-bottom:8px"><strong>CUARTA. PLAZO DE EJECUCI√ìN</strong></div>
        <div style="margin-bottom:14px">El plazo estimado de ejecuci√≥n es de <input id="ct-plazo" style="border:none;border-bottom:1px solid #333;width:40px;text-align:center;font-size:12px" value="90"> d√≠as naturales, contados desde la fecha de inicio de los trabajos.</div>
        <div style="margin-bottom:8px"><strong>QUINTA. MODIFICACIONES</strong></div>
        <div style="margin-bottom:14px">Cualquier modificaci√≥n del proyecto inicial deber√° ser acordada por escrito entre ambas partes y dar√° lugar a un presupuesto adicional.</div>
        <div style="margin-bottom:8px"><strong>SEXTA. GARANT√çAS</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA garantiza los trabajos realizados por un per√≠odo de 1 a√±o desde la fecha de entrega, excepto los desperfectos ocasionados por mal uso del cliente.</div>
        <div style="margin-bottom:8px"><strong>S√âPTIMA. CAUSAS DE RESOLUCI√ìN</strong></div>
        <div style="margin-bottom:14px">El incumplimiento de las obligaciones por cualquiera de las partes dar√° derecho a la otra parte a resolver el contrato, con las indemnizaciones que procedan.</div>
        <div style="margin-bottom:8px"><strong>OCTAVA. PROTECCI√ìN DE DATOS</strong></div>
        <div style="margin-bottom:20px">Los datos personales facilitados ser√°n tratados conforme al RGPD (UE) 2016/679.</div>
        <div style="margin-bottom:20px">Y en prueba de conformidad, firman el presente contrato por duplicado en el lugar y fecha indicados.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:32px">
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por LA EMPRESA<br><strong>PAU INTERIORISMO S.L.</strong></div></div>
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por EL CLIENTE<br><strong id="ct-firma-cliente">[CLIENTE]</strong></div></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PEDIDO DOC ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pedido_doc">
      <div class="search-bar">
        <select class="form-input" style="width:270px" id="pd-pedido-sel" onchange="loadPedidoDoc()"><option value="">Seleccionar pedido‚Ä¶</option></select>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="pd-doc" style="background:white;max-width:700px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;font-family:Arial,sans-serif">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;font-size:11px">C/ Tom√°s y Valiente N¬∫ 6 Bajo, 46290 Alc√†sser</div>
            <div style="color:#666;font-size:11px">info@pauinteriorismo.com ¬∑ Tel: 961 20 01 87 ¬∑ CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333">PEDIDO</div>
            <div id="pd-num" style="font-size:13px;font-weight:700"></div>
            <div id="pd-fecha" style="color:#666;font-size:11px"></div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">PROVEEDOR</div>
            <div id="pd-prov-nombre" style="font-weight:700"></div>
            <div id="pd-prov-tel" style="color:#666"></div>
            <div id="pd-prov-email" style="color:#666"></div>
          </div>
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">PROYECTO</div>
            <div id="pd-proyecto" style="font-weight:700"></div>
            <div id="pd-tipo" style="color:#666"></div>
          </div>
        </div>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead><tr style="background:#1a2a3a;color:white"><th style="padding:8px;text-align:left">Descripci√≥n / Concepto</th><th style="padding:8px;text-align:right;width:100px">Importe</th></tr></thead>
          <tbody>
            <tr style="border-bottom:1px solid #eee"><td style="padding:10px" id="pd-concepto">‚Äî</td><td style="padding:10px;text-align:right;font-weight:700" id="pd-importe">‚Äî</td></tr>
          </tbody>
        </table>
        <div style="padding:12px;background:#fff2cc;border-radius:4px;font-size:11px;color:#7d6608;margin-bottom:20px">
          <strong>NOTA:</strong> <span id="pd-obs">Servir lo antes posible. Direcci√≥n de entrega: <em id="pd-proyecto-dir"></em></span>
        </div>
        <div style="color:#666;font-size:10px;text-align:center;border-top:1px solid #eee;padding-top:12px">
          PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ info@pauinteriorismo.com
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LISTAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-listas">
      <div class="info-box">üóÇ Gestiona los valores de los desplegables de toda la aplicaci√≥n. Los cambios se guardan autom√°ticamente.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
        
        <div class="card">
          <div class="card-header"><div class="card-title">üë∑ Trabajadores</div><button class="btn btn-ghost btn-sm" onclick="addListItem('trabajadores-list','trabajador')">Ôºã A√±adir</button></div>
          <div class="card-body" id="trabajadores-list">
            <div class="lista-item" data-val="Paco">Paco</div>
            <div class="lista-item" data-val="Ra√∫l">Ra√∫l</div>
            <div class="lista-item" data-val="Boro">Boro</div>
            <div class="lista-item" data-val="Julio">Julio</div>
            <div class="lista-item" data-val="Pau">Pau</div>
            <div class="lista-item" data-val="Jose Asins">Jose Asins</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üìÅ Estados proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estados-list','estado')">Ôºã A√±adir</button></div>
          <div class="card-body" id="estados-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üèó Tipos proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proyecto-list','tipo')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-proyecto-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üí∂ IVA</div><small style="color:var(--text-light);font-size:10px">Fijo por ley</small></div>
          <div class="card-body">
            <div class="lista-item">Exento</div><div class="lista-item">4%</div><div class="lista-item">10%</div><div class="lista-item">21%</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üí≥ Formas de pago</div><button class="btn btn-ghost btn-sm" onclick="addListItem('formas-pago-list','forma pago')">Ôºã A√±adir</button></div>
          <div class="card-body" id="formas-pago-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üè≠ Tipos proveedor</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proveedor-list','tipo')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-proveedor-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üë• Tipos cliente</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-cliente-list','tipo cliente')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-cliente-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üõã Estancias</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estancias-list','estancia')">Ôºã A√±adir</button></div>
          <div class="card-body" id="estancias-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üè∑ Categor√≠as tarifario</div><button class="btn btn-ghost btn-sm" onclick="addListItem('categorias-list','categor√≠a')">Ôºã A√±adir</button></div>
          <div class="card-body" id="categorias-list"></div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">üìÇ Partidas presupuesto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('partidas-list','partida')">Ôºã A√±adir</button></div>
          <div class="card-body" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px" id="partidas-list">
            <div class="lista-item">01.Demoliciones</div><div class="lista-item">02.Alba√±iler√≠a</div><div class="lista-item">03.Instalaciones</div><div class="lista-item">04.Revestimientos</div><div class="lista-item">05.Fontaner√≠a</div><div class="lista-item">06.Electricidad</div><div class="lista-item">07.Carpinter√≠a</div><div class="lista-item">08.Pintura</div><div class="lista-item">09.Estructura</div><div class="lista-item">10.Cubierta</div><div class="lista-item">11.Fachada</div><div class="lista-item">12.Mobiliario</div><div class="lista-item">13.Climatizaci√≥n</div><div class="lista-item">14.Varios</div><div class="lista-item">15.Otros</div>
          </div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">üèñ Causas de ausencia (Control horario)</div></div>
          <div class="card-body" style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="lista-item">Vacaciones</div><div class="lista-item">Baja m√©dica</div><div class="lista-item">Permiso</div><div class="lista-item">Festivo</div><div class="lista-item">Teletrabajo</div><div class="lista-item">Formaci√≥n</div><div class="lista-item">Otros</div>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GERENCIA ‚ïê‚ïê‚ïê -->
    <div class="view active" id="view-gerencia">
      <div class="kpi-grid">
        <div class="kpi blue"><div class="kpi-label">Total Ventas (Base Imp.)</div><div class="kpi-value" id="g-ventas">‚Äî</div><div class="kpi-sub">Facturas emitidas</div></div>
        <div class="kpi red"><div class="kpi-label">Total Costes</div><div class="kpi-value" id="g-costes">‚Äî</div><div class="kpi-sub">Compras + Subcontr. + MO</div></div>
        <div class="kpi green"><div class="kpi-label">Beneficio Real</div><div class="kpi-value" id="g-benef">‚Äî</div><div class="kpi-sub">Ventas ‚àí Costes</div></div>
        <div class="kpi amber"><div class="kpi-label">Margen Real %</div><div class="kpi-value" id="g-margen">‚Äî</div><div class="kpi-sub">Sobre ventas</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Resumen econ√≥mico -->
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Resumen econ√≥mico</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Importe ‚Ç¨</span><span>%</span></div>
            <div class="cuenta-row"><span>Total Ventas (Base Imp.)</span><span id="ge-ventas">‚Äî</span><span>100%</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span id="ge-iva-rep">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">‚Äî Compras materiales</span><span id="ge-compras">‚Äî</span><span id="ge-compras-pct">‚Äî</span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">‚Äî Subcontratas</span><span id="ge-subcs">‚Äî</span><span id="ge-subcs-pct">‚Äî</span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">‚Äî Mano de obra propia</span><span id="ge-mo">‚Äî</span><span id="ge-mo-pct">‚Äî</span></div>
            <div class="cuenta-row total"><span>TOTAL COSTES</span><span id="ge-costes-tot">‚Äî</span><span id="ge-costes-pct">‚Äî</span></div>
            <div class="cuenta-row result" id="ge-result-row"><span>BENEFICIO BRUTO</span><span id="ge-beneficio">‚Äî</span><span id="ge-benef-pct">‚Äî</span></div>
          </div>
        </div>
        <!-- Proyectos por estado -->
        <div class="card">
          <div class="card-header"><div class="card-title">üìÅ Proyectos por estado</div></div>
          <div class="card-body" style="padding:0" id="g-estados"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Seguimiento cobros -->
        <div class="card">
          <div class="card-header"><div class="card-title">üí∞ Seguimiento de cobros</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Facturado</span><span id="gc-facturado">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">‚úÖ Cobrado</span><span id="gc-cobrado">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente cobro</span><span id="gc-pendiente">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--red)">‚ùå Vencidas</span><span id="gc-vencidas">‚Äî</span><span></span></div>
          </div>
        </div>
        <!-- Seguimiento pagos -->
        <div class="card">
          <div class="card-header"><div class="card-title">üè¶ Seguimiento de pagos</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Compras</span><span id="gp-compras">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">‚úÖ Pagado proveedores</span><span id="gp-pagado-prov">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente proveedores</span><span id="gp-pdte-prov">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Total Subcontratas</span><span id="gp-subcs">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente subcontr.</span><span id="gp-pdte-sub">‚Äî</span><span></span></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Control horas -->
        <div class="card">
          <div class="card-header"><div class="card-title">‚è± Control de horas</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total horas registradas</span><span id="gh-horas">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Coste total MO</span><span id="gh-coste">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Coste medio / hora</span><span id="gh-medio">‚Äî</span><span></span></div>
          </div>
        </div>
        <!-- IVA -->
        <div class="card">
          <div class="card-header"><div class="card-title">üßæ IVA trimestral</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>IVA Repercutido (ventas)</span><span id="gi-rep">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (compras)</span><span id="gi-comp">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (subcontr.)</span><span id="gi-sub">‚Äî</span><span></span></div>
            <div class="cuenta-row total"><span>IVA NETO A INGRESAR</span><span id="gi-neto">‚Äî</span><span></span></div>
          </div>
        </div>
      </div>
      <!-- Rentabilidad por proyecto tabla -->
      <div class="card">
        <div class="card-header"><div class="card-title">üìà Rentabilidad por proyecto</div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Proyecto</th><th>Estado</th><th>Ventas</th><th>Coste Compras</th><th>Coste Subcontr.</th><th>Coste MO</th><th>Coste Total</th><th>Margen ‚Ç¨</th><th>Margen %</th></tr></thead>
        <tbody id="g-rent-table"><tr><td colspan="10" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CLIENTES ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-clientes">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-clientes" placeholder="Buscar cliente‚Ä¶" oninput="filterTable('clientes-tbody','search-clientes')"></div>
        <button class="btn btn-primary" onclick="openModal('m-cliente')">Ôºã Nuevo cliente</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ü§ù Clientes<span id="clientes-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>CIF</th><th>Tel√©fono</th><th>Email</th><th>Tipo</th><th></th></tr></thead>
        <tbody id="clientes-tbody"><tr><td colspan="7" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROYECTOS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-proyectos">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-proyectos" placeholder="Buscar proyecto‚Ä¶" oninput="filterTable('proyectos-tbody','search-proyectos')"></div>
        <button class="btn btn-primary" onclick="openModal('m-proyecto')">Ôºã Nuevo proyecto</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üìÅ Proyectos<span id="proyectos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>Cliente</th><th>Tipo</th><th>Estado</th><th>Responsable</th><th>Inicio</th><th></th></tr></thead>
        <tbody id="proyectos-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PRESUPUESTO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-presupuesto">
      <div class="search-bar">
        <select class="form-input" style="width:260px" id="pres-proyecto-sel" onchange="loadPresupuesto()"><option value="">Seleccionar proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:75px" id="pres-version-sel" onchange="loadPresupuesto()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="addLineaPresupuesto()">Ôºã L√≠nea</button>
        <button class="btn btn-ghost" onclick="addCapituloPresupuesto()">Ôºã Cap√≠tulo</button>
        <div id="pres-total-lbl" style="margin-left:auto;font-size:13px;font-weight:700;color:var(--navy)"></div>
      </div>
      <div id="pres-resumen" style="display:none">
        <div class="kpi-grid" style="margin-bottom:12px">
          <div class="kpi blue"><div class="kpi-label">Base (s/CI)</div><div class="kpi-value" id="pres-k-base">‚Äî</div></div>
          <div class="kpi amber"><div class="kpi-label">CI+GG+BI</div><div class="kpi-value" id="pres-k-ci">‚Äî</div></div>
          <div class="kpi green"><div class="kpi-label">Total s/IVA</div><div class="kpi-value" id="pres-k-total">‚Äî</div></div>
          <div class="kpi red"><div class="kpi-label">Total c/IVA 10%</div><div class="kpi-value" id="pres-k-iva">‚Äî</div></div>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>#</th><th>Descripci√≥n</th><th>Ud.</th><th>Cant.</th><th>Precio Base</th><th>Margen %</th><th>CI+GG+BI</th><th>P.Venta</th><th>Subtotal</th><th>IVA</th><th></th></tr></thead>
        <tbody id="pres-tbody"><tr><td colspan="11"><div class="empty"><div class="empty-icon">üí∞</div><div class="empty-text">Selecciona un proyecto</div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê COMPARATIVA OFERTAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-comparativa">
      <div class="info-box">‚öñÔ∏è Compara hasta 3 ofertas de distintos proveedores para cada trabajo o material. Elige la m√°s ventajosa.</div>
      <div class="search-bar">
        <select class="form-input" style="width:260px" id="comp-proyecto-sel" onchange="loadComparativa()"><option value="">Seleccionar proyecto‚Ä¶</option></select>
        <button class="btn btn-primary" onclick="openModal('m-comparativa')">Ôºã Nueva comparativa</button>
      </div>
      <div id="comp-list"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TARIFARIO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-tarifario">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-tarifario" placeholder="Buscar‚Ä¶" oninput="filterTable('tarifario-tbody','search-tarifario')"></div>
        <button class="btn btn-primary" onclick="openModal('m-tarifario')">Ôºã Nuevo art√≠culo</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üìã Tarifario<span id="tarifario-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Ud.</th><th>Coste</th><th>Margen %</th><th>P.Venta</th><th>Categor√≠a</th><th></th></tr></thead>
        <tbody id="tarifario-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CYPE ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-cype">
      <div class="info-box">üìê <strong>524 partidas CYPE 2026</strong> importadas. Base de precios centralizada.</div>
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-cype" placeholder="Buscar por c√≥digo, descripci√≥n o cap√≠tulo‚Ä¶" oninput="filterCype()"></div>
        <select class="form-input" style="width:200px" id="filter-cype-cap" onchange="filterCype()"><option value="">Todos los cap√≠tulos</option></select>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Ud.</th><th>Precio s/IVA</th><th>Cap√≠tulo</th></tr></thead>
        <tbody id="cype-tbody"><tr><td colspan="5" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê INTERIORISMO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-interiorismo">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-interiorismo" placeholder="Buscar‚Ä¶" oninput="filterTable('interiorismo-tbody','search-interiorismo')"></div>
        <button class="btn btn-copper" onclick="openModal('m-interiorismo')">Ôºã A√±adir art√≠culo</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üõã Interiorismo & Mobiliario<span id="interiorismo-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Proyecto</th><th>Estancia</th><th>Ref.</th><th>Descripci√≥n</th><th>Cant.</th><th>PVP Neto</th><th>Margen</th><th>Est. Prop.</th><th>Est. Pedido</th><th></th></tr></thead>
        <tbody id="interiorismo-tbody"><tr><td colspan="10" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê COMPRAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-compras">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-compras" placeholder="Buscar‚Ä¶" oninput="filterTable('compras-tbody','search-compras')"></div>
        <button class="btn btn-primary" onclick="openModal('m-compra')">Ôºã Nueva compra</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üõí Compras<span id="compras-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Proveedor</th><th>Concepto</th><th>Base Imp.</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="compras-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SUBCONTRATAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-subcontratas">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-subcontratas" placeholder="Buscar‚Ä¶" oninput="filterTable('subcontratas-tbody','search-subcontratas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-subcontrata')">Ôºã Nueva subcontrata</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üë∑ Subcontratas<span id="subcontratas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Subcontratista</th><th>Trabajo</th><th>Importe</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="subcontratas-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê HORAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-horas">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-horas" placeholder="Buscar‚Ä¶" oninput="filterTable('horas-tbody','search-horas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-hora')">Ôºã Registrar horas</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">‚è± Horas<span id="horas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Trabajador</th><th>Horas</th><th>‚Ç¨/h</th><th>Total</th><th>Descripci√≥n</th><th></th></tr></thead>
        <tbody id="horas-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PEDIDOS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pedidos">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-pedidos" placeholder="Buscar‚Ä¶" oninput="filterTable('pedidos-tbody','search-pedidos')"></div>
        <button class="btn btn-primary" onclick="openPedidoModal()">Ôºã Nuevo pedido</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üì¶ Registro de pedidos<span id="pedidos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>N¬∫ Pedido</th><th>Fecha</th><th>Proyecto</th><th>Tipo</th><th>Proveedor/Empresa</th><th>Importe</th><th>Estado</th><th>Observaciones</th><th></th></tr></thead>
        <tbody id="pedidos-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTROL HORARIO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-control_horario">
      <div class="search-bar">
        <select class="form-input" style="width:160px" id="ch-trab-sel" onchange="loadControlHorario()"><option value="">Seleccionar trabajador‚Ä¶</option></select>
        <select class="form-input" style="width:100px" id="ch-year-sel" onchange="loadControlHorario()">
          <option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <div id="ch-resumen" style="margin-left:auto;font-size:12px;color:var(--text-soft)"></div>
      </div>
      <div id="ch-meses-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROVEEDORES ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-proveedores">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-proveedores" placeholder="Buscar‚Ä¶" oninput="filterTable('proveedores-tbody','search-proveedores')"></div>
        <button class="btn btn-primary" onclick="openModal('m-proveedor')">Ôºã Nuevo proveedor</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üè≠ Proveedores<span id="proveedores-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Nombre</th><th>CIF</th><th>Tipo</th><th>Especialidad</th><th>Tel√©fono</th><th>Email</th><th>F.Pago</th><th></th></tr></thead>
        <tbody id="proveedores-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RENTABILIDAD ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-rentabilidad">
      <div class="search-bar">
        <select class="form-input" style="width:300px" id="rent-proyecto-sel" onchange="loadRentabilidad()"><option value="">Seleccionar proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:75px" id="rent-version-sel" onchange="loadRentabilidad()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
      </div>
      <div id="rent-kpis" style="display:none">
        <div class="kpi-grid">
          <div class="kpi blue"><div class="kpi-label">Presupuesto (s/IVA)</div><div class="kpi-value" id="rk-pres">‚Äî</div></div>
          <div class="kpi red"><div class="kpi-label">Coste real total</div><div class="kpi-value" id="rk-coste">‚Äî</div></div>
          <div class="kpi green"><div class="kpi-label">Beneficio bruto</div><div class="kpi-value" id="rk-benef">‚Äî</div></div>
          <div class="kpi amber"><div class="kpi-label">Margen real %</div><div class="kpi-value" id="rk-margen">‚Äî</div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Coste vs Presupuesto</div></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span id="rent-bar-label"></span><span id="rent-bar-nums"></span></div>
            <div class="prog-wrap"><div id="rent-bar" class="prog-bar" style="width:0%;background:var(--green)"></div></div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
          <div class="card"><div class="card-header"><div class="card-title">üõí Compras</div><div id="rk-compras-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-compras-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">üë∑ Subcontratas</div><div id="rk-sub-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-sub-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">‚è± Horas</div><div id="rk-horas-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-horas-list"></tbody></table></div></div>
        </div>
        <div class="card"><div class="card-header"><div class="card-title">üßæ Facturas emitidas</div><div id="rk-fact-total" style="font-weight:700;color:var(--green)"></div></div><div class="table-wrap"><table><thead><tr><th>N¬∫ Factura</th><th>Fecha</th><th>Base Imp.</th><th>Total c/IVA</th><th>Estado</th></tr></thead><tbody id="rk-fact-list"></tbody></table></div></div>
      </div>
      <div id="rent-empty" class="empty"><div class="empty-icon">üìà</div><div class="empty-text">Selecciona un proyecto para ver su rentabilidad</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê FACTURAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-facturas">
      <div id="fac-kpis" class="kpi-grid" style="margin-bottom:12px">
        <div class="kpi blue"><div class="kpi-label">Total Facturado</div><div class="kpi-value" id="fk-total">‚Äî</div></div>
        <div class="kpi green"><div class="kpi-label">Cobrado</div><div class="kpi-value" id="fk-cobrado">‚Äî</div></div>
        <div class="kpi amber"><div class="kpi-label">Pendiente</div><div class="kpi-value" id="fk-pendiente">‚Äî</div></div>
        <div class="kpi red"><div class="kpi-label">Vencidas</div><div class="kpi-value" id="fk-vencidas">‚Äî</div></div>
      </div>
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-facturas" placeholder="Buscar‚Ä¶" oninput="filterTable('facturas-tbody','search-facturas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-factura')">Ôºã Nueva factura</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üßæ Facturas<span id="facturas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>N¬∫ Factura</th><th>Fecha</th><th>Vto.</th><th>Cliente</th><th>Proyecto</th><th>Base Imp.</th><th>IVA%</th><th>Total IVA</th><th>Cobrado</th><th>Pendiente</th><th>Estado</th><th></th></tr></thead>
        <tbody id="facturas-tbody"><tr><td colspan="12" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTABILIDAD ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-contabilidad">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Cuenta de Resultados</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Cta PGC</span><span>Importe ‚Ç¨</span></div>
            <div class="cuenta-row" style="background:var(--blue-light);font-weight:700"><span>INGRESOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Ventas ejecutadas (base imp.)</span><span style="color:var(--text-soft)">700</span><span id="cnt-ventas">‚Äî</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span style="color:var(--text-soft)">477</span><span id="cnt-iva-rep">‚Äî</span></div>
            <div class="cuenta-row total"><span>TOTAL INGRESOS c/IVA</span><span></span><span id="cnt-ing-tot">‚Äî</span></div>
            <div class="cuenta-row" style="background:var(--red-soft);font-weight:700;margin-top:4px"><span>GASTOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Compras materiales (base)</span><span style="color:var(--text-soft)">600</span><span id="cnt-compras">‚Äî</span></div>
            <div class="cuenta-row"><span>IVA Soportado compras</span><span style="color:var(--text-soft)">472</span><span id="cnt-iva-comp">‚Äî</span></div>
            <div class="cuenta-row"><span>Subcontratas (base imp.)</span><span style="color:var(--text-soft)">621</span><span id="cnt-subcs">‚Äî</span></div>
            <div class="cuenta-row"><span>IVA Soportado subcontratas</span><span style="color:var(--text-soft)">472</span><span id="cnt-iva-sub">‚Äî</span></div>
            <div class="cuenta-row"><span>Mano de obra propia</span><span style="color:var(--text-soft)">640</span><span id="cnt-mo">‚Äî</span></div>
            <div class="cuenta-row total"><span>TOTAL GASTOS (s/IVA)</span><span></span><span id="cnt-gastos-tot">‚Äî</span></div>
            <div class="cuenta-row result" id="cnt-result-row"><span>RESULTADO BRUTO</span><span></span><span id="cnt-result">‚Äî</span></div>
            <div class="cuenta-row"><span>Margen bruto %</span><span></span><span id="cnt-margen">‚Äî</span></div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-header"><div class="card-title">üßæ Liquidaci√≥n IVA Trimestral</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row"><span>IVA Repercutido (ventas)</span><span id="iva-rep">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>IVA Soportado (compras)</span><span id="iva-comp">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>IVA Soportado (subcontr.)</span><span id="iva-sub">‚Äî</span><span></span></div>
              <div class="cuenta-row total"><span>TOTAL IVA SOPORTADO</span><span id="iva-sop-tot">‚Äî</span><span></span></div>
              <div class="cuenta-row result" id="iva-result-row"><span>IVA NETO A INGRESAR</span><span id="iva-neto">‚Äî</span><span></span></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">‚öñÔ∏è Balance Simplificado</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row header"><span>ACTIVO</span><span>‚Ç¨</span><span></span></div>
              <div class="cuenta-row"><span>Clientes (pendiente cobro)</span><span id="bal-cli">‚Äî</span><span></span></div>
              <div class="cuenta-row header" style="margin-top:4px"><span>PASIVO</span><span>‚Ç¨</span><span></span></div>
              <div class="cuenta-row"><span>IVA a liquidar (Hacienda)</span><span id="bal-iva">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>Pendiente proveedores</span><span id="bal-prov">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>Pendiente subcontratas</span><span id="bal-sub">‚Äî</span><span></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONFIGURACI√ìN ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-configuracion">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">üè¢ Datos de la empresa</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">üíæ Guardar</button></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group fg-full"><label class="form-label">Raz√≥n Social</label><input class="form-input" id="cfg-razon" placeholder="PAU INTERIORISMO S.L."></div>
              <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="cfg-cif"></div>
              <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="cfg-tel"></div>
              <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="cfg-email" type="email"></div>
              <div class="form-group"><label class="form-label">Web</label><input class="form-input" id="cfg-web"></div>
              <div class="form-group fg-full"><label class="form-label">Direcci√≥n</label><input class="form-input" id="cfg-dir"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Par√°metros CI+GG+BI</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">üíæ Guardar</button></div>
          <div class="card-body">
            <div class="info-box">Estos porcentajes se aplican autom√°ticamente en el presupuesto cuando activas CI+GG+BI en cada l√≠nea.</div>
            <div class="form-grid">
              <div class="form-group"><label class="form-label">CI - Costes Indirectos %</label><input class="form-input" id="cfg-ci" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">GG - Gastos Generales %</label><input class="form-input" id="cfg-gg" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">BI - Beneficio Industrial %</label><input class="form-input" id="cfg-bi" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">TOTAL CI+GG+BI %</label><input class="form-input calc" id="cfg-total-ci" readonly></div>
              <div class="form-group"><label class="form-label">Coste hora defecto (‚Ç¨)</label><input class="form-input" id="cfg-hora" type="number" step="0.5"></div>
            </div>
          </div>
        </div>
      </div>
        <div class="card" style="margin-top:14px">
          <div class="card-header"><div class="card-title">üìÅ Categor√≠as de partidas</div></div>
          <div class="card-body">
            <div class="info-box">Define si cada categor√≠a aplica CI+GG+BI por defecto al a√±adirla al presupuesto.</div>
            <table style="width:100%;font-size:12px;border-collapse:collapse">
              <thead><tr><th style="padding:8px;background:var(--navy);color:white;text-align:left">Categor√≠a</th><th style="padding:8px;background:var(--navy);color:white;text-align:center">Aplica CI+GG+BI</th></tr></thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Materiales</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Mano de Obra</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Maquinaria</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Subcontrata</td><td style="padding:8px;text-align:center"><span class="badge b-red">No</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Transporte</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr><td style="padding:8px">Varios</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- CLIENTE -->
<div class="overlay" id="m-cliente"><div class="modal">
  <div class="modal-head"><div class="modal-title">ü§ù <span id="m-cliente-title">Nuevo cliente</span></div><button class="modal-close" onclick="closeModal('m-cliente')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="c-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="c-nombre"></div>
      <div class="form-group"><label class="form-label">CIF/NIF</label><input class="form-input" id="c-cif"></div>
      <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="c-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="c-email" type="email"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="c-tipo"><option>Particular</option><option>Empresa</option><option>Promotora</option><option>Administraci√≥n</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="c-pago"><option>Transferencia</option><option>Efectivo</option><option>Giro</option><option>Domiciliaci√≥n</option><option>Confirming</option><option>Pagar√©</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Direcci√≥n</label><input class="form-input" id="c-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="c-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-cliente')">Cancelar</button><button class="btn btn-primary" onclick="saveCliente()">üíæ Guardar</button></div>
</div></div>

<!-- PROYECTO -->
<div class="overlay" id="m-proyecto"><div class="modal">
  <div class="modal-head"><div class="modal-title">üìÅ <span id="m-proyecto-title">Nuevo proyecto</span></div><button class="modal-close" onclick="closeModal('m-proyecto')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="p-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Cliente</label><select class="form-input" id="p-cliente"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Nombre del proyecto *</label><input class="form-input" id="p-nombre"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="p-tipo"><option>Obra nueva</option><option>Rehabilitaci√≥n integral</option><option>Reforma parcial</option><option>Cocina</option><option>Ba√±o</option><option>Interiorismo</option><option>Mobiliario</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="p-estado"><option>Nuevo lead</option><option>Presupuesto enviado</option><option>Aprobado</option><option>En ejecuci√≥n</option><option>Finalizado</option><option>Facturado</option><option>Cobrado</option><option>Cancelado</option></select></div>
      <div class="form-group"><label class="form-label">Responsable</label><select class="form-input" id="p-resp"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Fecha inicio</label><input class="form-input" id="p-fecha" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">Direcci√≥n de obra</label><input class="form-input" id="p-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="p-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proyecto')">Cancelar</button><button class="btn btn-primary" onclick="saveProyecto()">üíæ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO LINEA -->
<div class="overlay" id="m-pres-linea"><div class="modal" style="width:600px">
  <div class="modal-head"><div class="modal-title">üí∞ <span id="m-pres-title">Nueva l√≠nea</span></div><button class="modal-close" onclick="closeModal('m-pres-linea')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="pl-id">
    <div class="form-group" style="margin-bottom:10px"><label class="form-label">üîç Buscar en CYPE 2026</label>
      <input class="form-input" id="pl-cype-search" placeholder="Escribe para buscar partida CYPE‚Ä¶" oninput="searchCypeLinea()">
      <div id="pl-cype-results" style="max-height:140px;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;display:none;background:white;position:relative;z-index:10"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px"><label class="form-label">üìã O seleccionar del tarifario propio</label>
      <select class="form-input" id="pl-tarif-sel" onchange="loadTarifLinea()"><option value="">‚Äî Seleccionar del tarifario ‚Äî</option></select>
    </div>
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n *</label><input class="form-input" id="pl-desc"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="pl-ud"><option>m¬≤</option><option>m¬≥</option><option>ml</option><option>Ud</option><option>kg</option><option>h</option><option>PA</option><option>m</option></select></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="pl-cant" type="number" step="0.01" value="1" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Base (coste)</label><input class="form-input" id="pl-precio" type="number" step="0.01" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="pl-margen" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">CI+GG+BI %</label><input class="form-input" id="pl-ci" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Venta</label><input class="form-input calc" id="pl-pventa" readonly></div>
      <div class="form-group"><label class="form-label">Subtotal</label><input class="form-input calc" id="pl-subtotal" readonly></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="pl-iva"><option>10%</option><option>21%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Cap√≠tulo / Partida</label><input class="form-input" id="pl-partida"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-linea')">Cancelar</button><button class="btn btn-primary" onclick="saveLineaPresupuesto()">üíæ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO CAP√çTULO -->
<div class="overlay" id="m-pres-cap"><div class="modal" style="width:400px">
  <div class="modal-head"><div class="modal-title">üìÇ Nuevo cap√≠tulo</div><button class="modal-close" onclick="closeModal('m-pres-cap')">√ó</button></div>
  <div class="modal-body"><div class="form-group"><label class="form-label">Nombre del cap√≠tulo</label><input class="form-input" id="cap-nombre" placeholder="01. Demoliciones y trabajos previos"></div></div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-cap')">Cancelar</button><button class="btn btn-primary" onclick="saveCapitulo()">üíæ Guardar</button></div>
</div></div>

<!-- COMPARATIVA OFERTAS -->
<div class="overlay" id="m-comparativa"><div class="modal" style="width:700px">
  <div class="modal-head"><div class="modal-title">‚öñÔ∏è Nueva comparativa de ofertas</div><button class="modal-close" onclick="closeModal('m-comparativa')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="cmp-id">
    <div class="form-grid" style="margin-bottom:14px">
      <div class="form-group"><label class="form-label">Proyecto *</label><select class="form-input" id="cmp-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Trabajo / Material *</label><input class="form-input" id="cmp-trabajo" placeholder="Ej: Instalaci√≥n fontaner√≠a cocina"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div><div class="modal-section">OFERTA 1</div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Proveedor</label><input class="form-input" id="o1-prov"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">PVP ‚Ç¨</label><input class="form-input" id="o1-pvp" type="number" step="0.01" oninput="calcOferta(1)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Dto. %</label><input class="form-input" id="o1-dto" type="number" value="0" oninput="calcOferta(1)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Markup %</label><input class="form-input" id="o1-mk" type="number" value="0" oninput="calcOferta(1)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Precio Final</label><input class="form-input calc" id="o1-final" readonly></div>
        <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="o1-notas"></div>
      </div>
      <div><div class="modal-section">OFERTA 2</div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Proveedor</label><input class="form-input" id="o2-prov"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">PVP ‚Ç¨</label><input class="form-input" id="o2-pvp" type="number" step="0.01" oninput="calcOferta(2)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Dto. %</label><input class="form-input" id="o2-dto" type="number" value="0" oninput="calcOferta(2)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Markup %</label><input class="form-input" id="o2-mk" type="number" value="0" oninput="calcOferta(2)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Precio Final</label><input class="form-input calc" id="o2-final" readonly></div>
        <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="o2-notas"></div>
      </div>
      <div><div class="modal-section">OFERTA 3</div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Proveedor</label><input class="form-input" id="o3-prov"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">PVP ‚Ç¨</label><input class="form-input" id="o3-pvp" type="number" step="0.01" oninput="calcOferta(3)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Dto. %</label><input class="form-input" id="o3-dto" type="number" value="0" oninput="calcOferta(3)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Markup %</label><input class="form-input" id="o3-mk" type="number" value="0" oninput="calcOferta(3)"></div>
        <div class="form-group" style="margin-bottom:7px"><label class="form-label">Precio Final</label><input class="form-input calc" id="o3-final" readonly></div>
        <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="o3-notas"></div>
      </div>
    </div>
    <div class="form-group" style="margin-top:14px"><label class="form-label">Oferta elegida</label>
      <select class="form-input" id="cmp-elegida" style="width:200px"><option value="1">Oferta 1</option><option value="2">Oferta 2</option><option value="3">Oferta 3</option></select>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-comparativa')">Cancelar</button><button class="btn btn-primary" onclick="saveComparativa()">üíæ Guardar</button></div>
</div></div>

<!-- TARIFARIO -->
<div class="overlay" id="m-tarifario"><div class="modal">
  <div class="modal-head"><div class="modal-title">üìã <span id="m-tarif-title">Nuevo art√≠culo</span></div><button class="modal-close" onclick="closeModal('m-tarifario')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="t-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">C√≥digo *</label><input class="form-input" id="t-codigo"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="t-unidad"><option>Ud</option><option>m¬≤</option><option>m¬≥</option><option>ml</option><option>kg</option><option>h</option><option>PA</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n *</label><input class="form-input" id="t-desc"></div>
      <div class="form-group"><label class="form-label">Precio coste (s/IVA)</label><input class="form-input" id="t-coste" type="number" step="0.01" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="t-margen" type="number" step="0.1" value="30" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Precio venta</label><input class="form-input calc" id="t-pventa" readonly></div>
      <div class="form-group"><label class="form-label">Categor√≠a</label><select class="form-input" id="t-cat"><option>Mobiliario</option><option>Sanitarios</option><option>Grifer√≠as</option><option>Cocina</option><option>Carpinter√≠a</option><option>Pavimentos</option><option>Revestimientos</option><option>Instalaciones</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="t-marca"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="t-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-tarifario')">Cancelar</button><button class="btn btn-primary" onclick="saveTarifario()">üíæ Guardar</button></div>
</div></div>

<!-- INTERIORISMO -->
<div class="overlay" id="m-interiorismo"><div class="modal">
  <div class="modal-head"><div class="modal-title">üõã A√±adir art√≠culo</div><button class="modal-close" onclick="closeModal('m-interiorismo')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="i-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Proyecto *</label><select class="form-input" id="i-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Estancia</label><select class="form-input" id="i-estancia"><option>Sal√≥n</option><option>Cocina</option><option>Dormitorio</option><option>Ba√±o</option><option>Terraza</option><option>Despacho</option><option>Comedor</option><option>Pasillo</option><option>Entrada</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Ref. Tarifario</label><select class="form-input" id="i-ref" onchange="loadTarifarioItem()"><option value="">‚Äî descripci√≥n libre ‚Äî</option></select></div>
      <div class="form-group"><label class="form-label">Descripci√≥n</label><input class="form-input" id="i-desc"></div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="i-marca"></div>
      <div class="form-group"><label class="form-label">Acabado</label><input class="form-input" id="i-acabado"></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="i-cant" type="number" value="1" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP unitario</label><input class="form-input" id="i-pvp" type="number" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">Dto. cliente %</label><input class="form-input" id="i-dto" type="number" value="0" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP Neto</label><input class="form-input calc" id="i-neto" readonly></div>
      <div class="form-group"><label class="form-label">Coste neto</label><input class="form-input" id="i-coste" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="i-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Estado propuesta</label><select class="form-input" id="i-eprop"><option>Borrador</option><option>Enviada</option><option>Aprobada</option><option>Rechazada</option><option>En pedido</option><option>Entregada</option></select></div>
      <div class="form-group"><label class="form-label">Estado pedido</label><select class="form-input" id="i-eped"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En tr√°nsito</option><option>Recibido</option><option>Pagado</option></select></div>
      <div class="form-group"><label class="form-label">Fecha entrega</label><input class="form-input" id="i-fentrega" type="date"></div>
      <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="i-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-interiorismo')">Cancelar</button><button class="btn btn-copper" onclick="saveInteriorismo()">üíæ Guardar</button></div>
</div></div>

<!-- COMPRA -->
<div class="overlay" id="m-compra"><div class="modal">
  <div class="modal-head"><div class="modal-title">üõí Nueva compra</div><button class="modal-close" onclick="closeModal('m-compra')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="co-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="co-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="co-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Proveedor</label><select class="form-input" id="co-prov"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="co-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Concepto</label><input class="form-input" id="co-concepto"></div>
      <div class="form-group"><label class="form-label">Base imponible ‚Ç¨</label><input class="form-input" id="co-base" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="co-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="co-vto" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="co-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-compra')">Cancelar</button><button class="btn btn-primary" onclick="saveCompra()">üíæ Guardar</button></div>
</div></div>

<!-- SUBCONTRATA -->
<div class="overlay" id="m-subcontrata"><div class="modal">
  <div class="modal-head"><div class="modal-title">üë∑ Nueva subcontrata</div><button class="modal-close" onclick="closeModal('m-subcontrata')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="sc-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="sc-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="sc-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Subcontratista</label><select class="form-input" id="sc-prov"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="sc-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Trabajo</label><input class="form-input" id="sc-trabajo"></div>
      <div class="form-group"><label class="form-label">Importe base ‚Ç¨</label><input class="form-input" id="sc-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="sc-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="sc-vto" type="date"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-subcontrata')">Cancelar</button><button class="btn btn-primary" onclick="saveSubcontrata()">üíæ Guardar</button></div>
</div></div>

<!-- HORA -->
<div class="overlay" id="m-hora"><div class="modal" style="width:420px">
  <div class="modal-head"><div class="modal-title">‚è± Registrar horas</div><button class="modal-close" onclick="closeModal('m-hora')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="h-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="h-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="h-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Trabajador</label><select class="form-input" id="h-trab"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Horas</label><input class="form-input" id="h-horas" type="number" step="0.5" placeholder="8"></div>
      <div class="form-group"><label class="form-label">‚Ç¨/hora</label><input class="form-input" id="h-coste" type="number" value="18"></div>
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n</label><input class="form-input" id="h-desc"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-hora')">Cancelar</button><button class="btn btn-primary" onclick="saveHora()">üíæ Guardar</button></div>
</div></div>

<!-- PEDIDO -->
<div class="overlay" id="m-pedido"><div class="modal">
  <div class="modal-head"><div class="modal-title">üì¶ Nuevo pedido</div><button class="modal-close" onclick="closeModal('m-pedido')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="ped-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">N¬∫ Pedido</label><input class="form-input" id="ped-num" placeholder="PED-001"></div>
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="ped-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="ped-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="ped-tipo"><option>Material</option><option>Mobiliario</option><option>Subcontrata</option><option>Herramienta</option><option>Otros</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Empresa/Proveedor</label><select class="form-input" id="ped-prov"><option value="">Seleccionar proveedor‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Importe ‚Ç¨</label><input class="form-input" id="ped-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="ped-estado"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En tr√°nsito</option><option>Recibido</option><option>Pagado</option><option>Cancelado</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Observaciones</label><input class="form-input" id="ped-obs"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pedido')">Cancelar</button><button class="btn btn-primary" onclick="savePedido()">üíæ Guardar</button></div>
</div></div>

<!-- PROVEEDOR -->
<div class="overlay" id="m-proveedor"><div class="modal">
  <div class="modal-head"><div class="modal-title">üè≠ Nuevo proveedor</div><button class="modal-close" onclick="closeModal('m-proveedor')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="pv-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="pv-nombre"></div>
      <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="pv-cif"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="pv-tipo"><option>Proveedor</option><option>Subcontrata</option><option>Alquiler</option><option>Servicio</option><option>Transporte</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="pv-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="pv-email" type="email"></div>
      <div class="form-group"><label class="form-label">Especialidad</label><input class="form-input" id="pv-esp"></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="pv-pago"><option>Transferencia</option><option>Efectivo</option><option>Giro</option><option>Domiciliaci√≥n</option><option>Confirming</option><option>Pagar√©</option></select></div>
      <div class="form-group"><label class="form-label">IBAN</label><input class="form-input" id="pv-iban"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="pv-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proveedor')">Cancelar</button><button class="btn btn-primary" onclick="saveProveedor()">üíæ Guardar</button></div>
</div></div>

<!-- FACTURA -->
<div class="overlay" id="m-factura"><div class="modal">
  <div class="modal-head"><div class="modal-title">üßæ Nueva factura</div><button class="modal-close" onclick="closeModal('m-factura')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="f-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">N¬∫ Factura</label><input class="form-input" id="f-num" placeholder="FAC-2026-001"></div>
      <div class="form-group"><label class="form-label">Fecha emisi√≥n</label><input class="form-input" id="f-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Cliente</label><select class="form-input" id="f-cliente"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="f-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Base imponible ‚Ç¨</label><input class="form-input" id="f-base" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="f-iva"><option>10%</option><option>21%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="f-pago"><option>Transferencia</option><option>Efectivo</option><option>Giro</option><option>Domiciliaci√≥n</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="f-vto" type="date"></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="f-estado"><option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option></select></div>
      <div class="form-group"><label class="form-label">Importe cobrado ‚Ç¨</label><input class="form-input" id="f-cobrado" type="number" step="0.01" value="0"></div>
      <div class="form-group fg-full"><label class="form-label">Concepto</label><input class="form-input" id="f-concepto"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-factura')">Cancelar</button><button class="btn btn-primary" onclick="saveFactura()">üíæ Guardar</button></div>
</div></div>

<!-- QUICK -->
<div class="overlay" id="m-quick"><div class="modal" style="width:320px">
  <div class="modal-head"><div class="modal-title">Ôºã ¬øQu√© quieres crear?</div><button class="modal-close" onclick="closeModal('m-quick')">√ó</button></div>
  <div class="modal-body"><div style="display:flex;flex-direction:column;gap:7px">
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-cliente')">ü§ù <strong style="margin-left:8px">Nuevo cliente</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-proyecto')">üìÅ <strong style="margin-left:8px">Nuevo proyecto</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-comparativa')">‚öñÔ∏è <strong style="margin-left:8px">Comparativa ofertas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-interiorismo')">üõã <strong style="margin-left:8px">Propuesta interiorismo</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-compra')">üõí <strong style="margin-left:8px">Registrar compra</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-hora')">‚è± <strong style="margin-left:8px">Registrar horas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-pedido')">üì¶ <strong style="margin-left:8px">Nuevo pedido</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-factura')">üßæ <strong style="margin-left:8px">Emitir factura</strong></button>
  </div></div>
</div></div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title">‚ö†Ô∏è Eliminar registro</div>
    <div class="confirm-text" id="confirm-text">¬øSeguro que quieres eliminar?</div>
    <div class="confirm-btns"><button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button><button class="btn btn-danger" onclick="confirmDeleteAction()">Eliminar</button></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO FINAL (documento imprimible)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPresFinal(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  populateSelects();
  const sel=document.getElementById('pf-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
}
async function loadPresupuestoFinal(){
  const proy=document.getElementById('pf-proyecto-sel').value;
  const ver=document.getElementById('pf-version-sel').value;
  const empty=document.getElementById('pf-empty');
  if(!proy){empty.style.display='block';return;}
  empty.style.display='none';
  try{
    const[lineas,proyecto]=await Promise.all([
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`),
      sbGet('proyectos',`?proyecto_id=eq.${proy}`)
    ]);
    const p=proyecto[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    // Header
    document.getElementById('pf-num').textContent=`Presupuesto N¬∫: ${proy}-${ver.toUpperCase()}`;
    document.getElementById('pf-fecha').textContent=new Date().toLocaleDateString('es-ES');
    document.getElementById('pf-cliente-nombre').textContent=cliente.nombre||'‚Äî';
    document.getElementById('pf-cliente-cif').textContent=cliente.cif?`CIF: ${cliente.cif}`:'';
    document.getElementById('pf-cliente-dir').textContent=cliente.direccion||'';
    document.getElementById('pf-proyecto-nombre').textContent=p.nombre||'‚Äî';
    document.getElementById('pf-proyecto-dir').textContent=p.direccion_obra||'';
    // Lineas
    let totalBase=0;
    const tbody=document.getElementById('pf-lineas');
    tbody.innerHTML=lineas.map((l,i)=>{
      if(l.es_capitulo)return`<tr><td colspan="5" style="padding:10px 8px;font-weight:700;background:#27405b;color:white;font-size:12px">üìÇ ${l.descripcion}</td></tr>`;
      const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv*(ci>0?(1+ci/100):1);
      totalBase+=sub;
      const bg=i%2===0?'white':'#f9f9f9';
      return`<tr style="background:${bg};border-bottom:1px solid #eee"><td style="padding:7px 8px">${l.descripcion}</td><td style="padding:7px 8px;text-align:center">${l.unidad||''}</td><td style="padding:7px 8px;text-align:right">${l.cantidad||0}</td><td style="padding:7px 8px;text-align:right">${(pv*(ci>0?1+ci/100:1)).toFixed(2)}‚Ç¨</td><td style="padding:7px 8px;text-align:right;font-weight:600">${sub.toFixed(2)}‚Ç¨</td></tr>`;
    }).join('');
    const iva=totalBase*0.10,total=totalBase+iva;
    document.getElementById('pf-base').textContent=totalBase.toFixed(2)+'‚Ç¨';
    document.getElementById('pf-iva').textContent=iva.toFixed(2)+'‚Ç¨';
    document.getElementById('pf-total').textContent=total.toFixed(2)+'‚Ç¨';
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTRATO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initContrato(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  const sel=document.getElementById('ct-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
}
async function loadContrato(){
  const proyId=document.getElementById('ct-proyecto-sel').value;
  if(!proyId)return;
  try{
    const[proyArr,lineas]=await Promise.all([
      sbGet('proyectos',`?proyecto_id=eq.${proyId}`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proyId}&version=eq.v1&es_capitulo=eq.false`)
    ]);
    const p=proyArr[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    const totalBase=lineas.reduce((s,l)=>s+(l.subtotal||0),0);
    const totalIVA=totalBase*1.10;
    const hoy=new Date().toLocaleDateString('es-ES');
    document.getElementById('ct-fecha').textContent=hoy;
    document.getElementById('ct-cliente-nombre').textContent=cliente.nombre||'[CLIENTE]';
    document.getElementById('ct-cliente-cif').textContent=cliente.cif||'[CIF]';
    document.getElementById('ct-cliente-dir').textContent=cliente.direccion||'[DIRECCI√ìN]';
    document.getElementById('ct-proyecto-nombre').textContent=p.nombre||'[PROYECTO]';
    document.getElementById('ct-proyecto-dir').textContent=p.direccion_obra||'[DIRECCI√ìN OBRA]';
    document.getElementById('ct-pres-id').textContent=`${proyId}-V1`;
    document.getElementById('ct-importe').textContent=totalIVA.toFixed(2)+'‚Ç¨ (IVA incluido)';
    document.getElementById('ct-firma-cliente').textContent=cliente.nombre||'[CLIENTE]';
    // Populate presupuesto selector
    document.getElementById('ct-pres-sel').innerHTML=`<option value="v1">${proyId}-v1 ¬∑ ${totalIVA.toFixed(2)}‚Ç¨ c/IVA</option>`;
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEDIDO DOCUMENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPedidoDoc(){
  if(!PedC.length)PedC=await sbGet('pedidos','?order=fecha.desc').catch(()=>[]);
  const sel=document.getElementById('pd-pedido-sel');
  sel.innerHTML='<option value="">Seleccionar pedido‚Ä¶</option>'+PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin n¬∫'} ¬∑ ${p.proveedor||'‚Äî'} ¬∑ ${fmt(p.importe)}</option>`).join('');
}
async function loadPedidoDoc(){
  const id=document.getElementById('pd-pedido-sel').value;
  if(!id)return;
  const ped=PedC.find(p=>p.id===id);
  if(!ped)return;
  const prov=ProvC.find(p=>p.nombre===ped.proveedor)||{};
  const proy=PC.find(p=>p.proyecto_id===ped.proyecto_id)||{};
  document.getElementById('pd-num').textContent=ped.num_pedido||'‚Äî';
  document.getElementById('pd-fecha').textContent=fmtD(ped.fecha);
  document.getElementById('pd-prov-nombre').textContent=ped.proveedor||'‚Äî';
  document.getElementById('pd-prov-tel').textContent=prov.telefono?`Tel: ${prov.telefono}`:'';
  document.getElementById('pd-prov-email').textContent=prov.email||'';
  document.getElementById('pd-proyecto').textContent=proy.nombre||ped.proyecto_id||'‚Äî';
  document.getElementById('pd-tipo').textContent=ped.tipo||'';
  document.getElementById('pd-concepto').textContent=ped.observaciones||ped.tipo||'Material seg√∫n pedido';
  document.getElementById('pd-importe').textContent=fmt(ped.importe);
  document.getElementById('pd-obs').textContent=ped.observaciones||'Servir lo antes posible.';
  document.getElementById('pd-proyecto-dir').textContent=proy.direccion_obra||'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LISTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function upsertConfig(clave, valor){
  // Upsert usando Supabase: si existe actualiza, si no inserta
  const resp = await fetch(`${SB_URL}/rest/v1/configuracion`, {
    method: 'POST',
    headers: {
      'apikey': SB_KEY,
      'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates,return=minimal'
    },
    body: JSON.stringify({clave, valor, descripcion:'Lista editable'})
  });
  if(!resp.ok){
    const err = await resp.text();
    throw new Error(err);
  }
}

async function addListItem(listId, tipo){
  const val=prompt(`Nuevo ${tipo}:`);
  if(!val||!val.trim())return;
  const v=val.trim();
  // Actualizar cach√© en memoria
  const clave=LISTA_MAP[listId];
  if(clave){
    if(clave==='trabajadores'){if(!TRABAJADORES.includes(v))TRABAJADORES.push(v);}
    else if(LISTAS[clave]){if(!LISTAS[clave].includes(v))LISTAS[clave].push(v);}
  }
  // Actualizar UI
  const list=document.getElementById(listId);
  if(list){
    const div=document.createElement('div');
    div.className='lista-item';div.dataset.val=v;div.textContent=v;
    list.appendChild(div);
  }
  // Refrescar todos los desplegables
  populateTrabajadores();
  populateAllListas();
  // Guardar en Supabase
  if(clave){
    const arr=clave==='trabajadores'?TRABAJADORES:(LISTAS[clave]||[]);
    try{
      await upsertConfig(clave, arr.join(','));
      toast(`"${v}" guardado ‚úÖ`);
    }catch(e){
      toast(`Error guardando: ${e.message}`,'error');
    }
  } else {
    toast(`"${v}" a√±adido ‚úÖ`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL='https://qxyflndntpmcdbyvwjnj.supabase.co';
const SB_KEY='sb_publishable_mCrvdo_QgXEwReMdKxJ1RQ_wpRcqLcE';
const USERS={'jose':'Pauinteriorismo2026','pau':'Pauinteriorismo2026'};
const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_CORTOS=['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doLogin(){
  const u=document.getElementById('login-user').value.trim().toLowerCase();
  const p=document.getElementById('login-pass').value;
  if(USERS[u]&&USERS[u]===p){
    document.getElementById('login-screen').style.display='none';
    sessionStorage.setItem('pau-auth','1');sessionStorage.setItem('pau-user',u);
    setUserDisplay(u);init();
  }else{
    document.getElementById('login-error').style.display='block';
    document.getElementById('login-pass').value='';
  }
}
function doLogout(){sessionStorage.clear();location.reload();}
function setUserDisplay(u){
  const n=u.charAt(0).toUpperCase()+u.slice(1);
  document.getElementById('user-name').textContent=n;
  document.getElementById('user-av').textContent=n.substring(0,2).toUpperCase();
}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
if(sessionStorage.getItem('pau-auth')==='1'){
  document.getElementById('login-screen').style.display='none';
  setUserDisplay(sessionStorage.getItem('pau-user')||'jose');
  document.addEventListener('DOMContentLoaded',init);
  if(document.readyState!=='loading')init();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sb(table,method='GET',body=null,id=null,extra=''){
  const url=`${SB_URL}/rest/v1/${table}${id?`?id=eq.${id}`:''}${extra}`;
  const r=await fetch(url,{method,headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':method==='POST'?'return=representation':''},body:body?JSON.stringify(body):null});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):[];
}
const sbGet=(t,e='')=>sb(t,'GET',null,null,e);
const sbPost=(t,d)=>sb(t,'POST',d);
const sbPatch=(t,id,d)=>sb(t,'PATCH',d,id);
const sbDelete=(t,id)=>sb(t,'DELETE',null,id);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const META={
  gerencia:{t:'Gerencia ¬∑ Panel ejecutivo',b:'Datos en tiempo real ¬∑ Todos los proyectos'},
  clientes:{t:'Clientes',b:'Base de datos centralizada'},
  proyectos:{t:'Proyectos',b:'Todos los proyectos'},
  presupuesto:{t:'Presupuesto ¬∑ Constructor',b:'B√∫squeda CYPE + Tarifario propio'},
  comparativa:{t:'Comparativa de ofertas',b:'Compara hasta 3 proveedores por trabajo'},
  tarifario:{t:'Tarifario ¬∑ Cat√°logo propio',b:''},
  cype:{t:'CYPE 2026 ¬∑ 524 partidas',b:'Base de precios importada de tu Excel'},
  interiorismo:{t:'Interiorismo & Mobiliario',b:'Propuestas ¬∑ Pedidos ¬∑ M√°rgenes'},
  compras:{t:'Compras',b:''},subcontratas:{t:'Subcontratas',b:''},
  horas:{t:'Control de horas',b:''},pedidos:{t:'Registro de pedidos',b:''},
  control_horario:{t:'Control horario anual',b:'Ficha por trabajador'},
  proveedores:{t:'Proveedores',b:'32 proveedores importados'},
  rentabilidad:{t:'Rentabilidad por proyecto',b:'Presupuesto vs Coste real'},
  facturas:{t:'Facturas emitidas',b:'Seguimiento de cobros'},
  contabilidad:{t:'Contabilidad',b:'Cuenta de resultados ¬∑ IVA ¬∑ Balance'},
  pres_final:{t:'Presupuesto Final ¬∑ Documento',b:'Documento imprimible listo para enviar al cliente'},
  contrato:{t:'Contrato de obra',b:'Plantilla de contrato autorellenable'},
  pedido_doc:{t:'Documento de pedido',b:'Hoja de pedido a proveedor imprimible'},
  listas:{t:'Listas ¬∑ Gesti√≥n de desplegables',b:'Edita trabajadores, estados, partidas y m√°s'},
  configuracion:{t:'Configuraci√≥n',b:'Empresa ¬∑ CI+GG+BI ¬∑ Par√°metros'},
};
document.querySelectorAll('.nav-item[data-view]').forEach(el=>el.addEventListener('click',()=>navTo(el.dataset.view)));
async function navTo(v){
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  document.querySelector(`[data-view="${v}"]`)?.classList.add('active');
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  document.getElementById('view-'+v)?.classList.add('active');
  const m=META[v]||{};
  document.getElementById('tb-title').textContent=m.t||v;
  document.getElementById('tb-bc').textContent=m.b||'';
  if(loaders[v]) await loaders[v]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bColors={'Nuevo lead':'b-gray','Presupuesto enviado':'b-amber','Aprobado':'b-blue','En ejecuci√≥n':'b-blue','Finalizado':'b-green','Facturado':'b-green','Cobrado':'b-navy','Cancelado':'b-red','Pendiente':'b-amber','Pagado':'b-green','Cobrada':'b-green','Parcial':'b-copper','Vencido':'b-red','Vencida':'b-red','Borrador':'b-gray','Enviada':'b-amber','Aprobada':'b-green','Rechazada':'b-red','En pedido':'b-blue','Entregada':'b-navy','Solicitado':'b-amber','Confirmado':'b-blue','En tr√°nsito':'b-blue','Recibido':'b-copper','Proveedor':'b-blue','Subcontrata':'b-green','Obra nueva':'b-navy','Rehabilitaci√≥n integral':'b-green','Interiorismo':'b-copper','Particular':'b-blue','Empresa':'b-green','Promotora':'b-copper'};
function bE(v){return`<span class="badge ${bColors[v]||'b-gray'}">${v||'‚Äî'}</span>`}
function fmt(n){if(n===null||n===undefined||n==='')return'‚Äî';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨'}
function fmtN(n){if(!n&&n!==0)return'‚Äî';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨'}
function fmtP(n){return n!=null?Number(n).toFixed(1)+'%':'‚Äî'}
function fmtD(d){if(!d)return'‚Äî';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d}
function genId(pre,list,key){const ns=list.map(x=>parseInt((x[key||pre.toLowerCase()+'_id']||'').replace(/\D/g,''))||0);return`${pre}-${(Math.max(0,...ns)+1).toString().padStart(3,'0')}`}
function ivaPct(s){return s==='Exento'?0:parseFloat(s)||21}
let toastT;
function toast(msg,type='success'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast show ${type}`;clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3200);}
function openModal(id){document.getElementById(id)?.classList.add('open')}
function closeModal(id){document.getElementById(id)?.classList.remove('open')}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open')}));
let pendingDel=null;
function confirmDelete(table,id,name){pendingDel={table,id};document.getElementById('confirm-text').textContent=`¬øEliminar "${name}"? No se puede deshacer.`;document.getElementById('confirm-overlay').classList.add('open');}
function closeConfirm(){pendingDel=null;document.getElementById('confirm-overlay').classList.remove('open');}
async function confirmDeleteAction(){if(!pendingDel)return;try{await sbDelete(pendingDel.table,pendingDel.id);toast('Eliminado ‚úÖ');closeConfirm();loaders[currentView()]?.();}catch(e){toast('Error: '+e.message,'error');}}
function currentView(){return document.querySelector('.view.active')?.id.replace('view-','')||'gerencia';}
function filterTable(tbId,inId){const q=document.getElementById(inId)?.value.toLowerCase()||'';document.querySelectorAll(`#${tbId} tr[data-search]`).forEach(r=>{r.style.display=r.dataset.search.includes(q)?'':'none';});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CACHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CC=[],PC=[],TC=[],ProvC=[],IntC=[],CoC=[],ScC=[],HC=[],FC=[],PedC=[],CmpC=[],PresC=[],CyCache=[];
let TRABAJADORES=['Paco','Ra√∫l','Boro','Julio','Pau','Jose Asins'];
let LISTAS={
  estados_proyecto:['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuci√≥n','Finalizado','Facturado','Cobrado','Cancelado'],
  tipos_proyecto:['Obra nueva','Rehabilitaci√≥n integral','Reforma parcial','Cocina','Ba√±o','Interiorismo','Mobiliario','Electricidad','Fontaner√≠a','Pintura','Otros'],
  formas_pago:['Transferencia','Efectivo','Giro','Domiciliaci√≥n','Confirming','Pagar√©'],
  tipos_cliente:['Particular','Empresa','Promotora','Administraci√≥n','Otros'],
  tipos_proveedor:['Proveedor','Subcontrata','Alquiler','Servicio','Transporte','Otros'],
  estancias:['Sal√≥n','Cocina','Dormitorio','Ba√±o','Terraza','Despacho','Comedor','Pasillo','Entrada','Otros'],
  categorias_tarifario:['Mobiliario','Sanitarios','Grifer√≠as','Cocina','Carpinter√≠a','Pavimentos','Revestimientos','Instalaciones','Otros'],
};
const LISTA_MAP={'trabajadores-list':'trabajadores','estados-list':'estados_proyecto','tipos-proyecto-list':'tipos_proyecto','formas-pago-list':'formas_pago','tipos-cliente-list':'tipos_cliente','tipos-proveedor-list':'tipos_proveedor','estancias-list':'estancias','categorias-list':'categorias_tarifario'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE SELECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateAllListas(){
  const map={estados_proyecto:['p-estado'],tipos_proyecto:['p-tipo'],formas_pago:['c-pago','pv-pago','f-pago'],tipos_cliente:['c-tipo'],tipos_proveedor:['pv-tipo'],estancias:['i-estancia'],categorias_tarifario:['t-cat']};
  Object.entries(map).forEach(([key,ids])=>{
    const vals=LISTAS[key]||[];
    ids.forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+vals.map(v=>`<option value="${v}">${v}</option>`).join('');if(cur&&vals.includes(cur))el.value=cur;});
  });
}
function populateTrabajadores(){
  const ids=['h-trab','ch-trab-sel','p-resp'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const cur=el.value;
    const placeholder=id==='ch-trab-sel'?'Seleccionar trabajador‚Ä¶':'Seleccionar‚Ä¶';
    el.innerHTML=`<option value="">${placeholder}</option>`+TRABAJADORES.map(t=>`<option value="${t}">${t}</option>`).join('');
    if(cur&&TRABAJADORES.includes(cur))el.value=cur;
  });
}
async function populateSelects(){
  if(!CC.length)CC=await sbGet('clientes').catch(()=>[]);
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!ProvC.length)ProvC=await sbGet('proveedores','?order=nombre.asc').catch(()=>[]);
  ['p-cliente','f-cliente'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-proyecto','sc-proyecto','h-proyecto','f-proyecto','i-proyecto','ped-proyecto','pres-proyecto-sel','comp-proyecto-sel','rent-proyecto-sel','cmp-proyecto'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-prov','sc-prov','ped-prov'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar proveedor‚Ä¶</option>'+ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ¬∑ '+p.tipo:''}</option>`).join('');if(cur)el.value=cur;});
}
async function populateIntCatalog(){
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  ['i-ref','pl-tarif-sel'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=(id==='i-ref'?'<option value="">‚Äî descripci√≥n libre ‚Äî</option>':'<option value="">‚Äî Seleccionar del tarifario ‚Äî</option>')+TC.map(t=>`<option value="${t.id}">${t.codigo} ¬∑ ${t.descripcion}</option>`).join('');});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GERENCIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadGerencia(){
  try{
    const [cl,pr,ta,cy,comp,subc,hor,fac]=await Promise.all([
      sbGet('clientes'),sbGet('proyectos'),sbGet('tarifario'),
      sbGet('precios_cype','?select=id'),
      sbGet('compras'),sbGet('subcontratas'),sbGet('horas'),sbGet('facturas')
    ]);
    CC=cl;PC=pr;TC=ta;CoC=comp;ScC=subc;HC=hor;FC=fac;
    document.getElementById('cype-badge').textContent=cy.length;

    // C√°lculos
    const totalVentas=fac.reduce((s,f)=>s+(f.base_imponible||0),0);
    const totalIvaRep=fac.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const totalCompras=comp.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalIvaComp=comp.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const totalSubcs=subc.reduce((s,c)=>s+(c.importe||0),0);
    const totalIvaSub=subc.reduce((s,c)=>s+(c.importe||0)*ivaPct(c.iva_pct)/100,0);
    const totalMO=hor.reduce((s,h)=>s+(h.total||0),0);
    const totalCostes=totalCompras+totalSubcs+totalMO;
    const beneficio=totalVentas-totalCostes;
    const margen=totalVentas>0?(beneficio/totalVentas)*100:0;

    // KPIs top
    document.getElementById('g-ventas').textContent=fmt(totalVentas);
    document.getElementById('g-costes').textContent=fmt(totalCostes);
    document.getElementById('g-benef').textContent=fmt(beneficio);
    document.getElementById('g-benef').style.color=beneficio>=0?'var(--green)':'var(--red)';
    document.getElementById('g-margen').textContent=fmtP(margen);

    // Resumen econ√≥mico
    const pv=totalVentas>0;
    document.getElementById('ge-ventas').textContent=fmt(totalVentas);
    document.getElementById('ge-iva-rep').textContent=fmt(totalIvaRep);
    document.getElementById('ge-compras').textContent=fmt(totalCompras);
    document.getElementById('ge-compras-pct').textContent=pv?fmtP(totalCompras/totalVentas*100):'‚Äî';
    document.getElementById('ge-subcs').textContent=fmt(totalSubcs);
    document.getElementById('ge-subcs-pct').textContent=pv?fmtP(totalSubcs/totalVentas*100):'‚Äî';
    document.getElementById('ge-mo').textContent=fmt(totalMO);
    document.getElementById('ge-mo-pct').textContent=pv?fmtP(totalMO/totalVentas*100):'‚Äî';
    document.getElementById('ge-costes-tot').textContent=fmt(totalCostes);
    document.getElementById('ge-costes-pct').textContent=pv?fmtP(totalCostes/totalVentas*100):'‚Äî';
    document.getElementById('ge-beneficio').textContent=fmt(beneficio);
    document.getElementById('ge-benef-pct').textContent=pv?fmtP(margen):'‚Äî';
    const rr=document.getElementById('ge-result-row');
    rr.className='cuenta-row result'+(beneficio<0?' neg':'');

    // Proyectos por estado
    const estados=['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuci√≥n','Finalizado','Facturado','Cobrado','Cancelado'];
    const counts={};estados.forEach(e=>counts[e]=0);
    pr.forEach(p=>counts[p.estado]=(counts[p.estado]||0)+1);
    document.getElementById('g-estados').innerHTML=
      Object.entries(counts).filter(([,v])=>v>0).map(([k,v])=>
        `<div class="cuenta-row"><span>${bE(k)} ${k}</span><span style="font-weight:700">${v}</span><span></span></div>`
      ).join('')+`<div class="cuenta-row total"><span>TOTAL PROYECTOS</span><span style="font-weight:700">${pr.length}</span><span></span></div>`;

    // Cobros
    const cobrado=fac.filter(f=>f.estado==='Cobrada').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const totalFactIVA=fac.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const vencidas=fac.filter(f=>f.estado==='Vencida').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('gc-facturado').textContent=fmt(totalFactIVA);
    document.getElementById('gc-cobrado').textContent=fmt(cobrado);
    document.getElementById('gc-pendiente').textContent=fmt(totalFactIVA-cobrado);
    document.getElementById('gc-vencidas').textContent=fmt(vencidas);

    // Pagos
    const pagadoProv=comp.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.base_imponible||0),0);
    const pagadoSub=subc.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.importe||0),0);
    document.getElementById('gp-compras').textContent=fmt(totalCompras);
    document.getElementById('gp-pagado-prov').textContent=fmt(pagadoProv);
    document.getElementById('gp-pdte-prov').textContent=fmt(totalCompras-pagadoProv);
    document.getElementById('gp-subcs').textContent=fmt(totalSubcs);
    document.getElementById('gp-pdte-sub').textContent=fmt(totalSubcs-pagadoSub);

    // Horas
    const totH=hor.reduce((s,h)=>s+(h.horas||0),0);
    document.getElementById('gh-horas').textContent=totH.toFixed(1)+'h';
    document.getElementById('gh-coste').textContent=fmt(totalMO);
    document.getElementById('gh-medio').textContent=totH>0?fmt(totalMO/totH).replace('‚Ç¨','')+' ‚Ç¨/h':'‚Äî';

    // IVA
    document.getElementById('gi-rep').textContent=fmt(totalIvaRep);
    document.getElementById('gi-comp').textContent=fmt(totalIvaComp);
    document.getElementById('gi-sub').textContent=fmt(totalIvaSub);
    document.getElementById('gi-neto').textContent=fmt(totalIvaRep-totalIvaComp-totalIvaSub);

    // Rentabilidad por proyecto
    const compByProy={},subByProy={},horByProy={},facByProy={};
    comp.forEach(c=>{compByProy[c.proyecto_id]=(compByProy[c.proyecto_id]||0)+(c.base_imponible||0);});
    subc.forEach(c=>{subByProy[c.proyecto_id]=(subByProy[c.proyecto_id]||0)+(c.importe||0);});
    hor.forEach(h=>{horByProy[h.proyecto_id]=(horByProy[h.proyecto_id]||0)+(h.total||0);});
    fac.forEach(f=>{facByProy[f.proyecto_id]=(facByProy[f.proyecto_id]||0)+(f.base_imponible||0);});

    const tbody=document.getElementById('g-rent-table');
    if(!pr.length){tbody.innerHTML='<tr><td colspan="10"><div class="empty"><div class="empty-icon">üìÅ</div><div class="empty-text">Sin proyectos</div></div></td></tr>';return;}
    tbody.innerHTML=pr.map(p=>{
      const v=facByProy[p.proyecto_id]||0,cc=compByProy[p.proyecto_id]||0,sc=subByProy[p.proyecto_id]||0,mo=horByProy[p.proyecto_id]||0;
      const tot=cc+sc+mo,ben=v-tot,mg=v>0?(ben/v)*100:0;
      return`<tr><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id}</td><td><strong>${p.nombre}</strong></td><td>${bE(p.estado)}</td><td class="td-mono">${fmt(v)}</td><td class="td-mono">${fmt(cc)}</td><td class="td-mono">${fmt(sc)}</td><td class="td-mono">${fmt(mo)}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td class="td-mono" style="${ben>=0?'color:var(--green)':'color:var(--red)'}">${fmt(ben)}</td><td class="td-mono" style="${mg>=15?'color:var(--green)':mg>=0?'color:var(--amber)':'color:var(--red)'}">${fmtP(mg)}</td></tr>`;
    }).join('');

    const s=document.getElementById('conn-status');s.style.background='var(--green-soft)';s.style.color='var(--green)';s.textContent='üü¢ Conectado';
    populateSelects();populateIntCatalog();populateTrabajadores();
  }catch(e){
    console.error(e);
    const s=document.getElementById('conn-status');s.style.background='var(--red-soft)';s.style.color='var(--red)';s.textContent='üî¥ Error';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadClientes(){
  const tb=document.getElementById('clientes-tbody');
  try{
    CC=await sbGet('clientes','?order=created_at.desc');
    document.getElementById('clientes-count').textContent=CC.length+' clientes';
    if(!CC.length){tb.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ü§ù</div><div class="empty-text">Sin clientes</div><button class="btn btn-primary" onclick="openModal('m-cliente')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=CC.map(c=>`<tr data-search="${(c.nombre+c.cif+c.email+c.tipo).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${c.cliente_id||'‚Äî'}</td><td><strong>${c.nombre}</strong></td><td class="td-mono">${c.cif||'‚Äî'}</td><td>${c.telefono||'‚Äî'}</td><td style="color:var(--navy-mid)">${c.email||'‚Äî'}</td><td>${bE(c.tipo)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editCliente('${c.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('clientes','${c.id}','${c.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
  }catch(e){tb.innerHTML=`<tr><td colspan="7" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editCliente(id){const c=CC.find(x=>x.id===id);if(!c)return;document.getElementById('m-cliente-title').textContent='Editar cliente';['c-id','c-nombre','c-cif','c-tel','c-email','c-dir','c-notas'].forEach((f,i)=>{document.getElementById(f).value=[c.id,c.nombre,c.cif,c.telefono,c.email,c.direccion,c.notas][i]||'';});document.getElementById('c-tipo').value=c.tipo||'Particular';document.getElementById('c-pago').value=c.forma_pago||'Transferencia';openModal('m-cliente');}
async function saveCliente(){
  const nombre=document.getElementById('c-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('c-id').value;
  const d={nombre,cif:document.getElementById('c-cif').value,telefono:document.getElementById('c-tel').value,email:document.getElementById('c-email').value,direccion:document.getElementById('c-dir').value,tipo:document.getElementById('c-tipo').value,forma_pago:document.getElementById('c-pago').value,notas:document.getElementById('c-notas').value};
  try{if(id){await sbPatch('clientes',id,d);toast('Cliente actualizado ‚úÖ');}else{d.cliente_id=genId('CLI',CC,'cliente_id');await sbPost('clientes',d);toast('Cliente guardado ‚úÖ');}closeModal('m-cliente');document.getElementById('c-id').value='';loadClientes();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROYECTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProyectos(){
  const tb=document.getElementById('proyectos-tbody');
  try{
    PC=await sbGet('proyectos','?order=created_at.desc');
    document.getElementById('proyectos-count').textContent=PC.length+' proyectos';
    if(!PC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üìÅ</div><div class="empty-text">Sin proyectos</div><button class="btn btn-primary" onclick="openModal('m-proyecto')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PC.map(p=>`<tr data-search="${(p.proyecto_id+p.nombre+p.cliente_id+p.tipo+p.estado).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'‚Äî'}</td><td><strong>${p.nombre}</strong></td><td>${p.cliente_id||'‚Äî'}</td><td>${bE(p.tipo)}</td><td>${bE(p.estado)}</td><td>${p.responsable||'‚Äî'}</td><td>${fmtD(p.fecha_inicio)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProyecto('${p.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proyectos','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editProyecto(id){const p=PC.find(x=>x.id===id);if(!p)return;document.getElementById('m-proyecto-title').textContent='Editar proyecto';document.getElementById('p-id').value=p.id;document.getElementById('p-nombre').value=p.nombre||'';document.getElementById('p-cliente').value=p.cliente_id||'';document.getElementById('p-tipo').value=p.tipo||'Obra nueva';document.getElementById('p-estado').value=p.estado||'Nuevo lead';document.getElementById('p-resp').value=p.responsable||'Jose Asins';document.getElementById('p-fecha').value=p.fecha_inicio||'';document.getElementById('p-dir').value=p.direccion_obra||'';document.getElementById('p-notas').value=p.notas||'';openModal('m-proyecto');}
async function saveProyecto(){
  const nombre=document.getElementById('p-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('p-id').value;
  const d={cliente_id:document.getElementById('p-cliente').value||null,nombre,tipo:document.getElementById('p-tipo').value,estado:document.getElementById('p-estado').value,responsable:document.getElementById('p-resp').value,fecha_inicio:document.getElementById('p-fecha').value||null,direccion_obra:document.getElementById('p-dir').value,notas:document.getElementById('p-notas').value};
  try{if(id){await sbPatch('proyectos',id,d);toast('Proyecto actualizado ‚úÖ');}else{d.proyecto_id=genId('PRY',PC,'proyecto_id');await sbPost('proyectos',d);toast('Proyecto creado ‚úÖ');}closeModal('m-proyecto');document.getElementById('p-id').value='';loadProyectos();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPresupuesto(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc').catch(()=>[]);
  populateSelects();populateIntCatalog();
}
async function loadPresupuesto(){
  const proy=document.getElementById('pres-proyecto-sel').value;
  const ver=document.getElementById('pres-version-sel').value;
  const tbody=document.getElementById('pres-tbody');
  if(!proy){tbody.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="empty-icon">üí∞</div><div class="empty-text">Selecciona un proyecto</div></div></td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  try{
    PresC=await sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`);
    renderPresupuesto();
  }catch(e){tbody.innerHTML=`<tr><td colspan="11" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function renderPresupuesto(){
  const tbody=document.getElementById('pres-tbody');
  if(!PresC.length){tbody.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="empty-icon">üí∞</div><div class="empty-text">Presupuesto vac√≠o</div><button class="btn btn-ghost" onclick="addCapituloPresupuesto()">Ôºã Cap√≠tulo</button></div></td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  let totBase=0,totCI=0,totVenta=0;
  tbody.innerHTML=PresC.map((l,i)=>{
    if(l.es_capitulo)return`<tr style="background:var(--navy);color:#fff"><td colspan="9" style="padding:9px 10px;font-weight:700;font-size:12px">üìÇ ${l.descripcion}</td><td></td><td><button class="btn btn-icon btn-sm" style="background:rgba(255,255,255,.1);border:none;color:#fff" onclick="confirmDelete('presupuesto_lineas','${l.id}','${l.descripcion.replace(/'/g,"\\'")}')">üóë</button></td></tr>`;
    const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv,subCI=ci>0?sub*(1+ci/100):sub;
    totBase+=(l.cantidad||0)*(l.precio_base||0);totCI+=subCI-sub;totVenta+=subCI;
    return`<tr data-search="${(l.descripcion||'').toLowerCase()}"><td style="color:var(--text-soft);font-size:11px">${i+1}</td><td><strong>${l.descripcion||'‚Äî'}</strong>${l.ref_cype?`<br><span style="font-size:9px;color:var(--text-soft)">${l.ref_cype}</span>`:''}</td><td style="text-align:center">${l.unidad||'‚Äî'}</td><td class="td-mono">${l.cantidad||0}</td><td class="td-mono">${fmt(l.precio_base)}</td><td class="td-mono" style="color:var(--green)">${l.margen_pct>0?fmtP(l.margen_pct):'‚Äî'}</td><td class="td-mono" style="color:var(--amber)">${ci>0?fmtP(ci):'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(pv)}</td><td class="td-mono" style="font-weight:700;color:var(--navy)">${fmt(subCI)}</td><td><span class="badge b-gray">${l.iva_pct||'10%'}</span></td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editLineaPresupuesto('${l.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('presupuesto_lineas','${l.id}','${(l.descripcion||'').replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`;
  }).join('');
  const iva=totVenta*0.10;
  document.getElementById('pres-k-base').textContent=fmt(totBase);document.getElementById('pres-k-ci').textContent=fmt(totCI);document.getElementById('pres-k-total').textContent=fmt(totVenta);document.getElementById('pres-k-iva').textContent=fmt(totVenta+iva);
  document.getElementById('pres-total-lbl').textContent=`TOTAL c/IVA: ${fmt(totVenta+iva)}`;
  document.getElementById('pres-resumen').style.display='block';
}
function calcLineaPres(){const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);const sub=cant*pv;document.getElementById('pl-pventa').value=pv>0?pv.toFixed(2)+' ‚Ç¨':'‚Äî';document.getElementById('pl-subtotal').value=sub>0?sub.toFixed(2)+' ‚Ç¨':'‚Äî';}
function searchCypeLinea(){const q=document.getElementById('pl-cype-search').value.toLowerCase(),res=document.getElementById('pl-cype-results');if(q.length<2){res.style.display='none';return;}const matches=CyCache.filter(c=>c.codigo.toLowerCase().includes(q)||c.descripcion.toLowerCase().includes(q)).slice(0,8);if(!matches.length){res.style.display='none';return;}res.style.display='block';res.innerHTML=matches.map(c=>`<div onclick="selectCype('${c.id}')" style="padding:7px 11px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--blue-light)'" onmouseout="this.style.background=''"><strong style="color:var(--navy-mid)">${c.codigo}</strong> ¬∑ ${c.descripcion} <span style="float:right;color:var(--green);font-weight:700">${fmt(c.precio)}/${c.unidad}</span></div>`).join('');}
function selectCype(id){const c=CyCache.find(x=>x.id===id);if(!c)return;document.getElementById('pl-desc').value=c.descripcion;document.getElementById('pl-precio').value=c.precio;document.getElementById('pl-ud').value=c.unidad||'m¬≤';document.getElementById('pl-cype-search').value=`${c.codigo} ¬∑ ${c.descripcion}`;document.getElementById('pl-cype-search').dataset.cypeRef=c.codigo;document.getElementById('pl-cype-results').style.display='none';calcLineaPres();}
function loadTarifLinea(){const id=document.getElementById('pl-tarif-sel').value;if(!id)return;const t=TC.find(x=>x.id===id);if(!t)return;document.getElementById('pl-desc').value=t.descripcion;document.getElementById('pl-precio').value=t.precio_coste||0;document.getElementById('pl-margen').value=t.margen_pct||0;document.getElementById('pl-ud').value=t.unidad||'Ud';calcLineaPres();}
function addLineaPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('m-pres-title').textContent='Nueva l√≠nea';['pl-id','pl-desc','pl-precio','pl-pventa','pl-subtotal','pl-partida'].forEach(id=>document.getElementById(id).value='');document.getElementById('pl-margen').value='0';document.getElementById('pl-ci').value='0';document.getElementById('pl-cant').value='1';document.getElementById('pl-cype-search').value='';document.getElementById('pl-cype-search').dataset.cypeRef='';document.getElementById('pl-cype-results').style.display='none';document.getElementById('pl-tarif-sel').value='';openModal('m-pres-linea');}
function editLineaPresupuesto(id){const l=PresC.find(x=>x.id===id);if(!l)return;document.getElementById('m-pres-title').textContent='Editar l√≠nea';document.getElementById('pl-id').value=l.id;document.getElementById('pl-desc').value=l.descripcion||'';document.getElementById('pl-precio').value=l.precio_base||0;document.getElementById('pl-margen').value=l.margen_pct||0;document.getElementById('pl-ci').value=l.ci_gg_bi_pct||0;document.getElementById('pl-cant').value=l.cantidad||1;document.getElementById('pl-ud').value=l.unidad||'m¬≤';document.getElementById('pl-iva').value=l.iva_pct||'10%';document.getElementById('pl-partida').value=l.partida||'';document.getElementById('pl-cype-search').value=l.ref_cype||'';document.getElementById('pl-cype-search').dataset.cypeRef=l.ref_cype||'';document.getElementById('pl-cype-results').style.display='none';calcLineaPres();openModal('m-pres-linea');}
async function saveLineaPresupuesto(){
  const desc=document.getElementById('pl-desc').value.trim();if(!desc){toast('La descripci√≥n es obligatoria','error');return;}
  const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;
  const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;
  let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);
  const id=document.getElementById('pl-id').value;
  const d={proyecto_id:proy,version:ver,descripcion:desc,ref_cype:document.getElementById('pl-cype-search').dataset.cypeRef||null,unidad:document.getElementById('pl-ud').value,cantidad:cant,precio_base:precio,margen_pct:margen,ci_gg_bi_pct:ci,precio_venta:parseFloat(pv.toFixed(4)),subtotal:parseFloat((cant*pv).toFixed(4)),iva_pct:document.getElementById('pl-iva').value,partida:document.getElementById('pl-partida').value,es_capitulo:false,orden:PresC.length+1};
  try{if(id){await sbPatch('presupuesto_lineas',id,d);toast('L√≠nea actualizada ‚úÖ');}else{await sbPost('presupuesto_lineas',d);toast('L√≠nea a√±adida ‚úÖ');}closeModal('m-pres-linea');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}
function addCapituloPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('cap-nombre').value='';openModal('m-pres-cap');}
async function saveCapitulo(){const nombre=document.getElementById('cap-nombre').value.trim();if(!nombre){toast('Escribe el nombre','error');return;}const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;try{await sbPost('presupuesto_lineas',{proyecto_id:proy,version:ver,descripcion:nombre,es_capitulo:true,orden:PresC.length+1,cantidad:0,precio_base:0,precio_venta:0,subtotal:0});toast('Cap√≠tulo a√±adido ‚úÖ');closeModal('m-pres-cap');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPARATIVA OFERTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcOferta(n){const pvp=parseFloat(document.getElementById(`o${n}-pvp`).value)||0,dto=parseFloat(document.getElementById(`o${n}-dto`).value)||0,mk=parseFloat(document.getElementById(`o${n}-mk`).value)||0;const coste=pvp*(1-dto/100),final=coste*(1+mk/100);document.getElementById(`o${n}-final`).value=final>0?final.toFixed(2)+' ‚Ç¨':'‚Äî';}
async function initComparativa(){if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);populateSelects();}
async function loadComparativa(){
  const proy=document.getElementById('comp-proyecto-sel').value;
  const el=document.getElementById('comp-list');
  if(!proy){el.innerHTML='<div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Selecciona un proyecto</div></div>';return;}
  try{
    CmpC=await sbGet('comparativa_ofertas',`?proyecto_id=eq.${proy}&order=created_at.desc`);
    if(!CmpC.length){el.innerHTML=`<div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Sin comparativas para este proyecto</div><button class="btn btn-primary" onclick="openModal('m-comparativa')">Ôºã Nueva comparativa</button></div>`;return;}
    el.innerHTML=CmpC.map(c=>{
      const ofertas=[1,2,3].map(n=>{const prov=c[`o${n}_proveedor`],final=c[`o${n}_precio_final`];return prov?`<div class="oferta-col${c.oferta_elegida==n?' ganadora':''}"><div class="oferta-title">OFERTA ${n}</div><div style="font-weight:700;margin-bottom:4px">${prov}</div><div style="font-size:12px;color:var(--text-soft)">PVP: ${fmt(c[`o${n}_pvp`])} ¬∑ Dto: ${c[`o${n}_dto`]||0}% ¬∑ Mk: ${c[`o${n}_markup`]||0}%</div><div style="font-size:14px;font-weight:700;margin-top:6px;color:var(--navy)">${fmt(final)}</div>${c[`o${n}_notas`]?`<div style="font-size:11px;color:var(--text-soft);margin-top:4px">${c[`o${n}_notas`]}</div>`:''}</div>`:'<div class="oferta-col" style="opacity:.3"><div class="oferta-title">OFERTA '+n+'</div><div style="font-size:12px;color:var(--text-soft)">Sin datos</div></div>';}).join('');
      return`<div class="card"><div class="card-header"><div class="card-title">‚öñÔ∏è ${c.trabajo}</div><button class="btn btn-danger btn-sm" onclick="confirmDelete('comparativa_ofertas','${c.id}','${c.trabajo.replace(/'/g,"\\'")}')">üóë</button></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">${ofertas}</div></div></div>`;
    }).join('');
  }catch(e){el.innerHTML=`<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`;}
}
async function saveComparativa(){
  const proy=document.getElementById('cmp-proyecto').value,trabajo=document.getElementById('cmp-trabajo').value.trim();
  if(!proy||!trabajo){toast('Proyecto y trabajo son obligatorios','error');return;}
  const d={proyecto_id:proy,trabajo};
  [1,2,3].forEach(n=>{const pvp=parseFloat(document.getElementById(`o${n}-pvp`).value)||0,dto=parseFloat(document.getElementById(`o${n}-dto`).value)||0,mk=parseFloat(document.getElementById(`o${n}-mk`).value)||0;d[`o${n}_proveedor`]=document.getElementById(`o${n}-prov`).value;d[`o${n}_pvp`]=pvp;d[`o${n}_dto`]=dto;d[`o${n}_markup`]=mk;d[`o${n}_coste`]=pvp*(1-dto/100);d[`o${n}_precio_final`]=pvp*(1-dto/100)*(1+mk/100);d[`o${n}_notas`]=document.getElementById(`o${n}-notas`).value;});
  d.oferta_elegida=parseInt(document.getElementById('cmp-elegida').value)||1;
  try{await sbPost('comparativa_ofertas',d);toast('Comparativa guardada ‚úÖ');closeModal('m-comparativa');loadComparativa();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TARIFARIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadTarifario(){
  const tb=document.getElementById('tarifario-tbody');
  try{
    TC=await sbGet('tarifario','?order=created_at.desc');
    document.getElementById('tarifario-count').textContent=TC.length+' art√≠culos';
    if(!TC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">Tarifario vac√≠o</div><button class="btn btn-primary" onclick="openModal('m-tarifario')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=TC.map(t=>`<tr data-search="${(t.codigo+t.descripcion+t.categoria+t.marca).toLowerCase()}"><td class="td-mono" style="color:var(--navy-mid);font-weight:700">${t.codigo}</td><td>${t.descripcion}</td><td style="text-align:center">${t.unidad||'Ud'}</td><td class="td-mono">${fmt(t.precio_coste)}</td><td class="td-mono" style="color:var(--green)">${fmtP(t.margen_pct)}</td><td class="td-mono" style="font-weight:700">${fmt(t.precio_venta)}</td><td>${t.categoria?`<span class="badge b-copper">${t.categoria}</span>`:'‚Äî'}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editTarifario('${t.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('tarifario','${t.id}','${t.descripcion.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function calcPrecioVenta(){const c=parseFloat(document.getElementById('t-coste').value)||0,m=parseFloat(document.getElementById('t-margen').value)||0,pv=m<100?c/(1-m/100):0;document.getElementById('t-pventa').value=pv>0?pv.toFixed(2)+' ‚Ç¨':'‚Äî';}
function editTarifario(id){const t=TC.find(x=>x.id===id);if(!t)return;document.getElementById('m-tarif-title').textContent='Editar art√≠culo';document.getElementById('t-id').value=t.id;document.getElementById('t-codigo').value=t.codigo||'';document.getElementById('t-desc').value=t.descripcion||'';document.getElementById('t-unidad').value=t.unidad||'Ud';document.getElementById('t-coste').value=t.precio_coste||0;document.getElementById('t-margen').value=t.margen_pct||30;document.getElementById('t-cat').value=t.categoria||'Mobiliario';document.getElementById('t-marca').value=t.marca||'';document.getElementById('t-notas').value=t.notas||'';calcPrecioVenta();openModal('m-tarifario');}
async function saveTarifario(){const codigo=document.getElementById('t-codigo').value.trim(),desc=document.getElementById('t-desc').value.trim();if(!codigo||!desc){toast('C√≥digo y descripci√≥n obligatorios','error');return;}const id=document.getElementById('t-id').value;const d={codigo,descripcion:desc,unidad:document.getElementById('t-unidad').value,precio_coste:parseFloat(document.getElementById('t-coste').value)||0,margen_pct:parseFloat(document.getElementById('t-margen').value)||30,categoria:document.getElementById('t-cat').value,marca:document.getElementById('t-marca').value,notas:document.getElementById('t-notas').value};try{if(id){await sbPatch('tarifario',id,d);toast('Art√≠culo actualizado ‚úÖ');}else{await sbPost('tarifario',d);toast('Art√≠culo a√±adido ‚úÖ');}closeModal('m-tarifario');document.getElementById('t-id').value='';loadTarifario();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CYPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCype(){
  const tb=document.getElementById('cype-tbody');
  try{
    if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc');
    if(!CyCache.length){tb.innerHTML=`<tr><td colspan="5"><div class="empty"><div class="empty-icon">üìê</div><div class="empty-text">Ejecuta el SQL de datos reales</div></div></td></tr>`;return;}
    const caps=[...new Set(CyCache.map(c=>c.capitulo).filter(Boolean))].sort();
    const sel=document.getElementById('filter-cype-cap');sel.innerHTML='<option value="">Todos los cap√≠tulos</option>'+caps.map(c=>`<option>${c}</option>`).join('');
    tb.innerHTML=CyCache.map(c=>`<tr data-search="${(c.codigo+c.descripcion+c.capitulo).toLowerCase()}" data-cap="${c.capitulo||''}"><td class="td-mono" style="color:var(--navy-mid);font-weight:700">${c.codigo}</td><td>${c.descripcion}</td><td style="text-align:center">${c.unidad||'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(c.precio)}</td><td><span class="badge b-gray" style="font-size:9px">${c.capitulo||'‚Äî'}</span></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="5" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function filterCype(){const q=document.getElementById('search-cype').value.toLowerCase(),cap=document.getElementById('filter-cype-cap').value;document.querySelectorAll('#cype-tbody tr[data-search]').forEach(r=>{r.style.display=(r.dataset.search.includes(q)&&(!cap||r.dataset.cap===cap))?'':'none';});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERIORISMO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadInteriorismo(){
  const tb=document.getElementById('interiorismo-tbody');
  try{
    IntC=await sbGet('interiorismo_lineas','?order=created_at.desc');
    document.getElementById('interiorismo-count').textContent=IntC.length+' l√≠neas';
    if(!IntC.length){tb.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">üõã</div><div class="empty-text">Sin propuestas</div><button class="btn btn-copper" onclick="openModal('m-interiorismo')">Ôºã A√±adir</button></div></td></tr>`;return;}
    tb.innerHTML=IntC.map(i=>`<tr data-search="${(i.proyecto_id+i.estancia+i.descripcion+i.marca).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${i.proyecto_id||'‚Äî'}</td><td>${i.estancia?`<span class="badge b-gray">${i.estancia}</span>`:'‚Äî'}</td><td class="td-mono">${i.ref_catalogo||'‚Äî'}</td><td>${i.descripcion||'‚Äî'}</td><td>${i.cantidad||1}</td><td class="td-mono" style="font-weight:700">${fmt(i.pvp_neto)}</td><td class="td-mono" style="color:var(--green)">${i.coste_neto&&i.pvp_neto?fmtP((i.pvp_neto-i.coste_neto)/i.pvp_neto*100):'‚Äî'}</td><td>${bE(i.estado_propuesta)}</td><td>${bE(i.estado_pedido)}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('interiorismo_lineas','${i.id}','${(i.descripcion||'art√≠culo').replace(/'/g,"\\'")}')">üóë</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="10" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function loadTarifarioItem(){const ref=document.getElementById('i-ref').value;if(!ref)return;const item=TC.find(t=>t.id===ref);if(!item)return;document.getElementById('i-desc').value=item.descripcion||'';document.getElementById('i-marca').value=item.marca||'';document.getElementById('i-pvp').value=item.precio_venta||0;document.getElementById('i-coste').value=item.precio_coste||0;calcIntPvp();}
function calcIntPvp(){const cant=parseFloat(document.getElementById('i-cant').value)||1,pvp=parseFloat(document.getElementById('i-pvp').value)||0,dto=parseFloat(document.getElementById('i-dto').value)||0;const neto=cant*pvp*(1-dto/100);document.getElementById('i-neto').value=neto>0?neto.toFixed(2)+' ‚Ç¨':'‚Äî';}
async function saveInteriorismo(){
  const proy=document.getElementById('i-proyecto').value;if(!proy){toast('Selecciona un proyecto','error');return;}
  const d={proyecto_id:proy,estancia:document.getElementById('i-estancia').value,ref_catalogo:document.getElementById('i-ref').value||null,descripcion:document.getElementById('i-desc').value,marca:document.getElementById('i-marca').value,acabado:document.getElementById('i-acabado').value,unidad:'Ud',cantidad:parseFloat(document.getElementById('i-cant').value)||1,pvp_catalogo:parseFloat(document.getElementById('i-pvp').value)||0,dto_cliente_pct:parseFloat(document.getElementById('i-dto').value)||0,coste_neto:parseFloat(document.getElementById('i-coste').value)||0,iva_pct:document.getElementById('i-iva').value,estado_propuesta:document.getElementById('i-eprop').value,estado_cobro:'Pendiente',estado_pedido:document.getElementById('i-eped').value,fecha_entrega:document.getElementById('i-fentrega').value||null,notas:document.getElementById('i-notas').value};
  try{await sbPost('interiorismo_lineas',d);toast('Art√≠culo a√±adido ‚úÖ');closeModal('m-interiorismo');loadInteriorismo();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPRAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCompras(){
  const tb=document.getElementById('compras-tbody');
  try{
    CoC=await sbGet('compras','?order=fecha.desc');
    document.getElementById('compras-count').textContent=CoC.length+' registros';
    if(!CoC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üõí</div><div class="empty-text">Sin compras</div><button class="btn btn-primary" onclick="openModal('m-compra')">Ôºã Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=CoC.map(c=>{const tot=c.base_imponible*(1+ivaPct(c.iva_pct)/100);return`<tr data-search="${(c.proyecto_id+c.proveedor_id+c.concepto).toLowerCase()}"><td>${fmtD(c.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${c.proyecto_id||'‚Äî'}</td><td>${c.proveedor_id||'‚Äî'}</td><td>${c.concepto||'‚Äî'}</td><td class="td-mono">${fmt(c.base_imponible)}</td><td class="td-mono">${c.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(c.estado_pago)}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('compras','${c.id}','${(c.concepto||'compra').replace(/'/g,"\\'")}')">üóë</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
async function saveCompra(){const d={fecha:document.getElementById('co-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('co-proyecto').value||null,proveedor_id:document.getElementById('co-prov').value||null,concepto:document.getElementById('co-concepto').value,base_imponible:parseFloat(document.getElementById('co-base').value)||0,iva_pct:document.getElementById('co-iva').value,estado_pago:document.getElementById('co-estado').value,fecha_vencimiento:document.getElementById('co-vto').value||null,notas:document.getElementById('co-notas').value};try{await sbPost('compras',d);toast('Compra registrada ‚úÖ');closeModal('m-compra');loadCompras();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBCONTRATAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSubcontratas(){
  const tb=document.getElementById('subcontratas-tbody');
  try{
    ScC=await sbGet('subcontratas','?order=fecha.desc');
    document.getElementById('subcontratas-count').textContent=ScC.length+' registros';
    if(!ScC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üë∑</div><div class="empty-text">Sin subcontratas</div><button class="btn btn-primary" onclick="openModal('m-subcontrata')">Ôºã Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=ScC.map(s=>{const tot=s.importe*(1+ivaPct(s.iva_pct)/100);return`<tr data-search="${(s.proyecto_id+s.proveedor_id+s.trabajo).toLowerCase()}"><td>${fmtD(s.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${s.proyecto_id||'‚Äî'}</td><td>${s.proveedor_id||'‚Äî'}</td><td>${s.trabajo||'‚Äî'}</td><td class="td-mono">${fmt(s.importe)}</td><td class="td-mono">${s.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(s.estado_pago)}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('subcontratas','${s.id}','${(s.trabajo||'subcontrata').replace(/'/g,"\\'")}')">üóë</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
async function saveSubcontrata(){const d={fecha:document.getElementById('sc-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('sc-proyecto').value||null,proveedor_id:document.getElementById('sc-prov').value||null,trabajo:document.getElementById('sc-trabajo').value,importe:parseFloat(document.getElementById('sc-importe').value)||0,iva_pct:document.getElementById('sc-iva').value,estado_pago:document.getElementById('sc-estado').value,fecha_vencimiento:document.getElementById('sc-vto').value||null};try{await sbPost('subcontratas',d);toast('Subcontrata registrada ‚úÖ');closeModal('m-subcontrata');loadSubcontratas();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HORAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadHoras(){
  const tb=document.getElementById('horas-tbody');
  try{
    HC=await sbGet('horas','?order=fecha.desc');
    document.getElementById('horas-count').textContent=HC.length+' registros';
    if(!HC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">‚è±</div><div class="empty-text">Sin horas registradas</div><button class="btn btn-primary" onclick="openModal('m-hora')">Ôºã Registrar</button></div></td></tr>`;return;}
    tb.innerHTML=HC.map(h=>`<tr data-search="${(h.proyecto_id+h.trabajador+h.descripcion).toLowerCase()}"><td>${fmtD(h.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${h.proyecto_id||'‚Äî'}</td><td><strong>${h.trabajador||'‚Äî'}</strong></td><td class="td-mono">${h.horas}h</td><td class="td-mono">${fmt(h.coste_hora)}</td><td class="td-mono" style="font-weight:700">${fmt(h.total)}</td><td style="color:var(--text-soft)">${h.descripcion||'‚Äî'}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('horas','${h.id}','horas ${h.trabajador}')">üóë</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
async function saveHora(){const d={fecha:document.getElementById('h-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('h-proyecto').value||null,trabajador:document.getElementById('h-trab').value,horas:parseFloat(document.getElementById('h-horas').value)||0,coste_hora:parseFloat(document.getElementById('h-coste').value)||18,descripcion:document.getElementById('h-desc').value};/* total es columna generada, no insertar */try{await sbPost('horas',d);toast('Horas registradas ‚úÖ');closeModal('m-hora');loadHoras();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEDIDOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPedidos(){
  // Siempre cargar proveedores para tenerlos listos
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  const tb=document.getElementById('pedidos-tbody');
  try{
    PedC=await sbGet('pedidos','?order=fecha.desc');
    document.getElementById('pedidos-count').textContent=PedC.length+' pedidos';
    if(!PedC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">Sin pedidos</div><button class="btn btn-primary" onclick="openModal('m-pedido')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PedC.map(p=>`<tr data-search="${(p.num_pedido+p.proyecto_id+p.proveedor+p.tipo).toLowerCase()}"><td class="td-mono" style="font-weight:700">${p.num_pedido||'‚Äî'}</td><td>${fmtD(p.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'‚Äî'}</td><td><span class="badge b-blue">${p.tipo||'‚Äî'}</span></td><td>${p.proveedor||'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(p.importe)}</td><td>${bE(p.estado)}</td><td style="color:var(--text-soft)">${p.observaciones||'‚Äî'}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('pedidos','${p.id}','${(p.num_pedido||'pedido').replace(/'/g,"\\'")}')">üóë</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function fillProvSelect(selId){
  const sel=document.getElementById(selId);
  if(!sel)return;
  if(!ProvC.length){
    sel.innerHTML='<option value="">Sin proveedores registrados</option>';
    return;
  }
  sel.innerHTML='<option value="">Seleccionar proveedor‚Ä¶</option>'
    +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ('+p.tipo+')':''}</option>`).join('');
}
function openPedidoModal(){
  document.getElementById('ped-id').value='';
  document.getElementById('ped-num').value='PED-'+String((PedC.length||0)+1).padStart(3,'0');
  document.getElementById('ped-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('ped-obs').value='';
  document.getElementById('ped-importe').value='';
  // Rellenar proveedores desde cach√© (cargados en init)
  const sel=document.getElementById('ped-prov');
  if(ProvC && ProvC.length>0){
    sel.innerHTML='<option value="">Seleccionar proveedor‚Ä¶</option>'
      +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ¬∑ '+p.tipo:''}</option>`).join('');
  } else {
    sel.innerHTML='<option value="">Sin proveedores ‚Äî a√±ade en men√∫ Proveedores</option>';
  }
  openModal('m-pedido');
}
async function savePedido(){const d={num_pedido:document.getElementById('ped-num').value,fecha:document.getElementById('ped-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('ped-proyecto').value||null,tipo:document.getElementById('ped-tipo').value,proveedor:document.getElementById('ped-prov').value,importe:parseFloat(document.getElementById('ped-importe').value)||0,estado:document.getElementById('ped-estado').value,observaciones:document.getElementById('ped-obs').value};try{await sbPost('pedidos',d);toast('Pedido registrado ‚úÖ');closeModal('m-pedido');loadPedidos();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROL HORARIO ANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadControlHorario(){
  const trab=document.getElementById('ch-trab-sel').value;
  const year=parseInt(document.getElementById('ch-year-sel').value)||2026;
  const grid=document.getElementById('ch-meses-grid');
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-soft)">Cargando‚Ä¶</div>';
  try{
    const data=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&anyo=eq.${year}&order=fecha.asc`);
    const horasByFecha={};data.forEach(d=>{horasByFecha[d.fecha]={horas:d.horas,tipo:d.tipo};});
    let totalHoras=0,diasTrab=0;
    grid.innerHTML='';
    for(let mes=0;mes<12;mes++){
      const primerDia=new Date(year,mes,1);
      const diasMes=new Date(year,mes+1,0).getDate();
      const diaInicio=(primerDia.getDay()+6)%7; // Lunes=0
      let html=`<div class="card"><div class="card-header"><div class="card-title">üìÖ ${MESES[mes]} ${year}</div></div><div class="card-body" style="padding:10px">`;
      html+='<div class="horario-grid">';
      DIAS_CORTOS.forEach(d=>{html+=`<div class="day-header">${d}</div>`;});
      for(let i=0;i<diaInicio;i++)html+='<div></div>';
      for(let d=1;d<=diasMes;d++){
        const fecha=`${year}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const diaSem=(new Date(year,mes,d).getDay()+6)%7;
        const reg=horasByFecha[fecha];
        let cls='horario-day';
        if(diaSem>=5)cls+=' weekend';
        if(reg){cls+=' trabajado';if(reg.horas>0){totalHoras+=reg.horas;diasTrab++;}}
        html+=`<div class="${cls}" onclick="toggleHorario('${fecha}','${trab}',${year})" title="${fecha}">
          <div class="horario-day-num">${d}</div>
          ${reg&&reg.horas>0?`<div class="horario-day-h">${reg.horas}h</div>`:''}
        </div>`;
      }
      html+='</div></div></div>';
      grid.innerHTML+=html;
    }
    document.getElementById('ch-resumen').textContent=`${diasTrab} d√≠as ¬∑ ${totalHoras}h totales`;
  }catch(e){grid.innerHTML=`<div style="color:var(--red);padding:20px;grid-column:1/-1">Error: ${e.message}. Aseg√∫rate de haber ejecutado el SQL de nuevas tablas.</div>`;}
}
async function toggleHorario(fecha,trab,year){
  try{
    const exist=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&fecha=eq.${fecha}`);
    if(exist.length){await sbDelete('control_horario',exist[0].id);toast('D√≠a borrado');}
    else{await sbPost('control_horario',{trabajador:trab,fecha,horas:8,tipo:'Trabajo',anyo:year});toast('D√≠a registrado ‚úÖ');}
    loadControlHorario();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROVEEDORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProveedores(){
  const tb=document.getElementById('proveedores-tbody');
  try{
    ProvC=await sbGet('proveedores','?order=nombre.asc');
    document.getElementById('proveedores-count').textContent=ProvC.length+' proveedores';
    if(!ProvC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üè≠</div><div class="empty-text">Sin proveedores</div></div></td></tr>`;return;}
    tb.innerHTML=ProvC.map(p=>`<tr data-search="${(p.nombre+p.cif+p.especialidad+p.tipo).toLowerCase()}"><td><strong>${p.nombre}</strong></td><td class="td-mono">${p.cif||'‚Äî'}</td><td>${bE(p.tipo)}</td><td>${p.especialidad||'‚Äî'}</td><td>${p.telefono||'‚Äî'}</td><td style="color:var(--navy-mid)">${p.email||'‚Äî'}</td><td>${p.forma_pago||'‚Äî'}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProveedor('${p.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proveedores','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editProveedor(id){const p=ProvC.find(x=>x.id===id);if(!p)return;document.getElementById('pv-id').value=p.id;document.getElementById('pv-nombre').value=p.nombre||'';document.getElementById('pv-cif').value=p.cif||'';document.getElementById('pv-tipo').value=p.tipo||'Proveedor';document.getElementById('pv-tel').value=p.telefono||'';document.getElementById('pv-email').value=p.email||'';document.getElementById('pv-esp').value=p.especialidad||'';document.getElementById('pv-pago').value=p.forma_pago||'Transferencia';document.getElementById('pv-iban').value=p.iban||'';document.getElementById('pv-notas').value=p.notas||'';openModal('m-proveedor');}
async function saveProveedor(){const nombre=document.getElementById('pv-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}const id=document.getElementById('pv-id').value;const d={nombre,cif:document.getElementById('pv-cif').value,tipo:document.getElementById('pv-tipo').value,telefono:document.getElementById('pv-tel').value,email:document.getElementById('pv-email').value,especialidad:document.getElementById('pv-esp').value,forma_pago:document.getElementById('pv-pago').value,iban:document.getElementById('pv-iban').value,notas:document.getElementById('pv-notas').value};try{if(id){await sbPatch('proveedores',id,d);toast('Proveedor actualizado ‚úÖ');}else{d.proveedor_id=genId('PRV',ProvC,'proveedor_id');await sbPost('proveedores',d);toast('Proveedor guardado ‚úÖ');}closeModal('m-proveedor');document.getElementById('pv-id').value='';loadProveedores();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENTABILIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initRentabilidad(){if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);populateSelects();}
async function loadRentabilidad(){
  const proy=document.getElementById('rent-proyecto-sel').value,ver=document.getElementById('rent-version-sel').value;
  document.getElementById('rent-kpis').style.display='none';document.getElementById('rent-empty').style.display=proy?'none':'block';
  if(!proy)return;
  try{
    const[lineas,compras,subcs,horas,facturas]=await Promise.all([sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}`),sbGet('compras',`?proyecto_id=eq.${proy}`),sbGet('subcontratas',`?proyecto_id=eq.${proy}`),sbGet('horas',`?proyecto_id=eq.${proy}`),sbGet('facturas',`?proyecto_id=eq.${proy}`)]);
    const totalPres=lineas.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
    const totalCompras=compras.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalSubcs=subcs.reduce((s,c)=>s+(c.importe||0),0);
    const totalHoras=horas.reduce((s,h)=>s+(h.total||0),0);
    const totalCoste=totalCompras+totalSubcs+totalHoras;
    const beneficio=totalPres-totalCoste,margen=totalPres>0?(beneficio/totalPres)*100:0;
    const pct=totalPres>0?Math.min((totalCoste/totalPres)*100,150):0;
    document.getElementById('rk-pres').textContent=fmt(totalPres);document.getElementById('rk-coste').textContent=fmt(totalCoste);
    document.getElementById('rk-benef').textContent=fmt(beneficio);document.getElementById('rk-benef').style.color=beneficio>=0?'var(--green)':'var(--red)';
    document.getElementById('rk-margen').textContent=fmtP(margen);document.getElementById('rk-margen').style.color=margen>=15?'var(--green)':margen>=0?'var(--amber)':'var(--red)';
    const bar=document.getElementById('rent-bar');bar.style.width=Math.min(pct,100)+'%';bar.style.background=pct<80?'var(--green)':pct<100?'var(--copper)':'var(--red)';
    document.getElementById('rent-bar-label').textContent=`${pct.toFixed(1)}% consumido`;document.getElementById('rent-bar-nums').textContent=`${fmt(totalCoste)} de ${fmt(totalPres)}`;
    document.getElementById('rk-compras-total').textContent=fmt(totalCompras);
    document.getElementById('rk-compras-list').innerHTML=compras.length?compras.map(c=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(c.fecha)}</td><td style="padding:5px 10px">${c.concepto||c.proveedor_id||'‚Äî'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(c.base_imponible)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin compras</td></tr>';
    document.getElementById('rk-sub-total').textContent=fmt(totalSubcs);
    document.getElementById('rk-sub-list').innerHTML=subcs.length?subcs.map(s=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(s.fecha)}</td><td style="padding:5px 10px">${s.trabajo||'‚Äî'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(s.importe)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin subcontratas</td></tr>';
    document.getElementById('rk-horas-total').textContent=fmt(totalHoras);
    const horPorTrab={};horas.forEach(h=>{horPorTrab[h.trabajador]=(horPorTrab[h.trabajador]||0)+(h.total||0);});
    document.getElementById('rk-horas-list').innerHTML=Object.keys(horPorTrab).length?Object.entries(horPorTrab).map(([t,v])=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px" colspan="2">${t}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(v)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin horas</td></tr>';
    const totalFact=facturas.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('rk-fact-total').textContent=fmt(totalFact);
    document.getElementById('rk-fact-list').innerHTML=facturas.length?facturas.map(f=>{const tot=(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);return`<tr><td style="padding:7px 10px;font-weight:700">${f.num_factura||'‚Äî'}</td><td style="padding:7px 10px">${fmtD(f.fecha_emision)}</td><td style="padding:7px 10px">${fmt(f.base_imponible)}</td><td style="padding:7px 10px;font-weight:700">${fmt(tot)}</td><td style="padding:7px 10px">${bE(f.estado)}</td></tr>`;}).join(''):'<tr><td colspan="5" style="text-align:center;padding:12px;color:var(--text-soft)">Sin facturas</td></tr>';
    document.getElementById('rent-kpis').style.display='block';
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACTURAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFacturas(){
  const tb=document.getElementById('facturas-tbody');
  try{
    FC=await sbGet('facturas','?order=fecha_emision.desc');
    document.getElementById('facturas-count').textContent=FC.length+' facturas';
    let totFact=0,totCob=0,totPdte=0,totVenc=0;
    FC.forEach(f=>{const tot=(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),cob=f.importe_cobrado||0,pdte=tot-cob;totFact+=tot;totCob+=cob;totPdte+=pdte;if(f.estado==='Vencida')totVenc+=pdte;});
    document.getElementById('fk-total').textContent=fmt(totFact);document.getElementById('fk-cobrado').textContent=fmt(totCob);document.getElementById('fk-pendiente').textContent=fmt(totPdte);document.getElementById('fk-vencidas').textContent=fmt(totVenc);
    if(!FC.length){tb.innerHTML=`<tr><td colspan="12"><div class="empty"><div class="empty-icon">üßæ</div><div class="empty-text">Sin facturas</div><button class="btn btn-primary" onclick="openModal('m-factura')">Ôºã Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=FC.map(f=>{const tot=(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),cob=f.importe_cobrado||0,pdte=tot-cob;return`<tr data-search="${(f.num_factura+f.cliente_id+f.proyecto_id+f.concepto).toLowerCase()}"><td class="td-mono" style="font-weight:700">${f.num_factura||'‚Äî'}</td><td>${fmtD(f.fecha_emision)}</td><td>${fmtD(f.fecha_vencimiento)}</td><td>${f.cliente_id||'‚Äî'}</td><td class="td-mono" style="color:var(--text-soft)">${f.proyecto_id||'‚Äî'}</td><td class="td-mono">${fmt(f.base_imponible)}</td><td class="td-mono">${f.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td class="td-mono" style="color:var(--green)">${fmt(cob)}</td><td class="td-mono" style="color:${pdte>0?'var(--amber)':'var(--green)'}">${fmt(pdte)}</td><td>${bE(f.estado)}</td><td><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('facturas','${f.id}','${(f.num_factura||'factura').replace(/'/g,"\\'")}')">üóë</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="12" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
async function saveFactura(){const d={num_factura:document.getElementById('f-num').value,fecha_emision:document.getElementById('f-fecha').value||new Date().toISOString().split('T')[0],cliente_id:document.getElementById('f-cliente').value||null,proyecto_id:document.getElementById('f-proyecto').value||null,base_imponible:parseFloat(document.getElementById('f-base').value)||0,iva_pct:document.getElementById('f-iva').value,forma_pago:document.getElementById('f-pago').value,fecha_vencimiento:document.getElementById('f-vto').value||null,estado:document.getElementById('f-estado').value,importe_cobrado:parseFloat(document.getElementById('f-cobrado').value)||0,concepto:document.getElementById('f-concepto').value};try{await sbPost('facturas',d);toast('Factura guardada ‚úÖ');closeModal('m-factura');loadFacturas();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTABILIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadContabilidad(){
  try{
    const[comp,subc,hor,fac]=await Promise.all([sbGet('compras'),sbGet('subcontratas'),sbGet('horas'),sbGet('facturas')]);
    const ventas=fac.reduce((s,f)=>s+(f.base_imponible||0),0);
    const ivaRep=fac.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const comprasB=comp.reduce((s,c)=>s+(c.base_imponible||0),0);
    const ivaComp=comp.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const subcsB=subc.reduce((s,c)=>s+(c.importe||0),0);
    const ivaSub=subc.reduce((s,c)=>s+(c.importe||0)*ivaPct(c.iva_pct)/100,0);
    const mo=hor.reduce((s,h)=>s+(h.total||0),0);
    const gastos=comprasB+subcsB+mo;
    const resultado=ventas-gastos;
    const margen=ventas>0?(resultado/ventas)*100:0;

    // Cuenta resultados
    document.getElementById('cnt-ventas').textContent=fmt(ventas);
    document.getElementById('cnt-iva-rep').textContent=fmt(ivaRep);
    document.getElementById('cnt-ing-tot').textContent=fmt(ventas+ivaRep);
    document.getElementById('cnt-compras').textContent=fmt(comprasB);
    document.getElementById('cnt-iva-comp').textContent=fmt(ivaComp);
    document.getElementById('cnt-subcs').textContent=fmt(subcsB);
    document.getElementById('cnt-iva-sub').textContent=fmt(ivaSub);
    document.getElementById('cnt-mo').textContent=fmt(mo);
    document.getElementById('cnt-gastos-tot').textContent=fmt(gastos);
    document.getElementById('cnt-result').textContent=fmt(resultado);
    document.getElementById('cnt-margen').textContent=fmtP(margen);
    const rr=document.getElementById('cnt-result-row');rr.className='cuenta-row result'+(resultado<0?' neg':'');

    // IVA
    document.getElementById('iva-rep').textContent=fmt(ivaRep);
    document.getElementById('iva-comp').textContent=fmt(ivaComp);
    document.getElementById('iva-sub').textContent=fmt(ivaSub);
    document.getElementById('iva-sop-tot').textContent=fmt(ivaComp+ivaSub);
    const ivaNeto=ivaRep-ivaComp-ivaSub;
    document.getElementById('iva-neto').textContent=fmt(ivaNeto);
    document.getElementById('iva-result-row').className='cuenta-row result'+(ivaNeto<0?' neg':'');

    // Balance
    const pendCobro=fac.filter(f=>f.estado!=='Cobrada').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100)-(f.importe_cobrado||0),0);
    const pendProv=comp.filter(c=>c.estado_pago!=='Pagado').reduce((s,c)=>s+(c.base_imponible||0),0);
    const pendSub=subc.filter(c=>c.estado_pago!=='Pagado').reduce((s,c)=>s+(c.importe||0),0);
    document.getElementById('bal-cli').textContent=fmt(pendCobro);
    document.getElementById('bal-iva').textContent=fmt(Math.max(0,ivaNeto));
    document.getElementById('bal-prov').textContent=fmt(pendProv);
    document.getElementById('bal-sub').textContent=fmt(pendSub);
  }catch(e){toast('Error cargando contabilidad: '+e.message,'error');}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO FINAL (documento imprimible)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadConfiguracion(){
  try{
    const data=await sbGet('configuracion');
    const map={};data.forEach(d=>{map[d.clave]=d.valor;});
    document.getElementById('cfg-razon').value=map.razon_social||'PAU INTERIORISMO S.L.';
    document.getElementById('cfg-cif').value=map.cif||'B-56909641';
    document.getElementById('cfg-tel').value=map.telefono||'961 20 0187';
    document.getElementById('cfg-email').value=map.email||'info@pauinteriorismo.com';
    document.getElementById('cfg-web').value=map.web||'www.pauinteriorismo.com';
    document.getElementById('cfg-dir').value=map.direccion||'';
    document.getElementById('cfg-ci').value=map.ci_pct||3;
    document.getElementById('cfg-gg').value=map.gg_pct||13;
    document.getElementById('cfg-bi').value=map.bi_pct||6;
    document.getElementById('cfg-hora').value=map.coste_hora_defecto||18;
    const total=(parseFloat(map.ci_pct)||3)+(parseFloat(map.gg_pct)||13)+(parseFloat(map.bi_pct)||6);
    document.getElementById('cfg-total-ci').value=total.toFixed(1)+'%';
    ['cfg-ci','cfg-gg','cfg-bi'].forEach(id=>{document.getElementById(id).addEventListener('input',()=>{const ci=parseFloat(document.getElementById('cfg-ci').value)||0,gg=parseFloat(document.getElementById('cfg-gg').value)||0,bi=parseFloat(document.getElementById('cfg-bi').value)||0;document.getElementById('cfg-total-ci').value=(ci+gg+bi).toFixed(1)+'%';});});
  }catch(e){toast('Configura la tabla configuracion ejecutando el SQL de nuevas tablas','error');}
}
async function saveConfig(){
  const updates=[
    ['razon_social', document.getElementById('cfg-razon')?.value],
    ['cif',          document.getElementById('cfg-cif')?.value],
    ['telefono',     document.getElementById('cfg-tel')?.value],
    ['email',        document.getElementById('cfg-email')?.value],
    ['web',          document.getElementById('cfg-web')?.value],
    ['direccion',    document.getElementById('cfg-dir')?.value],
    ['ci_pct',       document.getElementById('cfg-ci')?.value],
    ['gg_pct',       document.getElementById('cfg-gg')?.value],
    ['bi_pct',       document.getElementById('cfg-bi')?.value],
    ['coste_hora_defecto', document.getElementById('cfg-hora')?.value],
  ];
  try{
    for(const[k,v] of updates){
      if(v===undefined||v===null) continue;
      await upsertConfig(k, v);
    }
    toast('Configuraci√≥n guardada ‚úÖ');
  }catch(e){
    toast('Error guardando: '+e.message,'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADERS MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const loaders={
  gerencia:loadGerencia,clientes:loadClientes,proyectos:loadProyectos,
  presupuesto:()=>{initPresupuesto();if(document.getElementById('pres-proyecto-sel').value)loadPresupuesto();},
  comparativa:()=>{initComparativa();if(document.getElementById('comp-proyecto-sel').value)loadComparativa();},
  tarifario:loadTarifario,cype:loadCype,interiorismo:loadInteriorismo,
  compras:loadCompras,subcontratas:loadSubcontratas,horas:loadHoras,
  pedidos:loadPedidos,control_horario:loadControlHorario,
  proveedores:loadProveedores,
  rentabilidad:()=>{initRentabilidad();if(document.getElementById('rent-proyecto-sel').value)loadRentabilidad();},
  facturas:loadFacturas,contabilidad:loadContabilidad,configuracion:loadConfiguracion,
  pres_final:async()=>{
    const sel=document.getElementById('pf-proyecto-sel');
    sel.innerHTML='<option value="">Cargando proyectos‚Ä¶</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      if(!PC.length){
        sel.innerHTML='<option value="">Sin proyectos ‚Äî crea uno primero</option>';
        return;
      }
      sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error al cargar: '+e.message+'</option>';
      toast('Error cargando proyectos: '+e.message,'error');
    }
  },
  contrato:async()=>{
    const sel=document.getElementById('ct-proyecto-sel');
    sel.innerHTML='<option value="">Cargando‚Ä¶</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error: '+e.message+'</option>';
    }
  },
  pedido_doc:async()=>{
    PedC=await sbGet('pedidos','?order=fecha.desc').catch(()=>[]);
    if(!ProvC.length)ProvC=await sbGet('proveedores','?order=nombre.asc').catch(()=>[]);
    if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
    const sel=document.getElementById('pd-pedido-sel');
    sel.innerHTML='<option value="">Seleccionar pedido‚Ä¶</option>'+PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin n¬∫'} ¬∑ ${p.proveedor||'‚Äî'} ¬∑ ${p.importe?p.importe.toFixed(2)+'‚Ç¨':'‚Äî'}</option>`).join('');
  },
  listas:()=>{
    const r=(id,arr)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(t=>`<div class="lista-item" data-val="${t}">${t}</div>`).join('');};
    r('trabajadores-list',TRABAJADORES);
    r('estados-list',LISTAS.estados_proyecto);
    r('tipos-proyecto-list',LISTAS.tipos_proyecto);
    r('formas-pago-list',LISTAS.formas_pago);
    r('tipos-cliente-list',LISTAS.tipos_cliente);
    r('tipos-proveedor-list',LISTAS.tipos_proveedor);
    r('estancias-list',LISTAS.estancias);
    r('categorias-list',LISTAS.categorias_tarifario);
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  const today=new Date().toISOString().split('T')[0];
  ['co-fecha','sc-fecha','h-fecha','f-fecha','ped-fecha'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
  await loadGerencia();
  // Cargar proveedores al inicio para tenerlos siempre disponibles
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  // Cargar trabajadores personalizados desde Supabase
  try{
    const allCfg=await sbGet('configuracion','?clave=in.(trabajadores,estados_proyecto,tipos_proyecto,formas_pago,tipos_cliente,tipos_proveedor,estancias,categorias_tarifario)');
    allCfg.forEach(row=>{
      const vals=row.valor.split(',').map(t=>t.trim()).filter(Boolean);
      if(row.clave==='trabajadores') TRABAJADORES=vals;
      else if(LISTAS[row.clave]) LISTAS[row.clave]=vals;
    });
  }catch(e){}
  populateSelects();
  populateIntCatalog();
  populateTrabajadores();
  populateAllListas();
}
</script>
</body>
</html>
