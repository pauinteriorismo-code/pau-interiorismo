<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a2a3a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PAU GestiÃ³n">
<link rel="manifest" href="manifest.json">
<title>PAU INTERIORISMO Â· GestiÃ³n</title>
<style>
:root{--navy:#1a2a3a;--navy-mid:#27405b;--navy-light:#3d5a78;--blue-soft:#b8cce4;--blue-light:#e8f4ff;--cream:#f7f4ef;--sand:#ede8df;--copper:#b87333;--copper-light:#f4e8da;--green:#1e6b3d;--green-soft:#d5e8d4;--amber:#7d6608;--amber-soft:#fff2cc;--red:#7b241c;--red-soft:#fce8e6;--white:#fff;--text:#1a2a3a;--text-mid:#4a5f72;--text-soft:#8a9aaa;--border:#dce6f0;--radius:8px;--radius-sm:4px;--shadow:0 1px 3px rgba(26,42,58,.08),0 4px 16px rgba(26,42,58,.06);--shadow-lg:0 8px 32px rgba(26,42,58,.14);--sidebar:220px;--header:56px}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;color:var(--text);background:var(--cream)}
button,input,select,textarea{font-family:inherit}button{cursor:pointer}
/* LOGIN */
.login-screen{position:fixed;inset:0;background:var(--navy);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:var(--white);border-radius:var(--radius);padding:40px;width:340px;box-shadow:var(--shadow-lg);text-align:center}
.login-logo{font-size:15px;font-weight:700;color:var(--navy);letter-spacing:.06em;margin-bottom:4px}
.login-sub{font-size:10px;color:var(--text-soft);margin-bottom:28px;letter-spacing:.08em;text-transform:uppercase}
.login-error{background:var(--red-soft);color:var(--red);font-size:12px;padding:8px 12px;border-radius:var(--radius-sm);margin-bottom:12px;display:none}
/* APP */
.app{display:flex;height:100vh;overflow:hidden}
/* SIDEBAR */
.sidebar{width:var(--sidebar);background:var(--navy);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;z-index:10}
.sidebar-logo{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-size:13px;font-weight:700;color:#fff;letter-spacing:.04em}
.brand-sub{font-size:10px;color:rgba(255,255,255,.35);letter-spacing:.08em;text-transform:uppercase;margin-top:2px}
.nav-section{padding:12px 0 4px}
.nav-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.3);padding:0 16px 5px}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 16px;cursor:pointer;font-size:12px;color:rgba(255,255,255,.6);border-left:2px solid transparent;transition:all .15s;white-space:nowrap}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:var(--copper)}
.nav-item .ni{font-size:13px;width:16px;text-align:center}
.nav-badge{margin-left:auto;background:var(--copper);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px}
.sidebar-bottom{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.08)}
.user-card{display:flex;align-items:center;gap:8px}
.user-av{width:28px;height:28px;border-radius:50%;background:var(--copper);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.user-name{font-size:12px;color:rgba(255,255,255,.8);font-weight:600}
.user-role{font-size:10px;color:rgba(255,255,255,.35)}
/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:var(--header);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:10px;flex-shrink:0}
.topbar-title{font-size:14px;font-weight:700;color:var(--navy)}
.topbar-bc{font-size:11px;color:var(--text-soft);margin-top:1px}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:7px}
.content{flex:1;overflow-y:auto;padding:18px 20px}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;border:none;transition:all .15s;cursor:pointer}
.btn-primary{background:var(--navy-mid);color:#fff}.btn-primary:hover{background:var(--navy)}
.btn-ghost{background:transparent;color:var(--text-mid);border:1px solid var(--border)}.btn-ghost:hover{background:var(--sand)}
.btn-copper{background:var(--copper);color:#fff}.btn-copper:hover{background:#9a6028}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#621a14}
.btn-sm{padding:4px 9px;font-size:11px}
.btn-icon{padding:5px;width:28px;height:28px;justify-content:center}
/* CARDS */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;border-bottom:1px solid var(--border)}
.card-title{font-size:13px;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:7px}
.card-body{padding:14px 16px}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.kpi{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:13px 15px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.kpi.blue::before{background:var(--navy-mid)}.kpi.green::before{background:var(--green)}
.kpi.amber::before{background:var(--copper)}.kpi.red::before{background:var(--red)}
.kpi.purple::before{background:#6b3fa0}
.kpi-label{font-size:11px;color:var(--text-soft);font-weight:500}
.kpi-value{font-size:19px;font-weight:700;color:var(--navy);margin:3px 0;font-variant-numeric:tabular-nums}
.kpi-sub{font-size:11px;color:var(--text-soft)}
/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--navy);color:#fff;padding:8px 10px;text-align:left;font-size:11px;font-weight:600;letter-spacing:.04em;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--blue-light)}
tbody td{padding:7px 10px;vertical-align:middle}
.td-mono{font-family:'Courier New',monospace;font-size:11px}
.td-actions{display:flex;gap:3px}
/* BADGES */
.badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap}
.b-green{background:var(--green-soft);color:var(--green)}.b-amber{background:var(--amber-soft);color:var(--amber)}
.b-red{background:var(--red-soft);color:var(--red)}.b-blue{background:var(--blue-light);color:var(--navy-mid)}
.b-navy{background:var(--navy);color:#fff}.b-copper{background:var(--copper-light);color:var(--copper)}
.b-gray{background:var(--sand);color:var(--text-mid)}
/* VIEWS */
.view{display:none}.view.active{display:block}
/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-full{grid-column:1/-1}.fg-3{grid-column:span 1}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:11px;font-weight:600;color:var(--text-mid)}
.form-input{padding:7px 9px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;width:100%}
.form-input:focus{border-color:var(--navy-mid);box-shadow:0 0 0 3px rgba(39,64,91,.1)}
.form-input[readonly]{background:var(--sand);color:var(--text-soft)}
.form-input.calc{background:var(--green-soft);color:var(--green);font-weight:700}
.form-input.winner{background:var(--green-soft);color:var(--green);font-weight:700}
/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--white);border-radius:var(--radius);width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);transform:translateY(10px);transition:transform .2s}
.overlay.open .modal{transform:translateY(0)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:1}
.modal-title{font-size:14px;font-weight:700;color:var(--navy)}
.modal-close{background:none;border:none;font-size:22px;color:var(--text-soft);line-height:1;padding:0}
.modal-body{padding:20px}
.modal-foot{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;position:sticky;bottom:0;background:var(--white)}
.modal-section{font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.08em;margin:16px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
/* INFO BOX */
.info-box{background:var(--blue-light);border:1px solid var(--blue-soft);border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--navy-mid);margin-bottom:14px}
.warn-box{background:var(--amber-soft);border:1px solid #e6c80a;border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--amber);margin-bottom:14px}
/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px}
.search-wrap input{padding-left:30px}
.search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-soft);font-size:12px;pointer-events:none}
/* EMPTY / LOADING */
.loading{text-align:center;padding:35px;color:var(--text-soft);font-size:13px}
.empty{text-align:center;padding:45px 20px;color:var(--text-soft)}
.empty-icon{font-size:38px;margin-bottom:10px}.empty-text{font-size:13px;margin-bottom:14px}
/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:11px 18px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:999;box-shadow:var(--shadow-lg);transform:translateY(20px);opacity:0;transition:all .3s;max-width:300px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green)}.toast.error{background:var(--red)}
/* CONFIRM */
.confirm-overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:var(--white);border-radius:var(--radius);padding:26px;width:330px;box-shadow:var(--shadow-lg);text-align:center}
.confirm-title{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:8px}
.confirm-text{font-size:13px;color:var(--text-mid);margin-bottom:18px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
/* CONTROL HORARIO */
.horario-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
.horario-day{background:var(--white);border:1px solid var(--border);border-radius:4px;padding:5px;text-align:center;font-size:11px;cursor:pointer;min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .15s}
.horario-day:hover{border-color:var(--navy-mid);background:var(--blue-light)}
.horario-day.weekend{background:var(--sand)}.horario-day.festivo{background:var(--amber-soft)}
.horario-day.trabajado{background:var(--green-soft);border-color:var(--green)}
.horario-day.ausente{background:var(--red-soft);border-color:var(--red)}
.horario-day-num{font-weight:700;font-size:12px;color:var(--navy)}
.horario-day-h{font-size:10px;color:var(--green);font-weight:600}
.day-header{background:var(--navy);color:#fff;padding:5px;text-align:center;font-size:10px;font-weight:700;border-radius:4px}
/* COMPARATIVA */
.oferta-col{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative}
.oferta-col.ganadora{border-color:var(--green);background:var(--green-soft)}
.oferta-col.ganadora::before{content:'âœ… ELEGIDA';position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;font-size:10px;font-weight:700;padding:2px 10px;border-radius:10px}
.oferta-title{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px;text-align:center}
/* TABS */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px}
.tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--text-soft);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--navy)}.tab.active{color:var(--navy);border-bottom-color:var(--copper)}
.tab-content{display:none}.tab-content.active{display:block}
/* CONTABILIDAD */
.cuenta-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.cuenta-row.header{background:var(--navy);color:#fff;font-weight:700;border-radius:4px 4px 0 0}
.cuenta-row.total{background:var(--sand);font-weight:700}
.cuenta-row.result{background:var(--green-soft);font-weight:700;color:var(--green)}
.cuenta-row.result.neg{background:var(--red-soft);color:var(--red)}
/* PROG BAR */
.prog-wrap{background:var(--sand);border-radius:4px;height:16px;overflow:hidden;margin:6px 0}
.prog-bar{height:100%;border-radius:4px;transition:width .5s}
.lista-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--sand);border-radius:var(--radius-sm);font-size:12px;margin-bottom:5px}
.lista-item:hover{background:var(--blue-light)}
@media(max-width:768px){.sidebar{width:52px}.brand,.brand-sub,.nav-label,.nav-item span:not(.ni),.nav-badge,.user-name,.user-role{display:none}.nav-item{justify-content:center;padding:9px}.kpi-grid,.kpi-grid-3{grid-template-columns:1fr 1fr}.form-grid{grid-template-columns:1fr}.fg-full{grid-column:1}.content{padding:12px}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  .no-print { display: none !important; }
  input, textarea { border: none !important; background: transparent !important; outline: none !important; resize: none !important; }
  input::placeholder, textarea::placeholder { color: transparent !important; }

  /* Hide everything except the document */
  .sidebar, .topbar, .search-bar, .btn, 
  .nav-item, .overlay, .toast, .confirm-overlay,
  #login-screen { display: none !important; }
  
  /* Reset layout */
  body { background: white !important; }
  .app { display: block !important; }
  .main { display: block !important; overflow: visible !important; }
  .content { padding: 0 !important; overflow: visible !important; }
  
  /* Hide all views except the active one */
  .view { display: none !important; }
  .view.active { display: block !important; }
  
  /* Hide search bar and controls inside active view */
  .view.active .search-bar { display: none !important; }
  .view.active .kpi, .view.active .card:not(#pf-doc):not(#ct-doc):not(#pd-doc) { display: none !important; }
  
  /* Show ONLY the document div */
  #pf-doc, #ct-doc, #pd-doc {
    display: block !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    padding: 20mm !important;
    max-width: 100% !important;
    width: 210mm !important;
    min-height: 297mm !important;
    font-size: 11pt !important;
    page-break-after: always;
  }

  /* Page setup */
  @page {
    size: A4;
    margin: 0;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">PAU INTERIORISMO S.L.</div>
    <div class="login-sub">Sistema de gestiÃ³n Â· Acceso privado</div>
    <div class="login-error" id="login-error">Usuario o contraseÃ±a incorrectos</div>
    <div class="form-group" style="margin-bottom:11px;text-align:left"><label class="form-label">Usuario</label><input class="form-input" id="login-user" placeholder="usuario" autocomplete="username"></div>
    <div class="form-group" style="margin-bottom:18px;text-align:left"><label class="form-label">ContraseÃ±a</label><input class="form-input" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px" onclick="doLogin()">Entrar â†’</button>
  </div>
</div>

<!-- APP -->
<div class="app">
<nav class="sidebar">
  <div class="sidebar-logo"><div class="brand">PAU INTERIORISMO</div><div class="brand-sub">Sistema de gestiÃ³n Â· <span style="color:#b87333">v32</span></div></div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" data-view="gerencia"><span class="ni">ğŸ </span><span>Gerencia</span></div>
    <div class="nav-item" data-view="clientes"><span class="ni">ğŸ¤</span><span>Clientes</span></div>
    <div class="nav-item" data-view="proyectos"><span class="ni">ğŸ“</span><span>Proyectos</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">PresupuestaciÃ³n</div>
    <div class="nav-item" data-view="presupuesto"><span class="ni">ğŸ’°</span><span>Presupuesto</span></div>
    <div class="nav-item" data-view="comparativa"><span class="ni">âš–ï¸</span><span>Comparativa ofertas</span></div>
    <div class="nav-item" data-view="tarifario"><span class="ni">ğŸ“‹</span><span>Tarifario</span></div>
    <div class="nav-item" data-view="cype"><span class="ni">ğŸ“</span><span>CYPE 2026</span><span class="nav-badge" id="cype-badge">524</span></div>
    <div class="nav-item" data-view="interiorismo"><span class="ni">ğŸ›‹</span><span>Interiorismo</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">EjecuciÃ³n</div>
    <div class="nav-item" data-view="compras"><span class="ni">ğŸ›’</span><span>Compras</span></div>
    <div class="nav-item" data-view="subcontratas"><span class="ni">ğŸ‘·</span><span>Subcontratas</span></div>
    <div class="nav-item" data-view="horas"><span class="ni">â±</span><span>Horas</span></div>
    <div class="nav-item" data-view="pedidos"><span class="ni">ğŸ“¦</span><span>Pedidos</span></div>
    <div class="nav-item" data-view="control_horario"><span class="ni">ğŸ“…</span><span>Control horario</span></div>
    <div class="nav-item" data-view="proveedores"><span class="ni">ğŸ­</span><span>Proveedores</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Cierre</div>
    <div class="nav-item" data-view="rentabilidad"><span class="ni">ğŸ“ˆ</span><span>Rentabilidad</span></div>
    <div class="nav-item" data-view="facturas"><span class="ni">ğŸ§¾</span><span>Facturas</span></div>
    <div class="nav-item" data-view="conciliacion"><span class="ni">ğŸ¦</span><span>ConciliaciÃ³n bancaria</span></div>
    <div class="nav-item" data-view="contabilidad"><span class="ni">ğŸ“Š</span><span>Contabilidad</span></div>
    <div class="nav-item" data-view="informe_mensual"><span class="ni">ğŸ“…</span><span>Informe mensual</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Sistema</div>
    <div class="nav-item" data-view="pres_final"><span class="ni">ğŸ“„</span><span>Presupuesto final</span></div>
    <div class="nav-item" data-view="contrato"><span class="ni">ğŸ“</span><span>Contrato</span></div>
    <div class="nav-item" data-view="pedido_doc"><span class="ni">ğŸ“‹</span><span>Doc. Pedido</span></div>
    <div class="nav-item" data-view="listas"><span class="ni">ğŸ—‚</span><span>Listas</span></div>
    <div class="nav-item" data-view="configuracion"><span class="ni">âš™ï¸</span><span>ConfiguraciÃ³n</span></div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card"><div class="user-av" id="user-av">JA</div><div><div class="user-name" id="user-name">Jose</div><div class="user-role">Administrador</div></div></div>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <div><div class="topbar-title" id="tb-title">Gerencia Â· Panel ejecutivo</div><div class="topbar-bc" id="tb-bc">Datos en tiempo real</div></div>
    <div class="topbar-right">
      <div id="conn-status" style="font-size:11px;padding:3px 9px;border-radius:10px;background:var(--amber-soft);color:var(--amber);font-weight:600">â³ Conectandoâ€¦</div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('m-quick')">ï¼‹ Nuevo</button>
    </div>
  </div>

  <div class="content">


    <!-- â•â•â• PRESUPUESTO FINAL â•â•â• -->
    <div class="view" id="view-pres_final">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-pres_final" onchange="cascadaModulo('pres_final','pf-proyecto-sel',loadPresupuestoFinal)">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px" id="pf-proyecto-sel" onchange="loadPresupuestoFinal()"><option value="">ğŸ“ Proyectoâ€¦</option></select>
        <select class="form-input" style="width:75px" id="pf-version-sel" onchange="loadPresupuestoFinal()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Imprimir / PDF</button>
      </div>
      <div id="pf-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-family:Arial,sans-serif;font-size:12px">
        <!-- Cabecera empresa -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;margin-top:3px">C/ TomÃ¡s y Valiente NÂº 6 Bajo, 46290 AlcÃ sser (Valencia)</div>
            <div style="color:#666">Tel: 961 20 01 87 Â· info@pauinteriorismo.com</div>
            <div style="color:#666">CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333;letter-spacing:.05em">PRESUPUESTO</div>
            <div id="pf-num" style="font-size:13px;color:#1a2a3a;margin-top:4px"></div>
            <div id="pf-fecha" style="color:#666;font-size:11px"></div>
          </div>
        </div>
        <!-- Datos cliente -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">CLIENTE</div>
            <div id="pf-cliente-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-cliente-cif" style="color:#666"></div>
            <div id="pf-cliente-dir" style="color:#666"></div>
          </div>
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">PROYECTO</div>
            <div id="pf-proyecto-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-proyecto-dir" style="color:#666"></div>
          </div>
        </div>
        <!-- Tabla lÃ­neas -->
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px">
          <thead>
            <tr style="background:#1a2a3a;color:white">
              <th style="padding:8px;text-align:left">DescripciÃ³n</th>
              <th style="padding:8px;text-align:center;width:40px">Ud.</th>
              <th style="padding:8px;text-align:right;width:60px">Cant.</th>
              <th style="padding:8px;text-align:right;width:90px">P.Unitario</th>
              <th style="padding:8px;text-align:right;width:90px">Subtotal</th>
            </tr>
          </thead>
          <tbody id="pf-lineas"></tbody>
        </table>
        <!-- Totales -->
        <div style="display:flex;justify-content:flex-end">
          <div style="width:250px">
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>Base imponible</span><span id="pf-base">â€”</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>IVA (10%)</span><span id="pf-iva">â€”</span></div>
            <div style="display:flex;justify-content:space-between;padding:9px 0;font-size:14px;font-weight:700;color:#1a2a3a"><span>TOTAL</span><span id="pf-total">â€”</span></div>
          </div>
        </div>
        <!-- Condiciones -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid #ddd;color:#888;font-size:10px">
          <strong style="color:#333">Condiciones:</strong> Presupuesto vÃ¡lido por 30 dÃ­as desde su emisiÃ³n. Los precios incluyen mano de obra y materiales salvo indicaciÃ³n contraria. IVA no incluido salvo indicaciÃ³n. 
          En caso de aceptaciÃ³n, sÃ­rvase firmar y devolver una copia.
        </div>
        <div style="margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:30px">
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma PAU INTERIORISMO S.L.</div></div>
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma y conformidad del cliente</div></div>
        </div>
        <div id="pf-empty" class="empty" style="display:none"><div class="empty-icon">ğŸ“„</div><div class="empty-text">Selecciona un proyecto para generar el presupuesto</div></div>
      </div>
    </div>

    <!-- â•â•â• CONTRATO â•â•â• -->
    <div class="view" id="view-contrato">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-contrato" onchange="cascadaModulo('contrato','ct-proyecto-sel',loadContrato)">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px" id="ct-proyecto-sel" onchange="loadContrato()"><option value="">ğŸ“ Proyectoâ€¦</option></select>
        <select class="form-input" style="width:180px" id="ct-pres-sel"><option value="">Presupuesto vinculadoâ€¦</option></select>
        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Imprimir / PDF</button>
      </div>
      <div id="ct-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;line-height:1.7;font-family:Arial,sans-serif">
        <div style="text-align:center;margin-bottom:24px">
          <div style="font-size:16px;font-weight:700;color:#1a2a3a;border-bottom:2px solid #b87333;padding-bottom:8px">CONTRATO DE OBRA CIVIL Y SERVICIOS DE INTERIORISMO</div>
        </div>
        <div style="text-align:right;color:#666;margin-bottom:18px">En Valencia, a <span id="ct-fecha">[FECHA]</span></div>
        <div style="margin-bottom:16px"><strong>REUNIDOS</strong></div>
        <div style="margin-bottom:12px">De una parte: <strong>PAU INTERIORISMO S.L.</strong>, con CIF <strong>B-56909641</strong>, domicilio en C/ TomÃ¡s y Valiente NÂº 6 Bajo, 46290 AlcÃ sser (Valencia), en adelante <em>LA EMPRESA</em>.</div>
        <div style="margin-bottom:18px">De otra parte: <strong id="ct-cliente-nombre">[CLIENTE]</strong>, con CIF/NIF <strong id="ct-cliente-cif">[CIF]</strong>, domicilio en <span id="ct-cliente-dir">[DIRECCIÃ“N]</span>, en adelante <em>EL CLIENTE</em>.</div>
        <div style="margin-bottom:12px"><strong>EXPONEN</strong></div>
        <div style="margin-bottom:8px">I. Que LA EMPRESA se dedica profesionalmente a la ejecuciÃ³n de obras de reforma y proyectos de interiorismo.</div>
        <div style="margin-bottom:18px">II. Que EL CLIENTE estÃ¡ interesado en contratar los servicios de LA EMPRESA para la realizaciÃ³n de los trabajos descritos en el presupuesto aceptado.</div>
        <div style="margin-bottom:12px"><strong>ACUERDAN</strong></div>
        <div style="margin-bottom:8px"><strong>PRIMERA. OBJETO DEL CONTRATO</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA se compromete a ejecutar los trabajos de reforma e interiorismo descritos en el presupuesto nÂº <strong id="ct-pres-id">[PRES]</strong> para el proyecto <strong id="ct-proyecto-nombre">[PROYECTO]</strong>, sito en <span id="ct-proyecto-dir">[DIRECCIÃ“N OBRA]</span>.</div>
        <div style="margin-bottom:8px"><strong>SEGUNDA. PRECIO</strong></div>
        <div style="margin-bottom:14px">El precio total de los trabajos asciende a <strong id="ct-importe">[IMPORTE]</strong> (IVA incluido), segÃºn el presupuesto aceptado por el cliente.</div>
        <div style="margin-bottom:8px"><strong>TERCERA. FORMA DE PAGO</strong></div>
        <div style="margin-bottom:4px">El pago se realizarÃ¡ de la siguiente forma:</div>
        <div style="margin-left:16px;margin-bottom:14px">
          <div>â€” 40% a la firma del presente contrato</div>
          <div>â€” 30% al inicio de los trabajos</div>
          <div>â€” 30% a la finalizaciÃ³n y entrega de la obra</div>
        </div>
        <div style="margin-bottom:8px"><strong>CUARTA. PLAZO DE EJECUCIÃ“N</strong></div>
        <div style="margin-bottom:14px">El plazo estimado de ejecuciÃ³n es de <input id="ct-plazo" style="border:none;border-bottom:1px solid #333;width:40px;text-align:center;font-size:12px" value="90"> dÃ­as naturales, contados desde la fecha de inicio de los trabajos.</div>
        <div style="margin-bottom:8px"><strong>QUINTA. MODIFICACIONES</strong></div>
        <div style="margin-bottom:14px">Cualquier modificaciÃ³n del proyecto inicial deberÃ¡ ser acordada por escrito entre ambas partes y darÃ¡ lugar a un presupuesto adicional.</div>
        <div style="margin-bottom:8px"><strong>SEXTA. GARANTÃAS</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA garantiza los trabajos realizados por un perÃ­odo de 1 aÃ±o desde la fecha de entrega, excepto los desperfectos ocasionados por mal uso del cliente.</div>
        <div style="margin-bottom:8px"><strong>SÃ‰PTIMA. CAUSAS DE RESOLUCIÃ“N</strong></div>
        <div style="margin-bottom:14px">El incumplimiento de las obligaciones por cualquiera de las partes darÃ¡ derecho a la otra parte a resolver el contrato, con las indemnizaciones que procedan.</div>
        <div style="margin-bottom:8px"><strong>OCTAVA. PROTECCIÃ“N DE DATOS</strong></div>
        <div style="margin-bottom:20px">Los datos personales facilitados serÃ¡n tratados conforme al RGPD (UE) 2016/679.</div>
        <div style="margin-bottom:20px">Y en prueba de conformidad, firman el presente contrato por duplicado en el lugar y fecha indicados.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:32px">
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por LA EMPRESA<br><strong>PAU INTERIORISMO S.L.</strong></div></div>
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por EL CLIENTE<br><strong id="ct-firma-cliente">[CLIENTE]</strong></div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• PEDIDO DOC â•â•â• -->
    <div class="view" id="view-pedido_doc">
      <div class="search-bar" style="flex-wrap:wrap;gap:8px;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-pedido_doc" onchange="cascadaDocPedido()">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:210px" id="filter-proyecto-pedido_doc" onchange="filtrarPedidosPorProyecto()">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <select class="form-input" style="width:200px" id="pd-pedido-sel" onchange="cargarPedidoEnDoc()">
          <option value="">â€” Pedidoâ€¦ â€”</option>
        </select>
        <button class="btn btn-primary" onclick="guardarDocPedido()">ğŸ’¾ Guardar</button>
        <button class="btn btn-primary" onclick="exportarPDF('pd-doc', (document.getElementById('pd-num-input')?.value||'pedido')+'.pdf')">â¬‡ï¸ PDF</button>
        <button class="btn btn-ghost" onclick="window.print()">ğŸ–¨ï¸ Imprimir</button>
        <button class="btn btn-ghost btn-sm" onclick="nuevoPedidoDoc()">ï¼‹ Nuevo</button>
      </div>
      <!-- DOCUMENTO PEDIDO EDITABLE + IMPRIMIBLE -->
      <div id="pd-doc" style="background:white;max-width:720px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;font-family:Arial,sans-serif">
        <!-- CABECERA -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;font-size:10px">C/ TomÃ¡s y Valiente NÂº 6 Bajo Â· 46290 AlcÃ sser (Valencia)</div>
            <div style="color:#666;font-size:10px">info@pauinteriorismo.com Â· Tel: 961 20 01 87 Â· CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333">PEDIDO</div>
            <div style="font-size:11px;color:#666">NÂº <input id="pd-num-input" style="border:none;border-bottom:1px solid #ccc;width:100px;font-size:11px;text-align:right" placeholder="PED-001"></div>
            <div style="font-size:11px;color:#666">Fecha <input id="pd-fecha-input" type="date" style="border:none;border-bottom:1px solid #ccc;font-size:11px"></div>
          </div>
        </div>
        <!-- PROVEEDOR / PROYECTO -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
          <div style="background:#f7f4ef;padding:10px;border-radius:4px">
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:5px">PROVEEDOR / EMPRESA</div>
            <input id="pd-prov-input" style="border:none;background:transparent;width:100%;font-weight:700;font-size:12px" placeholder="Nombre proveedor">
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px">
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:5px">PROYECTO / REFERENCIA</div>
            <input id="pd-proyecto-input" style="border:none;background:transparent;width:100%;font-weight:700;font-size:12px" placeholder="Nombre o referencia del proyecto">
            <input id="pd-ref-doc-input" style="border:none;background:transparent;width:100%;color:#b87333;font-size:11px;font-weight:600;margin-top:3px" placeholder="Referencia del pedido (ej: Azulejo baÃ±o modelo X)">
          </div>
        </div>
        <!-- TABLA DE LÃNEAS -->
        <table style="width:100%;border-collapse:collapse;margin-bottom:16px" id="pd-lineas-table">
          <thead>
            <tr style="background:#1a2a3a;color:white">
              <th style="padding:7px 10px;text-align:center;width:60px">Cant.</th>
              <th style="padding:7px 10px;text-align:left">DescripciÃ³n / Concepto</th>
            </tr>
          </thead>
          <tbody id="pd-lineas-body">
            <!-- LÃ­neas generadas dinÃ¡micamente -->
          </tbody>
        </table>
        <div class="no-print" style="margin-bottom:16px">
          <button class="btn btn-ghost btn-sm" onclick="addPedidoLinea()">ï¼‹ AÃ±adir lÃ­nea</button>
          <button class="btn btn-ghost btn-sm" onclick="clearPedidoLineas()">ğŸ—‘ Limpiar todo</button>
        </div>
        <!-- NOTA / INSTRUCCIONES FIJAS -->
        <div style="border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:14px;font-size:11px">
          <textarea id="pd-nota-input" style="border:none;width:100%;resize:none;font-size:11px;font-family:Arial" rows="3" placeholder="Instrucciones de entrega...">SERVIR LO ANTES POSIBLE.

DIRECCIÃ“N DE ENTREGA AV. DIPUTACIÃ“N NÂº 24 - ALCASSER 46290 (VALENCIA)
HORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.
TELFN. CONTACTO 677 970 074 ATENCIÃ“N DE JOSE.</textarea>
        </div>
        <!-- PIE -->
        <div style="color:#666;font-size:10px;text-align:center;border-top:1px solid #eee;padding-top:10px">
          PAU INTERIORISMO S.L. Â· CIF B-56909641 Â· info@pauinteriorismo.com
        </div>
      </div>
    </div>

    <!-- â•â•â• INFORME MENSUAL â•â•â• -->
    <div class="view" id="view-informe_mensual">
      <div class="search-bar" style="gap:8px;align-items:center">
        <select class="form-input" style="width:140px" id="inf-mes">
          <option value="1">Enero</option><option value="2">Febrero</option>
          <option value="3">Marzo</option><option value="4">Abril</option>
          <option value="5">Mayo</option><option value="6">Junio</option>
          <option value="7">Julio</option><option value="8">Agosto</option>
          <option value="9">Septiembre</option><option value="10">Octubre</option>
          <option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>
        <select class="form-input" style="width:90px" id="inf-anyo">
          <option>2024</option><option>2025</option><option selected>2026</option><option>2027</option>
        </select>
        <button class="btn btn-primary" onclick="generarInformeMensual()">ğŸ“Š Generar informe</button>
        <button class="btn btn-ghost" onclick="exportarPDF(document.getElementById('inf-body').firstElementChild,'Informe_'+document.getElementById('inf-mes').value+'_'+document.getElementById('inf-anyo').value+'.pdf')">â¬‡ï¸ PDF</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="card-body" id="inf-body">
          <div style="text-align:center;padding:40px;color:var(--text-soft)">
            <div style="font-size:32px;margin-bottom:10px">ğŸ“…</div>
            <div style="font-size:14px">Selecciona mes y aÃ±o y pulsa Generar</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• LISTAS â•â•â• -->
    <div class="view" id="view-listas">
      <div class="info-box">ğŸ—‚ Gestiona los valores de los desplegables de toda la aplicaciÃ³n. Los cambios se guardan automÃ¡ticamente.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
        
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ‘· Trabajadores</div><button class="btn btn-ghost btn-sm" onclick="addListItem('trabajadores-list','trabajador')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="trabajadores-list">
            <div class="lista-item" data-val="Paco">Paco</div>
            <div class="lista-item" data-val="RaÃºl">RaÃºl</div>
            <div class="lista-item" data-val="Boro">Boro</div>
            <div class="lista-item" data-val="Julio">Julio</div>
            <div class="lista-item" data-val="Pau">Pau</div>
            <div class="lista-item" data-val="Jose Asins">Jose Asins</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“ Estados proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estados-list','estado')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="estados-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ— Tipos proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proyecto-list','tipo')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="tipos-proyecto-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ’¶ IVA</div><small style="color:var(--text-light);font-size:10px">Fijo por ley</small></div>
          <div class="card-body">
            <div class="lista-item">Exento</div><div class="lista-item">4%</div><div class="lista-item">10%</div><div class="lista-item">21%</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ’³ Formas de pago</div><button class="btn btn-ghost btn-sm" onclick="addListItem('formas-pago-list','forma pago')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="formas-pago-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ­ Tipos proveedor</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proveedor-list','tipo')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="tipos-proveedor-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ‘¥ Tipos cliente</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-cliente-list','tipo cliente')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="tipos-cliente-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ›‹ Estancias</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estancias-list','estancia')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="estancias-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ· CategorÃ­as tarifario</div><button class="btn btn-ghost btn-sm" onclick="addListItem('categorias-list','categorÃ­a')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" id="categorias-list"></div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">ğŸ“‚ Partidas presupuesto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('partidas-list','partida')">ï¼‹ AÃ±adir</button></div>
          <div class="card-body" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px" id="partidas-list">
            <div class="lista-item">01.Demoliciones</div><div class="lista-item">02.AlbaÃ±ilerÃ­a</div><div class="lista-item">03.Instalaciones</div><div class="lista-item">04.Revestimientos</div><div class="lista-item">05.FontanerÃ­a</div><div class="lista-item">06.Electricidad</div><div class="lista-item">07.CarpinterÃ­a</div><div class="lista-item">08.Pintura</div><div class="lista-item">09.Estructura</div><div class="lista-item">10.Cubierta</div><div class="lista-item">11.Fachada</div><div class="lista-item">12.Mobiliario</div><div class="lista-item">13.ClimatizaciÃ³n</div><div class="lista-item">14.Varios</div><div class="lista-item">15.Otros</div>
          </div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">ğŸ– Causas de ausencia (Control horario)</div></div>
          <div class="card-body" style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="lista-item">Vacaciones</div><div class="lista-item">Baja mÃ©dica</div><div class="lista-item">Permiso</div><div class="lista-item">Festivo</div><div class="lista-item">Teletrabajo</div><div class="lista-item">FormaciÃ³n</div><div class="lista-item">Otros</div>
          </div>
        </div>

      </div>
    </div>

    <!-- â•â•â• GERENCIA â•â•â• -->
    <div class="view active" id="view-gerencia">
      <div class="kpi-grid">
        <div class="kpi blue"><div class="kpi-label">Total Ventas (Base Imp.)</div><div class="kpi-value" id="g-ventas">â€”</div><div class="kpi-sub">Facturas emitidas</div></div>
        <div class="kpi red"><div class="kpi-label">Total Costes</div><div class="kpi-value" id="g-costes">â€”</div><div class="kpi-sub">Compras + Subcontr. + MO</div></div>
        <div class="kpi green"><div class="kpi-label">Beneficio Real</div><div class="kpi-value" id="g-benef">â€”</div><div class="kpi-sub">Ventas âˆ’ Costes</div></div>
        <div class="kpi amber"><div class="kpi-label">Margen Real %</div><div class="kpi-value" id="g-margen">â€”</div><div class="kpi-sub">Sobre ventas</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Resumen econÃ³mico -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š Resumen econÃ³mico</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Importe â‚¬</span><span>%</span></div>
            <div class="cuenta-row"><span>Total Ventas (Base Imp.)</span><span id="ge-ventas">â€”</span><span>100%</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span id="ge-iva-rep">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">â€” Compras materiales</span><span id="ge-compras">â€”</span><span id="ge-compras-pct">â€”</span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">â€” Subcontratas</span><span id="ge-subcs">â€”</span><span id="ge-subcs-pct">â€”</span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">â€” Mano de obra propia</span><span id="ge-mo">â€”</span><span id="ge-mo-pct">â€”</span></div>
            <div class="cuenta-row total"><span>TOTAL COSTES</span><span id="ge-costes-tot">â€”</span><span id="ge-costes-pct">â€”</span></div>
            <div class="cuenta-row result" id="ge-result-row"><span>BENEFICIO BRUTO</span><span id="ge-beneficio">â€”</span><span id="ge-benef-pct">â€”</span></div>
          </div>
        </div>
        <!-- Proyectos por estado -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“ Proyectos por estado</div></div>
          <div class="card-body" style="padding:0" id="g-estados"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Seguimiento cobros -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ’° Seguimiento de cobros</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Facturado</span><span id="gc-facturado">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">âœ… Cobrado</span><span id="gc-cobrado">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">â³ Pendiente cobro</span><span id="gc-pendiente">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--red)">âŒ Vencidas</span><span id="gc-vencidas">â€”</span><span></span></div>
          </div>
        </div>
        <!-- Seguimiento pagos -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ¦ Seguimiento de pagos</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Compras</span><span id="gp-compras">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">âœ… Pagado proveedores</span><span id="gp-pagado-prov">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">â³ Pendiente proveedores</span><span id="gp-pdte-prov">â€”</span><span></span></div>
            <div class="cuenta-row"><span>Total Subcontratas</span><span id="gp-subcs">â€”</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">â³ Pendiente subcontr.</span><span id="gp-pdte-sub">â€”</span><span></span></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Control horas -->
        <div class="card">
          <div class="card-header"><div class="card-title">â± Control de horas</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total horas registradas</span><span id="gh-horas">â€”</span><span></span></div>
            <div class="cuenta-row"><span>Coste total MO</span><span id="gh-coste">â€”</span><span></span></div>
            <div class="cuenta-row"><span>Coste medio / hora</span><span id="gh-medio">â€”</span><span></span></div>
          </div>
        </div>
        <!-- IVA -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ§¾ IVA trimestral</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>IVA Repercutido (ventas)</span><span id="gi-rep">â€”</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (compras)</span><span id="gi-comp">â€”</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (subcontr.)</span><span id="gi-sub">â€”</span><span></span></div>
            <div class="cuenta-row total"><span>IVA NETO A INGRESAR</span><span id="gi-neto">â€”</span><span></span></div>
          </div>
        </div>
      </div>
      <!-- Rentabilidad por proyecto tabla -->
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“ˆ Rentabilidad por proyecto</div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Proyecto</th><th>Estado</th><th>Ventas</th><th>Coste Compras</th><th>Coste Subcontr.</th><th>Coste MO</th><th>Coste Total</th><th>Margen â‚¬</th><th>Margen %</th></tr></thead>
        <tbody id="g-rent-table"><tr><td colspan="10" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>

      <!-- â•â•â• PANEL DE ALERTAS â•â•â• -->
      <div class="card" style="margin-top:14px">
        <div class="card-header">
          <div class="card-title">ğŸš¨ Alertas de rentabilidad</div>
          <div id="alertas-count" style="font-size:12px;color:var(--text-soft)"></div>
        </div>
        <div class="card-body" id="alertas-body" style="padding:0">
          <div style="text-align:center;padding:20px;color:var(--text-soft)">Cargando alertasâ€¦</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• CLIENTES â•â•â• -->
    <div class="view" id="view-clientes">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-clientes" placeholder="Buscar clienteâ€¦" oninput="filterTable('clientes-tbody','search-clientes')"></div>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-import-clientes')" style="border:1px dashed var(--border)">ğŸ“¤ Importar Holded</button>
        <button class="btn btn-primary" onclick="openModal('m-cliente')">ï¼‹ Nuevo cliente</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ¤ Clientes<span id="clientes-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>CIF</th><th>TelÃ©fono</th><th>Email</th><th>Tipo</th><th></th></tr></thead>
        <tbody id="clientes-tbody"><tr><td colspan="7" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• PROYECTOS â•â•â• -->
    <div class="view" id="view-proyectos">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap">
        <select class="form-input" style="width:240px;flex-shrink:0" id="filter-cliente-proyectos" onchange="filtrarProyectosPorCliente()">
          <option value="">ğŸ‘¤ Todos los clientes</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:180px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-proyectos" placeholder="Buscar proyectoâ€¦" oninput="filterTable('proyectos-tbody','search-proyectos')"></div>
        <button class="btn btn-primary" onclick="openModal('m-proyecto')">ï¼‹ Nuevo proyecto</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“ Proyectos<span id="proyectos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>Cliente</th><th>Tipo</th><th>Estado</th><th>Responsable</th><th>Inicio</th><th></th></tr></thead>
        <tbody id="proyectos-tbody"><tr><td colspan="8" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• PRESUPUESTO â•â•â• -->
    <div class="view" id="view-presupuesto">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-presupuesto" onchange="cascadaClienteProyecto('presupuesto')">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px" id="pres-proyecto-sel" onchange="loadPresupuesto()"><option value="">ğŸ“ Proyectoâ€¦</option></select>
        <select class="form-input" style="width:75px" id="pres-version-sel" onchange="loadPresupuesto()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="addLineaPresupuesto()">ï¼‹ LÃ­nea</button>
        <button class="btn btn-ghost" onclick="addCapituloPresupuesto()">ï¼‹ CapÃ­tulo</button>
        <button class="btn btn-ghost" id="btn-comparativa" style="display:none" onclick="abrirComparativa()">âš–ï¸ Comparar</button>
        <button class="btn btn-primary no-print" onclick="exportarPresupuestoPDF()">â¬‡ï¸ Descargar PDF</button>
        <button class="btn btn-ghost no-print" onclick="window.print()">ğŸ–¨ï¸ Imprimir</button>
        <div id="pres-total-lbl" style="margin-left:auto;font-size:13px;font-weight:700;color:var(--navy)"></div>
      </div>
      <div id="pres-resumen" style="display:none">
        <div class="kpi-grid" style="margin-bottom:12px">
          <div class="kpi blue"><div class="kpi-label">Base (s/CI)</div><div class="kpi-value" id="pres-k-base">â€”</div></div>
          <div class="kpi amber"><div class="kpi-label">CI+GG+BI</div><div class="kpi-value" id="pres-k-ci">â€”</div></div>
          <div class="kpi green"><div class="kpi-label">Total s/IVA</div><div class="kpi-value" id="pres-k-total">â€”</div></div>
          <div class="kpi red"><div class="kpi-label">Total c/IVA 10%</div><div class="kpi-value" id="pres-k-iva">â€”</div></div>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>#</th><th>DescripciÃ³n</th><th>Ud.</th><th>Cant.</th><th>Precio Base</th><th>Margen %</th><th>CI+GG+BI</th><th>P.Venta</th><th>Subtotal</th><th>IVA</th><th></th></tr></thead>
        <tbody id="pres-tbody"><tr><td colspan="11"><div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">Selecciona un proyecto</div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• COMPARATIVA OFERTAS â•â•â• -->
    <div class="view" id="view-comparativa">
      <div class="info-box">âš–ï¸ Compara hasta 3 ofertas de distintos proveedores para cada trabajo o material. Elige la mÃ¡s ventajosa.</div>
      <div class="search-bar">
        <select class="form-input" style="width:200px" id="filter-cliente-comparativa" onchange="cascadaClienteComparativa()">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:240px" id="comp-proyecto-sel" onchange="loadComparativa()">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <button class="btn btn-primary" id="btn-nueva-comparativa" onclick="abrirNuevaComparativa()" style="display:none">ï¼‹ Nueva comparativa</button>
      </div>
      <div id="comp-list"><div class="empty"><div class="empty-icon">âš–ï¸</div><div class="empty-text">Selecciona un cliente y proyecto</div></div></div>
    </div>

    <!-- â•â•â• TARIFARIO â•â•â• -->
    <div class="view" id="view-tarifario">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-tarifario" placeholder="Buscarâ€¦" oninput="filterTable('tarifario-tbody','search-tarifario')"></div>
        <button class="btn btn-primary" onclick="openModal('m-tarifario')">ï¼‹ Nuevo artÃ­culo</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“‹ Tarifario<span id="tarifario-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Ud.</th><th>Coste</th><th>Margen %</th><th>P.Venta</th><th>CategorÃ­a</th><th></th></tr></thead>
        <tbody id="tarifario-tbody"><tr><td colspan="8" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• CYPE â•â•â• -->
    <div class="view" id="view-cype">
      <div class="info-box">ğŸ“ <strong>524 partidas CYPE 2026</strong> importadas. Base de precios centralizada.</div>
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-cype" placeholder="Buscar por cÃ³digo, descripciÃ³n o capÃ­tuloâ€¦" oninput="filterCype()"></div>
        <select class="form-input" style="width:200px" id="filter-cype-cap" onchange="filterCype()"><option value="">Todos los capÃ­tulos</option></select>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>CÃ³digo</th><th>DescripciÃ³n</th><th>Ud.</th><th>Precio s/IVA</th><th>CapÃ­tulo</th></tr></thead>
        <tbody id="cype-tbody"><tr><td colspan="5" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• INTERIORISMO â•â•â• -->
    <div class="view" id="view-interiorismo">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-interiorismo" onchange="cascadaModuloInt()">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:215px;flex-shrink:0" id="filter-proyecto-interiorismo" onchange="filtrarInteriorismo()">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-interiorismo" placeholder="Buscarâ€¦" oninput="filterTable('interiorismo-tbody','search-interiorismo')"></div>
        <button class="btn btn-copper" onclick="openModal('m-interiorismo')">ï¼‹ AÃ±adir artÃ­culo</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ›‹ Interiorismo & Mobiliario<span id="interiorismo-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Proyecto</th><th>Estancia</th><th>Ref.</th><th>DescripciÃ³n</th><th>Cant.</th><th>PVP Neto</th><th>Margen</th><th>Est. Prop.</th><th>Est. Pedido</th><th></th></tr></thead>
        <tbody id="interiorismo-tbody"><tr><td colspan="10" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• COMPRAS â•â•â• -->
    <div class="view" id="view-compras">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-compras" onchange="cascadaClienteProyecto('compras')">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-compras" onchange="filtrarModuloPorProyecto('compras')">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-compras" placeholder="Buscarâ€¦" oninput="filterTable('compras-tbody','search-compras')"></div>
        <button class="btn btn-primary" onclick="openModal('m-compra')">ï¼‹ Nueva compra</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ›’ Compras<span id="compras-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Proveedor</th><th>Concepto</th><th>Base Imp.</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="compras-tbody"><tr><td colspan="9" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• SUBCONTRATAS â•â•â• -->
    <div class="view" id="view-subcontratas">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-subcontratas" onchange="cascadaClienteProyecto('subcontratas')">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-subcontratas" onchange="filtrarModuloPorProyecto('subcontratas')">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-subcontratas" placeholder="Buscarâ€¦" oninput="filterTable('subcontratas-tbody','search-subcontratas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-subcontrata')">ï¼‹ Nueva subcontrata</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ‘· Subcontratas<span id="subcontratas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Subcontratista</th><th>Trabajo</th><th>Importe</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="subcontratas-tbody"><tr><td colspan="9" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• HORAS â•â•â• -->
    <div class="view" id="view-horas">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-horas" onchange="cascadaClienteProyecto('horas')">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-horas" onchange="filtrarModuloPorProyecto('horas')">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-horas" placeholder="Buscarâ€¦" oninput="filterTable('horas-tbody','search-horas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-hora')">ï¼‹ Registrar horas</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">â± Horas<span id="horas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Trabajador</th><th>Horas</th><th>â‚¬/h</th><th>Total</th><th>DescripciÃ³n</th><th></th></tr></thead>
        <tbody id="horas-tbody"><tr><td colspan="8" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• PEDIDOS â•â•â• -->
    <div class="view" id="view-pedidos">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-pedidos" onchange="cascadaClienteProyecto('pedidos')">
          <option value="">ğŸ‘¤ Clienteâ€¦</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-pedidos" onchange="filtrarModuloPorProyecto('pedidos')">
          <option value="">ğŸ“ Proyectoâ€¦</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-pedidos" placeholder="Buscarâ€¦" oninput="filterTable('pedidos-tbody','search-pedidos')"></div>
        <button class="btn btn-primary" onclick="openPedidoModal()">ï¼‹ Nuevo pedido</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“¦ Registro de pedidos<span id="pedidos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>NÂº Pedido</th><th>Fecha</th><th>Proyecto</th><th>Tipo</th><th>Proveedor/Empresa</th><th>Importe</th><th>Estado</th><th>Observaciones</th><th></th></tr></thead>
        <tbody id="pedidos-tbody"><tr><td colspan="9" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• CONTROL HORARIO â•â•â• -->
    <div class="view" id="view-control_horario">
      <div class="search-bar">
        <select class="form-input" style="width:160px" id="ch-trab-sel" onchange="loadControlHorario()"><option value="">Seleccionar trabajadorâ€¦</option></select>
        <select class="form-input" style="width:100px" id="ch-year-sel" onchange="loadControlHorario()">
          <option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <div id="ch-resumen" style="margin-left:auto;font-size:12px;color:var(--text-soft)"></div>
      </div>
      <div id="ch-meses-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
    </div>

    <!-- â•â•â• PROVEEDORES â•â•â• -->
    <div class="view" id="view-proveedores">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input class="form-input" id="search-proveedores" placeholder="Buscarâ€¦" oninput="filterTable('proveedores-tbody','search-proveedores')"></div>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-import-proveedores')" style="border:1px dashed var(--border)">ğŸ“¤ Importar Holded</button>
        <button class="btn btn-primary" onclick="openModal('m-proveedor')">ï¼‹ Nuevo proveedor</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ­ Proveedores<span id="proveedores-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Nombre</th><th>CIF</th><th>Tipo</th><th>Especialidad</th><th>TelÃ©fono</th><th>Email</th><th>F.Pago</th><th></th></tr></thead>
        <tbody id="proveedores-tbody"><tr><td colspan="8" class="loading">Cargandoâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• RENTABILIDAD â•â•â• -->
    <div class="view" id="view-rentabilidad">
      <div class="search-bar">
        <select class="form-input" style="width:300px" id="rent-proyecto-sel" onchange="loadRentabilidad()"><option value="">Seleccionar proyectoâ€¦</option></select>
        <select class="form-input" style="width:75px" id="rent-version-sel" onchange="loadRentabilidad()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
      </div>
      <div id="rent-kpis" style="display:none">
        <div class="kpi-grid">
          <div class="kpi blue"><div class="kpi-label">Presupuesto (s/IVA)</div><div class="kpi-value" id="rk-pres">â€”</div></div>
          <div class="kpi red"><div class="kpi-label">Coste real total</div><div class="kpi-value" id="rk-coste">â€”</div></div>
          <div class="kpi green"><div class="kpi-label">Beneficio bruto</div><div class="kpi-value" id="rk-benef">â€”</div></div>
          <div class="kpi amber"><div class="kpi-label">Margen real %</div><div class="kpi-value" id="rk-margen">â€”</div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š Coste vs Presupuesto</div></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span id="rent-bar-label"></span><span id="rent-bar-nums"></span></div>
            <div class="prog-wrap"><div id="rent-bar" class="prog-bar" style="width:0%;background:var(--green)"></div></div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
          <div class="card"><div class="card-header"><div class="card-title">ğŸ›’ Compras</div><div id="rk-compras-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-compras-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">ğŸ‘· Subcontratas</div><div id="rk-sub-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-sub-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">â± Horas</div><div id="rk-horas-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-horas-list"></tbody></table></div></div>
        </div>
        <div class="card"><div class="card-header"><div class="card-title">ğŸ§¾ Facturas emitidas</div><div id="rk-fact-total" style="font-weight:700;color:var(--green)"></div></div><div class="table-wrap"><table><thead><tr><th>NÂº Factura</th><th>Fecha</th><th>Base Imp.</th><th>Total c/IVA</th><th>Estado</th></tr></thead><tbody id="rk-fact-list"></tbody></table></div></div>
      </div>
      <div id="rent-empty" class="empty"><div class="empty-icon">ğŸ“ˆ</div><div class="empty-text">Selecciona un proyecto para ver su rentabilidad</div></div>
    </div>

    <!-- â•â•â• FACTURAS â•â•â• -->
    <div class="view" id="view-facturas">

      <!-- â•â•â• PANEL RESUMEN â•â•â• -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
        <!-- VENTAS -->
        <div class="card" style="border-top:3px solid var(--green)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--green);margin-bottom:8px">ğŸ“¤ Facturas de Venta</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Total facturado</span>
              <span style="font-size:13px;font-weight:700" id="fk-v-total">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Cobrado</span>
              <span style="font-size:12px;font-weight:700;color:var(--green)" id="fk-v-cobrado">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pendiente cobro</span>
              <span style="font-size:12px;font-weight:700;color:var(--amber)" id="fk-v-pendiente">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="font-size:11px;color:var(--text-soft)">Vencidas</span>
              <span style="font-size:12px;font-weight:700;color:var(--red)" id="fk-v-vencidas">â€”</span>
            </div>
          </div>
        </div>
        <!-- COMPRAS -->
        <div class="card" style="border-top:3px solid var(--red)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--red);margin-bottom:8px">ğŸ“¥ Facturas de Compra</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Total recibido</span>
              <span style="font-size:13px;font-weight:700" id="fk-c-total">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pagado</span>
              <span style="font-size:12px;font-weight:700;color:var(--green)" id="fk-c-pagado">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pendiente pago</span>
              <span style="font-size:12px;font-weight:700;color:var(--amber)" id="fk-c-pendiente">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="font-size:11px;color:var(--text-soft)">IVA soportado</span>
              <span style="font-size:12px;font-weight:700;color:var(--copper)" id="fk-c-iva">â€”</span>
            </div>
          </div>
        </div>
        <!-- BALANCE -->
        <div class="card" style="border-top:3px solid var(--navy)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--navy);margin-bottom:8px">âš–ï¸ Balance</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Beneficio bruto</span>
              <span style="font-size:14px;font-weight:700" id="fk-b-beneficio">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Margen</span>
              <span style="font-size:13px;font-weight:700" id="fk-b-margen">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span style="font-size:11px;color:var(--text-soft)">IVA a liquidar</span>
              <span style="font-size:12px;font-weight:700;color:var(--copper)" id="fk-b-iva">â€”</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:8px;overflow:hidden">
              <div id="fk-b-bar" style="height:8px;width:0%;background:var(--green);border-radius:4px;transition:width .4s"></div>
            </div>
            <div style="font-size:10px;color:var(--text-soft);margin-top:3px" id="fk-b-bar-lbl">Gastos sobre ingresos</div>
          </div>
        </div>
      </div>

      <!-- â•â•â• TABS + BÃšSQUEDA â•â•â• -->
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <div style="display:flex;border:1px solid var(--border);border-radius:6px;overflow:hidden">
          <button id="ftab-todas"  class="btn" style="border-radius:0;background:var(--navy);color:white;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('todas')">Todas</button>
          <button id="ftab-venta"  class="btn btn-ghost" style="border-radius:0;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('Venta')">ğŸ“¤ Ventas</button>
          <button id="ftab-compra" class="btn btn-ghost" style="border-radius:0;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('Compra')">ğŸ“¥ Compras</button>
        </div>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">ğŸ”</span>
          <input class="form-input" id="search-facturas" placeholder="Buscarâ€¦" oninput="filterTable('facturas-tbody','search-facturas')">
        </div>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-importar-holded')" style="border:1px dashed var(--border)">ğŸ“¤ Importar Holded</button>
        <button class="btn btn-primary" onclick="abrirNuevaFactura('Venta')">ğŸ“¤ Nueva venta</button>
        <button class="btn" style="background:#fdecea;color:var(--red);border:1px solid #f5c6c6" onclick="abrirNuevaFactura('Compra')">ğŸ“¥ Nueva compra</button>
      </div>

      <!-- â•â•â• TABLA â•â•â• -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ§¾ Facturas <span id="facturas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
        </div>
        <div class="table-wrap"><table>
          <thead><tr>
            <th>Tipo</th><th>NÂº Factura</th><th>Fecha</th><th>Vto.</th>
            <th>Cliente / Proveedor</th><th>Proyecto</th>
            <th>Base imp.</th><th>IVA%</th><th>Total</th>
            <th>Cobrado/Pagado</th><th>Pendiente</th><th>Estado</th><th></th>
          </tr></thead>
          <tbody id="facturas-tbody"><tr><td colspan="13" class="loading">Cargandoâ€¦</td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- â•â•â• CONTABILIDAD â•â•â• -->
    <div class="view" id="view-conciliacion">

  <!-- â•â•â• PANEL SUPERIOR: ESTADO GIROS â•â•â• -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:14px">
    <div class="kpi red"><div class="kpi-label">â° Vencen esta semana</div><div class="kpi-value" id="conc-semana">â€”</div></div>
    <div class="kpi amber"><div class="kpi-label">ğŸ“… Vencen este mes</div><div class="kpi-value" id="conc-mes">â€”</div></div>
    <div class="kpi blue"><div class="kpi-label">ğŸ“‹ Pendientes de pago</div><div class="kpi-value" id="conc-pendientes">â€”</div></div>
    <div class="kpi green"><div class="kpi-label">âœ… Pagadas este mes</div><div class="kpi-value" id="conc-pagadas">â€”</div></div>
  </div>

  <!-- â•â•â• PRÃ“XIMOS VENCIMIENTOS â•â•â• -->
  <div class="card" style="margin-bottom:14px">
    <div class="card-header">
      <div class="card-title">â° PrÃ³ximos vencimientos <span id="venc-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <select class="form-input" id="venc-filtro" style="width:160px;font-size:12px" onchange="loadConciliacion()">
          <option value="30">PrÃ³ximos 30 dÃ­as</option>
          <option value="60">PrÃ³ximos 60 dÃ­as</option>
          <option value="90">PrÃ³ximos 90 dÃ­as</option>
          <option value="todos">Todos pendientes</option>
        </select>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Vencimiento</th><th>DÃ­as</th><th>Proveedor</th><th>Concepto</th>
        <th>Forma pago</th><th>Proyecto</th><th>Base imp.</th><th>Total</th><th>Estado</th><th></th>
      </tr></thead>
      <tbody id="venc-tbody"><tr><td colspan="10" class="loading">Cargandoâ€¦</td></tr></tbody>
    </table></div>
  </div>

  <!-- â•â•â• IMPORTAR EXTRACTO â•â•â• -->
  <div class="card" style="margin-bottom:14px">
    <div class="card-header">
      <div class="card-title">ğŸ¦ Importar extracto bancario (CSV)</div>
    </div>
    <div class="card-body">
      <div class="info-box" style="margin-bottom:12px">
        ğŸ“¥ Descarga el extracto de tu banco en formato CSV (BBVA: Mis cuentas â†’ Exportar / CaixaBank: Movimientos â†’ Descargar CSV). 
        El sistema cruzarÃ¡ automÃ¡ticamente los movimientos con tus facturas pendientes por <strong>importe y fecha</strong>.
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <label class="form-label">Banco / Formato</label>
          <select class="form-input" id="banco-formato" style="margin-bottom:10px">
            <option value="bbva">BBVA</option>
            <option value="caixabank">CaixaBank</option>
            <option value="santander">Santander</option>
            <option value="sabadell">Banco Sabadell</option>
            <option value="generico">GenÃ©rico (fecha, concepto, importe)</option>
          </select>
          <label class="form-label">Archivo CSV del extracto</label>
          <input type="file" id="csv-input" accept=".csv,.txt" class="form-input" onchange="procesarCSV()" style="padding:6px">
        </div>
        <div style="flex:2;min-width:280px">
          <div id="csv-preview" style="display:none;background:var(--bg);border-radius:6px;padding:10px;font-size:11px;max-height:120px;overflow-y:auto;font-family:monospace;color:var(--text-soft);border:1px solid var(--border)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• RESULTADOS CONCILIACIÃ“N â•â•â• -->
  <div id="conc-resultados" style="display:none">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ” Resultado de la conciliaciÃ³n <span id="conc-res-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
        <button class="btn btn-primary" onclick="aplicarConciliacion()" id="btn-aplicar-conc" style="display:none">âœ… Aplicar pagos detectados</button>
      </div>
      <div class="table-wrap"><table>
        <thead><tr>
          <th></th><th>Fecha banco</th><th>Concepto banco</th><th>Importe banco</th>
          <th>Factura detectada</th><th>Proveedor</th><th>Diferencia</th><th>Confianza</th>
        </tr></thead>
        <tbody id="conc-tbody"></tbody>
      </table></div>
    </div>
  </div>

</div>

<div class="view" id="view-contabilidad">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š Cuenta de Resultados</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Cta PGC</span><span>Importe â‚¬</span></div>
            <div class="cuenta-row" style="background:var(--blue-light);font-weight:700"><span>INGRESOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Ventas ejecutadas (base imp.)</span><span style="color:var(--text-soft)">700</span><span id="cnt-ventas">â€”</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span style="color:var(--text-soft)">477</span><span id="cnt-iva-rep">â€”</span></div>
            <div class="cuenta-row total"><span>TOTAL INGRESOS c/IVA</span><span></span><span id="cnt-ing-tot">â€”</span></div>
            <div class="cuenta-row" style="background:var(--red-soft);font-weight:700;margin-top:4px"><span>GASTOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Compras materiales (base)</span><span style="color:var(--text-soft)">600</span><span id="cnt-compras">â€”</span></div>
            <div class="cuenta-row"><span>IVA Soportado compras</span><span style="color:var(--text-soft)">472</span><span id="cnt-iva-comp">â€”</span></div>
            <div class="cuenta-row"><span>Subcontratas (base imp.)</span><span style="color:var(--text-soft)">621</span><span id="cnt-subcs">â€”</span></div>
            <div class="cuenta-row"><span>IVA Soportado subcontratas</span><span style="color:var(--text-soft)">472</span><span id="cnt-iva-sub">â€”</span></div>
            <div class="cuenta-row"><span>Mano de obra propia</span><span style="color:var(--text-soft)">640</span><span id="cnt-mo">â€”</span></div>
            <div class="cuenta-row total"><span>TOTAL GASTOS (s/IVA)</span><span></span><span id="cnt-gastos-tot">â€”</span></div>
            <div class="cuenta-row result" id="cnt-result-row"><span>RESULTADO BRUTO</span><span></span><span id="cnt-result">â€”</span></div>
            <div class="cuenta-row"><span>Margen bruto %</span><span></span><span id="cnt-margen">â€”</span></div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-header"><div class="card-title">ğŸ§¾ LiquidaciÃ³n IVA Trimestral</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row"><span>IVA Repercutido (ventas)</span><span id="iva-rep">â€”</span><span></span></div>
              <div class="cuenta-row"><span>IVA Soportado (compras)</span><span id="iva-comp">â€”</span><span></span></div>
              <div class="cuenta-row"><span>IVA Soportado (subcontr.)</span><span id="iva-sub">â€”</span><span></span></div>
              <div class="cuenta-row total"><span>TOTAL IVA SOPORTADO</span><span id="iva-sop-tot">â€”</span><span></span></div>
              <div class="cuenta-row result" id="iva-result-row"><span>IVA NETO A INGRESAR</span><span id="iva-neto">â€”</span><span></span></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">âš–ï¸ Balance Simplificado</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row header"><span>ACTIVO</span><span>â‚¬</span><span></span></div>
              <div class="cuenta-row"><span>Clientes (pendiente cobro)</span><span id="bal-cli">â€”</span><span></span></div>
              <div class="cuenta-row header" style="margin-top:4px"><span>PASIVO</span><span>â‚¬</span><span></span></div>
              <div class="cuenta-row"><span>IVA a liquidar (Hacienda)</span><span id="bal-iva">â€”</span><span></span></div>
              <div class="cuenta-row"><span>Pendiente proveedores</span><span id="bal-prov">â€”</span><span></span></div>
              <div class="cuenta-row"><span>Pendiente subcontratas</span><span id="bal-sub">â€”</span><span></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• CONFIGURACIÃ“N â•â•â• -->
    <div class="view" id="view-configuracion">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ¢ Datos de la empresa</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">ğŸ’¾ Guardar</button></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group fg-full"><label class="form-label">RazÃ³n Social</label><input class="form-input" id="cfg-razon" placeholder="PAU INTERIORISMO S.L."></div>
              <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="cfg-cif"></div>
              <div class="form-group"><label class="form-label">TelÃ©fono</label><input class="form-input" id="cfg-tel"></div>
              <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="cfg-email" type="email"></div>
              <div class="form-group"><label class="form-label">Web</label><input class="form-input" id="cfg-web"></div>
              <div class="form-group fg-full"><label class="form-label">DirecciÃ³n</label><input class="form-input" id="cfg-dir"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š ParÃ¡metros CI+GG+BI</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">ğŸ’¾ Guardar</button></div>
          <div class="card-body">
            <div class="info-box">Estos porcentajes se aplican automÃ¡ticamente en el presupuesto cuando activas CI+GG+BI en cada lÃ­nea.</div>
            <div class="form-grid">
              <div class="form-group"><label class="form-label">CI - Costes Indirectos %</label><input class="form-input" id="cfg-ci" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">GG - Gastos Generales %</label><input class="form-input" id="cfg-gg" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">BI - Beneficio Industrial %</label><input class="form-input" id="cfg-bi" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">TOTAL CI+GG+BI %</label><input class="form-input calc" id="cfg-total-ci" readonly></div>
              <div class="form-group"><label class="form-label">Coste hora defecto (â‚¬)</label><input class="form-input" id="cfg-hora" type="number" step="0.5"></div>
            </div>
          </div>
        </div>
      </div>
        <!-- DÃAS DE PAGO -->
        <div class="card" style="margin-top:14px">
          <div class="card-header">
            <div class="card-title">ğŸ“… DÃ­as de pago</div>
            <button class="btn btn-ghost btn-sm" onclick="saveDiasPago()">ğŸ’¾ Guardar</button>
          </div>
          <div class="card-body">
            <div class="info-box">Estos son los dÃ­as del mes en que se realizan los pagos. Se usan para calcular automÃ¡ticamente el vencimiento en facturas de compra con giro.</div>
            <div class="form-grid" style="margin-bottom:12px">
              <div class="form-group">
                <label class="form-label">DÃ­a de pago 1</label>
                <input class="form-input" id="cfg-dia1" type="number" min="1" max="31" value="5" placeholder="5">
              </div>
              <div class="form-group">
                <label class="form-label">DÃ­a de pago 2</label>
                <input class="form-input" id="cfg-dia2" type="number" min="1" max="31" value="20" placeholder="20">
              </div>
            </div>
            <div style="background:var(--bg);border-radius:6px;padding:10px;font-size:12px;color:var(--text-soft)">
              <strong style="color:var(--navy)">Â¿CÃ³mo funciona?</strong><br>
              Al seleccionar <em>Giro 30/60/90/120 dÃ­as</em> en una factura, el sistema calcula la fecha de vencimiento 
              sumando los dÃ­as al plazo y ajustando al siguiente dÃ­a de pago configurado (dÃ­a 5 o 20).<br><br>
              <strong>Ejemplo:</strong> Factura con fecha 10/03 + Giro 30 dÃ­as = vencimiento 09/04 â†’ ajusta al <strong>20/04</strong>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="card-header"><div class="card-title">ğŸ“ CategorÃ­as de partidas</div></div>
          <div class="card-body">
            <div class="info-box">Define si cada categorÃ­a aplica CI+GG+BI por defecto al aÃ±adirla al presupuesto.</div>
            <table style="width:100%;font-size:12px;border-collapse:collapse">
              <thead><tr><th style="padding:8px;background:var(--navy);color:white;text-align:left">CategorÃ­a</th><th style="padding:8px;background:var(--navy);color:white;text-align:center">Aplica CI+GG+BI</th></tr></thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Materiales</td><td style="padding:8px;text-align:center"><span class="badge b-green">SÃ­</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Mano de Obra</td><td style="padding:8px;text-align:center"><span class="badge b-green">SÃ­</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Maquinaria</td><td style="padding:8px;text-align:center"><span class="badge b-green">SÃ­</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Subcontrata</td><td style="padding:8px;text-align:center"><span class="badge b-red">No</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Transporte</td><td style="padding:8px;text-align:center"><span class="badge b-green">SÃ­</span></td></tr>
                <tr><td style="padding:8px">Varios</td><td style="padding:8px;text-align:center"><span class="badge b-green">SÃ­</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- CLIENTE -->
<div class="overlay" id="m-cliente"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ¤ <span id="m-cliente-title">Nuevo cliente</span></div><button class="modal-close" onclick="closeModal('m-cliente')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="c-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="c-nombre"></div>
      <div class="form-group"><label class="form-label">CIF/NIF</label><input class="form-input" id="c-cif"></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input class="form-input" id="c-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="c-email" type="email"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="c-tipo"><option>Particular</option><option>Empresa</option><option>Promotora</option><option>AdministraciÃ³n</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="c-pago"><option>Transferencia</option><option>Efectivo</option><option>DomiciliaciÃ³n</option><option>Confirming</option><option>PagarÃ©</option><option>Giro 30 dÃ­as</option><option>Giro 60 dÃ­as</option><option>Giro 90 dÃ­as</option><option>Giro 120 dÃ­as</option></select></div>
      <div class="form-group fg-full"><label class="form-label">DirecciÃ³n</label><input class="form-input" id="c-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="c-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-cliente')">Cancelar</button><button class="btn btn-primary" onclick="saveCliente()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- PROYECTO -->
<div class="overlay" id="m-proyecto"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ“ <span id="m-proyecto-title">Nuevo proyecto</span></div><button class="modal-close" onclick="closeModal('m-proyecto')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="p-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Cliente</label><select class="form-input" id="p-cliente"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Nombre del proyecto *</label><input class="form-input" id="p-nombre"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="p-tipo"><option>Obra nueva</option><option>RehabilitaciÃ³n integral</option><option>Reforma parcial</option><option>Cocina</option><option>BaÃ±o</option><option>Interiorismo</option><option>Mobiliario</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="p-estado"><option>Nuevo lead</option><option>Presupuesto enviado</option><option>Aprobado</option><option>En ejecuciÃ³n</option><option>Finalizado</option><option>Facturado</option><option>Cobrado</option><option>Cancelado</option></select></div>
      <div class="form-group"><label class="form-label">Responsable</label><select class="form-input" id="p-resp"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Fecha inicio</label><input class="form-input" id="p-fecha" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">DirecciÃ³n de obra</label><input class="form-input" id="p-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="p-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proyecto')">Cancelar</button><button class="btn btn-primary" onclick="saveProyecto()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO LINEA -->
<div class="overlay" id="m-pres-linea"><div class="modal" style="width:600px">
  <div class="modal-head"><div class="modal-title">ğŸ’° <span id="m-pres-title">Nueva lÃ­nea</span></div><button class="modal-close" onclick="closeModal('m-pres-linea')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="pl-id">
    <div class="form-group" style="margin-bottom:10px"><label class="form-label">ğŸ” Buscar en CYPE 2026</label>
      <input class="form-input" id="pl-cype-search" placeholder="Escribe para buscar partida CYPEâ€¦" oninput="searchCypeLinea()">
      <div id="pl-cype-results" style="max-height:140px;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;display:none;background:white;position:relative;z-index:10"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px"><label class="form-label">ğŸ“‹ O seleccionar del tarifario propio</label>
      <select class="form-input" id="pl-tarif-sel" onchange="loadTarifLinea()"><option value="">â€” Seleccionar del tarifario â€”</option></select>
    </div>
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">DescripciÃ³n *</label><input class="form-input" id="pl-desc"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="pl-ud"><option>mÂ²</option><option>mÂ³</option><option>ml</option><option>Ud</option><option>kg</option><option>h</option><option>PA</option><option>m</option></select></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="pl-cant" type="number" step="0.01" value="1" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Base (coste)</label><input class="form-input" id="pl-precio" type="number" step="0.01" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="pl-margen" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">CI+GG+BI %</label><input class="form-input" id="pl-ci" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Venta</label><input class="form-input calc" id="pl-pventa" readonly></div>
      <div class="form-group"><label class="form-label">Subtotal</label><input class="form-input calc" id="pl-subtotal" readonly></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="pl-iva"><option>10%</option><option>21%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">CapÃ­tulo / Partida</label><input class="form-input" id="pl-partida"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-linea')">Cancelar</button><button class="btn btn-primary" onclick="saveLineaPresupuesto()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO CAPÃTULO -->
<div class="overlay" id="m-pres-cap"><div class="modal" style="width:400px">
  <div class="modal-head"><div class="modal-title">ğŸ“‚ Nuevo capÃ­tulo</div><button class="modal-close" onclick="closeModal('m-pres-cap')">Ã—</button></div>
  <div class="modal-body"><div class="form-group"><label class="form-label">Nombre del capÃ­tulo</label><input class="form-input" id="cap-nombre" placeholder="01. Demoliciones y trabajos previos"></div></div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-cap')">Cancelar</button><button class="btn btn-primary" onclick="saveCapitulo()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- COMPARATIVA OFERTAS -->
<div class="overlay" id="m-comparativa"><div class="modal" style="width:780px;max-width:96vw">
  <div class="modal-head"><div class="modal-title">âš–ï¸ Nueva comparativa de ofertas</div><button class="modal-close" onclick="closeModal('m-comparativa')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="cmp-id">
    <!-- Cabecera: proyecto + trabajo + modo de cÃ¡lculo -->
    <div class="form-grid" style="margin-bottom:10px">
      <div class="form-group"><label class="form-label">Cliente</label>
        <select class="form-input" id="cmp-cliente" onchange="cascadaClienteModalCmp()"><option value="">Seleccionarâ€¦</option></select>
      </div>
      <div class="form-group"><label class="form-label">Proyecto *</label>
        <select class="form-input" id="cmp-proyecto"><option value="">Seleccionarâ€¦</option></select>
      </div>
      <div class="form-group fg-full"><label class="form-label">Trabajo / Material *</label>
        <input class="form-input" id="cmp-trabajo" placeholder="Ej: InstalaciÃ³n fontanerÃ­a cocina">
      </div>
    </div>
    <!-- Modo de cÃ¡lculo -->
    <div style="display:flex;gap:8px;margin-bottom:14px;background:var(--bg);border-radius:6px;padding:8px 10px;align-items:center">
      <span style="font-size:12px;font-weight:600;color:var(--text-soft);margin-right:4px">Modo:</span>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px">
        <input type="radio" name="cmp-modo" value="pvp" checked onchange="cambiarModoComparativa()"> 
        <span>ğŸ“‰ PVP catÃ¡logo âˆ’ descuento</span>
      </label>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;margin-left:12px">
        <input type="radio" name="cmp-modo" value="coste" onchange="cambiarModoComparativa()"> 
        <span>ğŸ“ˆ Precio coste + margen</span>
      </label>
    </div>
    <!-- Las 3 ofertas -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px" id="cmp-ofertas-grid">
      <div id="cmp-col-1" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 1</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o1-prov"><option value="">Seleccionarâ€¦</option></select>
        </div>
        <div id="o1-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP catÃ¡logo â‚¬</label>
            <input class="form-input" id="o1-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(1)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o1-dto" type="number" value="0" step="0.1" oninput="calcOferta(1)">
          </div>
        </div>
        <div id="o1-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste â‚¬</label>
            <input class="form-input" id="o1-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(1)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o1-mk" type="number" value="0" step="0.1" oninput="calcOferta(1)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o1-res-coste">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o1-res-venta">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen â‚¬</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o1-res-margen">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o1-res-pct">â€”</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o1-notas" placeholder="Plazo, condicionesâ€¦">
        </div>
      </div>
      <div id="cmp-col-2" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 2</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o2-prov"><option value="">Seleccionarâ€¦</option></select>
        </div>
        <div id="o2-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP catÃ¡logo â‚¬</label>
            <input class="form-input" id="o2-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(2)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o2-dto" type="number" value="0" step="0.1" oninput="calcOferta(2)">
          </div>
        </div>
        <div id="o2-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste â‚¬</label>
            <input class="form-input" id="o2-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(2)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o2-mk" type="number" value="0" step="0.1" oninput="calcOferta(2)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o2-res-coste">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o2-res-venta">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen â‚¬</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o2-res-margen">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o2-res-pct">â€”</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o2-notas" placeholder="Plazo, condicionesâ€¦">
        </div>
      </div>
      <div id="cmp-col-3" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 3</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o3-prov"><option value="">Seleccionarâ€¦</option></select>
        </div>
        <div id="o3-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP catÃ¡logo â‚¬</label>
            <input class="form-input" id="o3-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(3)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o3-dto" type="number" value="0" step="0.1" oninput="calcOferta(3)">
          </div>
        </div>
        <div id="o3-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste â‚¬</label>
            <input class="form-input" id="o3-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(3)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o3-mk" type="number" value="0" step="0.1" oninput="calcOferta(3)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o3-res-coste">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o3-res-venta">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen â‚¬</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o3-res-margen">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o3-res-pct">â€”</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o3-notas" placeholder="Plazo, condicionesâ€¦">
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:12px;padding-top:10px;border-top:1px solid var(--border);flex-wrap:wrap">
      <label class="form-label" style="margin:0;white-space:nowrap">Oferta elegida:</label>
      <select class="form-input" id="cmp-elegida" style="width:160px">
        <option value="1">Oferta 1</option><option value="2">Oferta 2</option><option value="3">Oferta 3</option>
      </select>
      <span id="cmp-ganadora-info" style="font-size:12px;flex:1"></span>
    </div>
    <!-- Resumen comparativo -->
    <div id="cmp-resumen" style="display:none;margin-top:8px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      <div style="background:#e8f5ee;border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">ğŸ’° Menor coste</div>
        <div id="cmp-res-precio" style="font-weight:700;color:var(--green)">â€”</div>
      </div>
      <div style="background:#fff5e6;border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">ğŸ“ˆ Mayor margen</div>
        <div id="cmp-res-margen" style="font-weight:700;color:var(--copper)">â€”</div>
      </div>
      <div style="background:var(--bg);border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">ğŸ“Š Diferencia max-min</div>
        <div id="cmp-res-diff" style="font-weight:700;color:var(--navy)">â€”</div>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-comparativa')">Cancelar</button><button class="btn btn-primary" onclick="saveComparativa()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- TARIFARIO -->
<div class="overlay" id="m-tarifario"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ“‹ <span id="m-tarif-title">Nuevo artÃ­culo</span></div><button class="modal-close" onclick="closeModal('m-tarifario')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="t-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">CÃ³digo *</label><input class="form-input" id="t-codigo"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="t-unidad"><option>Ud</option><option>mÂ²</option><option>mÂ³</option><option>ml</option><option>kg</option><option>h</option><option>PA</option></select></div>
      <div class="form-group fg-full"><label class="form-label">DescripciÃ³n *</label><input class="form-input" id="t-desc"></div>
      <div class="form-group"><label class="form-label">Precio coste (s/IVA)</label><input class="form-input" id="t-coste" type="number" step="0.01" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="t-margen" type="number" step="0.1" value="30" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Precio venta</label><input class="form-input calc" id="t-pventa" readonly></div>
      <div class="form-group"><label class="form-label">CategorÃ­a</label><select class="form-input" id="t-cat"><option>Mobiliario</option><option>Sanitarios</option><option>GriferÃ­as</option><option>Cocina</option><option>CarpinterÃ­a</option><option>Pavimentos</option><option>Revestimientos</option><option>Instalaciones</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="t-marca"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="t-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-tarifario')">Cancelar</button><button class="btn btn-primary" onclick="saveTarifario()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- INTERIORISMO -->
<div class="overlay" id="m-interiorismo"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ›‹ AÃ±adir artÃ­culo</div><button class="modal-close" onclick="closeModal('m-interiorismo')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="i-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Proyecto *</label><select class="form-input" id="i-proyecto"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Estancia</label><select class="form-input" id="i-estancia"><option>SalÃ³n</option><option>Cocina</option><option>Dormitorio</option><option>BaÃ±o</option><option>Terraza</option><option>Despacho</option><option>Comedor</option><option>Pasillo</option><option>Entrada</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Ref. Tarifario</label><select class="form-input" id="i-ref" onchange="loadTarifarioItem()"><option value="">â€” descripciÃ³n libre â€”</option></select></div>
      <div class="form-group"><label class="form-label">DescripciÃ³n</label><input class="form-input" id="i-desc"></div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="i-marca"></div>
      <div class="form-group"><label class="form-label">Acabado</label><input class="form-input" id="i-acabado"></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="i-cant" type="number" value="1" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP unitario</label><input class="form-input" id="i-pvp" type="number" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">Dto. cliente %</label><input class="form-input" id="i-dto" type="number" value="0" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP Neto</label><input class="form-input calc" id="i-neto" readonly></div>
      <div class="form-group"><label class="form-label">Coste neto</label><input class="form-input" id="i-coste" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="i-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Estado propuesta</label><select class="form-input" id="i-eprop"><option>Borrador</option><option>Enviada</option><option>Aprobada</option><option>Rechazada</option><option>En pedido</option><option>Entregada</option></select></div>
      <div class="form-group"><label class="form-label">Estado pedido</label><select class="form-input" id="i-eped"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En trÃ¡nsito</option><option>Recibido</option><option>Pagado</option></select></div>
      <div class="form-group"><label class="form-label">Fecha entrega</label><input class="form-input" id="i-fentrega" type="date"></div>
      <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="i-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-interiorismo')">Cancelar</button><button class="btn btn-copper" onclick="saveInteriorismo()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- COMPRA -->
<div class="overlay" id="m-compra"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ›’ Nueva compra</div><button class="modal-close" onclick="closeModal('m-compra')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="co-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="co-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="co-proyecto"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Proveedor</label><select class="form-input" id="co-prov"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="co-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Concepto</label><input class="form-input" id="co-concepto"></div>
      <div class="form-group"><label class="form-label">Base imponible â‚¬</label><input class="form-input" id="co-base" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="co-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="co-vto" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="co-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-compra')">Cancelar</button><button class="btn btn-primary" onclick="saveCompra()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- SUBCONTRATA -->
<div class="overlay" id="m-subcontrata"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ‘· Nueva subcontrata</div><button class="modal-close" onclick="closeModal('m-subcontrata')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="sc-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="sc-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="sc-proyecto"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Subcontratista</label><select class="form-input" id="sc-prov"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="sc-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Trabajo</label><input class="form-input" id="sc-trabajo"></div>
      <div class="form-group"><label class="form-label">Importe base â‚¬</label><input class="form-input" id="sc-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="sc-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="sc-vto" type="date"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-subcontrata')">Cancelar</button><button class="btn btn-primary" onclick="saveSubcontrata()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- HORA -->
<div class="overlay" id="m-hora"><div class="modal" style="width:420px">
  <div class="modal-head"><div class="modal-title">â± Registrar horas</div><button class="modal-close" onclick="closeModal('m-hora')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="h-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="h-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="h-proyecto"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Trabajador</label><select class="form-input" id="h-trab"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Horas</label><input class="form-input" id="h-horas" type="number" step="0.5" placeholder="8"></div>
      <div class="form-group"><label class="form-label">â‚¬/hora</label><input class="form-input" id="h-coste" type="number" value="18"></div>
      <div class="form-group fg-full"><label class="form-label">DescripciÃ³n</label><input class="form-input" id="h-desc"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-hora')">Cancelar</button><button class="btn btn-primary" onclick="saveHora()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- PEDIDO -->
<div class="overlay" id="m-pedido"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ“¦ Nuevo pedido</div><button class="modal-close" onclick="closeModal('m-pedido')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="ped-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">NÂº Pedido</label><input class="form-input" id="ped-num" placeholder="PED-001"></div>
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="ped-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="ped-proyecto"><option value="">Seleccionarâ€¦</option></select></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="ped-tipo"><option>Material</option><option>Mobiliario</option><option>Subcontrata</option><option>Herramienta</option><option>Otros</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Empresa/Proveedor</label><select class="form-input" id="ped-prov"><option value="">Seleccionar proveedorâ€¦</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Referencia / DescripciÃ³n</label><input class="form-input" id="ped-ref" placeholder="Ej: Azulejo baÃ±o modelo X, Mueble cocina ref.123..."></div>
      <div class="form-group"><label class="form-label">Importe â‚¬</label><input class="form-input" id="ped-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="ped-estado"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En trÃ¡nsito</option><option>Recibido</option><option>Pagado</option><option>Cancelado</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Observaciones</label><input class="form-input" id="ped-obs"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pedido')">Cancelar</button><button class="btn btn-primary" onclick="savePedido()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- PROVEEDOR -->
<div class="overlay" id="m-proveedor"><div class="modal">
  <div class="modal-head"><div class="modal-title">ğŸ­ Nuevo proveedor</div><button class="modal-close" onclick="closeModal('m-proveedor')">Ã—</button></div>
  <div class="modal-body"><input type="hidden" id="pv-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="pv-nombre"></div>
      <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="pv-cif"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="pv-tipo"><option>Proveedor</option><option>Subcontrata</option><option>Alquiler</option><option>Servicio</option><option>Transporte</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input class="form-input" id="pv-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="pv-email" type="email"></div>
      <div class="form-group"><label class="form-label">Especialidad</label><input class="form-input" id="pv-esp"></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="pv-pago"><option>Transferencia</option><option>Efectivo</option><option>DomiciliaciÃ³n</option><option>Confirming</option><option>PagarÃ©</option><option>Giro 30 dÃ­as</option><option>Giro 60 dÃ­as</option><option>Giro 90 dÃ­as</option><option>Giro 120 dÃ­as</option></select></div>
      <div class="form-group"><label class="form-label">IBAN</label><input class="form-input" id="pv-iban"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="pv-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proveedor')">Cancelar</button><button class="btn btn-primary" onclick="saveProveedor()">ğŸ’¾ Guardar</button></div>
</div></div>

<!-- FACTURA -->
<div class="overlay" id="m-factura"><div class="modal" style="width:640px;max-width:96vw">
  <div class="modal-head">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="modal-title" id="f-modal-title">ğŸ§¾ Nueva factura</div>
      <span id="f-tipo-badge" style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px;background:#e8f5ee;color:var(--green)">ğŸ“¤ VENTA</span>
    </div>
    <button class="modal-close" onclick="closeModal('m-factura')">Ã—</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="f-id">
    <input type="hidden" id="f-tipo" value="Venta">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">NÂº Factura *</label><input class="form-input" id="f-num" placeholder="FAC-2026-001"></div>
      <div class="form-group"><label class="form-label">Fecha emisiÃ³n</label><input class="form-input" id="f-fecha" type="date"></div>
      <!-- Venta â†’ Cliente | Compra â†’ Proveedor -->
      <div class="form-group" id="f-grp-cliente"><label class="form-label">Cliente</label>
        <select class="form-input" id="f-cliente" onchange="cascadaClienteFactura()"><option value="">Seleccionarâ€¦</option></select>
      </div>
      <div class="form-group" id="f-grp-proveedor" style="display:none"><label class="form-label">Proveedor</label>
        <select class="form-input" id="f-proveedor"><option value="">Seleccionarâ€¦</option></select>
      </div>
      <div class="form-group" id="f-grp-proyecto">
        <label class="form-label">Proyecto <span style="font-size:10px;color:var(--text-soft);font-weight:400">(opcional)</span></label>
        <select class="form-input" id="f-proyecto"><option value="">â€” Sin proyecto â€”</option></select>
      </div>
      <div class="form-group fg-full"><label class="form-label">Concepto / DescripciÃ³n</label>
        <input class="form-input" id="f-concepto" placeholder="DescripciÃ³n del trabajo o materialâ€¦">
      </div>
      <div class="form-group"><label class="form-label">Base imponible â‚¬</label>
        <input class="form-input" id="f-base" type="number" step="0.01" oninput="calcTotalFac()">
      </div>
      <div class="form-group"><label class="form-label">IVA</label>
        <select class="form-input" id="f-iva" onchange="calcTotalFac()">
          <option>21%</option><option>10%</option><option>4%</option><option>Exento</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Total con IVA</label>
        <input class="form-input" id="f-total-display" readonly style="background:var(--bg);font-weight:700;color:var(--navy)">
      </div>
      <!-- Vencimiento Ãºnico (ventas) / mÃºltiple (compras) -->
      <div class="form-group" id="f-grp-vto-simple">
        <label class="form-label">Fecha vencimiento</label>
        <input class="form-input" id="f-vto-venta" type="date">
      </div>
      <!-- Vencimientos mÃºltiples solo para compras -->
      <div class="form-group fg-full" id="f-grp-vtos-compra" style="display:none">
        <label class="form-label">Vencimientos <span style="font-size:10px;color:var(--text-soft);font-weight:400">â€” hasta 4 plazos (pulsa ğŸ’¡ para sugerir dÃ­as de pago)</span>
          <button type="button" onclick="sugerirDiasPago()" style="background:none;border:none;cursor:pointer;font-size:14px;padding:0 4px;vertical-align:middle" title="Sugerir dÃ­as de pago">ğŸ’¡</button>
        </label>
        <div style="display:grid;grid-template-columns:1fr 120px 1fr 120px 1fr 120px 1fr 120px;gap:6px;align-items:center">
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 1</div>
            <input class="form-input" id="f-vto" type="date" onclick="confirmarVto('f-vto')" onchange="confirmarVto('f-vto')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div>
            <input class="form-input" id="f-importe-vto1" type="number" step="0.01" placeholder="â‚¬" onclick="confirmarVto('f-importe-vto1')" onchange="confirmarVto('f-importe-vto1')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 2</div>
            <input class="form-input" id="f-vto2" type="date" onclick="confirmarVto('f-vto2')" onchange="confirmarVto('f-vto2')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div>
            <input class="form-input" id="f-importe-vto2" type="number" step="0.01" placeholder="â‚¬" onclick="confirmarVto('f-importe-vto2')" onchange="confirmarVto('f-importe-vto2')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 3</div>
            <input class="form-input" id="f-vto3" type="date" onclick="confirmarVto('f-vto3')" onchange="confirmarVto('f-vto3')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div>
            <input class="form-input" id="f-importe-vto3" type="number" step="0.01" placeholder="â‚¬" onclick="confirmarVto('f-importe-vto3')" onchange="confirmarVto('f-importe-vto3')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 4</div>
            <input class="form-input" id="f-vto4" type="date" onclick="confirmarVto('f-vto4')" onchange="confirmarVto('f-vto4')">
          </div>
          <div>
            <div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div>
            <input class="form-input" id="f-importe-vto4" type="number" step="0.01" placeholder="â‚¬" onclick="confirmarVto('f-importe-vto4')" onchange="confirmarVto('f-importe-vto4')">
          </div>
        </div>
        <div style="font-size:10px;color:var(--text-soft);margin-top:4px">ğŸ’¡ DÃ­as de pago configurados: <span id="f-dias-pago-info">5 y 20 de cada mes</span></div>
      </div>
      <div class="form-group"><label class="form-label">Forma de pago</label>
        <select class="form-input" id="f-pago" onchange="onFormaPagoChange()">
          <option>Transferencia</option><option>Efectivo</option><option>DomiciliaciÃ³n</option><option>Confirming</option><option>Cheque</option><option>Giro 30 dÃ­as</option><option>Giro 60 dÃ­as</option><option>Giro 90 dÃ­as</option><option>Giro 120 dÃ­as</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label" id="f-cobrado-lbl">Importe cobrado â‚¬</label>
        <input class="form-input" id="f-cobrado" type="number" step="0.01" value="0">
      </div>
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="f-estado">
          <option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-factura')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveFactura()">ğŸ’¾ Guardar</button>
  </div>
</div></div>

<!-- QUICK -->
<div class="overlay" id="m-quick"><div class="modal" style="width:320px">
  <div class="modal-head"><div class="modal-title">ï¼‹ Â¿QuÃ© quieres crear?</div><button class="modal-close" onclick="closeModal('m-quick')">Ã—</button></div>
  <div class="modal-body"><div style="display:flex;flex-direction:column;gap:7px">
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-cliente')">ğŸ¤ <strong style="margin-left:8px">Nuevo cliente</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-proyecto')">ğŸ“ <strong style="margin-left:8px">Nuevo proyecto</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-comparativa')">âš–ï¸ <strong style="margin-left:8px">Comparativa ofertas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-interiorismo')">ğŸ›‹ <strong style="margin-left:8px">Propuesta interiorismo</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-compra')">ğŸ›’ <strong style="margin-left:8px">Registrar compra</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-hora')">â± <strong style="margin-left:8px">Registrar horas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-pedido')">ğŸ“¦ <strong style="margin-left:8px">Nuevo pedido</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-factura')">ğŸ§¾ <strong style="margin-left:8px">Emitir factura</strong></button>
  </div></div>
</div></div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title">âš ï¸ Eliminar registro</div>
    <div class="confirm-text" id="confirm-text">Â¿Seguro que quieres eliminar?</div>
    <div class="confirm-btns"><button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button><button class="btn btn-danger" onclick="confirmDeleteAction()">Eliminar</button></div>
  </div>
</div>
<!-- MODAL COMPARATIVA VERSIONES -->
<div class="modal-overlay" id="m-comparativa" style="display:none" onclick="if(event.target===this)closeModal('m-comparativa')">
  <div class="modal" style="max-width:920px;width:96%">
    <div class="modal-header">
      <div class="modal-title">âš–ï¸ Comparativa de versiones de presupuesto</div>
      <button class="modal-close" onclick="closeModal('m-comparativa')">âœ•</button>
    </div>
    <div class="modal-body" style="padding:16px">
      <div id="comp-kpis" class="kpi-grid" style="margin-bottom:16px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))"></div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead id="comp-thead"></thead>
          <tbody id="comp-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESUPUESTO FINAL (documento imprimible)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initPresFinal(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  populateSelects();
  const sel=document.getElementById('pf-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyectoâ€¦</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
}
async function loadPresupuestoFinal(){
  const proy=document.getElementById('pf-proyecto-sel').value;
  const ver=document.getElementById('pf-version-sel').value;
  const empty=document.getElementById('pf-empty');
  if(!proy){empty.style.display='block';return;}
  empty.style.display='none';
  try{
    const[lineas,proyecto]=await Promise.all([
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`),
      sbGet('proyectos',`?proyecto_id=eq.${proy}`)
    ]);
    const p=proyecto[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    // Header
    document.getElementById('pf-num').textContent=`Presupuesto NÂº: ${proy}-${ver.toUpperCase()}`;
    document.getElementById('pf-fecha').textContent=new Date().toLocaleDateString('es-ES');
    document.getElementById('pf-cliente-nombre').textContent=cliente.nombre||'â€”';
    document.getElementById('pf-cliente-cif').textContent=cliente.cif?`CIF: ${cliente.cif}`:'';
    document.getElementById('pf-cliente-dir').textContent=cliente.direccion||'';
    document.getElementById('pf-proyecto-nombre').textContent=p.nombre||'â€”';
    document.getElementById('pf-proyecto-dir').textContent=p.direccion_obra||'';
    // Lineas
    let totalBase=0;
    const tbody=document.getElementById('pf-lineas');
    tbody.innerHTML=lineas.map((l,i)=>{
      if(l.es_capitulo)return`<tr><td colspan="5" style="padding:10px 8px;font-weight:700;background:#27405b;color:white;font-size:12px">ğŸ“‚ ${l.descripcion}</td></tr>`;
      const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv*(ci>0?(1+ci/100):1);
      totalBase+=sub;
      const bg=i%2===0?'white':'#f9f9f9';
      return`<tr style="background:${bg};border-bottom:1px solid #eee"><td style="padding:7px 8px">${l.descripcion}</td><td style="padding:7px 8px;text-align:center">${l.unidad||''}</td><td style="padding:7px 8px;text-align:right">${l.cantidad||0}</td><td style="padding:7px 8px;text-align:right">${(pv*(ci>0?1+ci/100:1)).toFixed(2)}â‚¬</td><td style="padding:7px 8px;text-align:right;font-weight:600">${sub.toFixed(2)}â‚¬</td></tr>`;
    }).join('');
    const iva=totalBase*0.10,total=totalBase+iva;
    document.getElementById('pf-base').textContent=totalBase.toFixed(2)+'â‚¬';
    document.getElementById('pf-iva').textContent=iva.toFixed(2)+'â‚¬';
    document.getElementById('pf-total').textContent=total.toFixed(2)+'â‚¬';
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRATO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initContrato(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  const sel=document.getElementById('ct-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyectoâ€¦</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
}
async function loadContrato(){
  const proyId=document.getElementById('ct-proyecto-sel').value;
  if(!proyId)return;
  try{
    const[proyArr,lineas]=await Promise.all([
      sbGet('proyectos',`?proyecto_id=eq.${proyId}`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proyId}&version=eq.v1&es_capitulo=eq.false`)
    ]);
    const p=proyArr[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    const totalBase=lineas.reduce((s,l)=>s+(l.subtotal||0),0);
    const totalIVA=totalBase*1.10;
    const hoy=new Date().toLocaleDateString('es-ES');
    document.getElementById('ct-fecha').textContent=hoy;
    document.getElementById('ct-cliente-nombre').textContent=cliente.nombre||'[CLIENTE]';
    document.getElementById('ct-cliente-cif').textContent=cliente.cif||'[CIF]';
    document.getElementById('ct-cliente-dir').textContent=cliente.direccion||'[DIRECCIÃ“N]';
    document.getElementById('ct-proyecto-nombre').textContent=p.nombre||'[PROYECTO]';
    document.getElementById('ct-proyecto-dir').textContent=p.direccion_obra||'[DIRECCIÃ“N OBRA]';
    document.getElementById('ct-pres-id').textContent=`${proyId}-V1`;
    document.getElementById('ct-importe').textContent=totalIVA.toFixed(2)+'â‚¬ (IVA incluido)';
    document.getElementById('ct-firma-cliente').textContent=cliente.nombre||'[CLIENTE]';
    // Populate presupuesto selector
    document.getElementById('ct-pres-sel').innerHTML=`<option value="v1">${proyId}-v1 Â· ${totalIVA.toFixed(2)}â‚¬ c/IVA</option>`;
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEDIDO DOCUMENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initPedidoDoc(){
  if(!PedC.length)PedC=await sbGet('pedidos','?order=fecha.desc').catch(()=>[]);
  const sel=document.getElementById('pd-pedido-sel');
  sel.innerHTML='<option value="">Seleccionar pedidoâ€¦</option>'+PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin nÂº'} Â· ${p.proveedor||'â€”'} Â· ${fmt(p.importe)}</option>`).join('');
}
async function loadPedidoDoc(){
  const id=document.getElementById('pd-pedido-sel').value;
  if(!id)return;
  const ped=PedC.find(p=>p.id===id);
  if(!ped)return;
  const prov=ProvC.find(p=>p.nombre===ped.proveedor)||{};
  const proy=PC.find(p=>p.proyecto_id===ped.proyecto_id)||{};
  document.getElementById('pd-num').textContent=ped.num_pedido||'â€”';
  document.getElementById('pd-fecha').textContent=fmtD(ped.fecha);
  document.getElementById('pd-prov-nombre').textContent=ped.proveedor||'â€”';
  document.getElementById('pd-prov-tel').textContent=prov.telefono?`Tel: ${prov.telefono}`:'';
  document.getElementById('pd-prov-email').textContent=prov.email||'';
  document.getElementById('pd-proyecto').textContent=proy.nombre||ped.proyecto_id||'â€”';
  document.getElementById('pd-tipo').textContent=ped.tipo||'';
  document.getElementById('pd-concepto').textContent=ped.observaciones||ped.tipo||'Material segÃºn pedido';
  document.getElementById('pd-importe').textContent=fmt(ped.importe);
  document.getElementById('pd-obs').textContent=ped.observaciones||'Servir lo antes posible.';
  document.getElementById('pd-proyecto-dir').textContent=proy.direccion_obra||'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function upsertConfig(clave, valor){
  // Upsert usando Supabase: si existe actualiza, si no inserta
  const resp = await fetch(`${SB_URL}/rest/v1/configuracion`, {
    method: 'POST',
    headers: {
      'apikey': SB_KEY,
      'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates,return=minimal'
    },
    body: JSON.stringify({clave, valor, descripcion:'Lista editable'})
  });
  if(!resp.ok){
    const err = await resp.text();
    throw new Error(err);
  }
}

async function addListItem(listId, tipo){
  const val=prompt(`Nuevo ${tipo}:`);
  if(!val||!val.trim())return;
  const v=val.trim();
  // Actualizar cachÃ© en memoria
  const clave=LISTA_MAP[listId];
  if(clave){
    if(clave==='trabajadores'){if(!TRABAJADORES.includes(v))TRABAJADORES.push(v);}
    else if(LISTAS[clave]){if(!LISTAS[clave].includes(v))LISTAS[clave].push(v);}
  }
  // Actualizar UI
  const list=document.getElementById(listId);
  if(list){
    const div=document.createElement('div');
    div.className='lista-item';div.dataset.val=v;div.textContent=v;
    list.appendChild(div);
  }
  // Refrescar todos los desplegables
  populateTrabajadores();
  populateAllListas();
  // Guardar en Supabase
  if(clave){
    const arr=clave==='trabajadores'?TRABAJADORES:(LISTAS[clave]||[]);
    try{
      await upsertConfig(clave, arr.join(','));
      toast(`"${v}" guardado âœ…`);
    }catch(e){
      toast(`Error guardando: ${e.message}`,'error');
    }
  } else {
    toast(`"${v}" aÃ±adido âœ…`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL='https://qxyflndntpmcdbyvwjnj.supabase.co';
const SB_KEY='sb_publishable_mCrvdo_QgXEwReMdKxJ1RQ_wpRcqLcE';
const USERS={'jose':'pau2026','pau':'pau2026'};
const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_CORTOS=['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  // Login simplificado - acepta cualquier usuario con cualquier contraseÃ±a
  // o directamente sin contraseÃ±a
  const u=document.getElementById('login-user').value.trim().toLowerCase()||'jose';
  document.getElementById('login-screen').style.display='none';
  sessionStorage.setItem('pau-auth','1');
  sessionStorage.setItem('pau-user',u);
  setUserDisplay(u);
  init();
}
function doLogout(){sessionStorage.clear();location.reload();}
function setUserDisplay(u){
  const n=u.charAt(0).toUpperCase()+u.slice(1);
  document.getElementById('user-name').textContent=n;
  document.getElementById('user-av').textContent=n.substring(0,2).toUpperCase();
}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
if(sessionStorage.getItem('pau-auth')==='1'){
  document.getElementById('login-screen').style.display='none';
  setUserDisplay(sessionStorage.getItem('pau-user')||'jose');
  document.addEventListener('DOMContentLoaded',init);
  if(document.readyState!=='loading')init();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sb(table,method='GET',body=null,id=null,extra=''){
  const url=`${SB_URL}/rest/v1/${table}${id?`?id=eq.${id}`:''}${extra}`;
  const r=await fetch(url,{method,headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':method==='POST'?'return=representation':''},body:body?JSON.stringify(body):null});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):[];
}
const sbGet=(t,e='')=>sb(t,'GET',null,null,e);
const sbPost=(t,d)=>sb(t,'POST',d);
const sbPatch=(t,id,d)=>sb(t,'PATCH',d,id);
const sbDelete=(t,id)=>sb(t,'DELETE',null,id);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const META={
  gerencia:{t:'Gerencia Â· Panel ejecutivo',b:'Datos en tiempo real Â· Todos los proyectos'},
  clientes:{t:'Clientes',b:'Base de datos centralizada'},
  proyectos:{t:'Proyectos',b:'Todos los proyectos'},
  presupuesto:{t:'Presupuesto Â· Constructor',b:'BÃºsqueda CYPE + Tarifario propio'},
  comparativa:{t:'Comparativa de ofertas',b:'Compara hasta 3 proveedores por trabajo'},
  tarifario:{t:'Tarifario Â· CatÃ¡logo propio',b:''},
  cype:{t:'CYPE 2026 Â· 524 partidas',b:'Base de precios importada de tu Excel'},
  interiorismo:{t:'Interiorismo & Mobiliario',b:'Propuestas Â· Pedidos Â· MÃ¡rgenes'},
  compras:{t:'Compras',b:''},subcontratas:{t:'Subcontratas',b:''},
  horas:{t:'Control de horas',b:''},pedidos:{t:'Registro de pedidos',b:''},
  control_horario:{t:'Control horario anual',b:'Ficha por trabajador'},
  proveedores:{t:'Proveedores',b:'32 proveedores importados'},
  conciliacion:{t:'ConciliaciÃ³n bancaria',b:'Vencimientos Â· Importar extracto Â· Conciliar pagos automÃ¡ticamente'},
  rentabilidad:{t:'Rentabilidad por proyecto',b:'Presupuesto vs Coste real'},
  facturas:{t:'Facturas emitidas',b:'Seguimiento de cobros'},
  contabilidad:{t:'Contabilidad',b:'Cuenta de resultados Â· IVA Â· Balance'},
  pres_final:{t:'Presupuesto Final Â· Documento',b:'Documento imprimible listo para enviar al cliente'},
  contrato:{t:'Contrato de obra',b:'Plantilla de contrato autorellenable'},
  pedido_doc:{t:'Documento de pedido',b:'Hoja de pedido a proveedor imprimible'},
  listas:{t:'Listas Â· GestiÃ³n de desplegables',b:'Edita trabajadores, estados, partidas y mÃ¡s'},
  configuracion:{t:'ConfiguraciÃ³n',b:'Empresa Â· CI+GG+BI Â· ParÃ¡metros'},
};
document.querySelectorAll('.nav-item[data-view]').forEach(el=>el.addEventListener('click',()=>navTo(el.dataset.view)));
async function navTo(v){
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  document.querySelector(`[data-view="${v}"]`)?.classList.add('active');
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  document.getElementById('view-'+v)?.classList.add('active');
  const m=META[v]||{};
  document.getElementById('tb-title').textContent=m.t||v;
  document.getElementById('tb-bc').textContent=m.b||'';
  if(loaders[v]) await loaders[v]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bColors={'Nuevo lead':'b-gray','Presupuesto enviado':'b-amber','Aprobado':'b-blue','En ejecuciÃ³n':'b-blue','Finalizado':'b-green','Facturado':'b-green','Cobrado':'b-navy','Cancelado':'b-red','Pendiente':'b-amber','Pagado':'b-green','Cobrada':'b-green','Parcial':'b-copper','Vencido':'b-red','Vencida':'b-red','Borrador':'b-gray','Enviada':'b-amber','Aprobada':'b-green','Rechazada':'b-red','En pedido':'b-blue','Entregada':'b-navy','Solicitado':'b-amber','Confirmado':'b-blue','En trÃ¡nsito':'b-blue','Recibido':'b-copper','Proveedor':'b-blue','Subcontrata':'b-green','Obra nueva':'b-navy','RehabilitaciÃ³n integral':'b-green','Interiorismo':'b-copper','Particular':'b-blue','Empresa':'b-green','Promotora':'b-copper'};
function bE(v){return`<span class="badge ${bColors[v]||'b-gray'}">${v||'â€”'}</span>`}
function fmt(n){if(n===null||n===undefined||n==='')return'â€”';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'â‚¬'}
function fmtN(n){if(!n&&n!==0)return'â€”';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'â‚¬'}
function fmtP(n){return n!=null?Number(n).toFixed(1)+'%':'â€”'}
function fmtD(d){if(!d)return'â€”';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d}
function genId(pre,list,key){const ns=list.map(x=>parseInt((x[key||pre.toLowerCase()+'_id']||'').replace(/\D/g,''))||0);return`${pre}-${(Math.max(0,...ns)+1).toString().padStart(3,'0')}`}
function ivaPct(s){return s==='Exento'?0:parseFloat(s)||21}
let toastT;
function toast(msg,type='success'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast show ${type}`;clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3200);}
function openModal(id){
  if(id==='m-comparativa'){
    poblarProveedoresComparativa();
    poblarClientesModalCmp();
    // Poblar proyectos tambiÃ©n
    const proySel=document.getElementById('cmp-proyecto');
    const clienteId=document.getElementById('cmp-cliente')?.value;
    if(proySel){
      const filtrados=clienteId?PC.filter(p=>p.cliente_id===clienteId):PC;
      proySel.innerHTML='<option value="">Seleccionarâ€¦</option>'
        +filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    }
  }
  document.getElementById(id)?.classList.add('open');
}
function closeModal(id){document.getElementById(id)?.classList.remove('open')}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open')}));
let pendingDel=null;
function confirmDelete(table,id,name){pendingDel={table,id};document.getElementById('confirm-text').textContent=`Â¿Eliminar "${name}"? No se puede deshacer.`;document.getElementById('confirm-overlay').classList.add('open');}
function closeConfirm(){pendingDel=null;document.getElementById('confirm-overlay').classList.remove('open');}
async function confirmDeleteAction(){if(!pendingDel)return;try{await sbDelete(pendingDel.table,pendingDel.id);toast('Eliminado âœ…');closeConfirm();loaders[currentView()]?.();}catch(e){toast('Error: '+e.message,'error');}}
function currentView(){return document.querySelector('.view.active')?.id.replace('view-','')||'gerencia';}
function filterTable(tbId,inId){const q=document.getElementById(inId)?.value.toLowerCase()||'';document.querySelectorAll(`#${tbId} tr[data-search]`).forEach(r=>{r.style.display=r.dataset.search.includes(q)?'':'none';});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CACHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CC=[],PC=[],TC=[],ProvC=[],IntC=[],CoC=[],ScC=[],HC=[],FC=[],PedC=[],CmpC=[],PresC=[],CyCache=[];
let TRABAJADORES=['Paco','RaÃºl','Boro','Julio','Pau','Jose Asins'];
let LISTAS={
  estados_proyecto:['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuciÃ³n','Finalizado','Facturado','Cobrado','Cancelado'],
  tipos_proyecto:['Obra nueva','RehabilitaciÃ³n integral','Reforma parcial','Cocina','BaÃ±o','Interiorismo','Mobiliario','Electricidad','FontanerÃ­a','Pintura','Otros'],
  formas_pago:['Transferencia','Efectivo','Giro','DomiciliaciÃ³n','Confirming','PagarÃ©'],
  tipos_cliente:['Particular','Empresa','Promotora','AdministraciÃ³n','Otros'],
  tipos_proveedor:['Proveedor','Subcontrata','Alquiler','Servicio','Transporte','Otros'],
  estancias:['SalÃ³n','Cocina','Dormitorio','BaÃ±o','Terraza','Despacho','Comedor','Pasillo','Entrada','Otros'],
  categorias_tarifario:['Mobiliario','Sanitarios','GriferÃ­as','Cocina','CarpinterÃ­a','Pavimentos','Revestimientos','Instalaciones','Otros'],
};
const LISTA_MAP={'trabajadores-list':'trabajadores','estados-list':'estados_proyecto','tipos-proyecto-list':'tipos_proyecto','formas-pago-list':'formas_pago','tipos-cliente-list':'tipos_cliente','tipos-proveedor-list':'tipos_proveedor','estancias-list':'estancias','categorias-list':'categorias_tarifario'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPULATE SELECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateAllListas(){
  const map={estados_proyecto:['p-estado'],tipos_proyecto:['p-tipo'],formas_pago:['c-pago','pv-pago','f-pago'],tipos_cliente:['c-tipo'],tipos_proveedor:['pv-tipo'],estancias:['i-estancia'],categorias_tarifario:['t-cat']};
  Object.entries(map).forEach(([key,ids])=>{
    const vals=LISTAS[key]||[];
    ids.forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionarâ€¦</option>'+vals.map(v=>`<option value="${v}">${v}</option>`).join('');if(cur&&vals.includes(cur))el.value=cur;});
  });
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTRO POR CLIENTE EN PROYECTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


function filtrarProyectosPorCliente(){
  const sel=document.getElementById('filter-cliente-proyectos');
  const clienteId=sel?sel.value:'';
  const tbody=document.getElementById('proyectos-tbody');
  if(!tbody)return;
  const rows=tbody.querySelectorAll('tr');
  let visible=0;
  rows.forEach(tr=>{
    const ds=tr.dataset.search||'';
    // cliente_id is 3rd part of data-search: proyecto_id+nombre+cliente_id+tipo+estado
    const show=!clienteId||ds.includes(clienteId.toLowerCase());
    tr.style.display=show?'':'none';
    if(show)visible++;
  });
  // Update count
  const count=document.getElementById('proyectos-count');
  if(count){
    const clienteNombre=clienteId
      ?(CC.find(c=>c.cliente_id===clienteId)||{}).nombre||clienteId
      :'';
    count.textContent=clienteId
      ?`${visible} proyecto${visible!==1?'s':''} Â· ${clienteNombre}`
      :`${rows.length} proyectos`;
  }
  // Auto-set cliente in new proyecto modal
  if(clienteId){
    const f=document.getElementById('p-cliente');
    if(f)f.value=clienteId;
  }
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERIORISMO: CASCADA + EDICIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cascadaModuloInt(){
  const clienteSel = document.getElementById('filter-cliente-interiorismo');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('filter-proyecto-interiorismo');
  if(!proySel) return;
  const filtrados  = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">ğŸ“ Proyectoâ€¦</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  filtrarInteriorismo();
}

function filtrarInteriorismo(){
  const proySel = document.getElementById('filter-proyecto-interiorismo');
  const proyId  = proySel ? proySel.value : '';
  const tbody   = document.getElementById('interiorismo-tbody');
  if(!tbody) return;
  const count   = document.getElementById('interiorismo-count');

  if(!proyId){
    tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">ğŸ›‹</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">Los artÃ­culos aparecerÃ¡n aquÃ­ una vez seleccionado el proyecto</div>
    </td></tr>`;
    if(count) count.textContent='â€”';
    return;
  }
  // Auto-set proyecto en modal
  const iProy = document.getElementById('i-proyecto');
  if(iProy) iProy.value = proyId;

  const rows = tbody.querySelectorAll('tr[data-search]');
  let visible = 0;
  rows.forEach(tr=>{
    const show = tr.dataset.search?.includes(proyId.toLowerCase());
    tr.style.display = show ? '' : 'none';
    if(show) visible++;
  });
  if(visible===0 && rows.length>0){
    if(!tbody.querySelector('#int-empty-state')){
      const tr=document.createElement('tr'); tr.id='int-empty-state';
      tr.innerHTML=`<td colspan="10" style="text-align:center;padding:30px;color:var(--text-soft)">
        <div style="font-size:24px;margin-bottom:6px">ğŸ“‹</div>
        <div>Sin artÃ­culos para <strong>${proyId}</strong></div>
      </td>`;
      tbody.appendChild(tr);
    }
  } else {
    const empty = tbody.querySelector('#int-empty-state');
    if(empty) empty.remove();
  }
  if(count) count.textContent=`${visible} artÃ­culo${visible!==1?'s':''} Â· ${proyId}`;
}

function editInteriorismo(id){
  const item = IntC.find(x=>String(x.id)===String(id)); if(!item) return;
  const set = (elId, val) => { const el=document.getElementById(elId); if(el) el.value=val||''; };
  document.getElementById('i-id').value = item.id;
  set('i-proyecto',   item.proyecto_id);
  set('i-estancia',   item.estancia);
  set('i-ref',        item.ref_catalogo);
  set('i-desc',       item.descripcion);
  set('i-marca',      item.marca);
  set('i-acabado',    item.acabado);
  set('i-cant',       item.cantidad);
  set('i-pvp',        item.pvp_catalogo);
  set('i-dto',        item.dto_cliente_pct);
  set('i-coste',      item.coste_neto);
  set('i-iva',        item.iva_pct||'21%');
  set('i-eprop',      item.estado_propuesta);
  set('i-eped',       item.estado_pedido);
  set('i-fentrega',   item.fecha_entrega);
  set('i-notas',      item.notas);
  document.querySelector('#m-interiorismo .modal-title').textContent = 'âœï¸ Editar artÃ­culo';
  openModal('m-interiorismo');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASCADA CLIENTEâ†’PROYECTO PARA DOCUMENTOS
// (pres_final, contrato, pedido_doc)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Generic: filter project selector by client, then call loadFn
function cascadaModulo(mod, proySelId, loadFn){
  const clienteSel = document.getElementById(`filter-cliente-${mod}`);
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById(proySelId);
  if(!proySel) return;
  const cur = proySel.value;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">ğŸ“ Proyectoâ€¦</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  // Restore selection if still valid
  if(cur && filtrados.find(p=>p.proyecto_id===cur)) proySel.value = cur;
  if(loadFn) loadFn();
}

// Doc. Pedido: cliente â†’ filter proyecto â†’ filter pedidos list
function cascadaDocPedido(){
  const clienteSel = document.getElementById('filter-cliente-pedido_doc');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('filter-proyecto-pedido_doc');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">ğŸ“ Proyectoâ€¦</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  // Reset pedido selector and doc
  const pedSel = document.getElementById('pd-pedido-sel');
  if(pedSel) pedSel.innerHTML = '<option value="">â€” Pedidoâ€¦ â€”</option>';
  nuevoPedidoDoc();
}

// Doc. Pedido: proyecto â†’ filter pedidos list
function filtrarPedidosPorProyecto(){
  const proySel  = document.getElementById('filter-proyecto-pedido_doc');
  const proyId   = proySel ? proySel.value : '';
  const pedSel   = document.getElementById('pd-pedido-sel');
  if(!pedSel) return;
  const pedidos = proyId ? PedC.filter(p=>p.proyecto_id===proyId) : PedC;
  pedSel.innerHTML = '<option value="">â€” Pedidoâ€¦ â€”</option>'
    + pedidos.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin nÂº'} Â· ${p.proveedor||'Sin prov.'}</option>`).join('');
  // Reset doc content
  nuevoPedidoDoc();
}

// Poblar selectores de cliente en documentos al init/load
function poblarClientesDocumentos(){
  const ids = ['filter-cliente-pres_final','filter-cliente-contrato','filter-cliente-pedido_doc'];
  ids.forEach(selId=>{
    const sel = document.getElementById(selId);
    if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">ğŸ‘¤ Clienteâ€¦</option>'
      + CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
    if(cur) sel.value = cur;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASCADA CLIENTE â†’ PROYECTO EN MÃ“DULOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MÃ³dulos con cascada clienteâ†’proyecto
const CASCADA_MODS = ['presupuesto','compras','subcontratas','horas','pedidos','interiorismo'];
// Comparativa uses its own cascade function (poblarClientesComparativa)

// Prefijo del campo proyecto en el modal de cada mÃ³dulo
const MOD_PROYECTO_FIELD = {
  presupuesto: 'pres-proyecto-sel',  // special: usa su propio selector
  compras:     'co-proyecto',
  subcontratas:'sc-proyecto',
  horas:       'h-proyecto',
  pedidos:     'ped-proyecto',
};

// Poblar selector de clientes en todos los mÃ³dulos
function poblarFiltrosCliente(){
  // Cascada en mÃ³dulos (compras, horas, etc.) + pÃ¡gina proyectos
  const sels = CASCADA_MODS.map(m=>`filter-cliente-${m}`)
    .concat(['filter-cliente-proyectos']);
  sels.forEach(selId=>{
    const sel=document.getElementById(selId);
    if(!sel)return;
    const cur=sel.value;
    const isProyectos = selId==='filter-cliente-proyectos';
    sel.innerHTML=`<option value="">${isProyectos?'ğŸ‘¤ Todos los clientes':'ğŸ‘¤ Clienteâ€¦'}</option>`
      +CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
}

// Cuando cambia el cliente: filtrar proyectos en cascada
function cascadaClienteProyecto(mod){
  const clienteSel=document.getElementById(`filter-cliente-${mod}`);
  const clienteId=clienteSel?clienteSel.value:'';

  // Filtrar selector de proyectos segÃºn cliente
  const proySel = mod==='presupuesto'
    ? document.getElementById('pres-proyecto-sel')
    : document.getElementById(`filter-proyecto-${mod}`);

  if(proySel){
    const proyectosFiltrados = clienteId
      ? PC.filter(p=>p.cliente_id===clienteId)
      : PC;
    const placeholder = mod==='presupuesto' ? 'ğŸ“ Proyectoâ€¦' : 'ğŸ“ Proyectoâ€¦';
    proySel.innerHTML=`<option value="">${placeholder}</option>`
      +proyectosFiltrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  }

  // Limpiar filtro de proyecto y re-filtrar tabla (excepto presupuesto que carga solo)
  if(mod!=='presupuesto'){
    filtrarModuloPorProyecto(mod);
  }
}

// Poblar todos los filtros proyecto (para init)
function poblarFiltrosProyecto(){
  CASCADA_MODS.filter(m=>m!=='presupuesto').forEach(mod=>{
    const sel=document.getElementById(`filter-proyecto-${mod}`);
    if(!sel)return;
    const cur=sel.value;
    sel.innerHTML='<option value="">ğŸ“ Proyectoâ€¦</option>'
      +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
  // Presupuesto: poblar su propio selector
  const presSel=document.getElementById('pres-proyecto-sel');
  if(presSel){
    const cur=presSel.value;
    presSel.innerHTML='<option value="">ğŸ“ Proyectoâ€¦</option>'
      +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    if(cur)presSel.value=cur;
  }
}

function filtrarModuloPorProyecto(mod){
  const proySel=document.getElementById(`filter-proyecto-${mod}`);
  const proyId=proySel?proySel.value:'';
  const tbody=document.getElementById(`${mod}-tbody`);
  if(!tbody)return;
  const count=document.getElementById(`${mod}-count`);

  // Sin proyecto seleccionado â†’ tabla vacÃ­a con mensaje
  if(!proyId){
    tbody.innerHTML=`<tr id="${mod}-empty-state"><td colspan="20" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">ğŸ“</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">Los registros aparecerÃ¡n aquÃ­ una vez seleccionado el proyecto</div>
    </td></tr>`;
    if(count) count.textContent='â€”';
    return;
  }

  // Con proyecto seleccionado â†’ mostrar solo sus registros
  // Primero restaurar filas ocultas (pueden estar hidden de filtro anterior)
  tbody.querySelectorAll('tr').forEach(tr=>{
    if(tr.id===`${mod}-empty-state`) tr.remove();
  });

  const rows=tbody.querySelectorAll('tr[data-search]');
  let visible=0;
  rows.forEach(tr=>{
    const ds=tr.dataset.search||'';
    const show=ds.includes(proyId.toLowerCase());
    tr.style.display=show?'':'none';
    if(show)visible++;
  });

  // Si no hay registros para este proyecto
  if(visible===0){
    const empty=tbody.querySelector(`#${mod}-empty-state`);
    if(!empty){
      const tr=document.createElement('tr');
      tr.id=`${mod}-empty-state`;
      tr.innerHTML=`<td colspan="20" style="text-align:center;padding:40px;color:var(--text-soft)">
        <div style="font-size:28px;margin-bottom:8px">ğŸ“‹</div>
        <div style="font-size:13px">Sin registros para <strong>${proyId}</strong></div>
      </td>`;
      tbody.appendChild(tr);
    }
  }

  if(count) count.textContent=`${visible} registro${visible!==1?'s':''} Â· ${proyId}`;

  // Auto-set proyecto en modal de nuevo registro
  const fieldId=MOD_PROYECTO_FIELD[mod];
  if(fieldId && fieldId!=='pres-proyecto-sel'){
    const f=document.getElementById(fieldId);
    if(f)f.value=proyId;
  }
}

function populateTrabajadores(){
  const ids=['h-trab','ch-trab-sel','p-resp'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const cur=el.value;
    const placeholder=id==='ch-trab-sel'?'Seleccionar trabajadorâ€¦':'Seleccionarâ€¦';
    el.innerHTML=`<option value="">${placeholder}</option>`+TRABAJADORES.map(t=>`<option value="${t}">${t}</option>`).join('');
    if(cur&&TRABAJADORES.includes(cur))el.value=cur;
  });
}
async function populateSelects(){
  if(!CC.length)CC=await sbGet('clientes').catch(()=>[]);
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!ProvC.length)ProvC=await sbGet('proveedores','?order=nombre.asc').catch(()=>[]);
  ['p-cliente','f-cliente'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionarâ€¦</option>'+CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-proyecto','sc-proyecto','h-proyecto','f-proyecto','i-proyecto','ped-proyecto','pres-proyecto-sel','comp-proyecto-sel','rent-proyecto-sel','cmp-proyecto'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionarâ€¦</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-prov','sc-prov','ped-prov'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar proveedorâ€¦</option>'+ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' Â· '+p.tipo:''}</option>`).join('');if(cur)el.value=cur;});
}
async function populateIntCatalog(){
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  ['i-ref','pl-tarif-sel'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=(id==='i-ref'?'<option value="">â€” descripciÃ³n libre â€”</option>':'<option value="">â€” Seleccionar del tarifario â€”</option>')+TC.map(t=>`<option value="${t.id}">${t.codigo} Â· ${t.descripcion}</option>`).join('');});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GERENCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGerencia(){
  try{
    const [cl,pr,ta,cy,comp,subc,hor,fac]=await Promise.all([
      sbGet('clientes'),sbGet('proyectos'),sbGet('tarifario'),
      sbGet('precios_cype','?select=id'),
      sbGet('compras'),sbGet('subcontratas'),sbGet('horas'),sbGet('facturas')
    ]);
    CC=cl;PC=pr;TC=ta;CoC=comp;ScC=subc;HC=hor;FC=fac;
    document.getElementById('cype-badge').textContent=cy.length;

    // CÃ¡lculos
    const totalVentas=fac.reduce((s,f)=>s+(f.base_imponible||0),0);
    const totalIvaRep=fac.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const totalCompras=comp.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalIvaComp=comp.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const totalSubcs=subc.reduce((s,c)=>s+(c.importe||0),0);
    const totalIvaSub=subc.reduce((s,c)=>s+(c.importe||0)*ivaPct(c.iva_pct)/100,0);
    const totalMO=hor.reduce((s,h)=>s+(h.total||0),0);
    const totalCostes=totalCompras+totalSubcs+totalMO;
    const beneficio=totalVentas-totalCostes;
    const margen=totalVentas>0?(beneficio/totalVentas)*100:0;

    // KPIs top
    document.getElementById('g-ventas').textContent=fmt(totalVentas);
    document.getElementById('g-costes').textContent=fmt(totalCostes);
    document.getElementById('g-benef').textContent=fmt(beneficio);
    document.getElementById('g-benef').style.color=beneficio>=0?'var(--green)':'var(--red)';
    document.getElementById('g-margen').textContent=fmtP(margen);

    // Resumen econÃ³mico
    const pv=totalVentas>0;
    document.getElementById('ge-ventas').textContent=fmt(totalVentas);
    document.getElementById('ge-iva-rep').textContent=fmt(totalIvaRep);
    document.getElementById('ge-compras').textContent=fmt(totalCompras);
    document.getElementById('ge-compras-pct').textContent=pv?fmtP(totalCompras/totalVentas*100):'â€”';
    document.getElementById('ge-subcs').textContent=fmt(totalSubcs);
    document.getElementById('ge-subcs-pct').textContent=pv?fmtP(totalSubcs/totalVentas*100):'â€”';
    document.getElementById('ge-mo').textContent=fmt(totalMO);
    document.getElementById('ge-mo-pct').textContent=pv?fmtP(totalMO/totalVentas*100):'â€”';
    document.getElementById('ge-costes-tot').textContent=fmt(totalCostes);
    document.getElementById('ge-costes-pct').textContent=pv?fmtP(totalCostes/totalVentas*100):'â€”';
    document.getElementById('ge-beneficio').textContent=fmt(beneficio);
    document.getElementById('ge-benef-pct').textContent=pv?fmtP(margen):'â€”';
    const rr=document.getElementById('ge-result-row');
    rr.className='cuenta-row result'+(beneficio<0?' neg':'');

    // Proyectos por estado
    const estados=['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuciÃ³n','Finalizado','Facturado','Cobrado','Cancelado'];
    const counts={};estados.forEach(e=>counts[e]=0);
    pr.forEach(p=>counts[p.estado]=(counts[p.estado]||0)+1);
    document.getElementById('g-estados').innerHTML=
      Object.entries(counts).filter(([,v])=>v>0).map(([k,v])=>
        `<div class="cuenta-row"><span>${bE(k)} ${k}</span><span style="font-weight:700">${v}</span><span></span></div>`
      ).join('')+`<div class="cuenta-row total"><span>TOTAL PROYECTOS</span><span style="font-weight:700">${pr.length}</span><span></span></div>`;

    // Cobros
    const cobrado=fac.filter(f=>f.estado==='Cobrada').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const totalFactIVA=fac.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const vencidas=fac.filter(f=>f.estado==='Vencida').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('gc-facturado').textContent=fmt(totalFactIVA);
    document.getElementById('gc-cobrado').textContent=fmt(cobrado);
    document.getElementById('gc-pendiente').textContent=fmt(totalFactIVA-cobrado);
    document.getElementById('gc-vencidas').textContent=fmt(vencidas);

    // Pagos
    const pagadoProv=comp.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.base_imponible||0),0);
    const pagadoSub=subc.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.importe||0),0);
    document.getElementById('gp-compras').textContent=fmt(totalCompras);
    document.getElementById('gp-pagado-prov').textContent=fmt(pagadoProv);
    document.getElementById('gp-pdte-prov').textContent=fmt(totalCompras-pagadoProv);
    document.getElementById('gp-subcs').textContent=fmt(totalSubcs);
    document.getElementById('gp-pdte-sub').textContent=fmt(totalSubcs-pagadoSub);

    // Horas
    const totH=hor.reduce((s,h)=>s+(h.horas||0),0);
    document.getElementById('gh-horas').textContent=totH.toFixed(1)+'h';
    document.getElementById('gh-coste').textContent=fmt(totalMO);
    document.getElementById('gh-medio').textContent=totH>0?fmt(totalMO/totH).replace('â‚¬','')+' â‚¬/h':'â€”';

    // IVA
    document.getElementById('gi-rep').textContent=fmt(totalIvaRep);
    document.getElementById('gi-comp').textContent=fmt(totalIvaComp);
    document.getElementById('gi-sub').textContent=fmt(totalIvaSub);
    document.getElementById('gi-neto').textContent=fmt(totalIvaRep-totalIvaComp-totalIvaSub);

    // Rentabilidad por proyecto
    const compByProy={},subByProy={},horByProy={},facByProy={};
    comp.forEach(c=>{compByProy[c.proyecto_id]=(compByProy[c.proyecto_id]||0)+(c.base_imponible||0);});
    subc.forEach(c=>{subByProy[c.proyecto_id]=(subByProy[c.proyecto_id]||0)+(c.importe||0);});
    hor.forEach(h=>{horByProy[h.proyecto_id]=(horByProy[h.proyecto_id]||0)+(h.total||0);});
    fac.forEach(f=>{facByProy[f.proyecto_id]=(facByProy[f.proyecto_id]||0)+(f.base_imponible||0);});

    const tbody=document.getElementById('g-rent-table');
    if(!pr.length){tbody.innerHTML='<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">Sin proyectos</div></div></td></tr>';return;}
    tbody.innerHTML=pr.map(p=>{
      const v=facByProy[p.proyecto_id]||0,cc=compByProy[p.proyecto_id]||0,sc=subByProy[p.proyecto_id]||0,mo=horByProy[p.proyecto_id]||0;
      const tot=cc+sc+mo,ben=v-tot,mg=v>0?(ben/v)*100:0;
      return`<tr><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id}</td><td><strong>${p.nombre}</strong></td><td>${bE(p.estado)}</td><td class="td-mono">${fmt(v)}</td><td class="td-mono">${fmt(cc)}</td><td class="td-mono">${fmt(sc)}</td><td class="td-mono">${fmt(mo)}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td class="td-mono" style="${ben>=0?'color:var(--green)':'color:var(--red)'}">${fmt(ben)}</td><td class="td-mono" style="${mg>=15?'color:var(--green)':mg>=0?'color:var(--amber)':'color:var(--red)'}">${fmtP(mg)}</td></tr>`;
    }).join('');

    const s=document.getElementById('conn-status');s.style.background='var(--green-soft)';s.style.color='var(--green)';s.textContent='ğŸŸ¢ Conectado';
    populateSelects();populateIntCatalog();populateTrabajadores();poblarFiltrosProyecto();poblarFiltrosCliente();poblarClientesComparativa();
  }catch(e){
    console.error(e);
    const s=document.getElementById('conn-status');s.style.background='var(--red-soft)';s.style.color='var(--red)';s.textContent='ğŸ”´ Error';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadClientes(){
  const tb=document.getElementById('clientes-tbody');
  try{
    CC=await sbGet('clientes','?order=created_at.desc');
    document.getElementById('clientes-count').textContent=CC.length+' clientes';
    if(!CC.length){tb.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ¤</div><div class="empty-text">Sin clientes</div><button class="btn btn-primary" onclick="openModal('m-cliente')">ï¼‹ Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=CC.map(c=>`<tr data-search="${(c.nombre+c.cif+c.email+c.tipo).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${c.cliente_id||'â€”'}</td><td><strong>${c.nombre}</strong></td><td class="td-mono">${c.cif||'â€”'}</td><td>${c.telefono||'â€”'}</td><td style="color:var(--navy-mid)">${c.email||'â€”'}</td><td>${bE(c.tipo)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editCliente('${c.id}')">âœï¸</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('clientes','${c.id}','${c.nombre.replace(/'/g,"\\'")}')">ğŸ—‘</button></div></td></tr>`).join('');
    populateSelects();
  }catch(e){tb.innerHTML=`<tr><td colspan="7" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editCliente(id){const c=CC.find(x=>x.id===id);if(!c)return;document.getElementById('m-cliente-title').textContent='Editar cliente';['c-id','c-nombre','c-cif','c-tel','c-email','c-dir','c-notas'].forEach((f,i)=>{document.getElementById(f).value=[c.id,c.nombre,c.cif,c.telefono,c.email,c.direccion,c.notas][i]||'';});document.getElementById('c-tipo').value=c.tipo||'Particular';document.getElementById('c-pago').value=c.forma_pago||'Transferencia';openModal('m-cliente');}
async function saveCliente(){
  const nombre=document.getElementById('c-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('c-id').value;
  const d={nombre,cif:document.getElementById('c-cif').value,telefono:document.getElementById('c-tel').value,email:document.getElementById('c-email').value,direccion:document.getElementById('c-dir').value,tipo:document.getElementById('c-tipo').value,forma_pago:document.getElementById('c-pago').value,notas:document.getElementById('c-notas').value};
  try{if(id){await sbPatch('clientes',id,d);toast('Cliente actualizado âœ…');}else{d.cliente_id=genId('CLI',CC,'cliente_id');await sbPost('clientes',d);toast('Cliente guardado âœ…');}closeModal('m-cliente');document.getElementById('c-id').value='';loadClientes();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROYECTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadProyectos(){
  const tb=document.getElementById('proyectos-tbody');
  try{
    PC=await sbGet('proyectos','?order=created_at.desc');
    document.getElementById('proyectos-count').textContent=PC.length+' proyectos';
    if(!PC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">Sin proyectos</div><button class="btn btn-primary" onclick="openModal('m-proyecto')">ï¼‹ Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PC.map(p=>`<tr data-search="${(p.proyecto_id+p.nombre+p.cliente_id+p.tipo+p.estado).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'â€”'}</td><td><strong>${p.nombre}</strong></td><td>${p.cliente_id||'â€”'}</td><td>${bE(p.tipo)}</td><td>${bE(p.estado)}</td><td>${p.responsable||'â€”'}</td><td>${fmtD(p.fecha_inicio)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProyecto('${p.id}')">âœï¸</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proyectos','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">ğŸ—‘</button></div></td></tr>`).join('');
    populateSelects();
    poblarFiltrosCliente();
    filtrarProyectosPorCliente();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editProyecto(id){const p=PC.find(x=>x.id===id);if(!p)return;document.getElementById('m-proyecto-title').textContent='Editar proyecto';document.getElementById('p-id').value=p.id;document.getElementById('p-nombre').value=p.nombre||'';document.getElementById('p-cliente').value=p.cliente_id||'';document.getElementById('p-tipo').value=p.tipo||'Obra nueva';document.getElementById('p-estado').value=p.estado||'Nuevo lead';document.getElementById('p-resp').value=p.responsable||'Jose Asins';document.getElementById('p-fecha').value=p.fecha_inicio||'';document.getElementById('p-dir').value=p.direccion_obra||'';document.getElementById('p-notas').value=p.notas||'';openModal('m-proyecto');}
async function saveProyecto(){
  const nombre=document.getElementById('p-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('p-id').value;
  const d={cliente_id:document.getElementById('p-cliente').value||null,nombre,tipo:document.getElementById('p-tipo').value,estado:document.getElementById('p-estado').value,responsable:document.getElementById('p-resp').value,fecha_inicio:document.getElementById('p-fecha').value||null,direccion_obra:document.getElementById('p-dir').value,notas:document.getElementById('p-notas').value};
  try{if(id){await sbPatch('proyectos',id,d);toast('Proyecto actualizado âœ…');}else{d.proyecto_id=genId('PRY',PC,'proyecto_id');await sbPost('proyectos',d);toast('Proyecto creado âœ…');}closeModal('m-proyecto');document.getElementById('p-id').value='';loadProyectos();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESUPUESTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initPresupuesto(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc').catch(()=>[]);
  populateSelects();populateIntCatalog();
}
async function loadPresupuesto(){
  const proy=document.getElementById('pres-proyecto-sel').value;
  const ver=document.getElementById('pres-version-sel').value;
  const tbody=document.getElementById('pres-tbody');
  document.getElementById('btn-comparativa').style.display=proy?'':'none';
  if(!proy){tbody.innerHTML=`<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">ğŸ“</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">El presupuesto aparecerÃ¡ aquÃ­ una vez seleccionado el proyecto</div>
    </td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  try{
    PresC=await sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`);
    renderPresupuesto();
  }catch(e){tbody.innerHTML=`<tr><td colspan="11" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function renderPresupuesto(){
  const tbody=document.getElementById('pres-tbody');
  if(!PresC.length){tbody.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">Presupuesto vacÃ­o</div><button class="btn btn-ghost" onclick="addCapituloPresupuesto()">ï¼‹ CapÃ­tulo</button></div></td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  let totBase=0,totCI=0,totVenta=0;
  tbody.innerHTML=PresC.map((l,i)=>{
    if(l.es_capitulo)return`<tr style="background:var(--navy);color:#fff"><td colspan="9" style="padding:9px 10px;font-weight:700;font-size:12px">ğŸ“‚ ${l.descripcion}</td><td></td><td><button class="btn btn-icon btn-sm" style="background:rgba(255,255,255,.1);border:none;color:#fff" onclick="confirmDelete('presupuesto_lineas','${l.id}','${l.descripcion.replace(/'/g,"\\'")}')">ğŸ—‘</button></td></tr>`;
    const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv,subCI=ci>0?sub*(1+ci/100):sub;
    totBase+=(l.cantidad||0)*(l.precio_base||0);totCI+=subCI-sub;totVenta+=subCI;
    return`<tr data-search="${(l.descripcion||'').toLowerCase()}"><td style="color:var(--text-soft);font-size:11px">${i+1}</td><td><strong>${l.descripcion||'â€”'}</strong>${l.ref_cype?`<br><span style="font-size:9px;color:var(--text-soft)">${l.ref_cype}</span>`:''}</td><td style="text-align:center">${l.unidad||'â€”'}</td><td class="td-mono">${l.cantidad||0}</td><td class="td-mono">${fmt(l.precio_base)}</td><td class="td-mono" style="color:var(--green)">${l.margen_pct>0?fmtP(l.margen_pct):'â€”'}</td><td class="td-mono" style="color:var(--amber)">${ci>0?fmtP(ci):'â€”'}</td><td class="td-mono" style="font-weight:700">${fmt(pv)}</td><td class="td-mono" style="font-weight:700;color:var(--navy)">${fmt(subCI)}</td><td><span class="badge b-gray">${l.iva_pct||'10%'}</span></td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editLineaPresupuesto('${l.id}')">âœï¸</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('presupuesto_lineas','${l.id}','${(l.descripcion||'').replace(/'/g,"\\'")}')">ğŸ—‘</button></div></td></tr>`;
  }).join('');
  const iva=totVenta*0.10;
  document.getElementById('pres-k-base').textContent=fmt(totBase);document.getElementById('pres-k-ci').textContent=fmt(totCI);document.getElementById('pres-k-total').textContent=fmt(totVenta);document.getElementById('pres-k-iva').textContent=fmt(totVenta+iva);
  document.getElementById('pres-total-lbl').textContent=`TOTAL c/IVA: ${fmt(totVenta+iva)}`;
  document.getElementById('pres-resumen').style.display='block';
}
function calcLineaPres(){const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);const sub=cant*pv;document.getElementById('pl-pventa').value=pv>0?pv.toFixed(2)+' â‚¬':'â€”';document.getElementById('pl-subtotal').value=sub>0?sub.toFixed(2)+' â‚¬':'â€”';}
function searchCypeLinea(){const q=document.getElementById('pl-cype-search').value.toLowerCase(),res=document.getElementById('pl-cype-results');if(q.length<2){res.style.display='none';return;}const matches=CyCache.filter(c=>c.codigo.toLowerCase().includes(q)||c.descripcion.toLowerCase().includes(q)).slice(0,8);if(!matches.length){res.style.display='none';return;}res.style.display='block';res.innerHTML=matches.map(c=>`<div onclick="selectCype('${c.id}')" style="padding:7px 11px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--blue-light)'" onmouseout="this.style.background=''"><strong style="color:var(--navy-mid)">${c.codigo}</strong> Â· ${c.descripcion} <span style="float:right;color:var(--green);font-weight:700">${fmt(c.precio)}/${c.unidad}</span></div>`).join('');}
function selectCype(id){const c=CyCache.find(x=>x.id===id);if(!c)return;document.getElementById('pl-desc').value=c.descripcion;document.getElementById('pl-precio').value=c.precio;document.getElementById('pl-ud').value=c.unidad||'mÂ²';document.getElementById('pl-cype-search').value=`${c.codigo} Â· ${c.descripcion}`;document.getElementById('pl-cype-search').dataset.cypeRef=c.codigo;document.getElementById('pl-cype-results').style.display='none';calcLineaPres();}
function loadTarifLinea(){const id=document.getElementById('pl-tarif-sel').value;if(!id)return;const t=TC.find(x=>x.id===id);if(!t)return;document.getElementById('pl-desc').value=t.descripcion;document.getElementById('pl-precio').value=t.precio_coste||0;document.getElementById('pl-margen').value=t.margen_pct||0;document.getElementById('pl-ud').value=t.unidad||'Ud';calcLineaPres();}
function addLineaPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('m-pres-title').textContent='Nueva lÃ­nea';['pl-id','pl-desc','pl-precio','pl-pventa','pl-subtotal','pl-partida'].forEach(id=>document.getElementById(id).value='');document.getElementById('pl-margen').value='0';document.getElementById('pl-ci').value='0';document.getElementById('pl-cant').value='1';document.getElementById('pl-cype-search').value='';document.getElementById('pl-cype-search').dataset.cypeRef='';document.getElementById('pl-cype-results').style.display='none';document.getElementById('pl-tarif-sel').value='';openModal('m-pres-linea');}
function editLineaPresupuesto(id){const l=PresC.find(x=>x.id===id);if(!l)return;document.getElementById('m-pres-title').textContent='Editar lÃ­nea';document.getElementById('pl-id').value=l.id;document.getElementById('pl-desc').value=l.descripcion||'';document.getElementById('pl-precio').value=l.precio_base||0;document.getElementById('pl-margen').value=l.margen_pct||0;document.getElementById('pl-ci').value=l.ci_gg_bi_pct||0;document.getElementById('pl-cant').value=l.cantidad||1;document.getElementById('pl-ud').value=l.unidad||'mÂ²';document.getElementById('pl-iva').value=l.iva_pct||'10%';document.getElementById('pl-partida').value=l.partida||'';document.getElementById('pl-cype-search').value=l.ref_cype||'';document.getElementById('pl-cype-search').dataset.cypeRef=l.ref_cype||'';document.getElementById('pl-cype-results').style.display='none';calcLineaPres();openModal('m-pres-linea');}
async function saveLineaPresupuesto(){
  const desc=document.getElementById('pl-desc').value.trim();if(!desc){toast('La descripciÃ³n es obligatoria','error');return;}
  const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;
  const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;
  let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);
  const id=document.getElementById('pl-id').value;
  const d={proyecto_id:proy,version:ver,descripcion:desc,ref_cype:document.getElementById('pl-cype-search').dataset.cypeRef||null,unidad:document.getElementById('pl-ud').value,cantidad:cant,precio_base:precio,margen_pct:margen,ci_gg_bi_pct:ci,precio_venta:parseFloat(pv.toFixed(4)),subtotal:parseFloat((cant*pv).toFixed(4)),iva_pct:document.getElementById('pl-iva').value,partida:document.getElementById('pl-partida').value,es_capitulo:false,orden:PresC.length+1};
  try{if(id){await sbPatch('presupuesto_lineas',id,d);toast('LÃ­nea actualizada âœ…');}else{await sbPost('presupuesto_lineas',d);toast('LÃ­nea aÃ±adida âœ…');}closeModal('m-pres-linea');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}
function addCapituloPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('cap-nombre').value='';openModal('m-pres-cap');}
async function saveCapitulo(){const nombre=document.getElementById('cap-nombre').value.trim();if(!nombre){toast('Escribe el nombre','error');return;}const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;try{await sbPost('presupuesto_lineas',{proyecto_id:proy,version:ver,descripcion:nombre,es_capitulo:true,orden:PresC.length+1,cantidad:0,precio_base:0,precio_venta:0,subtotal:0});toast('CapÃ­tulo aÃ±adido âœ…');closeModal('m-pres-cap');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPARATIVA OFERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcOferta(n){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value || 'pvp';
  let coste=0, venta=0;
  if(modo==='pvp'){
    // PVP catÃ¡logo = precio que el proveedor nos cobra "sin descuento"
    // Coste para nosotros = PVP * (1 - descuento%) â†’ lo que pagamos al proveedor
    // Precio de venta al cliente = PVP (precio catÃ¡logo sin descuento)
    // Margen = PVP - coste = el descuento que nos da el proveedor = nuestro beneficio
    const pvp = parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
    const dto = parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
    coste = pvp*(1-dto/100);
    venta = pvp; // vendemos al cliente al precio de catÃ¡logo
  } else {
    // Modo coste: sabemos lo que nos cuesta y aplicamos nuestro margen de venta
    coste = parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
    const mk = parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
    venta = coste>0 && mk<100 ? coste/(1-mk/100) : coste;
  }
  const margenE = venta - coste;
  const margenPct = venta>0 ? (margenE/venta)*100 : 0;
  const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
  set(`o${n}-res-coste`, coste>0 ? fmt(coste) : 'â€”');
  set(`o${n}-res-venta`, venta>0 ? fmt(venta) : 'â€”');
  set(`o${n}-res-margen`, margenE>0 ? fmt(margenE) : 'â€”');
  const pctEl = document.getElementById(`o${n}-res-pct`);
  if(pctEl){
    pctEl.textContent = margenPct>0 ? fmtP(margenPct) : 'â€”';
    pctEl.style.color = margenPct>=20?'var(--green)':margenPct>=10?'var(--amber)':'var(--red)';
  }
  // Highlight mejor oferta
  destacarMejorOferta();
}

function cambiarModoComparativa(){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value || 'pvp';
  [1,2,3].forEach(n=>{
    const pvpDiv   = document.getElementById(`o${n}-modo-pvp`);
    const costeDiv = document.getElementById(`o${n}-modo-coste`);
    if(pvpDiv)   pvpDiv.style.display   = modo==='pvp'   ? '' : 'none';
    if(costeDiv) costeDiv.style.display = modo==='coste' ? '' : 'none';
    calcOferta(n);
  });
}

function destacarMejorOferta(){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
  let mejorPrecio=null, menorCoste=Infinity;
  let mejorMargen=null, mayorMargenPct=-Infinity;

  [1,2,3].forEach(n=>{
    let coste=0, venta=0, margenPct=0;
    if(modo==='pvp'){
      const pvp=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      coste=pvp*(1-dto/100);
      venta=pvp;
    } else {
      coste=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      venta=coste>0&&mk<100?coste/(1-mk/100):coste;
    }
    margenPct = venta>0 ? ((venta-coste)/venta)*100 : 0;

    // Reset border
    const col=document.getElementById(`cmp-col-${n}`);
    if(col){ col.style.borderColor='var(--border)'; col.style.borderWidth='1px'; }

    if(coste>0 && coste<menorCoste){ menorCoste=coste; mejorPrecio=n; }
    if(margenPct>0 && margenPct>mayorMargenPct){ mayorMargenPct=margenPct; mejorMargen=n; }
  });

  // Marcar mejor precio (borde verde)
  if(mejorPrecio){
    const col=document.getElementById(`cmp-col-${mejorPrecio}`);
    if(col){ col.style.borderColor='var(--green)'; col.style.borderWidth='2px'; }
  }
  // Marcar mejor margen (borde cobre/naranja) - puede coincidir con mejor precio
  if(mejorMargen && mejorMargen!==mejorPrecio){
    const col=document.getElementById(`cmp-col-${mejorMargen}`);
    if(col){ col.style.borderColor='var(--copper)'; col.style.borderWidth='2px'; }
  }

  // Actualizar info
  const info=document.getElementById('cmp-ganadora-info');
  if(info){
    let txt='';
    if(mejorPrecio) txt+=`<span style="color:var(--green)">ğŸ’° Oferta ${mejorPrecio} menor coste (${fmt(menorCoste)})</span>`;
    if(mejorMargen && mejorMargen!==mejorPrecio)
      txt+=`<span style="color:var(--copper);margin-left:12px">ğŸ“ˆ Oferta ${mejorMargen} mayor margen (${mayorMargenPct.toFixed(1)}%)</span>`;
    else if(mejorMargen && mejorMargen===mejorPrecio)
      txt+=`<span style="color:var(--green);margin-left:8px">Â· ${mayorMargenPct.toFixed(1)}% margen</span>`;
    info.innerHTML=txt;
  }

  // Auto-seleccionar mejor precio en el desplegable
  const sel=document.getElementById('cmp-elegida');
  if(sel && mejorPrecio) sel.value=String(mejorPrecio);

  // Actualizar panel resumen
  const resPrecio=document.getElementById('cmp-res-precio');
  const resMargen=document.getElementById('cmp-res-margen');
  const resDiff  =document.getElementById('cmp-res-diff');
  const resPanel =document.getElementById('cmp-resumen');

  // Recoger todos los costes y mÃ¡rgenes para calcular diferencia
  const costes=[]; const margenes=[];
  [1,2,3].forEach(n=>{
    const modo2=document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
    let c=0,v=0;
    if(modo2==='pvp'){
      const pvp2=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto2=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      c=pvp2*(1-dto2/100); v=pvp2;
    } else {
      c=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk2=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      v=c>0&&mk2<100?c/(1-mk2/100):c;
    }
    if(c>0){ costes.push(c); margenes.push(v>0?((v-c)/v)*100:0); }
  });

  if(costes.length>=2){
    const minC=Math.min(...costes), maxC=Math.max(...costes);
    const maxM=Math.max(...margenes);
    if(resPrecio) resPrecio.textContent=`Oferta ${mejorPrecio} Â· ${fmt(minC)}`;
    if(resMargen) resMargen.textContent=`Oferta ${mejorMargen} Â· ${maxM.toFixed(1)}%`;
    if(resDiff)   resDiff.textContent  =`${fmt(maxC-minC)} (${(((maxC-minC)/minC)*100).toFixed(1)}%)`;
    if(resPanel)  resPanel.style.display='grid';
  } else {
    if(resPanel) resPanel.style.display='none';
  }
}

function cascadaClienteModalCmp(){
  const clienteId = document.getElementById('cmp-cliente')?.value;
  const proySel   = document.getElementById('cmp-proyecto');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML='<option value="">Seleccionarâ€¦</option>'
    +filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  if(clienteId && filtrados.length===1) proySel.value=filtrados[0].proyecto_id;
}

function poblarClientesModalCmp(){
  const sel=document.getElementById('cmp-cliente');
  if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">Seleccionarâ€¦</option>'
    +CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
  if(cur)sel.value=cur;
}

function poblarProveedoresComparativa(){
  [1,2,3].forEach(n=>{
    const sel=document.getElementById(`o${n}-prov`);
    if(!sel)return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Seleccionarâ€¦</option>'
      +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
}
async function initComparativa(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!CC.length)CC=await sbGet('clientes').catch(()=>[]);
  populateSelects();
  poblarClientesComparativa();
}
async function loadComparativa(){
  const proy=document.getElementById('comp-proyecto-sel').value;
  const el=document.getElementById('comp-list');
  if(!proy){el.innerHTML='<div class="empty"><div class="empty-icon">âš–ï¸</div><div class="empty-text">Selecciona un proyecto</div></div>';return;}
  try{
    CmpC=await sbGet('comparativa_ofertas',`?proyecto_id=eq.${proy}&order=created_at.desc`);
    if(!CmpC.length){el.innerHTML=`<div class="empty"><div class="empty-icon">âš–ï¸</div><div class="empty-text">Sin comparativas para este proyecto</div><button class="btn btn-primary" onclick="openModal('m-comparativa')">ï¼‹ Nueva comparativa</button></div>`;return;}
    el.innerHTML=CmpC.map(c=>{
      const ofertas=[1,2,3].map(n=>{const prov=c[`o${n}_proveedor`],final=c[`o${n}_precio_final`];return prov?`<div class="oferta-col${c.oferta_elegida==n?' ganadora':''}"><div class="oferta-title">OFERTA ${n}</div><div style="font-weight:700;margin-bottom:4px">${prov}</div><div style="font-size:12px;color:var(--text-soft)">PVP: ${fmt(c[`o${n}_pvp`])} Â· Dto: ${c[`o${n}_dto`]||0}% Â· Mk: ${c[`o${n}_markup`]||0}%</div><div style="font-size:14px;font-weight:700;margin-top:6px;color:var(--navy)">${fmt(final)}</div>${c[`o${n}_notas`]?`<div style="font-size:11px;color:var(--text-soft);margin-top:4px">${c[`o${n}_notas`]}</div>`:''}</div>`:'<div class="oferta-col" style="opacity:.3"><div class="oferta-title">OFERTA '+n+'</div><div style="font-size:12px;color:var(--text-soft)">Sin datos</div></div>';}).join('');
      return`<div class="card"><div class="card-header"><div class="card-title">âš–ï¸ ${c.trabajo}</div><button class="btn btn-danger btn-sm" onclick="confirmDelete('comparativa_ofertas','${c.id}','${c.trabajo.replace(/'/g,"\\'")}')">ğŸ—‘</button></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">${ofertas}</div></div></div>`;
    }).join('');
  }catch(e){el.innerHTML=`<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`;}
}
async function saveComparativa(){
  const proy=document.getElementById('cmp-proyecto').value,trabajo=document.getElementById('cmp-trabajo').value.trim();
  if(!proy||!trabajo){toast('Proyecto y trabajo son obligatorios','error');return;}
  const d={proyecto_id:proy,trabajo};
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
  d.modo_calculo = modo;
  [1,2,3].forEach(n=>{
    d[`o${n}_proveedor`] = document.getElementById(`o${n}-prov`)?.value||'';
    d[`o${n}_notas`]     = document.getElementById(`o${n}-notas`)?.value||'';
    if(modo==='pvp'){
      const pvp=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      d[`o${n}_pvp`]=pvp; d[`o${n}_dto`]=dto; d[`o${n}_markup`]=0;
      d[`o${n}_coste`]=pvp*(1-dto/100);
      d[`o${n}_precio_final`]=pvp; // precio de venta al cliente = PVP catÃ¡logo
    } else {
      const coste=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      d[`o${n}_pvp`]=0; d[`o${n}_dto`]=0; d[`o${n}_markup`]=mk;
      d[`o${n}_coste`]=coste;
      d[`o${n}_precio_final`]=coste>0?coste/(1-mk/100):0;
    }
  });
  d.oferta_elegida=parseInt(document.getElementById('cmp-elegida').value)||1;
  try{await sbPost('comparativa_ofertas',d);toast('Comparativa guardada âœ…');closeModal('m-comparativa');loadComparativa();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TARIFARIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTarifario(){
  const tb=document.getElementById('tarifario-tbody');
  try{
    TC=await sbGet('tarifario','?order=created_at.desc');
    document.getElementById('tarifario-count').textContent=TC.length+' artÃ­culos';
    if(!TC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Tarifario vacÃ­o</div><button class="btn btn-primary" onclick="openModal('m-tarifario')">ï¼‹ Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=TC.map(t=>`<tr data-search="${(t.codigo+t.descripcion+t.categoria+t.marca).toLowerCase()}"><td class="td-mono" style="color:var(--navy-mid);font-weight:700">${t.codigo}</td><td>${t.descripcion}</td><td style="text-align:center">${t.unidad||'Ud'}</td><td class="td-mono">${fmt(t.precio_coste)}</td><td class="td-mono" style="color:var(--green)">${fmtP(t.margen_pct)}</td><td class="td-mono" style="font-weight:700">${fmt(t.precio_venta)}</td><td>${t.categoria?`<span class="badge b-copper">${t.categoria}</span>`:'â€”'}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editTarifario('${t.id}')">âœï¸</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('tarifario','${t.id}','${t.descripcion.replace(/'/g,"\\'")}')">ğŸ—‘</button></div></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function calcPrecioVenta(){const c=parseFloat(document.getElementById('t-coste').value)||0,m=parseFloat(document.getElementById('t-margen').value)||0,pv=m<100?c/(1-m/100):0;document.getElementById('t-pventa').value=pv>0?pv.toFixed(2)+' â‚¬':'â€”';}
function editTarifario(id){const t=TC.find(x=>x.id===id);if(!t)return;document.getElementById('m-tarif-title').textContent='Editar artÃ­culo';document.getElementById('t-id').value=t.id;document.getElementById('t-codigo').value=t.codigo||'';document.getElementById('t-desc').value=t.descripcion||'';document.getElementById('t-unidad').value=t.unidad||'Ud';document.getElementById('t-coste').value=t.precio_coste||0;document.getElementById('t-margen').value=t.margen_pct||30;document.getElementById('t-cat').value=t.categoria||'Mobiliario';document.getElementById('t-marca').value=t.marca||'';document.getElementById('t-notas').value=t.notas||'';calcPrecioVenta();openModal('m-tarifario');}
async function saveTarifario(){const codigo=document.getElementById('t-codigo').value.trim(),desc=document.getElementById('t-desc').value.trim();if(!codigo||!desc){toast('CÃ³digo y descripciÃ³n obligatorios','error');return;}const id=document.getElementById('t-id').value;const d={codigo,descripcion:desc,unidad:document.getElementById('t-unidad').value,precio_coste:parseFloat(document.getElementById('t-coste').value)||0,margen_pct:parseFloat(document.getElementById('t-margen').value)||30,categoria:document.getElementById('t-cat').value,marca:document.getElementById('t-marca').value,notas:document.getElementById('t-notas').value};try{if(id){await sbPatch('tarifario',id,d);toast('ArtÃ­culo actualizado âœ…');}else{await sbPost('tarifario',d);toast('ArtÃ­culo aÃ±adido âœ…');}closeModal('m-tarifario');document.getElementById('t-id').value='';loadTarifario();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CYPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCype(){
  const tb=document.getElementById('cype-tbody');
  try{
    if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc');
    if(!CyCache.length){tb.innerHTML=`<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-text">Ejecuta el SQL de datos reales</div></div></td></tr>`;return;}
    const caps=[...new Set(CyCache.map(c=>c.capitulo).filter(Boolean))].sort();
    const sel=document.getElementById('filter-cype-cap');sel.innerHTML='<option value="">Todos los capÃ­tulos</option>'+caps.map(c=>`<option>${c}</option>`).join('');
    tb.innerHTML=CyCache.map(c=>`<tr data-search="${(c.codigo+c.descripcion+c.capitulo).toLowerCase()}" data-cap="${c.capitulo||''}"><td class="td-mono" style="color:var(--navy-mid);font-weight:700">${c.codigo}</td><td>${c.descripcion}</td><td style="text-align:center">${c.unidad||'â€”'}</td><td class="td-mono" style="font-weight:700">${fmt(c.precio)}</td><td><span class="badge b-gray" style="font-size:9px">${c.capitulo||'â€”'}</span></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="5" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function filterCype(){const q=document.getElementById('search-cype').value.toLowerCase(),cap=document.getElementById('filter-cype-cap').value;document.querySelectorAll('#cype-tbody tr[data-search]').forEach(r=>{r.style.display=(r.dataset.search.includes(q)&&(!cap||r.dataset.cap===cap))?'':'none';});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERIORISMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadInteriorismo(){
  const tb=document.getElementById('interiorismo-tbody');
  try{
    IntC=await sbGet('interiorismo_lineas','?order=created_at.desc');
    document.getElementById('interiorismo-count').textContent=IntC.length+' lÃ­neas';
    if(!IntC.length){tb.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ›‹</div><div class="empty-text">Sin propuestas</div><button class="btn btn-copper" onclick="openModal('m-interiorismo')">ï¼‹ AÃ±adir</button></div></td></tr>`;return;}
    tb.innerHTML=IntC.map(i=>`<tr data-search="${(i.proyecto_id+i.estancia+i.descripcion+i.marca).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${i.proyecto_id||'â€”'}</td><td>${i.estancia?`<span class="badge b-gray">${i.estancia}</span>`:'â€”'}</td><td class="td-mono">${i.ref_catalogo||'â€”'}</td><td>${i.descripcion||'â€”'}</td><td>${i.cantidad||1}</td><td class="td-mono" style="font-weight:700">${fmt(i.pvp_neto)}</td><td class="td-mono" style="color:var(--green)">${i.coste_neto&&i.pvp_neto?fmtP((i.pvp_neto-i.coste_neto)/i.pvp_neto*100):'â€”'}</td><td>${bE(i.estado_propuesta)}</td><td>${bE(i.estado_pedido)}</td><td style="display:flex;gap:3px"><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="editInteriorismo('${i.id}')">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('interiorismo_lineas','${i.id}','${(i.descripcion||'artÃ­culo').replace(/'/g,"\\'")}')">ğŸ—‘</button></td></tr>`).join('');
  filtrarInteriorismo();
  }catch(e){tb.innerHTML=`<tr><td colspan="10" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function loadTarifarioItem(){const ref=document.getElementById('i-ref').value;if(!ref)return;const item=TC.find(t=>t.id===ref);if(!item)return;document.getElementById('i-desc').value=item.descripcion||'';document.getElementById('i-marca').value=item.marca||'';document.getElementById('i-pvp').value=item.precio_venta||0;document.getElementById('i-coste').value=item.precio_coste||0;calcIntPvp();}
function calcIntPvp(){const cant=parseFloat(document.getElementById('i-cant').value)||1,pvp=parseFloat(document.getElementById('i-pvp').value)||0,dto=parseFloat(document.getElementById('i-dto').value)||0;const neto=cant*pvp*(1-dto/100);document.getElementById('i-neto').value=neto>0?neto.toFixed(2)+' â‚¬':'â€”';}
async function saveInteriorismo(){
  const proy=document.getElementById('i-proyecto').value;if(!proy){toast('Selecciona un proyecto','error');return;}
  const d={proyecto_id:proy,estancia:document.getElementById('i-estancia').value,ref_catalogo:document.getElementById('i-ref').value||null,descripcion:document.getElementById('i-desc').value,marca:document.getElementById('i-marca').value,acabado:document.getElementById('i-acabado').value,unidad:'Ud',cantidad:parseFloat(document.getElementById('i-cant').value)||1,pvp_catalogo:parseFloat(document.getElementById('i-pvp').value)||0,dto_cliente_pct:parseFloat(document.getElementById('i-dto').value)||0,coste_neto:parseFloat(document.getElementById('i-coste').value)||0,iva_pct:document.getElementById('i-iva').value,estado_propuesta:document.getElementById('i-eprop').value,estado_cobro:'Pendiente',estado_pedido:document.getElementById('i-eped').value,fecha_entrega:document.getElementById('i-fentrega').value||null,notas:document.getElementById('i-notas').value};
  try{
    const id=document.getElementById('i-id')?.value;
    if(id){
      await sb('interiorismo_lineas','PATCH',d,null,`?id=eq.${id}`);
      toast('ArtÃ­culo actualizado âœ…');
    } else {
      await sbPost('interiorismo_lineas',d);
      toast('ArtÃ­culo aÃ±adido âœ…');
    }
    document.getElementById('i-id').value='';
    document.querySelector('#m-interiorismo .modal-title').textContent='ğŸ›‹ AÃ±adir artÃ­culo';
    closeModal('m-interiorismo'); loadInteriorismo();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPRAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCompras(){
  const tb=document.getElementById('compras-tbody');
  try{
    CoC=await sbGet('compras','?order=fecha.desc');
    document.getElementById('compras-count').textContent=CoC.length+' registros';
    if(!CoC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Sin compras</div><button class="btn btn-primary" onclick="openModal('m-compra')">ï¼‹ Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=CoC.map(c=>{const tot=c.base_imponible*(1+ivaPct(c.iva_pct)/100);return`<tr data-search="${(c.proyecto_id+c.proveedor_id+c.concepto).toLowerCase()}"><td>${fmtD(c.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${c.proyecto_id||'â€”'}</td><td>${c.proveedor_id||'â€”'}</td><td>${c.concepto||'â€”'}</td><td class="td-mono">${fmt(c.base_imponible)}</td><td class="td-mono">${c.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(c.estado_pago)}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" onclick="editCompra('${c.id}')" style="font-size:11px">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('compras','${c.id}','${(c.concepto||'compra').replace(/'/g,"\\'")}')">ğŸ—‘</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('compras');
}
async function saveCompra(){
  const id=document.getElementById('co-id')?.value;
  const d={fecha:document.getElementById('co-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('co-proyecto').value||null,proveedor_id:document.getElementById('co-prov').value||null,concepto:document.getElementById('co-concepto').value,base_imponible:parseFloat(document.getElementById('co-base').value)||0,iva_pct:document.getElementById('co-iva').value,estado_pago:document.getElementById('co-estado').value,fecha_vencimiento:document.getElementById('co-vto').value||null,notas:document.getElementById('co-notas').value};
  try{
    if(id){await sb('compras','PATCH',d,null,`?id=eq.${id}`);toast('Compra actualizada âœ…');}
    else{await sbPost('compras',d);toast('Compra registrada âœ…');}
    document.getElementById('co-id').value='';
    document.querySelector('#m-compra .modal-title').textContent='ğŸ›’ Nueva compra';
    closeModal('m-compra');loadCompras();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBCONTRATAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSubcontratas(){
  const tb=document.getElementById('subcontratas-tbody');
  try{
    ScC=await sbGet('subcontratas','?order=fecha.desc');
    document.getElementById('subcontratas-count').textContent=ScC.length+' registros';
    if(!ScC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ‘·</div><div class="empty-text">Sin subcontratas</div><button class="btn btn-primary" onclick="openModal('m-subcontrata')">ï¼‹ Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=ScC.map(s=>{const tot=s.importe*(1+ivaPct(s.iva_pct)/100);return`<tr data-search="${(s.proyecto_id+s.proveedor_id+s.trabajo).toLowerCase()}"><td>${fmtD(s.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${s.proyecto_id||'â€”'}</td><td>${s.proveedor_id||'â€”'}</td><td>${s.trabajo||'â€”'}</td><td class="td-mono">${fmt(s.importe)}</td><td class="td-mono">${s.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(s.estado_pago)}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" onclick="editSubcontrata('${s.id}')" style="font-size:11px">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('subcontratas','${s.id}','${(s.trabajo||'subcontrata').replace(/'/g,"\\'")}')">ğŸ—‘</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('subcontratas');
}
async function saveSubcontrata(){
  const id=document.getElementById('sc-id')?.value;
  const d={fecha:document.getElementById('sc-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('sc-proyecto').value||null,proveedor_id:document.getElementById('sc-prov').value||null,trabajo:document.getElementById('sc-trabajo').value,importe:parseFloat(document.getElementById('sc-importe').value)||0,iva_pct:document.getElementById('sc-iva').value,estado_pago:document.getElementById('sc-estado').value,fecha_vencimiento:document.getElementById('sc-vto').value||null};
  try{
    if(id){await sb('subcontratas','PATCH',d,null,`?id=eq.${id}`);toast('Subcontrata actualizada âœ…');}
    else{await sbPost('subcontratas',d);toast('Subcontrata registrada âœ…');}
    document.getElementById('sc-id').value='';
    document.querySelector('#m-subcontrata .modal-title').textContent='ğŸ‘· Nueva subcontrata';
    closeModal('m-subcontrata');loadSubcontratas();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HORAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHoras(){
  const tb=document.getElementById('horas-tbody');
  try{
    HC=await sbGet('horas','?order=fecha.desc');
    document.getElementById('horas-count').textContent=HC.length+' registros';
    if(!HC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">â±</div><div class="empty-text">Sin horas registradas</div><button class="btn btn-primary" onclick="openModal('m-hora')">ï¼‹ Registrar</button></div></td></tr>`;return;}
    tb.innerHTML=HC.map(h=>`<tr data-search="${(h.proyecto_id+h.trabajador+h.descripcion).toLowerCase()}"><td>${fmtD(h.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${h.proyecto_id||'â€”'}</td><td><strong>${h.trabajador||'â€”'}</strong></td><td class="td-mono">${h.horas}h</td><td class="td-mono">${fmt(h.coste_hora)}</td><td class="td-mono" style="font-weight:700">${fmt(h.total)}</td><td style="color:var(--text-soft)">${h.descripcion||'â€”'}</td><td><button class="btn btn-ghost btn-sm" style="margin-right:4px;font-size:11px" onclick="editHora('${h.id}')">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('horas','${h.id}','horas ${h.trabajador}')">ğŸ—‘</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('horas');
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOC. PEDIDO - INTEGRACIÃ“N CON REGISTRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Navega a Doc.Pedido y carga el pedido con ese ID
async function abrirDocPedido(pedidoId){
  await navTo('pedido_doc');
  const sel = document.getElementById('pd-pedido-sel');
  if(sel){ sel.value = pedidoId; cargarPedidoEnDoc(); }
}

// Nuevo pedido en blanco
function nuevoPedidoDoc(){
  window.pdLineas = Array.from({length:20}, ()=>({cant:'',desc:''}));
  window.pdPedidoId = null;
  ['pd-num-input','pd-prov-input','pd-prov-tel-input','pd-proyecto-input','pd-obs-input'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const today = new Date().toISOString().split('T')[0];
  const f=document.getElementById('pd-fecha-input'); if(f) f.value=today;
  const n=document.getElementById('pd-nota-input');
  if(n) n.value='SERVIR LO ANTES POSIBLE.\n\nDIRECCIÃ“N DE ENTREGA AV. DIPUTACIÃ“N NÂº 24 - ALCASSER 46290 (VALENCIA)\nHORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.\nTELFN. CONTACTO 677 970 074 ATENCIÃ“N DE JOSE.';
  const sel=document.getElementById('pd-pedido-sel'); if(sel) sel.value='';
  renderPedidoLineas();
}

// Carga el pedido seleccionado en el documento
function cargarPedidoEnDoc(){
  const sel = document.getElementById('pd-pedido-sel');
  if(!sel||!sel.value){ nuevoPedidoDoc(); return; }
  const p = PedC.find(x=>String(x.id)===String(sel.value));
  if(!p) return;
  window.pdPedidoId = p.id;
  // Cabecera
  const setVal=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v||''; };
  setVal('pd-num-input', p.num_pedido);
  setVal('pd-fecha-input', p.fecha);
  setVal('pd-prov-input', p.proveedor);
  // pd-prov-tel-input removed
  setVal('pd-proyecto-input', p.proyecto_id);
  setVal('pd-obs-input', p.observaciones);
  setVal('pd-ref-doc-input', p.referencia);
  // LÃ­neas
  if(p.lineas && Array.isArray(p.lineas) && p.lineas.length){
    window.pdLineas = p.lineas;
    // Pad to minimum 20 lines
    while(window.pdLineas.length < 20) window.pdLineas.push({cant:'',desc:''});
  } else {
    window.pdLineas = Array.from({length:20}, ()=>({cant:'',desc:''}));
  }
  renderPedidoLineas();
}

// Guarda el documento en la tabla pedidos
async function guardarDocPedido(){
  const getVal = id => { const el=document.getElementById(id); return el?el.value:''; };
  const lineasLimpias = (window.pdLineas||[]).filter(l=>l.cant||l.desc);
  const d = {
    num_pedido:   getVal('pd-num-input'),
    fecha:        getVal('pd-fecha-input') || new Date().toISOString().split('T')[0],
    proveedor:    getVal('pd-prov-input'),
    // prov_tel removed from UI
    proyecto_id:  getVal('pd-proyecto-input') || null,
    observaciones:getVal('pd-obs-input'),
    referencia:   getVal('pd-ref-doc-input'),
    lineas:       lineasLimpias,
    estado:       'Pendiente',
    tipo:         'Material',
    importe:      0,
  };
  try{
    if(window.pdPedidoId){
      // UPDATE
      await sb('pedidos','PATCH',d,null,`?id=eq.${window.pdPedidoId}`);
      toast('Pedido actualizado âœ…');
    } else {
      // INSERT
      const res = await fetch(`${SB_URL}/rest/v1/pedidos`,{
        method:'POST',
        headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'},
        body:JSON.stringify(d)
      });
      if(!res.ok) throw new Error(await res.text());
      const created = await res.json();
      if(created&&created[0]) window.pdPedidoId = created[0].id;
      toast('Pedido creado y guardado âœ…');
    }
    // Refresh PedC cache and selector
    PedC = await sbGet('pedidos','?order=fecha.desc').catch(()=>PedC);
    poblarSelectorDocPedido();
    if(window.pdPedidoId){
      const sel=document.getElementById('pd-pedido-sel');
      if(sel) sel.value = window.pdPedidoId;
    }
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// Rellena el selector con los pedidos existentes
function poblarSelectorDocPedido(){
  const sel = document.getElementById('pd-pedido-sel');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Nuevo pedido â€”</option>'
    + PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin nÂº'} Â· ${p.proveedor||'Sin proveedor'} Â· ${fmtD(p.fecha)}</option>`).join('');
  if(cur) sel.value = cur;
}

// â•â•â• PEDIDO DOCUMENTO - LÃNEAS EDITABLES â•â•â•
function renderPedidoLineas(){
  const tbody=document.getElementById('pd-lineas-body');
  if(!tbody)return;
  if(!window.pdLineas||!window.pdLineas.length){
    window.pdLineas=Array.from({length:20},()=>({cant:'',desc:''}));
  }
  tbody.innerHTML=window.pdLineas.map((l,i)=>`
    <tr style="border-bottom:1px solid #ddd">
      <td style="padding:4px 6px;text-align:center;border-right:1px solid #ddd;width:64px;min-height:24px">
        <input value="${l.cant}" oninput="window.pdLineas[${i}].cant=this.value" style="width:54px;text-align:center;font-size:12px;font-family:Arial;border:none;border-bottom:1px dotted #bbb;outline:none;background:transparent;min-height:20px" placeholder=" ">
      </td>
      <td style="padding:4px 6px;min-height:24px">
        <input value="${l.desc}" oninput="window.pdLineas[${i}].desc=this.value" style="width:100%;font-size:12px;font-family:Arial;border:none;border-bottom:1px dotted #bbb;outline:none;background:transparent;min-height:20px" placeholder=" ">
      </td>
    </tr>`).join('');
}
function addPedidoLinea(){
  if(!window.pdLineas)window.pdLineas=[];
  window.pdLineas.push({cant:'',desc:''});
  renderPedidoLineas();
}
function clearPedidoLineas(){
  window.pdLineas=null;
  renderPedidoLineas();
  // Reset header fields
  ['pd-num-input','pd-prov-input','pd-prov-tel-input','pd-proyecto-input','pd-obs-input'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const today=new Date().toISOString().split('T')[0];
  const f=document.getElementById('pd-fecha-input');if(f)f.value=today;
  const n=document.getElementById('pd-nota-input');
  if(n)n.value='SERVIR LO ANTES POSIBLE.\n\nDIRECCIÃ“N DE ENTREGA AV. DIPUTACIÃ“N NÂº 24 - ALCASSER 46290 (VALENCIA)\nHORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.\nTELFN. CONTACTO 677 970 074 ATENCIÃ“N DE JOSE.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTAR PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportarPDF(elementId, nombreArchivo){
  const el = document.getElementById(elementId);
  if(!el){ toast('Elemento no encontrado','error'); return; }
  toast('Generando PDFâ€¦');
  const opt = {
    margin:       [8, 8, 8, 8],
    filename:     nombreArchivo || 'documento.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
  };
  try {
    await html2pdf().set(opt).from(el).save();
    toast('PDF descargado âœ…');
  } catch(e) {
    toast('Error generando PDF: ' + e.message, 'error');
  }
}

async function exportarPresupuestoPDF(){
  const proy = document.getElementById('pres-proyecto-sel')?.value;
  const ver  = document.getElementById('pres-version-sel')?.value || 'v1';
  if(!proy){ toast('Selecciona un proyecto primero','error'); return; }
  // Get project and client info
  const proyecto = PC.find(p=>p.proyecto_id===proy)||{};
  const cliente  = CC.find(c=>c.cliente_id===proyecto.cliente_id)||{};
  // Get rows from table
  const tbody = document.getElementById('pres-tbody');
  if(!tbody){ toast('Sin datos de presupuesto','error'); return; }
  // Build a clean printable div
  const totalEl = document.getElementById('pres-total-lbl');
  const totalText = totalEl ? totalEl.textContent : '';
  const rowsHtml = Array.from(tbody.querySelectorAll('tr[data-search]'))
    .filter(tr=>tr.style.display!=='none')
    .map(tr=>{
      const tds = tr.querySelectorAll('td');
      const isCapitulo = tr.classList.contains('capitulo-row') || (tds[0]&&tds[0].colSpan>1);
      if(isCapitulo){
        return `<tr style="background:#1a2a3a;color:white"><td colspan="7" style="padding:7px 10px;font-weight:700">${tds[0]?.textContent||''}</td></tr>`;
      }
      return `<tr style="border-bottom:1px solid #eee">
        ${Array.from(tds).slice(0,-1).map(td=>`<td style="padding:5px 8px;font-size:11px">${td.textContent}</td>`).join('')}
      </tr>`;
    }).join('');

  const printDiv = document.createElement('div');
  printDiv.innerHTML = `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #1a2a3a;padding-bottom:12px;margin-bottom:16px">
        <div>
          <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
          <div style="font-size:10px;color:#666">C/ TomÃ¡s y Valiente NÂº 6 Bajo Â· 46290 AlcÃ sser Â· info@pauinteriorismo.com Â· CIF: B-56909641</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:18px;font-weight:700;color:#b87333">PRESUPUESTO</div>
          <div style="font-size:11px;color:#666">${proy} Â· ${ver.toUpperCase()} Â· ${new Date().toLocaleDateString('es-ES')}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div style="background:#f7f4ef;padding:10px;border-radius:4px">
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a9aaa;margin-bottom:4px">CLIENTE</div>
          <div style="font-weight:700">${cliente.nombre||'â€”'}</div>
          <div style="font-size:11px;color:#666">${cliente.email||''} ${cliente.telefono||''}</div>
        </div>
        <div style="background:#f7f4ef;padding:10px;border-radius:4px">
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a9aaa;margin-bottom:4px">PROYECTO</div>
          <div style="font-weight:700">${proyecto.nombre||proy}</div>
          <div style="font-size:11px;color:#666">${proyecto.tipo||''}</div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:16px">
        <thead><tr style="background:#1a2a3a;color:white;font-size:11px">
          <th style="padding:7px;text-align:left">CÃ³d.</th>
          <th style="padding:7px;text-align:left">DescripciÃ³n</th>
          <th style="padding:7px;text-align:center">Ud.</th>
          <th style="padding:7px;text-align:right">Med.</th>
          <th style="padding:7px;text-align:right">P.Unit.</th>
          <th style="padding:7px;text-align:right">Total</th>
        </tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div style="text-align:right;font-size:14px;font-weight:700;padding:10px;background:#f7f4ef;border-radius:4px">${totalText}</div>
      <div style="color:#666;font-size:10px;text-align:center;border-top:1px solid #eee;padding-top:10px;margin-top:16px">
        PAU INTERIORISMO S.L. Â· CIF B-56909641 Â· info@pauinteriorismo.com Â· Tel: 961 20 01 87
      </div>
    </div>`;
  document.body.appendChild(printDiv);
  const filename = `Presupuesto_${proy}_${ver}_${new Date().toISOString().split('T')[0]}.pdf`;
  await exportarPDF(printDiv.firstElementChild, filename);
  document.body.removeChild(printDiv);
}
// â•â•â• EDITAR HORAS â•â•â•
function editHora(id){
  const h=HC.find(x=>x.id===id); if(!h)return;
  document.getElementById('h-id').value=h.id;
  document.getElementById('h-fecha').value=h.fecha;
  document.getElementById('h-proyecto').value=h.proyecto_id||'';
  document.getElementById('h-trab').value=h.trabajador||'';
  document.getElementById('h-horas').value=h.horas||'';
  document.getElementById('h-coste').value=h.coste_hora||18;
  document.getElementById('h-desc').value=h.descripcion||'';
  document.querySelector('#m-hora .modal-title').textContent='âœï¸ Editar horas';
  openModal('m-hora');
}
// â•â•â• EDITAR COMPRAS â•â•â•
function editCompra(id){
  const c=CoC.find(x=>x.id===id); if(!c)return;
  document.getElementById('co-id').value=c.id;
  document.getElementById('co-fecha').value=c.fecha;
  document.getElementById('co-proyecto').value=c.proyecto_id||'';
  document.getElementById('co-prov').value=c.proveedor_id||'';
  document.getElementById('co-concepto').value=c.concepto||'';
  document.getElementById('co-base').value=c.base_imponible||'';
  document.getElementById('co-iva').value=c.iva_pct||'21%';
  document.getElementById('co-estado').value=c.estado_pago||'Pendiente';
  document.getElementById('co-vto').value=c.fecha_vencimiento||'';
  document.getElementById('co-notas').value=c.notas||'';
  document.querySelector('#m-compra .modal-title').textContent='âœï¸ Editar compra';
  openModal('m-compra');
}
// â•â•â• EDITAR SUBCONTRATAS â•â•â•
function editSubcontrata(id){
  const s=ScC.find(x=>x.id===id); if(!s)return;
  document.getElementById('sc-id').value=s.id;
  document.getElementById('sc-fecha').value=s.fecha;
  document.getElementById('sc-proyecto').value=s.proyecto_id||'';
  document.getElementById('sc-prov').value=s.proveedor_id||'';
  document.getElementById('sc-trabajo').value=s.trabajo||'';
  document.getElementById('sc-importe').value=s.importe||'';
  document.getElementById('sc-iva').value=s.iva_pct||'21%';
  document.getElementById('sc-estado').value=s.estado_pago||'Pendiente';
  document.getElementById('sc-vto').value=s.fecha_vencimiento||'';
  document.querySelector('#m-subcontrata .modal-title').textContent='âœï¸ Editar subcontrata';
  openModal('m-subcontrata');
}
async function saveHora(){
  const id=document.getElementById('h-id')?.value;
  const d={fecha:document.getElementById('h-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('h-proyecto').value||null,trabajador:document.getElementById('h-trab').value,horas:parseFloat(document.getElementById('h-horas').value)||0,coste_hora:parseFloat(document.getElementById('h-coste').value)||18,descripcion:document.getElementById('h-desc').value};
  try{
    if(id){await sb('horas','PATCH',d,null,`?id=eq.${id}`);toast('Horas actualizadas âœ…');}
    else{await sbPost('horas',d);toast('Horas registradas âœ…');}
    document.getElementById('h-id').value='';
    document.querySelector('#m-hora .modal-title').textContent='â± Registrar horas';
    closeModal('m-hora');loadHoras();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEDIDOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPedidos(){
  // Siempre cargar proveedores para tenerlos listos
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  const tb=document.getElementById('pedidos-tbody');
  try{
    PedC=await sbGet('pedidos','?order=fecha.desc');
    document.getElementById('pedidos-count').textContent=PedC.length+' pedidos';
    if(!PedC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Sin pedidos</div><button class="btn btn-primary" onclick="openModal('m-pedido')">ï¼‹ Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PedC.map(p=>`<tr data-search="${(p.num_pedido+p.proyecto_id+p.proveedor+p.tipo).toLowerCase()}"><td class="td-mono" style="font-weight:700">${p.num_pedido||'â€”'}</td><td>${fmtD(p.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'â€”'}</td><td><span class="badge b-blue">${p.tipo||'â€”'}</span></td><td>${p.proveedor||'â€”'}</td><td class="td-mono" style="font-weight:700">${fmt(p.importe)}</td><td>${bE(p.estado)}</td><td style="color:var(--text-soft)">${p.referencia?`<span style="font-weight:600;color:var(--navy)">${p.referencia}</span>`:''} ${p.observaciones||''}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="editPedido('${p.id}')">Editar</button><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="abrirDocPedido('${p.id}')">ğŸ“‹ Doc.</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('pedidos','${p.id}','${(p.num_pedido||'pedido').replace(/'/g,"\\'")}')">ğŸ—‘</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('pedidos');
}
function fillProvSelect(selId){
  const sel=document.getElementById(selId);
  if(!sel)return;
  if(!ProvC.length){
    sel.innerHTML='<option value="">Sin proveedores registrados</option>';
    return;
  }
  sel.innerHTML='<option value="">Seleccionar proveedorâ€¦</option>'
    +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ('+p.tipo+')':''}</option>`).join('');
}
function editPedido(id){
  const p=PedC.find(x=>String(x.id)===String(id)); if(!p)return;
  document.getElementById('ped-id').value=p.id;
  document.getElementById('ped-num').value=p.num_pedido||'';
  document.getElementById('ped-fecha').value=p.fecha||'';
  document.getElementById('ped-proyecto').value=p.proyecto_id||'';
  document.getElementById('ped-tipo').value=p.tipo||'Material';
  document.getElementById('ped-prov').value=p.proveedor||'';
  if(document.getElementById('ped-ref')) document.getElementById('ped-ref').value=p.referencia||'';
  document.getElementById('ped-importe').value=p.importe||'';
  document.getElementById('ped-estado').value=p.estado||'Pendiente';
  document.getElementById('ped-obs').value=p.observaciones||'';
  // Fill proveedor select
  const sel=document.getElementById('ped-prov');
  if(ProvC&&ProvC.length){
    sel.innerHTML='<option value="">Seleccionar proveedorâ€¦</option>'+ProvC.map(pv=>`<option value="${pv.nombre}">${pv.nombre}${pv.tipo?' Â· '+pv.tipo:''}</option>`).join('');
    sel.value=p.proveedor||'';
  }
  document.querySelector('#m-pedido .modal-title').textContent='âœï¸ Editar pedido';
  openModal('m-pedido');
}
function openPedidoModal(){
  document.getElementById('ped-id').value='';
  document.getElementById('ped-num').value='PED-'+String((PedC.length||0)+1).padStart(3,'0');
  document.getElementById('ped-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('ped-obs').value='';
  document.getElementById('ped-importe').value='';
  // Rellenar proveedores desde cachÃ© (cargados en init)
  const sel=document.getElementById('ped-prov');
  if(ProvC && ProvC.length>0){
    sel.innerHTML='<option value="">Seleccionar proveedorâ€¦</option>'
      +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' Â· '+p.tipo:''}</option>`).join('');
  } else {
    sel.innerHTML='<option value="">Sin proveedores â€” aÃ±ade en menÃº Proveedores</option>';
  }
  openModal('m-pedido');
}
async function savePedido(){
  const id=document.getElementById('ped-id')?.value;
  const d={
    num_pedido:   document.getElementById('ped-num').value,
    fecha:        document.getElementById('ped-fecha').value||new Date().toISOString().split('T')[0],
    proyecto_id:  document.getElementById('ped-proyecto').value||null,
    tipo:         document.getElementById('ped-tipo').value,
    proveedor:    document.getElementById('ped-prov').value,
    referencia:   document.getElementById('ped-ref')?.value||'',
    importe:      parseFloat(document.getElementById('ped-importe').value)||0,
    estado:       document.getElementById('ped-estado').value,
    observaciones:document.getElementById('ped-obs').value
  };
  try{
    if(id){ await sb('pedidos','PATCH',d,null,`?id=eq.${id}`); toast('Pedido actualizado âœ…'); }
    else  { await sbPost('pedidos',d); toast('Pedido registrado âœ…'); }
    document.getElementById('ped-id').value='';
    document.querySelector('#m-pedido .modal-title').textContent='ğŸ“¦ Nuevo pedido';
    closeModal('m-pedido'); loadPedidos();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL HORARIO ANUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadControlHorario(){
  const trab=document.getElementById('ch-trab-sel').value;
  const year=parseInt(document.getElementById('ch-year-sel').value)||2026;
  const grid=document.getElementById('ch-meses-grid');
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-soft)">Cargandoâ€¦</div>';
  try{
    const data=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&anyo=eq.${year}&order=fecha.asc`);
    const horasByFecha={};data.forEach(d=>{horasByFecha[d.fecha]={horas:d.horas,tipo:d.tipo};});
    let totalHoras=0,diasTrab=0;
    grid.innerHTML='';
    for(let mes=0;mes<12;mes++){
      const primerDia=new Date(year,mes,1);
      const diasMes=new Date(year,mes+1,0).getDate();
      const diaInicio=(primerDia.getDay()+6)%7; // Lunes=0
      let html=`<div class="card"><div class="card-header"><div class="card-title">ğŸ“… ${MESES[mes]} ${year}</div></div><div class="card-body" style="padding:10px">`;
      html+='<div class="horario-grid">';
      DIAS_CORTOS.forEach(d=>{html+=`<div class="day-header">${d}</div>`;});
      for(let i=0;i<diaInicio;i++)html+='<div></div>';
      for(let d=1;d<=diasMes;d++){
        const fecha=`${year}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const diaSem=(new Date(year,mes,d).getDay()+6)%7;
        const reg=horasByFecha[fecha];
        let cls='horario-day';
        if(diaSem>=5)cls+=' weekend';
        if(reg){cls+=' trabajado';if(reg.horas>0){totalHoras+=reg.horas;diasTrab++;}}
        html+=`<div class="${cls}" onclick="toggleHorario('${fecha}','${trab}',${year})" title="${fecha}">
          <div class="horario-day-num">${d}</div>
          ${reg&&reg.horas>0?`<div class="horario-day-h">${reg.horas}h</div>`:''}
        </div>`;
      }
      html+='</div></div></div>';
      grid.innerHTML+=html;
    }
    document.getElementById('ch-resumen').textContent=`${diasTrab} dÃ­as Â· ${totalHoras}h totales`;
  }catch(e){grid.innerHTML=`<div style="color:var(--red);padding:20px;grid-column:1/-1">Error: ${e.message}. AsegÃºrate de haber ejecutado el SQL de nuevas tablas.</div>`;}
}
async function toggleHorario(fecha,trab,year){
  try{
    const exist=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&fecha=eq.${fecha}`);
    if(exist.length){await sbDelete('control_horario',exist[0].id);toast('DÃ­a borrado');}
    else{await sbPost('control_horario',{trabajador:trab,fecha,horas:8,tipo:'Trabajo',anyo:year});toast('DÃ­a registrado âœ…');}
    loadControlHorario();
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROVEEDORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadProveedores(){
  const tb=document.getElementById('proveedores-tbody');
  try{
    ProvC=await sbGet('proveedores','?order=nombre.asc');
    document.getElementById('proveedores-count').textContent=ProvC.length+' proveedores';
    if(!ProvC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸ­</div><div class="empty-text">Sin proveedores</div></div></td></tr>`;return;}
    tb.innerHTML=ProvC.map(p=>`<tr data-search="${(p.nombre+p.cif+p.especialidad+p.tipo).toLowerCase()}"><td><strong>${p.nombre}</strong></td><td class="td-mono">${p.cif||'â€”'}</td><td>${bE(p.tipo)}</td><td>${p.especialidad||'â€”'}</td><td>${p.telefono||'â€”'}</td><td style="color:var(--navy-mid)">${p.email||'â€”'}</td><td>${p.forma_pago||'â€”'}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProveedor('${p.id}')">âœï¸</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proveedores','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">ğŸ—‘</button></div></td></tr>`).join('');
    populateSelects();
    poblarFiltrosCliente();
    filtrarProyectosPorCliente();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editProveedor(id){const p=ProvC.find(x=>x.id===id);if(!p)return;document.getElementById('pv-id').value=p.id;document.getElementById('pv-nombre').value=p.nombre||'';document.getElementById('pv-cif').value=p.cif||'';document.getElementById('pv-tipo').value=p.tipo||'Proveedor';document.getElementById('pv-tel').value=p.telefono||'';document.getElementById('pv-email').value=p.email||'';document.getElementById('pv-esp').value=p.especialidad||'';document.getElementById('pv-pago').value=p.forma_pago||'Transferencia';document.getElementById('pv-iban').value=p.iban||'';document.getElementById('pv-notas').value=p.notas||'';openModal('m-proveedor');}
async function saveProveedor(){const nombre=document.getElementById('pv-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}const id=document.getElementById('pv-id').value;const d={nombre,cif:document.getElementById('pv-cif').value,tipo:document.getElementById('pv-tipo').value,telefono:document.getElementById('pv-tel').value,email:document.getElementById('pv-email').value,especialidad:document.getElementById('pv-esp').value,forma_pago:document.getElementById('pv-pago').value,iban:document.getElementById('pv-iban').value,notas:document.getElementById('pv-notas').value};try{if(id){await sbPatch('proveedores',id,d);toast('Proveedor actualizado âœ…');}else{d.proveedor_id=genId('PRV',ProvC,'proveedor_id');await sbPost('proveedores',d);toast('Proveedor guardado âœ…');}closeModal('m-proveedor');document.getElementById('pv-id').value='';loadProveedores();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENTABILIDAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initRentabilidad(){if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);populateSelects();}
async function loadRentabilidad(){
  const proy=document.getElementById('rent-proyecto-sel').value,ver=document.getElementById('rent-version-sel').value;
  document.getElementById('rent-kpis').style.display='none';document.getElementById('rent-empty').style.display=proy?'none':'block';
  if(!proy)return;
  try{
    const[lineas,compras,subcs,horas,facturas]=await Promise.all([sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}`),sbGet('compras',`?proyecto_id=eq.${proy}`),sbGet('subcontratas',`?proyecto_id=eq.${proy}`),sbGet('horas',`?proyecto_id=eq.${proy}`),sbGet('facturas',`?proyecto_id=eq.${proy}`)]);
    const totalPres=lineas.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
    const totalCompras=compras.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalSubcs=subcs.reduce((s,c)=>s+(c.importe||0),0);
    const totalHoras=horas.reduce((s,h)=>s+(h.total||0),0);
    const totalCoste=totalCompras+totalSubcs+totalHoras;
    const beneficio=totalPres-totalCoste,margen=totalPres>0?(beneficio/totalPres)*100:0;
    const pct=totalPres>0?Math.min((totalCoste/totalPres)*100,150):0;
    document.getElementById('rk-pres').textContent=fmt(totalPres);document.getElementById('rk-coste').textContent=fmt(totalCoste);
    document.getElementById('rk-benef').textContent=fmt(beneficio);document.getElementById('rk-benef').style.color=beneficio>=0?'var(--green)':'var(--red)';
    document.getElementById('rk-margen').textContent=fmtP(margen);document.getElementById('rk-margen').style.color=margen>=15?'var(--green)':margen>=0?'var(--amber)':'var(--red)';
    const bar=document.getElementById('rent-bar');bar.style.width=Math.min(pct,100)+'%';bar.style.background=pct<80?'var(--green)':pct<100?'var(--copper)':'var(--red)';
    document.getElementById('rent-bar-label').textContent=`${pct.toFixed(1)}% consumido`;document.getElementById('rent-bar-nums').textContent=`${fmt(totalCoste)} de ${fmt(totalPres)}`;
    document.getElementById('rk-compras-total').textContent=fmt(totalCompras);
    document.getElementById('rk-compras-list').innerHTML=compras.length?compras.map(c=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(c.fecha)}</td><td style="padding:5px 10px">${c.concepto||c.proveedor_id||'â€”'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(c.base_imponible)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin compras</td></tr>';
    document.getElementById('rk-sub-total').textContent=fmt(totalSubcs);
    document.getElementById('rk-sub-list').innerHTML=subcs.length?subcs.map(s=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(s.fecha)}</td><td style="padding:5px 10px">${s.trabajo||'â€”'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(s.importe)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin subcontratas</td></tr>';
    document.getElementById('rk-horas-total').textContent=fmt(totalHoras);
    const horPorTrab={};horas.forEach(h=>{horPorTrab[h.trabajador]=(horPorTrab[h.trabajador]||0)+(h.total||0);});
    document.getElementById('rk-horas-list').innerHTML=Object.keys(horPorTrab).length?Object.entries(horPorTrab).map(([t,v])=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px" colspan="2">${t}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(v)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin horas</td></tr>';
    const totalFact=facturas.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('rk-fact-total').textContent=fmt(totalFact);
    document.getElementById('rk-fact-list').innerHTML=facturas.length?facturas.map(f=>{const tot=(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);return`<tr><td style="padding:7px 10px;font-weight:700">${f.num_factura||'â€”'}</td><td style="padding:7px 10px">${fmtD(f.fecha_emision)}</td><td style="padding:7px 10px">${fmt(f.base_imponible)}</td><td style="padding:7px 10px;font-weight:700">${fmt(tot)}</td><td style="padding:7px 10px">${bE(f.estado)}</td></tr>`;}).join(''):'<tr><td colspan="5" style="text-align:center;padding:12px;color:var(--text-soft)">Sin facturas</td></tr>';
    document.getElementById('rent-kpis').style.display='block';
  }catch(e){toast('Error: '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACTURAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFacturas(){
  const tb=document.getElementById('facturas-tbody');
  try{
    FC=await sbGet('facturas','?order=fecha_emision.desc');
    // Poblar proveedor select en modal
    const fProv=document.getElementById('f-proveedor');
    if(fProv){
      const cur=fProv.value;
      fProv.innerHTML='<option value="">Seleccionarâ€¦</option>'+ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}</option>`).join('');
      if(cur)fProv.value=cur;
    }
    // KPIs
    let vTotal=0,vCob=0,vPdte=0,vVenc=0;
    let cTotal=0,cPag=0,cPdte=0,cIva=0;
    FC.forEach(f=>{
      const base=f.base_imponible||0;
      const tot=base*(1+ivaPct(f.iva_pct)/100);
      const pag=f.importe_cobrado||0;
      const pdte=tot-pag;
      const tipo=f.tipo_factura||'Venta';
      if(tipo==='Compra'){
        cTotal+=tot; cPag+=pag; cPdte+=pdte;
        cIva+=base*ivaPct(f.iva_pct)/100;
      } else {
        vTotal+=tot; vCob+=pag; vPdte+=pdte;
        if(f.estado==='Vencida') vVenc+=pdte;
      }
    });
    // Set venta KPIs
    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    sv('fk-v-total',fmt(vTotal)); sv('fk-v-cobrado',fmt(vCob));
    sv('fk-v-pendiente',fmt(vPdte)); sv('fk-v-vencidas',fmt(vVenc));
    // Set compra KPIs
    sv('fk-c-total',fmt(cTotal)); sv('fk-c-pagado',fmt(cPag));
    sv('fk-c-pendiente',fmt(cPdte)); sv('fk-c-iva',fmt(cIva));
    // Balance
    const beneficio=vTotal-cTotal;
    const margen=vTotal>0?(beneficio/vTotal)*100:0;
    const ivaLiquidar=FC.reduce((s,f)=>{
      const base=f.base_imponible||0, iva=base*ivaPct(f.iva_pct)/100;
      return s+((f.tipo_factura||'Venta')==='Venta'?iva:-iva);
    },0);
    const bEl=document.getElementById('fk-b-beneficio');
    if(bEl){bEl.textContent=fmt(beneficio);bEl.style.color=beneficio>=0?'var(--green)':'var(--red)';}
    const mEl=document.getElementById('fk-b-margen');
    if(mEl){mEl.textContent=fmtP(margen);mEl.style.color=margen>=20?'var(--green)':margen>=10?'var(--amber)':'var(--red)';}
    sv('fk-b-iva',fmt(ivaLiquidar));
    const pct=vTotal>0?Math.min(cTotal/vTotal*100,100):0;
    const bar=document.getElementById('fk-b-bar');
    if(bar){bar.style.width=pct+'%';bar.style.background=pct<60?'var(--green)':pct<85?'var(--amber)':'var(--red)';}
    sv('fk-b-bar-lbl',`Gastos: ${pct.toFixed(0)}% sobre ingresos`);
    // Count
    document.getElementById('facturas-count').textContent=FC.length+' facturas';
    if(!FC.length){
      tb.innerHTML=`<tr><td colspan="13"><div class="empty"><div class="empty-icon">ğŸ§¾</div><div class="empty-text">Sin facturas</div>
        <button class="btn btn-primary" onclick="abrirNuevaFactura('Venta')">ğŸ“¤ Nueva venta</button>
        <button class="btn btn-ghost" onclick="abrirNuevaFactura('Compra')" style="margin-left:6px">ğŸ“¥ Nueva compra</button>
      </div></td></tr>`;return;
    }
    // Render rows
    tb.innerHTML=FC.map(f=>{
      const base=f.base_imponible||0;
      const tot=base*(1+ivaPct(f.iva_pct)/100);
      const pag=f.importe_cobrado||0, pdte=tot-pag;
      const tipo=f.tipo_factura||'Venta';
      const esC=tipo==='Compra';
      const badge=esC
        ?'<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:8px;background:#fdecea;color:var(--red)">ğŸ“¥ Compra</span>'
        :'<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:8px;background:#e8f5ee;color:var(--green)">ğŸ“¤ Venta</span>';
      const contra=esC?(f.proveedor_id||f.cliente_id||'â€”'):(f.cliente_id||'â€”');
      return `<tr data-tipo="${tipo}" data-search="${tipo.toLowerCase()} ${(f.num_factura||'')} ${contra} ${f.proyecto_id||''} ${f.concepto||''}".toLowerCase()>
        <td>${badge}</td>
        <td class="td-mono" style="font-weight:700">${f.num_factura||'â€”'}</td>
        <td>${fmtD(f.fecha_emision)}</td>
        <td>${fmtD(f.fecha_vencimiento)}</td>
        <td>${contra}</td>
        <td class="td-mono" style="color:var(--text-soft)">${f.proyecto_id||'â€”'}</td>
        <td class="td-mono">${fmt(base)}</td>
        <td class="td-mono">${f.iva_pct||'â€”'}</td>
        <td class="td-mono" style="font-weight:700">${fmt(tot)}</td>
        <td class="td-mono" style="color:var(--green)">${fmt(pag)}</td>
        <td class="td-mono" style="color:${pdte>0?'var(--amber)':'var(--green)'}">${fmt(pdte)}</td>
        <td>${bE(f.estado)}</td>
        <td style="display:flex;gap:3px;align-items:center">
          <button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="editFactura('${f.id}')">âœï¸</button>
          ${!esC?`<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="marcarFacturaCobrada('${f.id}')">âœ…</button>
          <button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="marcarFacturaParcial('${f.id}')">ğŸ’¶</button>`:''}
          <button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('facturas','${f.id}','${(f.num_factura||'factura').replace(/'/g,"\\'")}')" >ğŸ—‘</button>
        </td>
      </tr>`;
    }).join('');
    // Re-apply active tab filter
    const activeTab=document.querySelector('[id^="ftab-"][style*="background:var(--navy)"]');
    if(activeTab) filtrarTabFacturas(activeTab.id.replace('ftab-',''));
  }catch(e){tb.innerHTML=`<tr><td colspan="13" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}

function filtrarTabFacturas(tipo){
  // Update tab styles
  ['todas','venta','compra'].forEach(t=>{
    const el=document.getElementById(`ftab-${t}`);
    if(!el)return;
    const active=(tipo==='todas'&&t==='todas')||(tipo!=='todas'&&t===tipo.toLowerCase());
    el.style.background=active?'var(--navy)':'';
    el.style.color=active?'white':'';
  });
  // Filter rows
  const rows=document.querySelectorAll('#facturas-tbody tr[data-tipo]');
  rows.forEach(tr=>{
    tr.style.display=(tipo==='todas'||tr.dataset.tipo===tipo)?'':'none';
  });
}

function abrirNuevaFactura(tipo){
  const esC=tipo==='Compra';
  document.getElementById('f-id').value='';
  document.getElementById('f-tipo').value=tipo;
  document.getElementById('f-modal-title').textContent=esC?'ğŸ“¥ Nueva factura de compra':'ğŸ“¤ Nueva factura de venta';
  const badge=document.getElementById('f-tipo-badge');
  if(badge){badge.textContent=esC?'ğŸ“¥ COMPRA':'ğŸ“¤ VENTA';badge.style.background=esC?'#fdecea':'#e8f5ee';badge.style.color=esC?'var(--red)':'var(--green)';}
  document.getElementById('f-grp-cliente').style.display=esC?'none':'';
  document.getElementById('f-grp-proveedor').style.display=esC?'':'none';
  document.getElementById('f-cobrado-lbl').textContent=esC?'Importe pagado â‚¬':'Importe cobrado â‚¬';
  // Mostrar vencimientos mÃºltiples solo en compras
  const vtoSimple=document.getElementById('f-grp-vto-simple');
  const vtoMulti =document.getElementById('f-grp-vtos-compra');
  if(vtoSimple) vtoSimple.style.display=esC?'none':'';
  if(vtoMulti)  vtoMulti.style.display =esC?'':'none';
  // Actualizar texto dÃ­as de pago en modal
  const dpInfo=document.getElementById('f-dias-pago-info');
  if(dpInfo) dpInfo.textContent=`dÃ­a ${DIAS_PAGO[0]} y dÃ­a ${DIAS_PAGO[1]} de cada mes`;
  document.getElementById('f-estado').innerHTML=esC
    ?'<option>Pendiente</option><option>Pagada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>'
    :'<option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>';
  // Auto-generar nÃºmero de factura Ãºnico
  const hoy = new Date();
  const anyo = hoy.getFullYear();
  const prefijo = esC ? `FRA-${anyo}-` : `FAC-${anyo}-`;
  // Buscar el mayor nÃºmero existente para este prefijo
  const nums = FC
    .map(f=>(f.num_factura||''))
    .filter(n=>n.startsWith(prefijo))
    .map(n=>parseInt(n.replace(prefijo,''))||0);
  const siguiente = (nums.length ? Math.max(...nums) : 0) + 1;
  document.getElementById('f-num').value = prefijo + String(siguiente).padStart(3,'0');
  // Clear otros campos
  document.getElementById('f-concepto').value='';
  document.getElementById('f-base').value='';
  document.getElementById('f-cobrado').value='0';
  document.getElementById('f-total-display').value='';
  document.getElementById('f-vto').value='';
  document.getElementById('f-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-estado').value='Pendiente'; // Siempre Pendiente por defecto
  // Reset cliente/proyecto
  const fCliente=document.getElementById('f-cliente');
  if(fCliente) fCliente.value='';
  const fProv=document.getElementById('f-proveedor');
  if(fProv) fProv.value='';
  // Reset proyecto select (se filtrarÃ¡ al elegir cliente)
  const fProy=document.getElementById('f-proyecto');
  if(fProy){
    fProy.innerHTML='<option value="">â€” Sin proyecto â€”</option>'
      +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  }
  // Reset vencimientos compra
  ['f-vto2','f-vto3','f-vto4'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  openModal('m-factura');
}

function calcTotalFac(){
  const base=parseFloat(document.getElementById('f-base')?.value)||0;
  const iva=ivaPct(document.getElementById('f-iva')?.value||'21%');
  const total=base*(1+iva/100);
  const el=document.getElementById('f-total-display');
  if(el)el.value=total>0?fmt(total):'';
}

function editFactura(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const esC = (f.tipo_factura||'Venta')==='Compra';

  // 1. Configurar tipo en el modal (SIN limpiar campos, SIN abrir)
  document.getElementById('f-tipo').value = f.tipo_factura||'Venta';
  document.getElementById('f-modal-title').textContent = esC?'âœï¸ Editar factura de compra':'âœï¸ Editar factura de venta';
  const badge=document.getElementById('f-tipo-badge');
  if(badge){badge.textContent=esC?'ğŸ“¥ COMPRA':'ğŸ“¤ VENTA';badge.style.background=esC?'#fdecea':'#e8f5ee';badge.style.color=esC?'var(--red)':'var(--green)';}
  document.getElementById('f-grp-cliente').style.display   = esC?'none':'';
  document.getElementById('f-grp-proveedor').style.display = esC?'':'none';
  document.getElementById('f-cobrado-lbl').textContent = esC?'Importe pagado â‚¬':'Importe cobrado â‚¬';

  // 2. Mostrar/ocultar secciÃ³n vencimientos
  const vtoSimple = document.getElementById('f-grp-vto-simple');
  const vtoMulti  = document.getElementById('f-grp-vtos-compra');
  if(vtoSimple) vtoSimple.style.display = esC ? 'none' : '';
  if(vtoMulti)  vtoMulti.style.display  = esC ? ''     : 'none';
  const dpInfo=document.getElementById('f-dias-pago-info');
  if(dpInfo) dpInfo.textContent=`dÃ­a ${DIAS_PAGO[0]} y dÃ­a ${DIAS_PAGO[1]} de cada mes`;

  // 3. Rellenar estados del select
  document.getElementById('f-estado').innerHTML = esC
    ?'<option>Pendiente</option><option>Pagada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>'
    :'<option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>';

  // 4. Rellenar todos los campos con datos de la factura
  document.getElementById('f-id').value      = f.id;
  document.getElementById('f-num').value     = f.num_factura||'';
  document.getElementById('f-fecha').value   = f.fecha_emision||'';
  document.getElementById('f-concepto').value= f.concepto||'';
  document.getElementById('f-base').value    = f.base_imponible||'';
  document.getElementById('f-iva').value     = f.iva_pct||'21%';
  document.getElementById('f-pago').value    = f.forma_pago||'Transferencia';
  document.getElementById('f-cobrado').value = f.importe_cobrado||'0';
  document.getElementById('f-estado').value  = f.estado||'Pendiente';

  // 5. Vencimiento(s)
  if(esC){
    document.getElementById('f-vto').value = f.fecha_vencimiento||'';
  } else {
    document.getElementById('f-vto-venta').value = f.fecha_vencimiento||'';
  }
  if(esC){
    const vtoIds = ['f-vto2','f-vto3','f-vto4'];
    vtoIds.forEach((vid,i)=>{
      const el=document.getElementById(vid);
      if(el){ el.value=f[`fecha_vto${i+2}`]||''; el.style.color=''; }
    });
    const impIds=['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'];
    impIds.forEach((vid,i)=>{
      const el=document.getElementById(vid);
      if(el){ el.value=f[`importe_vto${i+1}`]||''; el.style.color=''; }
    });
  }

  // 6. Cliente/proveedor y cascada proyecto
  if(esC){
    const fpEl=document.getElementById('f-proveedor');
    if(fpEl) fpEl.value=f.proveedor_id||'';
  } else {
    const fcEl=document.getElementById('f-cliente');
    if(fcEl){
      fcEl.value=f.cliente_id||'';
      cascadaClienteFactura();
      setTimeout(()=>{ document.getElementById('f-proyecto').value=f.proyecto_id||''; },50);
    }
  }

  calcTotalFac();
  openModal('m-factura');
}

async function saveFactura(){
  const tipo=document.getElementById('f-tipo').value||'Venta';
  const id=document.getElementById('f-id').value;
  const esC=tipo==='Compra';
  const numFac=document.getElementById('f-num').value.trim();

  // Validar que el nÃºmero no estÃ© duplicado (solo en facturas nuevas)
  if(!id){
    const duplicado = FC.find(f=>f.num_factura===numFac);
    if(duplicado){ toast(`El nÃºmero "${numFac}" ya existe. ModifÃ­calo.`,'error'); return; }
  }

  const d={
    tipo_factura:    tipo,
    num_factura:     numFac,
    fecha_emision:   document.getElementById('f-fecha').value||new Date().toISOString().split('T')[0],
    cliente_id:      esC?null:(document.getElementById('f-cliente').value||null),
    proveedor_id:    esC?(document.getElementById('f-proveedor').value||null):null,
    proyecto_id:     document.getElementById('f-proyecto').value||null,
    base_imponible:  parseFloat(document.getElementById('f-base').value)||0,
    iva_pct:         document.getElementById('f-iva').value,
    forma_pago:      document.getElementById('f-pago').value,
    fecha_vencimiento: esC
      ? (document.getElementById('f-vto')?.value||null)
      : (document.getElementById('f-vto-venta')?.value||null),
    estado:          document.getElementById('f-estado').value||'Pendiente',
    importe_cobrado: parseFloat(document.getElementById('f-cobrado').value)||0,
    concepto:        document.getElementById('f-concepto').value,
    // Vencimientos mÃºltiples (solo compras)
    fecha_vto2: esC?(document.getElementById('f-vto2')?.value||null):null,
    fecha_vto3: esC?(document.getElementById('f-vto3')?.value||null):null,
    fecha_vto4: esC?(document.getElementById('f-vto4')?.value||null):null,
    importe_vto1: esC?(parseFloat(document.getElementById('f-importe-vto1')?.value)||null):null,
    importe_vto2: esC?(parseFloat(document.getElementById('f-importe-vto2')?.value)||null):null,
    importe_vto3: esC?(parseFloat(document.getElementById('f-importe-vto3')?.value)||null):null,
    importe_vto4: esC?(parseFloat(document.getElementById('f-importe-vto4')?.value)||null):null,
  };

  // Si no hay importe_vto1 pero hay fecha, poner el total como importe
  if(esC && d.fecha_vencimiento && !d.importe_vto1){
    const base=parseFloat(document.getElementById('f-base').value)||0;
    d.importe_vto1 = base*(1+ivaPct(d.iva_pct)/100);
  }

  try{
    if(id){
      await sb('facturas','PATCH',d,null,`?id=eq.${id}`);
      toast('Factura actualizada âœ…');
    } else {
      await sbPost('facturas',d);
      toast('Factura guardada âœ…');
    }
    document.getElementById('f-id').value='';
    closeModal('m-factura');
    loadFacturas();
  }catch(e){
    // Mensaje de error mÃ¡s claro para duplicado
    if(e.message && e.message.includes('duplicate')){
      toast(`NÃºmero de factura duplicado. Cambia "${numFac}" por otro.`,'error');
    } else {
      toast('Error: '+e.message,'error');
    }
  }
}


async function loadContabilidad(){
  try{
    const[comp,subc,hor,fac]=await Promise.all([sbGet('compras'),sbGet('subcontratas'),sbGet('horas'),sbGet('facturas')]);
    const ventas=fac.reduce((s,f)=>s+(f.base_imponible||0),0);
    const ivaRep=fac.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const comprasB=comp.reduce((s,c)=>s+(c.base_imponible||0),0);
    const ivaComp=comp.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const subcsB=subc.reduce((s,c)=>s+(c.importe||0),0);
    const ivaSub=subc.reduce((s,c)=>s+(c.importe||0)*ivaPct(c.iva_pct)/100,0);
    const mo=hor.reduce((s,h)=>s+(h.total||0),0);
    const gastos=comprasB+subcsB+mo;
    const resultado=ventas-gastos;
    const margen=ventas>0?(resultado/ventas)*100:0;

    // Cuenta resultados
    document.getElementById('cnt-ventas').textContent=fmt(ventas);
    document.getElementById('cnt-iva-rep').textContent=fmt(ivaRep);
    document.getElementById('cnt-ing-tot').textContent=fmt(ventas+ivaRep);
    document.getElementById('cnt-compras').textContent=fmt(comprasB);
    document.getElementById('cnt-iva-comp').textContent=fmt(ivaComp);
    document.getElementById('cnt-subcs').textContent=fmt(subcsB);
    document.getElementById('cnt-iva-sub').textContent=fmt(ivaSub);
    document.getElementById('cnt-mo').textContent=fmt(mo);
    document.getElementById('cnt-gastos-tot').textContent=fmt(gastos);
    document.getElementById('cnt-result').textContent=fmt(resultado);
    document.getElementById('cnt-margen').textContent=fmtP(margen);
    const rr=document.getElementById('cnt-result-row');rr.className='cuenta-row result'+(resultado<0?' neg':'');

    // IVA
    document.getElementById('iva-rep').textContent=fmt(ivaRep);
    document.getElementById('iva-comp').textContent=fmt(ivaComp);
    document.getElementById('iva-sub').textContent=fmt(ivaSub);
    document.getElementById('iva-sop-tot').textContent=fmt(ivaComp+ivaSub);
    const ivaNeto=ivaRep-ivaComp-ivaSub;
    document.getElementById('iva-neto').textContent=fmt(ivaNeto);
    document.getElementById('iva-result-row').className='cuenta-row result'+(ivaNeto<0?' neg':'');

    // Balance
    const pendCobro=fac.filter(f=>f.estado!=='Cobrada').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100)-(f.importe_cobrado||0),0);
    const pendProv=comp.filter(c=>c.estado_pago!=='Pagado').reduce((s,c)=>s+(c.base_imponible||0),0);
    const pendSub=subc.filter(c=>c.estado_pago!=='Pagado').reduce((s,c)=>s+(c.importe||0),0);
    document.getElementById('bal-cli').textContent=fmt(pendCobro);
    document.getElementById('bal-iva').textContent=fmt(Math.max(0,ivaNeto));
    document.getElementById('bal-prov').textContent=fmt(pendProv);
    document.getElementById('bal-sub').textContent=fmt(pendSub);
  }catch(e){toast('Error cargando contabilidad: '+e.message,'error');}
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESUPUESTO FINAL (documento imprimible)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConfiguracion(){
  try{
    const data=await sbGet('configuracion');
    const map={};data.forEach(d=>{map[d.clave]=d.valor;});
    document.getElementById('cfg-razon').value=map.razon_social||'PAU INTERIORISMO S.L.';
    document.getElementById('cfg-cif').value=map.cif||'B-56909641';
    document.getElementById('cfg-tel').value=map.telefono||'961 20 0187';
    document.getElementById('cfg-email').value=map.email||'info@pauinteriorismo.com';
    document.getElementById('cfg-web').value=map.web||'www.pauinteriorismo.com';
    document.getElementById('cfg-dir').value=map.direccion||'';
    document.getElementById('cfg-ci').value=map.ci_pct||3;
    document.getElementById('cfg-gg').value=map.gg_pct||13;
    document.getElementById('cfg-bi').value=map.bi_pct||6;
    document.getElementById('cfg-hora').value=map.coste_hora_defecto||18;
    const total=(parseFloat(map.ci_pct)||3)+(parseFloat(map.gg_pct)||13)+(parseFloat(map.bi_pct)||6);
    document.getElementById('cfg-total-ci').value=total.toFixed(1)+'%';
    ['cfg-ci','cfg-gg','cfg-bi'].forEach(id=>{document.getElementById(id).addEventListener('input',()=>{const ci=parseFloat(document.getElementById('cfg-ci').value)||0,gg=parseFloat(document.getElementById('cfg-gg').value)||0,bi=parseFloat(document.getElementById('cfg-bi').value)||0;document.getElementById('cfg-total-ci').value=(ci+gg+bi).toFixed(1)+'%';});});
  }catch(e){toast('Configura la tabla configuracion ejecutando el SQL de nuevas tablas','error');}
  await loadDiasPago();
}
async function saveConfig(){
  const updates=[
    ['razon_social', document.getElementById('cfg-razon')?.value],
    ['cif',          document.getElementById('cfg-cif')?.value],
    ['telefono',     document.getElementById('cfg-tel')?.value],
    ['email',        document.getElementById('cfg-email')?.value],
    ['web',          document.getElementById('cfg-web')?.value],
    ['direccion',    document.getElementById('cfg-dir')?.value],
    ['ci_pct',       document.getElementById('cfg-ci')?.value],
    ['gg_pct',       document.getElementById('cfg-gg')?.value],
    ['bi_pct',       document.getElementById('cfg-bi')?.value],
    ['coste_hora_defecto', document.getElementById('cfg-hora')?.value],
  ];
  try{
    for(const[k,v] of updates){
      if(v===undefined||v===null) continue;
      await upsertConfig(k, v);
    }
    toast('ConfiguraciÃ³n guardada âœ…');
  }catch(e){
    toast('Error guardando: '+e.message,'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADERS MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const loaders={
  gerencia:loadGerencia,clientes:loadClientes,proyectos:loadProyectos,
  presupuesto:()=>{initPresupuesto();if(document.getElementById('pres-proyecto-sel').value)loadPresupuesto();},
  comparativa:()=>{initComparativa();if(document.getElementById('comp-proyecto-sel').value)loadComparativa();},
  tarifario:loadTarifario,cype:loadCype,interiorismo:loadInteriorismo,
  compras:loadCompras,subcontratas:loadSubcontratas,horas:loadHoras,
  pedidos:loadPedidos,control_horario:loadControlHorario,
  proveedores:loadProveedores,
  rentabilidad:()=>{initRentabilidad();if(document.getElementById('rent-proyecto-sel').value)loadRentabilidad();},
  facturas:loadFacturas,contabilidad:loadContabilidad,conciliacion:loadConciliacion,configuracion:loadConfiguracion,
  pres_final:async()=>{
    const sel=document.getElementById('pf-proyecto-sel');
    sel.innerHTML='<option value="">Cargando proyectosâ€¦</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      if(!PC.length){
        sel.innerHTML='<option value="">Sin proyectos â€” crea uno primero</option>';
        return;
      }
      sel.innerHTML='<option value="">Seleccionar proyectoâ€¦</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error al cargar: '+e.message+'</option>';
      toast('Error cargando proyectos: '+e.message,'error');
    }
  },
  contrato:async()=>{
    const sel=document.getElementById('ct-proyecto-sel');
    sel.innerHTML='<option value="">Cargandoâ€¦</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      sel.innerHTML='<option value="">Seleccionar proyectoâ€¦</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error: '+e.message+'</option>';
    }
  },
  pedido_doc:async()=>{
    PedC = await sbGet('pedidos','?order=fecha.desc').catch(()=>PedC||[]);
    poblarClientesDocumentos();
    // Si no hay pedido activo, iniciar en blanco
    if(!window.pdPedidoId){
      window.pdLineas=Array.from({length:20},()=>({cant:'',desc:''}));
      const today=new Date().toISOString().split('T')[0];
      const f=document.getElementById('pd-fecha-input');if(f&&!f.value)f.value=today;
    }
    renderPedidoLineas();
  },
  listas:()=>{
    const r=(id,arr)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(t=>`<div class="lista-item" data-val="${t}">${t}</div>`).join('');};
    r('trabajadores-list',TRABAJADORES);
    r('estados-list',LISTAS.estados_proyecto);
    r('tipos-proyecto-list',LISTAS.tipos_proyecto);
    r('formas-pago-list',LISTAS.formas_pago);
    r('tipos-cliente-list',LISTAS.tipos_cliente);
    r('tipos-proveedor-list',LISTAS.tipos_proveedor);
    r('estancias-list',LISTAS.estancias);
    r('categorias-list',LISTAS.categorias_tarifario);
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  const today=new Date().toISOString().split('T')[0];
  ['co-fecha','sc-fecha','h-fecha','f-fecha','ped-fecha'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
  await loadGerencia();
  // Cargar proveedores al inicio para tenerlos siempre disponibles
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  // Cargar trabajadores personalizados desde Supabase
  try{
    const allCfg=await sbGet('configuracion','?clave=in.(trabajadores,estados_proyecto,tipos_proyecto,formas_pago,tipos_cliente,tipos_proveedor,estancias,categorias_tarifario)');
    allCfg.forEach(row=>{
      const vals=row.valor.split(',').map(t=>t.trim()).filter(Boolean);
      if(row.clave==='trabajadores') TRABAJADORES=vals;
      else if(LISTAS[row.clave]) LISTAS[row.clave]=vals;
    });
  }catch(e){}
  populateSelects();
  populateIntCatalog();
  populateTrabajadores();
  populateAllListas();
  poblarFiltrosProyecto();
  poblarFiltrosCliente();
  poblarClientesDocumentos();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEJORA 1: ALERTAS DE RENTABILIDAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcularAlertas(){
  const body = document.getElementById('alertas-body');
  const countEl = document.getElementById('alertas-count');
  if(!body) return;
  try{
    const proyectos = PC.filter(p=>['En ejecuciÃ³n','Aprobado'].includes(p.estado));
    if(!proyectos.length){
      body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-soft)">Sin proyectos activos</div>';
      if(countEl) countEl.textContent='';
      return;
    }
    const alertas=[];
    for(const p of proyectos){
      const [lineas,compras,subcs,horas] = await Promise.all([
        sbGet('presupuesto_lineas',`?proyecto_id=eq.${p.proyecto_id}&version=eq.v1`),
        sbGet('compras',`?proyecto_id=eq.${p.proyecto_id}`),
        sbGet('subcontratas',`?proyecto_id=eq.${p.proyecto_id}`),
        sbGet('horas',`?proyecto_id=eq.${p.proyecto_id}`)
      ]);
      const presupuesto = lineas.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
      const coste = compras.reduce((s,c)=>s+(c.base_imponible||0),0)
                  + subcs.reduce((s,c)=>s+(c.importe||0),0)
                  + horas.reduce((s,h)=>s+(h.total||0),0);
      if(presupuesto<=0) continue;
      const pct = (coste/presupuesto)*100;
      const cliente = CC.find(c=>c.cliente_id===p.cliente_id);
      if(pct>=100){
        alertas.push({nivel:'rojo', icon:'ğŸ”´', msg:`<strong>${p.proyecto_id}</strong> â€” ${p.nombre} ha SUPERADO el presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado (${pct.toFixed(0)}%)`, pct, proyecto:p, cliente});
      } else if(pct>=85){
        alertas.push({nivel:'naranja', icon:'ğŸŸ ', msg:`<strong>${p.proyecto_id}</strong> â€” ${p.nombre} al ${pct.toFixed(0)}% del presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado â€” quedan ${fmt(presupuesto-coste)}`, pct, proyecto:p, cliente});
      } else if(pct>=70){
        alertas.push({nivel:'amarillo', icon:'ğŸŸ¡', msg:`<strong>${p.proyecto_id}</strong> â€” ${p.nombre} al ${pct.toFixed(0)}% del presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado â€” quedan ${fmt(presupuesto-coste)}`, pct, proyecto:p, cliente});
      }
    }
    if(!alertas.length){
      body.innerHTML='<div style="text-align:center;padding:20px;color:var(--green)">âœ… Todos los proyectos activos dentro del presupuesto</div>';
      if(countEl) countEl.textContent='Sin alertas';
      return;
    }
    alertas.sort((a,b)=>b.pct-a.pct);
    body.innerHTML=`<table style="width:100%;border-collapse:collapse">
      ${alertas.map(a=>`<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 14px;width:32px;font-size:18px">${a.icon}</td>
        <td style="padding:10px 8px">
          <div style="font-size:13px">${a.msg}</div>
          <div style="font-size:11px;color:var(--text-soft);margin-top:2px">${a.detalle} Â· ${a.cliente?.nombre||'â€”'}</div>
        </td>
        <td style="padding:10px 14px;text-align:right">
          <div style="background:var(--border);border-radius:4px;height:8px;width:120px;overflow:hidden;display:inline-block">
            <div style="height:8px;width:${Math.min(a.pct,100)}%;background:${a.nivel==='rojo'?'var(--red)':a.nivel==='naranja'?'var(--copper)':'var(--amber)'};border-radius:4px"></div>
          </div>
          <div style="font-size:11px;font-weight:700;color:${a.nivel==='rojo'?'var(--red)':a.nivel==='naranja'?'var(--copper)':'var(--amber)'};">${a.pct.toFixed(0)}%</div>
        </td>
        <td style="padding:10px 14px">
          <button class="btn btn-ghost btn-sm" onclick="navTo('rentabilidad');setTimeout(()=>{document.getElementById('rent-proyecto-sel').value='${a.proyecto.proyecto_id}';loadRentabilidad();},300)">Ver detalle</button>
        </td>
      </tr>`).join('')}
    </table>`;
    if(countEl) countEl.textContent=`${alertas.length} alerta${alertas.length>1?'s':''}`;
  }catch(e){ body.innerHTML=`<div style="padding:12px;color:var(--red)">Error: ${e.message}</div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEJORA 2: COMPARATIVA DE VERSIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function abrirComparativa(){
  const proy = document.getElementById('pres-proyecto-sel')?.value;
  if(!proy){ toast('Selecciona un proyecto primero','error'); return; }
  openModal('m-comparativa');
  const thead = document.getElementById('comp-thead');
  const tbody = document.getElementById('comp-tbody');
  const kpis  = document.getElementById('comp-kpis');
  thead.innerHTML='<tr style="background:var(--navy);color:white"><th style="padding:8px 10px;text-align:left">DescripciÃ³n</th><th style="padding:8px;text-align:right;width:80px">Ud.</th><th style="padding:8px;text-align:right">Med.</th><th style="padding:8px 10px;text-align:right;background:#b87333">v1 Total</th><th style="padding:8px 10px;text-align:right;background:#2e7d52">v2 Total</th><th style="padding:8px 10px;text-align:right;background:#1a5276">v3 Total</th><th style="padding:8px 10px;text-align:right">Î” v1â†’v2</th><th style="padding:8px 10px;text-align:right">Î” v1â†’v3</th></tr>';
  tbody.innerHTML='<tr><td colspan="8" class="loading">Cargandoâ€¦</td></tr>';
  kpis.innerHTML='';
  try{
    const [l1,l2,l3]=await Promise.all([
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v1&order=id.asc`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v2&order=id.asc`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v3&order=id.asc`)
    ]);
    const total = v => v.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
    const t1=total(l1), t2=total(l2), t3=total(l3);
    const hasV2=l2.length>0, hasV3=l3.length>0;
    // KPIs
    kpis.innerHTML=`
      <div class="kpi" style="background:#fff5e6"><div class="kpi-label">v1 Total</div><div class="kpi-value" style="color:#b87333">${fmt(t1)}</div></div>
      ${hasV2?`<div class="kpi" style="background:#e8f5ee"><div class="kpi-label">v2 Total</div><div class="kpi-value" style="color:var(--green)">${fmt(t2)}</div></div><div class="kpi" style="background:${t2>=t1?'#fdecea':'#e8f5ee'}"><div class="kpi-label">Î” v1â†’v2</div><div class="kpi-value" style="color:${t2>=t1?'var(--red)':'var(--green)'};">${t2>=t1?'+':''}${fmt(t2-t1)}</div></div>`:''}
      ${hasV3?`<div class="kpi" style="background:#eaf2fb"><div class="kpi-label">v3 Total</div><div class="kpi-value" style="color:#1a5276">${fmt(t3)}</div></div><div class="kpi" style="background:${t3>=t1?'#fdecea':'#e8f5ee'}"><div class="kpi-label">Î” v1â†’v3</div><div class="kpi-value" style="color:${t3>=t1?'var(--red)':'var(--green)'};">${t3>=t1?'+':''}${fmt(t3-t1)}</div></div>`:''}`;
    // Merge all descriptions from v1 as base
    if(!l1.length){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-soft)">Sin lÃ­neas en v1</td></tr>'; return; }
    tbody.innerHTML = l1.map(l=>{
      if(l.es_capitulo) return `<tr style="background:#1a2a3a;color:white"><td colspan="8" style="padding:7px 10px;font-weight:700">${l.descripcion||''}</td></tr>`;
      const match2 = l2.find(x=>x.descripcion===l.descripcion && !x.es_capitulo);
      const match3 = l3.find(x=>x.descripcion===l.descripcion && !x.es_capitulo);
      const s1=l.subtotal||0, s2=match2?.subtotal||0, s3=match3?.subtotal||0;
      const d12=s2-s1, d13=s3-s1;
      const cellStyle=(d)=>d>0?'color:var(--red);font-weight:700':d<0?'color:var(--green);font-weight:700':'color:var(--text-soft)';
      return `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:6px 10px;font-size:11px">${l.descripcion||'â€”'}</td>
        <td style="padding:6px 8px;text-align:right;font-size:11px;color:var(--text-soft)">${l.unidad||''}</td>
        <td style="padding:6px 8px;text-align:right;font-size:11px">${l.medicion||''}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;font-weight:700;background:#fffbf5">${s1?fmt(s1):'â€”'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;background:#f0faf4">${hasV2?(s2?fmt(s2):'â€”'):'â€”'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;background:#eaf4fb">${hasV3?(s3?fmt(s3):'â€”'):'â€”'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;${cellStyle(d12)}">${hasV2&&d12?((d12>0?'+':'')+fmt(d12)):'â€”'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;${cellStyle(d13)}">${hasV3&&d13?((d13>0?'+':'')+fmt(d13)):'â€”'}</td>
      </tr>`;
    }).join('');
  }catch(e){ tbody.innerHTML=`<tr><td colspan="8" style="color:var(--red);padding:12px">${e.message}</td></tr>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEJORA 4: ESTADO DE COBRO VISUAL EN FACTURAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function marcarFacturaCobrada(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const tot = (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);
  if(confirm(`Â¿Marcar factura ${f.num_factura} como cobrada (${fmt(tot)})?`)){
    sb('facturas','PATCH',{estado:'Cobrada',importe_cobrado:tot},null,`?id=eq.${id}`)
      .then(()=>{ toast('Factura marcada como cobrada âœ…'); loadFacturas(); })
      .catch(e=>toast('Error: '+e.message,'error'));
  }
}

function marcarFacturaParcial(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const tot = (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);
  const imp = prompt(`Importe cobrado parcialmente (total: ${fmt(tot)} â‚¬):`);
  if(!imp) return;
  const val = parseFloat(imp.replace(',','.'));
  if(isNaN(val)||val<=0){ toast('Importe no vÃ¡lido','error'); return; }
  const estado = val>=tot?'Cobrada':'Parcial';
  sb('facturas','PATCH',{estado,importe_cobrado:val},null,`?id=eq.${id}`)
    .then(()=>{ toast(`Cobro registrado: ${fmt(val)} âœ…`); loadFacturas(); })
    .catch(e=>toast('Error: '+e.message,'error'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEJORA 5: INFORME MENSUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generarInformeMensual(){
  const mes  = document.getElementById('inf-mes')?.value;
  const anyo = document.getElementById('inf-anyo')?.value;
  if(!mes||!anyo){ toast('Selecciona mes y aÃ±o','error'); return; }
  const desde = `${anyo}-${String(mes).padStart(2,'0')}-01`;
  const hasta = new Date(anyo, mes, 0).toISOString().split('T')[0];
  const body = document.getElementById('inf-body');
  body.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-soft)">Cargando datosâ€¦</div>';
  try{
    const [facs,comps,subcs,hors] = await Promise.all([
      sbGet('facturas',`?fecha_emision=gte.${desde}&fecha_emision=lte.${hasta}`),
      sbGet('compras', `?fecha=gte.${desde}&fecha=lte.${hasta}`),
      sbGet('subcontratas',`?fecha=gte.${desde}&fecha=lte.${hasta}`),
      sbGet('horas',   `?fecha=gte.${desde}&fecha=lte.${hasta}`)
    ]);
    const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const nombreMes = meses[parseInt(mes)-1];
    const ingresos = facs.reduce((s,f)=>s+(f.base_imponible||0),0);
    const ivaRep   = facs.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const cobrado  = facs.reduce((s,f)=>s+(f.importe_cobrado||0),0);
    const compTotal= comps.reduce((s,c)=>s+(c.base_imponible||0),0);
    const ivaSop   = comps.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const subcTotal= subcs.reduce((s,c)=>s+(c.importe||0),0);
    const horasTotal=hors.reduce((s,h)=>s+(h.total||0),0);
    const costTotal= compTotal+subcTotal+horasTotal;
    const beneficio= ingresos-costTotal;
    const saldoIva = ivaRep-ivaRep*0; // IVA repercutido - IVA soportado (simplificado)
    body.innerHTML=`
      <div style="font-family:Arial,sans-serif;max-width:700px">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #1a2a3a;padding-bottom:10px;margin-bottom:16px">
          <div><div style="font-size:16px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div><div style="font-size:10px;color:#666">CIF B-56909641</div></div>
          <div style="text-align:right"><div style="font-size:15px;font-weight:700;color:#b87333">INFORME MENSUAL</div><div style="font-size:12px;color:#666">${nombreMes} ${anyo}</div></div>
        </div>
        <!-- INGRESOS -->
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#1a2a3a;background:#f7f4ef;padding:6px 10px;border-radius:4px;margin-bottom:6px">ğŸ“ˆ INGRESOS</div>
          <table style="width:100%;font-size:12px">
            <tr><td style="padding:4px 10px">FacturaciÃ³n base imponible</td><td style="text-align:right;font-weight:700;padding:4px 10px">${fmt(ingresos)}</td></tr>
            <tr><td style="padding:4px 10px;color:#666">IVA repercutido (21%)</td><td style="text-align:right;padding:4px 10px;color:#666">${fmt(ivaRep)}</td></tr>
            <tr style="border-top:1px solid #eee"><td style="padding:6px 10px;font-weight:700">Total facturado (con IVA)</td><td style="text-align:right;font-weight:700;padding:6px 10px">${fmt(ingresos+ivaRep)}</td></tr>
            <tr><td style="padding:4px 10px;color:var(--green)">Cobrado en este periodo</td><td style="text-align:right;padding:4px 10px;color:var(--green);font-weight:700">${fmt(cobrado)}</td></tr>
          </table>
        </div>
        <!-- GASTOS -->
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#1a2a3a;background:#f7f4ef;padding:6px 10px;border-radius:4px;margin-bottom:6px">ğŸ“‰ GASTOS</div>
          <table style="width:100%;font-size:12px">
            <tr><td style="padding:4px 10px">Compras a proveedores (base)</td><td style="text-align:right;padding:4px 10px">${fmt(compTotal)}</td></tr>
            <tr><td style="padding:4px 10px;color:#666">IVA soportado compras</td><td style="text-align:right;padding:4px 10px;color:#666">${fmt(ivaRep>0?ivaRep*0.4:ivaRep)}</td></tr>
            <tr><td style="padding:4px 10px">Subcontratas</td><td style="text-align:right;padding:4px 10px">${fmt(subcTotal)}</td></tr>
            <tr><td style="padding:4px 10px">Mano de obra propia</td><td style="text-align:right;padding:4px 10px">${fmt(horasTotal)}</td></tr>
            <tr style="border-top:1px solid #eee"><td style="padding:6px 10px;font-weight:700">Total gastos</td><td style="text-align:right;font-weight:700;padding:6px 10px">${fmt(costTotal)}</td></tr>
          </table>
        </div>
        <!-- RESULTADO -->
        <div style="background:${beneficio>=0?'#e8f5ee':'#fdecea'};padding:12px 16px;border-radius:6px;margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;font-size:14px">RESULTADO DEL MES</div>
            <div style="font-size:18px;font-weight:700;color:${beneficio>=0?'var(--green)':'var(--red)'}">${fmt(beneficio)}</div>
          </div>
          <div style="font-size:11px;color:#666;margin-top:4px">Margen: ${ingresos>0?((beneficio/ingresos)*100).toFixed(1):0}%</div>
        </div>
        <!-- ACTIVIDAD -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${facs.length}</div>
            <div style="font-size:11px;color:#666">Facturas emitidas</div>
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${comps.length}</div>
            <div style="font-size:11px;color:#666">Compras registradas</div>
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${hors.reduce((s,h)=>s+(h.horas||0),0)}h</div>
            <div style="font-size:11px;color:#666">Horas trabajadas</div>
          </div>
        </div>
        <div style="font-size:10px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:8px">
          Informe generado el ${new Date().toLocaleDateString('es-ES')} Â· PAU INTERIORISMO S.L. Â· CIF B-56909641
        </div>
      </div>`;
  }catch(e){ body.innerHTML=`<div style="color:var(--red);padding:12px">Error: ${e.message}</div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASCADA CLIENTE â†’ PROYECTO EN MODAL FACTURA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function cascadaClienteFactura(){
  const clienteId = document.getElementById('f-cliente')?.value;
  const proyEl    = document.getElementById('f-proyecto');
  if(!proyEl) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proyEl.innerHTML = '<option value="">â€” Sin proyecto â€”</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  // Si solo hay un proyecto para ese cliente, seleccionarlo automÃ¡ticamente
  if(clienteId && filtrados.length===1){
    proyEl.value = filtrados[0].proyecto_id;
  }
}

// Llamar tambiÃ©n al abrir el modal para que el proyecto ya estÃ© filtrado
const _origAbrirNuevaFactura = abrirNuevaFactura;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASCADA CLIENTE â†’ PROYECTO EN COMPARATIVA OFERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function cascadaClienteComparativa(){
  const clienteSel = document.getElementById('filter-cliente-comparativa');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('comp-proyecto-sel');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">ğŸ“ Proyectoâ€¦</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
  // Reset lista
  const btn = document.getElementById('btn-nueva-comparativa');
  if(btn) btn.style.display='none';
  document.getElementById('comp-list').innerHTML=
    '<div class="empty"><div class="empty-icon">âš–ï¸</div><div class="empty-text">Selecciona un proyecto</div></div>';
}

function abrirNuevaComparativa(){
  const proyId   = document.getElementById('comp-proyecto-sel')?.value;
  const clienteId= document.getElementById('filter-cliente-comparativa')?.value;

  // 1. Poblar clientes en el modal PRIMERO
  poblarClientesModalCmp();

  // 2. Setear cliente seleccionado
  const cmpCliente = document.getElementById('cmp-cliente');
  if(cmpCliente && clienteId){
    cmpCliente.value = clienteId;
    // 3. Filtrar proyectos por ese cliente
    cascadaClienteModalCmp();
  } else {
    // Si no hay cliente, poblar todos los proyectos
    const proySel = document.getElementById('cmp-proyecto');
    if(proySel){
      proySel.innerHTML='<option value="">Seleccionarâ€¦</option>'
        +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
    }
  }

  // 4. Setear proyecto seleccionado
  const cmpProy = document.getElementById('cmp-proyecto');
  if(cmpProy && proyId){
    cmpProy.value = proyId;
  }

  // 5. Poblar proveedores
  poblarProveedoresComparativa();

  // 6. Reset campos del formulario
  document.getElementById('cmp-id').value='';
  document.getElementById('cmp-trabajo').value='';
  [1,2,3].forEach(n=>{
    const pvpEl=document.getElementById(`o${n}-pvp`);     if(pvpEl) pvpEl.value='';
    const dtoEl=document.getElementById(`o${n}-dto`);     if(dtoEl) dtoEl.value='0';
    const cbEl =document.getElementById(`o${n}-costebase`);if(cbEl) cbEl.value='';
    const mkEl =document.getElementById(`o${n}-mk`);      if(mkEl)  mkEl.value='0';
    const notEl=document.getElementById(`o${n}-notas`);   if(notEl) notEl.value='';
    // Reset resultados
    ['res-coste','res-venta','res-margen','res-pct'].forEach(k=>{
      const el=document.getElementById(`o${n}-${k}`); if(el) el.textContent='â€”';
    });
    // Reset border
    const col=document.getElementById(`cmp-col-${n}`);
    if(col){ col.style.borderColor='var(--border)'; col.style.borderWidth='1px'; }
  });
  const info=document.getElementById('cmp-ganadora-info');
  if(info) info.innerHTML='';

  openModal('m-comparativa');
}

// Override loadComparativa para tambiÃ©n mostrar botÃ³n nueva comparativa
const _origLoadComparativa = loadComparativa;
async function loadComparativa(){
  const proy = document.getElementById('comp-proyecto-sel')?.value;
  const btn  = document.getElementById('btn-nueva-comparativa');
  if(btn) btn.style.display = proy ? '' : 'none';
  await _origLoadComparativa();
}

// Poblar clientes en comparativa al inicializar
function poblarClientesComparativa(){
  const sel = document.getElementById('filter-cliente-comparativa');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">ğŸ‘¤ Clienteâ€¦</option>'
    + CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
  if(cur) sel.value = cur;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENCIMIENTOS MÃšLTIPLES EN FACTURAS DE COMPRA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Sugiere los prÃ³ximos dÃ­as de pago (5 y 20) a partir de hoy
function sugerirDiasPago(){
  const baseInput = document.getElementById('f-fecha');
  const baseVal   = baseInput?.value || new Date().toISOString().split('T')[0];
  const base      = new Date(baseVal);
  const hoy       = new Date();
  const ref        = base > hoy ? base : hoy;

  // Generar los prÃ³ximos 4 dÃ­as de pago a partir de ref
  const sugerencias = [];
  let cursor = new Date(ref);
  while(sugerencias.length < 4){
    for(const dia of [...DIAS_PAGO].sort((a,b)=>a-b)){
      const candidata = new Date(cursor.getFullYear(), cursor.getMonth(), dia);
      if(candidata > ref && sugerencias.length < 4){
        sugerencias.push(candidata.toISOString().split('T')[0]);
      }
    }
    cursor.setMonth(cursor.getMonth()+1);
    if(cursor.getMonth() > ref.getMonth() + 12) break; // safety
  }

  // Rellenar los campos de vencimiento en gris (placeholder visual)
  const ids = ['f-vto','f-vto2','f-vto3','f-vto4'];
  sugerencias.forEach((fecha, i) => {
    const el = document.getElementById(ids[i]);
    if(el){ el.value = fecha; el.style.color='var(--text-soft)'; }
  });

  // Distribuir importe total en partes iguales
  const base2 = parseFloat(document.getElementById('f-base')?.value)||0;
  const iva   = ivaPct(document.getElementById('f-iva')?.value||'21%');
  const total = base2*(1+iva/100);
  if(total > 0){
    const parte = (total / sugerencias.length).toFixed(2);
    ['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'].forEach((id,i)=>{
      const el=document.getElementById(id);
      if(el && i < sugerencias.length){
        el.value = i < sugerencias.length-1 ? parte : (total - parte*(sugerencias.length-1)).toFixed(2);
        el.style.color='var(--text-soft)';
      }
    });
  }
  toast(`Sugeridos ${sugerencias.length} vencimientos: dÃ­as ${DIAS_PAGO[0]} y ${DIAS_PAGO[1]} âœ…`);
}

// Confirmar vencimiento (quitar estilo gris cuando el usuario hace click)
function confirmarVto(id){
  const el = document.getElementById(id);
  if(el) el.style.color = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃAS DE PAGO & CÃLCULO VENCIMIENTO GIRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// DÃ­as de pago globales (por defecto 5 y 20, editables en ConfiguraciÃ³n)
let DIAS_PAGO = [5, 20];

async function loadDiasPago(){
  try{
    const cfg = await sbGet('configuracion','?clave=in.(dia_pago_1,dia_pago_2)');
    cfg.forEach(row=>{
      if(row.clave==='dia_pago_1') DIAS_PAGO[0]=parseInt(row.valor)||5;
      if(row.clave==='dia_pago_2') DIAS_PAGO[1]=parseInt(row.valor)||20;
    });
    const d1=document.getElementById('cfg-dia1'), d2=document.getElementById('cfg-dia2');
    if(d1) d1.value=DIAS_PAGO[0];
    if(d2) d2.value=DIAS_PAGO[1];
  }catch(e){}
}

async function saveDiasPago(){
  const d1=parseInt(document.getElementById('cfg-dia1')?.value)||5;
  const d2=parseInt(document.getElementById('cfg-dia2')?.value)||20;
  DIAS_PAGO=[d1,d2];
  try{
    await upsertConfig('dia_pago_1',String(d1));
    await upsertConfig('dia_pago_2',String(d2));
    toast(`DÃ­as de pago guardados: ${d1} y ${d2} de cada mes âœ…`);
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// Calcula fecha vencimiento segÃºn forma de pago y dÃ­as de pago configurados
function calcularVencimientoGiro(fechaEmision, formaPago){
  if(!fechaEmision) return null;
  const base = new Date(fechaEmision);
  let diasPlazo = 0;
  if(formaPago==='Giro 30 dÃ­as')  diasPlazo=30;
  else if(formaPago==='Giro 60 dÃ­as')  diasPlazo=60;
  else if(formaPago==='Giro 90 dÃ­as')  diasPlazo=90;
  else if(formaPago==='Giro 120 dÃ­as') diasPlazo=120;
  else return null; // No es giro

  // Sumar dÃ­as al plazo
  const fechaBase = new Date(base);
  fechaBase.setDate(fechaBase.getDate() + diasPlazo);

  // Buscar el siguiente dÃ­a de pago (5 o 20) igual o posterior
  const dias = [...DIAS_PAGO].sort((a,b)=>a-b);
  let mejor = null;
  // Buscar en el mes actual y siguiente
  for(let deltaM=0; deltaM<=2; deltaM++){
    const mes = fechaBase.getMonth() + deltaM;
    const anyo = fechaBase.getFullYear() + Math.floor((fechaBase.getMonth()+deltaM)/12);
    const mesReal = mes % 12;
    for(const dia of dias){
      const candidata = new Date(anyo, mesReal, dia);
      if(candidata >= fechaBase){
        if(!mejor || candidata < mejor) mejor = candidata;
      }
    }
    if(mejor) break;
  }
  if(!mejor) return null;
  return mejor.toISOString().split('T')[0];
}

// Auto-calcular vencimiento al cambiar forma de pago en modal factura
function onFormaPagoChange(){
  const forma = document.getElementById('f-pago')?.value;
  const fecha = document.getElementById('f-fecha')?.value;
  const vtoEl = document.getElementById('f-vto');
  if(!vtoEl) return;
  const vto = calcularVencimientoGiro(fecha, forma);
  if(vto){
    const tipoFac = document.getElementById('f-tipo')?.value;
    const targetVtoId = tipoFac==='Compra' ? 'f-vto' : 'f-vto-venta';
    const targetVtoEl = document.getElementById(targetVtoId);
    if(targetVtoEl) targetVtoEl.value = vto;
    toast(`Vencimiento calculado: ${fmtD(vto)} (${forma} Â· dÃ­as de pago: ${DIAS_PAGO.join(' y ')})`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONCILIACIÃ“N BANCARIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadConciliacion(){
  const dias = document.getElementById('venc-filtro')?.value || '30';
  const tbody = document.getElementById('venc-tbody');
  const hoy = new Date();

  try{
    // Cargar todas las facturas de compra pendientes
    const facturas = await sbGet('facturas','?tipo_factura=eq.Compra&estado=in.(Pendiente,Parcial,Vencida)&order=fecha_vencimiento.asc');
    // Cargar tambiÃ©n compras pendientes
    const compras  = await sbGet('compras','?estado_pago=in.(Pendiente,Parcial,Vencido)&order=fecha_vencimiento.asc');

    // Combinar ambas fuentes como "pagos pendientes"
    const pendientes = [
      ...facturas.map(f=>({
        id: f.id, tipo:'factura',
        proveedor: f.proveedor_id||'â€”',
        concepto:  f.concepto||f.num_factura||'â€”',
        forma_pago: f.forma_pago||'â€”',
        proyecto:  f.proyecto_id||'â€”',
        base:      f.base_imponible||0,
        total:     (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),
        vto:       f.fecha_vencimiento,
        estado:    f.estado,
        num:       f.num_factura||'â€”',
        iva_pct:   f.iva_pct||'21%'
      })),
      ...compras.map(c=>({
        id: c.id, tipo:'compra',
        proveedor: c.proveedor_id||'â€”',
        concepto:  c.concepto||'â€”',
        forma_pago:'â€”',
        proyecto:  c.proyecto_id||'â€”',
        base:      c.base_imponible||0,
        total:     (c.base_imponible||0)*(1+ivaPct(c.iva_pct)/100),
        vto:       c.fecha_vencimiento,
        estado:    c.estado_pago,
        num:       '(Compra)',
        iva_pct:   c.iva_pct||'21%'
      }))
    ].sort((a,b)=>{
      if(!a.vto) return 1; if(!b.vto) return -1;
      return new Date(a.vto)-new Date(b.vto);
    });

    // Filtrar segÃºn selecciÃ³n
    const limite = dias==='todos' ? null : new Date(hoy.getTime()+parseInt(dias)*86400000);
    const filtrados = limite ? pendientes.filter(p=>p.vto && new Date(p.vto)<=limite) : pendientes;

    // KPIs
    const semana = new Date(hoy.getTime()+7*86400000);
    const mesEnd  = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);
    const kSemana  = pendientes.filter(p=>p.vto&&new Date(p.vto)<=semana).reduce((s,p)=>s+p.total,0);
    const kMes     = pendientes.filter(p=>p.vto&&new Date(p.vto)<=mesEnd).reduce((s,p)=>s+p.total,0);
    const kPend    = pendientes.reduce((s,p)=>s+p.total,0);

    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    sv('conc-semana', fmt(kSemana));
    sv('conc-mes',    fmt(kMes));
    sv('conc-pendientes', fmt(kPend));
    sv('venc-count', `${filtrados.length} pagos`);

    // Facturas pagadas este mes
    const mesStart = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
    const pagadasMes = await sbGet('facturas',`?tipo_factura=eq.Compra&estado=eq.Pagada&fecha_vencimiento=gte.${mesStart}`);
    sv('conc-pagadas', fmt(pagadasMes.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0)));

    if(!filtrados.length){
      tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;padding:30px;color:var(--text-soft)">
        <div style="font-size:28px;margin-bottom:8px">âœ…</div>
        <div>Sin vencimientos en este periodo</div>
      </td></tr>`;
      return;
    }

    tbody.innerHTML = filtrados.map(p=>{
      const vtoDate = p.vto ? new Date(p.vto) : null;
      const diffDias = vtoDate ? Math.round((vtoDate-hoy)/86400000) : null;
      let urgencia='', urgColor='';
      if(diffDias!==null){
        if(diffDias<0){  urgencia=`<span style="color:var(--red);font-weight:700">Vencida hace ${Math.abs(diffDias)}d</span>`; urgColor='var(--red)'; }
        else if(diffDias<=7){ urgencia=`<span style="color:var(--red);font-weight:700">En ${diffDias}d ğŸ”´</span>`; urgColor='var(--red)'; }
        else if(diffDias<=30){ urgencia=`<span style="color:var(--amber);font-weight:700">En ${diffDias}d ğŸŸ </span>`; urgColor='var(--amber)'; }
        else { urgencia=`<span style="color:var(--text-soft)">En ${diffDias}d</span>`; urgColor=''; }
      }
      return `<tr style="border-bottom:1px solid var(--border);${urgColor?'background:#fff9f9':''}">
        <td style="padding:8px 10px;font-weight:700;color:${urgColor||'var(--navy)'}">
          ${p.vto?fmtD(p.vto):'Sin fecha'}
        </td>
        <td style="padding:8px 6px">${urgencia}</td>
        <td style="padding:8px 6px">${p.proveedor}</td>
        <td style="padding:8px 6px;font-size:11px;color:var(--text-soft)">${p.concepto}</td>
        <td style="padding:8px 6px"><span class="badge b-gray" style="font-size:10px">${p.forma_pago}</span></td>
        <td style="padding:8px 6px;color:var(--text-soft);font-size:11px">${p.proyecto}</td>
        <td style="padding:8px 6px" class="td-mono">${fmt(p.base)}</td>
        <td style="padding:8px 6px" class="td-mono" style="font-weight:700">${fmt(p.total)}</td>
        <td>${bE(p.estado)}</td>
        <td style="padding:8px 6px">
          <button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--green)" 
            onclick="marcarPagado('${p.tipo}','${p.id}',${p.total.toFixed(2)})">âœ… Pagado</button>
        </td>
      </tr>`;
    }).join('');

  }catch(e){
    tbody.innerHTML=`<tr><td colspan="10" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;
  }
}

async function marcarPagado(tipo, id, total){
  if(!confirm(`Â¿Confirmar pago de ${fmt(total)}?`)) return;
  try{
    if(tipo==='factura'){
      await sb('facturas','PATCH',{estado:'Pagada',importe_cobrado:total},null,`?id=eq.${id}`);
    } else {
      await sb('compras','PATCH',{estado_pago:'Pagado'},null,`?id=eq.${id}`);
    }
    toast('Pago registrado âœ…');
    loadConciliacion();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// â”€â”€ IMPORTAR CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let movimientosBanco = [];
let conciliacionPendiente = [];

function procesarCSV(){
  const file = document.getElementById('csv-input')?.files[0];
  const formato = document.getElementById('banco-formato')?.value || 'generico';
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = async (e) => {
    const text = e.target.result;
    const preview = document.getElementById('csv-preview');
    if(preview){
      preview.style.display='block';
      preview.textContent = text.split('\n').slice(0,5).join('\n');
    }
    movimientosBanco = parsearCSV(text, formato);
    if(!movimientosBanco.length){
      toast('No se encontraron movimientos en el CSV','error'); return;
    }
    toast(`${movimientosBanco.length} movimientos detectados. Conciliandoâ€¦`);
    await conciliarMovimientos();
  };
  reader.readAsText(file, 'UTF-8');
}

function parsearCSV(texto, formato){
  const lineas = texto.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  const movimientos = [];
  // Detectar separador
  const sep = texto.includes(';') ? ';' : ',';

  for(let i=1; i<lineas.length; i++){
    const cols = lineas[i].split(sep).map(c=>c.replace(/"/g,'').trim());
    if(cols.length<3) continue;
    let fecha='', concepto='', importe=0;
    try{
      if(formato==='bbva'){
        // BBVA: Fecha, Concepto, Importe, Disponible
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else if(formato==='caixabank'){
        // CaixaBank: Fecha operaciÃ³n, Fecha valor, DescripciÃ³n, Importe, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[2]||'';
        importe = parseFloat((cols[3]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else if(formato==='santander'){
        // Santander: Fecha, Concepto, Cargo, Abono, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        const cargo = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
        const abono = parseFloat((cols[3]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
        importe = abono - cargo;
      } else if(formato==='sabadell'){
        // Sabadell: Fecha, DescripciÃ³n, Importe, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else {
        // GenÃ©rico: fecha, concepto, importe
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      }
      if(fecha && importe<0){ // Solo cargos (pagos salientes)
        movimientos.push({ fecha, concepto, importe: Math.abs(importe) });
      }
    }catch(err){}
  }
  return movimientos;
}

function normalizarFecha(str){
  if(!str) return '';
  // dd/mm/yyyy â†’ yyyy-mm-dd
  const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1) return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  // yyyy-mm-dd ya correcto
  const m2 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m2) return str;
  return str;
}

async function conciliarMovimientos(){
  if(!movimientosBanco.length) return;
  // Cargar facturas de compra pendientes
  const facturas = await sbGet('facturas','?tipo_factura=eq.Compra&estado=in.(Pendiente,Parcial,Vencida)');
  const compras  = await sbGet('compras','?estado_pago=in.(Pendiente,Parcial,Vencido)');
  const pendientes = [
    ...facturas.map(f=>({
      id:f.id, tipo:'factura', num:f.num_factura||'â€”',
      proveedor:f.proveedor_id||'â€”', total:(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),
      vto:f.fecha_vencimiento
    })),
    ...compras.map(c=>({
      id:c.id, tipo:'compra', num:'(Compra)',
      proveedor:c.proveedor_id||'â€”', total:(c.base_imponible||0)*(1+ivaPct(c.iva_pct)/100),
      vto:c.fecha_vencimiento
    }))
  ];

  conciliacionPendiente = [];
  const resultados = [];

  for(const mov of movimientosBanco){
    // Buscar factura con importe similar (Â±2% tolerancia) y fecha prÃ³xima (Â±15 dÃ­as)
    const movFecha = new Date(mov.fecha);
    let mejor = null, mejorScore = 0;

    for(const pend of pendientes){
      // Score por importe
      const diff = Math.abs(mov.importe - pend.total);
      const pctDiff = pend.total>0 ? diff/pend.total : 1;
      if(pctDiff > 0.05) continue; // MÃ¡s del 5% de diferencia â†’ descartamos

      // Score por fecha (cuanto mÃ¡s cercana al vencimiento, mejor)
      let scoreFecha = 0.5;
      if(pend.vto){
        const vtoFecha = new Date(pend.vto);
        const diasDiff = Math.abs((movFecha-vtoFecha)/86400000);
        if(diasDiff<=3) scoreFecha=1.0;
        else if(diasDiff<=7) scoreFecha=0.9;
        else if(diasDiff<=15) scoreFecha=0.7;
        else if(diasDiff<=30) scoreFecha=0.5;
        else scoreFecha=0.2;
      }
      const score = (1-pctDiff)*0.6 + scoreFecha*0.4;
      if(score > mejorScore){ mejorScore=score; mejor=pend; }
    }

    const confianza = mejorScore>=0.85?'Alta':mejorScore>=0.65?'Media':mejorScore>=0.4?'Baja':null;
    resultados.push({ mov, factura:mejor, score:mejorScore, confianza });
    if(mejor && confianza && confianza!=='Baja'){
      conciliacionPendiente.push({ movimiento:mov, factura:mejor, confianza });
    }
  }

  // Renderizar resultados
  const tbody = document.getElementById('conc-tbody');
  const resDiv = document.getElementById('conc-resultados');
  const btnAplicar = document.getElementById('btn-aplicar-conc');
  const resCount = document.getElementById('conc-res-count');
  if(resDiv) resDiv.style.display='block';
  const matchCount = resultados.filter(r=>r.factura).length;
  if(resCount) resCount.textContent=`${movimientosBanco.length} movimientos Â· ${matchCount} coincidencias encontradas`;
  if(btnAplicar) btnAplicar.style.display = conciliacionPendiente.length ? '' : 'none';

  tbody.innerHTML = resultados.map((r,i)=>{
    const confianzaColor = r.confianza==='Alta'?'var(--green)':r.confianza==='Media'?'var(--amber)':'var(--red)';
    const diff = r.factura ? (r.mov.importe - r.factura.total) : null;
    return `<tr style="border-bottom:1px solid var(--border);${r.confianza==='Alta'?'background:#f0faf4':r.confianza==='Media'?'background:#fffbf0':''}">
      <td style="padding:8px 10px">
        <input type="checkbox" id="conc-chk-${i}" ${r.confianza&&r.confianza!=='Baja'?'checked':''} 
          data-idx="${i}" style="width:16px;height:16px;cursor:pointer">
      </td>
      <td style="padding:8px 8px;font-size:12px">${fmtD(r.mov.fecha)}</td>
      <td style="padding:8px 8px;font-size:11px;color:var(--text-soft);max-width:200px">${r.mov.concepto}</td>
      <td style="padding:8px 8px" class="td-mono"><strong>${fmt(r.mov.importe)}</strong></td>
      <td style="padding:8px 8px;font-size:11px">${r.factura?`${r.factura.num} (${r.factura.tipo})`:'<span style="color:var(--text-soft)">Sin coincidencia</span>'}</td>
      <td style="padding:8px 8px;font-size:11px">${r.factura?r.factura.proveedor:'â€”'}</td>
      <td style="padding:8px 8px;font-size:11px" class="td-mono">${diff!==null?`<span style="color:${Math.abs(diff)<0.01?'var(--green)':'var(--amber)'}">
        ${diff>=0?'+':''}${fmt(diff)}</span>`:'â€”'}</td>
      <td style="padding:8px 8px">${r.confianza?`<span style="font-weight:700;color:${confianzaColor}">${r.confianza}</span>`:'<span style="color:var(--text-soft)">â€”</span>'}</td>
    </tr>`;
  }).join('');
}

async function aplicarConciliacion(){
  const checkboxes = document.querySelectorAll('[id^="conc-chk-"]:checked');
  const idxs = [...checkboxes].map(cb=>parseInt(cb.dataset.idx));
  // Rebuild from current results
  const tbody = document.getElementById('conc-tbody');
  const rows = tbody.querySelectorAll('tr');
  let aplicados = 0;
  for(const c of conciliacionPendiente){
    try{
      if(c.factura.tipo==='factura'){
        await sb('facturas','PATCH',{estado:'Pagada',importe_cobrado:c.factura.total},null,`?id=eq.${c.factura.id}`);
      } else {
        await sb('compras','PATCH',{estado_pago:'Pagado'},null,`?id=eq.${c.factura.id}`);
      }
      aplicados++;
    }catch(e){}
  }
  toast(`${aplicados} pago(s) marcados como pagados âœ…`);
  conciliacionPendiente=[];
  document.getElementById('conc-resultados').style.display='none';
  document.getElementById('csv-input').value='';
  document.getElementById('csv-preview').style.display='none';
  loadConciliacion();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORTADOR HOLDED - FACTURAS DE COMPRA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let holdedRows = []; // Filas parseadas del archivo Holded

// Poblar selector de proyecto en modal Holded al abrir
function initImportHolded(){
  const sel = document.getElementById('holded-proyecto-default');
  if(!sel) return;
  sel.innerHTML = '<option value="">â€” Sin proyecto por defecto â€”</option>'
    + PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} Â· ${p.nombre}</option>`).join('');
}

// Override openModal para inicializar el importador
const _origOpenModalBase = openModal;
// (openModal ya fue overrideado antes para comparativa â€” encadenamos)
const _prevOpenModal = openModal;
openModal = function(id){
  if(id === 'm-importar-holded') initImportHolded();
  _prevOpenModal(id);
};

async function procesarArchivoHolded(){
  const file = document.getElementById('holded-file')?.files[0];
  if(!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  let rows = [];

  if(ext === 'csv'){
    const text = await file.text();
    rows = parsearCSVHolded(text);
  } else if(ext === 'xlsx' || ext === 'xls'){
    rows = await parsearXLSXHolded(file);
  } else {
    toast('Formato no soportado. Usa Excel (.xlsx) o CSV.', 'error');
    return;
  }

  if(!rows.length){
    toast('No se encontraron facturas en el archivo.', 'error');
    return;
  }

  holdedRows = rows;
  renderPreviewHolded(rows);
}

function parsearCSVHolded(text){
  const lineas = text.split('
').map(l=>l.trim()).filter(l=>l);
  if(lineas.length < 2) return [];
  const sep = text.includes(';') ? ';' : ',';
  const headers = lineas[0].split(sep).map(h=>h.replace(/"/g,'').trim().toLowerCase());
  const rows = [];
  for(let i=1;i<lineas.length;i++){
    const cols = lineas[i].split(sep).map(c=>c.replace(/"/g,'').trim());
    const obj = {};
    headers.forEach((h,j)=>{ obj[h]=cols[j]||''; });
    rows.push(mapearCamposHolded(obj));
  }
  return rows.filter(r=>r.num_factura);
}

async function parsearXLSXHolded(file){
  // Usar SheetJS si estÃ¡ disponible, sino leer como CSV
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        // Intentar parsear como CSV primero (Holded a veces exporta CSV con extensiÃ³n xls)
        const text = e.target.result;
        if(typeof text === 'string'){
          resolve(parsearCSVHolded(text));
          return;
        }
        // Si es binario, usar SheetJS
        const data = new Uint8Array(e.target.result);
        if(typeof XLSX !== 'undefined'){
          const wb = XLSX.read(data, {type:'array', cellDates:true});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, {raw:false, dateNF:'yyyy-mm-dd'});
          const rows = json.map(obj=>{
            const lower = {};
            Object.keys(obj).forEach(k=>{ lower[k.toLowerCase().trim()]=String(obj[k]||'').trim(); });
            return mapearCamposHolded(lower);
          }).filter(r=>r.num_factura);
          resolve(rows);
        } else {
          toast('Para archivos .xlsx instala SheetJS. Usa la exportaciÃ³n CSV de Holded.','error');
          resolve([]);
        }
      }catch(e){ resolve([]); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// Mapear columnas de Holded a nuestro esquema
// Holded exporta columnas como: NÃºmero, Fecha, Proveedor, Concepto/DescripciÃ³n,
// Base imponible, %IVA, Cuota IVA, Total, Fecha vencimiento, Estado
function mapearCamposHolded(obj){
  // Buscar campos con distintos nombres posibles que usa Holded
  const get = (...keys) => {
    for(const k of keys){
      const val = obj[k] || obj[k.toLowerCase()] || obj[k.toUpperCase()];
      if(val && val.toString().trim()) return val.toString().trim();
    }
    return '';
  };

  const num    = get('nÃºmero','numero','number','num. factura','nÂº factura','invoice number','factura','doc. number','docnumber','nÂº','num');
  const fecha  = normalizarFechaHolded(get('fecha','date','fecha emision','fecha emisiÃ³n','fecha factura','issue date'));
  const prov   = get('proveedor','supplier','contact','contacto','nombre proveedor','vendor','empresa');
  const conc   = get('concepto','descripciÃ³n','descripcion','description','concept','lÃ­nea','linea');
  const base   = parseFloat(get('base imponible','base','taxable base','importe','subtotal','base imp.').replace(',','.').replace(/[^0-9.-]/g,''))||0;
  const ivaPctRaw = get('%iva','iva %','tax %','iva','vat','tax rate','tipo iva');
  const ivaPct = ivaPctRaw ? (ivaPctRaw.includes('%')?ivaPctRaw:(ivaPctRaw+'%')) : '21%';
  const total  = parseFloat(get('total','importe total','amount','total factura').replace(',','.').replace(/[^0-9.-]/g,''))||0;
  const vto    = normalizarFechaHolded(get('vencimiento','fecha vencimiento','due date','fecha vto'));
  const estado = mapearEstadoHolded(get('estado','status','estado pago'));

  return { num_factura:num, fecha_emision:fecha, proveedor_id:prov,
           concepto:conc, base_imponible:base, iva_pct:ivaPct,
           total_calculado:total, fecha_vencimiento:vto, estado, tipo_factura:'Compra' };
}

function normalizarFechaHolded(str){
  if(!str) return '';
  // dd/mm/yyyy
  const m1 = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
  if(m1) return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  // yyyy-mm-dd
  const m2 = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m2) return str.substring(0,10);
  // mm/dd/yyyy (formato americano)
  const m3 = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m3) return `${m3[3]}-${m3[1].padStart(2,'0')}-${m3[2].padStart(2,'0')}`;
  return str;
}

function mapearEstadoHolded(s){
  const lower = (s||'').toLowerCase();
  if(lower.includes('pag') || lower.includes('paid') || lower.includes('cobr')) return 'Pagada';
  if(lower.includes('parci') || lower.includes('partial')) return 'Parcial';
  if(lower.includes('venc') || lower.includes('overdue') || lower.includes('expir')) return 'Vencida';
  if(lower.includes('anul') || lower.includes('cancel')) return 'Anulada';
  return 'Pendiente';
}

function renderPreviewHolded(rows){
  const tbody   = document.getElementById('holded-tbody');
  const preview = document.getElementById('holded-preview');
  const resumen = document.getElementById('holded-resumen');
  const btnImp  = document.getElementById('btn-importar-holded');
  const proyDef = document.getElementById('holded-proyecto-default')?.value || '';

  if(preview) preview.style.display = '';
  if(btnImp)  btnImp.style.display  = '';

  // Detectar duplicados (num_factura ya existe en FC)
  const existentes = new Set(FC.map(f=>f.num_factura));

  const totalBase  = rows.reduce((s,r)=>s+r.base_imponible,0);
  const duplicados = rows.filter(r=>existentes.has(r.num_factura)).length;

  if(resumen) resumen.innerHTML =
    `<span style="color:var(--navy)">${rows.length} facturas encontradas</span>
     Â· Base total: <strong>${fmt(totalBase)}</strong>
     ${duplicados ? `Â· <span style="color:var(--amber)">âš ï¸ ${duplicados} ya existen (se omitirÃ¡n)</span>` : 'Â· <span style="color:var(--green)">âœ… Sin duplicados</span>'}`;

  tbody.innerHTML = rows.map((r,i)=>{
    const dup = existentes.has(r.num_factura);
    const provConocido = ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase());
    return `<tr style="${dup?'opacity:0.4;background:#fff5e6':''}">
      <td><input type="checkbox" class="holded-chk" data-idx="${i}" ${dup?'':'checked'} style="width:15px;height:15px"></td>
      <td style="font-size:11px;font-weight:700">${r.num_factura||'â€”'}</td>
      <td style="font-size:11px">${fmtD(r.fecha_emision)}</td>
      <td style="font-size:11px;max-width:140px">
        ${provConocido
          ? r.proveedor_id
          : `<span style="color:var(--amber)" title="Proveedor nuevo â€” se crearÃ¡">âš ï¸ ${r.proveedor_id||'â€”'}</span>`}
      </td>
      <td style="font-size:11px;color:var(--text-soft);max-width:160px">${r.concepto||'â€”'}</td>
      <td class="td-mono" style="font-size:11px">${fmt(r.base_imponible)}</td>
      <td style="font-size:11px">${r.iva_pct}</td>
      <td class="td-mono" style="font-size:11px;font-weight:700">${fmt(r.total_calculado||r.base_imponible*(1+ivaPct(r.iva_pct)/100))}</td>
      <td style="font-size:11px">${fmtD(r.fecha_vencimiento)}</td>
      <td>${bE(r.estado)}</td>
      <td style="font-size:10px">
        <select class="form-input" style="font-size:10px;padding:2px 4px;min-width:100px" data-proy="${i}">
          <option value="${proyDef}">${proyDef||'Sin proyecto'}</option>
          ${PC.filter(p=>proyDef?p.proyecto_id!==proyDef:true).map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id}</option>`).join('')}
        </select>
      </td>
    </tr>`;
  }).join('');

  // Alertas
  const alertas = document.getElementById('holded-alertas');
  const nuevosProvs = [...new Set(rows
    .filter(r=>r.proveedor_id && !ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase()))
    .map(r=>r.proveedor_id))];
  if(alertas && nuevosProvs.length){
    alertas.innerHTML = `<div class="info-box" style="background:#fff9e6;border-color:var(--amber)">
      âš ï¸ <strong>${nuevosProvs.length} proveedores nuevos</strong> detectados â€” se crearÃ¡n automÃ¡ticamente al importar:<br>
      <span style="font-size:11px;color:var(--text-soft)">${nuevosProvs.join(', ')}</span>
    </div>`;
  } else if(alertas){
    alertas.innerHTML = '';
  }
}

function toggleAllHolded(checked){
  document.querySelectorAll('.holded-chk').forEach(cb=>{ cb.checked = checked; });
}

async function ejecutarImportHolded(){
  const checkboxes = document.querySelectorAll('.holded-chk:checked');
  if(!checkboxes.length){ toast('Selecciona al menos una factura','error'); return; }

  const idxs = [...checkboxes].map(cb=>parseInt(cb.dataset.idx));
  const selRows = idxs.map(i=>holdedRows[i]);
  const proySelects = document.querySelectorAll('[data-proy]');

  const btn = document.getElementById('btn-importar-holded');
  if(btn){ btn.disabled=true; btn.textContent='Importandoâ€¦'; }

  let ok=0, errores=0;
  const existentes = new Set(FC.map(f=>f.num_factura));

  for(let i=0;i<selRows.length;i++){
    const r = selRows[i];
    const realIdx = idxs[i];
    if(existentes.has(r.num_factura)){ continue; } // Saltar duplicados

    // Obtener proyecto asignado a esta fila
    const proySelect = document.querySelector(`[data-proy="${realIdx}"]`);
    const proyId = proySelect?.value || '';

    // Crear proveedor si no existe
    if(r.proveedor_id){
      const yaExiste = ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase());
      if(!yaExiste){
        try{
          await sbPost('proveedores',{ nombre:r.proveedor_id, tipo:'Proveedor', activo:true });
          ProvC.push({ nombre:r.proveedor_id, tipo:'Proveedor' });
        }catch(e){}
      }
    }

    // Insertar factura
    const d = {
      tipo_factura:   'Compra',
      num_factura:    r.num_factura,
      fecha_emision:  r.fecha_emision || null,
      proveedor_id:   r.proveedor_id || null,
      proyecto_id:    proyId || null,
      concepto:       r.concepto || '',
      base_imponible: r.base_imponible || 0,
      iva_pct:        r.iva_pct || '21%',
      forma_pago:     'Transferencia',
      fecha_vencimiento: r.fecha_vencimiento || null,
      estado:         r.estado || 'Pendiente',
      importe_cobrado: r.estado==='Pagada' ? (r.total_calculado||r.base_imponible) : 0,
    };

    try{
      await sbPost('facturas', d);
      ok++;
    }catch(e){
      errores++;
      console.warn('Error importando', r.num_factura, e.message);
    }
  }

  if(btn){ btn.disabled=false; btn.textContent='ğŸ“¥ Importar facturas seleccionadas'; }

  toast(`âœ… ${ok} facturas importadas${errores?` Â· âš ï¸ ${errores} errores`:''}`, errores?'warn':'ok');
  closeModal('m-importar-holded');
  document.getElementById('holded-file').value='';
  document.getElementById('holded-preview').style.display='none';
  holdedRows=[];
  await loadFacturas();
  await loadProveedores();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORTADOR HOLDED â€” CLIENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let holdedCli = [];

function toggleAll(cls, checked){
  document.querySelectorAll('.' + cls).forEach(cb => cb.checked = checked);
}

async function leerArchivoHolded(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    const text = await file.text();
    return parsearCSVGenerico(text);
  } else {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          if(typeof XLSX !== 'undefined'){
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array', cellDates:true});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, {raw:false, dateNF:'yyyy-mm-dd'});
            resolve(json.map(row => {
              const r = {};
              Object.keys(row).forEach(k => r[k.toLowerCase().trim()] = String(row[k]||'').trim());
              return r;
            }));
          } else { resolve([]); }
        } catch(e){ resolve([]); }
      };
      reader.readAsArrayBuffer(file);
    });
  }
}

function parsearCSVGenerico(text){
  const sep = text.includes(';') ? ';' : ',';
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  if(lines.length < 2) return [];
  const headers = lines[0].split(sep).map(h=>h.replace(/"/g,'').toLowerCase().trim());
  return lines.slice(1).map(line => {
    const cols = line.split(sep).map(c=>c.replace(/"/g,'').trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i]||'');
    return obj;
  }).filter(r => Object.values(r).some(v=>v));
}

function getField(obj, ...keys){
  for(const k of keys){
    const v = obj[k] || obj[k.toLowerCase()] || obj[k.toUpperCase()];
    if(v && String(v).trim()) return String(v).trim();
  }
  return '';
}

function mapearFormaPago(s){
  const l = (s||'').toLowerCase();
  if(l.includes('transfer')) return 'Transferencia';
  if(l.includes('efect') || l.includes('cash')) return 'Efectivo';
  if(l.includes('domic')) return 'DomiciliaciÃ³n';
  if(l.includes('confirm')) return 'Confirming';
  if(l.includes('cheque') || l.includes('check')) return 'Cheque';
  if(l.includes('giro') || l.includes('30')) return 'Giro 30 dÃ­as';
  if(l.includes('60')) return 'Giro 60 dÃ­as';
  if(l.includes('90')) return 'Giro 90 dÃ­as';
  if(l.includes('120')) return 'Giro 120 dÃ­as';
  return 'Transferencia';
}

async function procesarImportClientes(){
  const file = document.getElementById('cli-holded-file')?.files[0];
  if(!file) return;
  const rows = await leerArchivoHolded(file);
  if(!rows.length){ toast('No se encontraron datos en el archivo','error'); return; }

  holdedCli = rows.map(r => ({
    nombre:    getField(r,'nombre','name','razÃ³n social','razon social','empresa','company','client','cliente'),
    cif:       getField(r,'cif','nif','tax id','tax number','vat','cif/nif','nif/cif','nÃºmero fiscal','num. fiscal'),
    telefono:  getField(r,'telÃ©fono','telefono','phone','tel','mÃ³vil','movil','mobile'),
    email:     getField(r,'email','e-mail','correo','mail'),
    direccion: getField(r,'direcciÃ³n','direccion','address','domicilio','calle','dir.'),
    forma_pago:mapearFormaPago(getField(r,'forma pago','forma de pago','payment method','mÃ©todo pago','vencimiento')),
    notas:     getField(r,'notas','notes','observaciones','comentarios'),
  })).filter(r => r.nombre);

  renderImportPreview('cli', holdedCli, CC, 'nombre',
    ['nombre','cif','telefono','email','direccion','forma_pago'],
    ['Nombre','CIF/NIF','TelÃ©fono','Email','DirecciÃ³n','Forma pago']);
}

function renderImportPreview(prefix, rows, existing, matchKey, fields, labels){
  const existSet = new Set(existing.map(e => (e[matchKey]||'').toLowerCase().trim()));
  const preview  = document.getElementById(`${prefix}-import-preview`);
  const resumen  = document.getElementById(`${prefix}-import-resumen`);
  const tbody    = document.getElementById(`${prefix}-import-tbody`);
  const btn      = document.getElementById(`btn-import-${prefix==='cli'?'clientes':'proveedores'}`);

  if(preview) preview.style.display = '';
  if(btn)     btn.style.display     = '';

  const nuevos = rows.filter(r => !existSet.has((r[matchKey]||'').toLowerCase().trim())).length;
  const dups   = rows.length - nuevos;

  if(resumen) resumen.innerHTML =
    `<span style="color:var(--navy)">${rows.length} registros en el archivo</span>
     Â· <span style="color:var(--green)">âœ… ${nuevos} nuevos</span>
     ${dups ? `Â· <span style="color:var(--amber)">âš ï¸ ${dups} ya existen (marcados en naranja â€” se omitirÃ¡n)</span>` : ''}`;

  tbody.innerHTML = rows.map((r,i) => {
    const dup = existSet.has((r[matchKey]||'').toLowerCase().trim());
    const tds = fields.map(f => `<td style="font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r[f]||'â€”'}</td>`).join('');
    return `<tr style="${dup?'background:#fff9e6;opacity:0.6':''}">
      <td><input type="checkbox" class="${prefix}-chk" data-idx="${i}" ${dup?'':'checked'} style="width:15px;height:15px"></td>
      ${tds}
      <td style="font-size:10px;font-weight:700;color:${dup?'var(--amber)':'var(--green)'}">
        ${dup ? 'âš ï¸ Ya existe' : 'ğŸ†• Nuevo'}
      </td>
    </tr>`;
  }).join('');
}

async function ejecutarImportClientes(){
  const checked = [...document.querySelectorAll('.cli-chk:checked')];
  if(!checked.length){ toast('Selecciona al menos un cliente','error'); return; }
  const btn = document.getElementById('btn-import-clientes');
  if(btn){ btn.disabled=true; btn.textContent='Importandoâ€¦'; }

  const existSet = new Set(CC.map(c=>(c.nombre||'').toLowerCase().trim()));
  let ok=0, omitidos=0;

  for(const cb of checked){
    const r = holdedCli[parseInt(cb.dataset.idx)];
    if(existSet.has((r.nombre||'').toLowerCase().trim())){ omitidos++; continue; }
    try{
      const d = { ...r, cliente_id: genId('CLI', CC, 'cliente_id'), tipo:'Cliente', activo:true };
      await sbPost('clientes', d);
      CC.push(d);
      ok++;
    } catch(e){ console.warn('Error cliente', r.nombre, e.message); }
  }

  if(btn){ btn.disabled=false; btn.textContent='ğŸ‘¤ Importar clientes seleccionados'; }
  toast(`âœ… ${ok} clientes importados${omitidos?` Â· ${omitidos} ya existÃ­an (omitidos)`:''}` );
  closeModal('m-import-clientes');
  document.getElementById('cli-holded-file').value='';
  document.getElementById('cli-import-preview').style.display='none';
  holdedCli=[];
  await loadClientes();
  populateSelects();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORTADOR HOLDED â€” PROVEEDORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let holdedProv = [];

async function procesarImportProveedores(){
  const file = document.getElementById('prov-holded-file')?.files[0];
  if(!file) return;
  const rows = await leerArchivoHolded(file);
  if(!rows.length){ toast('No se encontraron datos en el archivo','error'); return; }

  holdedProv = rows.map(r => ({
    nombre:      getField(r,'nombre','name','razÃ³n social','razon social','empresa','company','proveedor','supplier','vendor'),
    cif:         getField(r,'cif','nif','tax id','vat','cif/nif','nÃºmero fiscal'),
    telefono:    getField(r,'telÃ©fono','telefono','phone','tel','mÃ³vil','movil'),
    email:       getField(r,'email','e-mail','correo','mail'),
    especialidad:getField(r,'especialidad','specialty','categorÃ­a','categoria','tipo servicio','servicio'),
    forma_pago:  mapearFormaPago(getField(r,'forma pago','forma de pago','payment method','vencimiento')),
    iban:        getField(r,'iban','cuenta','account','bank account','nÃºmero cuenta'),
    notas:       getField(r,'notas','notes','observaciones','comentarios'),
    tipo:        'Proveedor',
    activo:      true,
  })).filter(r => r.nombre);

  renderImportPreview('prov', holdedProv, ProvC, 'nombre',
    ['nombre','cif','telefono','email','especialidad','forma_pago','iban'],
    ['Nombre','CIF/NIF','TelÃ©fono','Email','Especialidad','Forma pago','IBAN']);
}

async function ejecutarImportProveedores(){
  const checked = [...document.querySelectorAll('.prov-chk:checked')];
  if(!checked.length){ toast('Selecciona al menos un proveedor','error'); return; }
  const btn = document.getElementById('btn-import-proveedores');
  if(btn){ btn.disabled=true; btn.textContent='Importandoâ€¦'; }

  const existSet = new Set(ProvC.map(p=>(p.nombre||'').toLowerCase().trim()));
  let ok=0, omitidos=0;

  for(const cb of checked){
    const r = holdedProv[parseInt(cb.dataset.idx)];
    if(existSet.has((r.nombre||'').toLowerCase().trim())){ omitidos++; continue; }
    try{
      const d = { ...r, proveedor_id: genId('PRV', ProvC, 'proveedor_id') };
      await sbPost('proveedores', d);
      ProvC.push(d);
      ok++;
    } catch(e){ console.warn('Error proveedor', r.nombre, e.message); }
  }

  if(btn){ btn.disabled=false; btn.textContent='ğŸ­ Importar proveedores seleccionados'; }
  toast(`âœ… ${ok} proveedores importados${omitidos?` Â· ${omitidos} ya existÃ­an (omitidos)`:''}` );
  closeModal('m-import-proveedores');
  document.getElementById('prov-holded-file').value='';
  document.getElementById('prov-import-preview').style.display='none';
  holdedProv=[];
  await loadProveedores();
  populateSelects();
}


// â•â•â• PWA SERVICE WORKER â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  });
}
</script>

<!-- â•â•â• MODAL IMPORTAR HOLDED â•â•â• -->
<div class="modal-overlay" id="m-importar-holded">
<div class="modal" style="width:780px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">ğŸ“¤ Importar facturas de compra desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-importar-holded')">Ã—</button>
  </div>
  <div class="modal-body">

    <!-- INSTRUCCIONES -->
    <div class="info-box" style="margin-bottom:14px">
      <strong>Â¿CÃ³mo exportar desde Holded?</strong><br>
      1. Ve a <strong>Gastos â†’ Facturas de compra</strong><br>
      2. Filtra por el periodo que quieras importar<br>
      3. Pulsa el <strong>icono â¬‡ Exportar</strong> (arriba derecha) â†’ <strong>Excel o CSV</strong><br>
      4. Sube el archivo aquÃ­ abajo
    </div>

    <!-- UPLOAD -->
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
        <input type="file" id="holded-file" accept=".xlsx,.xls,.csv" class="form-input"
          onchange="procesarArchivoHolded()" style="padding:6px">
      </div>
      <div style="flex:1;min-width:200px">
        <label class="form-label">Asignar a proyecto <span style="font-size:10px;color:var(--text-soft)">(opcional â€” puedes cambiar por factura)</span></label>
        <select class="form-input" id="holded-proyecto-default">
          <option value="">â€” Sin proyecto por defecto â€”</option>
        </select>
      </div>
    </div>

    <!-- PREVIEW TABLE -->
    <div id="holded-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="holded-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca las que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:320px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="holded-chk-all" onchange="toggleAllHolded(this.checked)" checked style="width:15px;height:15px"></th>
          <th>NÂº Factura</th><th>Fecha</th><th>Proveedor</th>
          <th>Concepto</th><th>Base imp.</th><th>IVA</th><th>Total</th>
          <th>Vencimiento</th><th>Estado</th><th>Proyecto</th>
        </tr></thead>
        <tbody id="holded-tbody"></tbody>
      </table></div>

      <!-- ALERTAS -->
      <div id="holded-alertas" style="margin-top:10px"></div>
    </div>

  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-importar-holded')">Cancelar</button>
    <button class="btn btn-primary" id="btn-importar-holded" style="display:none"
      onclick="ejecutarImportHolded()">ğŸ“¥ Importar facturas seleccionadas</button>
  </div>
</div>
</div>

<!-- â•â•â• MODAL IMPORTAR CLIENTES HOLDED â•â•â• -->
<div class="modal-overlay" id="m-import-clientes">
<div class="modal" style="width:820px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">ğŸ‘¤ Importar clientes desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-import-clientes')">Ã—</button>
  </div>
  <div class="modal-body">
    <div class="info-box" style="margin-bottom:14px">
      <strong>Â¿CÃ³mo exportar desde Holded?</strong><br>
      Ve a <strong>Contactos â†’ Clientes</strong> Â· Pulsa <strong>â¬‡ Exportar â†’ Excel o CSV</strong>
    </div>
    <div style="margin-bottom:14px">
      <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
      <input type="file" id="cli-holded-file" accept=".xlsx,.xls,.csv" class="form-input"
        onchange="procesarImportClientes()" style="padding:6px">
    </div>
    <div id="cli-import-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="cli-import-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca los que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:340px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="cli-chk-all" onchange="toggleAll('cli-chk',this.checked)" checked style="width:15px;height:15px"></th>
          <th>Nombre</th><th>CIF/NIF</th><th>TelÃ©fono</th><th>Email</th><th>DirecciÃ³n</th><th>Forma pago</th><th>Estado</th>
        </tr></thead>
        <tbody id="cli-import-tbody"></tbody>
      </table></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-import-clientes')">Cancelar</button>
    <button class="btn btn-primary" id="btn-import-clientes" style="display:none"
      onclick="ejecutarImportClientes()">ğŸ‘¤ Importar clientes seleccionados</button>
  </div>
</div>
</div>

<!-- â•â•â• MODAL IMPORTAR PROVEEDORES HOLDED â•â•â• -->
<div class="modal-overlay" id="m-import-proveedores">
<div class="modal" style="width:820px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">ğŸ­ Importar proveedores desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-import-proveedores')">Ã—</button>
  </div>
  <div class="modal-body">
    <div class="info-box" style="margin-bottom:14px">
      <strong>Â¿CÃ³mo exportar desde Holded?</strong><br>
      Ve a <strong>Contactos â†’ Proveedores</strong> Â· Pulsa <strong>â¬‡ Exportar â†’ Excel o CSV</strong>
    </div>
    <div style="margin-bottom:14px">
      <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
      <input type="file" id="prov-holded-file" accept=".xlsx,.xls,.csv" class="form-input"
        onchange="procesarImportProveedores()" style="padding:6px">
    </div>
    <div id="prov-import-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="prov-import-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca los que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:340px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="prov-chk-all" onchange="toggleAll('prov-chk',this.checked)" checked style="width:15px;height:15px"></th>
          <th>Nombre</th><th>CIF/NIF</th><th>TelÃ©fono</th><th>Email</th><th>Especialidad</th><th>Forma pago</th><th>IBAN</th><th>Estado</th>
        </tr></thead>
        <tbody id="prov-import-tbody"></tbody>
      </table></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-import-proveedores')">Cancelar</button>
    <button class="btn btn-primary" id="btn-import-proveedores" style="display:none"
      onclick="ejecutarImportProveedores()">ğŸ­ Importar proveedores seleccionados</button>
  </div>
</div>
</div>
</body>
</html>
