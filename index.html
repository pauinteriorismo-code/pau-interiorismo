<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a2a3a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PAU Gesti√≥n">
<link rel="manifest" href="manifest.json">
<title>PAU INTERIORISMO ¬∑ Gesti√≥n</title>
<style>
:root{--navy:#1a2a3a;--navy-mid:#27405b;--navy-light:#3d5a78;--blue-soft:#b8cce4;--blue-light:#e8f4ff;--cream:#f7f4ef;--sand:#ede8df;--copper:#b87333;--copper-light:#f4e8da;--green:#1e6b3d;--green-soft:#d5e8d4;--amber:#7d6608;--amber-soft:#fff2cc;--red:#7b241c;--red-soft:#fce8e6;--white:#fff;--text:#1a2a3a;--text-mid:#4a5f72;--text-soft:#8a9aaa;--border:#dce6f0;--radius:8px;--radius-sm:4px;--shadow:0 1px 3px rgba(26,42,58,.08),0 4px 16px rgba(26,42,58,.06);--shadow-lg:0 8px 32px rgba(26,42,58,.14);--sidebar:220px;--header:56px}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;color:var(--text);background:var(--cream)}
button,input,select,textarea{font-family:inherit}button{cursor:pointer}
/* LOGIN */
.login-screen{position:fixed;inset:0;background:var(--navy);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:var(--white);border-radius:var(--radius);padding:40px;width:340px;box-shadow:var(--shadow-lg);text-align:center}
.login-logo{font-size:15px;font-weight:700;color:var(--navy);letter-spacing:.06em;margin-bottom:4px}
.login-sub{font-size:10px;color:var(--text-soft);margin-bottom:28px;letter-spacing:.08em;text-transform:uppercase}
.login-error{background:var(--red-soft);color:var(--red);font-size:12px;padding:8px 12px;border-radius:var(--radius-sm);margin-bottom:12px;display:none}
/* APP */
.app{display:flex;height:100vh;overflow:hidden}
/* SIDEBAR */
.sidebar{width:var(--sidebar);background:var(--navy);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;z-index:10}
.sidebar-logo{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-size:13px;font-weight:700;color:#fff;letter-spacing:.04em}
.brand-sub{font-size:10px;color:rgba(255,255,255,.35);letter-spacing:.08em;text-transform:uppercase;margin-top:2px}
.nav-section{padding:12px 0 4px}
.nav-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.3);padding:0 16px 5px}
.nav-item{display:flex;align-items:center;gap:8px;padding:7px 16px;cursor:pointer;font-size:12px;color:rgba(255,255,255,.6);border-left:2px solid transparent;transition:all .15s;white-space:nowrap}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff}
.nav-item.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:var(--copper)}
.nav-item .ni{font-size:13px;width:16px;text-align:center}
.nav-badge{margin-left:auto;background:var(--copper);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px}
.sidebar-bottom{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.08)}
.user-card{display:flex;align-items:center;gap:8px}
.user-av{width:28px;height:28px;border-radius:50%;background:var(--copper);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.user-name{font-size:12px;color:rgba(255,255,255,.8);font-weight:600}
.user-role{font-size:10px;color:rgba(255,255,255,.35)}
/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:var(--header);background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:10px;flex-shrink:0}
.topbar-title{font-size:14px;font-weight:700;color:var(--navy)}
.topbar-bc{font-size:11px;color:var(--text-soft);margin-top:1px}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:7px}
.content{flex:1;overflow-y:auto;padding:18px 20px}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;border:none;transition:all .15s;cursor:pointer}
.btn-primary{background:var(--navy-mid);color:#fff}.btn-primary:hover{background:var(--navy)}
.btn-ghost{background:transparent;color:var(--text-mid);border:1px solid var(--border)}.btn-ghost:hover{background:var(--sand)}
.btn-copper{background:var(--copper);color:#fff}.btn-copper:hover{background:#9a6028}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#621a14}
.btn-sm{padding:4px 9px;font-size:11px}
.btn-icon{padding:5px;width:28px;height:28px;justify-content:center}
/* CARDS */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;border-bottom:1px solid var(--border)}
.card-title{font-size:13px;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:7px}
.card-body{padding:14px 16px}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.kpi-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.kpi{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:13px 15px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.kpi.blue::before{background:var(--navy-mid)}.kpi.green::before{background:var(--green)}
.kpi.amber::before{background:var(--copper)}.kpi.red::before{background:var(--red)}
.kpi.purple::before{background:#6b3fa0}
.kpi-label{font-size:11px;color:var(--text-soft);font-weight:500}
.kpi-value{font-size:19px;font-weight:700;color:var(--navy);margin:3px 0;font-variant-numeric:tabular-nums}
.kpi-sub{font-size:11px;color:var(--text-soft)}
/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--navy);color:#fff;padding:8px 10px;text-align:left;font-size:11px;font-weight:600;letter-spacing:.04em;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--blue-light)}
tbody td{padding:7px 10px;vertical-align:middle}
.td-mono{font-family:'Courier New',monospace;font-size:11px}
.td-actions{display:flex;gap:3px}
/* BADGES */
.badge{display:inline-block;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap}
.b-green{background:var(--green-soft);color:var(--green)}.b-amber{background:var(--amber-soft);color:var(--amber)}
.b-red{background:var(--red-soft);color:var(--red)}.b-blue{background:var(--blue-light);color:var(--navy-mid)}
.b-navy{background:var(--navy);color:#fff}.b-copper{background:var(--copper-light);color:var(--copper)}
.b-gray{background:var(--sand);color:var(--text-mid)}
/* VIEWS */
.view{display:none}.view.active{display:block}
/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-full{grid-column:1/-1}.fg-3{grid-column:span 1}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:11px;font-weight:600;color:var(--text-mid)}
.form-input{padding:7px 9px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;width:100%}
.search-dd{position:absolute;top:100%;left:0;right:0;background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:9999;max-height:220px;overflow-y:auto;margin-top:2px}
.search-dd-item{padding:8px 10px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border-light,#f0f0f0)}
.search-dd-item:hover{background:var(--blue-light)}
.search-dd-item strong{color:var(--navy)}
.search-dd-empty{padding:10px;color:var(--text-soft);font-size:12px;text-align:center}
.form-input:focus{border-color:var(--navy-mid);box-shadow:0 0 0 3px rgba(39,64,91,.1)}
.form-input[readonly]{background:var(--sand);color:var(--text-soft)}
.form-input.calc{background:var(--green-soft);color:var(--green);font-weight:700}
.form-input.winner{background:var(--green-soft);color:var(--green);font-weight:700}
/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--white);border-radius:var(--radius);width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);transform:translateY(10px);transition:transform .2s}
.overlay.open .modal{transform:translateY(0)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:1}
.modal-title{font-size:14px;font-weight:700;color:var(--navy)}
.modal-close{background:none;border:none;font-size:22px;color:var(--text-soft);line-height:1;padding:0}
.modal-body{padding:20px}
.modal-foot{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;position:sticky;bottom:0;background:var(--white)}
.modal-section{font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.08em;margin:16px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
/* INFO BOX */
.info-box{background:var(--blue-light);border:1px solid var(--blue-soft);border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--navy-mid);margin-bottom:14px}
.warn-box{background:var(--amber-soft);border:1px solid #e6c80a;border-radius:var(--radius-sm);padding:10px 13px;font-size:12px;color:var(--amber);margin-bottom:14px}
/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px}
.search-wrap input{padding-left:30px}
.search-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-soft);font-size:12px;pointer-events:none}
/* EMPTY / LOADING */
.loading{text-align:center;padding:35px;color:var(--text-soft);font-size:13px}
.empty{text-align:center;padding:45px 20px;color:var(--text-soft)}
.empty-icon{font-size:38px;margin-bottom:10px}.empty-text{font-size:13px;margin-bottom:14px}
/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:11px 18px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:999;box-shadow:var(--shadow-lg);transform:translateY(20px);opacity:0;transition:all .3s;max-width:300px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green)}.toast.error{background:var(--red)}
/* CONFIRM */
.confirm-overlay{position:fixed;inset:0;background:rgba(10,20,30,.5);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:var(--white);border-radius:var(--radius);padding:26px;width:330px;box-shadow:var(--shadow-lg);text-align:center}
.confirm-title{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:8px}
.confirm-text{font-size:13px;color:var(--text-mid);margin-bottom:18px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
/* CONTROL HORARIO */
.horario-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:6px}
.horario-day{background:var(--white);border:1px solid var(--border);border-radius:4px;padding:5px;text-align:center;font-size:11px;cursor:pointer;min-height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .15s}
.horario-day:hover{border-color:var(--navy-mid);background:var(--blue-light)}
.horario-day.weekend{background:var(--sand)}.horario-day.festivo{background:var(--amber-soft)}
.horario-day.trabajado{background:var(--green-soft);border-color:var(--green)}
.horario-day.ausente{background:var(--red-soft);border-color:var(--red)}
.horario-day-num{font-weight:700;font-size:12px;color:var(--navy)}
.horario-day-h{font-size:10px;color:var(--green);font-weight:600}
.day-header{background:var(--navy);color:#fff;padding:5px;text-align:center;font-size:10px;font-weight:700;border-radius:4px}
/* COMPARATIVA */
.oferta-col{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative}
.oferta-col.ganadora{border-color:var(--green);background:var(--green-soft)}
.oferta-col.ganadora::before{content:'‚úÖ ELEGIDA';position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;font-size:10px;font-weight:700;padding:2px 10px;border-radius:10px}
.oferta-title{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px;text-align:center}
/* TABS */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px}
.tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--text-soft);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab:hover{color:var(--navy)}.tab.active{color:var(--navy);border-bottom-color:var(--copper)}
.tab-content{display:none}.tab-content.active{display:block}
/* CONTABILIDAD */
.cuenta-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.cuenta-row.header{background:var(--navy);color:#fff;font-weight:700;border-radius:4px 4px 0 0}
.cuenta-row.total{background:var(--sand);font-weight:700}
.cuenta-row.result{background:var(--green-soft);font-weight:700;color:var(--green)}
.cuenta-row.result.neg{background:var(--red-soft);color:var(--red)}
/* PROG BAR */
.prog-wrap{background:var(--sand);border-radius:4px;height:16px;overflow:hidden;margin:6px 0}
.prog-bar{height:100%;border-radius:4px;transition:width .5s}
.lista-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--sand);border-radius:var(--radius-sm);font-size:12px;margin-bottom:5px}
.lista-item:hover{background:var(--blue-light)}
@media(max-width:768px){.sidebar{width:52px}.brand,.brand-sub,.nav-label,.nav-item span:not(.ni),.nav-badge,.user-name,.user-role{display:none}.nav-item{justify-content:center;padding:9px}.kpi-grid,.kpi-grid-3{grid-template-columns:1fr 1fr}.form-grid{grid-template-columns:1fr}.fg-full{grid-column:1}.content{padding:12px}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT STYLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media print {
  .no-print { display: none !important; }
  input, textarea { border: none !important; background: transparent !important; outline: none !important; resize: none !important; }
  input::placeholder, textarea::placeholder { color: transparent !important; }

  /* Hide everything except the document */
  .sidebar, .topbar, .search-bar, .btn, 
  .nav-item, .overlay, .toast, .confirm-overlay,
  #login-screen { display: none !important; }
  
  /* Reset layout */
  body { background: white !important; }
  .app { display: block !important; }
  .main { display: block !important; overflow: visible !important; }
  .content { padding: 0 !important; overflow: visible !important; }
  
  /* Hide all views except the active one */
  .view { display: none !important; }
  .view.active { display: block !important; }
  
  /* Hide search bar and controls inside active view */
  .view.active .search-bar { display: none !important; }
  .view.active .kpi, .view.active .card:not(#pf-doc):not(#ct-doc):not(#pd-doc) { display: none !important; }
  
  /* Show ONLY the document div */
  #pf-doc, #ct-doc, #pd-doc {
    display: block !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    padding: 20mm !important;
    max-width: 100% !important;
    width: 210mm !important;
    min-height: 297mm !important;
    font-size: 11pt !important;
    page-break-after: always;
  }

  /* Page setup */
  @page {
    size: A4;
    margin: 0;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  #login-screen { display: none !important; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">PAU INTERIORISMO S.L.</div>
    <div class="login-sub">Sistema de gesti√≥n ¬∑ Acceso privado</div>
    <div class="login-error" id="login-error">Usuario o contrase√±a incorrectos</div>
    <div class="form-group" style="margin-bottom:11px;text-align:left"><label class="form-label">Usuario</label><input class="form-input" id="login-user" placeholder="usuario" autocomplete="username"></div>
    <div class="form-group" style="margin-bottom:18px;text-align:left"><label class="form-label">Contrase√±a</label><input class="form-input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px" onclick="doLogin()">Entrar ‚Üí</button>
  </div>
</div>

<!-- APP -->
<div class="app">
<nav class="sidebar">
  <div class="sidebar-logo"><div class="brand">PAU INTERIORISMO</div><div class="brand-sub">Sistema de gesti√≥n ¬∑ <span style="color:#b87333">v50</span></div></div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" data-view="gerencia"><span class="ni">üè†</span><span>Gerencia</span></div>
    <div class="nav-item" data-view="agenda"><span class="ni">üîî</span><span>Agenda</span><span class="nav-badge" id="agenda-badge" style="display:none">0</span></div>
    <div class="nav-item" data-view="clientes"><span class="ni">ü§ù</span><span>Clientes</span></div>
    <div class="nav-item" data-view="proyectos"><span class="ni">üìÅ</span><span>Proyectos</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Presupuestaci√≥n</div>
    <div class="nav-item" data-view="presupuesto"><span class="ni">üí∞</span><span>Presupuesto</span></div>
    <div class="nav-item" data-view="comparativa"><span class="ni">‚öñÔ∏è</span><span>Comparativa ofertas</span></div>
    <div class="nav-item" data-view="tarifario"><span class="ni">üìã</span><span>Tarifario</span></div>
    <div class="nav-item" data-view="cype"><span class="ni">üìê</span><span>CYPE 2026</span><span class="nav-badge" id="cype-badge">524</span></div>
    <div class="nav-item" data-view="interiorismo"><span class="ni">üõã</span><span>Interiorismo</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Ejecuci√≥n</div>
    <div class="nav-item" data-view="compras"><span class="ni">üõí</span><span>Compras</span></div>
    <div class="nav-item" data-view="subcontratas"><span class="ni">üë∑</span><span>Subcontratas</span></div>
    <div class="nav-item" data-view="horas"><span class="ni">‚è±</span><span>Horas</span></div>
    <div class="nav-item" data-view="pedidos"><span class="ni">üì¶</span><span>Pedidos</span></div>
    <div class="nav-item" data-view="control_horario"><span class="ni">üìÖ</span><span>Control horario</span></div>
    <div class="nav-item" data-view="proveedores"><span class="ni">üè≠</span><span>Proveedores</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Cierre</div>
    <div class="nav-item" data-view="rentabilidad"><span class="ni">üìà</span><span>Rentabilidad</span></div>
    <div class="nav-item" data-view="facturas"><span class="ni">üßæ</span><span>Facturas</span></div>
    <div class="nav-item" data-view="conciliacion"><span class="ni">üè¶</span><span>Conciliaci√≥n bancaria</span></div>
    <div class="nav-item" data-view="contabilidad"><span class="ni">üìä</span><span>Contabilidad</span></div>
    <div class="nav-item" data-view="informe_mensual"><span class="ni">üìÖ</span><span>Informe mensual</span></div>
    <div class="nav-item" data-view="rrhh"><span class="ni">üë§</span><span>RR.HH. ¬∑ N√≥minas</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Sistema</div>
    <div class="nav-item" data-view="pres_final"><span class="ni">üìÑ</span><span>Presupuesto final</span></div>
    <div class="nav-item" data-view="contrato"><span class="ni">üìù</span><span>Contrato</span></div>
    <div class="nav-item" data-view="pedido_doc"><span class="ni">üìã</span><span>Doc. Pedido</span></div>
    <div class="nav-item" data-view="listas"><span class="ni">üóÇ</span><span>Listas</span></div>
    <div class="nav-item" data-view="configuracion"><span class="ni">‚öôÔ∏è</span><span>Configuraci√≥n</span></div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card"><div class="user-av" id="user-av">JA</div><div><div class="user-name" id="user-name">Jose</div><div class="user-role">Administrador</div></div></div>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <div><div class="topbar-title" id="tb-title">Gerencia ¬∑ Panel ejecutivo</div><div class="topbar-bc" id="tb-bc">Datos en tiempo real</div></div>
    <div class="topbar-right">
      <div id="conn-status" style="font-size:11px;padding:3px 9px;border-radius:10px;background:var(--amber-soft);color:var(--amber);font-weight:600">‚è≥ Conectando‚Ä¶</div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
      <button class="btn btn-primary btn-sm" onclick="openModal('m-quick')">Ôºã Nuevo</button>
    </div>
  </div>

  <div class="content">


    <!-- ‚ïê‚ïê‚ïê PRESUPUESTO FINAL ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pres_final">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-pres_final" onchange="cascadaModulo('pres_final','pf-proyecto-sel',loadPresupuestoFinal)">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px" id="pf-proyecto-sel" onchange="loadPresupuestoFinal()"><option value="">üìÅ Proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:75px" id="pf-version-sel" onchange="loadPresupuestoFinal()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="pf-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-family:Arial,sans-serif;font-size:12px">
        <!-- Cabecera empresa -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;margin-top:3px">C/ Tom√°s y Valiente N¬∫ 6 Bajo, 46290 Alc√†sser (Valencia)</div>
            <div style="color:#666">Tel: 961 20 01 87 ¬∑ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5f363139301f2f3e2a36312b3a2d36302d362c3230713c3032">[email&#160;protected]</a></div>
            <div style="color:#666">CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333;letter-spacing:.05em">PRESUPUESTO</div>
            <div id="pf-num" style="font-size:13px;color:#1a2a3a;margin-top:4px"></div>
            <div id="pf-fecha" style="color:#666;font-size:11px"></div>
          </div>
        </div>
        <!-- Datos cliente -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">CLIENTE</div>
            <div id="pf-cliente-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-cliente-cif" style="color:#666"></div>
            <div id="pf-cliente-dir" style="color:#666"></div>
          </div>
          <div style="background:#f7f4ef;padding:12px;border-radius:4px">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:6px">PROYECTO</div>
            <div id="pf-proyecto-nombre" style="font-weight:700;font-size:13px"></div>
            <div id="pf-proyecto-dir" style="color:#666"></div>
          </div>
        </div>
        <!-- Tabla l√≠neas -->
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;font-size:11px">
          <thead>
            <tr style="background:#1a2a3a;color:white">
              <th style="padding:8px;text-align:left">Descripci√≥n</th>
              <th style="padding:8px;text-align:center;width:40px">Ud.</th>
              <th style="padding:8px;text-align:right;width:60px">Cant.</th>
              <th style="padding:8px;text-align:right;width:90px">P.Unitario</th>
              <th style="padding:8px;text-align:right;width:90px">Subtotal</th>
            </tr>
          </thead>
          <tbody id="pf-lineas"></tbody>
        </table>
        <!-- Totales -->
        <div style="display:flex;justify-content:flex-end">
          <div style="width:250px">
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>Base imponible</span><span id="pf-base">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #ddd;font-size:12px"><span>IVA (10%)</span><span id="pf-iva">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between;padding:9px 0;font-size:14px;font-weight:700;color:#1a2a3a"><span>TOTAL</span><span id="pf-total">‚Äî</span></div>
          </div>
        </div>
        <!-- Condiciones -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid #ddd;color:#888;font-size:10px">
          <strong style="color:#333">Condiciones:</strong> Presupuesto v√°lido por 30 d√≠as desde su emisi√≥n. Los precios incluyen mano de obra y materiales salvo indicaci√≥n contraria. IVA no incluido salvo indicaci√≥n. 
          En caso de aceptaci√≥n, s√≠rvase firmar y devolver una copia.
        </div>
        <div style="margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:30px">
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma PAU INTERIORISMO S.L.</div></div>
          <div><div style="border-top:1px solid #333;padding-top:8px;color:#666;font-size:10px">Firma y conformidad del cliente</div></div>
        </div>
        <div id="pf-empty" class="empty" style="display:none"><div class="empty-icon">üìÑ</div><div class="empty-text">Selecciona un proyecto para generar el presupuesto</div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTRATO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-contrato">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-contrato" onchange="cascadaModulo('contrato','ct-proyecto-sel',loadContrato)">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px" id="ct-proyecto-sel" onchange="loadContrato()"><option value="">üìÅ Proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:180px" id="ct-pres-sel"><option value="">Presupuesto vinculado‚Ä¶</option></select>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      </div>
      <div id="ct-doc" style="background:white;max-width:800px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;line-height:1.7;font-family:Arial,sans-serif">
        <div style="text-align:center;margin-bottom:24px">
          <div style="font-size:16px;font-weight:700;color:#1a2a3a;border-bottom:2px solid #b87333;padding-bottom:8px">CONTRATO DE OBRA CIVIL Y SERVICIOS DE INTERIORISMO</div>
        </div>
        <div style="text-align:right;color:#666;margin-bottom:18px">En Valencia, a <span id="ct-fecha">[FECHA]</span></div>
        <div style="margin-bottom:16px"><strong>REUNIDOS</strong></div>
        <div style="margin-bottom:12px">De una parte: <strong>PAU INTERIORISMO S.L.</strong>, con CIF <strong>B-56909641</strong>, domicilio en C/ Tom√°s y Valiente N¬∫ 6 Bajo, 46290 Alc√†sser (Valencia), en adelante <em>LA EMPRESA</em>.</div>
        <div style="margin-bottom:18px">De otra parte: <strong id="ct-cliente-nombre">[CLIENTE]</strong>, con CIF/NIF <strong id="ct-cliente-cif">[CIF]</strong>, domicilio en <span id="ct-cliente-dir">[DIRECCI√ìN]</span>, en adelante <em>EL CLIENTE</em>.</div>
        <div style="margin-bottom:12px"><strong>EXPONEN</strong></div>
        <div style="margin-bottom:8px">I. Que LA EMPRESA se dedica profesionalmente a la ejecuci√≥n de obras de reforma y proyectos de interiorismo.</div>
        <div style="margin-bottom:18px">II. Que EL CLIENTE est√° interesado en contratar los servicios de LA EMPRESA para la realizaci√≥n de los trabajos descritos en el presupuesto aceptado.</div>
        <div style="margin-bottom:12px"><strong>ACUERDAN</strong></div>
        <div style="margin-bottom:8px"><strong>PRIMERA. OBJETO DEL CONTRATO</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA se compromete a ejecutar los trabajos de reforma e interiorismo descritos en el presupuesto n¬∫ <strong id="ct-pres-id">[PRES]</strong> para el proyecto <strong id="ct-proyecto-nombre">[PROYECTO]</strong>, sito en <span id="ct-proyecto-dir">[DIRECCI√ìN OBRA]</span>.</div>
        <div style="margin-bottom:8px"><strong>SEGUNDA. PRECIO</strong></div>
        <div style="margin-bottom:14px">El precio total de los trabajos asciende a <strong id="ct-importe">[IMPORTE]</strong> (IVA incluido), seg√∫n el presupuesto aceptado por el cliente.</div>
        <div style="margin-bottom:8px"><strong>TERCERA. FORMA DE PAGO</strong></div>
        <div style="margin-bottom:4px">El pago se realizar√° de la siguiente forma:</div>
        <div style="margin-left:16px;margin-bottom:14px">
          <div>‚Äî 40% a la firma del presente contrato</div>
          <div>‚Äî 30% al inicio de los trabajos</div>
          <div>‚Äî 30% a la finalizaci√≥n y entrega de la obra</div>
        </div>
        <div style="margin-bottom:8px"><strong>CUARTA. PLAZO DE EJECUCI√ìN</strong></div>
        <div style="margin-bottom:14px">El plazo estimado de ejecuci√≥n es de <input id="ct-plazo" style="border:none;border-bottom:1px solid #333;width:40px;text-align:center;font-size:12px" value="90"> d√≠as naturales, contados desde la fecha de inicio de los trabajos.</div>
        <div style="margin-bottom:8px"><strong>QUINTA. MODIFICACIONES</strong></div>
        <div style="margin-bottom:14px">Cualquier modificaci√≥n del proyecto inicial deber√° ser acordada por escrito entre ambas partes y dar√° lugar a un presupuesto adicional.</div>
        <div style="margin-bottom:8px"><strong>SEXTA. GARANT√çAS</strong></div>
        <div style="margin-bottom:14px">LA EMPRESA garantiza los trabajos realizados por un per√≠odo de 1 a√±o desde la fecha de entrega, excepto los desperfectos ocasionados por mal uso del cliente.</div>
        <div style="margin-bottom:8px"><strong>S√âPTIMA. CAUSAS DE RESOLUCI√ìN</strong></div>
        <div style="margin-bottom:14px">El incumplimiento de las obligaciones por cualquiera de las partes dar√° derecho a la otra parte a resolver el contrato, con las indemnizaciones que procedan.</div>
        <div style="margin-bottom:8px"><strong>OCTAVA. PROTECCI√ìN DE DATOS</strong></div>
        <div style="margin-bottom:20px">Los datos personales facilitados ser√°n tratados conforme al RGPD (UE) 2016/679.</div>
        <div style="margin-bottom:20px">Y en prueba de conformidad, firman el presente contrato por duplicado en el lugar y fecha indicados.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:32px">
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por LA EMPRESA<br><strong>PAU INTERIORISMO S.L.</strong></div></div>
          <div style="text-align:center"><div style="margin-bottom:40px"></div><div style="border-top:1px solid #333;padding-top:8px;font-size:11px">Por EL CLIENTE<br><strong id="ct-firma-cliente">[CLIENTE]</strong></div></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PEDIDO DOC ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pedido_doc">
      <div class="search-bar" style="flex-wrap:wrap;gap:8px;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-pedido_doc" onchange="cascadaDocPedido()">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:210px" id="filter-proyecto-pedido_doc" onchange="filtrarPedidosPorProyecto()">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <select class="form-input" style="width:200px" id="pd-pedido-sel" onchange="cargarPedidoEnDoc()">
          <option value="">‚Äî Pedido‚Ä¶ ‚Äî</option>
        </select>
        <button class="btn btn-primary" onclick="guardarDocPedido()">üíæ Guardar</button>
        <button class="btn btn-primary" onclick="exportarPDF('pd-doc', (document.getElementById('pd-num-input')?.value||'pedido')+'.pdf')">‚¨áÔ∏è PDF</button>
        <button class="btn btn-ghost" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-ghost btn-sm" onclick="nuevoPedidoDoc()">Ôºã Nuevo</button>
      </div>
      <!-- DOCUMENTO PEDIDO EDITABLE + IMPRIMIBLE -->
      <div id="pd-doc" style="background:white;max-width:720px;margin:0 auto;padding:32px 40px;border:1px solid var(--border);border-radius:var(--radius);font-size:12px;font-family:Arial,sans-serif">
        <!-- CABECERA -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #1a2a3a">
          <div>
            <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
            <div style="color:#666;font-size:10px">C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia)</div>
            <div style="color:#666;font-size:10px"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="650c0b030a251504100c0b1100170c0a170c16080a4b060a08">[email&#160;protected]</a> ¬∑ Tel: 961 20 01 87 ¬∑ CIF: B-56909641</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:700;color:#b87333">PEDIDO</div>
            <div style="font-size:11px;color:#666">N¬∫ <input id="pd-num-input" style="border:none;border-bottom:1px solid #ccc;width:100px;font-size:11px;text-align:right" placeholder="PED-001"></div>
            <div style="font-size:11px;color:#666">Fecha <input id="pd-fecha-input" type="date" style="border:none;border-bottom:1px solid #ccc;font-size:11px"></div>
          </div>
        </div>
        <!-- PROVEEDOR / PROYECTO / CLIENTE -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">
          <div style="background:#f7f4ef;padding:10px;border-radius:4px">
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:5px">PROVEEDOR / EMPRESA</div>
            <input id="pd-prov-input" style="border:none;background:transparent;width:100%;font-weight:700;font-size:12px" placeholder="Nombre proveedor">
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px">
            <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#8a9aaa;margin-bottom:5px">PROYECTO / REFERENCIA</div>
            <input id="pd-proyecto-input" style="border:none;background:transparent;width:100%;font-weight:700;font-size:12px" placeholder="Nombre o referencia del proyecto">
            <input id="pd-ref-doc-input" style="border:none;background:transparent;width:100%;color:#b87333;font-size:11px;font-weight:600;margin-top:3px" placeholder="Referencia del pedido (ej: Azulejo ba√±o modelo X)">
          </div>
        </div>
        <!-- CLIENTE -->
        <div id="pd-cliente-block" style="background:#eef6ff;padding:10px;border-radius:4px;margin-bottom:18px;border-left:3px solid #2a6aad">
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#2a6aad;margin-bottom:6px">CLIENTE FINAL</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <input id="pd-cliente-nombre-input" style="border:none;background:transparent;width:100%;font-weight:700;font-size:12px" placeholder="Nombre cliente">
              <input id="pd-cliente-dir-input" style="border:none;background:transparent;width:100%;font-size:11px;color:#555;margin-top:2px" placeholder="Direcci√≥n">
            </div>
            <div>
              <input id="pd-cliente-nif-input" style="border:none;background:transparent;width:100%;font-size:11px;color:#555" placeholder="NIF/CIF">
              <input id="pd-cliente-tel-input" style="border:none;background:transparent;width:100%;font-size:11px;color:#555;margin-top:2px" placeholder="Tel√©fono">
            </div>
          </div>
        </div>
        <!-- TABLA DE L√çNEAS -->
        <table style="width:100%;border-collapse:collapse;margin-bottom:16px" id="pd-lineas-table">
          <thead>
            <tr style="background:#1a2a3a;color:white">
              <th style="padding:7px 10px;text-align:center;width:60px">Cant.</th>
              <th style="padding:7px 10px;text-align:left">Descripci√≥n / Concepto</th>
            </tr>
          </thead>
          <tbody id="pd-lineas-body">
            <!-- L√≠neas generadas din√°micamente -->
          </tbody>
        </table>
        <div class="no-print" style="margin-bottom:16px">
          <button class="btn btn-ghost btn-sm" onclick="addPedidoLinea()">Ôºã A√±adir l√≠nea</button>
          <button class="btn btn-ghost btn-sm" onclick="clearPedidoLineas()">üóë Limpiar todo</button>
        </div>
        <!-- NOTA / INSTRUCCIONES FIJAS -->
        <div style="border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:14px;font-size:11px">
          <textarea id="pd-nota-input" style="border:none;width:100%;resize:none;font-size:11px;font-family:Arial" rows="3" placeholder="Instrucciones de entrega...">SERVIR LO ANTES POSIBLE.

DIRECCI√ìN DE ENTREGA AV. DIPUTACI√ìN N¬∫ 24 - ALCASSER 46290 (VALENCIA)
HORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.
TELFN. CONTACTO 677 970 074 ATENCI√ìN DE JOSE.</textarea>
        </div>
        <!-- PIE -->
        <div style="color:#666;font-size:10px;text-align:center;border-top:1px solid #eee;padding-top:10px">
          PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d1b8bfb7be91a1b0a4b8bfa5b4a3b8bea3b8a2bcbeffb2bebc">[email&#160;protected]</a>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê INFORME MENSUAL ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-informe_mensual">
      <div class="search-bar" style="gap:8px;align-items:center">
        <select class="form-input" style="width:140px" id="inf-mes">
          <option value="1">Enero</option><option value="2">Febrero</option>
          <option value="3">Marzo</option><option value="4">Abril</option>
          <option value="5">Mayo</option><option value="6">Junio</option>
          <option value="7">Julio</option><option value="8">Agosto</option>
          <option value="9">Septiembre</option><option value="10">Octubre</option>
          <option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>
        <select class="form-input" style="width:90px" id="inf-anyo">
          <option>2024</option><option>2025</option><option selected>2026</option><option>2027</option>
        </select>
        <button class="btn btn-primary" onclick="generarInformeMensual()">üìä Generar informe</button>
        <button class="btn btn-ghost" onclick="exportarPDF(document.getElementById('inf-body').firstElementChild,'Informe_'+document.getElementById('inf-mes').value+'_'+document.getElementById('inf-anyo').value+'.pdf')">‚¨áÔ∏è PDF</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="card-body" id="inf-body">
          <div style="text-align:center;padding:40px;color:var(--text-soft)">
            <div style="font-size:32px;margin-bottom:10px">üìÖ</div>
            <div style="font-size:14px">Selecciona mes y a√±o y pulsa Generar</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LISTAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-listas">
      <div class="info-box">üóÇ Gestiona los valores de los desplegables de toda la aplicaci√≥n. Los cambios se guardan autom√°ticamente.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px">
        
        <div class="card">
          <div class="card-header"><div class="card-title">üë∑ Trabajadores</div><button class="btn btn-ghost btn-sm" onclick="addListItem('trabajadores-list','trabajador')">Ôºã A√±adir</button></div>
          <div class="card-body" id="trabajadores-list">
            <div class="lista-item" data-val="Paco">Paco</div>
            <div class="lista-item" data-val="Ra√∫l">Ra√∫l</div>
            <div class="lista-item" data-val="Boro">Boro</div>
            <div class="lista-item" data-val="Julio">Julio</div>
            <div class="lista-item" data-val="Pau">Pau</div>
            <div class="lista-item" data-val="Jose Asins">Jose Asins</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üìÅ Estados proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estados-list','estado')">Ôºã A√±adir</button></div>
          <div class="card-body" id="estados-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üèó Tipos proyecto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proyecto-list','tipo')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-proyecto-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üí∂ IVA</div><small style="color:var(--text-light);font-size:10px">Fijo por ley</small></div>
          <div class="card-body">
            <div class="lista-item">Exento</div><div class="lista-item">4%</div><div class="lista-item">10%</div><div class="lista-item">21%</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üí≥ Formas de pago</div><button class="btn btn-ghost btn-sm" onclick="addListItem('formas-pago-list','forma pago')">Ôºã A√±adir</button></div>
          <div class="card-body" id="formas-pago-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üè≠ Tipos proveedor</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-proveedor-list','tipo')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-proveedor-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üë• Tipos cliente</div><button class="btn btn-ghost btn-sm" onclick="addListItem('tipos-cliente-list','tipo cliente')">Ôºã A√±adir</button></div>
          <div class="card-body" id="tipos-cliente-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üõã Estancias</div><button class="btn btn-ghost btn-sm" onclick="addListItem('estancias-list','estancia')">Ôºã A√±adir</button></div>
          <div class="card-body" id="estancias-list"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">üè∑ Categor√≠as tarifario</div><button class="btn btn-ghost btn-sm" onclick="addListItem('categorias-list','categor√≠a')">Ôºã A√±adir</button></div>
          <div class="card-body" id="categorias-list"></div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header">
            <div class="card-title">üìÇ Familias del tarifario <span style="font-size:11px;font-weight:400;color:var(--text-soft)">‚Äî agrupaciones dentro de cada categor√≠a</span></div>
            <button class="btn btn-ghost btn-sm" onclick="addFamiliaTarifario()">Ôºã A√±adir familia</button>
          </div>
          <div id="familias-tarifario-container" style="padding:12px">
            <div style="color:var(--text-soft);font-size:12px;text-align:center;padding:20px">Cargando familias‚Ä¶</div>
          </div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">üìÇ Partidas presupuesto</div><button class="btn btn-ghost btn-sm" onclick="addListItem('partidas-list','partida')">Ôºã A√±adir</button></div>
          <div class="card-body" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px" id="partidas-list">
            <div class="lista-item">01.Demoliciones</div><div class="lista-item">02.Alba√±iler√≠a</div><div class="lista-item">03.Instalaciones</div><div class="lista-item">04.Revestimientos</div><div class="lista-item">05.Fontaner√≠a</div><div class="lista-item">06.Electricidad</div><div class="lista-item">07.Carpinter√≠a</div><div class="lista-item">08.Pintura</div><div class="lista-item">09.Estructura</div><div class="lista-item">10.Cubierta</div><div class="lista-item">11.Fachada</div><div class="lista-item">12.Mobiliario</div><div class="lista-item">13.Climatizaci√≥n</div><div class="lista-item">14.Varios</div><div class="lista-item">15.Otros</div>
          </div>
        </div>

        <div class="card" style="grid-column:1/-1">
          <div class="card-header"><div class="card-title">üèñ Causas de ausencia (Control horario)</div></div>
          <div class="card-body" style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="lista-item">Vacaciones</div><div class="lista-item">Baja m√©dica</div><div class="lista-item">Permiso</div><div class="lista-item">Festivo</div><div class="lista-item">Teletrabajo</div><div class="lista-item">Formaci√≥n</div><div class="lista-item">Otros</div>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GERENCIA ‚ïê‚ïê‚ïê -->
    <div class="view active" id="view-gerencia">
      <div class="kpi-grid">
        <div class="kpi blue"><div class="kpi-label">Total Ventas (Base Imp.)</div><div class="kpi-value" id="g-ventas">‚Äî</div><div class="kpi-sub">Facturas emitidas</div></div>
        <div class="kpi red"><div class="kpi-label">Total Costes (Base Imp.)</div><div class="kpi-value" id="g-costes">‚Äî</div><div class="kpi-sub">Facturas recibidas</div></div>
        <div class="kpi green"><div class="kpi-label">Beneficio Neto</div><div class="kpi-value" id="g-benef">‚Äî</div><div class="kpi-sub">Ventas ‚àí Costes (base imp.)</div></div>
        <div class="kpi amber"><div class="kpi-label">Margen Neto %</div><div class="kpi-value" id="g-margen">‚Äî</div><div class="kpi-sub">Sobre base imponible</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Resumen econ√≥mico -->
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Resumen econ√≥mico</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Importe ‚Ç¨</span><span>%</span></div>
            <div class="cuenta-row"><span>Total Ventas (Base Imp.)</span><span id="ge-ventas">‚Äî</span><span>100%</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span id="ge-iva-rep">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--text-soft)">‚Äî Compras (fact. recibidas)</span><span id="ge-compras">‚Äî</span><span id="ge-compras-pct">‚Äî</span></div>
            <div class="cuenta-row" style="display:none"><span></span><span id="ge-subcs">‚Äî</span><span id="ge-subcs-pct"></span></div>
            <div class="cuenta-row" style="display:none"><span></span><span id="ge-mo">‚Äî</span><span id="ge-mo-pct"></span></div>
            <div class="cuenta-row total"><span>TOTAL COSTES (Base Imp.)</span><span id="ge-costes-tot">‚Äî</span><span id="ge-costes-pct">‚Äî</span></div>
            <div class="cuenta-row result" id="ge-result-row"><span>BENEFICIO NETO</span><span id="ge-beneficio">‚Äî</span><span id="ge-benef-pct">‚Äî</span></div>
          </div>
        </div>
        <!-- Proyectos por estado -->
        <div class="card">
          <div class="card-header"><div class="card-title">üìÅ Proyectos por estado</div></div>
          <div class="card-body" style="padding:0" id="g-estados"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Seguimiento cobros -->
        <div class="card">
          <div class="card-header"><div class="card-title">üí∞ Seguimiento de cobros</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Facturado</span><span id="gc-facturado">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">‚úÖ Cobrado</span><span id="gc-cobrado">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente cobro</span><span id="gc-pendiente">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--red)">‚ùå Vencidas</span><span id="gc-vencidas">‚Äî</span><span></span></div>
          </div>
        </div>
        <!-- Seguimiento pagos -->
        <div class="card">
          <div class="card-header"><div class="card-title">üè¶ Seguimiento de pagos</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total Compras</span><span id="gp-compras">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--green)">‚úÖ Pagado proveedores</span><span id="gp-pagado-prov">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente proveedores</span><span id="gp-pdte-prov">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Total Subcontratas</span><span id="gp-subcs">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span style="color:var(--amber)">‚è≥ Pendiente subcontr.</span><span id="gp-pdte-sub">‚Äî</span><span></span></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <!-- Control horas -->
        <div class="card">
          <div class="card-header"><div class="card-title">‚è± Control de horas</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>Total horas registradas</span><span id="gh-horas">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Coste total MO</span><span id="gh-coste">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>Coste medio / hora</span><span id="gh-medio">‚Äî</span><span></span></div>
          </div>
        </div>
        <!-- IVA -->
        <div class="card">
          <div class="card-header"><div class="card-title">üßæ IVA trimestral</div></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row"><span>IVA Repercutido (ventas)</span><span id="gi-rep">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (compras)</span><span id="gi-comp">‚Äî</span><span></span></div>
            <div class="cuenta-row"><span>IVA Soportado (subcontr.)</span><span id="gi-sub">‚Äî</span><span></span></div>
            <div class="cuenta-row total"><span>IVA NETO A INGRESAR</span><span id="gi-neto">‚Äî</span><span></span></div>
          </div>
        </div>
      </div>
      <!-- Rentabilidad por proyecto tabla -->
      <div class="card">
        <div class="card-header" style="flex-wrap:wrap;gap:8px">
          <div class="card-title">üìà Rentabilidad por proyecto</div>
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <span style="font-size:11px;color:var(--text-soft)">Mostrar:</span>
            <button id="grent-btn-activos" class="btn btn-primary btn-sm" style="font-size:11px" onclick="filtrarGrentTable('activos')">En ejecuci√≥n</button>
            <button id="grent-btn-alerta" class="btn btn-ghost btn-sm" style="font-size:11px" onclick="filtrarGrentTable('alerta')">‚ö†Ô∏è Con alerta</button>
            <button id="grent-btn-todos" class="btn btn-ghost btn-sm" style="font-size:11px" onclick="filtrarGrentTable('todos')">Todos</button>
            <span id="grent-count" style="font-size:11px;color:var(--text-soft);margin-left:4px"></span>
          </div>
        </div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Proyecto</th><th>Estado</th><th>Ventas (base)</th><th>Costes (base)</th><th>Beneficio Neto</th><th>Margen %</th></tr></thead>
        <tbody id="g-rent-table"><tr><td colspan="7" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
        <div id="grent-expand-wrap" style="display:none;text-align:center;padding:8px;border-top:1px solid var(--border)">
          <button class="btn btn-ghost btn-sm" id="grent-expand-btn" onclick="toggleGrentExpand()" style="font-size:11px">‚ñº Ver todos los proyectos</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê PANEL DE ALERTAS ‚ïê‚ïê‚ïê -->
      <div class="card" style="margin-top:14px">
        <div class="card-header">
          <div class="card-title">üö® Alertas de rentabilidad</div>
          <div id="alertas-count" style="font-size:12px;color:var(--text-soft)"></div>
        </div>
        <div class="card-body" id="alertas-body" style="padding:0">
          <div style="text-align:center;padding:20px;color:var(--text-soft)">Cargando alertas‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê AGENDA ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-agenda">
      <div class="search-bar">
        <button class="btn btn-primary" onclick="openAgendaModal()">Ôºã Nuevo aviso</button>
        <div style="display:flex;gap:6px;margin-left:auto;align-items:center">
          <select class="form-input" style="width:140px" id="ag-filtro" onchange="renderAgenda()">
            <option value="todos">Todos</option>
            <option value="pendiente">Pendientes</option>
            <option value="hoy">Hoy</option>
            <option value="esta_semana">Esta semana</option>
            <option value="completado">Completados</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="loadAgenda()">üîÑ</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi-grid-3" style="grid-template-columns:repeat(3,1fr)">
        <div class="kpi amber">
          <div class="kpi-label">‚è≥ Pendientes</div>
          <div class="kpi-value" id="ag-kpi-pendientes">‚Äî</div>
          <div class="kpi-sub">Por completar</div>
        </div>
        <div class="kpi red">
          <div class="kpi-label">üî¥ Vencidos</div>
          <div class="kpi-value" id="ag-kpi-vencidos">‚Äî</div>
          <div class="kpi-sub">Ya pasaron</div>
        </div>
        <div class="kpi green">
          <div class="kpi-label">‚úÖ Completados</div>
          <div class="kpi-value" id="ag-kpi-completados">‚Äî</div>
          <div class="kpi-sub">Este mes</div>
        </div>
      </div>

      <!-- HOY -->
      <div class="card" id="ag-card-hoy" style="border-left:4px solid var(--copper);display:none">
        <div class="card-header">
          <div class="card-title">üìÖ Hoy</div>
        </div>
        <div class="card-body" id="ag-hoy-list"></div>
      </div>

      <!-- PR√ìXIMOS -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üîî Avisos y citas</div>
        </div>
        <div class="card-body" style="padding:0">
          <div class="table-wrap">
            <table>
              <thead><tr>
                <th style="width:40px"></th>
                <th>Descripci√≥n</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Tipo</th>
                <th>Proyecto</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th style="width:90px"></th>
              </tr></thead>
              <tbody id="ag-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CLIENTES ‚ïê‚ïê‚ïê -->

    <div class="view" id="view-clientes">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-clientes" placeholder="Buscar cliente‚Ä¶" oninput="filterTable('clientes-tbody','search-clientes')"></div>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-import-clientes')" style="border:1px dashed var(--border)">üì§ Importar Holded</button>
        <button class="btn btn-primary" onclick="openModal('m-cliente')">Ôºã Nuevo cliente</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ü§ù Clientes<span id="clientes-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>CIF</th><th>Tel√©fono</th><th>Email</th><th>Tipo</th><th></th></tr></thead>
        <tbody id="clientes-tbody"><tr><td colspan="7" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROYECTOS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-proyectos">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap">
        <select class="form-input" style="width:240px;flex-shrink:0" id="filter-cliente-proyectos" onchange="filtrarProyectosPorCliente()">
          <option value="">üë§ Todos los clientes</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:180px"><span class="search-icon">üîç</span><input class="form-input" id="search-proyectos" placeholder="Buscar proyecto‚Ä¶" oninput="filterTable('proyectos-tbody','search-proyectos')"></div>
        <button class="btn btn-primary" onclick="openModal('m-proyecto')">Ôºã Nuevo proyecto</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üìÅ Proyectos<span id="proyectos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>ID</th><th>Nombre</th><th>Cliente</th><th>Tipo</th><th>Estado</th><th>Responsable</th><th>Inicio</th><th></th></tr></thead>
        <tbody id="proyectos-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PRESUPUESTO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-presupuesto">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-presupuesto" onchange="cascadaClienteProyecto('presupuesto')">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px" id="pres-proyecto-sel" onchange="loadPresupuesto()"><option value="">üìÅ Proyecto‚Ä¶</option></select>
        <select class="form-input" style="width:75px" id="pres-version-sel" onchange="loadPresupuesto()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
        <button class="btn btn-primary" onclick="addLineaPresupuesto()">Ôºã L√≠nea</button>
        <button class="btn btn-ghost" onclick="addCapituloPresupuesto()">Ôºã Cap√≠tulo</button>
        <button class="btn btn-ghost" id="btn-comparativa" style="display:none" onclick="abrirComparativa()">‚öñÔ∏è Comparar</button>
        <button class="btn btn-primary no-print" onclick="exportarPresupuestoPDF()">‚¨áÔ∏è Descargar PDF</button>
        <button class="btn btn-ghost no-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <div id="pres-total-lbl" style="margin-left:auto;font-size:13px;font-weight:700;color:var(--navy)"></div>
      </div>
      <div id="pres-resumen" style="display:none">
        <div class="kpi-grid" style="margin-bottom:12px">
          <div class="kpi blue"><div class="kpi-label">Base (s/CI)</div><div class="kpi-value" id="pres-k-base">‚Äî</div></div>
          <div class="kpi amber"><div class="kpi-label">CI+GG+BI</div><div class="kpi-value" id="pres-k-ci">‚Äî</div></div>
          <div class="kpi green"><div class="kpi-label">Total s/IVA</div><div class="kpi-value" id="pres-k-total">‚Äî</div></div>
          <div class="kpi red"><div class="kpi-label">Total c/IVA 10%</div><div class="kpi-value" id="pres-k-iva">‚Äî</div></div>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>#</th><th>Descripci√≥n</th><th>Ud.</th><th>Cant.</th><th>Precio Base</th><th>Margen %</th><th>CI+GG+BI</th><th>P.Venta</th><th>Subtotal</th><th>IVA</th><th></th></tr></thead>
        <tbody id="pres-tbody"><tr><td colspan="11"><div class="empty"><div class="empty-icon">üí∞</div><div class="empty-text">Selecciona un proyecto</div></div></td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê COMPARATIVA OFERTAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-comparativa">
      <div class="info-box">‚öñÔ∏è Compara hasta 3 ofertas de distintos proveedores para cada trabajo o material. Elige la m√°s ventajosa.</div>
      <div class="search-bar">
        <select class="form-input" style="width:200px" id="filter-cliente-comparativa" onchange="cascadaClienteComparativa()">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:240px" id="comp-proyecto-sel" onchange="loadComparativa()">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <button class="btn btn-primary" id="btn-nueva-comparativa" onclick="abrirNuevaComparativa()" style="display:none">Ôºã Nueva comparativa</button>
      </div>
      <div id="comp-list"><div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Selecciona un cliente y proyecto</div></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê TARIFARIO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-tarifario">
      <!-- Barra superior -->
      <div class="search-bar" style="margin-bottom:12px">
        <div class="search-wrap" style="flex:1"><span class="search-icon">üîç</span><input class="form-input" id="search-tarifario" placeholder="Buscar en todo el tarifario‚Ä¶" oninput="buscarTarifario()"></div>
        <button class="btn btn-primary" onclick="abrirNuevoTarifario()">Ôºã Nuevo art√≠culo</button>
      </div>
      <!-- Layout √°rbol + contenido -->
      <div style="display:flex;gap:12px;align-items:flex-start">
        <!-- Sidebar √°rbol -->
        <div id="tarif-tree" style="width:210px;flex-shrink:0;background:white;border-radius:10px;border:1px solid var(--border);overflow:hidden">
          <div style="padding:10px 12px;background:var(--navy);color:white;font-size:12px;font-weight:700;display:flex;justify-content:space-between;align-items:center">
            <span>üìÇ Categor√≠as</span>
            <span id="tarif-total-badge" style="background:rgba(255,255,255,.2);border-radius:10px;padding:1px 7px;font-size:11px"></span>
          </div>
          <div id="tarif-tree-body" style="max-height:calc(100vh - 220px);overflow-y:auto"></div>
        </div>
        <!-- Panel principal -->
        <div style="flex:1;min-width:0">
          <div id="tarif-breadcrumb" style="font-size:12px;color:var(--text-soft);margin-bottom:8px;padding:6px 10px;background:white;border-radius:8px;border:1px solid var(--border)">
            üìã Tarifario completo &mdash; <span id="tarifario-count" style="color:var(--navy);font-weight:700"></span>
          </div>
          <div id="tarif-main-panel"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CYPE ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-cype">
      <div class="info-box">üìê <strong>524 partidas CYPE 2026</strong> importadas. Base de precios centralizada.</div>
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-cype" placeholder="Buscar por c√≥digo, descripci√≥n o cap√≠tulo‚Ä¶" oninput="filterCype()"></div>
        <select class="form-input" style="width:200px" id="filter-cype-cap" onchange="filterCype()"><option value="">Todos los cap√≠tulos</option></select>
      </div>
      <div class="card">
        <div class="table-wrap"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Ud.</th><th>Precio s/IVA</th><th>Cap√≠tulo</th></tr></thead>
        <tbody id="cype-tbody"><tr><td colspan="5" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê INTERIORISMO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-interiorismo">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:195px;flex-shrink:0" id="filter-cliente-interiorismo" onchange="cascadaModuloInt()">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:215px;flex-shrink:0" id="filter-proyecto-interiorismo" onchange="filtrarInteriorismo()">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span><input class="form-input" id="search-interiorismo" placeholder="Buscar‚Ä¶" oninput="filterTable('interiorismo-tbody','search-interiorismo')"></div>
        <button class="btn btn-copper" onclick="openModal('m-interiorismo')">Ôºã A√±adir art√≠culo</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üõã Interiorismo & Mobiliario<span id="interiorismo-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Proyecto</th><th>Estancia</th><th>Ref.</th><th>Descripci√≥n</th><th>Cant.</th><th>PVP Neto</th><th>Margen</th><th>Est. Prop.</th><th>Est. Pedido</th><th></th></tr></thead>
        <tbody id="interiorismo-tbody"><tr><td colspan="10" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê COMPRAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-compras">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-compras" onchange="cascadaClienteProyecto('compras')">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-compras" onchange="filtrarModuloPorProyecto('compras')">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span><input class="form-input" id="search-compras" placeholder="Buscar‚Ä¶" oninput="filterTable('compras-tbody','search-compras')"></div>
        <button class="btn btn-primary" onclick="openModal('m-compra')">Ôºã Nueva compra</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üõí Compras<span id="compras-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Proveedor</th><th>Concepto</th><th>Base Imp.</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="compras-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SUBCONTRATAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-subcontratas">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-subcontratas" onchange="cascadaClienteProyecto('subcontratas')">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-subcontratas" onchange="filtrarModuloPorProyecto('subcontratas')">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span><input class="form-input" id="search-subcontratas" placeholder="Buscar‚Ä¶" oninput="filterTable('subcontratas-tbody','search-subcontratas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-subcontrata')">Ôºã Nueva subcontrata</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üë∑ Subcontratas<span id="subcontratas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Subcontratista</th><th>Trabajo</th><th>Importe</th><th>IVA</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="subcontratas-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê HORAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-horas">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-horas" onchange="cascadaClienteProyecto('horas')">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-horas" onchange="filtrarModuloPorProyecto('horas')">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span><input class="form-input" id="search-horas" placeholder="Buscar‚Ä¶" oninput="filterTable('horas-tbody','search-horas')"></div>
        <button class="btn btn-primary" onclick="openModal('m-hora')">Ôºã Registrar horas</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">‚è± Horas<span id="horas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Proyecto</th><th>Trabajador</th><th>Horas</th><th>‚Ç¨/h</th><th>Total</th><th>Descripci√≥n</th><th></th></tr></thead>
        <tbody id="horas-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PEDIDOS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-pedidos">
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;align-items:center">
        <select class="form-input" style="width:200px;flex-shrink:0" id="filter-cliente-pedidos" onchange="cascadaClienteProyecto('pedidos')">
          <option value="">üë§ Cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:220px;flex-shrink:0" id="filter-proyecto-pedidos" onchange="filtrarModuloPorProyecto('pedidos')">
          <option value="">üìÅ Proyecto‚Ä¶</option>
        </select>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span><input class="form-input" id="search-pedidos" placeholder="Buscar‚Ä¶" oninput="filterTable('pedidos-tbody','search-pedidos')"></div>
        <button class="btn btn-primary" onclick="openPedidoModal()">Ôºã Nuevo pedido</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üì¶ Registro de pedidos<span id="pedidos-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>N¬∫ Pedido</th><th>Fecha</th><th>Proyecto</th><th>Tipo</th><th>Proveedor/Empresa</th><th>Importe</th><th>Estado</th><th>Observaciones</th><th></th></tr></thead>
        <tbody id="pedidos-tbody"><tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTROL HORARIO ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-control_horario">
      <div class="search-bar">
        <select class="form-input" style="width:160px" id="ch-trab-sel" onchange="loadControlHorario()"><option value="">Seleccionar trabajador‚Ä¶</option></select>
        <select class="form-input" style="width:100px" id="ch-year-sel" onchange="loadControlHorario()">
          <option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <div id="ch-resumen" style="margin-left:auto;font-size:12px;color:var(--text-soft)"></div>
      </div>
      <div id="ch-meses-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROVEEDORES ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-proveedores">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">üîç</span><input class="form-input" id="search-proveedores" placeholder="Buscar‚Ä¶" oninput="filterTable('proveedores-tbody','search-proveedores')"></div>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-import-proveedores')" style="border:1px dashed var(--border)">üì§ Importar Holded</button>
        <button class="btn btn-primary" onclick="abrirNuevoProveedor()">Ôºã Nuevo proveedor</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üè≠ Proveedores<span id="proveedores-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div></div>
        <div class="table-wrap"><table><thead><tr><th>Nombre</th><th>CIF</th><th>Tipo</th><th>Especialidad</th><th>Tel√©fono</th><th>Email</th><th>F.Pago</th><th></th></tr></thead>
        <tbody id="proveedores-tbody"><tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RENTABILIDAD ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-rentabilidad">
      <div class="search-bar">
        <select class="form-input" style="width:220px" id="rent-cliente-sel" onchange="filtrarProyectosRentabilidad()">
          <option value="">üìÅ Seleccionar cliente‚Ä¶</option>
        </select>
        <select class="form-input" style="width:280px" id="rent-proyecto-sel" onchange="loadRentabilidad()" disabled>
          <option value="">‚Äî Selecciona cliente primero ‚Äî</option>
        </select>
        <select class="form-input" style="width:75px" id="rent-version-sel" onchange="loadRentabilidad()"><option value="v1">v1</option><option value="v2">v2</option><option value="v3">v3</option></select>
      </div>
      <div id="rent-kpis" style="display:none">
        <div class="kpi-grid">
          <div class="kpi blue"><div class="kpi-label">Presupuesto (s/IVA)</div><div class="kpi-value" id="rk-pres">‚Äî</div></div>
          <div class="kpi red"><div class="kpi-label">Coste real total</div><div class="kpi-value" id="rk-coste">‚Äî</div></div>
          <div class="kpi green"><div class="kpi-label">Beneficio bruto</div><div class="kpi-value" id="rk-benef">‚Äî</div></div>
          <div class="kpi amber"><div class="kpi-label">Margen real %</div><div class="kpi-value" id="rk-margen">‚Äî</div></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Coste vs Presupuesto</div></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span id="rent-bar-label"></span><span id="rent-bar-nums"></span></div>
            <div class="prog-wrap"><div id="rent-bar" class="prog-bar" style="width:0%;background:var(--green)"></div></div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
          <div class="card"><div class="card-header"><div class="card-title">üõí Compras</div><div id="rk-compras-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-compras-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">üë∑ Subcontratas</div><div id="rk-sub-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-sub-list"></tbody></table></div></div>
          <div class="card"><div class="card-header"><div class="card-title">‚è± Horas</div><div id="rk-horas-total" style="font-weight:700;color:var(--red)"></div></div><div style="padding:0"><table style="width:100%;font-size:12px;border-collapse:collapse"><tbody id="rk-horas-list"></tbody></table></div></div>
        </div>
        <div class="card"><div class="card-header"><div class="card-title">üßæ Facturas emitidas</div><div id="rk-fact-total" style="font-weight:700;color:var(--green)"></div></div><div class="table-wrap"><table><thead><tr><th>N¬∫ Factura</th><th>Fecha</th><th>Base Imp.</th><th>Total c/IVA</th><th>Estado</th></tr></thead><tbody id="rk-fact-list"></tbody></table></div></div>
      </div>
      <div id="rent-empty" class="empty"><div class="empty-icon">üìÅ</div><div class="empty-text">Selecciona un cliente y luego el proyecto para ver su rentabilidad</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê FACTURAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-facturas">

      <!-- ‚ïê‚ïê‚ïê PANEL RESUMEN ‚ïê‚ïê‚ïê -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
        <!-- VENTAS -->
        <div class="card" style="border-top:3px solid var(--green)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--green);margin-bottom:8px">üì§ Facturas de Venta</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Total facturado</span>
              <span style="font-size:13px;font-weight:700" id="fk-v-total">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Cobrado</span>
              <span style="font-size:12px;font-weight:700;color:var(--green)" id="fk-v-cobrado">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pendiente cobro</span>
              <span style="font-size:12px;font-weight:700;color:var(--amber)" id="fk-v-pendiente">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="font-size:11px;color:var(--text-soft)">Vencidas</span>
              <span style="font-size:12px;font-weight:700;color:var(--red)" id="fk-v-vencidas">‚Äî</span>
            </div>
          </div>
        </div>
        <!-- COMPRAS -->
        <div class="card" style="border-top:3px solid var(--red)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--red);margin-bottom:8px">üì• Facturas de Compra</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Total recibido</span>
              <span style="font-size:13px;font-weight:700" id="fk-c-total">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pagado</span>
              <span style="font-size:12px;font-weight:700;color:var(--green)" id="fk-c-pagado">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Pendiente pago</span>
              <span style="font-size:12px;font-weight:700;color:var(--amber)" id="fk-c-pendiente">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span style="font-size:11px;color:var(--text-soft)">IVA soportado</span>
              <span style="font-size:12px;font-weight:700;color:var(--copper)" id="fk-c-iva">‚Äî</span>
            </div>
          </div>
        </div>
        <!-- BALANCE -->
        <div class="card" style="border-top:3px solid var(--navy)">
          <div class="card-body" style="padding:12px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--navy);margin-bottom:8px">‚öñÔ∏è Balance</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Beneficio bruto</span>
              <span style="font-size:14px;font-weight:700" id="fk-b-beneficio">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:11px;color:var(--text-soft)">Margen</span>
              <span style="font-size:13px;font-weight:700" id="fk-b-margen">‚Äî</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span style="font-size:11px;color:var(--text-soft)">IVA a liquidar</span>
              <span style="font-size:12px;font-weight:700;color:var(--copper)" id="fk-b-iva">‚Äî</span>
            </div>
            <div style="background:var(--border);border-radius:4px;height:8px;overflow:hidden">
              <div id="fk-b-bar" style="height:8px;width:0%;background:var(--green);border-radius:4px;transition:width .4s"></div>
            </div>
            <div style="font-size:10px;color:var(--text-soft);margin-top:3px" id="fk-b-bar-lbl">Gastos sobre ingresos</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê TABS + B√öSQUEDA ‚ïê‚ïê‚ïê -->
      <div class="search-bar" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <div style="display:flex;border:1px solid var(--border);border-radius:6px;overflow:hidden">
          <button id="ftab-todas"  class="btn" style="border-radius:0;background:var(--navy);color:white;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('todas')">Todas</button>
          <button id="ftab-venta"  class="btn btn-ghost" style="border-radius:0;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('Venta')">üì§ Ventas</button>
          <button id="ftab-compra" class="btn btn-ghost" style="border-radius:0;font-size:12px;padding:6px 12px" onclick="filtrarTabFacturas('Compra')">üì• Compras</button>
        </div>
        <div class="search-wrap" style="flex:1;min-width:160px"><span class="search-icon">üîç</span>
          <input class="form-input" id="search-facturas" placeholder="Buscar n¬∫, cliente, proveedor‚Ä¶" oninput="filtrarFacturas()">
        </div>
        <select class="form-input" style="width:160px" id="filt-fac-contra" onchange="filtrarFacturas()">
          <option value="">‚Äî Cliente / Proveedor ‚Äî</option>
        </select>
        <select class="form-input" style="width:150px" id="filt-fac-vto" onchange="filtrarFacturas()">
          <option value="">‚Äî Vencimiento ‚Äî</option>
        </select>
        <select class="form-input" style="width:120px" id="filt-fac-estado" onchange="filtrarFacturas()">
          <option value="">‚Äî Estado ‚Äî</option>
          <option>Pendiente</option><option>Cobrada</option><option>Pagada</option>
          <option>Parcial</option><option>Vencida</option><option>Anulada</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="limpiarFiltrosFacturas()">‚úï Limpiar</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('m-importar-holded')" style="border:1px dashed var(--border)">üì§ Importar Holded</button>
        <button class="btn btn-ghost btn-sm" onclick="exportarInformeFacturas()" style="border:1px solid var(--border)">üìÑ Exportar PDF</button>
        <button class="btn btn-primary" onclick="abrirNuevaFactura('Venta')">üì§ Nueva venta</button>
        <button class="btn" style="background:#fdecea;color:var(--red);border:1px solid #f5c6c6" onclick="abrirNuevaFactura('Compra')">üì• Nueva compra</button>
      </div>

      <!-- ‚ïê‚ïê‚ïê TABLA ‚ïê‚ïê‚ïê -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üßæ Facturas <span id="facturas-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
        </div>
        <div class="table-wrap"><table>
          <thead><tr>
            <th>Tipo</th><th>N¬∫ Factura</th><th>Fecha</th><th>Vto.</th>
            <th>Cliente / Proveedor</th><th>Proyecto</th>
            <th>Base imp.</th><th>IVA%</th><th>Total</th>
            <th>Cobrado/Pagado</th><th>Pendiente</th><th>Estado</th><th></th>
          </tr></thead>
          <tbody id="facturas-tbody"><tr><td colspan="13" class="loading">Cargando‚Ä¶</td></tr></tbody>
        </table></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONTABILIDAD ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-conciliacion">

  <!-- ‚ïê‚ïê‚ïê PANEL SUPERIOR: ESTADO GIROS ‚ïê‚ïê‚ïê -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:14px">
    <div class="kpi red"><div class="kpi-label">‚è∞ Vencen esta semana</div><div class="kpi-value" id="conc-semana">‚Äî</div></div>
    <div class="kpi amber"><div class="kpi-label">üìÖ Vencen este mes</div><div class="kpi-value" id="conc-mes">‚Äî</div></div>
    <div class="kpi blue"><div class="kpi-label">üìã Pendientes de pago</div><div class="kpi-value" id="conc-pendientes">‚Äî</div></div>
    <div class="kpi green"><div class="kpi-label">‚úÖ Pagadas este mes</div><div class="kpi-value" id="conc-pagadas">‚Äî</div></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PR√ìXIMOS VENCIMIENTOS ‚ïê‚ïê‚ïê -->
  <div class="card" style="margin-bottom:14px">
    <div class="card-header">
      <div class="card-title">‚è∞ Pr√≥ximos vencimientos <span id="venc-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <select class="form-input" id="venc-filtro" style="width:160px;font-size:12px" onchange="loadConciliacion()">
          <option value="30">Pr√≥ximos 30 d√≠as</option>
          <option value="60">Pr√≥ximos 60 d√≠as</option>
          <option value="90">Pr√≥ximos 90 d√≠as</option>
          <option value="todos">Todos pendientes</option>
        </select>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Vencimiento</th><th>D√≠as</th><th>Proveedor</th><th>Concepto</th>
        <th>Forma pago</th><th>Proyecto</th><th>Base imp.</th><th>Total</th><th>Estado</th><th></th>
      </tr></thead>
      <tbody id="venc-tbody"><tr><td colspan="10" class="loading">Cargando‚Ä¶</td></tr></tbody>
    </table></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê IMPORTAR EXTRACTO ‚ïê‚ïê‚ïê -->
  <div class="card" style="margin-bottom:14px">
    <div class="card-header">
      <div class="card-title">üè¶ Importar extracto bancario (CSV)</div>
    </div>
    <div class="card-body">
      <div class="info-box" style="margin-bottom:12px">
        üì• Descarga el extracto de tu banco en formato CSV (BBVA: Mis cuentas ‚Üí Exportar / CaixaBank: Movimientos ‚Üí Descargar CSV). 
        El sistema cruzar√° autom√°ticamente los movimientos con tus facturas pendientes por <strong>importe y fecha</strong>.
      </div>
      <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <label class="form-label">Banco / Formato</label>
          <select class="form-input" id="banco-formato" style="margin-bottom:10px">
            <option value="bbva">BBVA</option>
            <option value="caixabank">CaixaBank</option>
            <option value="santander">Santander</option>
            <option value="sabadell">Banco Sabadell</option>
            <option value="generico">Gen√©rico (fecha, concepto, importe)</option>
          </select>
          <label class="form-label">Archivo CSV del extracto</label>
          <input type="file" id="csv-input" accept=".csv,.txt" class="form-input" onchange="procesarCSV()" style="padding:6px">
        </div>
        <div style="flex:2;min-width:280px">
          <div id="csv-preview" style="display:none;background:var(--bg);border-radius:6px;padding:10px;font-size:11px;max-height:120px;overflow-y:auto;font-family:monospace;color:var(--text-soft);border:1px solid var(--border)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê RESULTADOS CONCILIACI√ìN ‚ïê‚ïê‚ïê -->
  <div id="conc-resultados" style="display:none">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üîç Resultado de la conciliaci√≥n <span id="conc-res-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
        <button class="btn btn-primary" onclick="aplicarConciliacion()" id="btn-aplicar-conc" style="display:none">‚úÖ Aplicar pagos detectados</button>
      </div>
      <div class="table-wrap"><table>
        <thead><tr>
          <th></th><th>Fecha banco</th><th>Concepto banco</th><th>Importe banco</th>
          <th>Factura detectada</th><th>Proveedor</th><th>Diferencia</th><th>Confianza</th>
        </tr></thead>
        <tbody id="conc-tbody"></tbody>
      </table></div>
    </div>
  </div>

</div>

<div class="view" id="view-contabilidad">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Cuenta de Resultados</div><span style="font-size:10px;color:var(--text-soft);font-weight:400">Basado en facturas emitidas y recibidas</span></div>
          <div class="card-body" style="padding:0">
            <div class="cuenta-row header"><span>Concepto</span><span>Cta PGC</span><span>Importe ‚Ç¨</span></div>
            <div class="cuenta-row" style="background:var(--blue-light);font-weight:700"><span>INGRESOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Ventas (base imp.) ‚Äî Facturas emitidas</span><span style="color:var(--text-soft)">700</span><span id="cnt-ventas">‚Äî</span></div>
            <div class="cuenta-row"><span>IVA Repercutido</span><span style="color:var(--text-soft)">477</span><span id="cnt-iva-rep">‚Äî</span></div>
            <div class="cuenta-row total"><span>TOTAL INGRESOS c/IVA</span><span></span><span id="cnt-ing-tot">‚Äî</span></div>
            <div class="cuenta-row" style="background:var(--red-soft);font-weight:700;margin-top:4px"><span>GASTOS</span><span></span><span></span></div>
            <div class="cuenta-row"><span>Compras (base imp.) ‚Äî Facturas recibidas</span><span style="color:var(--text-soft)">600</span><span id="cnt-compras">‚Äî</span></div>
            <div class="cuenta-row"><span>IVA Soportado compras</span><span style="color:var(--text-soft)">472</span><span id="cnt-iva-comp">‚Äî</span></div>
            <div class="cuenta-row total"><span>TOTAL GASTOS c/IVA</span><span></span><span id="cnt-gastos-tot">‚Äî</span></div>
            <div class="cuenta-row result" id="cnt-result-row"><span>RESULTADO NETO (base imp.)</span><span></span><span id="cnt-result">‚Äî</span></div>
            <div class="cuenta-row"><span>Margen neto %</span><span></span><span id="cnt-margen">‚Äî</span></div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-header"><div class="card-title">üßæ Liquidaci√≥n IVA Trimestral</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row"><span>IVA Repercutido (facturas venta)</span><span id="iva-rep">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>IVA Soportado (facturas compra)</span><span id="iva-comp">‚Äî</span><span></span></div>
              <div class="cuenta-row result" id="iva-result-row"><span>IVA NETO A INGRESAR</span><span id="iva-neto">‚Äî</span><span></span></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">‚öñÔ∏è Balance Simplificado</div></div>
            <div class="card-body" style="padding:0">
              <div class="cuenta-row header"><span>ACTIVO</span><span>‚Ç¨</span><span></span></div>
              <div class="cuenta-row"><span>Clientes (pendiente cobro)</span><span id="bal-cli">‚Äî</span><span></span></div>
              <div class="cuenta-row header" style="margin-top:4px"><span>PASIVO</span><span>‚Ç¨</span><span></span></div>
              <div class="cuenta-row"><span>IVA a liquidar (Hacienda)</span><span id="bal-iva">‚Äî</span><span></span></div>
              <div class="cuenta-row"><span>Pendiente proveedores (fact. compra)</span><span id="bal-prov">‚Äî</span><span></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RR.HH. ¬∑ N√ìMINAS ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-rrhh">
      <!-- KPIs -->
      <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
        <div class="kpi blue"><div class="kpi-label">üë§ Trabajadores</div><div class="kpi-value" id="rrhh-kpi-total">‚Äî</div><div class="kpi-sub">En plantilla</div></div>
        <div class="kpi red"><div class="kpi-label">üí∂ Coste n√≥minas/mes</div><div class="kpi-value" id="rrhh-kpi-coste">‚Äî</div><div class="kpi-sub">Bruto + SS empresa</div></div>
        <div class="kpi amber"><div class="kpi-label">üèõ SS empresa/mes</div><div class="kpi-value" id="rrhh-kpi-ss">‚Äî</div><div class="kpi-sub">~30% s/bruto</div></div>
        <div class="kpi green"><div class="kpi-label">üìÖ Coste anual total</div><div class="kpi-value" id="rrhh-kpi-anual">‚Äî</div><div class="kpi-sub">12 pagas</div></div>
      </div>

      <div class="search-bar">
        <button class="btn btn-primary" onclick="abrirModalTrabajador()">Ôºã Nuevo trabajador</button>
        <div class="search-wrap" style="flex:1;max-width:300px"><span class="search-icon">üîç</span>
          <input class="form-input" id="search-rrhh" placeholder="Buscar trabajador‚Ä¶" oninput="filtrarRRHH()">
        </div>
      </div>

      <!-- Tabla trabajadores -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üë§ Plantilla y n√≥minas <span id="rrhh-count" style="font-size:11px;font-weight:400;color:var(--text-soft);margin-left:6px"></span></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Trabajador</th><th>DNI/NIE</th><th>Categor√≠a</th><th>Fecha alta</th>
              <th>Salario bruto/mes</th><th>IRPF %</th><th>SS trabajador</th><th>Neto/mes</th>
              <th>SS empresa (~30%)</th><th>Coste total empresa</th><th>Estado</th><th></th>
            </tr></thead>
            <tbody id="rrhh-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Resumen mensual -->
      <div class="card" style="margin-top:14px">
        <div class="card-header"><div class="card-title">üìä Resumen coste mensual empresa</div></div>
        <div class="card-body" style="padding:0">
          <div class="cuenta-row header"><span>Concepto</span><span>Importe ‚Ç¨</span><span></span></div>
          <div class="cuenta-row"><span>Suma salarios brutos</span><span id="rrhh-sum-bruto">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span>Suma IRPF retenido (trabajadores)</span><span id="rrhh-sum-irpf">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span>Suma SS trabajadores</span><span id="rrhh-sum-ss-trab">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span>Suma neto pagado a trabajadores</span><span id="rrhh-sum-neto">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span>Seguridad Social empresa (~30%)</span><span id="rrhh-sum-ss-emp">‚Äî</span><span></span></div>
          <div class="cuenta-row total"><span>COSTE N√ìMINAS / MES</span><span id="rrhh-sum-total">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span style="color:var(--text-soft)">+ Pagas extras anuales (total)</span><span id="rrhh-sum-pagas">‚Äî</span><span></span></div>
          <div class="cuenta-row"><span style="color:var(--text-soft)">+ Compensaciones / Bonus anuales</span><span id="rrhh-sum-bonus">‚Äî</span><span></span></div>
          <div class="cuenta-row result"><span>COSTE TOTAL EMPRESA / A√ëO</span><span id="rrhh-sum-anual">‚Äî</span><span></span></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONFIGURACI√ìN ‚ïê‚ïê‚ïê -->
    <div class="view" id="view-configuracion">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="card">
          <div class="card-header"><div class="card-title">üè¢ Datos de la empresa</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">üíæ Guardar</button></div>
          <div class="card-body">
            <div class="form-grid">
              <div class="form-group fg-full"><label class="form-label">Raz√≥n Social</label><input class="form-input" id="cfg-razon" placeholder="PAU INTERIORISMO S.L."></div>
              <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="cfg-cif"></div>
              <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="cfg-tel"></div>
              <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="cfg-email" type="email"></div>
              <div class="form-group"><label class="form-label">Web</label><input class="form-input" id="cfg-web"></div>
              <div class="form-group fg-full"><label class="form-label">Direcci√≥n</label><input class="form-input" id="cfg-dir"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üìä Par√°metros CI+GG+BI</div><button class="btn btn-ghost btn-sm" onclick="saveConfig()">üíæ Guardar</button></div>
          <div class="card-body">
            <div class="info-box">Estos porcentajes se aplican autom√°ticamente en el presupuesto cuando activas CI+GG+BI en cada l√≠nea.</div>
            <div class="form-grid">
              <div class="form-group"><label class="form-label">CI - Costes Indirectos %</label><input class="form-input" id="cfg-ci" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">GG - Gastos Generales %</label><input class="form-input" id="cfg-gg" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">BI - Beneficio Industrial %</label><input class="form-input" id="cfg-bi" type="number" step="0.1"></div>
              <div class="form-group"><label class="form-label">TOTAL CI+GG+BI %</label><input class="form-input calc" id="cfg-total-ci" readonly></div>
              <div class="form-group"><label class="form-label">Coste hora defecto (‚Ç¨)</label><input class="form-input" id="cfg-hora" type="number" step="0.5"></div>
            </div>
          </div>
        </div>
      </div>
        <!-- D√çAS DE PAGO -->
        <div class="card" style="margin-top:14px">
          <div class="card-header">
            <div class="card-title">üìÖ D√≠as de pago</div>
            <button class="btn btn-ghost btn-sm" onclick="saveDiasPago()">üíæ Guardar</button>
          </div>
          <div class="card-body">
            <div class="info-box">Estos son los d√≠as del mes en que se realizan los pagos. Se usan para calcular autom√°ticamente el vencimiento en facturas de compra con giro.</div>
            <div class="form-grid" style="margin-bottom:12px">
              <div class="form-group">
                <label class="form-label">D√≠a de pago 1</label>
                <input class="form-input" id="cfg-dia1" type="number" min="1" max="31" value="5" placeholder="5">
              </div>
              <div class="form-group">
                <label class="form-label">D√≠a de pago 2</label>
                <input class="form-input" id="cfg-dia2" type="number" min="1" max="31" value="20" placeholder="20">
              </div>
            </div>
            <div style="background:var(--bg);border-radius:6px;padding:10px;font-size:12px;color:var(--text-soft)">
              <strong style="color:var(--navy)">¬øC√≥mo funciona?</strong><br>
              Al seleccionar <em>Giro 30/60/90/120 d√≠as</em> en una factura, el sistema calcula la fecha de vencimiento 
              sumando los d√≠as al plazo y ajustando al siguiente d√≠a de pago configurado (d√≠a 5 o 20).<br><br>
              <strong>Ejemplo:</strong> Factura con fecha 10/03 + Giro 30 d√≠as = vencimiento 09/04 ‚Üí ajusta al <strong>20/04</strong>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="card-header">
            <div class="card-title">üßæ Pie de factura</div>
            <button class="btn btn-ghost btn-sm" onclick="savePieFactura()">üíæ Guardar</button>
          </div>
          <div class="card-body">
            <div class="info-box">Este texto aparecer√° autom√°ticamente en el pie de todas las facturas de venta. Ind√≠calo una vez y se aplicar√° siempre.</div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">N√∫mero de cuenta (IBAN)</label>
                <input class="form-input" id="cfg-iban" placeholder="ES00 0000 0000 0000 0000 0000">
              </div>
              <div class="form-group">
                <label class="form-label">Banco / Entidad</label>
                <input class="form-input" id="cfg-banco" placeholder="Ej: CaixaBank, Sabadell‚Ä¶">
              </div>
              <div class="form-group fg-full">
                <label class="form-label">Condiciones de pago</label>
                <input class="form-input" id="cfg-condiciones-pago" placeholder="Ej: Pago a 30 d√≠as desde la fecha de factura mediante transferencia bancaria">
              </div>
              <div class="form-group fg-full">
                <label class="form-label">Texto legal / Nota adicional</label>
                <textarea class="form-input" id="cfg-nota-legal" rows="3" placeholder="Ej: En caso de impago se aplicar√°n los intereses de demora previstos en la Ley 3/2004. Los datos del presente documento son confidenciales‚Ä¶"></textarea>
              </div>
              <div class="form-group fg-full">
                <label class="form-label">Texto libre adicional</label>
                <textarea class="form-input" id="cfg-pie-extra" rows="2" placeholder="Cualquier otro texto que quieras incluir en el pie de factura‚Ä¶"></textarea>
              </div>
            </div>
            <!-- Preview -->
            <div style="margin-top:12px;border:1px solid var(--border);border-radius:6px;padding:12px;background:var(--bg)">
              <div style="font-size:10px;font-weight:700;color:var(--text-soft);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em">Vista previa del pie</div>
              <div id="cfg-pie-preview" style="font-size:11px;color:var(--navy)">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="card-header"><div class="card-title">üìÅ Categor√≠as de partidas</div></div>
          <div class="card-body">
            <div class="info-box">Define si cada categor√≠a aplica CI+GG+BI por defecto al a√±adirla al presupuesto.</div>
            <table style="width:100%;font-size:12px;border-collapse:collapse">
              <thead><tr><th style="padding:8px;background:var(--navy);color:white;text-align:left">Categor√≠a</th><th style="padding:8px;background:var(--navy);color:white;text-align:center">Aplica CI+GG+BI</th></tr></thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Materiales</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Mano de Obra</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Maquinaria</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Subcontrata</td><td style="padding:8px;text-align:center"><span class="badge b-red">No</span></td></tr>
                <tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">Transporte</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
                <tr><td style="padding:8px">Varios</td><td style="padding:8px;text-align:center"><span class="badge b-green">S√≠</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- CLIENTE -->
<div class="overlay" id="m-cliente"><div class="modal">
  <div class="modal-head"><div class="modal-title">ü§ù <span id="m-cliente-title">Nuevo cliente</span></div><button class="modal-close" onclick="closeModal('m-cliente')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="c-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="c-nombre"></div>
      <div class="form-group"><label class="form-label">CIF/NIF</label><input class="form-input" id="c-cif"></div>
      <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="c-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="c-email" type="email"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="c-tipo"><option>Particular</option><option>Empresa</option><option>Promotora</option><option>Administraci√≥n</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="c-pago"><option>Transferencia</option><option>Efectivo</option><option>Domiciliaci√≥n</option><option>Confirming</option><option>Pagar√©</option><option>Giro 30 d√≠as</option><option>Giro 60 d√≠as</option><option>Giro 90 d√≠as</option><option>Giro 120 d√≠as</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Direcci√≥n</label><input class="form-input" id="c-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="c-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-cliente')">Cancelar</button><button class="btn btn-primary" onclick="saveCliente()">üíæ Guardar</button></div>
</div></div>

<!-- PROYECTO -->
<div class="overlay" id="m-proyecto"><div class="modal">
  <div class="modal-head"><div class="modal-title">üìÅ <span id="m-proyecto-title">Nuevo proyecto</span></div><button class="modal-close" onclick="closeModal('m-proyecto')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="p-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Cliente</label><select class="form-input" id="p-cliente"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Nombre del proyecto *</label><input class="form-input" id="p-nombre"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="p-tipo"><option>Obra nueva</option><option>Rehabilitaci√≥n integral</option><option>Reforma parcial</option><option>Cocina</option><option>Ba√±o</option><option>Interiorismo</option><option>Mobiliario</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="p-estado"><option>Nuevo lead</option><option>Presupuesto enviado</option><option>Aprobado</option><option>En ejecuci√≥n</option><option>Finalizado</option><option>Facturado</option><option>Cobrado</option><option>Cancelado</option></select></div>
      <div class="form-group"><label class="form-label">Responsable</label><select class="form-input" id="p-resp"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Fecha inicio</label><input class="form-input" id="p-fecha" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">Direcci√≥n de obra</label><input class="form-input" id="p-dir"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="p-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proyecto')">Cancelar</button><button class="btn btn-primary" onclick="saveProyecto()">üíæ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO LINEA -->
<div class="overlay" id="m-pres-linea"><div class="modal" style="width:600px">
  <div class="modal-head"><div class="modal-title">üí∞ <span id="m-pres-title">Nueva l√≠nea</span></div><button class="modal-close" onclick="closeModal('m-pres-linea')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="pl-id">
    <div class="form-group" style="margin-bottom:10px"><label class="form-label">üîç Buscar en CYPE 2026</label>
      <input class="form-input" id="pl-cype-search" placeholder="Escribe para buscar partida CYPE‚Ä¶" oninput="searchCypeLinea()">
      <div id="pl-cype-results" style="max-height:140px;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;display:none;background:white;position:relative;z-index:10"></div>
    </div>
    <div class="form-group" style="margin-bottom:12px"><label class="form-label">üìã O seleccionar del tarifario propio</label>
      <select class="form-input" id="pl-tarif-sel" onchange="loadTarifLinea()"><option value="">‚Äî Seleccionar del tarifario ‚Äî</option></select>
    </div>
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n *</label><input class="form-input" id="pl-desc"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="pl-ud"><option>m¬≤</option><option>m¬≥</option><option>ml</option><option>Ud</option><option>kg</option><option>h</option><option>PA</option><option>m</option></select></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="pl-cant" type="number" step="0.01" value="1" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Base (coste)</label><input class="form-input" id="pl-precio" type="number" step="0.01" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="pl-margen" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">CI+GG+BI %</label><input class="form-input" id="pl-ci" type="number" step="0.1" value="0" oninput="calcLineaPres()"></div>
      <div class="form-group"><label class="form-label">Precio Venta</label><input class="form-input calc" id="pl-pventa" readonly></div>
      <div class="form-group"><label class="form-label">Subtotal</label><input class="form-input calc" id="pl-subtotal" readonly></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="pl-iva"><option>10%</option><option>21%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Cap√≠tulo / Partida</label><input class="form-input" id="pl-partida"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-linea')">Cancelar</button><button class="btn btn-primary" onclick="saveLineaPresupuesto()">üíæ Guardar</button></div>
</div></div>

<!-- PRESUPUESTO CAP√çTULO -->
<div class="overlay" id="m-pres-cap"><div class="modal" style="width:400px">
  <div class="modal-head"><div class="modal-title">üìÇ Nuevo cap√≠tulo</div><button class="modal-close" onclick="closeModal('m-pres-cap')">√ó</button></div>
  <div class="modal-body"><div class="form-group"><label class="form-label">Nombre del cap√≠tulo</label><input class="form-input" id="cap-nombre" placeholder="01. Demoliciones y trabajos previos"></div></div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pres-cap')">Cancelar</button><button class="btn btn-primary" onclick="saveCapitulo()">üíæ Guardar</button></div>
</div></div>

<!-- COMPARATIVA OFERTAS -->
<div class="overlay" id="m-comparativa"><div class="modal" style="width:780px;max-width:96vw">
  <div class="modal-head"><div class="modal-title">‚öñÔ∏è Nueva comparativa de ofertas</div><button class="modal-close" onclick="closeModal('m-comparativa')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="cmp-id">
    <!-- Cabecera: proyecto + trabajo + modo de c√°lculo -->
    <div class="form-grid" style="margin-bottom:10px">
      <div class="form-group"><label class="form-label">Cliente</label>
        <select class="form-input" id="cmp-cliente" onchange="cascadaClienteModalCmp()"><option value="">Seleccionar‚Ä¶</option></select>
      </div>
      <div class="form-group"><label class="form-label">Proyecto *</label>
        <select class="form-input" id="cmp-proyecto"><option value="">Seleccionar‚Ä¶</option></select>
      </div>
      <div class="form-group fg-full"><label class="form-label">Trabajo / Material *</label>
        <input class="form-input" id="cmp-trabajo" placeholder="Ej: Instalaci√≥n fontaner√≠a cocina">
      </div>
    </div>
    <!-- Modo de c√°lculo -->
    <div style="display:flex;gap:8px;margin-bottom:14px;background:var(--bg);border-radius:6px;padding:8px 10px;align-items:center">
      <span style="font-size:12px;font-weight:600;color:var(--text-soft);margin-right:4px">Modo:</span>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px">
        <input type="radio" name="cmp-modo" value="pvp" checked onchange="cambiarModoComparativa()"> 
        <span>üìâ PVP cat√°logo ‚àí descuento</span>
      </label>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;margin-left:12px">
        <input type="radio" name="cmp-modo" value="coste" onchange="cambiarModoComparativa()"> 
        <span>üìà Precio coste + margen</span>
      </label>
    </div>
    <!-- Las 3 ofertas -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px" id="cmp-ofertas-grid">
      <div id="cmp-col-1" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 1</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o1-prov"><option value="">Seleccionar‚Ä¶</option></select>
        </div>
        <div id="o1-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP cat√°logo ‚Ç¨</label>
            <input class="form-input" id="o1-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(1)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o1-dto" type="number" value="0" step="0.1" oninput="calcOferta(1)">
          </div>
        </div>
        <div id="o1-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste ‚Ç¨</label>
            <input class="form-input" id="o1-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(1)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o1-mk" type="number" value="0" step="0.1" oninput="calcOferta(1)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o1-res-coste">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o1-res-venta">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen ‚Ç¨</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o1-res-margen">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o1-res-pct">‚Äî</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o1-notas" placeholder="Plazo, condiciones‚Ä¶">
        </div>
      </div>
      <div id="cmp-col-2" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 2</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o2-prov"><option value="">Seleccionar‚Ä¶</option></select>
        </div>
        <div id="o2-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP cat√°logo ‚Ç¨</label>
            <input class="form-input" id="o2-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(2)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o2-dto" type="number" value="0" step="0.1" oninput="calcOferta(2)">
          </div>
        </div>
        <div id="o2-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste ‚Ç¨</label>
            <input class="form-input" id="o2-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(2)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o2-mk" type="number" value="0" step="0.1" oninput="calcOferta(2)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o2-res-coste">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o2-res-venta">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen ‚Ç¨</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o2-res-margen">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o2-res-pct">‚Äî</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o2-notas" placeholder="Plazo, condiciones‚Ä¶">
        </div>
      </div>
      <div id="cmp-col-3" style="border:1px solid var(--border);border-radius:6px;padding:10px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-soft);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)">OFERTA 3</div>
        <div class="form-group" style="margin-bottom:6px"><label class="form-label">Proveedor</label>
          <select class="form-input" id="o3-prov"><option value="">Seleccionar‚Ä¶</option></select>
        </div>
        <div id="o3-modo-pvp">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">PVP cat√°logo ‚Ç¨</label>
            <input class="form-input" id="o3-pvp" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(3)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Descuento %</label>
            <input class="form-input" id="o3-dto" type="number" value="0" step="0.1" oninput="calcOferta(3)">
          </div>
        </div>
        <div id="o3-modo-coste" style="display:none">
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Precio coste ‚Ç¨</label>
            <input class="form-input" id="o3-costebase" type="number" step="0.01" placeholder="0.00" oninput="calcOferta(3)">
          </div>
          <div class="form-group" style="margin-bottom:6px"><label class="form-label">Margen venta %</label>
            <input class="form-input" id="o3-mk" type="number" value="0" step="0.1" oninput="calcOferta(3)">
          </div>
        </div>
        <div style="background:var(--bg);border-radius:4px;padding:8px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio coste</span>
            <span style="font-size:12px;font-weight:700" id="o3-res-coste">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-size:11px;color:var(--text-soft)">Precio venta</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)" id="o3-res-venta">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-size:11px;color:var(--text-soft)">Margen ‚Ç¨</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o3-res-margen">‚Äî</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:2px">
            <span style="font-size:11px;color:var(--text-soft)">Margen %</span>
            <span style="font-size:12px;font-weight:700;color:var(--green)" id="o3-res-pct">‚Äî</span>
          </div>
        </div>
        <div class="form-group" style="margin-top:6px"><label class="form-label">Notas</label>
          <input class="form-input" id="o3-notas" placeholder="Plazo, condiciones‚Ä¶">
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:12px;padding-top:10px;border-top:1px solid var(--border);flex-wrap:wrap">
      <label class="form-label" style="margin:0;white-space:nowrap">Oferta elegida:</label>
      <select class="form-input" id="cmp-elegida" style="width:160px">
        <option value="1">Oferta 1</option><option value="2">Oferta 2</option><option value="3">Oferta 3</option>
      </select>
      <span id="cmp-ganadora-info" style="font-size:12px;flex:1"></span>
    </div>
    <!-- Resumen comparativo -->
    <div id="cmp-resumen" style="display:none;margin-top:8px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
      <div style="background:#e8f5ee;border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">üí∞ Menor coste</div>
        <div id="cmp-res-precio" style="font-weight:700;color:var(--green)">‚Äî</div>
      </div>
      <div style="background:#fff5e6;border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">üìà Mayor margen</div>
        <div id="cmp-res-margen" style="font-weight:700;color:var(--copper)">‚Äî</div>
      </div>
      <div style="background:var(--bg);border-radius:6px;padding:8px 12px;font-size:11px">
        <div style="color:var(--text-soft);margin-bottom:2px">üìä Diferencia max-min</div>
        <div id="cmp-res-diff" style="font-weight:700;color:var(--navy)">‚Äî</div>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-comparativa')">Cancelar</button><button class="btn btn-primary" onclick="saveComparativa()">üíæ Guardar</button></div>
</div></div>

<!-- TARIFARIO -->
<div class="overlay" id="m-tarifario"><div class="modal">
  <div class="modal-head"><div class="modal-title">üìã <span id="m-tarif-title">Nuevo art√≠culo</span></div><button class="modal-close" onclick="closeModal('m-tarifario')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="t-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">C√≥digo *</label><input class="form-input" id="t-codigo"></div>
      <div class="form-group"><label class="form-label">Unidad</label><select class="form-input" id="t-unidad"><option>Ud</option><option>m¬≤</option><option>m¬≥</option><option>ml</option><option>kg</option><option>h</option><option>PA</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n *</label><input class="form-input" id="t-desc"></div>
      <div class="form-group"><label class="form-label">Precio coste (s/IVA)</label><input class="form-input" id="t-coste" type="number" step="0.01" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Margen %</label><input class="form-input" id="t-margen" type="number" step="0.1" value="30" oninput="calcPrecioVenta()"></div>
      <div class="form-group"><label class="form-label">Precio venta</label><input class="form-input calc" id="t-pventa" readonly></div>
      <div class="form-group"><label class="form-label">Categor√≠a</label><select class="form-input" id="t-cat" onchange="actualizarFamiliasModal()"><option>Mobiliario</option><option>Sofas y tapizados</option><option>Dormitorios</option><option>Colchones</option><option>Cocina</option><option>Banos</option><option>Sanitarios</option><option>Griferias</option><option>Pavimentos</option><option>Revestimientos</option><option>Carpinteria</option><option>Puertas y ventanas</option><option>Iluminacion</option><option>Climatizacion</option><option>Calefaccion</option><option>Instalaciones</option><option>Electricidad</option><option>Fontaneria</option><option>Pintura</option><option>Varios</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Familia / Subfamilia</label>
        <div style="display:flex;gap:6px">
          <select class="form-input" id="t-familia-sel" onchange="selFamiliaModal()" style="flex:1"><option value="">‚Äî Nueva familia ‚Äî</option></select>
          <input class="form-input" id="t-familia" placeholder="Ej: Rejillas lineales" style="flex:1.5">
        </div>
        <div style="font-size:10px;color:var(--text-soft);margin-top:3px">Elige una existente o escribe una nueva</div>
      </div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="t-marca"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="t-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-tarifario')">Cancelar</button><button class="btn btn-primary" onclick="saveTarifario()">üíæ Guardar</button></div>
</div></div>

<!-- INTERIORISMO -->
<div class="overlay" id="m-interiorismo"><div class="modal">
  <div class="modal-head"><div class="modal-title">üõã A√±adir art√≠culo</div><button class="modal-close" onclick="closeModal('m-interiorismo')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="i-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Proyecto *</label><select class="form-input" id="i-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Estancia</label><select class="form-input" id="i-estancia"><option>Sal√≥n</option><option>Cocina</option><option>Dormitorio</option><option>Ba√±o</option><option>Terraza</option><option>Despacho</option><option>Comedor</option><option>Pasillo</option><option>Entrada</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Ref. Tarifario</label><select class="form-input" id="i-ref" onchange="loadTarifarioItem()"><option value="">‚Äî descripci√≥n libre ‚Äî</option></select></div>
      <div class="form-group"><label class="form-label">Descripci√≥n</label><input class="form-input" id="i-desc"></div>
      <div class="form-group"><label class="form-label">Marca</label><input class="form-input" id="i-marca"></div>
      <div class="form-group"><label class="form-label">Acabado</label><input class="form-input" id="i-acabado"></div>
      <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="i-cant" type="number" value="1" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP unitario</label><input class="form-input" id="i-pvp" type="number" step="0.01" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">Dto. cliente %</label><input class="form-input" id="i-dto" type="number" value="0" oninput="calcIntPvp()"></div>
      <div class="form-group"><label class="form-label">PVP Neto</label><input class="form-input calc" id="i-neto" readonly></div>
      <div class="form-group"><label class="form-label">Coste neto</label><input class="form-input" id="i-coste" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="i-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group"><label class="form-label">Estado propuesta</label><select class="form-input" id="i-eprop"><option>Borrador</option><option>Enviada</option><option>Aprobada</option><option>Rechazada</option><option>En pedido</option><option>Entregada</option></select></div>
      <div class="form-group"><label class="form-label">Estado pedido</label><select class="form-input" id="i-eped"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En tr√°nsito</option><option>Recibido</option><option>Pagado</option></select></div>
      <div class="form-group"><label class="form-label">Fecha entrega</label><input class="form-input" id="i-fentrega" type="date"></div>
      <div class="form-group"><label class="form-label">Notas</label><input class="form-input" id="i-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-interiorismo')">Cancelar</button><button class="btn btn-copper" onclick="saveInteriorismo()">üíæ Guardar</button></div>
</div></div>

<!-- COMPRA -->
<div class="overlay" id="m-compra"><div class="modal">
  <div class="modal-head"><div class="modal-title">üõí Nueva compra</div><button class="modal-close" onclick="closeModal('m-compra')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="co-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="co-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="co-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Proveedor</label><select class="form-input" id="co-prov"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="co-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Concepto</label><input class="form-input" id="co-concepto"></div>
      <div class="form-group"><label class="form-label">Base imponible ‚Ç¨</label><input class="form-input" id="co-base" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="co-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="co-vto" type="date"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><input class="form-input" id="co-notas"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-compra')">Cancelar</button><button class="btn btn-primary" onclick="saveCompra()">üíæ Guardar</button></div>
</div></div>

<!-- SUBCONTRATA -->
<div class="overlay" id="m-subcontrata"><div class="modal">
  <div class="modal-head"><div class="modal-title">üë∑ Nueva subcontrata</div><button class="modal-close" onclick="closeModal('m-subcontrata')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="sc-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="sc-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="sc-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Subcontratista</label><select class="form-input" id="sc-prov"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">IVA</label><select class="form-input" id="sc-iva"><option>21%</option><option>10%</option><option>4%</option><option>Exento</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Trabajo</label><input class="form-input" id="sc-trabajo"></div>
      <div class="form-group"><label class="form-label">Importe base ‚Ç¨</label><input class="form-input" id="sc-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado pago</label><select class="form-input" id="sc-estado"><option>Pendiente</option><option>Pagado</option><option>Parcial</option><option>Vencido</option></select></div>
      <div class="form-group"><label class="form-label">Fecha vencimiento</label><input class="form-input" id="sc-vto" type="date"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-subcontrata')">Cancelar</button><button class="btn btn-primary" onclick="saveSubcontrata()">üíæ Guardar</button></div>
</div></div>

<!-- HORA -->
<div class="overlay" id="m-hora"><div class="modal" style="width:420px">
  <div class="modal-head"><div class="modal-title">‚è± Registrar horas</div><button class="modal-close" onclick="closeModal('m-hora')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="h-id">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="h-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="h-proyecto"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Trabajador</label><select class="form-input" id="h-trab"><option value="">Seleccionar‚Ä¶</option></select></div>
      <div class="form-group"><label class="form-label">Horas</label><input class="form-input" id="h-horas" type="number" step="0.5" placeholder="8"></div>
      <div class="form-group"><label class="form-label">‚Ç¨/hora</label><input class="form-input" id="h-coste" type="number" value="18"></div>
      <div class="form-group fg-full"><label class="form-label">Descripci√≥n</label><input class="form-input" id="h-desc"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-hora')">Cancelar</button><button class="btn btn-primary" onclick="saveHora()">üíæ Guardar</button></div>
</div></div>

<!-- PEDIDO -->
<div class="overlay" id="m-pedido"><div class="modal" style="width:580px">
  <div class="modal-head"><div class="modal-title">üì¶ Nuevo pedido</div><button class="modal-close" onclick="closeModal('m-pedido')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="ped-id">
    <input type="hidden" id="ped-cliente-id">
    <input type="hidden" id="ped-cliente-val">
    <input type="hidden" id="ped-proyecto-id">
    <input type="hidden" id="ped-proyecto-val">

    <!-- Info cliente/proyecto pre-cargada (solo lectura) -->
    <div style="background:var(--blue-light);border-radius:6px;padding:10px 12px;margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--navy);text-transform:uppercase;margin-bottom:2px">Cliente</div>
        <div id="ped-modal-cli-info" style="font-size:12px;font-weight:600;color:var(--text)">‚Äî Sin cliente seleccionado</div>
      </div>
      <div>
        <div style="font-size:10px;font-weight:700;color:var(--navy);text-transform:uppercase;margin-bottom:2px">Proyecto</div>
        <div id="ped-modal-proy-info" style="font-size:12px;font-weight:600;color:var(--text)">‚Äî Sin proyecto</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--text-soft);margin-bottom:10px">Para cambiar cliente/proyecto, cierra y usa los filtros de la p√°gina superior izquierda.</div>

    <div class="form-grid">
      <div class="form-group"><label class="form-label">N¬∫ Pedido</label><input class="form-input" id="ped-num" placeholder="PED-001"></div>
      <div class="form-group"><label class="form-label">Fecha</label><input class="form-input" id="ped-fecha" type="date"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="ped-tipo"><option>Material</option><option>Mobiliario</option><option>Subcontrata</option><option>Herramienta</option><option>Otros</option></select></div>

      <!-- Proveedor buscable -->
      <div class="form-group">
        <label class="form-label">üè≠ Proveedor <span style="color:var(--text-soft);font-weight:400">(escribe para filtrar)</span></label>
        <div style="position:relative">
          <input class="form-input" id="ped-prov-search" placeholder="Buscar proveedor‚Ä¶" autocomplete="off"
            oninput="filtrarSearchSelect('ped-prov-search','ped-prov-dd','ped-prov-id','ped-prov-val',ProvC,'nombre','id')"
            onfocus="abrirSearchDd('ped-prov-dd')" onblur="setTimeout(()=>cerrarSearchDd('ped-prov-dd'),200)">
          <input type="hidden" id="ped-prov-id">
          <input type="hidden" id="ped-prov-val">
          <div id="ped-prov-dd" class="search-dd" style="display:none"></div>
        </div>
      </div>

      <div class="form-group fg-full"><label class="form-label">Referencia / Descripci√≥n</label><input class="form-input" id="ped-ref" placeholder="Ej: Azulejo ba√±o modelo X, Mueble cocina ref.123..."></div>
      <div class="form-group"><label class="form-label">Importe ‚Ç¨</label><input class="form-input" id="ped-importe" type="number" step="0.01"></div>
      <div class="form-group"><label class="form-label">Estado</label><select class="form-input" id="ped-estado"><option>Pendiente</option><option>Solicitado</option><option>Confirmado</option><option>En tr√°nsito</option><option>Recibido</option><option>Pagado</option><option>Cancelado</option></select></div>
      <div class="form-group fg-full"><label class="form-label">Observaciones</label><input class="form-input" id="ped-obs"></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-pedido')">Cancelar</button><button class="btn btn-primary" onclick="savePedido()">üíæ Guardar</button></div>
</div></div>

<!-- PROVEEDOR -->
<div class="overlay" id="m-proveedor"><div class="modal">
  <div class="modal-head"><div class="modal-title">üè≠ Nuevo proveedor</div><button class="modal-close" onclick="closeModal('m-proveedor')">√ó</button></div>
  <div class="modal-body"><input type="hidden" id="pv-id">
    <div class="form-grid">
      <div class="form-group fg-full"><label class="form-label">Nombre *</label><input class="form-input" id="pv-nombre"></div>
      <div class="form-group"><label class="form-label">CIF</label><input class="form-input" id="pv-cif"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="pv-tipo"><option>Proveedor</option><option>Subcontrata</option><option>Alquiler</option><option>Servicio</option><option>Transporte</option><option>Otros</option></select></div>
      <div class="form-group"><label class="form-label">Tel√©fono</label><input class="form-input" id="pv-tel"></div>
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="pv-email" type="email"></div>
      <div class="form-group"><label class="form-label">Especialidad</label><input class="form-input" id="pv-esp"></div>
      <div class="form-group"><label class="form-label">Forma de pago</label><select class="form-input" id="pv-pago"><option>Transferencia</option><option>Efectivo</option><option>Domiciliaci√≥n</option><option>Confirming</option><option>Pagar√©</option><option>Giro 30 d√≠as</option><option>Giro 60 d√≠as</option><option>Giro 90 d√≠as</option><option>Giro 120 d√≠as</option></select></div>
      <div class="form-group"><label class="form-label">IBAN</label><input class="form-input" id="pv-iban"></div>
      <div class="form-group fg-full"><label class="form-label">Notas</label><textarea class="form-input" id="pv-notas" rows="2"></textarea></div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn btn-ghost" onclick="closeModal('m-proveedor')">Cancelar</button><button class="btn btn-primary" onclick="saveProveedor()">üíæ Guardar</button></div>
</div></div>

<!-- FACTURA -->
<div class="overlay" id="m-factura"><div class="modal" style="width:720px;max-width:97vw">
  <div class="modal-head">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="modal-title" id="f-modal-title">üßæ Nueva factura</div>
      <span id="f-tipo-badge" style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:10px;background:#e8f5ee;color:var(--green)">üì§ VENTA</span>
    </div>
    <button class="modal-close" onclick="closeModal('m-factura')">√ó</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="f-id">
    <input type="hidden" id="f-tipo" value="Venta">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">N¬∫ Factura *</label><input class="form-input" id="f-num" placeholder="FAC-2026-001"></div>
      <div class="form-group"><label class="form-label">Fecha emisi√≥n</label><input class="form-input" id="f-fecha" type="date"></div>
      <!-- Venta ‚Üí Cliente | Compra ‚Üí Proveedor -->
      <div class="form-group" id="f-grp-cliente"><label class="form-label">Cliente</label>
        <select class="form-input" id="f-cliente" onchange="cascadaClienteFactura()"><option value="">Seleccionar‚Ä¶</option></select>
      </div>
      <div class="form-group" id="f-grp-proveedor" style="display:none"><label class="form-label">Proveedor</label>
        <select class="form-input" id="f-proveedor"><option value="">Seleccionar‚Ä¶</option></select>
      </div>
      <div class="form-group" id="f-grp-proyecto">
        <label class="form-label">Proyecto <span style="font-size:10px;color:var(--text-soft);font-weight:400">(opcional)</span></label>
        <select class="form-input" id="f-proyecto" onchange="onFacProyectoChange()"><option value="">‚Äî Sin proyecto ‚Äî</option></select>
      </div>
      <!-- Importar desde presupuesto (solo ventas) -->
      <div class="form-group" id="f-grp-importar-pres">
        <label class="form-label">üìã Importar desde presupuesto <span style="font-size:10px;color:var(--text-soft);font-weight:400">(opcional)</span></label>
        <div style="display:flex;gap:6px">
          <select class="form-input" id="f-pres-sel" style="flex:1"><option value="">‚Äî Seleccionar presupuesto ‚Äî</option></select>
          <button type="button" class="btn btn-ghost btn-sm" onclick="importarLineasPresupuesto()" style="white-space:nowrap">üì• Importar</button>
        </div>
      </div>
    </div>

    <!-- L√çNEAS DE FACTURA (solo ventas) -->
    <div id="f-grp-lineas">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 6px">
        <div style="font-size:12px;font-weight:700;color:var(--navy)">üìù L√≠neas de factura</div>
        <button type="button" class="btn btn-ghost btn-sm" onclick="addFacLinea()">Ôºã A√±adir l√≠nea</button>
      </div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden">
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="background:var(--navy);color:white">
              <th style="padding:6px 8px;text-align:left;width:40%">Descripci√≥n</th>
              <th style="padding:6px 8px;text-align:center;width:60px">Ud.</th>
              <th style="padding:6px 8px;text-align:right;width:70px">Cant.</th>
              <th style="padding:6px 8px;text-align:right;width:90px">P.Unit. ‚Ç¨</th>
              <th style="padding:6px 8px;text-align:center;width:70px">IVA</th>
              <th style="padding:6px 8px;text-align:right;width:90px">Subtotal</th>
              <th style="padding:6px 4px;width:28px"></th>
            </tr>
          </thead>
          <tbody id="f-lineas-tbody"></tbody>
          <tfoot>
            <tr style="background:var(--bg);border-top:2px solid var(--border)">
              <td colspan="3" style="padding:7px 8px;font-size:11px;color:var(--text-soft)">Los totales se calculan autom√°ticamente</td>
              <td colspan="2" style="padding:7px 8px;text-align:right;font-size:11px;font-weight:600">Base imp. / Total c/IVA</td>
              <td style="padding:7px 8px;text-align:right;font-weight:700;color:var(--navy)" id="f-lineas-total">0,00 ‚Ç¨ / 0,00 ‚Ç¨</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="form-grid" style="margin-top:12px">
      <div class="form-group fg-full"><label class="form-label">Concepto general <span style="font-size:10px;color:var(--text-soft);font-weight:400">(resumen para cabecera de factura)</span></label>
        <input class="form-input" id="f-concepto" placeholder="Ej: Mobiliario comedor seg√∫n presupuesto PRE-001‚Ä¶">
      </div>
      <div class="form-group"><label class="form-label">Base imponible ‚Ç¨ <span style="font-size:10px;color:var(--amber);font-weight:400">‚Üë auto desde l√≠neas</span></label>
        <input class="form-input" id="f-base" type="number" step="0.01" oninput="calcTotalFac()">
      </div>
      <div class="form-group"><label class="form-label">IVA</label>
        <select class="form-input" id="f-iva" onchange="calcTotalFac()">
          <option>21%</option><option>10%</option><option>4%</option><option>Exento</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Total con IVA</label>
        <input class="form-input" id="f-total-display" readonly style="background:var(--bg);font-weight:700;color:var(--navy)">
      </div>
      <!-- Vencimiento √∫nico (ventas) / m√∫ltiple (compras) -->
      <div class="form-group" id="f-grp-vto-simple">
        <label class="form-label">Fecha vencimiento</label>
        <input class="form-input" id="f-vto-venta" type="date">
      </div>
      <!-- Vencimientos m√∫ltiples solo para compras -->
      <div class="form-group fg-full" id="f-grp-vtos-compra" style="display:none">
        <label class="form-label">Vencimientos <span style="font-size:10px;color:var(--text-soft);font-weight:400">‚Äî hasta 4 plazos (pulsa üí° para sugerir d√≠as de pago)</span>
          <button type="button" onclick="sugerirDiasPago()" style="background:none;border:none;cursor:pointer;font-size:14px;padding:0 4px;vertical-align:middle" title="Sugerir d√≠as de pago">üí°</button>
        </label>
        <div style="display:grid;grid-template-columns:1fr 120px 1fr 120px 1fr 120px 1fr 120px;gap:6px;align-items:center">
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 1</div><input class="form-input" id="f-vto" type="date" onclick="confirmarVto('f-vto')" onchange="confirmarVto('f-vto')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div><input class="form-input" id="f-importe-vto1" type="number" step="0.01" placeholder="‚Ç¨" onclick="confirmarVto('f-importe-vto1')" onchange="confirmarVto('f-importe-vto1')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 2</div><input class="form-input" id="f-vto2" type="date" onclick="confirmarVto('f-vto2')" onchange="confirmarVto('f-vto2')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div><input class="form-input" id="f-importe-vto2" type="number" step="0.01" placeholder="‚Ç¨" onclick="confirmarVto('f-importe-vto2')" onchange="confirmarVto('f-importe-vto2')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 3</div><input class="form-input" id="f-vto3" type="date" onclick="confirmarVto('f-vto3')" onchange="confirmarVto('f-vto3')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div><input class="form-input" id="f-importe-vto3" type="number" step="0.01" placeholder="‚Ç¨" onclick="confirmarVto('f-importe-vto3')" onchange="confirmarVto('f-importe-vto3')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Vto. 4</div><input class="form-input" id="f-vto4" type="date" onclick="confirmarVto('f-vto4')" onchange="confirmarVto('f-vto4')"></div>
          <div><div style="font-size:10px;color:var(--text-soft);margin-bottom:2px;text-align:center">Importe</div><input class="form-input" id="f-importe-vto4" type="number" step="0.01" placeholder="‚Ç¨" onclick="confirmarVto('f-importe-vto4')" onchange="confirmarVto('f-importe-vto4')"></div>
        </div>
        <div style="font-size:10px;color:var(--text-soft);margin-top:4px">üí° D√≠as de pago configurados: <span id="f-dias-pago-info">5 y 20 de cada mes</span></div>
      </div>
      <div class="form-group"><label class="form-label">Forma de pago</label>
        <select class="form-input" id="f-pago" onchange="onFormaPagoChange()">
          <option>Transferencia</option><option>Efectivo</option><option>Domiciliaci√≥n</option><option>Confirming</option><option>Cheque</option><option>Giro 30 d√≠as</option><option>Giro 60 d√≠as</option><option>Giro 90 d√≠as</option><option>Giro 120 d√≠as</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label" id="f-cobrado-lbl">Importe cobrado ‚Ç¨</label>
        <input class="form-input" id="f-cobrado" type="number" step="0.01" value="0">
      </div>
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="f-estado">
          <option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-factura')">Cancelar</button>
    <button class="btn btn-ghost" onclick="previsualizarFactura()" style="border:1px solid var(--border)">üëÅ Vista previa</button>
    <button class="btn btn-primary" onclick="saveFactura()">üíæ Guardar</button>
  </div>
</div></div>

<!-- QUICK -->
<div class="overlay" id="m-quick"><div class="modal" style="width:320px">
  <div class="modal-head"><div class="modal-title">Ôºã ¬øQu√© quieres crear?</div><button class="modal-close" onclick="closeModal('m-quick')">√ó</button></div>
  <div class="modal-body"><div style="display:flex;flex-direction:column;gap:7px">
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-cliente')">ü§ù <strong style="margin-left:8px">Nuevo cliente</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-proyecto')">üìÅ <strong style="margin-left:8px">Nuevo proyecto</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-comparativa')">‚öñÔ∏è <strong style="margin-left:8px">Comparativa ofertas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-interiorismo')">üõã <strong style="margin-left:8px">Propuesta interiorismo</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-compra')">üõí <strong style="margin-left:8px">Registrar compra</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-hora')">‚è± <strong style="margin-left:8px">Registrar horas</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-pedido')">üì¶ <strong style="margin-left:8px">Nuevo pedido</strong></button>
    <button class="btn btn-ghost" style="justify-content:flex-start;padding:12px 14px" onclick="closeModal('m-quick');openModal('m-factura')">üßæ <strong style="margin-left:8px">Emitir factura</strong></button>
  </div></div>
</div></div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title">‚ö†Ô∏è Eliminar registro</div>
    <div class="confirm-text" id="confirm-text">¬øSeguro que quieres eliminar?</div>
    <div class="confirm-btns"><button class="btn btn-ghost" onclick="closeConfirm()">Cancelar</button><button class="btn btn-danger" onclick="confirmDeleteAction()">Eliminar</button></div>
  </div>
</div>
<!-- MODAL COMPARATIVA VERSIONES -->
<div class="modal-overlay" id="m-comparativa" style="display:none" onclick="if(event.target===this)closeModal('m-comparativa')">
  <div class="modal" style="max-width:920px;width:96%">
    <div class="modal-header">
      <div class="modal-title">‚öñÔ∏è Comparativa de versiones de presupuesto</div>
      <button class="modal-close" onclick="closeModal('m-comparativa')">‚úï</button>
    </div>
    <div class="modal-body" style="padding:16px">
      <div id="comp-kpis" class="kpi-grid" style="margin-bottom:16px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))"></div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead id="comp-thead"></thead>
          <tbody id="comp-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO FINAL (documento imprimible)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPresFinal(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  populateSelects();
  const sel=document.getElementById('pf-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
}
async function loadPresupuestoFinal(){
  const proy=document.getElementById('pf-proyecto-sel').value;
  const ver=document.getElementById('pf-version-sel').value;
  const empty=document.getElementById('pf-empty');
  if(!proy){empty.style.display='block';return;}
  empty.style.display='none';
  try{
    const[lineas,proyecto]=await Promise.all([
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`),
      sbGet('proyectos',`?proyecto_id=eq.${proy}`)
    ]);
    const p=proyecto[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    // Header
    document.getElementById('pf-num').textContent=`Presupuesto N¬∫: ${proy}-${ver.toUpperCase()}`;
    document.getElementById('pf-fecha').textContent=new Date().toLocaleDateString('es-ES');
    document.getElementById('pf-cliente-nombre').textContent=cliente.nombre||'‚Äî';
    document.getElementById('pf-cliente-cif').textContent=cliente.cif?`CIF: ${cliente.cif}`:'';
    document.getElementById('pf-cliente-dir').textContent=cliente.direccion||'';
    document.getElementById('pf-proyecto-nombre').textContent=p.nombre||'‚Äî';
    document.getElementById('pf-proyecto-dir').textContent=p.direccion_obra||'';
    // Lineas
    let totalBase=0;
    const tbody=document.getElementById('pf-lineas');
    tbody.innerHTML=lineas.map((l,i)=>{
      if(l.es_capitulo)return`<tr><td colspan="5" style="padding:10px 8px;font-weight:700;background:#27405b;color:white;font-size:12px">üìÇ ${l.descripcion}</td></tr>`;
      const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv*(ci>0?(1+ci/100):1);
      totalBase+=sub;
      const bg=i%2===0?'white':'#f9f9f9';
      return`<tr style="background:${bg};border-bottom:1px solid #eee"><td style="padding:7px 8px">${l.descripcion}</td><td style="padding:7px 8px;text-align:center">${l.unidad||''}</td><td style="padding:7px 8px;text-align:right">${l.cantidad||0}</td><td style="padding:7px 8px;text-align:right">${(pv*(ci>0?1+ci/100:1)).toFixed(2)}‚Ç¨</td><td style="padding:7px 8px;text-align:right;font-weight:600">${sub.toFixed(2)}‚Ç¨</td></tr>`;
    }).join('');
    const iva=totalBase*0.10,total=totalBase+iva;
    document.getElementById('pf-base').textContent=totalBase.toFixed(2)+'‚Ç¨';
    document.getElementById('pf-iva').textContent=iva.toFixed(2)+'‚Ç¨';
    document.getElementById('pf-total').textContent=total.toFixed(2)+'‚Ç¨';
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTRATO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initContrato(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  const sel=document.getElementById('ct-proyecto-sel');
  sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
}
async function loadContrato(){
  const proyId=document.getElementById('ct-proyecto-sel').value;
  if(!proyId)return;
  try{
    const[proyArr,lineas]=await Promise.all([
      sbGet('proyectos',`?proyecto_id=eq.${proyId}`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proyId}&version=eq.v1&es_capitulo=eq.false`)
    ]);
    const p=proyArr[0]||{};
    const cliente=CC.find(c=>c.cliente_id===p.cliente_id)||{};
    const totalBase=lineas.reduce((s,l)=>s+(l.subtotal||0),0);
    const totalIVA=totalBase*1.10;
    const hoy=new Date().toLocaleDateString('es-ES');
    document.getElementById('ct-fecha').textContent=hoy;
    document.getElementById('ct-cliente-nombre').textContent=cliente.nombre||'[CLIENTE]';
    document.getElementById('ct-cliente-cif').textContent=cliente.cif||'[CIF]';
    document.getElementById('ct-cliente-dir').textContent=cliente.direccion||'[DIRECCI√ìN]';
    document.getElementById('ct-proyecto-nombre').textContent=p.nombre||'[PROYECTO]';
    document.getElementById('ct-proyecto-dir').textContent=p.direccion_obra||'[DIRECCI√ìN OBRA]';
    document.getElementById('ct-pres-id').textContent=`${proyId}-V1`;
    document.getElementById('ct-importe').textContent=totalIVA.toFixed(2)+'‚Ç¨ (IVA incluido)';
    document.getElementById('ct-firma-cliente').textContent=cliente.nombre||'[CLIENTE]';
    // Populate presupuesto selector
    document.getElementById('ct-pres-sel').innerHTML=`<option value="v1">${proyId}-v1 ¬∑ ${totalIVA.toFixed(2)}‚Ç¨ c/IVA</option>`;
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEDIDO DOCUMENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPedidoDoc(){
  if(!PedC.length)PedC=await sbGet('pedidos','?order=fecha.desc').catch(()=>[]);
  const sel=document.getElementById('pd-pedido-sel');
  sel.innerHTML='<option value="">Seleccionar pedido‚Ä¶</option>'+PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin n¬∫'} ¬∑ ${p.proveedor||'‚Äî'} ¬∑ ${fmt(p.importe)}</option>`).join('');
}
async function loadPedidoDoc(){
  const id=document.getElementById('pd-pedido-sel').value;
  if(!id)return;
  const ped=PedC.find(p=>p.id===id);
  if(!ped)return;
  const prov=ProvC.find(p=>p.nombre===ped.proveedor)||{};
  const proy=PC.find(p=>p.proyecto_id===ped.proyecto_id)||{};
  document.getElementById('pd-num').textContent=ped.num_pedido||'‚Äî';
  document.getElementById('pd-fecha').textContent=fmtD(ped.fecha);
  document.getElementById('pd-prov-nombre').textContent=ped.proveedor||'‚Äî';
  document.getElementById('pd-prov-tel').textContent=prov.telefono?`Tel: ${prov.telefono}`:'';
  document.getElementById('pd-prov-email').textContent=prov.email||'';
  document.getElementById('pd-proyecto').textContent=proy.nombre||ped.proyecto_id||'‚Äî';
  document.getElementById('pd-tipo').textContent=ped.tipo||'';
  document.getElementById('pd-concepto').textContent=ped.observaciones||ped.tipo||'Material seg√∫n pedido';
  document.getElementById('pd-importe').textContent=fmt(ped.importe);
  document.getElementById('pd-obs').textContent=ped.observaciones||'Servir lo antes posible.';
  document.getElementById('pd-proyecto-dir').textContent=proy.direccion_obra||'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LISTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function upsertConfig(clave, valor){
  // GET para ver si ya existe
  const check = await fetch(SB_URL+'/rest/v1/configuracion?clave=eq.'+encodeURIComponent(clave)+'&select=id', {
    headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY}
  });
  const existing = check.ok ? await check.json() : [];
  if(existing.length > 0){
    // PATCH - actualizar
    const resp = await fetch(SB_URL+'/rest/v1/configuracion?clave=eq.'+encodeURIComponent(clave), {
      method:'PATCH',
      headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({valor})
    });
    if(!resp.ok){const e=await resp.text();throw new Error(e);}
  } else {
    // POST - insertar nuevo
    const resp = await fetch(SB_URL+'/rest/v1/configuracion', {
      method:'POST',
      headers:{'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({clave, valor, descripcion:'Configuracion'})
    });
    if(!resp.ok){const e=await resp.text();throw new Error(e);}
  }
}

async function addListItem(listId, tipo){
  const val=prompt(`Nuevo ${tipo}:`);
  if(!val||!val.trim())return;
  const v=val.trim();
  // Actualizar cach√© en memoria
  const clave=LISTA_MAP[listId];
  if(clave){
    if(clave==='trabajadores'){if(!TRABAJADORES.includes(v))TRABAJADORES.push(v);}
    else if(LISTAS[clave]){if(!LISTAS[clave].includes(v))LISTAS[clave].push(v);}
  }
  // Actualizar UI
  const list=document.getElementById(listId);
  if(list){
    const div=document.createElement('div');
    div.className='lista-item';div.dataset.val=v;div.textContent=v;
    list.appendChild(div);
  }
  // Refrescar todos los desplegables
  populateTrabajadores();
  populateAllListas();
  // Guardar en Supabase
  if(clave){
    const arr=clave==='trabajadores'?TRABAJADORES:(LISTAS[clave]||[]);
    try{
      await upsertConfig(clave, arr.join(','));
      toast(`"${v}" guardado ‚úÖ`);
    }catch(e){
      toast(`Error guardando: ${e.message}`,'error');
    }
  } else {
    toast(`"${v}" a√±adido ‚úÖ`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL='https://qxyflndntpmcdbyvwjnj.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4eWZsbmRudHBtY2RieXZ3am5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjgzOTMsImV4cCI6MjA4NzUwNDM5M30.WQ193I6oS9ANMvuWG8XXa_J6oFleoTSlLQKeFVR_d50';
const USERS={'jose':'pau2026','pau':'pau2026'};
const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS_CORTOS=['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doLogin(){
  const u=document.getElementById('login-user').value.trim()||'jose';
  const p=document.getElementById('login-pass').value;
  // Contrase√±a maestra (SHA-256 de "pau2026")
  const PASS_HASH='2ce5f8dfc259976ad98b39e354432d527e34d68b70c00fb9e982dfc1351a639f';
  // Simple check - hash the input
  const encoder=new TextEncoder();
  crypto.subtle.digest('SHA-256',encoder.encode(p)).then(buf=>{
    const hex=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    if(hex===PASS_HASH){
      document.getElementById('login-screen').style.display='none';
      sessionStorage.setItem('pau-auth','1');
      sessionStorage.setItem('pau-user',u.toLowerCase());
      setUserDisplay(u);
      document.getElementById('login-error').style.display='none';
      init();
    } else {
      const errEl=document.getElementById('login-error');
      if(errEl){ errEl.style.display='block'; errEl.textContent='Contrase√±a incorrecta'; }
      document.getElementById('login-pass').value='';
      document.getElementById('login-pass').focus();
    }
  });
}
function doLogout(){sessionStorage.clear();location.reload();}
function setUserDisplay(u){
  const n=u.charAt(0).toUpperCase()+u.slice(1);
  document.getElementById('user-name').textContent=n;
  document.getElementById('user-av').textContent=n.substring(0,2).toUpperCase();
}
// ‚îÄ‚îÄ ARRANQUE: esperar a que el DOM est√© listo ‚îÄ‚îÄ
function arrancar(){
  const passEl = document.getElementById('login-pass');
  if(passEl) passEl.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  // Si ya hay sesi√≥n activa, entrar directamente
  if(sessionStorage.getItem('pau-auth')==='1'){
    const loginScreen = document.getElementById('login-screen');
    if(loginScreen) loginScreen.style.display='none';
    setUserDisplay(sessionStorage.getItem('pau-user')||'jose');
    init().catch(e=>{
      console.error('INIT ERROR:', e);
      document.body.insertAdjacentHTML('beforeend',
        '<div style="position:fixed;top:0;left:0;right:0;background:#c0392b;color:white;padding:12px 16px;z-index:99999;font-size:13px;font-family:monospace">'
        +'‚ö†Ô∏è Error de inicio: '+e.message+'</div>');
    });
  } else {
    // Mostrar pantalla de login
    const loginScreen = document.getElementById('login-screen');
    if(loginScreen) loginScreen.style.display='flex';
    setTimeout(()=>{ const u=document.getElementById('login-user'); if(u)u.focus(); },100);
  }
}
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', arrancar);
} else {
  arrancar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sb(table,method='GET',body=null,id=null,extra=''){
  const url=`${SB_URL}/rest/v1/${table}${id?`?id=eq.${id}`:''}${extra}`;
  const r=await fetch(url,{method,headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':method==='POST'?'return=representation':''},body:body?JSON.stringify(body):null});
  if(!r.ok)throw new Error(await r.text());
  const t=await r.text();return t?JSON.parse(t):[];
}
const sbGet=(t,e='')=>sb(t,'GET',null,null,e);
const sbPost=(t,d)=>sb(t,'POST',d);
const sbPatch=(t,id,d)=>sb(t,'PATCH',d,id);
const sbDelete=(t,id)=>sb(t,'DELETE',null,id);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const META={
  gerencia:{t:'Gerencia ¬∑ Panel ejecutivo',b:'Datos en tiempo real ¬∑ Todos los proyectos'},
  agenda:{t:'Agenda ¬∑ Recordatorios',b:'Avisos y citas con notificaci√≥n'},
  clientes:{t:'Clientes',b:'Base de datos centralizada'},
  proyectos:{t:'Proyectos',b:'Todos los proyectos'},
  presupuesto:{t:'Presupuesto ¬∑ Constructor',b:'B√∫squeda CYPE + Tarifario propio'},
  comparativa:{t:'Comparativa de ofertas',b:'Compara hasta 3 proveedores por trabajo'},
  tarifario:{t:'Tarifario ¬∑ Cat√°logo propio',b:''},
  cype:{t:'CYPE 2026 ¬∑ 524 partidas',b:'Base de precios importada de tu Excel'},
  interiorismo:{t:'Interiorismo & Mobiliario',b:'Propuestas ¬∑ Pedidos ¬∑ M√°rgenes'},
  compras:{t:'Compras',b:''},subcontratas:{t:'Subcontratas',b:''},
  horas:{t:'Control de horas',b:''},pedidos:{t:'Registro de pedidos',b:''},
  control_horario:{t:'Control horario anual',b:'Ficha por trabajador'},
  proveedores:{t:'Proveedores',b:'32 proveedores importados'},
  conciliacion:{t:'Conciliaci√≥n bancaria',b:'Vencimientos ¬∑ Importar extracto ¬∑ Conciliar pagos autom√°ticamente'},
  rentabilidad:{t:'Rentabilidad por proyecto',b:'Presupuesto vs Coste real'},
  facturas:{t:'Facturas emitidas',b:'Seguimiento de cobros'},
  contabilidad:{t:'Contabilidad',b:'Cuenta de resultados ¬∑ IVA ¬∑ Balance'},
  pres_final:{t:'Presupuesto Final ¬∑ Documento',b:'Documento imprimible listo para enviar al cliente'},
  contrato:{t:'Contrato de obra',b:'Plantilla de contrato autorellenable'},
  pedido_doc:{t:'Documento de pedido',b:'Hoja de pedido a proveedor imprimible'},
  listas:{t:'Listas ¬∑ Gesti√≥n de desplegables',b:'Edita trabajadores, estados, partidas y m√°s'},
  rrhh:{t:'RR.HH. ¬∑ N√≥minas',b:'Fichas de trabajadores ¬∑ N√≥minas ¬∑ Coste empresa'},
  configuracion:{t:'Configuraci√≥n',b:'Empresa ¬∑ CI+GG+BI ¬∑ Par√°metros'},
};
document.querySelectorAll('.nav-item[data-view]').forEach(el=>el.addEventListener('click',()=>navTo(el.dataset.view)));
async function navTo(v){
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  document.querySelector(`[data-view="${v}"]`)?.classList.add('active');
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  document.getElementById('view-'+v)?.classList.add('active');
  const m=META[v]||{};
  document.getElementById('tb-title').textContent=m.t||v;
  document.getElementById('tb-bc').textContent=m.b||'';
  if(loaders[v]) await loaders[v]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêonst bColors={'Nuevo lead':'b-gray','Presupuesto enviado':'b-amber','Aprobado':'b-blue','En ejecuci√≥n':'b-blue','Finalizado':'b-green','Facturado':'b-green','Cobrado':'b-navy','Cancelado':'b-red','Pendiente':'b-amber','Pagado':'b-green','Cobrada':'b-green','Parcial':'b-copper','Vencido':'b-red','Vencida':'b-red','Borrador':'b-gray','Enviada':'b-amber','Aprobada':'b-green','Rechazada':'b-red','En pedido':'b-blue','Entregada':'b-navy','Solicitado':'b-amber','Confirmado':'b-blue','En tr√°nsito':'b-blue','Recibido':'b-copper','Proveedor':'b-blue','Subcontrata':'b-green','Obra nueva':'b-navy','Rehabilitaci√≥n integral':'b-green','Interiorismo':'b-copper','Particular':'b-blue','Empresa':'b-green','Promotora':'b-copper'};
function bE(v){return`<span class="badge ${bColors[v]||'b-gray'}">${v||'‚Äî'}</span>`}
function fmt(n){if(n===null||n===undefined||n==='')return'‚Äî';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨'}
function fmtN(n){if(!n&&n!==0)return'‚Äî';return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨'}
function fmtP(n){return n!=null?Number(n).toFixed(1)+'%':'‚Äî'}
function fmtD(d){if(!d)return'‚Äî';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d}
function genId(pre,list,key){const ns=list.map(x=>parseInt((x[key||pre.toLowerCase()+'_id']||'').replace(/\D/g,''))||0);return`${pre}-${(Math.max(0,...ns)+1).toString().padStart(3,'0')}`}
function ivaPct(s){return s==='Exento'?0:parseFloat(s)||21}
let toastT;
function toast(msg,type='success'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast show ${type}`;clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3200);}
function openModal(id){
  if(id==='m-comparativa'){
    poblarProveedoresComparativa();
    poblarClientesModalCmp();
    // Poblar proyectos tambi√©n
    const proySel=document.getElementById('cmp-proyecto');
    const clienteId=document.getElementById('cmp-cliente')?.value;
    if(proySel){
      const filtrados=clienteId?PC.filter(p=>p.cliente_id===clienteId):PC;
      proySel.innerHTML='<option value="">Seleccionar‚Ä¶</option>'
        +filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }
  }
  document.getElementById(id)?.classList.add('open');
}
function closeModal(id){document.getElementById(id)?.classList.remove('open')}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open')}));
let pendingDel=null;
function confirmDelete(table,id,name){pendingDel={table,id};document.getElementById('confirm-text').textContent=`¬øEliminar "${name}"? No se puede deshacer.`;document.getElementById('confirm-overlay').classList.add('open');}
function closeConfirm(){pendingDel=null;document.getElementById('confirm-overlay').classList.remove('open');}
async function confirmDeleteAction(){if(!pendingDel)return;try{await sbDelete(pendingDel.table,pendingDel.id);toast('Eliminado ‚úÖ');closeConfirm();loaders[currentView()]?.();}catch(e){toast('Error: '+e.message,'error');}}
function currentView(){return document.querySelector('.view.active')?.id.replace('view-','')||'gerencia';}
function filterTable(tbId,inId){const q=document.getElementById(inId)?.value.toLowerCase()||'';document.querySelectorAll(`#${tbId} tr[data-search]`).forEach(r=>{r.style.display=r.dataset.search.includes(q)?'':'none';});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CACHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CC=[],PC=[],TC=[],ProvC=[],IntC=[],CoC=[],ScC=[],HC=[],FC=[],PedC=[],CmpC=[],PresC=[],CyCache=[];
let TRABAJADORES=['Paco','Ra√∫l','Boro','Julio','Pau','Jose Asins'];
let LISTAS={
  estados_proyecto:['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuci√≥n','Finalizado','Facturado','Cobrado','Cancelado'],
  tipos_proyecto:['Obra nueva','Rehabilitaci√≥n integral','Reforma parcial','Cocina','Ba√±o','Interiorismo','Mobiliario','Electricidad','Fontaner√≠a','Pintura','Otros'],
  formas_pago:['Transferencia','Efectivo','Giro','Domiciliaci√≥n','Confirming','Pagar√©'],
  tipos_cliente:['Particular','Empresa','Promotora','Administraci√≥n','Otros'],
  tipos_proveedor:['Proveedor','Subcontrata','Alquiler','Servicio','Transporte','Otros'],
  estancias:['Sal√≥n','Cocina','Dormitorio','Ba√±o','Terraza','Despacho','Comedor','Pasillo','Entrada','Otros'],
  categorias_tarifario:['Mobiliario','Sofas y tapizados','Dormitorios','Colchones','Cocina','Banos','Sanitarios','Griferias','Pavimentos','Revestimientos','Carpinteria','Puertas y ventanas','Iluminacion','Climatizacion','Calefaccion','Instalaciones','Electricidad','Fontaneria','Pintura','Varios','Otros'],
};
const LISTA_MAP={'trabajadores-list':'trabajadores','estados-list':'estados_proyecto','tipos-proyecto-list':'tipos_proyecto','formas-pago-list':'formas_pago','tipos-cliente-list':'tipos_cliente','tipos-proveedor-list':'tipos_proveedor','estancias-list':'estancias','categorias-list':'categorias_tarifario'};

// familias gestionadas aparte via familias_tarifario (tabla supabase)

// ‚îÄ‚îÄ GESTI√ìN DE FAMILIAS DEL TARIFARIO ‚îÄ‚îÄ
async function loadFamiliasTarifario(){
  const container = document.getElementById('familias-tarifario-container');
  if(!container) return;
  try{
    // Get unique families from tarifario table
    const items = await sbGet('tarifario','?select=categoria,familia&order=categoria,familia');
    // Also get any manually saved families from configuracion
    let savedFams = [];
    try{
      const cfg = await sbGet('configuracion','?clave=eq.familias_tarifario');
      if(cfg.length) savedFams = cfg[0].valor.split('||').filter(Boolean).map(f=>{
        const [cat,fam]=f.split('::'); return {categoria:cat,familia:fam};
      });
    }catch(e){}
    
    // Merge: DB families + saved families
    const famMap = {};
    items.forEach(t=>{
      if(!t.familia) return;
      const cat = t.categoria||'Sin categor√≠a';
      if(!famMap[cat]) famMap[cat]=new Set();
      famMap[cat].add(t.familia);
    });
    savedFams.forEach(f=>{
      if(!f.familia) return;
      if(!famMap[f.categoria]) famMap[f.categoria]=new Set();
      famMap[f.categoria].add(f.familia);
    });

    if(!Object.keys(famMap).length){
      container.innerHTML='<div style="color:var(--text-soft);font-size:12px;text-align:center;padding:16px">No hay familias definidas a√∫n. Cr√©alas al a√±adir art√≠culos al tarifario o pulsa Ôºã A√±adir familia.</div>';
      return;
    }

    let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">';
    Object.keys(famMap).sort().forEach(cat=>{
      const fams = [...famMap[cat]].sort();
      html += `<div style="background:#f8f9fb;border-radius:8px;padding:10px">`;
      html += `<div style="font-size:11px;font-weight:800;color:var(--navy-mid);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">${cat}</div>`;
      fams.forEach(fam=>{
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 8px;background:white;border-radius:6px;margin-bottom:4px;border:1px solid var(--border)">`;
        html += `<span style="font-size:12px">${fam}</span>`;
        html += `<div style="display:flex;gap:4px">`;
        html += `<button class="btn btn-ghost btn-icon btn-sm" title="Renombrar" onclick="renameFamilia('${cat.replace(/'/g,"\'")}','${fam.replace(/'/g,"\'")}')">‚úèÔ∏è</button>`;
        html += `<button class="btn btn-ghost btn-icon btn-sm" title="Eliminar" onclick="deleteFamilia('${cat.replace(/'/g,"\'")}','${fam.replace(/'/g,"\'")}')">üóë</button>`;
        html += `</div></div>`;
      });
      html += `</div>`;
    });
    html += '</div>';
    container.innerHTML = html;
  }catch(e){
    container.innerHTML=`<div style="color:var(--red);font-size:12px;padding:12px">Error cargando familias: ${e.message}</div>`;
  }
}

async function addFamiliaTarifario(){
  const cats = LISTAS.categorias_tarifario || [];
  if(!cats.length){ toast('Primero a√±ade categor√≠as en la lista de arriba','error'); return; }
  
  // Show a simple modal-style prompt
  const cat = await seleccionarOpcion('Categor√≠a', cats);
  if(!cat) return;
  const fam = prompt(`Nueva familia dentro de "${cat}":`);
  if(!fam||!fam.trim()) return;
  
  // Save to configuracion as a combined string
  try{
    const cfg = await sbGet('configuracion','?clave=eq.familias_tarifario');
    let vals = cfg.length ? cfg[0].valor.split('||').filter(Boolean) : [];
    const key = `${cat}::${fam.trim()}`;
    if(!vals.includes(key)) vals.push(key);
    await upsertConfig('familias_tarifario', vals.join('||'));
    toast(`Familia "${fam.trim()}" a√±adida ‚úÖ`);
    loadFamiliasTarifario();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

async function renameFamilia(cat, oldFam){
  const newFam = prompt(`Renombrar "${oldFam}":`, oldFam);
  if(!newFam||!newFam.trim()||newFam.trim()===oldFam) return;
  try{
    // Update all tarifario items with this family
    const items = TC.filter(t=>(t.categoria||'')===cat && (t.familia||'')===oldFam);
    for(const item of items){
      await sbPatch('tarifario', item.id, {familia: newFam.trim()});
    }
    // Update saved families in configuracion
    const cfg = await sbGet('configuracion','?clave=eq.familias_tarifario');
    if(cfg.length){
      const vals = cfg[0].valor.split('||').filter(Boolean);
      const newVals = vals.map(v => v===`${cat}::${oldFam}` ? `${cat}::${newFam.trim()}` : v);
      await upsertConfig('familias_tarifario', newVals.join('||'));
    }
    toast(`Familia renombrada a "${newFam.trim()}" ‚úÖ`);
    loadFamiliasTarifario();
    loadTarifario();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

async function deleteFamilia(cat, fam){
  const count = TC.filter(t=>(t.categoria||'')===cat && (t.familia||'')===fam).length;
  const msg = count > 0 
    ? `¬øEliminar familia "${fam}"? Los ${count} art√≠culos quedar√°n sin familia asignada.`
    : `¬øEliminar familia "${fam}"?`;
  if(!confirm(msg)) return;
  try{
    // Clear family on all affected tarifario items
    const items = TC.filter(t=>(t.categoria||'')===cat && (t.familia||'')===fam);
    for(const item of items){
      await sbPatch('tarifario', item.id, {familia: null});
    }
    // Remove from configuracion
    const cfg = await sbGet('configuracion','?clave=eq.familias_tarifario');
    if(cfg.length){
      const vals = cfg[0].valor.split('||').filter(Boolean).filter(v=>v!==`${cat}::${fam}`);
      await upsertConfig('familias_tarifario', vals.join('||'));
    }
    toast(`Familia "${fam}" eliminada ‚úÖ`);
    loadFamiliasTarifario();
    loadTarifario();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

async function seleccionarOpcion(titulo, opciones){
  return new Promise(resolve=>{
    const ov=document.createElement('div');
    ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px';
    const box=document.createElement('div');
    box.style.cssText='background:white;border-radius:12px;padding:20px;max-width:320px;width:100%';
    box.innerHTML=`<div style="font-weight:800;font-size:15px;margin-bottom:14px">üìÇ ${titulo}</div>`;
    opciones.forEach(op=>{
      const btn=document.createElement('button');
      btn.textContent=op;
      btn.style.cssText='display:block;width:100%;text-align:left;padding:9px 12px;border:1px solid var(--border);border-radius:7px;background:white;cursor:pointer;font-size:13px;margin-bottom:6px';
      btn.onmouseover=()=>btn.style.background='#f0f4ff';
      btn.onmouseout=()=>btn.style.background='white';
      btn.onclick=()=>{ ov.remove(); resolve(op); };
      box.appendChild(btn);
    });
    const cancel=document.createElement('button');
    cancel.textContent='Cancelar';
    cancel.style.cssText='display:block;width:100%;padding:8px;border:1px solid #ddd;border-radius:7px;background:none;cursor:pointer;font-size:12px;color:#888;margin-top:4px';
    cancel.onclick=()=>{ ov.remove(); resolve(null); };
    box.appendChild(cancel);
    ov.appendChild(box);
    ov.addEventListener('click',e=>{ if(e.target===ov){ ov.remove(); resolve(null); }});
    document.body.appendChild(ov);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPULATE SELECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateAllListas(){
  const map={estados_proyecto:['p-estado'],tipos_proyecto:['p-tipo'],formas_pago:['c-pago','pv-pago','f-pago'],tipos_cliente:['c-tipo'],tipos_proveedor:['pv-tipo'],estancias:['i-estancia'],categorias_tarifario:['t-cat']};
  Object.entries(map).forEach(([key,ids])=>{
    const vals=LISTAS[key]||[];
    ids.forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+vals.map(v=>`<option value="${v}">${v}</option>`).join('');if(cur&&vals.includes(cur))el.value=cur;});
  });
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTRO POR CLIENTE EN PROYECTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


function filtrarProyectosPorCliente(){
  const sel=document.getElementById('filter-cliente-proyectos');
  const clienteId=sel?sel.value:'';
  const tbody=document.getElementById('proyectos-tbody');
  if(!tbody)return;
  const rows=tbody.querySelectorAll('tr');
  let visible=0;
  rows.forEach(tr=>{
    const ds=tr.dataset.search||'';
    // cliente_id is 3rd part of data-search: proyecto_id+nombre+cliente_id+tipo+estado
    const show=!clienteId||ds.includes(clienteId.toLowerCase());
    tr.style.display=show?'':'none';
    if(show)visible++;
  });
  // Update count
  const count=document.getElementById('proyectos-count');
  if(count){
    const clienteNombre=clienteId
      ?(CC.find(c=>c.cliente_id===clienteId)||{}).nombre||clienteId
      :'';
    count.textContent=clienteId
      ?`${visible} proyecto${visible!==1?'s':''} ¬∑ ${clienteNombre}`
      :`${rows.length} proyectos`;
  }
  // Auto-set cliente in new proyecto modal
  if(clienteId){
    const f=document.getElementById('p-cliente');
    if(f)f.value=clienteId;
  }
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERIORISMO: CASCADA + EDICI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cascadaModuloInt(){
  const clienteSel = document.getElementById('filter-cliente-interiorismo');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('filter-proyecto-interiorismo');
  if(!proySel) return;
  const filtrados  = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">üìÅ Proyecto‚Ä¶</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  filtrarInteriorismo();
}

function filtrarInteriorismo(){
  const proySel = document.getElementById('filter-proyecto-interiorismo');
  const proyId  = proySel ? proySel.value : '';
  const tbody   = document.getElementById('interiorismo-tbody');
  if(!tbody) return;
  const count   = document.getElementById('interiorismo-count');

  if(!proyId){
    tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">üõã</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">Los art√≠culos aparecer√°n aqu√≠ una vez seleccionado el proyecto</div>
    </td></tr>`;
    if(count) count.textContent='‚Äî';
    return;
  }
  // Auto-set proyecto en modal
  const iProy = document.getElementById('i-proyecto');
  if(iProy) iProy.value = proyId;

  const rows = tbody.querySelectorAll('tr[data-search]');
  let visible = 0;
  rows.forEach(tr=>{
    const show = tr.dataset.search?.includes(proyId.toLowerCase());
    tr.style.display = show ? '' : 'none';
    if(show) visible++;
  });
  if(visible===0 && rows.length>0){
    if(!tbody.querySelector('#int-empty-state')){
      const tr=document.createElement('tr'); tr.id='int-empty-state';
      tr.innerHTML=`<td colspan="10" style="text-align:center;padding:30px;color:var(--text-soft)">
        <div style="font-size:24px;margin-bottom:6px">üìã</div>
        <div>Sin art√≠culos para <strong>${proyId}</strong></div>
      </td>`;
      tbody.appendChild(tr);
    }
  } else {
    const empty = tbody.querySelector('#int-empty-state');
    if(empty) empty.remove();
  }
  if(count) count.textContent=`${visible} art√≠culo${visible!==1?'s':''} ¬∑ ${proyId}`;
}

function editInteriorismo(id){
  const item = IntC.find(x=>String(x.id)===String(id)); if(!item) return;
  const set = (elId, val) => { const el=document.getElementById(elId); if(el) el.value=val||''; };
  document.getElementById('i-id').value = item.id;
  set('i-proyecto',   item.proyecto_id);
  set('i-estancia',   item.estancia);
  set('i-ref',        item.ref_catalogo);
  set('i-desc',       item.descripcion);
  set('i-marca',      item.marca);
  set('i-acabado',    item.acabado);
  set('i-cant',       item.cantidad);
  set('i-pvp',        item.pvp_catalogo);
  set('i-dto',        item.dto_cliente_pct);
  set('i-coste',      item.coste_neto);
  set('i-iva',        item.iva_pct||'21%');
  set('i-eprop',      item.estado_propuesta);
  set('i-eped',       item.estado_pedido);
  set('i-fentrega',   item.fecha_entrega);
  set('i-notas',      item.notas);
  document.querySelector('#m-interiorismo .modal-title').textContent = '‚úèÔ∏è Editar art√≠culo';
  openModal('m-interiorismo');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CASCADA CLIENTE‚ÜíPROYECTO PARA DOCUMENTOS
// (pres_final, contrato, pedido_doc)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Generic: filter project selector by client, then call loadFn
function cascadaModulo(mod, proySelId, loadFn){
  const clienteSel = document.getElementById(`filter-cliente-${mod}`);
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById(proySelId);
  if(!proySel) return;
  const cur = proySel.value;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">üìÅ Proyecto‚Ä¶</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  // Restore selection if still valid
  if(cur && filtrados.find(p=>p.proyecto_id===cur)) proySel.value = cur;
  if(loadFn) loadFn();
}

// Doc. Pedido: cliente ‚Üí filter proyecto ‚Üí filter pedidos list
function cascadaDocPedido(){
  const clienteSel = document.getElementById('filter-cliente-pedido_doc');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('filter-proyecto-pedido_doc');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">üìÅ Proyecto‚Ä¶</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  // Reset pedido selector and doc
  const pedSel = document.getElementById('pd-pedido-sel');
  if(pedSel) pedSel.innerHTML = '<option value="">‚Äî Pedido‚Ä¶ ‚Äî</option>';
  nuevoPedidoDoc();
}

// Doc. Pedido: proyecto ‚Üí filter pedidos list
function filtrarPedidosPorProyecto(){
  const proySel  = document.getElementById('filter-proyecto-pedido_doc');
  const proyId   = proySel ? proySel.value : '';
  const pedSel   = document.getElementById('pd-pedido-sel');
  if(!pedSel) return;
  const pedidos = proyId ? PedC.filter(p=>p.proyecto_id===proyId) : PedC;
  pedSel.innerHTML = '<option value="">‚Äî Pedido‚Ä¶ ‚Äî</option>'
    + pedidos.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin n¬∫'} ¬∑ ${p.proveedor||'Sin prov.'}</option>`).join('');
  // Reset doc content
  nuevoPedidoDoc();
}

// Poblar selectores de cliente en documentos al init/load
function poblarClientesDocumentos(){
  const ids = ['filter-cliente-pres_final','filter-cliente-contrato','filter-cliente-pedido_doc'];
  ids.forEach(selId=>{
    const sel = document.getElementById(selId);
    if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">üë§ Cliente‚Ä¶</option>'
      + CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
    if(cur) sel.value = cur;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CASCADA CLIENTE ‚Üí PROYECTO EN M√ìDULOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// M√≥dulos con cascada cliente‚Üíproyecto
const CASCADA_MODS = ['presupuesto','compras','subcontratas','horas','pedidos','interiorismo'];
// Comparativa uses its own cascade function (poblarClientesComparativa)

// Prefijo del campo proyecto en el modal de cada m√≥dulo
const MOD_PROYECTO_FIELD = {
  presupuesto: 'pres-proyecto-sel',  // special: usa su propio selector
  compras:     'co-proyecto',
  subcontratas:'sc-proyecto',
  horas:       'h-proyecto',
  pedidos:     'ped-proyecto',
};

// Poblar selector de clientes en todos los m√≥dulos
function poblarFiltrosCliente(){
  // Cascada en m√≥dulos (compras, horas, etc.) + p√°gina proyectos
  const sels = CASCADA_MODS.map(m=>`filter-cliente-${m}`)
    .concat(['filter-cliente-proyectos']);
  sels.forEach(selId=>{
    const sel=document.getElementById(selId);
    if(!sel)return;
    const cur=sel.value;
    const isProyectos = selId==='filter-cliente-proyectos';
    sel.innerHTML=`<option value="">${isProyectos?'üë§ Todos los clientes':'üë§ Cliente‚Ä¶'}</option>`
      +CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
}

// Cuando cambia el cliente: filtrar proyectos en cascada
function cascadaClienteProyecto(mod){
  const clienteSel=document.getElementById(`filter-cliente-${mod}`);
  const clienteId=clienteSel?clienteSel.value:'';

  // Filtrar selector de proyectos seg√∫n cliente
  const proySel = mod==='presupuesto'
    ? document.getElementById('pres-proyecto-sel')
    : document.getElementById(`filter-proyecto-${mod}`);

  if(proySel){
    const proyectosFiltrados = clienteId
      ? PC.filter(p=>p.cliente_id===clienteId)
      : PC;
    const placeholder = mod==='presupuesto' ? 'üìÅ Proyecto‚Ä¶' : 'üìÅ Proyecto‚Ä¶';
    proySel.innerHTML=`<option value="">${placeholder}</option>`
      +proyectosFiltrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  }

  // Limpiar filtro de proyecto y re-filtrar tabla (excepto presupuesto que carga solo)
  if(mod!=='presupuesto'){
    filtrarModuloPorProyecto(mod);
  }
}

// Poblar todos los filtros proyecto (para init)
function poblarFiltrosProyecto(){
  CASCADA_MODS.filter(m=>m!=='presupuesto').forEach(mod=>{
    const sel=document.getElementById(`filter-proyecto-${mod}`);
    if(!sel)return;
    const cur=sel.value;
    sel.innerHTML='<option value="">üìÅ Proyecto‚Ä¶</option>'
      +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
  // Presupuesto: poblar su propio selector
  const presSel=document.getElementById('pres-proyecto-sel');
  if(presSel){
    const cur=presSel.value;
    presSel.innerHTML='<option value="">üìÅ Proyecto‚Ä¶</option>'
      +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    if(cur)presSel.value=cur;
  }
}

function filtrarModuloPorProyecto(mod){
  const proySel=document.getElementById(`filter-proyecto-${mod}`);
  const proyId=proySel?proySel.value:'';
  const tbody=document.getElementById(`${mod}-tbody`);
  if(!tbody)return;
  const count=document.getElementById(`${mod}-count`);

  // Sin proyecto seleccionado ‚Üí tabla vac√≠a con mensaje
  if(!proyId){
    tbody.innerHTML=`<tr id="${mod}-empty-state"><td colspan="20" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">üìÅ</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">Los registros aparecer√°n aqu√≠ una vez seleccionado el proyecto</div>
    </td></tr>`;
    if(count) count.textContent='‚Äî';
    return;
  }

  // Con proyecto seleccionado ‚Üí mostrar solo sus registros
  // Primero restaurar filas ocultas (pueden estar hidden de filtro anterior)
  tbody.querySelectorAll('tr').forEach(tr=>{
    if(tr.id===`${mod}-empty-state`) tr.remove();
  });

  const rows=tbody.querySelectorAll('tr[data-search]');
  let visible=0;
  rows.forEach(tr=>{
    const ds=tr.dataset.search||'';
    const show=ds.includes(proyId.toLowerCase());
    tr.style.display=show?'':'none';
    if(show)visible++;
  });

  // Si no hay registros para este proyecto
  if(visible===0){
    const empty=tbody.querySelector(`#${mod}-empty-state`);
    if(!empty){
      const tr=document.createElement('tr');
      tr.id=`${mod}-empty-state`;
      tr.innerHTML=`<td colspan="20" style="text-align:center;padding:40px;color:var(--text-soft)">
        <div style="font-size:28px;margin-bottom:8px">üìã</div>
        <div style="font-size:13px">Sin registros para <strong>${proyId}</strong></div>
      </td>`;
      tbody.appendChild(tr);
    }
  }

  if(count) count.textContent=`${visible} registro${visible!==1?'s':''} ¬∑ ${proyId}`;

  // Auto-set proyecto en modal de nuevo registro
  const fieldId=MOD_PROYECTO_FIELD[mod];
  if(fieldId && fieldId!=='pres-proyecto-sel'){
    const f=document.getElementById(fieldId);
    if(f)f.value=proyId;
  }
}

function populateTrabajadores(){
  const ids=['h-trab','ch-trab-sel','p-resp'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const cur=el.value;
    const placeholder=id==='ch-trab-sel'?'Seleccionar trabajador‚Ä¶':'Seleccionar‚Ä¶';
    el.innerHTML=`<option value="">${placeholder}</option>`+TRABAJADORES.map(t=>`<option value="${t}">${t}</option>`).join('');
    if(cur&&TRABAJADORES.includes(cur))el.value=cur;
  });
}
async function populateSelects(){
  if(!CC.length)CC=await sbGet('clientes').catch(()=>[]);
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!ProvC.length)ProvC=await sbGet('proveedores','?order=nombre.asc').catch(()=>[]);
  ['p-cliente','f-cliente'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-proyecto','sc-proyecto','h-proyecto','f-proyecto','i-proyecto','ped-proyecto','pres-proyecto-sel','comp-proyecto-sel','rent-proyecto-sel','cmp-proyecto'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');if(cur)el.value=cur;});
  ['co-prov','sc-prov','ped-prov'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const cur=el.value;el.innerHTML='<option value="">Seleccionar proveedor‚Ä¶</option>'+ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ¬∑ '+p.tipo:''}</option>`).join('');if(cur)el.value=cur;});
}
async function populateIntCatalog(){
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  ['i-ref','pl-tarif-sel'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.innerHTML=(id==='i-ref'?'<option value="">‚Äî descripci√≥n libre ‚Äî</option>':'<option value="">‚Äî Seleccionar del tarifario ‚Äî</option>')+TC.map(t=>`<option value="${t.id}">${t.codigo} ¬∑ ${t.descripcion}</option>`).join('');});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GERENCIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GERENCIA ¬∑ RENTABILIDAD FILTRO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GRENT_MAX = 6; // proyectos visibles antes del "Ver todos"
let _grentExpanded = false;

function renderGrentTable(filtro){
  window._grentFiltro = filtro;
  _grentExpanded = false;
  const tbody = document.getElementById('g-rent-table');
  const countEl = document.getElementById('grent-count');
  const expandWrap = document.getElementById('grent-expand-wrap');
  const expandBtn = document.getElementById('grent-expand-btn');
  if(!tbody || !window._grentData) return;

  // Botones estado
  ['activos','alerta','todos'].forEach(k=>{
    const btn=document.getElementById(`grent-btn-${k}`);
    if(btn) btn.className='btn btn-sm '+(k===filtro?'btn-primary':'btn-ghost');
  });

  const ACTIVOS=['Aprobado','En ejecuci√≥n','En Ejecuci√≥n','en ejecuci√≥n','Aprobado'];
  let datos = window._grentData;
  if(filtro==='activos')  datos = datos.filter(d=>ACTIVOS.some(e=>e.toLowerCase()===( d.p.estado||'').toLowerCase()));
  if(filtro==='alerta')   datos = datos.filter(d=>d.mg<0||(d.c>0&&d.v===0));

  if(!datos.length){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--text-soft)">
      ${filtro==='activos'?'No hay proyectos en ejecuci√≥n':filtro==='alerta'?'‚úÖ Sin proyectos en alerta':'Sin proyectos'}
    </td></tr>`;
    if(countEl) countEl.textContent='';
    if(expandWrap) expandWrap.style.display='none';
    return;
  }

  const mostrar = _grentExpanded ? datos : datos.slice(0, GRENT_MAX);
  if(countEl) countEl.textContent = `${datos.length} proyecto${datos.length!==1?'s':''}`;

  tbody.innerHTML = mostrar.map(({p,v,c,ben,mg})=>`<tr>
    <td class="td-mono" style="color:var(--text-soft);font-size:11px">${p.proyecto_id}</td>
    <td><strong>${p.nombre}</strong></td>
    <td>${bE(p.estado)}</td>
    <td class="td-mono" style="color:var(--green);font-weight:700">${v>0?fmt(v):'‚Äî'}</td>
    <td class="td-mono" style="color:var(--red)">${c>0?fmt(c):'‚Äî'}</td>
    <td class="td-mono" style="font-weight:700;${ben>=0?'color:var(--green)':'color:var(--red)'}">${(v||c)?fmt(ben):'‚Äî'}</td>
    <td class="td-mono" style="${mg>=15?'color:var(--green)':mg>=0?'color:var(--amber)':'color:var(--red)'}">${v>0?fmtP(mg):'‚Äî'}</td>
  </tr>`).join('');

  // Bot√≥n expandir
  if(datos.length > GRENT_MAX && !_grentExpanded){
    if(expandWrap) expandWrap.style.display='';
    if(expandBtn) expandBtn.textContent=`‚ñº Ver los ${datos.length - GRENT_MAX} proyectos restantes`;
  } else if(_grentExpanded && datos.length > GRENT_MAX){
    if(expandWrap) expandWrap.style.display='';
    if(expandBtn) expandBtn.textContent='‚ñ≤ Colapsar';
  } else {
    if(expandWrap) expandWrap.style.display='none';
  }
}

function filtrarGrentTable(filtro){ renderGrentTable(filtro); }

function toggleGrentExpand(){
  _grentExpanded = !_grentExpanded;
  renderGrentTable(window._grentFiltro||'activos');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCHABLE SELECT ‚Äî reutilizable
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function filtrarSearchSelect(inputId, ddId, hiddenId, hiddenValId, arr, labelField, valueField){
  const input = document.getElementById(inputId);
  const dd    = document.getElementById(ddId);
  const q     = (input?.value||'').toLowerCase().trim();
  if(!dd) return;
  const items = q ? arr.filter(x=>(x[labelField]||'').toLowerCase().includes(q)) : arr;
  if(!items.length){
    dd.innerHTML=`<div class="search-dd-empty">Sin resultados para "${q}"</div>`;
    dd.style.display='';
    return;
  }
  dd.innerHTML = items.slice(0,40).map(x=>{
    const lbl = x[labelField]||'‚Äî';
    const val = x[valueField]||'';
    const sub = x.cif ? `<span style="color:var(--text-soft);font-size:11px"> ¬∑ ${x.cif}</span>` :
                x.tipo ? `<span style="color:var(--text-soft);font-size:11px"> ¬∑ ${x.tipo}</span>` :
                x.proyecto_id ? `<span style="color:var(--text-soft);font-size:11px"> ${x.proyecto_id}</span>` : '';
    return `<div class="search-dd-item" onmousedown="selecSearchDd('${inputId}','${ddId}','${hiddenId}','${hiddenValId}','${val}','${lbl.replace(/'/g,"\\'")}')">
      <strong>${lbl}</strong>${sub}
    </div>`;
  }).join('');
  dd.style.display='';
}
function selecSearchDd(inputId, ddId, hiddenId, hiddenValId, val, lbl){
  const inp = document.getElementById(inputId);
  const hid = document.getElementById(hiddenId);
  const hv  = document.getElementById(hiddenValId);
  if(inp) inp.value = lbl;
  if(hid) hid.value = val;
  if(hv)  hv.value  = lbl;
  cerrarSearchDd(ddId);
  // Trigger cascada proyecto si cambi√≥ cliente
  if(inputId === 'ped-cliente-search') pedClienteChanged();
}
function abrirSearchDd(ddId){
  const dd = document.getElementById(ddId);
  if(dd && dd.innerHTML) dd.style.display='';
}
function cerrarSearchDd(ddId){
  const dd = document.getElementById(ddId);
  if(dd) dd.style.display='none';
}
function _pedProysFilt(){
  const cid = document.getElementById('ped-cliente-id')?.value;
  if(!cid) return PC;
  return PC.filter(p=>String(p.cliente_id)===String(cid));
}
function pedClienteChanged(){
  // Reset proyecto al cambiar cliente
  const ps = document.getElementById('ped-proyecto-search');
  const pi = document.getElementById('ped-proyecto-id');
  const pv = document.getElementById('ped-proyecto-val');
  if(ps) ps.value=''; if(pi) pi.value=''; if(pv) pv.value='';
}

function exportarInformeFacturas(){
  const tab   = window._facTabActivo||'todas';
  const estado= document.getElementById('filt-fac-estado')?.value||'';
  const q     = (document.getElementById('search-facturas')?.value||'').toLowerCase();

  // Filtrar facturas visibles igual que la tabla
  let lista = FC.filter(f=>{
    const tipo = (f.tipo_factura||'Venta');
    const contra = tipo==='Compra'
      ? (ProvC.find(p=>String(p.id)===String(f.proveedor_id))?.nombre || f.proveedor_id || '')
      : (CC.find(c=>c.cliente_id===f.cliente_id||String(c.id)===String(f.cliente_id))?.nombre || f.cliente_id || '');
    if(tab!=='todas' && tipo.toLowerCase()!==tab.toLowerCase()) return false;
    if(estado && f.estado!==estado) return false;
    if(q && !(f.num_factura||'').toLowerCase().includes(q) && !contra.toLowerCase().includes(q)) return false;
    return true;
  });

  // Totales
  const totBase   = lista.reduce((s,f)=>s+(f.base_imponible||0),0);
  const totIVA    = lista.reduce((s,f)=>{const b=f.base_imponible||0;return s+b*ivaPct(f.iva_pct)/100;},0);
  const totTotal  = totBase+totIVA;
  const totCobrado= lista.reduce((s,f)=>s+(f.importe_cobrado||0),0);
  const totPdte   = totTotal-totCobrado;

  const tipoLabel = tab==='todas'?'Ventas y Compras': tab==='Venta'?'Ingresos':'Gastos';
  const estadoLabel = estado ? ` ¬∑ Estado: ${estado}` : '';
  const hoy = new Date().toLocaleDateString('es-ES');

  const filas = lista.map(f=>{
    const tipo  = f.tipo_factura||'Venta';
    const esC   = tipo==='Compra';
    const contra= esC
      ? (ProvC.find(p=>String(p.id)===String(f.proveedor_id))?.nombre || f.proveedor_id || '‚Äî')
      : (CC.find(c=>c.cliente_id===f.cliente_id||String(c.id)===String(f.cliente_id))?.nombre || f.cliente_id || '‚Äî');
    const base  = f.base_imponible||0;
    const iva   = base*ivaPct(f.iva_pct)/100;
    const total = base+iva;
    const cobrado=f.importe_cobrado||0;
    const pdte  = total-cobrado;
    const badge = esC
      ? `<span style="background:#fdecea;color:#c0392b;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:700">üì• Compra</span>`
      : `<span style="background:#e8f5ee;color:#27ae60;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:700">üì§ Venta</span>`;
    const estColor = f.estado==='Cobrada'||f.estado==='Pagada'?'#27ae60':f.estado==='Vencida'?'#e74c3c':'#e67e22';
    return `<tr style="border-bottom:1px solid #f0f0f0;font-size:11px">
      <td style="padding:5px 6px">${badge}</td>
      <td style="padding:5px 6px;font-weight:700;font-family:monospace">${f.num_factura||'‚Äî'}</td>
      <td style="padding:5px 6px">${fmtD(f.fecha_emision)}</td>
      <td style="padding:5px 6px;color:#888">${fmtD(f.fecha_vencimiento)}</td>
      <td style="padding:5px 6px;font-weight:600">${contra}</td>
      <td style="padding:5px 6px;color:#888">${f.proyecto_id||'‚Äî'}</td>
      <td style="padding:5px 6px;text-align:right">${fmt(base)}</td>
      <td style="padding:5px 6px;text-align:right;color:#888">${f.iva_pct||21}%</td>
      <td style="padding:5px 6px;text-align:right;font-weight:700">${fmt(total)}</td>
      <td style="padding:5px 6px;text-align:right;color:#27ae60">${fmt(cobrado)}</td>
      <td style="padding:5px 6px;text-align:right;color:${pdte>0.01?'#e67e22':'#27ae60'}">${fmt(pdte)}</td>
      <td style="padding:5px 6px"><span style="color:${estColor};font-weight:600;font-size:10px">${f.estado||'‚Äî'}</span></td>
    </tr>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>PAU INTERIORISMO SL - ${tipoLabel}</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:12px;color:#222;margin:0;padding:0}
    @media print{@page{size:A4 landscape;margin:15mm}}
    .header{background:#1a2a3a;color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:flex-start}
    .header h1{margin:0;font-size:16px;font-weight:700}
    .header p{margin:3px 0 0;font-size:11px;opacity:.8}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:0;border-bottom:2px solid #e0e0e0}
    .kpi{padding:12px 16px;border-right:1px solid #e0e0e0}
    .kpi:last-child{border-right:none}
    .kpi-label{font-size:10px;color:#888;text-transform:uppercase;font-weight:600;margin-bottom:4px}
    .kpi-value{font-size:16px;font-weight:700;color:#1a2a3a}
    table{width:100%;border-collapse:collapse}
    thead tr{background:#1a2a3a;color:white}
    thead th{padding:7px 6px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em}
    thead th:nth-child(n+7){text-align:right}
    tbody tr:hover{background:#f8f8f8}
    tfoot tr{background:#f0f4f8;font-weight:700}
    tfoot td{padding:7px 6px;font-size:11px}
    .footer{text-align:center;color:#aaa;font-size:10px;margin-top:16px;padding:12px;border-top:1px solid #eee}
  </style></head><body>
  <div class="header">
    <div>
      <h1>PAU INTERIORISMO S.L. ‚Äî ${tipoLabel}${estadoLabel}</h1>
      <p>CIF B-56909641 ¬∑ C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia)</p>
      <p>Informe generado: ${hoy} ¬∑ ${lista.length} facturas</p>
    </div>
    <div style="text-align:right;font-size:22px;opacity:.3">üßæ</div>
  </div>
  <div class="kpis">
    <div class="kpi"><div class="kpi-label">Base imponible</div><div class="kpi-value">${fmt(totBase)}</div></div>
    <div class="kpi"><div class="kpi-label">IVA</div><div class="kpi-value">${fmt(totIVA)}</div></div>
    <div class="kpi"><div class="kpi-label">Total</div><div class="kpi-value">${fmt(totTotal)}</div></div>
    <div class="kpi"><div class="kpi-label">Cobrado / Pagado</div><div class="kpi-value" style="color:#27ae60">${fmt(totCobrado)}</div></div>
    <div class="kpi"><div class="kpi-label">Pendiente</div><div class="kpi-value" style="color:#e67e22">${fmt(totPdte)}</div></div>
  </div>
  <table>
    <thead><tr>
      <th>Tipo</th><th>N¬∫ Factura</th><th>Fecha</th><th>Vto.</th>
      <th>Cliente / Proveedor</th><th>Proyecto</th>
      <th style="text-align:right">Base imp.</th>
      <th style="text-align:right">IVA%</th>
      <th style="text-align:right">Total</th>
      <th style="text-align:right">Cobrado</th>
      <th style="text-align:right">Pendiente</th>
      <th>Estado</th>
    </tr></thead>
    <tbody>${filas}</tbody>
    <tfoot><tr>
      <td colspan="6" style="padding:7px 6px;font-size:11px">TOTAL ‚Äî ${lista.length} facturas</td>
      <td style="padding:7px 6px;text-align:right">${fmt(totBase)}</td>
      <td></td>
      <td style="padding:7px 6px;text-align:right">${fmt(totTotal)}</td>
      <td style="padding:7px 6px;text-align:right;color:#27ae60">${fmt(totCobrado)}</td>
      <td style="padding:7px 6px;text-align:right;color:#e67e22">${fmt(totPdte)}</td>
      <td></td>
    </tr></tfoot>
  </table>
  <div class="footer">PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ info@pauinteriorismo.com ¬∑ Tel: 961 20 01 87</div>
  </body></html>`;

  // Abrir en ventana nueva y lanzar impresi√≥n/PDF
  const win = window.open('','_blank','width=1100,height=750');
  win.document.write(html);
  win.document.close();
  win.onload = ()=>{ win.focus(); win.print(); };
}

async function loadGerencia(){
  try{
    const [cl,pr,ta,cy,comp,subc,hor,fac]=await Promise.all([
      sbGet('clientes'),sbGet('proyectos'),sbGet('tarifario'),
      sbGet('precios_cype','?select=id'),
      sbGet('compras'),sbGet('subcontratas'),sbGet('horas'),sbGet('facturas')
    ]);
    CC=cl;PC=pr;TC=ta;CoC=comp;ScC=subc;HC=hor;FC=fac;
    document.getElementById('cype-badge').textContent=cy.length;

    // KPIs superiores y resumen: SOLO facturas emitidas y recibidas (base imponible)
    const facVenta  = fac.filter(f=>(f.tipo_factura||'Venta')==='Venta');
    const facCompra = fac.filter(f=>(f.tipo_factura||'Venta')==='Compra');
    const kpiVentas = facVenta.reduce((s,f)=>s+(f.base_imponible||0),0);
    const kpiCostes = facCompra.reduce((s,f)=>s+(f.base_imponible||0),0);
    const kpiBenef  = kpiVentas - kpiCostes;
    const kpiMargen = kpiVentas>0?(kpiBenef/kpiVentas)*100:0;
    const totalIvaRep=facVenta.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const totalIvaComp=facCompra.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);

    // KPIs top ‚Äî solo facturas, base imponible
    document.getElementById('g-ventas').textContent=fmt(kpiVentas);
    document.getElementById('g-costes').textContent=fmt(kpiCostes);
    document.getElementById('g-benef').textContent=fmt(kpiBenef);
    document.getElementById('g-benef').style.color=kpiBenef>=0?'var(--green)':'var(--red)';
    document.getElementById('g-margen').textContent=fmtP(kpiMargen);

    // Resumen econ√≥mico ‚Äî solo facturas, base imponible
    const pv=kpiVentas>0;
    document.getElementById('ge-ventas').textContent=fmt(kpiVentas);
    document.getElementById('ge-iva-rep').textContent=fmt(totalIvaRep);
    document.getElementById('ge-compras').textContent=fmt(kpiCostes);
    document.getElementById('ge-compras-pct').textContent=pv?fmtP(kpiCostes/kpiVentas*100):'‚Äî';
    document.getElementById('ge-subcs').textContent='‚Äî';
    document.getElementById('ge-subcs-pct').textContent='';
    document.getElementById('ge-mo').textContent='‚Äî';
    document.getElementById('ge-mo-pct').textContent='';
    document.getElementById('ge-costes-tot').textContent=fmt(kpiCostes);
    document.getElementById('ge-costes-pct').textContent=pv?fmtP(kpiCostes/kpiVentas*100):'‚Äî';
    document.getElementById('ge-beneficio').textContent=fmt(kpiBenef);
    document.getElementById('ge-benef-pct').textContent=pv?fmtP(kpiMargen):'‚Äî';
    document.getElementById('ge-result-row').className='cuenta-row result'+(kpiBenef<0?' neg':'');

    // Variables auxiliares para tarjetas inferiores (seguimiento pagos/horas/IVA) ‚Äî NO afectan KPIs
    const totalCompras=comp.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalIvaComp2=comp.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const totalSubcs=subc.reduce((s,c)=>s+(c.importe||0),0);
    const totalIvaSub=subc.reduce((s,c)=>s+(c.importe||0)*ivaPct(c.iva_pct)/100,0);
    const totalMO=hor.reduce((s,h)=>s+(h.total||0),0);

    // Proyectos por estado
    const estados=['Nuevo lead','Presupuesto enviado','Aprobado','En ejecuci√≥n','Finalizado','Facturado','Cobrado','Cancelado'];
    const counts={};estados.forEach(e=>counts[e]=0);
    pr.forEach(p=>counts[p.estado]=(counts[p.estado]||0)+1);
    document.getElementById('g-estados').innerHTML=
      Object.entries(counts).filter(([,v])=>v>0).map(([k,v])=>
        `<div class="cuenta-row"><span>${bE(k)} ${k}</span><span style="font-weight:700">${v}</span><span></span></div>`
      ).join('')+`<div class="cuenta-row total"><span>TOTAL PROYECTOS</span><span style="font-weight:700">${pr.length}</span><span></span></div>`;

    // Cobros
    const cobrado=fac.filter(f=>f.estado==='Cobrada').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const totalFactIVA=fac.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    const vencidas=fac.filter(f=>f.estado==='Vencida').reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('gc-facturado').textContent=fmt(totalFactIVA);
    document.getElementById('gc-cobrado').textContent=fmt(cobrado);
    document.getElementById('gc-pendiente').textContent=fmt(totalFactIVA-cobrado);
    document.getElementById('gc-vencidas').textContent=fmt(vencidas);

    // Pagos
    const pagadoProv=comp.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.base_imponible||0),0);
    const pagadoSub=subc.filter(c=>c.estado_pago==='Pagado').reduce((s,c)=>s+(c.importe||0),0);
    document.getElementById('gp-compras').textContent=fmt(totalCompras);
    document.getElementById('gp-pagado-prov').textContent=fmt(pagadoProv);
    document.getElementById('gp-pdte-prov').textContent=fmt(totalCompras-pagadoProv);
    document.getElementById('gp-subcs').textContent=fmt(totalSubcs);
    document.getElementById('gp-pdte-sub').textContent=fmt(totalSubcs-pagadoSub);

    // Horas
    const totH=hor.reduce((s,h)=>s+(h.horas||0),0);
    document.getElementById('gh-horas').textContent=totH.toFixed(1)+'h';
    document.getElementById('gh-coste').textContent=fmt(totalMO);
    document.getElementById('gh-medio').textContent=totH>0?fmt(totalMO/totH).replace('‚Ç¨','')+' ‚Ç¨/h':'‚Äî';

    // IVA
    document.getElementById('gi-rep').textContent=fmt(totalIvaRep);
    document.getElementById('gi-comp').textContent=fmt(totalIvaComp);
    document.getElementById('gi-sub').textContent=fmt(totalIvaSub);
    document.getElementById('gi-neto').textContent=fmt(totalIvaRep-totalIvaComp);

    // Rentabilidad por proyecto ‚Äî SOLO facturas con proyecto asignado
    // Comparaci√≥n expl√≠cita: Compra === 'Compra', cualquier otra cosa = Venta
    const ventasByProy={}, costesByProy={};
    fac.forEach(f=>{
      const pid=(f.proyecto_id||'').trim();
      if(!pid) return; // ignorar facturas sin proyecto
      const base=parseFloat(f.base_imponible)||0;
      if(f.tipo_factura==='Compra'){
        costesByProy[pid]=(costesByProy[pid]||0)+base;
      } else {
        // Venta, o null/undefined -> venta por defecto
        ventasByProy[pid]=(ventasByProy[pid]||0)+base;
      }
    });

    // Construir datos completos y delegar a renderGrentTable
    const GRENT_ACTIVOS=['Aprobado','En ejecuci√≥n','En Ejecuci√≥n','en ejecuci√≥n'];
    window._grentData = pr.map(p=>{
      const pid=(p.proyecto_id||'').trim();
      const v=ventasByProy[pid]||0, c=costesByProy[pid]||0;
      const ben=v-c, mg=v>0?(ben/v)*100:0;
      return { p, pid, v, c, ben, mg };
    });
    window._grentFiltro = 'activos';
    renderGrentTable('activos');


    const s=document.getElementById('conn-status');s.style.background='var(--green-soft)';s.style.color='var(--green)';s.textContent='üü¢ Conectado';
    populateSelects();populateIntCatalog();populateTrabajadores();poblarFiltrosProyecto();poblarFiltrosCliente();poblarClientesComparativa();
  }catch(e){
    console.error(e);
    const s=document.getElementById('conn-status');s.style.background='var(--red-soft)';s.style.color='var(--red)';s.textContent='üî¥ Error';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadClientes(){
  const tb=document.getElementById('clientes-tbody');
  try{
    CC=await sbGet('clientes','?order=created_at.desc');
    document.getElementById('clientes-count').textContent=CC.length+' clientes';
    if(!CC.length){tb.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ü§ù</div><div class="empty-text">Sin clientes</div><button class="btn btn-primary" onclick="openModal('m-cliente')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=CC.map(c=>`<tr data-search="${(c.nombre+c.cif+c.email+c.tipo).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${c.cliente_id||'‚Äî'}</td><td><strong>${c.nombre}</strong></td><td class="td-mono">${c.cif||'‚Äî'}</td><td>${c.telefono||'‚Äî'}</td><td style="color:var(--navy-mid)">${c.email||'‚Äî'}</td><td>${bE(c.tipo)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editCliente('${c.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('clientes','${c.id}','${c.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
  }catch(e){tb.innerHTML=`<tr><td colspan="7" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editCliente(id){const c=CC.find(x=>x.id===id);if(!c)return;document.getElementById('m-cliente-title').textContent='Editar cliente';['c-id','c-nombre','c-cif','c-tel','c-email','c-dir','c-notas'].forEach((f,i)=>{document.getElementById(f).value=[c.id,c.nombre,c.cif,c.telefono,c.email,c.direccion,c.notas][i]||'';});document.getElementById('c-tipo').value=c.tipo||'Particular';document.getElementById('c-pago').value=c.forma_pago||'Transferencia';openModal('m-cliente');}
async function saveCliente(){
  const nombre=document.getElementById('c-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('c-id').value;
  const d={nombre,cif:document.getElementById('c-cif').value,telefono:document.getElementById('c-tel').value,email:document.getElementById('c-email').value,direccion:document.getElementById('c-dir').value,tipo:document.getElementById('c-tipo').value,forma_pago:document.getElementById('c-pago').value,notas:document.getElementById('c-notas').value};
  try{if(id){await sbPatch('clientes',id,d);toast('Cliente actualizado ‚úÖ');}else{d.cliente_id=genId('CLI',CC,'cliente_id');await sbPost('clientes',d);toast('Cliente guardado ‚úÖ');}closeModal('m-cliente');document.getElementById('c-id').value='';loadClientes();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROYECTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProyectos(){
  const tb=document.getElementById('proyectos-tbody');
  try{
    PC=await sbGet('proyectos','?order=created_at.desc');
    document.getElementById('proyectos-count').textContent=PC.length+' proyectos';
    if(!PC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üìÅ</div><div class="empty-text">Sin proyectos</div><button class="btn btn-primary" onclick="openModal('m-proyecto')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PC.map(p=>`<tr data-search="${(p.proyecto_id+p.nombre+p.cliente_id+p.tipo+p.estado).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'‚Äî'}</td><td><strong>${p.nombre}</strong></td><td>${p.cliente_id||'‚Äî'}</td><td>${bE(p.tipo)}</td><td>${bE(p.estado)}</td><td>${p.responsable||'‚Äî'}</td><td>${fmtD(p.fecha_inicio)}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProyecto('${p.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proyectos','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
    poblarFiltrosCliente();
    filtrarProyectosPorCliente();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function editProyecto(id){const p=PC.find(x=>x.id===id);if(!p)return;document.getElementById('m-proyecto-title').textContent='Editar proyecto';document.getElementById('p-id').value=p.id;document.getElementById('p-nombre').value=p.nombre||'';document.getElementById('p-cliente').value=p.cliente_id||'';document.getElementById('p-tipo').value=p.tipo||'Obra nueva';document.getElementById('p-estado').value=p.estado||'Nuevo lead';document.getElementById('p-resp').value=p.responsable||'Jose Asins';document.getElementById('p-fecha').value=p.fecha_inicio||'';document.getElementById('p-dir').value=p.direccion_obra||'';document.getElementById('p-notas').value=p.notas||'';openModal('m-proyecto');}
async function saveProyecto(){
  const nombre=document.getElementById('p-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}
  const id=document.getElementById('p-id').value;
  const d={cliente_id:document.getElementById('p-cliente').value||null,nombre,tipo:document.getElementById('p-tipo').value,estado:document.getElementById('p-estado').value,responsable:document.getElementById('p-resp').value,fecha_inicio:document.getElementById('p-fecha').value||null,direccion_obra:document.getElementById('p-dir').value,notas:document.getElementById('p-notas').value};
  try{if(id){await sbPatch('proyectos',id,d);toast('Proyecto actualizado ‚úÖ');}else{d.proyecto_id=genId('PRY',PC,'proyecto_id');await sbPost('proyectos',d);toast('Proyecto creado ‚úÖ');}closeModal('m-proyecto');document.getElementById('p-id').value='';loadProyectos();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initPresupuesto(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!TC.length)TC=await sbGet('tarifario').catch(()=>[]);
  if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc').catch(()=>[]);
  populateSelects();populateIntCatalog();
}
async function loadPresupuesto(){
  const proy=document.getElementById('pres-proyecto-sel').value;
  const ver=document.getElementById('pres-version-sel').value;
  const tbody=document.getElementById('pres-tbody');
  document.getElementById('btn-comparativa').style.display=proy?'':'none';
  if(!proy){tbody.innerHTML=`<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text-soft)">
      <div style="font-size:32px;margin-bottom:10px">üìÅ</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:6px">Selecciona un cliente y proyecto</div>
      <div style="font-size:12px">El presupuesto aparecer√° aqu√≠ una vez seleccionado el proyecto</div>
    </td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  try{
    PresC=await sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}&order=orden.asc`);
    renderPresupuesto();
  }catch(e){tbody.innerHTML=`<tr><td colspan="11" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function renderPresupuesto(){
  const tbody=document.getElementById('pres-tbody');
  if(!PresC.length){tbody.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="empty-icon">üí∞</div><div class="empty-text">Presupuesto vac√≠o</div><button class="btn btn-ghost" onclick="addCapituloPresupuesto()">Ôºã Cap√≠tulo</button></div></td></tr>`;document.getElementById('pres-resumen').style.display='none';return;}
  let totBase=0,totCI=0,totVenta=0;
  tbody.innerHTML=PresC.map((l,i)=>{
    if(l.es_capitulo)return`<tr style="background:var(--navy);color:#fff"><td colspan="9" style="padding:9px 10px;font-weight:700;font-size:12px">üìÇ ${l.descripcion}</td><td></td><td><button class="btn btn-icon btn-sm" style="background:rgba(255,255,255,.1);border:none;color:#fff" onclick="confirmDelete('presupuesto_lineas','${l.id}','${l.descripcion.replace(/'/g,"\\'")}')">üóë</button></td></tr>`;
    const pv=l.precio_venta||0,ci=l.ci_gg_bi_pct||0,sub=(l.cantidad||0)*pv,subCI=ci>0?sub*(1+ci/100):sub;
    totBase+=(l.cantidad||0)*(l.precio_base||0);totCI+=subCI-sub;totVenta+=subCI;
    return`<tr data-search="${(l.descripcion||'').toLowerCase()}"><td style="color:var(--text-soft);font-size:11px">${i+1}</td><td><strong>${l.descripcion||'‚Äî'}</strong>${l.ref_cype?`<br><span style="font-size:9px;color:var(--text-soft)">${l.ref_cype}</span>`:''}</td><td style="text-align:center">${l.unidad||'‚Äî'}</td><td class="td-mono">${l.cantidad||0}</td><td class="td-mono">${fmt(l.precio_base)}</td><td class="td-mono" style="color:var(--green)">${l.margen_pct>0?fmtP(l.margen_pct):'‚Äî'}</td><td class="td-mono" style="color:var(--amber)">${ci>0?fmtP(ci):'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(pv)}</td><td class="td-mono" style="font-weight:700;color:var(--navy)">${fmt(subCI)}</td><td><span class="badge b-gray">${l.iva_pct||'10%'}</span></td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editLineaPresupuesto('${l.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('presupuesto_lineas','${l.id}','${(l.descripcion||'').replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`;
  }).join('');
  const iva=totVenta*0.10;
  document.getElementById('pres-k-base').textContent=fmt(totBase);document.getElementById('pres-k-ci').textContent=fmt(totCI);document.getElementById('pres-k-total').textContent=fmt(totVenta);document.getElementById('pres-k-iva').textContent=fmt(totVenta+iva);
  document.getElementById('pres-total-lbl').textContent=`TOTAL c/IVA: ${fmt(totVenta+iva)}`;
  document.getElementById('pres-resumen').style.display='block';
}
function calcLineaPres(){const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);const sub=cant*pv;document.getElementById('pl-pventa').value=pv>0?pv.toFixed(2)+' ‚Ç¨':'‚Äî';document.getElementById('pl-subtotal').value=sub>0?sub.toFixed(2)+' ‚Ç¨':'‚Äî';}
function searchCypeLinea(){const q=document.getElementById('pl-cype-search').value.toLowerCase(),res=document.getElementById('pl-cype-results');if(q.length<2){res.style.display='none';return;}const matches=CyCache.filter(c=>c.codigo.toLowerCase().includes(q)||c.descripcion.toLowerCase().includes(q)).slice(0,8);if(!matches.length){res.style.display='none';return;}res.style.display='block';res.innerHTML=matches.map(c=>`<div onclick="selectCype('${c.id}')" style="padding:7px 11px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--blue-light)'" onmouseout="this.style.background=''"><strong style="color:var(--navy-mid)">${c.codigo}</strong> ¬∑ ${c.descripcion} <span style="float:right;color:var(--green);font-weight:700">${fmt(c.precio)}/${c.unidad}</span></div>`).join('');}
function selectCype(id){const c=CyCache.find(x=>x.id===id);if(!c)return;document.getElementById('pl-desc').value=c.descripcion;document.getElementById('pl-precio').value=c.precio;document.getElementById('pl-ud').value=c.unidad||'m¬≤';document.getElementById('pl-cype-search').value=`${c.codigo} ¬∑ ${c.descripcion}`;document.getElementById('pl-cype-search').dataset.cypeRef=c.codigo;document.getElementById('pl-cype-results').style.display='none';calcLineaPres();}
function loadTarifLinea(){const id=document.getElementById('pl-tarif-sel').value;if(!id)return;const t=TC.find(x=>x.id===id);if(!t)return;document.getElementById('pl-desc').value=t.descripcion;document.getElementById('pl-precio').value=t.precio_coste||0;document.getElementById('pl-margen').value=t.margen_pct||0;document.getElementById('pl-ud').value=t.unidad||'Ud';calcLineaPres();}
function addLineaPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('m-pres-title').textContent='Nueva l√≠nea';['pl-id','pl-desc','pl-precio','pl-pventa','pl-subtotal','pl-partida'].forEach(id=>document.getElementById(id).value='');document.getElementById('pl-margen').value='0';document.getElementById('pl-ci').value='0';document.getElementById('pl-cant').value='1';document.getElementById('pl-cype-search').value='';document.getElementById('pl-cype-search').dataset.cypeRef='';document.getElementById('pl-cype-results').style.display='none';document.getElementById('pl-tarif-sel').value='';openModal('m-pres-linea');}
function editLineaPresupuesto(id){const l=PresC.find(x=>x.id===id);if(!l)return;document.getElementById('m-pres-title').textContent='Editar l√≠nea';document.getElementById('pl-id').value=l.id;document.getElementById('pl-desc').value=l.descripcion||'';document.getElementById('pl-precio').value=l.precio_base||0;document.getElementById('pl-margen').value=l.margen_pct||0;document.getElementById('pl-ci').value=l.ci_gg_bi_pct||0;document.getElementById('pl-cant').value=l.cantidad||1;document.getElementById('pl-ud').value=l.unidad||'m¬≤';document.getElementById('pl-iva').value=l.iva_pct||'10%';document.getElementById('pl-partida').value=l.partida||'';document.getElementById('pl-cype-search').value=l.ref_cype||'';document.getElementById('pl-cype-search').dataset.cypeRef=l.ref_cype||'';document.getElementById('pl-cype-results').style.display='none';calcLineaPres();openModal('m-pres-linea');}
async function saveLineaPresupuesto(){
  const desc=document.getElementById('pl-desc').value.trim();if(!desc){toast('La descripci√≥n es obligatoria','error');return;}
  const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;
  const precio=parseFloat(document.getElementById('pl-precio').value)||0,margen=parseFloat(document.getElementById('pl-margen').value)||0,ci=parseFloat(document.getElementById('pl-ci').value)||0,cant=parseFloat(document.getElementById('pl-cant').value)||0;
  let pv=margen>0&&margen<100?precio/(1-margen/100):precio;if(ci>0)pv=pv*(1+ci/100);
  const id=document.getElementById('pl-id').value;
  const d={proyecto_id:proy,version:ver,descripcion:desc,ref_cype:document.getElementById('pl-cype-search').dataset.cypeRef||null,unidad:document.getElementById('pl-ud').value,cantidad:cant,precio_base:precio,margen_pct:margen,ci_gg_bi_pct:ci,precio_venta:parseFloat(pv.toFixed(4)),subtotal:parseFloat((cant*pv).toFixed(4)),iva_pct:document.getElementById('pl-iva').value,partida:document.getElementById('pl-partida').value,es_capitulo:false,orden:PresC.length+1};
  try{if(id){await sbPatch('presupuesto_lineas',id,d);toast('L√≠nea actualizada ‚úÖ');}else{await sbPost('presupuesto_lineas',d);toast('L√≠nea a√±adida ‚úÖ');}closeModal('m-pres-linea');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}
function addCapituloPresupuesto(){const proy=document.getElementById('pres-proyecto-sel').value;if(!proy){toast('Selecciona un proyecto primero','error');return;}document.getElementById('cap-nombre').value='';openModal('m-pres-cap');}
async function saveCapitulo(){const nombre=document.getElementById('cap-nombre').value.trim();if(!nombre){toast('Escribe el nombre','error');return;}const proy=document.getElementById('pres-proyecto-sel').value,ver=document.getElementById('pres-version-sel').value;try{await sbPost('presupuesto_lineas',{proyecto_id:proy,version:ver,descripcion:nombre,es_capitulo:true,orden:PresC.length+1,cantidad:0,precio_base:0,precio_venta:0,subtotal:0});toast('Cap√≠tulo a√±adido ‚úÖ');closeModal('m-pres-cap');loadPresupuesto();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPARATIVA OFERTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcOferta(n){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value || 'pvp';
  let coste=0, venta=0;
  if(modo==='pvp'){
    // PVP cat√°logo = precio que el proveedor nos cobra "sin descuento"
    // Coste para nosotros = PVP * (1 - descuento%) ‚Üí lo que pagamos al proveedor
    // Precio de venta al cliente = PVP (precio cat√°logo sin descuento)
    // Margen = PVP - coste = el descuento que nos da el proveedor = nuestro beneficio
    const pvp = parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
    const dto = parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
    coste = pvp*(1-dto/100);
    venta = pvp; // vendemos al cliente al precio de cat√°logo
  } else {
    // Modo coste: sabemos lo que nos cuesta y aplicamos nuestro margen de venta
    coste = parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
    const mk = parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
    venta = coste>0 && mk<100 ? coste/(1-mk/100) : coste;
  }
  const margenE = venta - coste;
  const margenPct = venta>0 ? (margenE/venta)*100 : 0;
  const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
  set(`o${n}-res-coste`, coste>0 ? fmt(coste) : '‚Äî');
  set(`o${n}-res-venta`, venta>0 ? fmt(venta) : '‚Äî');
  set(`o${n}-res-margen`, margenE>0 ? fmt(margenE) : '‚Äî');
  const pctEl = document.getElementById(`o${n}-res-pct`);
  if(pctEl){
    pctEl.textContent = margenPct>0 ? fmtP(margenPct) : '‚Äî';
    pctEl.style.color = margenPct>=20?'var(--green)':margenPct>=10?'var(--amber)':'var(--red)';
  }
  // Highlight mejor oferta
  destacarMejorOferta();
}

function cambiarModoComparativa(){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value || 'pvp';
  [1,2,3].forEach(n=>{
    const pvpDiv   = document.getElementById(`o${n}-modo-pvp`);
    const costeDiv = document.getElementById(`o${n}-modo-coste`);
    if(pvpDiv)   pvpDiv.style.display   = modo==='pvp'   ? '' : 'none';
    if(costeDiv) costeDiv.style.display = modo==='coste' ? '' : 'none';
    calcOferta(n);
  });
}

function destacarMejorOferta(){
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
  let mejorPrecio=null, menorCoste=Infinity;
  let mejorMargen=null, mayorMargenPct=-Infinity;

  [1,2,3].forEach(n=>{
    let coste=0, venta=0, margenPct=0;
    if(modo==='pvp'){
      const pvp=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      coste=pvp*(1-dto/100);
      venta=pvp;
    } else {
      coste=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      venta=coste>0&&mk<100?coste/(1-mk/100):coste;
    }
    margenPct = venta>0 ? ((venta-coste)/venta)*100 : 0;

    // Reset border
    const col=document.getElementById(`cmp-col-${n}`);
    if(col){ col.style.borderColor='var(--border)'; col.style.borderWidth='1px'; }

    if(coste>0 && coste<menorCoste){ menorCoste=coste; mejorPrecio=n; }
    if(margenPct>0 && margenPct>mayorMargenPct){ mayorMargenPct=margenPct; mejorMargen=n; }
  });

  // Marcar mejor precio (borde verde)
  if(mejorPrecio){
    const col=document.getElementById(`cmp-col-${mejorPrecio}`);
    if(col){ col.style.borderColor='var(--green)'; col.style.borderWidth='2px'; }
  }
  // Marcar mejor margen (borde cobre/naranja) - puede coincidir con mejor precio
  if(mejorMargen && mejorMargen!==mejorPrecio){
    const col=document.getElementById(`cmp-col-${mejorMargen}`);
    if(col){ col.style.borderColor='var(--copper)'; col.style.borderWidth='2px'; }
  }

  // Actualizar info
  const info=document.getElementById('cmp-ganadora-info');
  if(info){
    let txt='';
    if(mejorPrecio) txt+=`<span style="color:var(--green)">üí∞ Oferta ${mejorPrecio} menor coste (${fmt(menorCoste)})</span>`;
    if(mejorMargen && mejorMargen!==mejorPrecio)
      txt+=`<span style="color:var(--copper);margin-left:12px">üìà Oferta ${mejorMargen} mayor margen (${mayorMargenPct.toFixed(1)}%)</span>`;
    else if(mejorMargen && mejorMargen===mejorPrecio)
      txt+=`<span style="color:var(--green);margin-left:8px">¬∑ ${mayorMargenPct.toFixed(1)}% margen</span>`;
    info.innerHTML=txt;
  }

  // Auto-seleccionar mejor precio en el desplegable
  const sel=document.getElementById('cmp-elegida');
  if(sel && mejorPrecio) sel.value=String(mejorPrecio);

  // Actualizar panel resumen
  const resPrecio=document.getElementById('cmp-res-precio');
  const resMargen=document.getElementById('cmp-res-margen');
  const resDiff  =document.getElementById('cmp-res-diff');
  const resPanel =document.getElementById('cmp-resumen');

  // Recoger todos los costes y m√°rgenes para calcular diferencia
  const costes=[]; const margenes=[];
  [1,2,3].forEach(n=>{
    const modo2=document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
    let c=0,v=0;
    if(modo2==='pvp'){
      const pvp2=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto2=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      c=pvp2*(1-dto2/100); v=pvp2;
    } else {
      c=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk2=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      v=c>0&&mk2<100?c/(1-mk2/100):c;
    }
    if(c>0){ costes.push(c); margenes.push(v>0?((v-c)/v)*100:0); }
  });

  if(costes.length>=2){
    const minC=Math.min(...costes), maxC=Math.max(...costes);
    const maxM=Math.max(...margenes);
    if(resPrecio) resPrecio.textContent=`Oferta ${mejorPrecio} ¬∑ ${fmt(minC)}`;
    if(resMargen) resMargen.textContent=`Oferta ${mejorMargen} ¬∑ ${maxM.toFixed(1)}%`;
    if(resDiff)   resDiff.textContent  =`${fmt(maxC-minC)} (${(((maxC-minC)/minC)*100).toFixed(1)}%)`;
    if(resPanel)  resPanel.style.display='grid';
  } else {
    if(resPanel) resPanel.style.display='none';
  }
}

function cascadaClienteModalCmp(){
  const clienteId = document.getElementById('cmp-cliente')?.value;
  const proySel   = document.getElementById('cmp-proyecto');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML='<option value="">Seleccionar‚Ä¶</option>'
    +filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  if(clienteId && filtrados.length===1) proySel.value=filtrados[0].proyecto_id;
}

function poblarClientesModalCmp(){
  const sel=document.getElementById('cmp-cliente');
  if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">Seleccionar‚Ä¶</option>'
    +CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
  if(cur)sel.value=cur;
}

function poblarProveedoresComparativa(){
  [1,2,3].forEach(n=>{
    const sel=document.getElementById(`o${n}-prov`);
    if(!sel)return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Seleccionar‚Ä¶</option>'
      +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}</option>`).join('');
    if(cur)sel.value=cur;
  });
}
async function initComparativa(){
  if(!PC.length)PC=await sbGet('proyectos').catch(()=>[]);
  if(!CC.length)CC=await sbGet('clientes').catch(()=>[]);
  populateSelects();
  poblarClientesComparativa();
}
async function loadComparativa(){
  const proy=document.getElementById('comp-proyecto-sel').value;
  const el=document.getElementById('comp-list');
  if(!proy){el.innerHTML='<div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Selecciona un proyecto</div></div>';return;}
  try{
    CmpC=await sbGet('comparativa_ofertas',`?proyecto_id=eq.${proy}&order=created_at.desc`);
    if(!CmpC.length){el.innerHTML=`<div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Sin comparativas para este proyecto</div><button class="btn btn-primary" onclick="openModal('m-comparativa')">Ôºã Nueva comparativa</button></div>`;return;}
    el.innerHTML=CmpC.map(c=>{
      const ofertas=[1,2,3].map(n=>{const prov=c[`o${n}_proveedor`],final=c[`o${n}_precio_final`];return prov?`<div class="oferta-col${c.oferta_elegida==n?' ganadora':''}"><div class="oferta-title">OFERTA ${n}</div><div style="font-weight:700;margin-bottom:4px">${prov}</div><div style="font-size:12px;color:var(--text-soft)">PVP: ${fmt(c[`o${n}_pvp`])} ¬∑ Dto: ${c[`o${n}_dto`]||0}% ¬∑ Mk: ${c[`o${n}_markup`]||0}%</div><div style="font-size:14px;font-weight:700;margin-top:6px;color:var(--navy)">${fmt(final)}</div>${c[`o${n}_notas`]?`<div style="font-size:11px;color:var(--text-soft);margin-top:4px">${c[`o${n}_notas`]}</div>`:''}</div>`:'<div class="oferta-col" style="opacity:.3"><div class="oferta-title">OFERTA '+n+'</div><div style="font-size:12px;color:var(--text-soft)">Sin datos</div></div>';}).join('');
      return`<div class="card"><div class="card-header"><div class="card-title">‚öñÔ∏è ${c.trabajo}</div><button class="btn btn-danger btn-sm" onclick="confirmDelete('comparativa_ofertas','${c.id}','${c.trabajo.replace(/'/g,"\\'")}')">üóë</button></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">${ofertas}</div></div></div>`;
    }).join('');
  }catch(e){el.innerHTML=`<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`;}
}
async function saveComparativa(){
  const proy=document.getElementById('cmp-proyecto').value,trabajo=document.getElementById('cmp-trabajo').value.trim();
  if(!proy||!trabajo){toast('Proyecto y trabajo son obligatorios','error');return;}
  const d={proyecto_id:proy,trabajo};
  const modo = document.querySelector('input[name="cmp-modo"]:checked')?.value||'pvp';
  d.modo_calculo = modo;
  [1,2,3].forEach(n=>{
    d[`o${n}_proveedor`] = document.getElementById(`o${n}-prov`)?.value||'';
    d[`o${n}_notas`]     = document.getElementById(`o${n}-notas`)?.value||'';
    if(modo==='pvp'){
      const pvp=parseFloat(document.getElementById(`o${n}-pvp`)?.value)||0;
      const dto=parseFloat(document.getElementById(`o${n}-dto`)?.value)||0;
      d[`o${n}_pvp`]=pvp; d[`o${n}_dto`]=dto; d[`o${n}_markup`]=0;
      d[`o${n}_coste`]=pvp*(1-dto/100);
      d[`o${n}_precio_final`]=pvp; // precio de venta al cliente = PVP cat√°logo
    } else {
      const coste=parseFloat(document.getElementById(`o${n}-costebase`)?.value)||0;
      const mk=parseFloat(document.getElementById(`o${n}-mk`)?.value)||0;
      d[`o${n}_pvp`]=0; d[`o${n}_dto`]=0; d[`o${n}_markup`]=mk;
      d[`o${n}_coste`]=coste;
      d[`o${n}_precio_final`]=coste>0?coste/(1-mk/100):0;
    }
  });
  d.oferta_elegida=parseInt(document.getElementById('cmp-elegida').value)||1;
  try{await sbPost('comparativa_ofertas',d);toast('Comparativa guardada ‚úÖ');closeModal('m-comparativa');loadComparativa();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TARIFARIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadTarifario(){
  TC = await sbGet('tarifario','?order=categoria,familia,descripcion').catch(()=>[]);
  document.getElementById('tarif-total-badge').textContent = TC.length;
  renderTarifTree();
  renderTarifPanel(TC, '', '');
}

// ‚îÄ‚îÄ √ÅRBOL LATERAL ‚îÄ‚îÄ
function renderTarifTree(){
  const body = document.getElementById('tarif-tree-body');
  if(!body) return;

  // Agrupar categor√≠as ‚Üí familias
  const tree = {};
  TC.forEach(t => {
    const cat = t.categoria || 'Sin categor√≠a';
    const fam = t.familia   || 'Sin familia';
    if(!tree[cat]) tree[cat] = new Set();
    tree[cat].add(fam);
  });

  const catIcons = {
    'Mobiliario':'üõã','Sofas y tapizados':'üõã','Dormitorios':'üõè','Colchones':'üõè',
    'Cocina':'üç≥','Banos':'üöø','Sanitarios':'üöø','Griferias':'üö∞',
    'Pavimentos':'üè†','Revestimientos':'üè†','Carpinteria':'üö™','Puertas y ventanas':'üö™',
    'Iluminacion':'üí°','Climatizacion':'‚ùÑÔ∏è','Calefaccion':'üî•','Instalaciones':'‚öôÔ∏è',
    'Electricidad':'‚ö°','Fontaneria':'üîß','Pintura':'üé®','Varios':'üì¶','Otros':'üì¶',
    'Sin categor√≠a':'üìã'
  };

  let html = '<div style="padding:6px 0">';
  // "Todo" link
  html += '<div class="tarif-tree-all tarif-tree-item" onclick="selTarifCat(\'\')" style="padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:13px;color:var(--navy);font-weight:700;border-bottom:1px solid var(--border)">'
        + 'üìã Todo el tarifario</div>';

  Object.keys(tree).sort().forEach(cat => {
    const fams = [...tree[cat]].sort();
    const count = TC.filter(t=>(t.categoria||'Sin categor√≠a')===cat).length;
    const icon = catIcons[cat] || 'üì¶';
    html += `<div class="tarif-cat-block" data-cat="${cat}">`;
    html += `<div class="tarif-tree-item" onclick="toggleTarifCat('${cat}')" style="padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:var(--navy-mid);border-bottom:1px solid var(--border);user-select:none">`
          + `<span id="tarif-arrow-${CSS.escape(cat)}" style="font-size:10px;transition:transform .2s">‚ñ∂</span>`
          + `<span>${icon} ${cat}</span>`
          + `<span style="margin-left:auto;background:var(--border);border-radius:8px;padding:1px 6px;font-size:10px;font-weight:600">${count}</span>`
          + `</div>`;
    html += `<div id="tarif-fams-${CSS.escape(cat)}" style="display:none">`;
    fams.forEach(fam => {
      const fcount = TC.filter(t=>(t.categoria||'Sin categor√≠a')===cat && (t.familia||'Sin familia')===fam).length;
      html += `<div class="tarif-tree-item tarif-fam-item" onclick="selTarifFam('${cat}','${fam.replace(/'/g,"\\'")}')"`
            + ` style="padding:7px 12px 7px 28px;cursor:pointer;font-size:12px;color:var(--text-soft);border-bottom:1px solid #f5f5f5;display:flex;align-items:center;gap:6px">`
            + `<span style="color:var(--copper)">‚Ä∫</span> ${fam}`
            + `<span style="margin-left:auto;color:var(--text-soft);font-size:10px">${fcount}</span>`
            + `</div>`;
    });
    html += `</div></div>`;
  });
  html += '</div>';
  body.innerHTML = html;
}

function toggleTarifCat(cat){
  const famsEl = document.getElementById('tarif-fams-' + CSS.escape(cat));
  const arrow  = document.getElementById('tarif-arrow-' + CSS.escape(cat));
  if(!famsEl) return;
  const open = famsEl.style.display !== 'none';
  famsEl.style.display = open ? 'none' : 'block';
  if(arrow) arrow.style.transform = open ? '' : 'rotate(90deg)';
  if(!open) selTarifCat(cat);
}

function selTarifCat(cat){
  // Highlight active
  document.querySelectorAll('.tarif-tree-item').forEach(el => el.style.background = '');
  const items = cat ? document.querySelectorAll(`[data-cat="${cat}"] .tarif-tree-item:first-child`) : document.querySelectorAll('.tarif-tree-all');
  items.forEach(el => el.style.background = '#eef3fb');

  const filtered = cat ? TC.filter(t=>(t.categoria||'Sin categor√≠a')===cat) : TC;
  renderTarifPanel(filtered, cat, '');
}

function selTarifFam(cat, fam){
  document.querySelectorAll('.tarif-fam-item').forEach(el => el.style.background = '');
  // highlight
  const filtered = TC.filter(t=>(t.categoria||'Sin categor√≠a')===cat && (t.familia||'Sin familia')===fam);
  renderTarifPanel(filtered, cat, fam);
}

// ‚îÄ‚îÄ PANEL PRINCIPAL ‚îÄ‚îÄ
function renderTarifPanel(items, cat, fam){
  const panel = document.getElementById('tarif-main-panel');
  const crumb = document.getElementById('tarif-breadcrumb');
  if(!panel) return;

  // breadcrumb
  let bc = 'üìã <span onclick="selTarifCat(\'\')" style="cursor:pointer;color:var(--navy)">Tarifario</span>';
  if(cat) bc += ` ‚Ä∫ <span onclick="selTarifCat('${cat}')" style="cursor:pointer;color:var(--navy)">${cat}</span>`;
  if(fam) bc += ` ‚Ä∫ <strong style="color:var(--copper)">${fam}</strong>`;
  if(crumb) crumb.innerHTML = bc + ` &mdash; <span id="tarifario-count" style="color:var(--navy);font-weight:700">${items.length} art√≠culo${items.length!==1?'s':''}</span>`;

  if(!items.length){
    panel.innerHTML = '<div class="card"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">No hay art√≠culos en esta secci√≥n</div><button class="btn btn-primary" onclick="abrirNuevoTarifario()">Ôºã Nuevo art√≠culo</button></div></div>';
    return;
  }

  // Si no se filtr√≥ por familia, agrupar por familias
  if(!fam){
    const famGroups = {};
    items.forEach(t => {
      const f = t.familia || 'Sin familia';
      if(!famGroups[f]) famGroups[f] = [];
      famGroups[f].push(t);
    });
    let html = '';
    Object.keys(famGroups).sort().forEach(f => {
      const grp = famGroups[f];
      html += `<div class="card" style="margin-bottom:10px">`;
      html += `<div class="card-header" style="cursor:pointer;user-select:none" onclick="toggleTarifGroup('tg-${CSS.escape(f)}')">`
            + `<div class="card-title" style="display:flex;align-items:center;gap:8px">`
            + `<span id="tg-arrow-${CSS.escape(f)}" style="font-size:11px;transition:transform .2s">‚ñº</span>`
            + `üì¶ ${f} <span style="font-size:11px;color:var(--text-soft);font-weight:400">${grp.length} art√≠culo${grp.length!==1?'s':''}</span>`
            + `</div>`
            + `<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();selTarifFam('${cat||grp[0].categoria||''}','${f.replace(/'/g,"\\'")}')">Ver todos ‚Ä∫</button>`
            + `</div>`;
      html += `<div id="tg-${CSS.escape(f)}" class="table-wrap"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Ud.</th><th>Coste</th><th>Margen</th><th>P.Venta</th><th>Marca</th><th></th></tr></thead><tbody>`;
      grp.forEach(t => { html += buildTarifRow(t); });
      html += `</tbody></table></div></div>`;
    });
    panel.innerHTML = html;
  } else {
    // Vista plana dentro de una familia
    panel.innerHTML = `<div class="card"><div class="table-wrap"><table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Ud.</th><th>Coste</th><th>Margen</th><th>P.Venta</th><th>Marca</th><th></th></tr></thead><tbody>`
      + items.map(buildTarifRow).join('')
      + `</tbody></table></div></div>`;
  }
}

function buildTarifRow(t){
  return `<tr data-search="${(t.codigo+' '+t.descripcion+' '+(t.familia||'')+' '+(t.marca||'')).toLowerCase()}">`
    + `<td class="td-mono" style="color:var(--navy-mid);font-weight:700;font-size:11px">${t.codigo}</td>`
    + `<td>${t.descripcion}</td>`
    + `<td style="text-align:center">${t.unidad||'Ud'}</td>`
    + `<td class="td-mono">${fmt(t.precio_coste)}</td>`
    + `<td class="td-mono" style="color:var(--green)">${fmtP(t.margen_pct)}</td>`
    + `<td class="td-mono" style="font-weight:700">${fmt(t.precio_venta)}</td>`
    + `<td style="color:var(--text-soft);font-size:11px">${t.marca||'‚Äî'}</td>`
    + `<td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editTarifario('${t.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('tarifario','${t.id}','${(t.descripcion||'').replace(/'/g,"\\'").replace(/"/g,'\\"')}')">üóë</button></div></td>`
    + `</tr>`;
}

function toggleTarifGroup(id){
  const el = document.getElementById(id);
  const arrow = document.getElementById('tg-arrow-' + id.replace('tg-',''));
  if(!el) return;
  const open = el.style.display !== 'none';
  el.style.display = open ? 'none' : '';
  if(arrow) arrow.style.transform = open ? 'rotate(-90deg)' : '';
}

function buscarTarifario(){
  const q = (document.getElementById('search-tarifario')?.value||'').toLowerCase().trim();
  if(!q){ loadTarifario(); return; }
  const results = TC.filter(t => (t.codigo+' '+t.descripcion+' '+(t.familia||'')+' '+(t.categoria||'')+' '+(t.marca||'')).toLowerCase().includes(q));
  renderTarifPanel(results, '', '');
  const crumb = document.getElementById('tarif-breadcrumb');
  if(crumb) crumb.innerHTML = `üîç B√∫squeda: <strong>"${q}"</strong> &mdash; <span style="color:var(--navy);font-weight:700">${results.length} resultado${results.length!==1?'s':''}</span>`;
}

function filtrarTarifario(){ buscarTarifario(); }

function abrirNuevoTarifario(){
  document.getElementById('m-tarif-title').textContent = 'Ôºã Nuevo art√≠culo';
  ['t-id','t-codigo','t-desc','t-marca','t-notas','t-familia'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('t-unidad').value = 'Ud';
  document.getElementById('t-coste').value = '0';
  document.getElementById('t-margen').value = '30';
  document.getElementById('t-cat').value = 'Mobiliario';
  document.getElementById('t-pventa').value = '';
  actualizarFamiliasModal();
  openModal('m-tarifario');
}

function actualizarFamiliasModal(){
  const cat = document.getElementById('t-cat')?.value || '';
  const sel = document.getElementById('t-familia-sel');
  if(!sel) return;
  const fams = [...new Set(TC.filter(t=>(t.categoria||'')===cat && t.familia).map(t=>t.familia))].sort();
  sel.innerHTML = '<option value="">‚Äî Nueva familia ‚Äî</option>' + fams.map(f=>`<option value="${f}">${f}</option>`).join('');
  document.getElementById('t-familia').value = '';
}

function selFamiliaModal(){
  const val = document.getElementById('t-familia-sel')?.value || '';
  if(val) document.getElementById('t-familia').value = val;
}

function editTarifario(id){
  const t=TC.find(x=>x.id===id);if(!t)return;
  document.getElementById('m-tarif-title').textContent='‚úèÔ∏è Editar art√≠culo';
  document.getElementById('t-id').value=t.id;
  document.getElementById('t-codigo').value=t.codigo||'';
  document.getElementById('t-desc').value=t.descripcion||'';
  document.getElementById('t-unidad').value=t.unidad||'Ud';
  document.getElementById('t-coste').value=t.precio_coste||0;
  document.getElementById('t-margen').value=t.margen_pct||30;
  document.getElementById('t-cat').value=t.categoria||'Mobiliario';
  document.getElementById('t-marca').value=t.marca||'';
  document.getElementById('t-notas').value=t.notas||'';
  document.getElementById('t-familia').value=t.familia||'';
  actualizarFamiliasModal();
  document.getElementById('t-familia').value=t.familia||'';
  calcPrecioVenta();
  openModal('m-tarifario');
}

async function saveTarifario(){
  const codigo=document.getElementById('t-codigo').value.trim(),desc=document.getElementById('t-desc').value.trim();
  if(!codigo||!desc){toast('C√≥digo y descripci√≥n obligatorios','error');return;}
  const id=document.getElementById('t-id').value;
  const costeV=parseFloat(document.getElementById('t-coste').value)||0,margenV=parseFloat(document.getElementById('t-margen').value)||30;
  const pvV=margenV<100?parseFloat((costeV/(1-margenV/100)).toFixed(4)):costeV;
  const familiaV=(document.getElementById('t-familia').value||'').trim();
  const d={codigo,descripcion:desc,unidad:document.getElementById('t-unidad').value,precio_coste:costeV,margen_pct:margenV,categoria:document.getElementById('t-cat').value,familia:familiaV||null,marca:document.getElementById('t-marca').value,notas:document.getElementById('t-notas').value};
  try{
    if(id){await sbPatch('tarifario',id,d);toast('Art√≠culo actualizado ‚úÖ');}
    else{await sbPost('tarifario',d);toast('Art√≠culo a√±adido ‚úÖ');}
    closeModal('m-tarifario');document.getElementById('t-id').value='';loadTarifario();
  }catch(e){toast('Error: '+e.message,'error');}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CYPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCype(){
  const tb=document.getElementById('cype-tbody');
  try{
    if(!CyCache.length)CyCache=await sbGet('precios_cype','?order=codigo.asc');
    if(!CyCache.length){tb.innerHTML=`<tr><td colspan="5"><div class="empty"><div class="empty-icon">üìê</div><div class="empty-text">Ejecuta el SQL de datos reales</div></div></td></tr>`;return;}
    const caps=[...new Set(CyCache.map(c=>c.capitulo).filter(Boolean))].sort();
    const sel=document.getElementById('filter-cype-cap');sel.innerHTML='<option value="">Todos los cap√≠tulos</option>'+caps.map(c=>`<option>${c}</option>`).join('');
    tb.innerHTML=CyCache.map(c=>`<tr data-search="${(c.codigo+c.descripcion+c.capitulo).toLowerCase()}" data-cap="${c.capitulo||''}"><td class="td-mono" style="color:var(--navy-mid);font-weight:700">${c.codigo}</td><td>${c.descripcion}</td><td style="text-align:center">${c.unidad||'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(c.precio)}</td><td><span class="badge b-gray" style="font-size:9px">${c.capitulo||'‚Äî'}</span></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="5" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function filterCype(){const q=document.getElementById('search-cype').value.toLowerCase(),cap=document.getElementById('filter-cype-cap').value;document.querySelectorAll('#cype-tbody tr[data-search]').forEach(r=>{r.style.display=(r.dataset.search.includes(q)&&(!cap||r.dataset.cap===cap))?'':'none';});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERIORISMO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadInteriorismo(){
  const tb=document.getElementById('interiorismo-tbody');
  try{
    IntC=await sbGet('interiorismo_lineas','?order=created_at.desc');
    document.getElementById('interiorismo-count').textContent=IntC.length+' l√≠neas';
    if(!IntC.length){tb.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">üõã</div><div class="empty-text">Sin propuestas</div><button class="btn btn-copper" onclick="openModal('m-interiorismo')">Ôºã A√±adir</button></div></td></tr>`;return;}
    tb.innerHTML=IntC.map(i=>`<tr data-search="${(i.proyecto_id+i.estancia+i.descripcion+i.marca).toLowerCase()}"><td class="td-mono" style="color:var(--text-soft)">${i.proyecto_id||'‚Äî'}</td><td>${i.estancia?`<span class="badge b-gray">${i.estancia}</span>`:'‚Äî'}</td><td class="td-mono">${i.ref_catalogo||'‚Äî'}</td><td>${i.descripcion||'‚Äî'}</td><td>${i.cantidad||1}</td><td class="td-mono" style="font-weight:700">${fmt(i.pvp_neto)}</td><td class="td-mono" style="color:var(--green)">${i.coste_neto&&i.pvp_neto?fmtP((i.pvp_neto-i.coste_neto)/i.pvp_neto*100):'‚Äî'}</td><td>${bE(i.estado_propuesta)}</td><td>${bE(i.estado_pedido)}</td><td style="display:flex;gap:3px"><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="editInteriorismo('${i.id}')">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('interiorismo_lineas','${i.id}','${(i.descripcion||'art√≠culo').replace(/'/g,"\\'")}')">üóë</button></td></tr>`).join('');
  filtrarInteriorismo();
  }catch(e){tb.innerHTML=`<tr><td colspan="10" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function loadTarifarioItem(){const ref=document.getElementById('i-ref').value;if(!ref)return;const item=TC.find(t=>t.id===ref);if(!item)return;document.getElementById('i-desc').value=item.descripcion||'';document.getElementById('i-marca').value=item.marca||'';document.getElementById('i-pvp').value=item.precio_venta||0;document.getElementById('i-coste').value=item.precio_coste||0;calcIntPvp();}
function calcIntPvp(){const cant=parseFloat(document.getElementById('i-cant').value)||1,pvp=parseFloat(document.getElementById('i-pvp').value)||0,dto=parseFloat(document.getElementById('i-dto').value)||0;const neto=cant*pvp*(1-dto/100);document.getElementById('i-neto').value=neto>0?neto.toFixed(2)+' ‚Ç¨':'‚Äî';}
async function saveInteriorismo(){
  const proy=document.getElementById('i-proyecto').value;if(!proy){toast('Selecciona un proyecto','error');return;}
  const d={proyecto_id:proy,estancia:document.getElementById('i-estancia').value,ref_catalogo:document.getElementById('i-ref').value||null,descripcion:document.getElementById('i-desc').value,marca:document.getElementById('i-marca').value,acabado:document.getElementById('i-acabado').value,unidad:'Ud',cantidad:parseFloat(document.getElementById('i-cant').value)||1,pvp_catalogo:parseFloat(document.getElementById('i-pvp').value)||0,dto_cliente_pct:parseFloat(document.getElementById('i-dto').value)||0,coste_neto:parseFloat(document.getElementById('i-coste').value)||0,iva_pct:document.getElementById('i-iva').value,estado_propuesta:document.getElementById('i-eprop').value,estado_cobro:'Pendiente',estado_pedido:document.getElementById('i-eped').value,fecha_entrega:document.getElementById('i-fentrega').value||null,notas:document.getElementById('i-notas').value};
  try{
    const id=document.getElementById('i-id')?.value;
    if(id){
      await sb('interiorismo_lineas','PATCH',d,null,`?id=eq.${id}`);
      toast('Art√≠culo actualizado ‚úÖ');
    } else {
      await sbPost('interiorismo_lineas',d);
      toast('Art√≠culo a√±adido ‚úÖ');
    }
    document.getElementById('i-id').value='';
    document.querySelector('#m-interiorismo .modal-title').textContent='üõã A√±adir art√≠culo';
    closeModal('m-interiorismo'); loadInteriorismo();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPRAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCompras(){
  const tb=document.getElementById('compras-tbody');
  try{
    CoC=await sbGet('compras','?order=fecha.desc');
    document.getElementById('compras-count').textContent=CoC.length+' registros';
    if(!CoC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üõí</div><div class="empty-text">Sin compras</div><button class="btn btn-primary" onclick="openModal('m-compra')">Ôºã Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=CoC.map(c=>{const tot=c.base_imponible*(1+ivaPct(c.iva_pct)/100);return`<tr data-search="${(c.proyecto_id+c.proveedor_id+c.concepto).toLowerCase()}"><td>${fmtD(c.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${c.proyecto_id||'‚Äî'}</td><td>${c.proveedor_id||'‚Äî'}</td><td>${c.concepto||'‚Äî'}</td><td class="td-mono">${fmt(c.base_imponible)}</td><td class="td-mono">${c.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(c.estado_pago)}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" onclick="editCompra('${c.id}')" style="font-size:11px">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('compras','${c.id}','${(c.concepto||'compra').replace(/'/g,"\\'")}')">üóë</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('compras');
}
async function saveCompra(){
  const id=document.getElementById('co-id')?.value;
  const d={fecha:document.getElementById('co-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('co-proyecto').value||null,proveedor_id:document.getElementById('co-prov').value||null,concepto:document.getElementById('co-concepto').value,base_imponible:parseFloat(document.getElementById('co-base').value)||0,iva_pct:document.getElementById('co-iva').value,estado_pago:document.getElementById('co-estado').value,fecha_vencimiento:document.getElementById('co-vto').value||null,notas:document.getElementById('co-notas').value};
  try{
    if(id){await sb('compras','PATCH',d,null,`?id=eq.${id}`);toast('Compra actualizada ‚úÖ');}
    else{await sbPost('compras',d);toast('Compra registrada ‚úÖ');}
    document.getElementById('co-id').value='';
    document.querySelector('#m-compra .modal-title').textContent='üõí Nueva compra';
    closeModal('m-compra');loadCompras();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBCONTRATAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSubcontratas(){
  const tb=document.getElementById('subcontratas-tbody');
  try{
    ScC=await sbGet('subcontratas','?order=fecha.desc');
    document.getElementById('subcontratas-count').textContent=ScC.length+' registros';
    if(!ScC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üë∑</div><div class="empty-text">Sin subcontratas</div><button class="btn btn-primary" onclick="openModal('m-subcontrata')">Ôºã Nueva</button></div></td></tr>`;return;}
    tb.innerHTML=ScC.map(s=>{const tot=s.importe*(1+ivaPct(s.iva_pct)/100);return`<tr data-search="${(s.proyecto_id+s.proveedor_id+s.trabajo).toLowerCase()}"><td>${fmtD(s.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${s.proyecto_id||'‚Äî'}</td><td>${s.proveedor_id||'‚Äî'}</td><td>${s.trabajo||'‚Äî'}</td><td class="td-mono">${fmt(s.importe)}</td><td class="td-mono">${s.iva_pct}</td><td class="td-mono" style="font-weight:700">${fmt(tot)}</td><td>${bE(s.estado_pago)}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-icon btn-sm" onclick="editSubcontrata('${s.id}')" style="font-size:11px">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('subcontratas','${s.id}','${(s.trabajo||'subcontrata').replace(/'/g,"\\'")}')">üóë</button></td></tr>`;}).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('subcontratas');
}
async function saveSubcontrata(){
  const id=document.getElementById('sc-id')?.value;
  const d={fecha:document.getElementById('sc-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('sc-proyecto').value||null,proveedor_id:document.getElementById('sc-prov').value||null,trabajo:document.getElementById('sc-trabajo').value,importe:parseFloat(document.getElementById('sc-importe').value)||0,iva_pct:document.getElementById('sc-iva').value,estado_pago:document.getElementById('sc-estado').value,fecha_vencimiento:document.getElementById('sc-vto').value||null};
  try{
    if(id){await sb('subcontratas','PATCH',d,null,`?id=eq.${id}`);toast('Subcontrata actualizada ‚úÖ');}
    else{await sbPost('subcontratas',d);toast('Subcontrata registrada ‚úÖ');}
    document.getElementById('sc-id').value='';
    document.querySelector('#m-subcontrata .modal-title').textContent='üë∑ Nueva subcontrata';
    closeModal('m-subcontrata');loadSubcontratas();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HORAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadHoras(){
  const tb=document.getElementById('horas-tbody');
  try{
    HC=await sbGet('horas','?order=fecha.desc');
    document.getElementById('horas-count').textContent=HC.length+' registros';
    if(!HC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">‚è±</div><div class="empty-text">Sin horas registradas</div><button class="btn btn-primary" onclick="openModal('m-hora')">Ôºã Registrar</button></div></td></tr>`;return;}
    tb.innerHTML=HC.map(h=>`<tr data-search="${(h.proyecto_id+h.trabajador+h.descripcion).toLowerCase()}"><td>${fmtD(h.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${h.proyecto_id||'‚Äî'}</td><td><strong>${h.trabajador||'‚Äî'}</strong></td><td class="td-mono">${h.horas}h</td><td class="td-mono">${fmt(h.coste_hora)}</td><td class="td-mono" style="font-weight:700">${fmt(h.total)}</td><td style="color:var(--text-soft)">${h.descripcion||'‚Äî'}</td><td><button class="btn btn-ghost btn-sm" style="margin-right:4px;font-size:11px" onclick="editHora('${h.id}')">Editar</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('horas','${h.id}','horas ${h.trabajador}')">üóë</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('horas');
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOC. PEDIDO - INTEGRACI√ìN CON REGISTRO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Navega a Doc.Pedido y carga el pedido con ese ID
async function abrirDocPedido(pedidoId){
  await navTo('pedido_doc');
  const sel = document.getElementById('pd-pedido-sel');
  if(sel){ sel.value = pedidoId; cargarPedidoEnDoc(); }
}

// Nuevo pedido en blanco
function nuevoPedidoDoc(){
  window.pdLineas = Array.from({length:20}, ()=>({cant:'',desc:''}));
  window.pdPedidoId = null;
  ['pd-num-input','pd-prov-input','pd-prov-tel-input','pd-proyecto-input','pd-obs-input'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const today = new Date().toISOString().split('T')[0];
  const f=document.getElementById('pd-fecha-input'); if(f) f.value=today;
  const n=document.getElementById('pd-nota-input');
  if(n) n.value='SERVIR LO ANTES POSIBLE.\n\nDIRECCI√ìN DE ENTREGA AV. DIPUTACI√ìN N¬∫ 24 - ALCASSER 46290 (VALENCIA)\nHORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.\nTELFN. CONTACTO 677 970 074 ATENCI√ìN DE JOSE.';
  const sel=document.getElementById('pd-pedido-sel'); if(sel) sel.value='';
  renderPedidoLineas();
}

// Carga el pedido seleccionado en el documento
function cargarPedidoEnDoc(){
  const sel = document.getElementById('pd-pedido-sel');
  if(!sel||!sel.value){ nuevoPedidoDoc(); return; }
  const p = PedC.find(x=>String(x.id)===String(sel.value));
  if(!p) return;
  window.pdPedidoId = p.id;
  const setVal=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v||''; };
  const setText=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v||''; };
  setVal('pd-num-input', p.num_pedido);
  setVal('pd-fecha-input', p.fecha);
  setVal('pd-prov-input', p.proveedor);
  setVal('pd-proyecto-input', p.proyecto_id);
  setVal('pd-obs-input', p.observaciones);
  setVal('pd-ref-doc-input', p.referencia);
  // Datos del cliente en el documento
  const cli = CC.find(c=>String(c.cliente_id)===String(p.cliente_id)||String(c.id)===String(p.cliente_id)||c.nombre===p.cliente_nombre);
  if(cli){
    setVal('pd-cliente-nombre-input', cli.nombre||'');
    setVal('pd-cliente-dir-input', cli.direccion||'');
    setVal('pd-cliente-tel-input', cli.telefono||'');
    setVal('pd-cliente-nif-input', cli.cif||'');
    document.getElementById('pd-cliente-block')?.style && (document.getElementById('pd-cliente-block').style.display='');
  } else {
    document.getElementById('pd-cliente-block')?.style && (document.getElementById('pd-cliente-block').style.display='none');
  }
  // L√≠neas
  if(p.lineas && Array.isArray(p.lineas) && p.lineas.length){
    window.pdLineas = p.lineas;
    while(window.pdLineas.length < 20) window.pdLineas.push({cant:'',desc:''});
  } else {
    window.pdLineas = Array.from({length:20}, ()=>({cant:'',desc:''}));
  }
  renderPedidoLineas();
}

// Guarda el documento en la tabla pedidos
async function guardarDocPedido(){
  const getVal = id => { const el=document.getElementById(id); return el?el.value:''; };
  const lineasLimpias = (window.pdLineas||[]).filter(l=>l.cant||l.desc);
  const d = {
    num_pedido:   getVal('pd-num-input'),
    fecha:        getVal('pd-fecha-input') || new Date().toISOString().split('T')[0],
    proveedor:    getVal('pd-prov-input'),
    // prov_tel removed from UI
    proyecto_id:  getVal('pd-proyecto-input') || null,
    observaciones:getVal('pd-obs-input'),
    referencia:   getVal('pd-ref-doc-input'),
    lineas:       lineasLimpias,
    estado:       'Pendiente',
    tipo:         'Material',
    importe:      0,
  };
  try{
    if(window.pdPedidoId){
      // UPDATE
      await sb('pedidos','PATCH',d,null,`?id=eq.${window.pdPedidoId}`);
      toast('Pedido actualizado ‚úÖ');
    } else {
      // INSERT
      const res = await fetch(`${SB_URL}/rest/v1/pedidos`,{
        method:'POST',
        headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'},
        body:JSON.stringify(d)
      });
      if(!res.ok) throw new Error(await res.text());
      const created = await res.json();
      if(created&&created[0]) window.pdPedidoId = created[0].id;
      toast('Pedido creado y guardado ‚úÖ');
    }
    // Refresh PedC cache and selector
    PedC = await sbGet('pedidos','?order=fecha.desc').catch(()=>PedC);
    poblarSelectorDocPedido();
    if(window.pdPedidoId){
      const sel=document.getElementById('pd-pedido-sel');
      if(sel) sel.value = window.pdPedidoId;
    }
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// Rellena el selector con los pedidos existentes
function poblarSelectorDocPedido(){
  const sel = document.getElementById('pd-pedido-sel');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Nuevo pedido ‚Äî</option>'
    + PedC.map(p=>`<option value="${p.id}">${p.num_pedido||'Sin n¬∫'} ¬∑ ${p.proveedor||'Sin proveedor'} ¬∑ ${fmtD(p.fecha)}</option>`).join('');
  if(cur) sel.value = cur;
}

// ‚ïê‚ïê‚ïê PEDIDO DOCUMENTO - L√çNEAS EDITABLES ‚ïê‚ïê‚ïê
function renderPedidoLineas(){
  const tbody=document.getElementById('pd-lineas-body');
  if(!tbody)return;
  if(!window.pdLineas||!window.pdLineas.length){
    window.pdLineas=Array.from({length:20},()=>({cant:'',desc:''}));
  }
  tbody.innerHTML=window.pdLineas.map((l,i)=>`
    <tr style="border-bottom:1px solid #ddd">
      <td style="padding:4px 6px;text-align:center;border-right:1px solid #ddd;width:64px;min-height:24px">
        <input value="${l.cant}" oninput="window.pdLineas[${i}].cant=this.value" style="width:54px;text-align:center;font-size:12px;font-family:Arial;border:none;border-bottom:1px dotted #bbb;outline:none;background:transparent;min-height:20px" placeholder=" ">
      </td>
      <td style="padding:4px 6px;min-height:24px">
        <input value="${l.desc}" oninput="window.pdLineas[${i}].desc=this.value" style="width:100%;font-size:12px;font-family:Arial;border:none;border-bottom:1px dotted #bbb;outline:none;background:transparent;min-height:20px" placeholder=" ">
      </td>
    </tr>`).join('');
}
function addPedidoLinea(){
  if(!window.pdLineas)window.pdLineas=[];
  window.pdLineas.push({cant:'',desc:''});
  renderPedidoLineas();
}
function clearPedidoLineas(){
  window.pdLineas=null;
  renderPedidoLineas();
  // Reset header fields
  ['pd-num-input','pd-prov-input','pd-prov-tel-input','pd-proyecto-input','pd-obs-input'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const today=new Date().toISOString().split('T')[0];
  const f=document.getElementById('pd-fecha-input');if(f)f.value=today;
  const n=document.getElementById('pd-nota-input');
  if(n)n.value='SERVIR LO ANTES POSIBLE.\n\nDIRECCI√ìN DE ENTREGA AV. DIPUTACI√ìN N¬∫ 24 - ALCASSER 46290 (VALENCIA)\nHORARIO DE DESCARGA DE 10:00 - 14:00 Y DE 16:30 A 19:00 H.\nTELFN. CONTACTO 677 970 074 ATENCI√ìN DE JOSE.';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function exportarPDF(elementId, nombreArchivo){
  const el = document.getElementById(elementId);
  if(!el){ toast('Elemento no encontrado','error'); return; }
  toast('Generando PDF‚Ä¶');
  const opt = {
    margin:       [8, 8, 8, 8],
    filename:     nombreArchivo || 'documento.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
  };
  try {
    await html2pdf().set(opt).from(el).save();
    toast('PDF descargado ‚úÖ');
  } catch(e) {
    toast('Error generando PDF: ' + e.message, 'error');
  }
}

async function exportarPresupuestoPDF(){
  const proy = document.getElementById('pres-proyecto-sel')?.value;
  const ver  = document.getElementById('pres-version-sel')?.value || 'v1';
  if(!proy){ toast('Selecciona un proyecto primero','error'); return; }
  // Get project and client info
  const proyecto = PC.find(p=>p.proyecto_id===proy)||{};
  const cliente  = CC.find(c=>c.cliente_id===proyecto.cliente_id)||{};
  // Get rows from table
  const tbody = document.getElementById('pres-tbody');
  if(!tbody){ toast('Sin datos de presupuesto','error'); return; }
  // Build a clean printable div
  const totalEl = document.getElementById('pres-total-lbl');
  const totalText = totalEl ? totalEl.textContent : '';
  const rowsHtml = Array.from(tbody.querySelectorAll('tr[data-search]'))
    .filter(tr=>tr.style.display!=='none')
    .map(tr=>{
      const tds = tr.querySelectorAll('td');
      const isCapitulo = tr.classList.contains('capitulo-row') || (tds[0]&&tds[0].colSpan>1);
      if(isCapitulo){
        return `<tr style="background:#1a2a3a;color:white"><td colspan="7" style="padding:7px 10px;font-weight:700">${tds[0]?.textContent||''}</td></tr>`;
      }
      return `<tr style="border-bottom:1px solid #eee">
        ${Array.from(tds).slice(0,-1).map(td=>`<td style="padding:5px 8px;font-size:11px">${td.textContent}</td>`).join('')}
      </tr>`;
    }).join('');

  const printDiv = document.createElement('div');
  printDiv.innerHTML = `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #1a2a3a;padding-bottom:12px;margin-bottom:16px">
        <div>
          <div style="font-size:18px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div>
          <div style="font-size:10px;color:#666">C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser ¬∑ info@pauinteriorismo.com ¬∑ CIF: B-56909641</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:18px;font-weight:700;color:#b87333">PRESUPUESTO</div>
          <div style="font-size:11px;color:#666">${proy} ¬∑ ${ver.toUpperCase()} ¬∑ ${new Date().toLocaleDateString('es-ES')}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div style="background:#f7f4ef;padding:10px;border-radius:4px">
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a9aaa;margin-bottom:4px">CLIENTE</div>
          <div style="font-weight:700">${cliente.nombre||'‚Äî'}</div>
          <div style="font-size:11px;color:#666">${cliente.email||''} ${cliente.telefono||''}</div>
        </div>
        <div style="background:#f7f4ef;padding:10px;border-radius:4px">
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:#8a9aaa;margin-bottom:4px">PROYECTO</div>
          <div style="font-weight:700">${proyecto.nombre||proy}</div>
          <div style="font-size:11px;color:#666">${proyecto.tipo||''}</div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:16px">
        <thead><tr style="background:#1a2a3a;color:white;font-size:11px">
          <th style="padding:7px;text-align:left">C√≥d.</th>
          <th style="padding:7px;text-align:left">Descripci√≥n</th>
          <th style="padding:7px;text-align:center">Ud.</th>
          <th style="padding:7px;text-align:right">Med.</th>
          <th style="padding:7px;text-align:right">P.Unit.</th>
          <th style="padding:7px;text-align:right">Total</th>
        </tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div style="text-align:right;font-size:14px;font-weight:700;padding:10px;background:#f7f4ef;border-radius:4px">${totalText}</div>
      <div style="color:#666;font-size:10px;text-align:center;border-top:1px solid #eee;padding-top:10px;margin-top:16px">
        PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ info@pauinteriorismo.com ¬∑ Tel: 961 20 01 87
      </div>
    </div>`;
  document.body.appendChild(printDiv);
  const filename = `Presupuesto_${proy}_${ver}_${new Date().toISOString().split('T')[0]}.pdf`;
  await exportarPDF(printDiv.firstElementChild, filename);
  document.body.removeChild(printDiv);
}
// ‚ïê‚ïê‚ïê EDITAR HORAS ‚ïê‚ïê‚ïê
function editHora(id){
  const h=HC.find(x=>x.id===id); if(!h)return;
  document.getElementById('h-id').value=h.id;
  document.getElementById('h-fecha').value=h.fecha;
  document.getElementById('h-proyecto').value=h.proyecto_id||'';
  document.getElementById('h-trab').value=h.trabajador||'';
  document.getElementById('h-horas').value=h.horas||'';
  document.getElementById('h-coste').value=h.coste_hora||18;
  document.getElementById('h-desc').value=h.descripcion||'';
  document.querySelector('#m-hora .modal-title').textContent='‚úèÔ∏è Editar horas';
  openModal('m-hora');
}
// ‚ïê‚ïê‚ïê EDITAR COMPRAS ‚ïê‚ïê‚ïê
function editCompra(id){
  const c=CoC.find(x=>x.id===id); if(!c)return;
  document.getElementById('co-id').value=c.id;
  document.getElementById('co-fecha').value=c.fecha;
  document.getElementById('co-proyecto').value=c.proyecto_id||'';
  document.getElementById('co-prov').value=c.proveedor_id||'';
  document.getElementById('co-concepto').value=c.concepto||'';
  document.getElementById('co-base').value=c.base_imponible||'';
  document.getElementById('co-iva').value=c.iva_pct||'21%';
  document.getElementById('co-estado').value=c.estado_pago||'Pendiente';
  document.getElementById('co-vto').value=c.fecha_vencimiento||'';
  document.getElementById('co-notas').value=c.notas||'';
  document.querySelector('#m-compra .modal-title').textContent='‚úèÔ∏è Editar compra';
  openModal('m-compra');
}
// ‚ïê‚ïê‚ïê EDITAR SUBCONTRATAS ‚ïê‚ïê‚ïê
function editSubcontrata(id){
  const s=ScC.find(x=>x.id===id); if(!s)return;
  document.getElementById('sc-id').value=s.id;
  document.getElementById('sc-fecha').value=s.fecha;
  document.getElementById('sc-proyecto').value=s.proyecto_id||'';
  document.getElementById('sc-prov').value=s.proveedor_id||'';
  document.getElementById('sc-trabajo').value=s.trabajo||'';
  document.getElementById('sc-importe').value=s.importe||'';
  document.getElementById('sc-iva').value=s.iva_pct||'21%';
  document.getElementById('sc-estado').value=s.estado_pago||'Pendiente';
  document.getElementById('sc-vto').value=s.fecha_vencimiento||'';
  document.querySelector('#m-subcontrata .modal-title').textContent='‚úèÔ∏è Editar subcontrata';
  openModal('m-subcontrata');
}
async function saveHora(){
  const id=document.getElementById('h-id')?.value;
  const d={fecha:document.getElementById('h-fecha').value||new Date().toISOString().split('T')[0],proyecto_id:document.getElementById('h-proyecto').value||null,trabajador:document.getElementById('h-trab').value,horas:parseFloat(document.getElementById('h-horas').value)||0,coste_hora:parseFloat(document.getElementById('h-coste').value)||18,descripcion:document.getElementById('h-desc').value};
  try{
    if(id){await sb('horas','PATCH',d,null,`?id=eq.${id}`);toast('Horas actualizadas ‚úÖ');}
    else{await sbPost('horas',d);toast('Horas registradas ‚úÖ');}
    document.getElementById('h-id').value='';
    document.querySelector('#m-hora .modal-title').textContent='‚è± Registrar horas';
    closeModal('m-hora');loadHoras();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEDIDOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPedidos(){
  // Siempre cargar proveedores para tenerlos listos
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  const tb=document.getElementById('pedidos-tbody');
  try{
    PedC=await sbGet('pedidos','?order=fecha.desc');
    document.getElementById('pedidos-count').textContent=PedC.length+' pedidos';
    if(!PedC.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">Sin pedidos</div><button class="btn btn-primary" onclick="openModal('m-pedido')">Ôºã Nuevo</button></div></td></tr>`;return;}
    tb.innerHTML=PedC.map(p=>`<tr data-search="${(p.num_pedido+p.proyecto_id+p.proveedor+p.tipo).toLowerCase()}"><td class="td-mono" style="font-weight:700">${p.num_pedido||'‚Äî'}</td><td>${fmtD(p.fecha)}</td><td class="td-mono" style="color:var(--text-soft)">${p.proyecto_id||'‚Äî'}</td><td><span class="badge b-blue">${p.tipo||'‚Äî'}</span></td><td>${p.proveedor||'‚Äî'}</td><td class="td-mono" style="font-weight:700">${fmt(p.importe)}</td><td>${bE(p.estado)}</td><td style="color:var(--text-soft)">${p.referencia?`<span style="font-weight:600;color:var(--navy)">${p.referencia}</span>`:''} ${p.observaciones||''}</td><td style="display:flex;gap:4px"><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="editPedido('${p.id}')">Editar</button><button class="btn btn-ghost btn-sm" style="font-size:11px" onclick="abrirDocPedido('${p.id}')">üìã Doc.</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('pedidos','${p.id}','${(p.num_pedido||'pedido').replace(/'/g,"\\'")}')">üóë</button></td></tr>`).join('');
  }catch(e){tb.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
  // Re-apply project filter after load
  filtrarModuloPorProyecto('pedidos');
}
function fillProvSelect(selId){
  const sel=document.getElementById(selId);
  if(!sel)return;
  if(!ProvC.length){
    sel.innerHTML='<option value="">Sin proveedores registrados</option>';
    return;
  }
  sel.innerHTML='<option value="">Seleccionar proveedor‚Ä¶</option>'
    +ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}${p.tipo?' ('+p.tipo+')':''}</option>`).join('');
}
function editPedido(id){
  const p=PedC.find(x=>String(x.id)===String(id)); if(!p)return;
  document.getElementById('ped-id').value=p.id;
  document.getElementById('ped-num').value=p.num_pedido||'';
  document.getElementById('ped-fecha').value=p.fecha||'';
  document.getElementById('ped-tipo').value=p.tipo||'Material';
  if(document.getElementById('ped-ref')) document.getElementById('ped-ref').value=p.referencia||'';
  document.getElementById('ped-importe').value=p.importe||'';
  document.getElementById('ped-estado').value=p.estado||'Pendiente';
  document.getElementById('ped-obs').value=p.observaciones||'';
  // Cliente / Proyecto (hidden fields + display)
  const cliObj = CC.find(c=>String(c.cliente_id)===String(p.cliente_id)||String(c.id)===String(p.cliente_id)||c.nombre===p.cliente_nombre);
  const proyObj = PC.find(x=>x.proyecto_id===p.proyecto_id);
  document.getElementById('ped-cliente-id').value  = p.cliente_id||'';
  document.getElementById('ped-cliente-val').value = cliObj?.nombre||p.cliente_nombre||'';
  document.getElementById('ped-proyecto-id').value = p.proyecto_id||'';
  document.getElementById('ped-proyecto-val').value= proyObj?.nombre||p.proyecto_id||'';
  const infoCli  = document.getElementById('ped-modal-cli-info');
  const infoProy = document.getElementById('ped-modal-proy-info');
  if(infoCli)  infoCli.textContent  = cliObj  ? 'üë§ '+cliObj.nombre  : p.cliente_nombre||'‚Äî Sin cliente';
  if(infoProy) infoProy.textContent = proyObj  ? 'üìÅ '+proyObj.nombre+' ('+p.proyecto_id+')' : p.proyecto_id||'‚Äî Sin proyecto';
  // Proveedor
  document.getElementById('ped-prov-search').value = p.proveedor||'';
  document.getElementById('ped-prov-val').value = p.proveedor||'';
  document.querySelector('#m-pedido .modal-title').textContent='‚úèÔ∏è Editar pedido';
  openModal('m-pedido');
}
function openPedidoModal(){
  document.getElementById('ped-id').value='';
  document.getElementById('ped-num').value='PED-'+String((PedC.length||0)+1).padStart(3,'0');
  document.getElementById('ped-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('ped-obs').value='';
  document.getElementById('ped-importe').value='';

  // Leer cliente y proyecto ya seleccionados en los filtros de la p√°gina
  const cliSel  = document.getElementById('filter-cliente-pedidos');
  const proySel = document.getElementById('filter-proyecto-pedidos');
  const cliId   = cliSel?.value||'';
  const proyId  = proySel?.value||'';
  const cliObj  = CC.find(c=>String(c.cliente_id)===String(cliId) || String(c.id)===String(cliId));
  const proyObj = PC.find(p=>p.proyecto_id===proyId);

  // Pre-rellenar campos ocultos (se guardar√°n en save)
  document.getElementById('ped-cliente-id').value  = cliId;
  document.getElementById('ped-cliente-val').value = cliObj?.nombre||'';
  document.getElementById('ped-proyecto-id').value = proyId;
  document.getElementById('ped-proyecto-val').value= proyObj?.nombre||proyId||'';

  // Mostrar info pre-cargada en el modal
  const infoCli  = document.getElementById('ped-modal-cli-info');
  const infoProy = document.getElementById('ped-modal-proy-info');
  if(infoCli)  infoCli.textContent  = cliObj  ? 'üë§ '+cliObj.nombre  : '‚Äî Sin cliente seleccionado';
  if(infoProy) infoProy.textContent = proyObj  ? 'üìÅ '+proyObj.nombre+' ('+proyId+')' : proyId ? 'üìÅ '+proyId : '‚Äî Sin proyecto';

  // Reset proveedor
  ['ped-prov-search','ped-prov-id','ped-prov-val'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.querySelector('#m-pedido .modal-title').textContent='üì¶ Nuevo pedido';
  openModal('m-pedido');
}
async function savePedido(){
  const id=document.getElementById('ped-id')?.value;
  const d={
    num_pedido:   document.getElementById('ped-num').value,
    fecha:        document.getElementById('ped-fecha').value||new Date().toISOString().split('T')[0],
    cliente_id:   document.getElementById('ped-cliente-id')?.value||null,
    cliente_nombre: document.getElementById('ped-cliente-val')?.value||null,
    proyecto_id:  document.getElementById('ped-proyecto-id')?.value||null,
    tipo:         document.getElementById('ped-tipo').value,
    proveedor:    document.getElementById('ped-prov-val')?.value||document.getElementById('ped-prov-search')?.value||'',
    referencia:   document.getElementById('ped-ref')?.value||'',
    importe:      parseFloat(document.getElementById('ped-importe').value)||0,
    estado:       document.getElementById('ped-estado').value,
    observaciones:document.getElementById('ped-obs').value
  };
  try{
    if(id){ await sb('pedidos','PATCH',d,null,`?id=eq.${id}`); toast('Pedido actualizado ‚úÖ'); }
    else  { await sbPost('pedidos',d); toast('Pedido registrado ‚úÖ'); }
    document.getElementById('ped-id').value='';
    document.querySelector('#m-pedido .modal-title').textContent='üì¶ Nuevo pedido';
    closeModal('m-pedido'); loadPedidos();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROL HORARIO ANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadControlHorario(){
  const trab=document.getElementById('ch-trab-sel').value;
  const year=parseInt(document.getElementById('ch-year-sel').value)||2026;
  const grid=document.getElementById('ch-meses-grid');
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-soft)">Cargando‚Ä¶</div>';
  try{
    const data=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&anyo=eq.${year}&order=fecha.asc`);
    const horasByFecha={};data.forEach(d=>{horasByFecha[d.fecha]={horas:d.horas,tipo:d.tipo};});
    let totalHoras=0,diasTrab=0;
    grid.innerHTML='';
    for(let mes=0;mes<12;mes++){
      const primerDia=new Date(year,mes,1);
      const diasMes=new Date(year,mes+1,0).getDate();
      const diaInicio=(primerDia.getDay()+6)%7; // Lunes=0
      let html=`<div class="card"><div class="card-header"><div class="card-title">üìÖ ${MESES[mes]} ${year}</div></div><div class="card-body" style="padding:10px">`;
      html+='<div class="horario-grid">';
      DIAS_CORTOS.forEach(d=>{html+=`<div class="day-header">${d}</div>`;});
      for(let i=0;i<diaInicio;i++)html+='<div></div>';
      for(let d=1;d<=diasMes;d++){
        const fecha=`${year}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const diaSem=(new Date(year,mes,d).getDay()+6)%7;
        const reg=horasByFecha[fecha];
        let cls='horario-day';
        if(diaSem>=5)cls+=' weekend';
        if(reg){cls+=' trabajado';if(reg.horas>0){totalHoras+=reg.horas;diasTrab++;}}
        html+=`<div class="${cls}" onclick="toggleHorario('${fecha}','${trab}',${year})" title="${fecha}">
          <div class="horario-day-num">${d}</div>
          ${reg&&reg.horas>0?`<div class="horario-day-h">${reg.horas}h</div>`:''}
        </div>`;
      }
      html+='</div></div></div>';
      grid.innerHTML+=html;
    }
    document.getElementById('ch-resumen').textContent=`${diasTrab} d√≠as ¬∑ ${totalHoras}h totales`;
  }catch(e){grid.innerHTML=`<div style="color:var(--red);padding:20px;grid-column:1/-1">Error: ${e.message}. Aseg√∫rate de haber ejecutado el SQL de nuevas tablas.</div>`;}
}
async function toggleHorario(fecha,trab,year){
  try{
    const exist=await sbGet('control_horario',`?trabajador=eq.${encodeURIComponent(trab)}&fecha=eq.${fecha}`);
    if(exist.length){await sbDelete('control_horario',exist[0].id);toast('D√≠a borrado');}
    else{await sbPost('control_horario',{trabajador:trab,fecha,horas:8,tipo:'Trabajo',anyo:year});toast('D√≠a registrado ‚úÖ');}
    loadControlHorario();
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROVEEDORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProveedores(){
  const tb=document.getElementById('proveedores-tbody');
  try{
    ProvC=await sbGet('proveedores','?order=nombre.asc');
    document.getElementById('proveedores-count').textContent=ProvC.length+' proveedores';
    if(!ProvC.length){tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-icon">üè≠</div><div class="empty-text">Sin proveedores</div></div></td></tr>`;return;}
    tb.innerHTML=ProvC.map(p=>`<tr data-search="${(p.nombre+p.cif+p.especialidad+p.tipo).toLowerCase()}"><td><strong>${p.nombre}</strong></td><td class="td-mono">${p.cif||'‚Äî'}</td><td>${bE(p.tipo)}</td><td>${p.especialidad||'‚Äî'}</td><td>${p.telefono||'‚Äî'}</td><td style="color:var(--navy-mid)">${p.email||'‚Äî'}</td><td>${p.forma_pago||'‚Äî'}</td><td><div class="td-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="editProveedor('${p.id}')">‚úèÔ∏è</button><button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('proveedores','${p.id}','${p.nombre.replace(/'/g,"\\'")}')">üóë</button></div></td></tr>`).join('');
    populateSelects();
    poblarFiltrosCliente();
    filtrarProyectosPorCliente();
  }catch(e){tb.innerHTML=`<tr><td colspan="8" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}
function abrirNuevoProveedor(){
  // Limpiar formulario para proveedor nuevo
  ['pv-id','pv-nombre','pv-cif','pv-tel','pv-email','pv-esp','pv-iban','pv-notas'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('pv-tipo').value='Proveedor';
  document.getElementById('pv-pago').value='Transferencia';
  document.getElementById('m-proveedor').querySelector('.modal-title').textContent='üè≠ Nuevo proveedor';
  openModal('m-proveedor');
}

function editProveedor(id){const p=ProvC.find(x=>x.id===id);if(!p)return;document.getElementById('m-proveedor').querySelector('.modal-title').textContent='‚úèÔ∏è Editar proveedor';document.getElementById('pv-id').value=p.id;document.getElementById('pv-nombre').value=p.nombre||'';document.getElementById('pv-cif').value=p.cif||'';document.getElementById('pv-tipo').value=p.tipo||'Proveedor';document.getElementById('pv-tel').value=p.telefono||'';document.getElementById('pv-email').value=p.email||'';document.getElementById('pv-esp').value=p.especialidad||'';document.getElementById('pv-pago').value=p.forma_pago||'Transferencia';document.getElementById('pv-iban').value=p.iban||'';document.getElementById('pv-notas').value=p.notas||'';openModal('m-proveedor');}
async function saveProveedor(){const nombre=document.getElementById('pv-nombre').value.trim();if(!nombre){toast('El nombre es obligatorio','error');return;}const id=document.getElementById('pv-id').value;const d={nombre,cif:document.getElementById('pv-cif').value,tipo:document.getElementById('pv-tipo').value,telefono:document.getElementById('pv-tel').value,email:document.getElementById('pv-email').value,especialidad:document.getElementById('pv-esp').value,forma_pago:document.getElementById('pv-pago').value,iban:document.getElementById('pv-iban').value,notas:document.getElementById('pv-notas').value};try{if(id){await sbPatch('proveedores',id,d);toast('Proveedor actualizado ‚úÖ');}else{d.proveedor_id=genId('PRV',ProvC,'proveedor_id');await sbPost('proveedores',d);toast('Proveedor guardado ‚úÖ');}closeModal('m-proveedor');document.getElementById('pv-id').value='';loadProveedores();populateSelects();}catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENTABILIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initRentabilidad(){
  if(!PC.length) PC=await sbGet('proyectos').catch(()=>[]);
  if(!CC.length) CC=await sbGet('clientes').catch(()=>[]);
  // Poblar clientes
  const selCli=document.getElementById('rent-cliente-sel');
  if(selCli){
    const cur=selCli.value;
    selCli.innerHTML='<option value="">üìÅ Seleccionar cliente‚Ä¶</option>'
      +CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
    if(cur) selCli.value=cur;
  }
  // Poblar otros selects del sistema
  populateSelects();
}

function filtrarProyectosRentabilidad(){
  const clienteId=document.getElementById('rent-cliente-sel')?.value;
  const selProy=document.getElementById('rent-proyecto-sel');
  if(!selProy) return;
  if(!clienteId){
    selProy.innerHTML='<option value="">‚Äî Selecciona cliente primero ‚Äî</option>';
    selProy.disabled=true;
    // Ocultar datos
    document.getElementById('rent-kpis').style.display='none';
    document.getElementById('rent-empty').style.display='block';
    return;
  }
  const proyCliente=PC.filter(p=>p.cliente_id===clienteId);
  selProy.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'
    +proyCliente.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  selProy.disabled=false;
  // Si solo hay uno, seleccionarlo
  if(proyCliente.length===1){
    selProy.value=proyCliente[0].proyecto_id;
    loadRentabilidad();
  } else {
    document.getElementById('rent-kpis').style.display='none';
    document.getElementById('rent-empty').style.display='block';
  }
}
async function loadRentabilidad(){
  const proy=document.getElementById('rent-proyecto-sel').value,ver=document.getElementById('rent-version-sel').value;
  const clienteId=document.getElementById('rent-cliente-sel')?.value;
  document.getElementById('rent-kpis').style.display='none';
  document.getElementById('rent-empty').style.display=(!clienteId||!proy)?'block':'none';
  if(!clienteId||!proy) return;
  try{
    const[lineas,compras,subcs,horas,facturas]=await Promise.all([sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.${ver}`),sbGet('compras',`?proyecto_id=eq.${proy}`),sbGet('subcontratas',`?proyecto_id=eq.${proy}`),sbGet('horas',`?proyecto_id=eq.${proy}`),sbGet('facturas',`?proyecto_id=eq.${proy}`)]);
    const totalPres=lineas.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
    const totalCompras=compras.reduce((s,c)=>s+(c.base_imponible||0),0);
    const totalSubcs=subcs.reduce((s,c)=>s+(c.importe||0),0);
    const totalHoras=horas.reduce((s,h)=>s+(h.total||0),0);
    const totalCoste=totalCompras+totalSubcs+totalHoras;
    const beneficio=totalPres-totalCoste,margen=totalPres>0?(beneficio/totalPres)*100:0;
    const pct=totalPres>0?Math.min((totalCoste/totalPres)*100,150):0;
    document.getElementById('rk-pres').textContent=fmt(totalPres);document.getElementById('rk-coste').textContent=fmt(totalCoste);
    document.getElementById('rk-benef').textContent=fmt(beneficio);document.getElementById('rk-benef').style.color=beneficio>=0?'var(--green)':'var(--red)';
    document.getElementById('rk-margen').textContent=fmtP(margen);document.getElementById('rk-margen').style.color=margen>=15?'var(--green)':margen>=0?'var(--amber)':'var(--red)';
    const bar=document.getElementById('rent-bar');bar.style.width=Math.min(pct,100)+'%';bar.style.background=pct<80?'var(--green)':pct<100?'var(--copper)':'var(--red)';
    document.getElementById('rent-bar-label').textContent=`${pct.toFixed(1)}% consumido`;document.getElementById('rent-bar-nums').textContent=`${fmt(totalCoste)} de ${fmt(totalPres)}`;
    document.getElementById('rk-compras-total').textContent=fmt(totalCompras);
    document.getElementById('rk-compras-list').innerHTML=compras.length?compras.map(c=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(c.fecha)}</td><td style="padding:5px 10px">${c.concepto||c.proveedor_id||'‚Äî'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(c.base_imponible)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin compras</td></tr>';
    document.getElementById('rk-sub-total').textContent=fmt(totalSubcs);
    document.getElementById('rk-sub-list').innerHTML=subcs.length?subcs.map(s=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px;color:var(--text-soft)">${fmtD(s.fecha)}</td><td style="padding:5px 10px">${s.trabajo||'‚Äî'}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(s.importe)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin subcontratas</td></tr>';
    document.getElementById('rk-horas-total').textContent=fmt(totalHoras);
    const horPorTrab={};horas.forEach(h=>{horPorTrab[h.trabajador]=(horPorTrab[h.trabajador]||0)+(h.total||0);});
    document.getElementById('rk-horas-list').innerHTML=Object.keys(horPorTrab).length?Object.entries(horPorTrab).map(([t,v])=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 10px" colspan="2">${t}</td><td style="padding:5px 10px;text-align:right;font-weight:700">${fmt(v)}</td></tr>`).join(''):'<tr><td colspan="3" style="padding:12px;text-align:center;color:var(--text-soft)">Sin horas</td></tr>';
    const totalFact=facturas.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0);
    document.getElementById('rk-fact-total').textContent=fmt(totalFact);
    document.getElementById('rk-fact-list').innerHTML=facturas.length?facturas.map(f=>{const tot=(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);return`<tr><td style="padding:7px 10px;font-weight:700">${f.num_factura||'‚Äî'}</td><td style="padding:7px 10px">${fmtD(f.fecha_emision)}</td><td style="padding:7px 10px">${fmt(f.base_imponible)}</td><td style="padding:7px 10px;font-weight:700">${fmt(tot)}</td><td style="padding:7px 10px">${bE(f.estado)}</td></tr>`;}).join(''):'<tr><td colspan="5" style="text-align:center;padding:12px;color:var(--text-soft)">Sin facturas</td></tr>';
    document.getElementById('rent-kpis').style.display='block';
  }catch(e){toast('Error: '+e.message,'error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACTURAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFacturas(){
  const tb=document.getElementById('facturas-tbody');
  try{
    FC=await sbGet('facturas','?order=fecha_emision.desc');
    // Poblar proveedor select en modal
    const fProv=document.getElementById('f-proveedor');
    if(fProv){
      const cur=fProv.value;
      fProv.innerHTML='<option value="">Seleccionar‚Ä¶</option>'+ProvC.map(p=>`<option value="${p.nombre}">${p.nombre}</option>`).join('');
      if(cur)fProv.value=cur;
    }
    // KPIs
    let vTotal=0,vCob=0,vPdte=0,vVenc=0;
    let cTotal=0,cPag=0,cPdte=0,cIva=0;
    FC.forEach(f=>{
      const base=f.base_imponible||0;
      const tot=base*(1+ivaPct(f.iva_pct)/100);
      const pag=f.importe_cobrado||0;
      const pdte=tot-pag;
      const tipo=f.tipo_factura||'Venta';
      if(tipo==='Compra'){
        cTotal+=tot; cPag+=pag; cPdte+=pdte;
        cIva+=base*ivaPct(f.iva_pct)/100;
      } else {
        vTotal+=tot; vCob+=pag; vPdte+=pdte;
        if(f.estado==='Vencida') vVenc+=pdte;
      }
    });
    // Set venta KPIs
    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    sv('fk-v-total',fmt(vTotal)); sv('fk-v-cobrado',fmt(vCob));
    sv('fk-v-pendiente',fmt(vPdte)); sv('fk-v-vencidas',fmt(vVenc));
    // Set compra KPIs
    sv('fk-c-total',fmt(cTotal)); sv('fk-c-pagado',fmt(cPag));
    sv('fk-c-pendiente',fmt(cPdte)); sv('fk-c-iva',fmt(cIva));
    // Balance
    const beneficio=vTotal-cTotal;
    const margen=vTotal>0?(beneficio/vTotal)*100:0;
    const ivaLiquidar=FC.reduce((s,f)=>{
      const base=f.base_imponible||0, iva=base*ivaPct(f.iva_pct)/100;
      return s+((f.tipo_factura||'Venta')==='Venta'?iva:-iva);
    },0);
    const bEl=document.getElementById('fk-b-beneficio');
    if(bEl){bEl.textContent=fmt(beneficio);bEl.style.color=beneficio>=0?'var(--green)':'var(--red)';}
    const mEl=document.getElementById('fk-b-margen');
    if(mEl){mEl.textContent=fmtP(margen);mEl.style.color=margen>=20?'var(--green)':margen>=10?'var(--amber)':'var(--red)';}
    sv('fk-b-iva',fmt(ivaLiquidar));
    const pct=vTotal>0?Math.min(cTotal/vTotal*100,100):0;
    const bar=document.getElementById('fk-b-bar');
    if(bar){bar.style.width=pct+'%';bar.style.background=pct<60?'var(--green)':pct<85?'var(--amber)':'var(--red)';}
    sv('fk-b-bar-lbl',`Gastos: ${pct.toFixed(0)}% sobre ingresos`);
    // Poblar filtros desplegables con nombres reales
    const contrasNombres = [...new Set(FC.map(f=>{
      const esC=(f.tipo_factura||'Venta')==='Compra';
      return esC
        ?(ProvC.find(p=>p.nombre===f.proveedor_id)?.nombre || f.proveedor_id || '')
        :(CC.find(c=>c.cliente_id===f.cliente_id)?.nombre || f.cliente_id || '');
    }).filter(Boolean))].sort();
    const selContra = document.getElementById('filt-fac-contra');
    if(selContra){
      const cur=selContra.value;
      selContra.innerHTML='<option value="">‚Äî Cliente / Proveedor ‚Äî</option>'+
        contrasNombres.map(c=>`<option value="${c.toLowerCase()}">${c}</option>`).join('');
      if(cur) selContra.value=cur;
    }
    const vtos = [...new Set(FC.map(f=>f.fecha_vencimiento).filter(Boolean))].sort();
    const selVto = document.getElementById('filt-fac-vto');
    if(selVto){
      const cur=selVto.value;
      selVto.innerHTML='<option value="">‚Äî Vencimiento ‚Äî</option>'+
        vtos.map(v=>`<option value="${v}">${fmtD(v)}</option>`).join('');
      if(cur) selVto.value=cur;
    }
    // Count
    document.getElementById('facturas-count').textContent=FC.length+' facturas';
    if(!FC.length){
      tb.innerHTML=`<tr><td colspan="13"><div class="empty"><div class="empty-icon">üßæ</div><div class="empty-text">Sin facturas</div>
        <button class="btn btn-primary" onclick="abrirNuevaFactura('Venta')">üì§ Nueva venta</button>
        <button class="btn btn-ghost" onclick="abrirNuevaFactura('Compra')" style="margin-left:6px">üì• Nueva compra</button>
      </div></td></tr>`;return;
    }
    // Render rows
    tb.innerHTML=FC.map(f=>{
      const base=f.base_imponible||0;
      const tot=base*(1+ivaPct(f.iva_pct)/100);
      const pag=f.importe_cobrado||0, pdte=tot-pag;
      const tipo=f.tipo_factura||'Venta';
      const esC=tipo==='Compra';
      const badge=esC
        ?'<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:8px;background:#fdecea;color:var(--red)">üì• Compra</span>'
        :'<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:8px;background:#e8f5ee;color:var(--green)">üì§ Venta</span>';
      const contra=esC
        ?(ProvC.find(p=>String(p.id)===String(f.proveedor_id))?.nombre || f.proveedor_id || '‚Äî')
        :(CC.find(c=>String(c.id)===String(f.cliente_id)||c.cliente_id===f.cliente_id)?.nombre || f.cliente_id || '‚Äî');
      const yaCobrada = f.estado==='Cobrada'||f.estado==='Pagada';
      const srch=(tipo+' '+(f.num_factura||'')+' '+contra+' '+(f.proyecto_id||'')+' '+(f.concepto||'')).toLowerCase();
      return `<tr data-tipo="${tipo}" data-contra="${contra.toLowerCase()}" data-vto="${f.fecha_vencimiento||''}" data-estado="${f.estado||''}" data-search="${srch}">
        <td>${badge}</td>
        <td class="td-mono" style="font-weight:700">${f.num_factura||'‚Äî'}</td>
        <td>${fmtD(f.fecha_emision)}</td>
        <td>${fmtD(f.fecha_vencimiento)}</td>
        <td>${contra}</td>
        <td class="td-mono" style="color:var(--text-soft)">${f.proyecto_id||'‚Äî'}</td>
        <td class="td-mono">${fmt(base)}</td>
        <td class="td-mono">${f.iva_pct||'‚Äî'}</td>
        <td class="td-mono" style="font-weight:700">${fmt(tot)}</td>
        <td class="td-mono" style="color:var(--green)">${fmt(pag)}</td>
        <td class="td-mono" style="color:${pdte>0?'var(--amber)':'var(--green)'}">${fmt(pdte)}</td>
        <td>${bE(f.estado)}</td>
        <td style="display:flex;gap:3px;align-items:center">
          <button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="editFactura('${f.id}')">‚úèÔ∏è</button>
          ${!esC
            ? `<button class="btn btn-sm ${yaCobrada?'btn-green':'btn-ghost'}" style="font-size:10px;padding:2px 6px" title="${yaCobrada?'Ya cobrada':'Marcar como cobrada'}" onclick="marcarFacturaCobrada('${f.id}')">‚úÖ</button>
               <button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="marcarFacturaParcial('${f.id}')">üí∂</button>`
            : `<button class="btn btn-sm ${yaCobrada?'btn-green':'btn-ghost'}" style="font-size:10px;padding:2px 6px" title="${yaCobrada?'Ya pagada':'Marcar como pagada'}" onclick="marcarFacturaPagada('${f.id}')">üí≥</button>`
          }
          ${!esC ? `<button class="btn btn-ghost btn-sm" style="font-size:11px;padding:2px 5px;${f.email_enviado?'color:var(--green)':''}" title="${f.email_enviado?'üì¨ Enviada el '+fmtD(f.fecha_envio):'üìß Enviar por email'}" onclick="enviarFacturaEmail('${f.id}')">${f.email_enviado?'üì¨':'üìß'}</button>` : ''}
          <button class="btn btn-ghost btn-icon btn-sm" onclick="confirmDelete('facturas','${f.id}','${(f.num_factura||'factura').replace(/'/g,"\\'")}')" >üóë</button>
        </td>
      </tr>`;
    }).join('');
    // Re-apply filtros activos
    filtrarFacturas();
  }catch(e){tb.innerHTML=`<tr><td colspan="13" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;}
}

function filtrarTabFacturas(tipo){
  window._facTabActivo = tipo;
  ['todas','venta','compra'].forEach(t=>{
    const el=document.getElementById(`ftab-${t}`);
    if(!el)return;
    const active=(tipo==='todas'&&t==='todas')||(tipo!=='todas'&&t===tipo.toLowerCase());
    el.style.background=active?'var(--navy)':'';
    el.style.color=active?'white':'';
  });
  filtrarFacturas();
}

function filtrarFacturas(){
  const q=(document.getElementById('search-facturas')?.value||'').toLowerCase();
  const contra=(document.getElementById('filt-fac-contra')?.value||'').toLowerCase();
  const vto=document.getElementById('filt-fac-vto')?.value||'';
  const estado=document.getElementById('filt-fac-estado')?.value||'';
  const tipo=(window._facTabActivo||'todas');

  let visible=0;
  document.querySelectorAll('#facturas-tbody tr[data-tipo]').forEach(tr=>{
    const matchTipo = tipo==='todas' || (tr.dataset.tipo||'').toLowerCase()===tipo.toLowerCase();
    const matchQ = !q || (tr.dataset.search||'').toLowerCase().includes(q);
    const matchContra = !contra || (tr.dataset.contra||'').includes(contra);
    const matchVto = !vto || tr.dataset.vto===vto;
    const matchEstado = !estado || tr.dataset.estado===estado;
    const show = matchTipo && matchQ && matchContra && matchVto && matchEstado;
    tr.style.display = show ? '' : 'none';
    if(show) visible++;
  });
  document.getElementById('facturas-count').textContent = visible+' facturas';
}

function limpiarFiltrosFacturas(){
  document.getElementById('search-facturas').value='';
  document.getElementById('filt-fac-contra').value='';
  document.getElementById('filt-fac-vto').value='';
  document.getElementById('filt-fac-estado').value='';
  filtrarFacturas();
}

function abrirNuevaFactura(tipo){
  const esC=tipo==='Compra';
  document.getElementById('f-id').value='';
  document.getElementById('f-tipo').value=tipo;
  document.getElementById('f-modal-title').textContent=esC?'üì• Nueva factura de compra':'üì§ Nueva factura de venta';
  const badge=document.getElementById('f-tipo-badge');
  if(badge){badge.textContent=esC?'üì• COMPRA':'üì§ VENTA';badge.style.background=esC?'#fdecea':'#e8f5ee';badge.style.color=esC?'var(--red)':'var(--green)';}
  document.getElementById('f-grp-cliente').style.display=esC?'none':'';
  document.getElementById('f-grp-proveedor').style.display=esC?'':'none';
  document.getElementById('f-cobrado-lbl').textContent=esC?'Importe pagado ‚Ç¨':'Importe cobrado ‚Ç¨';
  // Mostrar vencimientos m√∫ltiples solo en compras
  const vtoSimple=document.getElementById('f-grp-vto-simple');
  const vtoMulti =document.getElementById('f-grp-vtos-compra');
  if(vtoSimple) vtoSimple.style.display=esC?'none':'';
  if(vtoMulti)  vtoMulti.style.display =esC?'':'none';
  // Actualizar texto d√≠as de pago en modal
  const dpInfo=document.getElementById('f-dias-pago-info');
  if(dpInfo) dpInfo.textContent=`d√≠a ${DIAS_PAGO[0]} y d√≠a ${DIAS_PAGO[1]} de cada mes`;
  document.getElementById('f-estado').innerHTML=esC
    ?'<option>Pendiente</option><option>Pagada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>'
    :'<option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>';
  // Auto-generar n√∫mero de factura √∫nico (formato FAC-001 / FRA-001)
  const prefijo = esC ? 'FRA-' : 'FAC-';
  // Buscar el mayor n√∫mero existente para este prefijo
  const nums = FC
    .map(f=>(f.num_factura||''))
    .filter(n=>n.startsWith(prefijo))
    .map(n=>parseInt(n.replace(prefijo,''))||0);
  const siguiente = (nums.length ? Math.max(...nums) : 0) + 1;
  document.getElementById('f-num').value = prefijo + String(siguiente).padStart(3,'0');
  // Clear otros campos
  document.getElementById('f-concepto').value='';
  document.getElementById('f-base').value='';
  document.getElementById('f-cobrado').value='0';
  document.getElementById('f-total-display').value='';
  document.getElementById('f-vto').value='';
  document.getElementById('f-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-estado').value='Pendiente'; // Siempre Pendiente por defecto
  // Reset cliente/proyecto
  const fCliente=document.getElementById('f-cliente');
  if(fCliente) fCliente.value='';
  const fProv=document.getElementById('f-proveedor');
  if(fProv) fProv.value='';
  // Reset proyecto: vac√≠o hasta que se elija cliente (venta) o mostrar todos (compra)
  const fProy=document.getElementById('f-proyecto');
  if(fProy){
    if(esC){
      // Compras: mostrar todos los proyectos
      fProy.innerHTML='<option value="">‚Äî Sin proyecto ‚Äî</option>'
        +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    } else {
      // Ventas: vac√≠o hasta elegir cliente
      fProy.innerHTML='<option value="">‚Äî Selecciona cliente primero ‚Äî</option>';
    }
  }
  // Reset vencimientos compra
  ['f-vto2','f-vto3','f-vto4'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  // Reset l√≠neas de factura
  _facLineas = [];
  renderFacLineas();
  // Mostrar/ocultar secci√≥n l√≠neas y presupuesto (solo ventas)
  const grpLineas=document.getElementById('f-grp-lineas');
  const grpImportarPres=document.getElementById('f-grp-importar-pres');
  if(grpLineas) grpLineas.style.display=esC?'none':'';
  if(grpImportarPres) grpImportarPres.style.display=esC?'none':'';
  // Reset presupuesto selector
  const presSel=document.getElementById('f-pres-sel');
  if(presSel) presSel.innerHTML='<option value="">‚Äî Seleccionar presupuesto ‚Äî</option>';
  openModal('m-factura');
}


function calcTotalFac(){
  const base=parseFloat(document.getElementById('f-base')?.value)||0;
  const iva=ivaPct(document.getElementById('f-iva')?.value||'21%');
  const total=base*(1+iva/100);
  const el=document.getElementById('f-total-display');
  if(el) el.value=total>0?Number(total).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨':'';
}

// ‚îÄ‚îÄ L√çNEAS DE FACTURA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _facLineas = []; // array de l√≠neas en edici√≥n

function renderFacLineas(){
  const tbody = document.getElementById('f-lineas-tbody');
  const totEl = document.getElementById('f-lineas-total');
  if(!tbody) return;
  if(!_facLineas.length){
    tbody.innerHTML='<tr><td colspan="7" style="padding:12px;text-align:center;color:var(--text-soft);font-size:11px">Sin l√≠neas ‚Äî pulsa Ôºã A√±adir l√≠nea o importa desde presupuesto</td></tr>';
    if(totEl) totEl.textContent='0,00 ‚Ç¨ / 0,00 ‚Ç¨';
    const bEl=document.getElementById('f-base'); if(bEl) bEl.value='';
    const tEl=document.getElementById('f-total-display'); if(tEl) tEl.value='';
    return;
  }
  let totalBase=0, totalConIva=0;
  // Calcular totales SIN rerenderizar si el foco est√° en la tabla
  const focused = document.activeElement;
  const inTable = tbody.contains(focused);

  _facLineas.forEach((l,i)=>{
    const cant=parseFloat(l.cantidad)||0;
    const prec=parseFloat(l.precio)||0;
    totalBase   += cant*prec;
    totalConIva += cant*prec*(1+ivaPct(l.iva||'21%')/100);
  });

  if(inTable){
    // Solo actualizar totales, no rerenderizar filas (mantiene el foco)
    _facLineas.forEach((l,i)=>{
      const cant=parseFloat(l.cantidad)||0;
      const prec=parseFloat(l.precio)||0;
      const sub=cant*prec;
      const cell=tbody.querySelector(`tr:nth-child(${i+1}) td:nth-child(6)`);
      if(cell) cell.textContent=sub>0?Number(sub).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨':'0,00‚Ç¨';
    });
  } else {
    // Rerenderizar completo
    tbody.innerHTML = _facLineas.map((l,i)=>{
      const cant=parseFloat(l.cantidad)||0;
      const prec=parseFloat(l.precio)||0;
      const sub=cant*prec;
      const ivaOpts=['21%','10%','4%','Exento'].map(v=>'<option'+(((l.iva||'21%')===v)?' selected':'')+'>'+v+'</option>').join('');
      return '<tr style="border-bottom:1px solid var(--border)">'
        +'<td style="padding:4px 6px">'
          +'<input class="form-input" style="font-size:11px;padding:3px 6px;width:100%;min-width:180px"'
          +' value="'+(l.desc||'').replace(/"/g,'&quot;')+'"'
          +' oninput="_facLineas['+i+'].desc=this.value" placeholder="Descripci√≥n‚Ä¶">'
        +'</td>'
        +'<td style="padding:4px 6px">'
          +'<input class="form-input" style="font-size:11px;padding:3px 6px;width:50px;text-align:center"'
          +' value="'+(l.ud||'Ud')+'" oninput="_facLineas['+i+'].ud=this.value">'
        +'</td>'
        +'<td style="padding:4px 6px">'
          +'<input class="form-input" style="font-size:11px;padding:3px 6px;width:62px;text-align:right"'
          +' type="number" step="0.01" value="'+cant+'"'
          +' oninput="_facLineas['+i+'].cantidad=parseFloat(this.value)||0;renderFacLineas()">'
        +'</td>'
        +'<td style="padding:4px 6px">'
          +'<input class="form-input" style="font-size:11px;padding:3px 6px;width:82px;text-align:right"'
          +' type="number" step="0.01" value="'+prec+'"'
          +' oninput="_facLineas['+i+'].precio=parseFloat(this.value)||0;renderFacLineas()">'
        +'</td>'
        +'<td style="padding:4px 6px">'
          +'<select class="form-input" style="font-size:11px;padding:3px 4px;width:64px"'
          +' onchange="_facLineas['+i+'].iva=this.value;renderFacLineas()">'+ivaOpts+'</select>'
        +'</td>'
        +'<td style="padding:4px 6px;text-align:right;font-weight:700;font-size:12px;color:var(--navy);white-space:nowrap;min-width:80px">'
          +(sub>0?Number(sub).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨':'0,00‚Ç¨')
        +'</td>'
        +'<td style="padding:4px 2px;text-align:center">'
          +'<button type="button" onclick="_facLineas.splice('+i+',1);renderFacLineas()"'
          +' style="background:none;border:none;cursor:pointer;color:var(--red);font-size:13px;padding:2px 4px">üóë</button>'
        +'</td>'
      +'</tr>';
    }).join('');
  }

  if(totEl) totEl.textContent=Number(totalBase).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨ / '+Number(totalConIva).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨';
  const bEl=document.getElementById('f-base'); if(bEl) bEl.value=totalBase.toFixed(2);
  calcTotalFac();
}

function recalcFacLineas(){ renderFacLineas(); }

function addFacLinea(){
  _facLineas.push({desc:'',ud:'Ud',cantidad:1,precio:0,iva:'21%'});
  renderFacLineas();
  setTimeout(()=>{
    const rows=document.querySelectorAll('#f-lineas-tbody tr');
    if(rows.length){ const last=rows[rows.length-1]; const inp=last.querySelector('input'); if(inp) inp.focus(); }
  },30);
}

function _buildFacturaPDF(){
  const esC = document.getElementById('f-tipo').value==='Compra';
  const num  = document.getElementById('f-num').value||'BORRADOR';
  const fecha= document.getElementById('f-fecha').value;
  const vto  = esC ? (document.getElementById('f-vto')?.value||'') : (document.getElementById('f-vto-venta')?.value||'');
  const base = parseFloat(document.getElementById('f-base').value)||0;
  const ivaSel = document.getElementById('f-iva').value;
  const ivaN = ivaPct(ivaSel);
  const total= base*(1+ivaN/100);
  const cobrado = parseFloat(document.getElementById('f-cobrado').value)||0;
  const pdte = total - cobrado;
  const estado= document.getElementById('f-estado').value;
  const concepto=document.getElementById('f-concepto').value||'';
  const fpago = document.getElementById('f-pago').value;

  let contra='‚Äî', contraDir='', contraCIF='';
  if(!esC){
    const cliId=document.getElementById('f-cliente').value;
    const cli=CC.find(c=>String(c.id)===String(cliId)||c.cliente_id===cliId);
    if(cli){ contra=cli.nombre||'‚Äî'; contraDir=cli.direccion||''; contraCIF=cli.cif||''; }
  } else {
    const provId=document.getElementById('f-proveedor').value;
    const prov=ProvC.find(p=>String(p.id)===String(provId));
    if(prov){ contra=prov.nombre||'‚Äî'; contraCIF=prov.cif||''; }
  }

  let filasLineas='';
  if(_facLineas.length){
    filasLineas=_facLineas.map(l=>{
      const cant=parseFloat(l.cantidad)||0;
      const prec=parseFloat(l.precio)||0;
      const sub=cant*prec;
      return '<tr style="border-bottom:1px solid #eee">'
        +'<td style="padding:8px">'+escH(l.desc||'‚Äî')+'</td>'
        +'<td style="padding:8px;text-align:center">'+escH(l.ud||'Ud')+'</td>'
        +'<td style="padding:8px;text-align:right">'+cant+'</td>'
        +'<td style="padding:8px;text-align:right">'+Number(prec).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨</td>'
        +'<td style="padding:8px;text-align:center">'+(l.iva||'21%')+'</td>'
        +'<td style="padding:8px;text-align:right;font-weight:700">'+Number(sub).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨</td>'
      +'</tr>';
    }).join('');
  } else {
    filasLineas='<tr><td colspan="6" style="padding:14px;text-align:center;color:#888">'+(concepto||'Sin l√≠neas detalladas')+'</td></tr>';
  }

  const ivaImporte=base*ivaN/100;
  const estColor=estado==='Cobrada'||estado==='Pagada'?'#27ae60':estado==='Vencida'?'#e74c3c':'#e67e22';
  const tipoLabel=esC?'FACTURA DE COMPRA':'FACTURA DE VENTA';
  const hoy=new Date().toLocaleDateString('es-ES');

  return {num,fecha,vto,base,ivaSel,ivaN,total,cobrado,pdte,estado,concepto,fpago,
          contra,contraDir,contraCIF,filasLineas,ivaImporte,estColor,tipoLabel,hoy};
}

function escH(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function fmtE(n){ return Number(n).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨'; }

function previsualizarFactura(){
  const d=_buildFacturaPDF();
  const html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Factura '+d.num+' - PAU INTERIORISMO</title>'
  +'<style>'
  +'*{box-sizing:border-box;margin:0;padding:0}'
  +'body{font-family:Arial,sans-serif;font-size:12px;color:#222;background:#eef1f4}'
  +'@media print{body{background:white}.toolbar{display:none}@page{size:A4;margin:12mm}}'
  +'.toolbar{display:flex;gap:10px;justify-content:center;padding:14px;background:#1a2a3a}'
  +'.btn{padding:9px 22px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700}'
  +'.btn-print{background:#fff;color:#1a2a3a}'
  +'.btn-pdf{background:#27ae60;color:#fff}'
  +'.btn-close{background:rgba(255,255,255,.15);color:#fff}'
  +'.page{background:white;max-width:794px;margin:16px auto;box-shadow:0 2px 16px rgba(0,0,0,.15)}'
  +'.hdr{background:#1a2a3a;color:white;padding:24px 28px;display:flex;justify-content:space-between;align-items:flex-start}'
  +'.logo{font-size:17px;font-weight:900}'
  +'.logo small{font-size:10px;opacity:.65;display:block;font-weight:400;margin-top:3px}'
  +'.fnum{text-align:right}'
  +'.fnum h2{font-size:24px;font-weight:900;margin-bottom:5px}'
  +'.ftipo{font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}'
  +'.badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700;border:1px solid '+d.estColor+';color:'+d.estColor+';background:#f8f8f8}'
  +'.iband{display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:3px solid #1a2a3a}'
  +'.icell{padding:14px 20px;border-right:1px solid #eee}'
  +'.icell:last-child{border-right:none}'
  +'.ilbl{font-size:9px;text-transform:uppercase;font-weight:700;color:#999;margin-bottom:5px;letter-spacing:.06em}'
  +'.ival{font-size:13px;font-weight:700;color:#1a2a3a}'
  +'.isub{font-size:10px;color:#888;margin-top:3px}'
  +'.sec{padding:20px 28px 0}'
  +'table{width:100%;border-collapse:collapse}'
  +'thead tr{background:#1a2a3a;color:white}'
  +'thead th{padding:8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;text-align:left}'
  +'tbody tr:nth-child(even){background:#fafafa}'
  +'.tot{background:#f5f7fa;border-top:2px solid #1a2a3a;padding:16px 28px}'
  +'.tr{display:flex;justify-content:space-between;padding:4px 0;font-size:12px}'
  +'.tf{font-size:16px;font-weight:900;color:#1a2a3a;border-top:1px solid #ccc;padding-top:8px;margin-top:5px}'
  +'.foot{text-align:center;color:#aaa;font-size:10px;padding:14px 28px;border-top:1px solid #eee}'
  +'</style></head><body>'
  +'<div class="toolbar">'
  +'<button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>'
  +'<button class="btn btn-pdf" id="btn-pdf" onclick="dlPDF()">üì• Guardar PDF</button>'
  +'<button class="btn btn-close" onclick="window.close()">‚úï Cerrar</button>'
  +'</div>'
  +'<div class="page" id="fpdf">'
    +'<div class="hdr">'
      +'<div>'
        +'<div class="logo">PAU INTERIORISMO S.L.<small>CIF B-56909641</small></div>'
        +'<div style="font-size:10px;opacity:.65;margin-top:8px">C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia)<br>Tel: 961 20 01 87 ¬∑ info@pauinteriorismo.com</div>'
      +'</div>'
      +'<div class="fnum">'
        +'<div class="ftipo">'+d.tipoLabel+'</div>'
        +'<h2>'+escH(d.num)+'</h2>'
        // estado omitido en PDF ‚Äî es informaci√≥n interna
      +'</div>'
    +'</div>'
    +'<div class="iband">'
      +'<div class="icell"><div class="ilbl">'+(d.esC?'Proveedor':'Cliente')+'</div><div class="ival">'+escH(d.contra)+'</div>'
        +(d.contraCIF?'<div class="isub">CIF/NIF: '+escH(d.contraCIF)+'</div>':'')
        +(d.contraDir?'<div class="isub">'+escH(d.contraDir)+'</div>':'')
      +'</div>'
      +'<div class="icell"><div class="ilbl">Fechas</div><div class="ival">Emisi√≥n: '+fmtD(d.fecha)+'</div>'
        +(d.vto?'<div class="isub">Vencimiento: '+fmtD(d.vto)+'</div>':'')
      +'</div>'
      +'<div class="icell"><div class="ilbl">Forma de pago</div><div class="ival">'+escH(d.fpago||'‚Äî')+'</div>'
        +(d.concepto?'<div class="isub">'+escH(d.concepto)+'</div>':'')
      +'</div>'
    +'</div>'
    +'<div class="sec">'
    +'<table>'
    +'<thead><tr>'
    +'<th style="width:44%">Descripci√≥n</th>'
    +'<th style="text-align:center;width:7%">Ud.</th>'
    +'<th style="text-align:right;width:8%">Cant.</th>'
    +'<th style="text-align:right;width:14%">P. Unit.</th>'
    +'<th style="text-align:center;width:7%">IVA</th>'
    +'<th style="text-align:right;width:14%">Subtotal</th>'
    +'</tr></thead>'
    +'<tbody>'+d.filasLineas+'</tbody>'
    +'</table>'
    +'</div>'
    +'<div class="tot">'
    +'<div style="max-width:270px;margin-left:auto">'
    +'<div class="tr"><span>Base imponible</span><span>'+fmtE(d.base)+'</span></div>'
    +'<div class="tr"><span>IVA ('+escH(d.ivaSel)+')</span><span>'+fmtE(d.ivaImporte)+'</span></div>'
    +'<div class="tr tf"><span>TOTAL</span><span>'+fmtE(d.total)+'</span></div>'
    // cobrado/pendiente omitidos ‚Äî son informaci√≥n interna
    +'</div>'
    +'</div>'
    +'<div style="padding:12px 28px 0">'+_getPieHtml()+'</div>'
    +'<div class="foot">PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia) ¬∑ Tel: 961 20 01 87</div>'
  +'</div>'
  +'</body></html>';

  const win=window.open('','_blank','width=870,height=900');
  if(!win){ toast('Activa las ventanas emergentes para ver la previsualizaci√≥n','error'); return; }
  win.document.write(html);
  win.document.close();
  // Inyectar html2pdf y funci√≥n dlPDF via script element
  const s=win.document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
  s.onload=function(){
    const s2=win.document.createElement('script');
    s2.textContent='function dlPDF(){'
      +'var btn=document.getElementById("btn-pdf");'
      +'btn.textContent="‚è≥ Generando‚Ä¶";btn.disabled=true;'
      +'html2pdf().set({'
      +'margin:8,'
      +'filename:"Factura_'+d.num.replace(/[^a-zA-Z0-9_-]/g,'_')+'_PAU_INTERIORISMO.pdf",'
      +'image:{type:"jpeg",quality:0.98},'
      +'html2canvas:{scale:2,useCORS:true,logging:false},'
      +'jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}'
      +'}).from(document.getElementById("fpdf")).save().then(function(){'
      +'btn.textContent="üì• Guardar PDF";btn.disabled=false;'
      +'});}';
    win.document.head.appendChild(s2);
  };
  win.document.head.appendChild(s);
}

async function onFacProyectoChange(){
  const proyId=document.getElementById('f-proyecto')?.value;
  if(!proyId) return;
  // Poblar selector de presupuestos del proyecto
  await poblarFacPresupuestos(proyId);
}

async function poblarFacPresupuestos(proyId){
  const sel=document.getElementById('f-pres-sel');
  if(!sel) return;
  if(!proyId){ sel.innerHTML='<option value="">‚Äî Seleccionar presupuesto ‚Äî</option>'; return; }
  // Obtener versiones del presupuesto del proyecto
  try{
    const lineas=await sbGet('presupuesto_lineas',`?proyecto_id=eq.${proyId}&es_capitulo=eq.false&select=version&order=version.asc`);
    const versiones=[...new Set((lineas||[]).map(l=>l.version))];
    sel.innerHTML='<option value="">‚Äî Seleccionar versi√≥n ‚Äî</option>'
      +versiones.map(v=>`<option value="${proyId}|${v}">${proyId} ¬∑ ${v}</option>`).join('');
  }catch(e){ sel.innerHTML='<option value="">‚Äî Sin presupuesto ‚Äî</option>'; }
}

async function importarLineasPresupuesto(){
  const sel=document.getElementById('f-pres-sel');
  const val=sel?.value;
  if(!val){ toast('Selecciona un presupuesto primero','error'); return; }
  const [proyId,ver]=val.split('|');
  try{
    const lineas=await sbGet('presupuesto_lineas',
      `?proyecto_id=eq.${proyId}&version=eq.${ver}&es_capitulo=eq.false&order=orden.asc`);
    if(!lineas?.length){ toast('El presupuesto est√° vac√≠o','error'); return; }
    _facLineas = lineas.map(l=>({
      desc: l.descripcion||'',
      ud:   l.unidad||'Ud',
      cantidad: l.cantidad||1,
      precio:   l.precio_venta||l.precio_base||0,
      iva:      l.iva_pct||'21%'
    }));
    renderFacLineas();
    toast(`${lineas.length} l√≠neas importadas ‚úÖ`,'success');
  }catch(e){ toast('Error: '+e.message,'error'); }
}

function editFactura(id){
  try{
  const f = FC.find(x=>String(x.id)===String(id));
  if(!f){ toast('Factura no encontrada (id: '+id+')','error'); return; }
  const esC = (f.tipo_factura||'Venta')==='Compra';

  // 1. Configurar tipo en el modal (SIN limpiar campos, SIN abrir)
  document.getElementById('f-tipo').value = f.tipo_factura||'Venta';
  document.getElementById('f-modal-title').textContent = esC?'‚úèÔ∏è Editar factura de compra':'‚úèÔ∏è Editar factura de venta';
  const badge=document.getElementById('f-tipo-badge');
  if(badge){badge.textContent=esC?'üì• COMPRA':'üì§ VENTA';badge.style.background=esC?'#fdecea':'#e8f5ee';badge.style.color=esC?'var(--red)':'var(--green)';}
  document.getElementById('f-grp-cliente').style.display   = esC?'none':'';
  document.getElementById('f-grp-proveedor').style.display = esC?'':'none';
  document.getElementById('f-cobrado-lbl').textContent = esC?'Importe pagado ‚Ç¨':'Importe cobrado ‚Ç¨';

  // 2. Mostrar/ocultar secci√≥n vencimientos
  const vtoSimple = document.getElementById('f-grp-vto-simple');
  const vtoMulti  = document.getElementById('f-grp-vtos-compra');
  if(vtoSimple) vtoSimple.style.display = esC ? 'none' : '';
  if(vtoMulti)  vtoMulti.style.display  = esC ? ''     : 'none';
  const dpInfo=document.getElementById('f-dias-pago-info');
  if(dpInfo) dpInfo.textContent=`d√≠a ${DIAS_PAGO[0]} y d√≠a ${DIAS_PAGO[1]} de cada mes`;

  // 3. Rellenar estados del select
  document.getElementById('f-estado').innerHTML = esC
    ?'<option>Pendiente</option><option>Pagada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>'
    :'<option>Pendiente</option><option>Cobrada</option><option>Parcial</option><option>Vencida</option><option>Anulada</option>';

  // 4. Rellenar todos los campos con datos de la factura
  document.getElementById('f-id').value      = f.id;
  document.getElementById('f-num').value     = f.num_factura||'';
  document.getElementById('f-fecha').value   = f.fecha_emision||'';
  document.getElementById('f-concepto').value= f.concepto||'';
  document.getElementById('f-base').value    = f.base_imponible||'';
  document.getElementById('f-iva').value     = f.iva_pct||'21%';
  document.getElementById('f-pago').value    = f.forma_pago||'Transferencia';
  document.getElementById('f-cobrado').value = f.importe_cobrado||'0';
  document.getElementById('f-estado').value  = f.estado||'Pendiente';

  // 5. Vencimiento(s)
  if(esC){
    document.getElementById('f-vto').value = f.fecha_vencimiento||'';
  } else {
    document.getElementById('f-vto-venta').value = f.fecha_vencimiento||'';
  }
  if(esC){
    const vtoIds = ['f-vto2','f-vto3','f-vto4'];
    vtoIds.forEach((vid,i)=>{
      const el=document.getElementById(vid);
      if(el){ el.value=f[`fecha_vto${i+2}`]||''; el.style.color=''; }
    });
    const impIds=['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'];
    impIds.forEach((vid,i)=>{
      const el=document.getElementById(vid);
      if(el){ el.value=f[`importe_vto${i+1}`]||''; el.style.color=''; }
    });
  }

  // 6. Cliente/proveedor y cascada proyecto
  if(esC){
    const fpEl=document.getElementById('f-proveedor');
    if(fpEl) fpEl.value=f.proveedor_id||'';
  } else {
    const fcEl=document.getElementById('f-cliente');
    if(fcEl){
      fcEl.value=f.cliente_id||'';
      cascadaClienteFactura();
      setTimeout(()=>{ document.getElementById('f-proyecto').value=f.proyecto_id||''; },50);
    }
  }

  // Mostrar/ocultar secci√≥n l√≠neas (solo ventas)
  const grpLineas=document.getElementById('f-grp-lineas');
  const grpImportarPres=document.getElementById('f-grp-importar-pres');
  if(grpLineas) grpLineas.style.display=esC?'none':'';
  if(grpImportarPres) grpImportarPres.style.display=esC?'none':'';
  // Cargar l√≠neas guardadas (si existen)
  try{ _facLineas = f.lineas_json ? JSON.parse(f.lineas_json) : []; }
  catch(e){ _facLineas=[]; }
  renderFacLineas();
  // Poblar presupuestos si hay proyecto (async, no bloqueante)
  if(!esC && f.proyecto_id) poblarFacPresupuestos(f.proyecto_id).catch(()=>{});

  calcTotalFac();
  openModal('m-factura');
  }catch(e){ toast('Error al abrir factura: '+e.message,'error'); console.error('editFactura error:',e); }
}

async function saveFactura(){
  const tipo=document.getElementById('f-tipo').value||'Venta';
  const id=document.getElementById('f-id').value;
  const esC=tipo==='Compra';
  const numFac=document.getElementById('f-num').value.trim();

  // Validar que el n√∫mero no est√© duplicado (solo en facturas nuevas)
  if(!id){
    const duplicado = FC.find(f=>f.num_factura===numFac);
    if(duplicado){ toast(`El n√∫mero "${numFac}" ya existe. Modif√≠calo.`,'error'); return; }
  }

  const d={
    tipo_factura:    tipo,
    num_factura:     numFac,
    fecha_emision:   document.getElementById('f-fecha').value||new Date().toISOString().split('T')[0],
    cliente_id:      esC?null:(document.getElementById('f-cliente').value||null),
    proveedor_id:    esC?(document.getElementById('f-proveedor').value||null):null,
    proyecto_id:     document.getElementById('f-proyecto').value||null,
    base_imponible:  parseFloat(document.getElementById('f-base').value)||0,
    iva_pct:         document.getElementById('f-iva').value,
    forma_pago:      document.getElementById('f-pago').value,
    fecha_vencimiento: esC
      ? (document.getElementById('f-vto')?.value||null)
      : (document.getElementById('f-vto-venta')?.value||null),
    estado:          document.getElementById('f-estado').value||'Pendiente',
    importe_cobrado: parseFloat(document.getElementById('f-cobrado').value)||0,
    concepto:        document.getElementById('f-concepto').value,
    // L√≠neas de factura (solo ventas)
    lineas_json: (!esC && _facLineas.length) ? JSON.stringify(_facLineas) : null,
    // Vencimientos m√∫ltiples (solo compras)
    fecha_vto2: esC?(document.getElementById('f-vto2')?.value||null):null,
    fecha_vto3: esC?(document.getElementById('f-vto3')?.value||null):null,
    fecha_vto4: esC?(document.getElementById('f-vto4')?.value||null):null,
    importe_vto1: esC?(parseFloat(document.getElementById('f-importe-vto1')?.value)||null):null,
    importe_vto2: esC?(parseFloat(document.getElementById('f-importe-vto2')?.value)||null):null,
    importe_vto3: esC?(parseFloat(document.getElementById('f-importe-vto3')?.value)||null):null,
    importe_vto4: esC?(parseFloat(document.getElementById('f-importe-vto4')?.value)||null):null,
  };

  // Si no hay importe_vto1 pero hay fecha, poner el total como importe
  if(esC && d.fecha_vencimiento && !d.importe_vto1){
    const base=parseFloat(document.getElementById('f-base').value)||0;
    d.importe_vto1 = base*(1+ivaPct(d.iva_pct)/100);
  }

  try{
    if(id){
      await sb('facturas','PATCH',d,null,`?id=eq.${id}`);
      toast('Factura actualizada ‚úÖ');
    } else {
      await sbPost('facturas',d);
      toast('Factura guardada ‚úÖ');
    }
    document.getElementById('f-id').value='';
    closeModal('m-factura');
    loadFacturas();
  }catch(e){
    // Mensaje de error m√°s claro para duplicado
    if(e.message && e.message.includes('duplicate')){
      toast(`N√∫mero de factura duplicado. Cambia "${numFac}" por otro.`,'error');
    } else {
      toast('Error: '+e.message,'error');
    }
  }
}


async function loadContabilidad(){
  try{
    // SOLO facturas ‚Äî ni compras, ni subcontratas, ni horas
    const fac = await sbGet('facturas');

    const facVenta  = fac.filter(f=>(f.tipo_factura||'Venta')==='Venta');
    const facCompra = fac.filter(f=>(f.tipo_factura||'Venta')==='Compra');

    // ‚îÄ‚îÄ INGRESOS ‚îÄ‚îÄ
    const ventas    = facVenta.reduce((s,f)=>s+(f.base_imponible||0), 0);
    const ivaRep    = facVenta.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100, 0);
    const ingTot    = ventas + ivaRep;

    // ‚îÄ‚îÄ GASTOS ‚îÄ‚îÄ
    const comprasB  = facCompra.reduce((s,f)=>s+(f.base_imponible||0), 0);
    const ivaComp   = facCompra.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100, 0);

    // ‚îÄ‚îÄ RESULTADO ‚îÄ‚îÄ
    const resultado = ventas - comprasB;
    const margen    = ventas > 0 ? (resultado / ventas) * 100 : 0;

    // ‚îÄ‚îÄ Cuenta de Resultados ‚îÄ‚îÄ
    document.getElementById('cnt-ventas').textContent     = fmt(ventas);
    document.getElementById('cnt-iva-rep').textContent    = fmt(ivaRep);
    document.getElementById('cnt-ing-tot').textContent    = fmt(ingTot);
    document.getElementById('cnt-compras').textContent    = fmt(comprasB);
    document.getElementById('cnt-iva-comp').textContent   = fmt(ivaComp);
    document.getElementById('cnt-gastos-tot').textContent = fmt(comprasB + ivaComp);
    document.getElementById('cnt-result').textContent     = fmt(resultado);
    document.getElementById('cnt-margen').textContent     = fmtP(margen);
    document.getElementById('cnt-result-row').className   = 'cuenta-row result'+(resultado<0?' neg':'');

    // ‚îÄ‚îÄ IVA Trimestral ‚îÄ‚îÄ
    const ivaNeto = ivaRep - ivaComp;
    document.getElementById('iva-rep').textContent        = fmt(ivaRep);
    document.getElementById('iva-comp').textContent       = fmt(ivaComp);
    document.getElementById('iva-neto').textContent       = fmt(ivaNeto);
    document.getElementById('iva-result-row').className   = 'cuenta-row result'+(ivaNeto<0?' neg':'');

    // ‚îÄ‚îÄ Balance ‚îÄ‚îÄ
    // Activo: lo que nos deben los clientes (facturas venta no cobradas)
    const pendCobro = facVenta
      .filter(f=>f.estado!=='Cobrada')
      .reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100)-(f.importe_cobrado||0), 0);

    // Pasivo: lo que debemos a proveedores (facturas compra no pagadas)
    const pendProv = facCompra
      .filter(f=>f.estado!=='Pagada')
      .reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100)-(f.importe_cobrado||0), 0);

    document.getElementById('bal-cli').textContent  = fmt(pendCobro);
    document.getElementById('bal-iva').textContent  = fmt(Math.max(0, ivaNeto));
    document.getElementById('bal-prov').textContent = fmt(pendProv);

  }catch(e){ toast('Error cargando contabilidad: '+e.message,'error'); }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESUPUESTO FINAL (documento imprimible)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadConfiguracion(){
  try{
    const data=await sbGet('configuracion');
    const map={};data.forEach(d=>{map[d.clave]=d.valor;});
    document.getElementById('cfg-razon').value=map.razon_social||'PAU INTERIORISMO S.L.';
    document.getElementById('cfg-cif').value=map.cif||'B-56909641';
    document.getElementById('cfg-tel').value=map.telefono||'961 20 0187';
    document.getElementById('cfg-email').value=map.email||'info@pauinteriorismo.com';
    document.getElementById('cfg-web').value=map.web||'www.pauinteriorismo.com';
    document.getElementById('cfg-dir').value=map.direccion||'';
    document.getElementById('cfg-ci').value=map.ci_pct||3;
    document.getElementById('cfg-gg').value=map.gg_pct||13;
    document.getElementById('cfg-bi').value=map.bi_pct||6;
    document.getElementById('cfg-hora').value=map.coste_hora_defecto||18;
    const total=(parseFloat(map.ci_pct)||3)+(parseFloat(map.gg_pct)||13)+(parseFloat(map.bi_pct)||6);
    document.getElementById('cfg-total-ci').value=total.toFixed(1)+'%';
    ['cfg-ci','cfg-gg','cfg-bi'].forEach(id=>{document.getElementById(id).addEventListener('input',()=>{const ci=parseFloat(document.getElementById('cfg-ci').value)||0,gg=parseFloat(document.getElementById('cfg-gg').value)||0,bi=parseFloat(document.getElementById('cfg-bi').value)||0;document.getElementById('cfg-total-ci').value=(ci+gg+bi).toFixed(1)+'%';});});
    // ‚îÄ‚îÄ PIE DE FACTURA ‚îÄ‚îÄ
    document.getElementById('cfg-iban').value           = map.pie_iban||'';
    document.getElementById('cfg-banco').value          = map.pie_banco||'';
    document.getElementById('cfg-condiciones-pago').value = map.pie_condiciones||'';
    document.getElementById('cfg-nota-legal').value     = map.pie_nota_legal||'';
    document.getElementById('cfg-pie-extra').value      = map.pie_extra||'';
    actualizarPreviewPie();
    // Live preview
    ['cfg-iban','cfg-banco','cfg-condiciones-pago','cfg-nota-legal','cfg-pie-extra']
      .forEach(id=>document.getElementById(id)?.addEventListener('input', actualizarPreviewPie));
  }catch(e){toast('Configura la tabla configuracion ejecutando el SQL de nuevas tablas','error');}
  await loadDiasPago();
}
async function saveConfig(){
  const updates=[
    ['razon_social', document.getElementById('cfg-razon')?.value],
    ['cif',          document.getElementById('cfg-cif')?.value],
    ['telefono',     document.getElementById('cfg-tel')?.value],
    ['email',        document.getElementById('cfg-email')?.value],
    ['web',          document.getElementById('cfg-web')?.value],
    ['direccion',    document.getElementById('cfg-dir')?.value],
    ['ci_pct',       document.getElementById('cfg-ci')?.value],
    ['gg_pct',       document.getElementById('cfg-gg')?.value],
    ['bi_pct',       document.getElementById('cfg-bi')?.value],
    ['coste_hora_defecto', document.getElementById('cfg-hora')?.value],
  ];
  try{
    for(const[k,v] of updates){
      if(v===undefined||v===null) continue;
      await upsertConfig(k, v);
    }
    toast('Configuraci√≥n guardada ‚úÖ');
  }catch(e){
    toast('Error guardando: '+e.message,'error');
  }
}

// ‚îÄ‚îÄ PIE DE FACTURA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _PIE_FACTURA = {};

async function loadPieFactura(){
  try{
    const data=await sbGet('configuracion','?clave=in.(pie_iban,pie_banco,pie_condiciones,pie_nota_legal,pie_extra)');
    data.forEach(d=>{ _PIE_FACTURA[d.clave]=d.valor; });
  }catch(e){}
}

function actualizarPreviewPie(){
  const iban  = document.getElementById('cfg-iban')?.value||'';
  const banco = document.getElementById('cfg-banco')?.value||'';
  const cond  = document.getElementById('cfg-condiciones-pago')?.value||'';
  const legal = document.getElementById('cfg-nota-legal')?.value||'';
  const extra = document.getElementById('cfg-pie-extra')?.value||'';
  const prev  = document.getElementById('cfg-pie-preview');
  if(!prev) return;
  let html='';
  if(iban||banco) html+=`<div style="margin-bottom:4px"><strong>Cuenta bancaria:</strong> ${iban}${banco?' ¬∑ '+banco:''}</div>`;
  if(cond)  html+=`<div style="margin-bottom:4px"><strong>Condiciones de pago:</strong> ${cond}</div>`;
  if(legal) html+=`<div style="margin-bottom:4px;color:#666">${legal}</div>`;
  if(extra) html+=`<div style="color:#666">${extra}</div>`;
  prev.innerHTML = html||'<span style="color:var(--text-soft)">Rellena los campos para ver la vista previa</span>';
}

async function savePieFactura(){
  const campos=[
    ['pie_iban',        document.getElementById('cfg-iban')?.value||''],
    ['pie_banco',       document.getElementById('cfg-banco')?.value||''],
    ['pie_condiciones', document.getElementById('cfg-condiciones-pago')?.value||''],
    ['pie_nota_legal',  document.getElementById('cfg-nota-legal')?.value||''],
    ['pie_extra',       document.getElementById('cfg-pie-extra')?.value||''],
  ];
  try{
    for(const[k,v] of campos) await upsertConfig(k,v);
    // Actualizar cach√© global
    campos.forEach(([k,v])=>{ _PIE_FACTURA[k]=v; });
    toast('Pie de factura guardado ‚úÖ');
    actualizarPreviewPie();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

function _getPieHtml(){
  const iban  = _PIE_FACTURA.pie_iban||'';
  const banco = _PIE_FACTURA.pie_banco||'';
  const cond  = _PIE_FACTURA.pie_condiciones||'';
  const legal = _PIE_FACTURA.pie_nota_legal||'';
  const extra = _PIE_FACTURA.pie_extra||'';
  if(!iban&&!banco&&!cond&&!legal&&!extra) return '';
  let html='<div style="border-top:1px solid #ddd;padding-top:12px;margin-top:8px;font-size:10px;color:#555">';
  if(iban||banco){
    html+='<div style="display:flex;gap:24px;margin-bottom:6px;flex-wrap:wrap">';
    if(iban)  html+=`<span><strong style="color:#1a2a3a">Cuenta bancaria:</strong> ${escH(iban)}</span>`;
    if(banco) html+=`<span><strong style="color:#1a2a3a">Banco:</strong> ${escH(banco)}</span>`;
    html+='</div>';
  }
  if(cond)  html+=`<div style="margin-bottom:5px"><strong style="color:#1a2a3a">Condiciones de pago:</strong> ${escH(cond)}</div>`;
  if(legal) html+=`<div style="margin-bottom:5px;color:#777">${escH(legal)}</div>`;
  if(extra) html+=`<div style="color:#777">${escH(extra)}</div>`;
  html+='</div>';
  return html;
}

// ‚îÄ‚îÄ Cargar pie al inicializar app ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ




const loaders={
  gerencia:loadGerencia,agenda:loadAgenda,clientes:loadClientes,proyectos:loadProyectos,
  presupuesto:()=>{initPresupuesto();if(document.getElementById('pres-proyecto-sel').value)loadPresupuesto();},
  comparativa:()=>{initComparativa();if(document.getElementById('comp-proyecto-sel').value)loadComparativa();},
  tarifario:loadTarifario,cype:loadCype,interiorismo:loadInteriorismo,
  listas:loadFamiliasTarifario,
  compras:loadCompras,subcontratas:loadSubcontratas,horas:loadHoras,
  pedidos:loadPedidos,control_horario:loadControlHorario,
  proveedores:loadProveedores,
  rentabilidad:async()=>{await initRentabilidad();const p=document.getElementById('rent-proyecto-sel')?.value;if(p)loadRentabilidad();},
  facturas:loadFacturas,contabilidad:loadContabilidad,conciliacion:loadConciliacion,rrhh:loadRRHH,configuracion:loadConfiguracion,
  pres_final:async()=>{
    const sel=document.getElementById('pf-proyecto-sel');
    sel.innerHTML='<option value="">Cargando proyectos‚Ä¶</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      if(!PC.length){
        sel.innerHTML='<option value="">Sin proyectos ‚Äî crea uno primero</option>';
        return;
      }
      sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error al cargar: '+e.message+'</option>';
      toast('Error cargando proyectos: '+e.message,'error');
    }
  },
  contrato:async()=>{
    const sel=document.getElementById('ct-proyecto-sel');
    sel.innerHTML='<option value="">Cargando‚Ä¶</option>';
    try{
      PC=await sbGet('proyectos','?order=created_at.desc');
      CC=await sbGet('clientes');
      sel.innerHTML='<option value="">Seleccionar proyecto‚Ä¶</option>'+PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }catch(e){
      sel.innerHTML='<option value="">Error: '+e.message+'</option>';
    }
  },
  pedido_doc:async()=>{
    PedC = await sbGet('pedidos','?order=fecha.desc').catch(()=>PedC||[]);
    poblarClientesDocumentos();
    // Si no hay pedido activo, iniciar en blanco
    if(!window.pdPedidoId){
      window.pdLineas=Array.from({length:20},()=>({cant:'',desc:''}));
      const today=new Date().toISOString().split('T')[0];
      const f=document.getElementById('pd-fecha-input');if(f&&!f.value)f.value=today;
    }
    renderPedidoLineas();
  },
  listas:()=>{
    const r=(id,arr)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(t=>`<div class="lista-item" data-val="${t}">${t}</div>`).join('');};
    r('trabajadores-list',TRABAJADORES);
    r('estados-list',LISTAS.estados_proyecto);
    r('tipos-proyecto-list',LISTAS.tipos_proyecto);
    r('formas-pago-list',LISTAS.formas_pago);
    r('tipos-cliente-list',LISTAS.tipos_cliente);
    r('tipos-proveedor-list',LISTAS.tipos_proveedor);
    r('estancias-list',LISTAS.estancias);
    r('categorias-list',LISTAS.categorias_tarifario);
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  const today=new Date().toISOString().split('T')[0];
  ['co-fecha','sc-fecha','h-fecha','f-fecha','ped-fecha'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
  await loadGerencia();
  // Cargar proveedores al inicio para tenerlos siempre disponibles
  try{ ProvC=await sbGet('proveedores','?order=nombre.asc'); }catch(e){ ProvC=[]; }
  // Cargar trabajadores personalizados desde Supabase
  try{
    const allCfg=await sbGet('configuracion','?clave=in.(trabajadores,estados_proyecto,tipos_proyecto,formas_pago,tipos_cliente,tipos_proveedor,estancias,categorias_tarifario)');
    allCfg.forEach(row=>{
      const vals=row.valor.split(',').map(t=>t.trim()).filter(Boolean);
      if(row.clave==='trabajadores') TRABAJADORES=vals;
      else if(LISTAS[row.clave]) LISTAS[row.clave]=vals;
    });
  }catch(e){}
  populateSelects();
  populateIntCatalog();
  populateTrabajadores();
  populateAllListas();
  poblarFiltrosProyecto();
  poblarFiltrosCliente();
  poblarClientesDocumentos();

  await loadPieFactura();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEJORA 1: ALERTAS DE RENTABILIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function calcularAlertas(){
  const body = document.getElementById('alertas-body');
  const countEl = document.getElementById('alertas-count');
  if(!body) return;
  try{
    const proyectos = PC.filter(p=>['En ejecuci√≥n','Aprobado'].includes(p.estado));
    if(!proyectos.length){
      body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-soft)">Sin proyectos activos</div>';
      if(countEl) countEl.textContent='';
      return;
    }
    const alertas=[];
    for(const p of proyectos){
      const [lineas,compras,subcs,horas] = await Promise.all([
        sbGet('presupuesto_lineas',`?proyecto_id=eq.${p.proyecto_id}&version=eq.v1`),
        sbGet('compras',`?proyecto_id=eq.${p.proyecto_id}`),
        sbGet('subcontratas',`?proyecto_id=eq.${p.proyecto_id}`),
        sbGet('horas',`?proyecto_id=eq.${p.proyecto_id}`)
      ]);
      const presupuesto = lineas.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
      const coste = compras.reduce((s,c)=>s+(c.base_imponible||0),0)
                  + subcs.reduce((s,c)=>s+(c.importe||0),0)
                  + horas.reduce((s,h)=>s+(h.total||0),0);
      if(presupuesto<=0) continue;
      const pct = (coste/presupuesto)*100;
      const cliente = CC.find(c=>c.cliente_id===p.cliente_id);
      if(pct>=100){
        alertas.push({nivel:'rojo', icon:'üî¥', msg:`<strong>${p.proyecto_id}</strong> ‚Äî ${p.nombre} ha SUPERADO el presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado (${pct.toFixed(0)}%)`, pct, proyecto:p, cliente});
      } else if(pct>=85){
        alertas.push({nivel:'naranja', icon:'üü†', msg:`<strong>${p.proyecto_id}</strong> ‚Äî ${p.nombre} al ${pct.toFixed(0)}% del presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado ‚Äî quedan ${fmt(presupuesto-coste)}`, pct, proyecto:p, cliente});
      } else if(pct>=70){
        alertas.push({nivel:'amarillo', icon:'üü°', msg:`<strong>${p.proyecto_id}</strong> ‚Äî ${p.nombre} al ${pct.toFixed(0)}% del presupuesto`, detalle:`${fmt(coste)} coste vs ${fmt(presupuesto)} presupuestado ‚Äî quedan ${fmt(presupuesto-coste)}`, pct, proyecto:p, cliente});
      }
    }
    if(!alertas.length){
      body.innerHTML='<div style="text-align:center;padding:20px;color:var(--green)">‚úÖ Todos los proyectos activos dentro del presupuesto</div>';
      if(countEl) countEl.textContent='Sin alertas';
      return;
    }
    alertas.sort((a,b)=>b.pct-a.pct);
    body.innerHTML=`<table style="width:100%;border-collapse:collapse">
      ${alertas.map(a=>`<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 14px;width:32px;font-size:18px">${a.icon}</td>
        <td style="padding:10px 8px">
          <div style="font-size:13px">${a.msg}</div>
          <div style="font-size:11px;color:var(--text-soft);margin-top:2px">${a.detalle} ¬∑ ${a.cliente?.nombre||'‚Äî'}</div>
        </td>
        <td style="padding:10px 14px;text-align:right">
          <div style="background:var(--border);border-radius:4px;height:8px;width:120px;overflow:hidden;display:inline-block">
            <div style="height:8px;width:${Math.min(a.pct,100)}%;background:${a.nivel==='rojo'?'var(--red)':a.nivel==='naranja'?'var(--copper)':'var(--amber)'};border-radius:4px"></div>
          </div>
          <div style="font-size:11px;font-weight:700;color:${a.nivel==='rojo'?'var(--red)':a.nivel==='naranja'?'var(--copper)':'var(--amber)'};">${a.pct.toFixed(0)}%</div>
        </td>
        <td style="padding:10px 14px">
          <button class="btn btn-ghost btn-sm" onclick="navTo('rentabilidad');setTimeout(()=>{document.getElementById('rent-proyecto-sel').value='${a.proyecto.proyecto_id}';loadRentabilidad();},300)">Ver detalle</button>
        </td>
      </tr>`).join('')}
    </table>`;
    if(countEl) countEl.textContent=`${alertas.length} alerta${alertas.length>1?'s':''}`;
  }catch(e){ body.innerHTML=`<div style="padding:12px;color:var(--red)">Error: ${e.message}</div>`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEJORA 2: COMPARATIVA DE VERSIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function abrirComparativa(){
  const proy = document.getElementById('pres-proyecto-sel')?.value;
  if(!proy){ toast('Selecciona un proyecto primero','error'); return; }
  openModal('m-comparativa');
  const thead = document.getElementById('comp-thead');
  const tbody = document.getElementById('comp-tbody');
  const kpis  = document.getElementById('comp-kpis');
  thead.innerHTML='<tr style="background:var(--navy);color:white"><th style="padding:8px 10px;text-align:left">Descripci√≥n</th><th style="padding:8px;text-align:right;width:80px">Ud.</th><th style="padding:8px;text-align:right">Med.</th><th style="padding:8px 10px;text-align:right;background:#b87333">v1 Total</th><th style="padding:8px 10px;text-align:right;background:#2e7d52">v2 Total</th><th style="padding:8px 10px;text-align:right;background:#1a5276">v3 Total</th><th style="padding:8px 10px;text-align:right">Œî v1‚Üív2</th><th style="padding:8px 10px;text-align:right">Œî v1‚Üív3</th></tr>';
  tbody.innerHTML='<tr><td colspan="8" class="loading">Cargando‚Ä¶</td></tr>';
  kpis.innerHTML='';
  try{
    const [l1,l2,l3]=await Promise.all([
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v1&order=id.asc`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v2&order=id.asc`),
      sbGet('presupuesto_lineas',`?proyecto_id=eq.${proy}&version=eq.v3&order=id.asc`)
    ]);
    const total = v => v.filter(l=>!l.es_capitulo).reduce((s,l)=>s+(l.subtotal||0),0);
    const t1=total(l1), t2=total(l2), t3=total(l3);
    const hasV2=l2.length>0, hasV3=l3.length>0;
    // KPIs
    kpis.innerHTML=`
      <div class="kpi" style="background:#fff5e6"><div class="kpi-label">v1 Total</div><div class="kpi-value" style="color:#b87333">${fmt(t1)}</div></div>
      ${hasV2?`<div class="kpi" style="background:#e8f5ee"><div class="kpi-label">v2 Total</div><div class="kpi-value" style="color:var(--green)">${fmt(t2)}</div></div><div class="kpi" style="background:${t2>=t1?'#fdecea':'#e8f5ee'}"><div class="kpi-label">Œî v1‚Üív2</div><div class="kpi-value" style="color:${t2>=t1?'var(--red)':'var(--green)'};">${t2>=t1?'+':''}${fmt(t2-t1)}</div></div>`:''}
      ${hasV3?`<div class="kpi" style="background:#eaf2fb"><div class="kpi-label">v3 Total</div><div class="kpi-value" style="color:#1a5276">${fmt(t3)}</div></div><div class="kpi" style="background:${t3>=t1?'#fdecea':'#e8f5ee'}"><div class="kpi-label">Œî v1‚Üív3</div><div class="kpi-value" style="color:${t3>=t1?'var(--red)':'var(--green)'};">${t3>=t1?'+':''}${fmt(t3-t1)}</div></div>`:''}`;
    // Merge all descriptions from v1 as base
    if(!l1.length){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-soft)">Sin l√≠neas en v1</td></tr>'; return; }
    tbody.innerHTML = l1.map(l=>{
      if(l.es_capitulo) return `<tr style="background:#1a2a3a;color:white"><td colspan="8" style="padding:7px 10px;font-weight:700">${l.descripcion||''}</td></tr>`;
      const match2 = l2.find(x=>x.descripcion===l.descripcion && !x.es_capitulo);
      const match3 = l3.find(x=>x.descripcion===l.descripcion && !x.es_capitulo);
      const s1=l.subtotal||0, s2=match2?.subtotal||0, s3=match3?.subtotal||0;
      const d12=s2-s1, d13=s3-s1;
      const cellStyle=(d)=>d>0?'color:var(--red);font-weight:700':d<0?'color:var(--green);font-weight:700':'color:var(--text-soft)';
      return `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:6px 10px;font-size:11px">${l.descripcion||'‚Äî'}</td>
        <td style="padding:6px 8px;text-align:right;font-size:11px;color:var(--text-soft)">${l.unidad||''}</td>
        <td style="padding:6px 8px;text-align:right;font-size:11px">${l.medicion||''}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;font-weight:700;background:#fffbf5">${s1?fmt(s1):'‚Äî'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;background:#f0faf4">${hasV2?(s2?fmt(s2):'‚Äî'):'‚Äî'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;background:#eaf4fb">${hasV3?(s3?fmt(s3):'‚Äî'):'‚Äî'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;${cellStyle(d12)}">${hasV2&&d12?((d12>0?'+':'')+fmt(d12)):'‚Äî'}</td>
        <td style="padding:6px 10px;text-align:right;font-size:11px;${cellStyle(d13)}">${hasV3&&d13?((d13>0?'+':'')+fmt(d13)):'‚Äî'}</td>
      </tr>`;
    }).join('');
  }catch(e){ tbody.innerHTML=`<tr><td colspan="8" style="color:var(--red);padding:12px">${e.message}</td></tr>`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEJORA 4: ESTADO DE COBRO VISUAL EN FACTURAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function enviarFacturaEmail(id){
  const f = FC.find(x=>String(x.id)===String(id));
  if(!f){ toast('Factura no encontrada','error'); return; }
  if((f.tipo_factura||'Venta')==='Compra'){ toast('Solo se pueden enviar facturas de venta','error'); return; }

  // Buscar email del cliente
  const cli = CC.find(c=>String(c.id)===String(f.cliente_id)||c.cliente_id===f.cliente_id);
  const emailCliente = cli?.email||'';

  // Mostrar modal de confirmaci√≥n
  const emailDest = prompt(
    `Enviar factura ${f.num_factura} por email\n\nCliente: ${cli?.nombre||'‚Äî'}\nEmail detectado: ${emailCliente||'(sin email registrado)'}\n\nConfirma o modifica el email de destino:`,
    emailCliente
  );
  if(!emailDest||!emailDest.trim()){ return; }
  if(!emailDest.includes('@')){ toast('Email no v√°lido','error'); return; }

  // Construir HTML de la factura para el cuerpo del email
  const d = _buildFacturaPDF();
  const base = f.base_imponible||0;
  const ivaN = ivaPct(f.iva_pct||'21%');
  const total = base*(1+ivaN/100);
  const pie = _getPieHtml();

  const htmlFactura = `
    <div style="font-family:Arial,sans-serif;max-width:700px;margin:0 auto">
      <div style="background:#1a2a3a;color:white;padding:20px 24px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:18px;font-weight:900">PAU INTERIORISMO S.L.</div>
          <div style="font-size:10px;opacity:.65;margin-top:4px">CIF B-56909641 ¬∑ C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia)</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;opacity:.6;text-transform:uppercase">Factura de venta</div>
          <div style="font-size:22px;font-weight:900">${f.num_factura}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:3px solid #1a2a3a">
        <div style="padding:14px 16px;border-right:1px solid #eee">
          <div style="font-size:9px;text-transform:uppercase;font-weight:700;color:#888;margin-bottom:4px">Cliente</div>
          <div style="font-size:13px;font-weight:700;color:#1a2a3a">${escH(d.contra)}</div>
          ${d.contraCIF?`<div style="font-size:10px;color:#888">CIF/NIF: ${escH(d.contraCIF)}</div>`:''}
        </div>
        <div style="padding:14px 16px;border-right:1px solid #eee">
          <div style="font-size:9px;text-transform:uppercase;font-weight:700;color:#888;margin-bottom:4px">Fechas</div>
          <div style="font-size:13px;font-weight:700;color:#1a2a3a">Emisi√≥n: ${fmtD(f.fecha_emision)}</div>
          ${f.fecha_vencimiento?`<div style="font-size:10px;color:#888">Vencimiento: ${fmtD(f.fecha_vencimiento)}</div>`:''}
        </div>
        <div style="padding:14px 16px">
          <div style="font-size:9px;text-transform:uppercase;font-weight:700;color:#888;margin-bottom:4px">Forma de pago</div>
          <div style="font-size:13px;font-weight:700;color:#1a2a3a">${escH(f.forma_pago||'‚Äî')}</div>
        </div>
      </div>
      <div style="padding:16px 16px 0">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:#1a2a3a;color:white">
            <th style="padding:8px;text-align:left;font-size:10px">Descripci√≥n</th>
            <th style="padding:8px;text-align:center;font-size:10px">Ud.</th>
            <th style="padding:8px;text-align:right;font-size:10px">Cant.</th>
            <th style="padding:8px;text-align:right;font-size:10px">P. Unit.</th>
            <th style="padding:8px;text-align:center;font-size:10px">IVA</th>
            <th style="padding:8px;text-align:right;font-size:10px">Subtotal</th>
          </tr></thead>
          <tbody>${d.filasLineas||`<tr><td colspan="6" style="padding:12px;text-align:center;color:#888">${escH(f.concepto||'‚Äî')}</td></tr>`}</tbody>
        </table>
      </div>
      <div style="background:#f5f7fa;border-top:2px solid #1a2a3a;padding:14px 16px">
        <div style="max-width:250px;margin-left:auto">
          <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px"><span>Base imponible</span><span>${fmtE(base)}</span></div>
          <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:12px"><span>IVA (${f.iva_pct||'21%'})</span><span>${fmtE(base*ivaN/100)}</span></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:16px;font-weight:900;color:#1a2a3a;border-top:1px solid #ccc;margin-top:4px"><span>TOTAL</span><span>${fmtE(total)}</span></div>
        </div>
      </div>
      ${pie ? `<div style="padding:12px 16px">${pie}</div>` : ''}
      <div style="text-align:center;color:#aaa;font-size:10px;padding:12px 16px;border-top:1px solid #eee">
        PAU INTERIORISMO S.L. ¬∑ CIF B-56909641 ¬∑ C/ Tom√°s y Valiente N¬∫ 6 Bajo ¬∑ 46290 Alc√†sser (Valencia) ¬∑ Tel: 961 20 01 87
      </div>
    </div>
  `;

  toast('Enviando factura...','info');

  try{
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        messages:[{role:'user',content:`Send an email using Gmail MCP.
To: ${emailDest.trim()}
From: administracion@pauinteriorismo.es  
Subject: Factura ${f.num_factura} - PAU INTERIORISMO S.L.
Body (HTML): ${htmlFactura}

Please send this email now using the Gmail tool.`}],
        mcp_servers:[{type:'url',url:'https://gmail.mcp.claude.com/mcp',name:'gmail-mcp'}]
      })
    });

    if(response.ok){
      // Registrar en BD
      const hoy = new Date().toISOString().split('T')[0];
      await sb('facturas','PATCH',{email_enviado:true, fecha_envio:hoy},null,`?id=eq.${id}`);
      // Actualizar cach√© local
      const idx = FC.findIndex(x=>String(x.id)===String(id));
      if(idx>=0){ FC[idx].email_enviado=true; FC[idx].fecha_envio=hoy; }
      renderFacturas();
      toast(`üì¨ Factura enviada a ${emailDest}`,'success');
    } else {
      const err = await response.text();
      throw new Error('API error: '+err.substring(0,100));
    }
  } catch(e){
    // Fallback: abrir cliente de correo
    const asunto = encodeURIComponent(`Factura ${f.num_factura} - PAU INTERIORISMO S.L.`);
    const cuerpo = encodeURIComponent(`Estimado/a ${d.contra},\n\nAdjunto la factura ${f.num_factura} por importe de ${fmtE(total)}.\n\nQuedo a su disposici√≥n para cualquier consulta.\n\nAtentamente,\nPAU INTERIORISMO S.L.\nTel: 961 20 01 87`);
    window.open(`mailto:${emailDest}?subject=${asunto}&body=${cuerpo}`);
    toast('Abriendo cliente de email (fallback)','info');
  }
}

function marcarFacturaPagada(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const tot = (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);
  if(f.estado==='Pagada'){
    toast(`${f.num_factura} ya est√° marcada como pagada`,'error'); return;
  }
  if(confirm(`¬øMarcar factura ${f.num_factura} como PAGADA (${fmt(tot)})?`)){
    sb('facturas','PATCH',{estado:'Pagada',importe_cobrado:tot},null,`?id=eq.${id}`)
      .then(()=>{ toast('Factura marcada como pagada üí≥'); loadFacturas(); })
      .catch(e=>toast('Error: '+e.message,'error'));
  }
}

function marcarFacturaCobrada(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const tot = (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);
  if(confirm(`¬øMarcar factura ${f.num_factura} como cobrada (${fmt(tot)})?`)){
    sb('facturas','PATCH',{estado:'Cobrada',importe_cobrado:tot},null,`?id=eq.${id}`)
      .then(()=>{ toast('Factura marcada como cobrada ‚úÖ'); loadFacturas(); })
      .catch(e=>toast('Error: '+e.message,'error'));
  }
}

function marcarFacturaParcial(id){
  const f = FC.find(x=>x.id===id); if(!f) return;
  const tot = (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100);
  const imp = prompt(`Importe cobrado parcialmente (total: ${fmt(tot)} ‚Ç¨):`);
  if(!imp) return;
  const val = parseFloat(imp.replace(',','.'));
  if(isNaN(val)||val<=0){ toast('Importe no v√°lido','error'); return; }
  const estado = val>=tot?'Cobrada':'Parcial';
  sb('facturas','PATCH',{estado,importe_cobrado:val},null,`?id=eq.${id}`)
    .then(()=>{ toast(`Cobro registrado: ${fmt(val)} ‚úÖ`); loadFacturas(); })
    .catch(e=>toast('Error: '+e.message,'error'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEJORA 5: INFORME MENSUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generarInformeMensual(){
  const mes  = document.getElementById('inf-mes')?.value;
  const anyo = document.getElementById('inf-anyo')?.value;
  if(!mes||!anyo){ toast('Selecciona mes y a√±o','error'); return; }
  const desde = `${anyo}-${String(mes).padStart(2,'0')}-01`;
  const hasta = new Date(anyo, mes, 0).toISOString().split('T')[0];
  const body = document.getElementById('inf-body');
  body.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-soft)">Cargando datos‚Ä¶</div>';
  try{
    const [facs,comps,subcs,hors] = await Promise.all([
      sbGet('facturas',`?fecha_emision=gte.${desde}&fecha_emision=lte.${hasta}`),
      sbGet('compras', `?fecha=gte.${desde}&fecha=lte.${hasta}`),
      sbGet('subcontratas',`?fecha=gte.${desde}&fecha=lte.${hasta}`),
      sbGet('horas',   `?fecha=gte.${desde}&fecha=lte.${hasta}`)
    ]);
    const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const nombreMes = meses[parseInt(mes)-1];
    const ingresos = facs.reduce((s,f)=>s+(f.base_imponible||0),0);
    const ivaRep   = facs.reduce((s,f)=>s+(f.base_imponible||0)*ivaPct(f.iva_pct)/100,0);
    const cobrado  = facs.reduce((s,f)=>s+(f.importe_cobrado||0),0);
    const compTotal= comps.reduce((s,c)=>s+(c.base_imponible||0),0);
    const ivaSop   = comps.reduce((s,c)=>s+(c.base_imponible||0)*ivaPct(c.iva_pct)/100,0);
    const subcTotal= subcs.reduce((s,c)=>s+(c.importe||0),0);
    const horasTotal=hors.reduce((s,h)=>s+(h.total||0),0);
    const costTotal= compTotal+subcTotal+horasTotal;
    const beneficio= ingresos-costTotal;
    const saldoIva = ivaRep-ivaRep*0; // IVA repercutido - IVA soportado (simplificado)
    body.innerHTML=`
      <div style="font-family:Arial,sans-serif;max-width:700px">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #1a2a3a;padding-bottom:10px;margin-bottom:16px">
          <div><div style="font-size:16px;font-weight:700;color:#1a2a3a">PAU INTERIORISMO S.L.</div><div style="font-size:10px;color:#666">CIF B-56909641</div></div>
          <div style="text-align:right"><div style="font-size:15px;font-weight:700;color:#b87333">INFORME MENSUAL</div><div style="font-size:12px;color:#666">${nombreMes} ${anyo}</div></div>
        </div>
        <!-- INGRESOS -->
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#1a2a3a;background:#f7f4ef;padding:6px 10px;border-radius:4px;margin-bottom:6px">üìà INGRESOS</div>
          <table style="width:100%;font-size:12px">
            <tr><td style="padding:4px 10px">Facturaci√≥n base imponible</td><td style="text-align:right;font-weight:700;padding:4px 10px">${fmt(ingresos)}</td></tr>
            <tr><td style="padding:4px 10px;color:#666">IVA repercutido (21%)</td><td style="text-align:right;padding:4px 10px;color:#666">${fmt(ivaRep)}</td></tr>
            <tr style="border-top:1px solid #eee"><td style="padding:6px 10px;font-weight:700">Total facturado (con IVA)</td><td style="text-align:right;font-weight:700;padding:6px 10px">${fmt(ingresos+ivaRep)}</td></tr>
            <tr><td style="padding:4px 10px;color:var(--green)">Cobrado en este periodo</td><td style="text-align:right;padding:4px 10px;color:var(--green);font-weight:700">${fmt(cobrado)}</td></tr>
          </table>
        </div>
        <!-- GASTOS -->
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#1a2a3a;background:#f7f4ef;padding:6px 10px;border-radius:4px;margin-bottom:6px">üìâ GASTOS</div>
          <table style="width:100%;font-size:12px">
            <tr><td style="padding:4px 10px">Compras a proveedores (base)</td><td style="text-align:right;padding:4px 10px">${fmt(compTotal)}</td></tr>
            <tr><td style="padding:4px 10px;color:#666">IVA soportado compras</td><td style="text-align:right;padding:4px 10px;color:#666">${fmt(ivaRep>0?ivaRep*0.4:ivaRep)}</td></tr>
            <tr><td style="padding:4px 10px">Subcontratas</td><td style="text-align:right;padding:4px 10px">${fmt(subcTotal)}</td></tr>
            <tr><td style="padding:4px 10px">Mano de obra propia</td><td style="text-align:right;padding:4px 10px">${fmt(horasTotal)}</td></tr>
            <tr style="border-top:1px solid #eee"><td style="padding:6px 10px;font-weight:700">Total gastos</td><td style="text-align:right;font-weight:700;padding:6px 10px">${fmt(costTotal)}</td></tr>
          </table>
        </div>
        <!-- RESULTADO -->
        <div style="background:${beneficio>=0?'#e8f5ee':'#fdecea'};padding:12px 16px;border-radius:6px;margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;font-size:14px">RESULTADO DEL MES</div>
            <div style="font-size:18px;font-weight:700;color:${beneficio>=0?'var(--green)':'var(--red)'}">${fmt(beneficio)}</div>
          </div>
          <div style="font-size:11px;color:#666;margin-top:4px">Margen: ${ingresos>0?((beneficio/ingresos)*100).toFixed(1):0}%</div>
        </div>
        <!-- ACTIVIDAD -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${facs.length}</div>
            <div style="font-size:11px;color:#666">Facturas emitidas</div>
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${comps.length}</div>
            <div style="font-size:11px;color:#666">Compras registradas</div>
          </div>
          <div style="background:#f7f4ef;padding:10px;border-radius:4px;text-align:center">
            <div style="font-size:22px;font-weight:700">${hors.reduce((s,h)=>s+(h.horas||0),0)}h</div>
            <div style="font-size:11px;color:#666">Horas trabajadas</div>
          </div>
        </div>
        <div style="font-size:10px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:8px">
          Informe generado el ${new Date().toLocaleDateString('es-ES')} ¬∑ PAU INTERIORISMO S.L. ¬∑ CIF B-56909641
        </div>
      </div>`;
  }catch(e){ body.innerHTML=`<div style="color:var(--red);padding:12px">Error: ${e.message}</div>`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CASCADA CLIENTE ‚Üí PROYECTO EN MODAL FACTURA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function cascadaClienteFactura(){
  const clienteId = document.getElementById('f-cliente')?.value;
  const proyEl    = document.getElementById('f-proyecto');
  if(!proyEl) return;
  if(!clienteId){
    proyEl.innerHTML='<option value="">‚Äî Selecciona cliente primero ‚Äî</option>';
    return;
  }
  const filtrados = PC.filter(p=>p.cliente_id===clienteId);
  if(!filtrados.length){
    proyEl.innerHTML='<option value="">‚Äî Sin proyectos para este cliente ‚Äî</option>';
  } else {
    proyEl.innerHTML='<option value="">‚Äî Sin proyecto ‚Äî</option>'
      +filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    // Si solo hay uno, seleccionarlo autom√°ticamente
    if(filtrados.length===1) proyEl.value=filtrados[0].proyecto_id;
  }
}

// Llamar tambi√©n al abrir el modal para que el proyecto ya est√© filtrado
const _origAbrirNuevaFactura = abrirNuevaFactura;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CASCADA CLIENTE ‚Üí PROYECTO EN COMPARATIVA OFERTAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function cascadaClienteComparativa(){
  const clienteSel = document.getElementById('filter-cliente-comparativa');
  const clienteId  = clienteSel ? clienteSel.value : '';
  const proySel    = document.getElementById('comp-proyecto-sel');
  if(!proySel) return;
  const filtrados = clienteId ? PC.filter(p=>p.cliente_id===clienteId) : PC;
  proySel.innerHTML = '<option value="">üìÅ Proyecto‚Ä¶</option>'
    + filtrados.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
  // Reset lista
  const btn = document.getElementById('btn-nueva-comparativa');
  if(btn) btn.style.display='none';
  document.getElementById('comp-list').innerHTML=
    '<div class="empty"><div class="empty-icon">‚öñÔ∏è</div><div class="empty-text">Selecciona un proyecto</div></div>';
}

function abrirNuevaComparativa(){
  const proyId   = document.getElementById('comp-proyecto-sel')?.value;
  const clienteId= document.getElementById('filter-cliente-comparativa')?.value;

  // 1. Poblar clientes en el modal PRIMERO
  poblarClientesModalCmp();

  // 2. Setear cliente seleccionado
  const cmpCliente = document.getElementById('cmp-cliente');
  if(cmpCliente && clienteId){
    cmpCliente.value = clienteId;
    // 3. Filtrar proyectos por ese cliente
    cascadaClienteModalCmp();
  } else {
    // Si no hay cliente, poblar todos los proyectos
    const proySel = document.getElementById('cmp-proyecto');
    if(proySel){
      proySel.innerHTML='<option value="">Seleccionar‚Ä¶</option>'
        +PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }
  }

  // 4. Setear proyecto seleccionado
  const cmpProy = document.getElementById('cmp-proyecto');
  if(cmpProy && proyId){
    cmpProy.value = proyId;
  }

  // 5. Poblar proveedores
  poblarProveedoresComparativa();

  // 6. Reset campos del formulario
  document.getElementById('cmp-id').value='';
  document.getElementById('cmp-trabajo').value='';
  [1,2,3].forEach(n=>{
    const pvpEl=document.getElementById(`o${n}-pvp`);     if(pvpEl) pvpEl.value='';
    const dtoEl=document.getElementById(`o${n}-dto`);     if(dtoEl) dtoEl.value='0';
    const cbEl =document.getElementById(`o${n}-costebase`);if(cbEl) cbEl.value='';
    const mkEl =document.getElementById(`o${n}-mk`);      if(mkEl)  mkEl.value='0';
    const notEl=document.getElementById(`o${n}-notas`);   if(notEl) notEl.value='';
    // Reset resultados
    ['res-coste','res-venta','res-margen','res-pct'].forEach(k=>{
      const el=document.getElementById(`o${n}-${k}`); if(el) el.textContent='‚Äî';
    });
    // Reset border
    const col=document.getElementById(`cmp-col-${n}`);
    if(col){ col.style.borderColor='var(--border)'; col.style.borderWidth='1px'; }
  });
  const info=document.getElementById('cmp-ganadora-info');
  if(info) info.innerHTML='';

  openModal('m-comparativa');
}

// Override loadComparativa para tambi√©n mostrar bot√≥n nueva comparativa
const _origLoadComparativa = loadComparativa;


// Poblar clientes en comparativa al inicializar
function poblarClientesComparativa(){
  const sel = document.getElementById('filter-cliente-comparativa');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">üë§ Cliente‚Ä¶</option>'
    + CC.map(c=>`<option value="${c.cliente_id}">${c.nombre}</option>`).join('');
  if(cur) sel.value = cur;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VENCIMIENTOS M√öLTIPLES EN FACTURAS DE COMPRA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Sugiere los pr√≥ximos d√≠as de pago (5 y 20) a partir de hoy
function sugerirDiasPago(){
  const baseInput = document.getElementById('f-fecha');
  const baseVal   = baseInput?.value || new Date().toISOString().split('T')[0];
  const base      = new Date(baseVal);
  const hoy       = new Date();
  const ref        = base > hoy ? base : hoy;

  // Generar los pr√≥ximos 4 d√≠as de pago a partir de ref
  const sugerencias = [];
  let cursor = new Date(ref);
  while(sugerencias.length < 4){
    for(const dia of [...DIAS_PAGO].sort((a,b)=>a-b)){
      const candidata = new Date(cursor.getFullYear(), cursor.getMonth(), dia);
      if(candidata > ref && sugerencias.length < 4){
        sugerencias.push(candidata.toISOString().split('T')[0]);
      }
    }
    cursor.setMonth(cursor.getMonth()+1);
    if(cursor.getMonth() > ref.getMonth() + 12) break; // safety
  }

  // Contar cu√°ntos vencimientos tiene ya el usuario rellenados (fechas con valor)
  const idsVto = ['f-vto','f-vto2','f-vto3','f-vto4'];
  const vtoConValor = idsVto.filter(id => {
    const el = document.getElementById(id);
    return el && el.value;
  });
  // Si ya tiene fechas puestas, respetar cu√°ntas son; si no, sugerir solo 1
  const numVtos = vtoConValor.length || 1;

  // Solo rellenar fechas en los vencimientos visibles QUE EST√âN VAC√çOS
  // (si el usuario ya puso fechas, no las tocamos)
  sugerencias.slice(0, numVtos).forEach((fecha, i) => {
    const el = document.getElementById(idsVto[i]);
    if(el && !el.value){ el.value = fecha; el.style.color='var(--text-soft)'; }
  });

  // Distribuir importe total SOLO entre los vencimientos visibles
  const base2 = parseFloat(document.getElementById('f-base')?.value)||0;
  const iva   = ivaPct(document.getElementById('f-iva')?.value||'21%');
  const total = base2*(1+iva/100);
  if(total > 0){
    const parte = (total / numVtos).toFixed(2);
    ['f-importe-vto1','f-importe-vto2','f-importe-vto3','f-importe-vto4'].forEach((id,i)=>{
      const el=document.getElementById(id);
      if(!el) return;
      if(i < numVtos){
        // √öltimo vencimiento absorbe el redondeo
        el.value = i < numVtos-1 ? parte : (total - parseFloat(parte)*(numVtos-1)).toFixed(2);
        el.style.color='var(--text-soft)';
      } else {
        // Limpiar vencimientos que no aplican
        el.value = '';
      }
    });
  }
  toast(`üí° Importe dividido en ${numVtos} vencimiento${numVtos>1?'s':''} ‚úÖ`);
}

// Confirmar vencimiento (quitar estilo gris cuando el usuario hace click)
function confirmarVto(id){
  const el = document.getElementById(id);
  if(el) el.style.color = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// D√çAS DE PAGO & C√ÅLCULO VENCIMIENTO GIRO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// D√≠as de pago globales (por defecto 5 y 20, editables en Configuraci√≥n)
let DIAS_PAGO = [5, 20];

async function loadDiasPago(){
  try{
    const cfg = await sbGet('configuracion','?clave=in.(dia_pago_1,dia_pago_2)');
    cfg.forEach(row=>{
      if(row.clave==='dia_pago_1') DIAS_PAGO[0]=parseInt(row.valor)||5;
      if(row.clave==='dia_pago_2') DIAS_PAGO[1]=parseInt(row.valor)||20;
    });
    const d1=document.getElementById('cfg-dia1'), d2=document.getElementById('cfg-dia2');
    if(d1) d1.value=DIAS_PAGO[0];
    if(d2) d2.value=DIAS_PAGO[1];
  }catch(e){}
}

async function saveDiasPago(){
  const d1=parseInt(document.getElementById('cfg-dia1')?.value)||5;
  const d2=parseInt(document.getElementById('cfg-dia2')?.value)||20;
  DIAS_PAGO=[d1,d2];
  try{
    await upsertConfig('dia_pago_1',String(d1));
    await upsertConfig('dia_pago_2',String(d2));
    toast(`D√≠as de pago guardados: ${d1} y ${d2} de cada mes ‚úÖ`);
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// Calcula fecha vencimiento seg√∫n forma de pago y d√≠as de pago configurados
function calcularVencimientoGiro(fechaEmision, formaPago){
  if(!fechaEmision) return null;
  const base = new Date(fechaEmision);
  let diasPlazo = 0;
  if(formaPago==='Giro 30 d√≠as')  diasPlazo=30;
  else if(formaPago==='Giro 60 d√≠as')  diasPlazo=60;
  else if(formaPago==='Giro 90 d√≠as')  diasPlazo=90;
  else if(formaPago==='Giro 120 d√≠as') diasPlazo=120;
  else return null; // No es giro

  // Sumar d√≠as al plazo
  const fechaBase = new Date(base);
  fechaBase.setDate(fechaBase.getDate() + diasPlazo);

  // Buscar el siguiente d√≠a de pago (5 o 20) igual o posterior
  const dias = [...DIAS_PAGO].sort((a,b)=>a-b);
  let mejor = null;
  // Buscar en el mes actual y siguiente
  for(let deltaM=0; deltaM<=2; deltaM++){
    const mes = fechaBase.getMonth() + deltaM;
    const anyo = fechaBase.getFullYear() + Math.floor((fechaBase.getMonth()+deltaM)/12);
    const mesReal = mes % 12;
    for(const dia of dias){
      const candidata = new Date(anyo, mesReal, dia);
      if(candidata >= fechaBase){
        if(!mejor || candidata < mejor) mejor = candidata;
      }
    }
    if(mejor) break;
  }
  if(!mejor) return null;
  return mejor.toISOString().split('T')[0];
}

// Auto-calcular vencimiento al cambiar forma de pago en modal factura
function onFormaPagoChange(){
  const forma = document.getElementById('f-pago')?.value;
  const fecha = document.getElementById('f-fecha')?.value;
  const vtoEl = document.getElementById('f-vto');
  if(!vtoEl) return;
  const vto = calcularVencimientoGiro(fecha, forma);
  if(vto){
    const tipoFac = document.getElementById('f-tipo')?.value;
    const targetVtoId = tipoFac==='Compra' ? 'f-vto' : 'f-vto-venta';
    const targetVtoEl = document.getElementById(targetVtoId);
    if(targetVtoEl) targetVtoEl.value = vto;
    toast(`Vencimiento calculado: ${fmtD(vto)} (${forma} ¬∑ d√≠as de pago: ${DIAS_PAGO.join(' y ')})`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONCILIACI√ìN BANCARIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadConciliacion(){
  const dias = document.getElementById('venc-filtro')?.value || '30';
  const tbody = document.getElementById('venc-tbody');
  const hoy = new Date();

  try{
    // Cargar todas las facturas de compra pendientes
    const facturas = await sbGet('facturas','?tipo_factura=eq.Compra&estado=in.(Pendiente,Parcial,Vencida)&order=fecha_vencimiento.asc');
    // Cargar tambi√©n compras pendientes
    const compras  = await sbGet('compras','?estado_pago=in.(Pendiente,Parcial,Vencido)&order=fecha_vencimiento.asc');

    // Combinar ambas fuentes como "pagos pendientes"
    const pendientes = [
      ...facturas.map(f=>({
        id: f.id, tipo:'factura',
        proveedor: f.proveedor_id||'‚Äî',
        concepto:  f.concepto||f.num_factura||'‚Äî',
        forma_pago: f.forma_pago||'‚Äî',
        proyecto:  f.proyecto_id||'‚Äî',
        base:      f.base_imponible||0,
        total:     (f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),
        vto:       f.fecha_vencimiento,
        estado:    f.estado,
        num:       f.num_factura||'‚Äî',
        iva_pct:   f.iva_pct||'21%'
      })),
      ...compras.map(c=>({
        id: c.id, tipo:'compra',
        proveedor: c.proveedor_id||'‚Äî',
        concepto:  c.concepto||'‚Äî',
        forma_pago:'‚Äî',
        proyecto:  c.proyecto_id||'‚Äî',
        base:      c.base_imponible||0,
        total:     (c.base_imponible||0)*(1+ivaPct(c.iva_pct)/100),
        vto:       c.fecha_vencimiento,
        estado:    c.estado_pago,
        num:       '(Compra)',
        iva_pct:   c.iva_pct||'21%'
      }))
    ].sort((a,b)=>{
      if(!a.vto) return 1; if(!b.vto) return -1;
      return new Date(a.vto)-new Date(b.vto);
    });

    // Filtrar seg√∫n selecci√≥n
    const limite = dias==='todos' ? null : new Date(hoy.getTime()+parseInt(dias)*86400000);
    const filtrados = limite ? pendientes.filter(p=>p.vto && new Date(p.vto)<=limite) : pendientes;

    // KPIs
    const semana = new Date(hoy.getTime()+7*86400000);
    const mesEnd  = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);
    const kSemana  = pendientes.filter(p=>p.vto&&new Date(p.vto)<=semana).reduce((s,p)=>s+p.total,0);
    const kMes     = pendientes.filter(p=>p.vto&&new Date(p.vto)<=mesEnd).reduce((s,p)=>s+p.total,0);
    const kPend    = pendientes.reduce((s,p)=>s+p.total,0);

    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    sv('conc-semana', fmt(kSemana));
    sv('conc-mes',    fmt(kMes));
    sv('conc-pendientes', fmt(kPend));
    sv('venc-count', `${filtrados.length} pagos`);

    // Facturas pagadas este mes
    const mesStart = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
    const pagadasMes = await sbGet('facturas',`?tipo_factura=eq.Compra&estado=eq.Pagada&fecha_vencimiento=gte.${mesStart}`);
    sv('conc-pagadas', fmt(pagadasMes.reduce((s,f)=>s+(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),0)));

    if(!filtrados.length){
      tbody.innerHTML=`<tr><td colspan="10" style="text-align:center;padding:30px;color:var(--text-soft)">
        <div style="font-size:28px;margin-bottom:8px">‚úÖ</div>
        <div>Sin vencimientos en este periodo</div>
      </td></tr>`;
      return;
    }

    tbody.innerHTML = filtrados.map(p=>{
      const vtoDate = p.vto ? new Date(p.vto) : null;
      const diffDias = vtoDate ? Math.round((vtoDate-hoy)/86400000) : null;
      let urgencia='', urgColor='';
      if(diffDias!==null){
        if(diffDias<0){  urgencia=`<span style="color:var(--red);font-weight:700">Vencida hace ${Math.abs(diffDias)}d</span>`; urgColor='var(--red)'; }
        else if(diffDias<=7){ urgencia=`<span style="color:var(--red);font-weight:700">En ${diffDias}d üî¥</span>`; urgColor='var(--red)'; }
        else if(diffDias<=30){ urgencia=`<span style="color:var(--amber);font-weight:700">En ${diffDias}d üü†</span>`; urgColor='var(--amber)'; }
        else { urgencia=`<span style="color:var(--text-soft)">En ${diffDias}d</span>`; urgColor=''; }
      }
      return `<tr style="border-bottom:1px solid var(--border);${urgColor?'background:#fff9f9':''}">
        <td style="padding:8px 10px;font-weight:700;color:${urgColor||'var(--navy)'}">
          ${p.vto?fmtD(p.vto):'Sin fecha'}
        </td>
        <td style="padding:8px 6px">${urgencia}</td>
        <td style="padding:8px 6px">${p.proveedor}</td>
        <td style="padding:8px 6px;font-size:11px;color:var(--text-soft)">${p.concepto}</td>
        <td style="padding:8px 6px"><span class="badge b-gray" style="font-size:10px">${p.forma_pago}</span></td>
        <td style="padding:8px 6px;color:var(--text-soft);font-size:11px">${p.proyecto}</td>
        <td style="padding:8px 6px" class="td-mono">${fmt(p.base)}</td>
        <td style="padding:8px 6px" class="td-mono" style="font-weight:700">${fmt(p.total)}</td>
        <td>${bE(p.estado)}</td>
        <td style="padding:8px 6px">
          <button class="btn btn-ghost btn-sm" style="font-size:10px;color:var(--green)" 
            onclick="marcarPagado('${p.tipo}','${p.id}',${p.total.toFixed(2)})">‚úÖ Pagado</button>
        </td>
      </tr>`;
    }).join('');

  }catch(e){
    tbody.innerHTML=`<tr><td colspan="10" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;
  }
}

async function marcarPagado(tipo, id, total){
  if(!confirm(`¬øConfirmar pago de ${fmt(total)}?`)) return;
  try{
    if(tipo==='factura'){
      await sb('facturas','PATCH',{estado:'Pagada',importe_cobrado:total},null,`?id=eq.${id}`);
    } else {
      await sb('compras','PATCH',{estado_pago:'Pagado'},null,`?id=eq.${id}`);
    }
    toast('Pago registrado ‚úÖ');
    loadConciliacion();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// ‚îÄ‚îÄ IMPORTAR CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let movimientosBanco = [];
let conciliacionPendiente = [];

function procesarCSV(){
  const file = document.getElementById('csv-input')?.files[0];
  const formato = document.getElementById('banco-formato')?.value || 'generico';
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = async (e) => {
    const text = e.target.result;
    const preview = document.getElementById('csv-preview');
    if(preview){
      preview.style.display='block';
      preview.textContent = text.split('\n').slice(0,5).join('\n');
    }
    movimientosBanco = parsearCSV(text, formato);
    if(!movimientosBanco.length){
      toast('No se encontraron movimientos en el CSV','error'); return;
    }
    toast(`${movimientosBanco.length} movimientos detectados. Conciliando‚Ä¶`);
    await conciliarMovimientos();
  };
  reader.readAsText(file, 'UTF-8');
}

function parsearCSV(texto, formato){
  const lineas = texto.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  const movimientos = [];
  // Detectar separador
  const sep = texto.includes(';') ? ';' : ',';

  for(let i=1; i<lineas.length; i++){
    const cols = lineas[i].split(sep).map(c=>c.replace(/"/g,'').trim());
    if(cols.length<3) continue;
    let fecha='', concepto='', importe=0;
    try{
      if(formato==='bbva'){
        // BBVA: Fecha, Concepto, Importe, Disponible
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else if(formato==='caixabank'){
        // CaixaBank: Fecha operaci√≥n, Fecha valor, Descripci√≥n, Importe, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[2]||'';
        importe = parseFloat((cols[3]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else if(formato==='santander'){
        // Santander: Fecha, Concepto, Cargo, Abono, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        const cargo = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
        const abono = parseFloat((cols[3]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
        importe = abono - cargo;
      } else if(formato==='sabadell'){
        // Sabadell: Fecha, Descripci√≥n, Importe, Saldo
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      } else {
        // Gen√©rico: fecha, concepto, importe
        fecha   = normalizarFecha(cols[0]);
        concepto= cols[1]||'';
        importe = parseFloat((cols[2]||'0').replace('.','').replace(',','.').replace(/[^0-9.-]/g,''))||0;
      }
      if(fecha && importe<0){ // Solo cargos (pagos salientes)
        movimientos.push({ fecha, concepto, importe: Math.abs(importe) });
      }
    }catch(err){}
  }
  return movimientos;
}

function normalizarFecha(str){
  if(!str) return '';
  // dd/mm/yyyy ‚Üí yyyy-mm-dd
  const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1) return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  // yyyy-mm-dd ya correcto
  const m2 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m2) return str;
  return str;
}

async function conciliarMovimientos(){
  if(!movimientosBanco.length) return;
  // Cargar facturas de compra pendientes
  const facturas = await sbGet('facturas','?tipo_factura=eq.Compra&estado=in.(Pendiente,Parcial,Vencida)');
  const compras  = await sbGet('compras','?estado_pago=in.(Pendiente,Parcial,Vencido)');
  const pendientes = [
    ...facturas.map(f=>({
      id:f.id, tipo:'factura', num:f.num_factura||'‚Äî',
      proveedor:f.proveedor_id||'‚Äî', total:(f.base_imponible||0)*(1+ivaPct(f.iva_pct)/100),
      vto:f.fecha_vencimiento
    })),
    ...compras.map(c=>({
      id:c.id, tipo:'compra', num:'(Compra)',
      proveedor:c.proveedor_id||'‚Äî', total:(c.base_imponible||0)*(1+ivaPct(c.iva_pct)/100),
      vto:c.fecha_vencimiento
    }))
  ];

  conciliacionPendiente = [];
  const resultados = [];

  for(const mov of movimientosBanco){
    // Buscar factura con importe similar (¬±2% tolerancia) y fecha pr√≥xima (¬±15 d√≠as)
    const movFecha = new Date(mov.fecha);
    let mejor = null, mejorScore = 0;

    for(const pend of pendientes){
      // Score por importe
      const diff = Math.abs(mov.importe - pend.total);
      const pctDiff = pend.total>0 ? diff/pend.total : 1;
      if(pctDiff > 0.05) continue; // M√°s del 5% de diferencia ‚Üí descartamos

      // Score por fecha (cuanto m√°s cercana al vencimiento, mejor)
      let scoreFecha = 0.5;
      if(pend.vto){
        const vtoFecha = new Date(pend.vto);
        const diasDiff = Math.abs((movFecha-vtoFecha)/86400000);
        if(diasDiff<=3) scoreFecha=1.0;
        else if(diasDiff<=7) scoreFecha=0.9;
        else if(diasDiff<=15) scoreFecha=0.7;
        else if(diasDiff<=30) scoreFecha=0.5;
        else scoreFecha=0.2;
      }
      const score = (1-pctDiff)*0.6 + scoreFecha*0.4;
      if(score > mejorScore){ mejorScore=score; mejor=pend; }
    }

    const confianza = mejorScore>=0.85?'Alta':mejorScore>=0.65?'Media':mejorScore>=0.4?'Baja':null;
    resultados.push({ mov, factura:mejor, score:mejorScore, confianza });
    if(mejor && confianza && confianza!=='Baja'){
      conciliacionPendiente.push({ movimiento:mov, factura:mejor, confianza });
    }
  }

  // Renderizar resultados
  const tbody = document.getElementById('conc-tbody');
  const resDiv = document.getElementById('conc-resultados');
  const btnAplicar = document.getElementById('btn-aplicar-conc');
  const resCount = document.getElementById('conc-res-count');
  if(resDiv) resDiv.style.display='block';
  const matchCount = resultados.filter(r=>r.factura).length;
  if(resCount) resCount.textContent=`${movimientosBanco.length} movimientos ¬∑ ${matchCount} coincidencias encontradas`;
  if(btnAplicar) btnAplicar.style.display = conciliacionPendiente.length ? '' : 'none';

  tbody.innerHTML = resultados.map((r,i)=>{
    const confianzaColor = r.confianza==='Alta'?'var(--green)':r.confianza==='Media'?'var(--amber)':'var(--red)';
    const diff = r.factura ? (r.mov.importe - r.factura.total) : null;
    return `<tr style="border-bottom:1px solid var(--border);${r.confianza==='Alta'?'background:#f0faf4':r.confianza==='Media'?'background:#fffbf0':''}">
      <td style="padding:8px 10px">
        <input type="checkbox" id="conc-chk-${i}" ${r.confianza&&r.confianza!=='Baja'?'checked':''} 
          data-idx="${i}" style="width:16px;height:16px;cursor:pointer">
      </td>
      <td style="padding:8px 8px;font-size:12px">${fmtD(r.mov.fecha)}</td>
      <td style="padding:8px 8px;font-size:11px;color:var(--text-soft);max-width:200px">${r.mov.concepto}</td>
      <td style="padding:8px 8px" class="td-mono"><strong>${fmt(r.mov.importe)}</strong></td>
      <td style="padding:8px 8px;font-size:11px">${r.factura?`${r.factura.num} (${r.factura.tipo})`:'<span style="color:var(--text-soft)">Sin coincidencia</span>'}</td>
      <td style="padding:8px 8px;font-size:11px">${r.factura?r.factura.proveedor:'‚Äî'}</td>
      <td style="padding:8px 8px;font-size:11px" class="td-mono">${diff!==null?`<span style="color:${Math.abs(diff)<0.01?'var(--green)':'var(--amber)'}">
        ${diff>=0?'+':''}${fmt(diff)}</span>`:'‚Äî'}</td>
      <td style="padding:8px 8px">${r.confianza?`<span style="font-weight:700;color:${confianzaColor}">${r.confianza}</span>`:'<span style="color:var(--text-soft)">‚Äî</span>'}</td>
    </tr>`;
  }).join('');
}

async function aplicarConciliacion(){
  const checkboxes = document.querySelectorAll('[id^="conc-chk-"]:checked');
  const idxsSeleccionados = new Set([...checkboxes].map(cb=>parseInt(cb.dataset.idx)));
  if(!idxsSeleccionados.size){ toast('Selecciona al menos una coincidencia','error'); return; }

  let aplicados = 0;
  conciliacionPendiente.forEach((c,i)=>{
    if(!idxsSeleccionados.has(i)) return; // solo los marcados
  });

  for(let i=0; i<conciliacionPendiente.length; i++){
    if(!idxsSeleccionados.has(i)) continue;
    const c = conciliacionPendiente[i];
    try{
      if(c.factura.tipo==='factura'){
        // Factura de compra ‚Üí estado Pagada
        await sb('facturas','PATCH',{estado:'Pagada',importe_cobrado:c.factura.total},null,`?id=eq.${c.factura.id}`);
        // Actualizar cache local para que el bot√≥n üí≥ se ponga verde inmediatamente
        const fLocal = FC.find(f=>f.id===c.factura.id);
        if(fLocal){ fLocal.estado='Pagada'; fLocal.importe_cobrado=c.factura.total; }
      } else {
        await sb('compras','PATCH',{estado_pago:'Pagado'},null,`?id=eq.${c.factura.id}`);
      }
      aplicados++;
    }catch(e){ console.warn('Error conciliando',e); }
  }
  toast(`‚úÖ ${aplicados} pago(s) marcados como pagados autom√°ticamente`);
  conciliacionPendiente=[];
  document.getElementById('conc-resultados').style.display='none';
  document.getElementById('csv-input').value='';
  document.getElementById('csv-preview').style.display='none';
  loadConciliacion();
  loadFacturas(); // refrescar tabla de facturas para que se vea üí≥ en verde
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTADOR HOLDED - FACTURAS DE COMPRA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let holdedRows = []; // Filas parseadas del archivo Holded

// Poblar selector de proyecto en modal Holded al abrir
function initImportHolded(){
  const sel = document.getElementById('holded-proyecto-default');
  if(!sel) return;
  sel.innerHTML = '<option value="">‚Äî Sin proyecto por defecto ‚Äî</option>'
    + PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
}

// Override openModal para inicializar el importador
const _origOpenModalBase = openModal;
// (openModal ya fue overrideado antes para comparativa ‚Äî encadenamos)
const _prevOpenModal = openModal;
openModal = function(id){
  if(id === 'm-importar-holded') initImportHolded();
  _prevOpenModal(id);
};

async function procesarArchivoHolded(){
  const file = document.getElementById('holded-file')?.files[0];
  if(!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  let rows = [];

  if(ext === 'csv'){
    const text = await file.text();
    rows = parsearCSVHolded(text);
  } else if(ext === 'xlsx' || ext === 'xls'){
    rows = await parsearXLSXHolded(file);
  } else {
    toast('Formato no soportado. Usa Excel (.xlsx) o CSV.', 'error');
    return;
  }

  if(!rows.length){
    toast('No se encontraron facturas en el archivo.', 'error');
    return;
  }

  holdedRows = rows;
  renderPreviewHolded(rows);
}

function parsearCSVHolded(text){
  const lineas = text.split('\n').map(l=>l.trim()).filter(l=>l);
  if(lineas.length < 2) return [];
  const sep = text.includes(';') ? ';' : ',';
  const headers = lineas[0].split(sep).map(h=>h.replace(/"/g,'').trim().toLowerCase());
  const rows = [];
  for(let i=1;i<lineas.length;i++){
    const cols = lineas[i].split(sep).map(c=>c.replace(/"/g,'').trim());
    const obj = {};
    headers.forEach((h,j)=>{ obj[h]=cols[j]||''; });
    rows.push(mapearCamposHolded(obj));
  }
  return rows.filter(r=>r.num_factura);
}

async function parsearXLSXHolded(file){
  // Usar SheetJS si est√° disponible, sino leer como CSV
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        // Intentar parsear como CSV primero (Holded a veces exporta CSV con extensi√≥n xls)
        const text = e.target.result;
        if(typeof text === 'string'){
          resolve(parsearCSVHolded(text));
          return;
        }
        // Si es binario, usar SheetJS
        const data = new Uint8Array(e.target.result);
        if(typeof XLSX !== 'undefined'){
          const wb = XLSX.read(data, {type:'array', cellDates:true});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, {raw:false, dateNF:'yyyy-mm-dd'});
          const rows = json.map(obj=>{
            const lower = {};
            Object.keys(obj).forEach(k=>{ lower[k.toLowerCase().trim()]=String(obj[k]||'').trim(); });
            return mapearCamposHolded(lower);
          }).filter(r=>r.num_factura);
          resolve(rows);
        } else {
          toast('Para archivos .xlsx instala SheetJS. Usa la exportaci√≥n CSV de Holded.','error');
          resolve([]);
        }
      }catch(e){ resolve([]); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// Mapear columnas de Holded a nuestro esquema
// Holded exporta columnas como: N√∫mero, Fecha, Proveedor, Concepto/Descripci√≥n,
// Base imponible, %IVA, Cuota IVA, Total, Fecha vencimiento, Estado
function mapearCamposHolded(obj){
  // Buscar campos con distintos nombres posibles que usa Holded
  const get = (...keys) => {
    for(const k of keys){
      const val = obj[k] || obj[k.toLowerCase()] || obj[k.toUpperCase()];
      if(val && val.toString().trim()) return val.toString().trim();
    }
    return '';
  };

  const num    = get('n√∫mero','numero','number','num. factura','n¬∫ factura','invoice number','factura','doc. number','docnumber','n¬∫','num');
  const fecha  = normalizarFechaHolded(get('fecha','date','fecha emision','fecha emisi√≥n','fecha factura','issue date'));
  const prov   = get('proveedor','supplier','contact','contacto','nombre proveedor','vendor','empresa');
  const conc   = get('concepto','descripci√≥n','descripcion','description','concept','l√≠nea','linea');
  const base   = parseFloat(get('base imponible','base','taxable base','importe','subtotal','base imp.').replace(',','.').replace(/[^0-9.-]/g,''))||0;
  const ivaPctRaw = get('%iva','iva %','tax %','iva','vat','tax rate','tipo iva');
  const ivaPct = ivaPctRaw ? (ivaPctRaw.includes('%')?ivaPctRaw:(ivaPctRaw+'%')) : '21%';
  const total  = parseFloat(get('total','importe total','amount','total factura').replace(',','.').replace(/[^0-9.-]/g,''))||0;
  const vto    = normalizarFechaHolded(get('vencimiento','fecha vencimiento','due date','fecha vto'));
  const estado = mapearEstadoHolded(get('estado','status','estado pago'));

  return { num_factura:num, fecha_emision:fecha, proveedor_id:prov,
           concepto:conc, base_imponible:base, iva_pct:ivaPct,
           total_calculado:total, fecha_vencimiento:vto, estado, tipo_factura:'Compra' };
}

function normalizarFechaHolded(str){
  if(!str) return '';
  // dd/mm/yyyy
  const m1 = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
  if(m1) return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  // yyyy-mm-dd
  const m2 = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m2) return str.substring(0,10);
  // mm/dd/yyyy (formato americano)
  const m3 = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m3) return `${m3[3]}-${m3[1].padStart(2,'0')}-${m3[2].padStart(2,'0')}`;
  return str;
}

function mapearEstadoHolded(s){
  const lower = (s||'').toLowerCase();
  if(lower.includes('pag') || lower.includes('paid') || lower.includes('cobr')) return 'Pagada';
  if(lower.includes('parci') || lower.includes('partial')) return 'Parcial';
  if(lower.includes('venc') || lower.includes('overdue') || lower.includes('expir')) return 'Vencida';
  if(lower.includes('anul') || lower.includes('cancel')) return 'Anulada';
  return 'Pendiente';
}

function renderPreviewHolded(rows){
  const tbody   = document.getElementById('holded-tbody');
  const preview = document.getElementById('holded-preview');
  const resumen = document.getElementById('holded-resumen');
  const btnImp  = document.getElementById('btn-importar-holded');
  const proyDef = document.getElementById('holded-proyecto-default')?.value || '';

  if(preview) preview.style.display = '';
  if(btnImp)  btnImp.style.display  = '';

  // Detectar duplicados (num_factura ya existe en FC)
  const existentes = new Set(FC.map(f=>f.num_factura));

  const totalBase  = rows.reduce((s,r)=>s+r.base_imponible,0);
  const duplicados = rows.filter(r=>existentes.has(r.num_factura)).length;

  if(resumen) resumen.innerHTML =
    `<span style="color:var(--navy)">${rows.length} facturas encontradas</span>
     ¬∑ Base total: <strong>${fmt(totalBase)}</strong>
     ${duplicados ? `¬∑ <span style="color:var(--amber)">‚ö†Ô∏è ${duplicados} ya existen (se omitir√°n)</span>` : '¬∑ <span style="color:var(--green)">‚úÖ Sin duplicados</span>'}`;

  tbody.innerHTML = rows.map((r,i)=>{
    const dup = existentes.has(r.num_factura);
    const provConocido = ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase());
    return `<tr style="${dup?'opacity:0.4;background:#fff5e6':''}">
      <td><input type="checkbox" class="holded-chk" data-idx="${i}" ${dup?'':'checked'} style="width:15px;height:15px"></td>
      <td style="font-size:11px;font-weight:700">${r.num_factura||'‚Äî'}</td>
      <td style="font-size:11px">${fmtD(r.fecha_emision)}</td>
      <td style="font-size:11px;max-width:140px">
        ${provConocido
          ? r.proveedor_id
          : `<span style="color:var(--amber)" title="Proveedor nuevo ‚Äî se crear√°">‚ö†Ô∏è ${r.proveedor_id||'‚Äî'}</span>`}
      </td>
      <td style="font-size:11px;color:var(--text-soft);max-width:160px">${r.concepto||'‚Äî'}</td>
      <td class="td-mono" style="font-size:11px">${fmt(r.base_imponible)}</td>
      <td style="font-size:11px">${r.iva_pct}</td>
      <td class="td-mono" style="font-size:11px;font-weight:700">${fmt(r.total_calculado||r.base_imponible*(1+ivaPct(r.iva_pct)/100))}</td>
      <td style="font-size:11px">${fmtD(r.fecha_vencimiento)}</td>
      <td>${bE(r.estado)}</td>
      <td style="font-size:10px">
        <select class="form-input" style="font-size:10px;padding:2px 4px;min-width:100px" data-proy="${i}">
          <option value="${proyDef}">${proyDef||'Sin proyecto'}</option>
          ${PC.filter(p=>proyDef?p.proyecto_id!==proyDef:true).map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id}</option>`).join('')}
        </select>
      </td>
    </tr>`;
  }).join('');

  // Alertas
  const alertas = document.getElementById('holded-alertas');
  const nuevosProvs = [...new Set(rows
    .filter(r=>r.proveedor_id && !ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase()))
    .map(r=>r.proveedor_id))];
  if(alertas && nuevosProvs.length){
    alertas.innerHTML = `<div class="info-box" style="background:#fff9e6;border-color:var(--amber)">
      ‚ö†Ô∏è <strong>${nuevosProvs.length} proveedores nuevos</strong> detectados ‚Äî se crear√°n autom√°ticamente al importar:<br>
      <span style="font-size:11px;color:var(--text-soft)">${nuevosProvs.join(', ')}</span>
    </div>`;
  } else if(alertas){
    alertas.innerHTML = '';
  }
}

function toggleAllHolded(checked){
  document.querySelectorAll('.holded-chk').forEach(cb=>{ cb.checked = checked; });
}

async function ejecutarImportHolded(){
  const checkboxes = document.querySelectorAll('.holded-chk:checked');
  if(!checkboxes.length){ toast('Selecciona al menos una factura','error'); return; }

  const idxs = [...checkboxes].map(cb=>parseInt(cb.dataset.idx));
  const selRows = idxs.map(i=>holdedRows[i]);
  const proySelects = document.querySelectorAll('[data-proy]');

  const btn = document.getElementById('btn-importar-holded');
  if(btn){ btn.disabled=true; btn.textContent='Importando‚Ä¶'; }

  let ok=0, errores=0;
  const existentes = new Set(FC.map(f=>f.num_factura));

  for(let i=0;i<selRows.length;i++){
    const r = selRows[i];
    const realIdx = idxs[i];
    if(existentes.has(r.num_factura)){ continue; } // Saltar duplicados

    // Obtener proyecto asignado a esta fila
    const proySelect = document.querySelector(`[data-proy="${realIdx}"]`);
    const proyId = proySelect?.value || '';

    // Crear proveedor si no existe
    if(r.proveedor_id){
      const yaExiste = ProvC.some(p=>p.nombre.toLowerCase()===r.proveedor_id.toLowerCase());
      if(!yaExiste){
        try{
          await sbPost('proveedores',{ nombre:r.proveedor_id, tipo:'Proveedor', activo:true });
          ProvC.push({ nombre:r.proveedor_id, tipo:'Proveedor' });
        }catch(e){}
      }
    }

    // Insertar factura
    const d = {
      tipo_factura:   'Compra',
      num_factura:    r.num_factura,
      fecha_emision:  r.fecha_emision || null,
      proveedor_id:   r.proveedor_id || null,
      proyecto_id:    proyId || null,
      concepto:       r.concepto || '',
      base_imponible: r.base_imponible || 0,
      iva_pct:        r.iva_pct || '21%',
      forma_pago:     'Transferencia',
      fecha_vencimiento: r.fecha_vencimiento || null,
      estado:         r.estado || 'Pendiente',
      importe_cobrado: r.estado==='Pagada' ? (r.total_calculado||r.base_imponible) : 0,
    };

    try{
      await sbPost('facturas', d);
      ok++;
    }catch(e){
      errores++;
      console.warn('Error importando', r.num_factura, e.message);
    }
  }

  if(btn){ btn.disabled=false; btn.textContent='üì• Importar facturas seleccionadas'; }

  toast(`‚úÖ ${ok} facturas importadas${errores?` ¬∑ ‚ö†Ô∏è ${errores} errores`:''}`, errores?'warn':'ok');
  closeModal('m-importar-holded');
  document.getElementById('holded-file').value='';
  document.getElementById('holded-preview').style.display='none';
  holdedRows=[];
  await loadFacturas();
  await loadProveedores();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTADOR HOLDED ‚Äî CLIENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let holdedCli = [];

function toggleAll(cls, checked){
  document.querySelectorAll('.' + cls).forEach(cb => cb.checked = checked);
}

async function leerArchivoHolded(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    const text = await file.text();
    return parsearCSVGenerico(text);
  } else {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          if(typeof XLSX !== 'undefined'){
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array', cellDates:true});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, {raw:false, dateNF:'yyyy-mm-dd'});
            resolve(json.map(row => {
              const r = {};
              Object.keys(row).forEach(k => r[k.toLowerCase().trim()] = String(row[k]||'').trim());
              return r;
            }));
          } else { resolve([]); }
        } catch(e){ resolve([]); }
      };
      reader.readAsArrayBuffer(file);
    });
  }
}

function parsearCSVGenerico(text){
  const sep = text.includes(';') ? ';' : ',';
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  if(lines.length < 2) return [];
  const headers = lines[0].split(sep).map(h=>h.replace(/"/g,'').toLowerCase().trim());
  return lines.slice(1).map(line => {
    const cols = line.split(sep).map(c=>c.replace(/"/g,'').trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i]||'');
    return obj;
  }).filter(r => Object.values(r).some(v=>v));
}

function getField(obj, ...keys){
  for(const k of keys){
    const v = obj[k] || obj[k.toLowerCase()] || obj[k.toUpperCase()];
    if(v && String(v).trim()) return String(v).trim();
  }
  return '';
}

function mapearFormaPago(s){
  const l = (s||'').toLowerCase();
  if(l.includes('transfer')) return 'Transferencia';
  if(l.includes('efect') || l.includes('cash')) return 'Efectivo';
  if(l.includes('domic')) return 'Domiciliaci√≥n';
  if(l.includes('confirm')) return 'Confirming';
  if(l.includes('cheque') || l.includes('check')) return 'Cheque';
  if(l.includes('giro') || l.includes('30')) return 'Giro 30 d√≠as';
  if(l.includes('60')) return 'Giro 60 d√≠as';
  if(l.includes('90')) return 'Giro 90 d√≠as';
  if(l.includes('120')) return 'Giro 120 d√≠as';
  return 'Transferencia';
}

async function procesarImportClientes(){
  const file = document.getElementById('cli-holded-file')?.files[0];
  if(!file) return;
  const rows = await leerArchivoHolded(file);
  if(!rows.length){ toast('No se encontraron datos en el archivo','error'); return; }

  holdedCli = rows.map(r => ({
    nombre:    getField(r,'nombre','name','raz√≥n social','razon social','empresa','company','client','cliente'),
    cif:       getField(r,'cif','nif','tax id','tax number','vat','cif/nif','nif/cif','n√∫mero fiscal','num. fiscal'),
    telefono:  getField(r,'tel√©fono','telefono','phone','tel','m√≥vil','movil','mobile'),
    email:     getField(r,'email','e-mail','correo','mail'),
    direccion: getField(r,'direcci√≥n','direccion','address','domicilio','calle','dir.'),
    forma_pago:mapearFormaPago(getField(r,'forma pago','forma de pago','payment method','m√©todo pago','vencimiento')),
    notas:     getField(r,'notas','notes','observaciones','comentarios'),
  })).filter(r => r.nombre);

  renderImportPreview('cli', holdedCli, CC, 'nombre',
    ['nombre','cif','telefono','email','direccion','forma_pago'],
    ['Nombre','CIF/NIF','Tel√©fono','Email','Direcci√≥n','Forma pago']);
}

function renderImportPreview(prefix, rows, existing, matchKey, fields, labels){
  const existSet = new Set(existing.map(e => (e[matchKey]||'').toLowerCase().trim()));
  const preview  = document.getElementById(`${prefix}-import-preview`);
  const resumen  = document.getElementById(`${prefix}-import-resumen`);
  const tbody    = document.getElementById(`${prefix}-import-tbody`);
  const btn      = document.getElementById(`btn-import-${prefix==='cli'?'clientes':'proveedores'}`);

  if(preview) preview.style.display = '';
  if(btn)     btn.style.display     = '';

  const nuevos = rows.filter(r => !existSet.has((r[matchKey]||'').toLowerCase().trim())).length;
  const dups   = rows.length - nuevos;

  if(resumen) resumen.innerHTML =
    `<span style="color:var(--navy)">${rows.length} registros en el archivo</span>
     ¬∑ <span style="color:var(--green)">‚úÖ ${nuevos} nuevos</span>
     ${dups ? `¬∑ <span style="color:var(--amber)">‚ö†Ô∏è ${dups} ya existen (marcados en naranja ‚Äî se omitir√°n)</span>` : ''}`;

  tbody.innerHTML = rows.map((r,i) => {
    const dup = existSet.has((r[matchKey]||'').toLowerCase().trim());
    const tds = fields.map(f => `<td style="font-size:11px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r[f]||'‚Äî'}</td>`).join('');
    return `<tr style="${dup?'background:#fff9e6;opacity:0.6':''}">
      <td><input type="checkbox" class="${prefix}-chk" data-idx="${i}" ${dup?'':'checked'} style="width:15px;height:15px"></td>
      ${tds}
      <td style="font-size:10px;font-weight:700;color:${dup?'var(--amber)':'var(--green)'}">
        ${dup ? '‚ö†Ô∏è Ya existe' : 'üÜï Nuevo'}
      </td>
    </tr>`;
  }).join('');
}

async function ejecutarImportClientes(){
  const checked = [...document.querySelectorAll('.cli-chk:checked')];
  if(!checked.length){ toast('Selecciona al menos un cliente','error'); return; }
  const btn = document.getElementById('btn-import-clientes');
  if(btn){ btn.disabled=true; btn.textContent='Importando‚Ä¶'; }

  const existSet = new Set(CC.map(c=>(c.nombre||'').toLowerCase().trim()));
  let ok=0, omitidos=0;

  for(const cb of checked){
    const r = holdedCli[parseInt(cb.dataset.idx)];
    if(existSet.has((r.nombre||'').toLowerCase().trim())){ omitidos++; continue; }
    try{
      const d = { ...r, cliente_id: genId('CLI', CC, 'cliente_id'), tipo:'Cliente', activo:true };
      await sbPost('clientes', d);
      CC.push(d);
      ok++;
    } catch(e){ console.warn('Error cliente', r.nombre, e.message); }
  }

  if(btn){ btn.disabled=false; btn.textContent='üë§ Importar clientes seleccionados'; }
  toast(`‚úÖ ${ok} clientes importados${omitidos?` ¬∑ ${omitidos} ya exist√≠an (omitidos)`:''}` );
  closeModal('m-import-clientes');
  document.getElementById('cli-holded-file').value='';
  document.getElementById('cli-import-preview').style.display='none';
  holdedCli=[];
  await loadClientes();
  populateSelects();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTADOR HOLDED ‚Äî PROVEEDORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let holdedProv = [];

async function procesarImportProveedores(){
  const file = document.getElementById('prov-holded-file')?.files[0];
  if(!file) return;
  const rows = await leerArchivoHolded(file);
  if(!rows.length){ toast('No se encontraron datos en el archivo','error'); return; }

  holdedProv = rows.map(r => ({
    nombre:      getField(r,'nombre','name','raz√≥n social','razon social','empresa','company','proveedor','supplier','vendor'),
    cif:         getField(r,'cif','nif','tax id','vat','cif/nif','n√∫mero fiscal'),
    telefono:    getField(r,'tel√©fono','telefono','phone','tel','m√≥vil','movil'),
    email:       getField(r,'email','e-mail','correo','mail'),
    especialidad:getField(r,'especialidad','specialty','categor√≠a','categoria','tipo servicio','servicio'),
    forma_pago:  mapearFormaPago(getField(r,'forma pago','forma de pago','payment method','vencimiento')),
    iban:        getField(r,'iban','cuenta','account','bank account','n√∫mero cuenta'),
    notas:       getField(r,'notas','notes','observaciones','comentarios'),
    tipo:        'Proveedor',
    activo:      true,
  })).filter(r => r.nombre);

  renderImportPreview('prov', holdedProv, ProvC, 'nombre',
    ['nombre','cif','telefono','email','especialidad','forma_pago','iban'],
    ['Nombre','CIF/NIF','Tel√©fono','Email','Especialidad','Forma pago','IBAN']);
}

async function ejecutarImportProveedores(){
  const checked = [...document.querySelectorAll('.prov-chk:checked')];
  if(!checked.length){ toast('Selecciona al menos un proveedor','error'); return; }
  const btn = document.getElementById('btn-import-proveedores');
  if(btn){ btn.disabled=true; btn.textContent='Importando‚Ä¶'; }

  const existSet = new Set(ProvC.map(p=>(p.nombre||'').toLowerCase().trim()));
  let ok=0, omitidos=0;

  for(const cb of checked){
    const r = holdedProv[parseInt(cb.dataset.idx)];
    if(existSet.has((r.nombre||'').toLowerCase().trim())){ omitidos++; continue; }
    try{
      const d = { ...r, proveedor_id: genId('PRV', ProvC, 'proveedor_id') };
      await sbPost('proveedores', d);
      ProvC.push(d);
      ok++;
    } catch(e){ console.warn('Error proveedor', r.nombre, e.message); }
  }

  if(btn){ btn.disabled=false; btn.textContent='üè≠ Importar proveedores seleccionados'; }
  toast(`‚úÖ ${ok} proveedores importados${omitidos?` ¬∑ ${omitidos} ya exist√≠an (omitidos)`:''}` );
  closeModal('m-import-proveedores');
  document.getElementById('prov-holded-file').value='';
  document.getElementById('prov-import-preview').style.display='none';
  holdedProv=[];
  await loadProveedores();
  populateSelects();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RR.HH. ¬∑ N√ìMINAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let TrabC = [];

async function loadRRHH(){
  const tbody = document.getElementById('rrhh-tbody');
  if(!tbody) return;
  tbody.innerHTML = '<tr><td colspan="12" class="loading">Cargando‚Ä¶</td></tr>';
  try{
    TrabC = await sbGet('trabajadores_rrhh','?order=nombre.asc');
    // Sincronizar lista activos con TRABAJADORES global
    const activos = TrabC.filter(t=>t.estado==='Activo').map(t=>t.nombre).filter(Boolean);
    if(activos.length){ TRABAJADORES = activos; populateTrabajadores(); }
    renderRRHH();
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="12" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}<br><small>Ejecuta el SQL de creaci√≥n de tabla primero</small></td></tr>`;
  }
}

function renderRRHH(){
  const tbody = document.getElementById('rrhh-tbody');
  if(!tbody) return;
  const q = (document.getElementById('search-rrhh')?.value||'').toLowerCase();
  const items = q ? TrabC.filter(t=>(t.nombre||'').toLowerCase().includes(q)) : TrabC;

  // KPIs y resumen
  const activos = TrabC.filter(t=>t.estado==='Activo');
  let sumBruto=0, sumIrpf=0, sumSsTrab=0, sumNeto=0, sumSsEmp=0, sumPagasAnual=0, sumBonusAnual=0;
  activos.forEach(t=>{
    const bruto=t.salario_bruto||0;
    const irpfAmt=bruto*(t.irpf_pct||0)/100;
    const ssTrabAmt=bruto*(t.ss_trab_pct||6.35)/100;
    const neto=bruto-irpfAmt-ssTrabAmt;
    const ssEmpAmt=bruto*(t.ss_emp_pct||30)/100;
    sumBruto+=bruto; sumIrpf+=irpfAmt; sumSsTrab+=ssTrabAmt;
    sumNeto+=neto; sumSsEmp+=ssEmpAmt;
    // Pagas extra: coste bruto √ó num pagas
    sumPagasAnual+=(t.paga_extra||0)*(t.num_pagas_extra||0);
    // Bonus anual
    let bonusTrab=0;
    if(t.bonus_modo==='puntual' || (!t.bonus_modo && t.bonus_pagos_json)){
      // Pagos puntuales: sumar todos
      const pagos=Array.isArray(t.bonus_pagos_json)?t.bonus_pagos_json:(t.bonus_pagos_json?JSON.parse(t.bonus_pagos_json):[]);
      bonusTrab=pagos.reduce((s,p)=>s+(p.importe||0)*(1+(p.iva||0)/100),0);
    } else {
      // Recurrente
      const periodoMult={mensual:12,trimestral:4,anual:1};
      const mult=periodoMult[t.bonus_periodo||'mensual']||12;
      bonusTrab=(t.bonus||0)*(1+(t.bonus_iva_pct||0)/100)*mult;
    }
    sumBonusAnual+=bonusTrab;
  });
  const sumTotal=sumBruto+sumSsEmp;
  const sumAnualTotal=sumTotal*12+sumPagasAnual+sumBonusAnual;
  document.getElementById('rrhh-kpi-total').textContent=activos.length;
  document.getElementById('rrhh-kpi-coste').textContent=fmt(sumTotal);
  document.getElementById('rrhh-kpi-ss').textContent=fmt(sumSsEmp);
  document.getElementById('rrhh-kpi-anual').textContent=fmt(sumAnualTotal);
  document.getElementById('rrhh-sum-bruto').textContent=fmt(sumBruto);
  document.getElementById('rrhh-sum-irpf').textContent=fmt(sumIrpf);
  document.getElementById('rrhh-sum-ss-trab').textContent=fmt(sumSsTrab);
  document.getElementById('rrhh-sum-neto').textContent=fmt(sumNeto);
  document.getElementById('rrhh-sum-ss-emp').textContent=fmt(sumSsEmp);
  document.getElementById('rrhh-sum-total').textContent=fmt(sumTotal);
  document.getElementById('rrhh-sum-pagas')?.textContent && (document.getElementById('rrhh-sum-pagas').textContent=sumPagasAnual>0?fmt(sumPagasAnual):'‚Äî');
  document.getElementById('rrhh-sum-bonus')?.textContent && (document.getElementById('rrhh-sum-bonus').textContent=sumBonusAnual>0?fmt(sumBonusAnual):'‚Äî');
  document.getElementById('rrhh-sum-anual').textContent=fmt(sumAnualTotal);
  document.getElementById('rrhh-count').textContent=TrabC.length+' trabajadores';

  if(!items.length){
    tbody.innerHTML='<tr><td colspan="12"><div class="empty"><div class="empty-icon">üë§</div><div class="empty-text">Sin trabajadores registrados</div><button class="btn btn-primary btn-sm" onclick="abrirModalTrabajador()">Ôºã A√±adir</button></div></td></tr>';
    return;
  }
  tbody.innerHTML = items.map(t=>{
    const bruto=t.salario_bruto||0;
    const irpfAmt=bruto*(t.irpf_pct||0)/100;
    const ssTrabAmt=bruto*(t.ss_trab_pct||6.35)/100;
    const neto=bruto-irpfAmt-ssTrabAmt;
    const ssEmpAmt=bruto*(t.ss_emp_pct||30)/100;
    const total=bruto+ssEmpAmt;
    const estadoColor=t.estado==='Activo'?'b-green':t.estado==='Baja temporal'?'b-amber':'b-gray';
    return `<tr data-search="${(t.nombre||'').toLowerCase()}">
      <td><strong>${t.nombre||'‚Äî'}</strong>${t.categoria?`<div style="font-size:11px;color:var(--text-soft)">${t.categoria}</div>`:''}</td>
      <td class="td-mono" style="color:var(--text-soft)">${t.dni||'‚Äî'}</td>
      <td style="font-size:11px">${t.categoria||'‚Äî'}</td>
      <td class="td-mono" style="font-size:11px">${fmtD(t.fecha_alta)}</td>
      <td class="td-mono" style="font-weight:700">${fmt(bruto)}</td>
      <td class="td-mono">${t.irpf_pct||0}%</td>
      <td class="td-mono" style="color:var(--amber)">${fmt(ssTrabAmt)}</td>
      <td class="td-mono" style="color:var(--green);font-weight:700">${fmt(neto)}</td>
      <td class="td-mono" style="color:var(--amber)">${fmt(ssEmpAmt)}</td>
      <td class="td-mono" style="color:var(--red);font-weight:700">${fmt(total)}</td>
      <td><span class="badge ${estadoColor}">${t.estado||'‚Äî'}</span></td>
      <td><div class="td-actions">
        <button class="btn btn-ghost btn-icon btn-sm" onclick="editTrabajador('${t.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon btn-sm" onclick="confirmDelete('trabajadores_rrhh','${t.id}','${(t.nombre||'').replace(/'/g,'')}')">üóë</button>
      </div></td>
    </tr>`;
  }).join('');
}

function filtrarRRHH(){ renderRRHH(); }

let bonusPagos = []; // array de pagos puntuales en memoria del modal
let bonusModo = 'recurrente'; // 'recurrente' | 'puntual'

function setModoBonus(modo){
  bonusModo = modo;
  document.getElementById('bonus-modo-recurrente').style.display = modo==='recurrente' ? '' : 'none';
  document.getElementById('bonus-modo-puntual').style.display = modo==='puntual' ? '' : 'none';
  document.getElementById('btn-modo-recurrente').className = 'btn btn-sm ' + (modo==='recurrente'?'btn-primary':'btn-ghost');
  document.getElementById('btn-modo-puntual').className = 'btn btn-sm ' + (modo==='puntual'?'btn-primary':'btn-ghost');
  calcNomina();
}

function addBonusPago(){
  const concepto = document.getElementById('bp-concepto').value.trim();
  const fecha = document.getElementById('bp-fecha').value;
  const importe = parseFloat(document.getElementById('bp-importe').value)||0;
  const iva = parseFloat(document.getElementById('bp-iva').value)||0;
  if(!concepto){ toast('Escribe un concepto','error'); return; }
  if(importe<=0){ toast('Importe no v√°lido','error'); return; }
  bonusPagos.push({ concepto, fecha, importe, iva });
  document.getElementById('bp-concepto').value='';
  document.getElementById('bp-fecha').value='';
  document.getElementById('bp-importe').value='';
  document.getElementById('bp-iva').value='0';
  renderBonusPagos();
  calcNomina();
}

function removeBonusPago(idx){
  bonusPagos.splice(idx,1);
  renderBonusPagos();
  calcNomina();
}

function renderBonusPagos(){
  const lista = document.getElementById('bp-lista');
  if(!lista) return;
  if(!bonusPagos.length){
    lista.innerHTML='<div style="text-align:center;color:var(--text-soft);padding:8px;font-size:11px">Sin pagos registrados ‚Äî a√±ade con el bot√≥n Ôºã</div>';
    return;
  }
  lista.innerHTML = bonusPagos.map((p,i)=>{
    const total = p.importe*(1+p.iva/100);
    return `<div style="display:grid;grid-template-columns:2fr 1.2fr 1fr 1fr auto;gap:6px;align-items:center;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="font-weight:600">${p.concepto}</span>
      <span style="color:var(--text-soft)">${p.fecha?fmtD(p.fecha):'Sin fecha'}</span>
      <span class="td-mono">${fmt(p.importe)}</span>
      <span class="td-mono" style="color:var(--copper)">${p.iva>0?fmt(total)+' ('+p.iva+'% IVA)':'Exento'}</span>
      <button class="btn btn-danger btn-icon btn-sm" onclick="removeBonusPago(${i})" style="padding:2px 6px;font-size:11px">üóë</button>
    </div>`;
  }).join('');
}

function calcNomina(){
  const bruto=parseFloat(document.getElementById('trab-bruto')?.value)||0;
  const irpf=parseFloat(document.getElementById('trab-irpf')?.value)||0;
  const ssTrab=parseFloat(document.getElementById('trab-ss-trab')?.value)||6.35;
  const ssEmp=parseFloat(document.getElementById('trab-ss-emp')?.value)||30;
  const irpfAmt=bruto*irpf/100;
  const ssTrabAmt=bruto*ssTrab/100;
  const neto=bruto-irpfAmt-ssTrabAmt;
  const ssEmpAmt=bruto*ssEmp/100;
  const total=bruto+ssEmpAmt;

  // Paga extra
  const pagaExtra=parseFloat(document.getElementById('trab-paga-extra')?.value)||0;
  const numPagas=parseInt(document.getElementById('trab-num-pagas')?.value)||0;
  const pagaIrpf=parseFloat(document.getElementById('trab-paga-irpf')?.value)||0;
  const pagaNetoUnit=pagaExtra - pagaExtra*pagaIrpf/100;
  const pagaAnual=pagaExtra*numPagas; // coste bruto empresa

  // Bonus / compensaci√≥n
  let bonusAnual=0;
  if(bonusModo==='recurrente'){
    const bonus=parseFloat(document.getElementById('trab-bonus')?.value)||0;
    const bonusIvaPct=parseFloat(document.getElementById('trab-bonus-iva')?.value)||0;
    const bonusConIva=bonus*(1+bonusIvaPct/100);
    const periodoMult={mensual:12,trimestral:4,anual:1};
    const mult=periodoMult[document.getElementById('trab-bonus-periodo')?.value||'mensual']||12;
    bonusAnual=bonusConIva*mult;
    const calcBonusEl=document.getElementById('trab-calc-bonus');
    if(calcBonusEl) calcBonusEl.textContent=bonus>0?fmt(bonusAnual)+'/a√±o'+(bonusIvaPct>0?` (${bonusIvaPct}% IVA)`:'  exento'):'‚Äî';
  } else {
    // Pagos puntuales: suma de todos con IVA
    bonusAnual=bonusPagos.reduce((s,p)=>s+p.importe*(1+p.iva/100),0);
    const el=document.getElementById('trab-calc-bonus-puntual');
    if(el) el.textContent=bonusAnual>0?fmt(bonusAnual):'‚Äî';
  }

  // Coste anual total
  const costoMensualEmp=total;
  const costoAnualNom=costoMensualEmp*12;
  const costoAnualTotal=costoAnualNom+pagaAnual+bonusAnual;

  // Actualizar UI
  document.getElementById('trab-calc-bruto').textContent=bruto>0?fmt(bruto):'‚Äî';
  document.getElementById('trab-calc-neto').textContent=bruto>0?fmt(neto):'‚Äî';
  document.getElementById('trab-calc-ss-emp').textContent=bruto>0?fmt(ssEmpAmt):'‚Äî';
  document.getElementById('trab-calc-total').textContent=bruto>0?fmt(total):'‚Äî';
  const pagaEl=document.getElementById('trab-calc-paga-neto');
  if(pagaEl) pagaEl.textContent=(pagaExtra>0&&numPagas>0)?fmt(pagaNetoUnit)+' √ó '+numPagas:'‚Äî';
  document.getElementById('trab-calc-anual-nom').textContent=bruto>0?fmt(costoAnualNom):'‚Äî';
  document.getElementById('trab-calc-anual-pagas').textContent=(pagaExtra>0&&numPagas>0)?fmt(pagaAnual):'‚Äî';
  const anualBonusEl=document.getElementById('trab-calc-anual-bonus');
  if(anualBonusEl) anualBonusEl.textContent=bonusAnual>0?fmt(bonusAnual):'‚Äî';
  document.getElementById('trab-calc-anual-total').textContent=bruto>0?fmt(costoAnualTotal):'‚Äî';
}

function abrirModalTrabajador(){
  document.getElementById('trab-id').value='';
  document.getElementById('m-trab-title').textContent='üë§ Nuevo trabajador';
  ['trab-nombre','trab-dni','trab-tel','trab-email','trab-dir','trab-nss','trab-iban','trab-notas','trab-bruto','trab-paga-extra','trab-bonus'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('trab-irpf').value='15';
  document.getElementById('trab-ss-trab').value='6.35';
  document.getElementById('trab-ss-emp').value='30';
  document.getElementById('trab-paga-irpf').value='15';
  document.getElementById('trab-num-pagas').value='2';
  document.getElementById('trab-bonus-iva').value='0';
  document.getElementById('trab-bonus-periodo').value='mensual';
  document.getElementById('trab-alta').value=new Date().toISOString().split('T')[0];
  document.getElementById('trab-estado').value='Activo';
  bonusPagos=[]; bonusModo='recurrente';
  setModoBonus('recurrente');
  renderBonusPagos();
  calcNomina();
  openModal('m-trabajador');
}

function editTrabajador(id){
  const t=TrabC.find(x=>x.id==id); if(!t) return;
  document.getElementById('trab-id').value=t.id;
  document.getElementById('m-trab-title').textContent='‚úèÔ∏è Editar trabajador';
  document.getElementById('trab-nombre').value=t.nombre||'';
  document.getElementById('trab-dni').value=t.dni||'';
  document.getElementById('trab-tel').value=t.telefono||'';
  document.getElementById('trab-email').value=t.email||'';
  document.getElementById('trab-dir').value=t.direccion||'';
  document.getElementById('trab-nss').value=t.num_ss||'';
  document.getElementById('trab-iban').value=t.iban||'';
  document.getElementById('trab-categoria').value=t.categoria||'Oficial 1¬™';
  document.getElementById('trab-contrato').value=t.tipo_contrato||'Indefinido';
  document.getElementById('trab-alta').value=t.fecha_alta||'';
  document.getElementById('trab-estado').value=t.estado||'Activo';
  document.getElementById('trab-bruto').value=t.salario_bruto||'';
  document.getElementById('trab-irpf').value=t.irpf_pct||15;
  document.getElementById('trab-ss-trab').value=t.ss_trab_pct||6.35;
  document.getElementById('trab-ss-emp').value=t.ss_emp_pct||30;
  document.getElementById('trab-paga-extra').value=t.paga_extra||'';
  document.getElementById('trab-num-pagas').value=t.num_pagas_extra??2;
  document.getElementById('trab-paga-irpf').value=t.paga_extra_irpf||15;
  document.getElementById('trab-bonus').value=t.bonus||'';
  document.getElementById('trab-bonus-periodo').value=t.bonus_periodo||'mensual';
  document.getElementById('trab-bonus-iva').value=t.bonus_iva_pct??0;
  // Cargar modo bonus y pagos puntuales
  bonusPagos = Array.isArray(t.bonus_pagos_json) ? t.bonus_pagos_json : (t.bonus_pagos_json ? JSON.parse(t.bonus_pagos_json) : []);
  const modoGuardado = t.bonus_modo || (bonusPagos.length>0 ? 'puntual' : 'recurrente');
  bonusModo = modoGuardado;
  setModoBonus(modoGuardado);
  renderBonusPagos();
  document.getElementById('trab-notas').value=t.notas||'';
  calcNomina();
  openModal('m-trabajador');
}

async function saveTrabajador(){
  const nombre=document.getElementById('trab-nombre').value.trim();
  if(!nombre){ toast('El nombre es obligatorio','error'); return; }
  const id=document.getElementById('trab-id').value;
  const d={
    nombre,
    dni:       document.getElementById('trab-dni').value||null,
    telefono:  document.getElementById('trab-tel').value||null,
    email:     document.getElementById('trab-email').value||null,
    direccion: document.getElementById('trab-dir').value||null,
    num_ss:    document.getElementById('trab-nss').value||null,
    iban:      document.getElementById('trab-iban').value||null,
    categoria: document.getElementById('trab-categoria').value,
    tipo_contrato: document.getElementById('trab-contrato').value,
    fecha_alta: document.getElementById('trab-alta').value||null,
    estado:    document.getElementById('trab-estado').value,
    salario_bruto: parseFloat(document.getElementById('trab-bruto').value)||null,
    irpf_pct:  parseFloat(document.getElementById('trab-irpf').value)||15,
    ss_trab_pct: parseFloat(document.getElementById('trab-ss-trab').value)||6.35,
    ss_emp_pct: parseFloat(document.getElementById('trab-ss-emp').value)||30,
    paga_extra: parseFloat(document.getElementById('trab-paga-extra').value)||null,
    num_pagas_extra: parseInt(document.getElementById('trab-num-pagas').value)||0,
    paga_extra_irpf: parseFloat(document.getElementById('trab-paga-irpf').value)||15,
    bonus: bonusModo==='recurrente' ? (parseFloat(document.getElementById('trab-bonus').value)||null) : null,
    bonus_periodo: bonusModo==='recurrente' ? document.getElementById('trab-bonus-periodo').value : null,
    bonus_iva_pct: bonusModo==='recurrente' ? (parseFloat(document.getElementById('trab-bonus-iva').value)||0) : 0,
    bonus_modo: bonusModo,
    bonus_pagos_json: bonusModo==='puntual' ? JSON.stringify(bonusPagos) : null,
    notas:     document.getElementById('trab-notas').value||null,
  };
  try{
    if(id){ await sb('trabajadores_rrhh','PATCH',d,null,`?id=eq.${id}`); toast('Trabajador actualizado ‚úÖ'); }
    else  { await sbPost('trabajadores_rrhh',d); toast('Trabajador guardado ‚úÖ'); }

    // ‚îÄ‚îÄ Sincronizar nombre con lista global TRABAJADORES ‚îÄ‚îÄ
    try{
      const todosRRHH = await sbGet('trabajadores_rrhh','?estado=eq.Activo&order=nombre.asc');
      const nombresActivos = todosRRHH.map(t=>t.nombre).filter(Boolean);
      TRABAJADORES = nombresActivos;
      // Guardar como lista separada por comas (mismo formato que usa la p√°gina Listas)
      await upsertConfig('trabajadores', nombresActivos.join(','));
      populateTrabajadores();
    }catch(syncErr){
      // Si falla la sincronizaci√≥n no bloqueamos ‚Äî el trabajador ya se guard√≥
      console.warn('Sincronizaci√≥n lista trabajadores:', syncErr.message);
      // Actualizar solo en memoria
      if(!TRABAJADORES.includes(nombre)) TRABAJADORES.push(nombre);
      populateTrabajadores();
    }

    closeModal('m-trabajador');
    await loadRRHH();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENDA ¬∑ AVISOS Y NOTIFICACIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let AgC = [];
let agendaTimer = null;

const AG_TIPOS = {
  'Reuni√≥n':'ü§ù','Visita obra':'üèó','Llamada':'üìû','Entrega':'üì¶',
  'Pago':'üí∂','Recordatorio':'üìå','Otro':'üìã'
};

async function loadAgenda(){
  const tbody = document.getElementById('ag-tbody');
  if(!tbody) return;
  tbody.innerHTML = '<tr><td colspan="9" class="loading">Cargando‚Ä¶</td></tr>';
  try{
    AgC = await sbGet('agenda','?order=fecha.asc,hora.asc');
    renderAgenda();
    actualizarBadgeAgenda();
    // Poblar proyecto en modal
    const sel = document.getElementById('ag-proyecto');
    if(sel){
      if(!PC.length) PC = await sbGet('proyectos').catch(()=>[]);
      sel.innerHTML = '<option value="">‚Äî Sin proyecto ‚Äî</option>'+
        PC.map(p=>`<option value="${p.proyecto_id}">${p.proyecto_id} ¬∑ ${p.nombre}</option>`).join('');
    }
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Error: ${e.message}</td></tr>`;
  }
}

function renderAgenda(){
  const tbody = document.getElementById('ag-tbody');
  if(!tbody) return;
  const filtro = document.getElementById('ag-filtro')?.value || 'todos';
  const hoy = new Date().toISOString().split('T')[0];
  const ahora = new Date();

  // Calcular fin de semana
  const finSemana = new Date(ahora);
  finSemana.setDate(ahora.getDate() + 7);
  const finSemanaStr = finSemana.toISOString().split('T')[0];

  let items = [...AgC];

  // Filtrar
  if(filtro === 'pendiente') items = items.filter(a => a.estado !== 'Completado' && a.fecha >= hoy);
  else if(filtro === 'hoy') items = items.filter(a => a.fecha === hoy);
  else if(filtro === 'esta_semana') items = items.filter(a => a.fecha >= hoy && a.fecha <= finSemanaStr);
  else if(filtro === 'completado') items = items.filter(a => a.estado === 'Completado');

  // KPIs
  const pendientes = AgC.filter(a => a.estado !== 'Completado' && a.fecha >= hoy).length;
  const vencidos = AgC.filter(a => a.estado !== 'Completado' && a.fecha < hoy).length;
  const mesActual = new Date().toISOString().slice(0,7);
  const completados = AgC.filter(a => a.estado === 'Completado' && (a.fecha||'').startsWith(mesActual)).length;
  document.getElementById('ag-kpi-pendientes').textContent = pendientes;
  document.getElementById('ag-kpi-vencidos').textContent = vencidos;
  document.getElementById('ag-kpi-completados').textContent = completados;

  // Secci√≥n HOY
  const cardHoy = document.getElementById('ag-card-hoy');
  const listHoy = document.getElementById('ag-hoy-list');
  const itemsHoy = AgC.filter(a => a.fecha === hoy && a.estado !== 'Completado');
  if(itemsHoy.length > 0 && cardHoy){
    cardHoy.style.display = '';
    listHoy.innerHTML = itemsHoy.map(a => `
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:20px">${AG_TIPOS[a.tipo]||'üìã'}</span>
        <div style="flex:1">
          <div style="font-weight:700;font-size:13px">${a.descripcion}</div>
          <div style="font-size:11px;color:var(--text-soft)">${a.hora?'‚è∞ '+a.hora:''} ${a.proyecto_id?'¬∑ üìÅ '+a.proyecto_id:''}</div>
        </div>
        ${a.prioridad==='alta'?'<span class="badge b-red">üî¥ Alta</span>':''}
        <button class="btn btn-green btn-sm" onclick="completarAgenda('${a.id}')">‚úÖ Hecho</button>
      </div>`).join('');
  } else if(cardHoy){
    cardHoy.style.display = 'none';
  }

  // Tabla principal
  if(!items.length){
    tbody.innerHTML='<tr><td colspan="9"><div class="empty"><div class="empty-icon">üîî</div><div class="empty-text">Sin avisos'+
      (filtro!=='todos'?' con este filtro':'')+'</div><button class="btn btn-primary btn-sm" onclick="openModal(\'m-agenda\')">Ôºã Crear aviso</button></div></td></tr>';
    return;
  }

  tbody.innerHTML = items.map(a => {
    const esVencido = a.fecha < hoy && a.estado !== 'Completado';
    const esHoy = a.fecha === hoy;
    const rowStyle = esVencido ? 'background:#fff5f5' : esHoy ? 'background:#fffbf0' : '';
    const prioBadge = a.prioridad==='alta'?'<span class="badge b-red">Alta</span>':
                      a.prioridad==='baja'?'<span class="badge b-gray">Baja</span>':
                      '<span class="badge b-blue">Normal</span>';
    const estadoBadge = a.estado==='Completado'?'<span class="badge b-green">‚úÖ Hecho</span>':
                        esVencido?'<span class="badge b-red">‚ö†Ô∏è Vencido</span>':
                        esHoy?'<span class="badge b-amber">üìÖ Hoy</span>':
                        '<span class="badge b-gray">Pendiente</span>';
    return `<tr style="${rowStyle}" data-search="${(a.descripcion+a.tipo+a.proyecto_id).toLowerCase()}">
      <td style="font-size:18px;text-align:center">${AG_TIPOS[a.tipo]||'üìã'}</td>
      <td><strong>${a.descripcion||'‚Äî'}</strong>${a.notas?`<div style="font-size:11px;color:var(--text-soft)">${a.notas}</div>`:''}</td>
      <td class="td-mono">${fmtD(a.fecha)}</td>
      <td class="td-mono" style="font-weight:${a.hora?'700':'400'};color:${a.hora?'var(--navy)':'var(--text-soft)'}">${a.hora||'‚Äî'}</td>
      <td>${a.tipo||'‚Äî'}</td>
      <td class="td-mono" style="color:var(--text-soft)">${a.proyecto_id||'‚Äî'}</td>
      <td>${prioBadge}</td>
      <td>${estadoBadge}</td>
      <td><div class="td-actions">
        ${a.estado!=='Completado'?`<button class="btn btn-green btn-icon btn-sm" title="Completar" onclick="completarAgenda('${a.id}')">‚úÖ</button>`:''}
        <button class="btn btn-ghost btn-icon btn-sm" title="Editar" onclick="editAgenda('${a.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon btn-sm" title="Eliminar" onclick="confirmDelete('agenda','${a.id}','${(a.descripcion||'').replace(/'/g,'')}')">üóë</button>
      </div></td>
    </tr>`;
  }).join('');
}

function openAgendaModal(){
  document.getElementById('ag-id').value='';
  document.getElementById('ag-desc').value='';
  document.getElementById('ag-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('ag-hora').value='';
  document.getElementById('ag-tipo').value='Reuni√≥n';
  document.getElementById('ag-prioridad').value='normal';
  document.getElementById('ag-notas').value='';
  document.getElementById('ag-notif').checked=true;
  openModal('m-agenda');
}

function editAgenda(id){
  const a = AgC.find(x=>x.id==id);
  if(!a) return;
  document.getElementById('ag-id').value=a.id;
  document.getElementById('ag-desc').value=a.descripcion||'';
  document.getElementById('ag-fecha').value=a.fecha||'';
  document.getElementById('ag-hora').value=a.hora||'';
  document.getElementById('ag-tipo').value=a.tipo||'Reuni√≥n';
  document.getElementById('ag-prioridad').value=a.prioridad||'normal';
  document.getElementById('ag-notas').value=a.notas||'';
  document.getElementById('ag-notif').checked=a.notificacion!==false;
  if(document.getElementById('ag-proyecto')) document.getElementById('ag-proyecto').value=a.proyecto_id||'';
  openModal('m-agenda');
}

async function saveAgenda(){
  const desc = document.getElementById('ag-desc').value.trim();
  if(!desc){ toast('La descripci√≥n es obligatoria','error'); return; }
  const fecha = document.getElementById('ag-fecha').value;
  if(!fecha){ toast('La fecha es obligatoria','error'); return; }
  const id = document.getElementById('ag-id').value;
  const hora = document.getElementById('ag-hora').value||null;
  const tipo = document.getElementById('ag-tipo').value;
  const prioridad = document.getElementById('ag-prioridad').value;
  const proyecto_id = document.getElementById('ag-proyecto')?.value||null;
  const notas = document.getElementById('ag-notas').value||null;
  const notificacion = document.getElementById('ag-notif').checked;

  const d = { descripcion:desc, fecha, hora, tipo, prioridad, proyecto_id, notas, notificacion, estado:'Pendiente' };

  try{
    if(id){
      await sb('agenda','PATCH',d,null,`?id=eq.${id}`);
      toast('Aviso actualizado ‚úÖ');
    } else {
      await sbPost('agenda',d);
      toast('Aviso guardado ‚úÖ');
    }
    closeModal('m-agenda');
    await loadAgenda();
    solicitarPermisosNotificacion();

    // ‚îÄ‚îÄ Crear evento en Google Calendar autom√°ticamente si tiene notificaci√≥n ‚îÄ‚îÄ
    if(notificacion){
      try{
        await crearEventoGoogleCalendar({desc, fecha, hora, tipo, prioridad, proyecto_id, notas});
      }catch(e){
        console.warn('Google Calendar no disponible:', e.message);
        // No bloquear ‚Äî el aviso ya est√° guardado en la app
      }
    }
  }catch(e){ toast('Error: '+e.message,'error'); }
}

function _fmtICS(d){ return d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}/,''); }

function generarICS({desc, fecha, hora, tipo, prioridad, proyecto_id, notas}){
  // Genera fichero .ics ‚Äî iOS lo abre en Calendario nativo con alarma incluida
  const titulo = '[PAU] ' + (tipo||'Aviso') + ': ' + desc + (proyecto_id?' - '+proyecto_id:'');
  const detalle = ['Tipo: '+(tipo||'-'), 'Prioridad: '+(prioridad||'-'),
    proyecto_id?'Proyecto: '+proyecto_id:'', notas?'Notas: '+notas:'',
    'PAU INTERIORISMO S.L.'].filter(Boolean).join('\n');
  let dtStart, dtEnd, allDay = false;
  if(hora){
    const start = new Date(fecha + 'T' + hora + ':00');
    const end   = new Date(start.getTime() + 60*60*1000);
    dtStart = 'DTSTART;TZID=Europe/Madrid:' + _fmtICS(start).replace('Z','');
    dtEnd   = 'DTEND;TZID=Europe/Madrid:'   + _fmtICS(end).replace('Z','');
  } else {
    allDay  = true;
    const d = fecha.replace(/-/g,'');
    const nd = new Date(fecha); nd.setDate(nd.getDate()+1);
    dtStart = 'DTSTART;VALUE=DATE:' + d;
    dtEnd   = 'DTEND;VALUE=DATE:'   + nd.toISOString().split('T')[0].replace(/-/g,'');
  }
  const uid = 'pau-' + Date.now() + '@pauinteriorismo.es';
  const now = _fmtICS(new Date());
  const ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//PAU INTERIORISMO S.L.//ES',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    uid ? 'UID:' + uid : '',
    'DTSTAMP:' + now,
    dtStart, dtEnd,
    'SUMMARY:' + titulo,
    'DESCRIPTION:' + detalle.replace(/\n/g,'\\n'),
    'BEGIN:VALARM',
    'ACTION:DISPLAY',
    'DESCRIPTION:Recordatorio PAU',
    allDay ? 'TRIGGER:-PT9H' : 'TRIGGER:-PT15M',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].filter(Boolean).join('\r\n');
  return ics;
}

function descargarICS(evento){
  const ics = generarICS(evento);
  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'evento-pau.ics';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
}

function abrirModalICS(evento){
  // Eliminar overlay anterior si existe
  const prev = document.getElementById('ics-overlay');
  if(prev) prev.remove();

  const overlay = document.createElement('div');
  overlay.id = 'ics-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px';

  const box = document.createElement('div');
  box.style.cssText = 'background:white;border-radius:16px;padding:24px 20px;max-width:360px;width:100%;text-align:center;box-shadow:0 16px 48px rgba(0,0,0,.35)';

  box.innerHTML = ''
    + '<div style="font-size:40px;margin-bottom:6px">&#128197;</div>'
    + '<div style="font-size:16px;font-weight:800;color:#1a2a3a;margin-bottom:4px">A&ntilde;adir al Calendario del iPhone</div>'
    + '<div style="font-size:12px;color:#888;margin-bottom:16px">El aviso se activa solo &mdash; sin pasos extra</div>'

    + '<div style="background:#e8f4ff;border-radius:10px;padding:12px 14px;text-align:left;margin-bottom:10px">'
    + '<div style="font-weight:800;font-size:12px;color:#1a73e8;margin-bottom:6px">&#128242; C&oacute;mo funciona</div>'
    + '<div style="font-size:11px;color:#333;line-height:1.8">'
    + '<b>1.</b> Pulsa el bot&oacute;n verde<br>'
    + '<b>2.</b> iOS abre el archivo en <b>Calendario</b><br>'
    + '<b>3.</b> Pulsa <b>"A&ntilde;adir"</b> o <b>"Aceptar"</b><br>'
    + '<b>4.</b> Listo &mdash; recibir&aacute;s la notificaci&oacute;n autom&aacute;ticamente &#9989;'
    + '</div>'
    + '</div>'

    + '<div style="background:#fff8e1;border-radius:10px;padding:10px 14px;text-align:left;margin-bottom:16px">'
    + '<div style="font-size:11px;color:#7a5c00;line-height:1.6">'
    + '&#9888;&#65039; <b>Descarga desde el iPhone o iPad</b> para que iOS lo abra en Calendario.<br>'
    + 'En PC se guarda el archivo pero no avisa en m&oacute;vil.'
    + '</div>'
    + '</div>';

  // Bot√≥n descargar ICS
  const btnICS = document.createElement('button');
  btnICS.innerHTML = '&#128229; Descargar evento (.ics)';
  btnICS.style.cssText = 'display:block;width:100%;background:#0fa860;color:white;padding:13px 20px;border-radius:9px;border:none;font-weight:800;font-size:15px;margin-bottom:10px;cursor:pointer;box-shadow:0 2px 8px rgba(15,168,96,.4)';
  btnICS.onclick = () => { descargarICS(evento); overlay.remove(); };
  box.appendChild(btnICS);

  const btnClose = document.createElement('button');
  btnClose.textContent = 'Cancelar';
  btnClose.style.cssText = 'background:none;border:1px solid #ddd;padding:9px 20px;border-radius:7px;cursor:pointer;font-size:13px;color:#888;width:100%';
  btnClose.onclick = () => overlay.remove();
  box.appendChild(btnClose);

  overlay.appendChild(box);
  overlay.addEventListener('click', e => { if(e.target === overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}


async function crearEventoGoogleCalendar({desc, fecha, hora, tipo, prioridad, proyecto_id, notas}){
  abrirModalICS({desc, fecha, hora, tipo, prioridad, proyecto_id, notas});
}


async function completarAgenda(id){
  try{
    await sb('agenda','PATCH',{estado:'Completado'},null,`?id=eq.${id}`);
    toast('‚úÖ Marcado como completado');
    await loadAgenda();
  }catch(e){ toast('Error: '+e.message,'error'); }
}

function actualizarBadgeAgenda(){
  const hoy = new Date().toISOString().split('T')[0];
  const pendHoy = AgC.filter(a => a.estado !== 'Completado' && a.fecha <= hoy).length;
  const badge = document.getElementById('agenda-badge');
  if(badge){
    badge.textContent = pendHoy;
    badge.style.display = pendHoy > 0 ? '' : 'none';
  }
}

// ‚îÄ‚îÄ NOTIFICACIONES ‚îÄ‚îÄ
function solicitarPermisosNotificacion(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default'){
    // Necesitamos un gesto del usuario en m√≥vil ‚Äî pedimos al hacer click en cualquier sitio
    Notification.requestPermission().then(p=>{
      if(p==='granted') toast('‚úÖ Notificaciones activadas','success');
    });
  }
}

// Bot√≥n visible para activar notificaciones si est√°n denegadas/pendientes
function mostrarBotonNotif(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'granted') return;
  const btn = document.createElement('button');
  btn.className = 'btn btn-amber btn-sm';
  btn.style.cssText='position:fixed;bottom:16px;right:16px;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.2)';
  btn.textContent = 'üîî Activar notificaciones';
  btn.onclick = ()=>{
    Notification.requestPermission().then(p=>{
      if(p==='granted'){ toast('‚úÖ Notificaciones activadas'); btn.remove(); }
      else toast('Notificaciones bloqueadas en el navegador','error');
    });
  };
  document.body.appendChild(btn);
}

function reproducirSonidoAviso(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [0, 0.3, 0.6].forEach((t, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = i===0?880:i===1?1046:1318;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.4, ctx.currentTime+t);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+t+0.25);
      osc.start(ctx.currentTime+t);
      osc.stop(ctx.currentTime+t+0.3);
    });
  }catch(e){ console.warn('Audio no disponible'); }
  // Vibraci√≥n en m√≥vil
  if('vibrate' in navigator) navigator.vibrate([200,100,200]);
}

function lanzarNotificacion(aviso){
  reproducirSonidoAviso();
  // Toast siempre visible (independiente de permisos)
  toast(`üîî ${aviso.tipo||'Aviso'}: ${aviso.descripcion}`, 'success');
  if('Notification' in window && Notification.permission === 'granted'){
    try{
      const n = new Notification(`üîî ${aviso.tipo||'Aviso'}: ${aviso.descripcion}`, {
        body: `${aviso.hora||''} ${aviso.proyecto_id?'¬∑ Proyecto: '+aviso.proyecto_id:''}`,
        icon: '/favicon.ico',
        badge: '/favicon.ico',
        tag: 'agenda-'+aviso.id,
        requireInteraction: true,
        silent: false,
      });
      n.onclick = ()=>{ window.focus(); navTo('agenda'); n.close(); };
    }catch(e){ console.warn('Notification error:', e); }
  }
}

const _notificadosIds = new Set(); // IDs ya notificados esta sesi√≥n

function iniciarCheckerAgenda(){
  if(agendaTimer) clearInterval(agendaTimer);

  const checkear = async () => {
    const ahora = new Date();
    const hoy = ahora.toISOString().split('T')[0];
    const hh = ahora.getHours();
    const mm = ahora.getMinutes();

    // Recargar BD cada 2 min
    if(mm % 2 === 0 && ahora.getSeconds() < 35){
      try{ AgC = await sbGet('agenda','?order=fecha.asc'); actualizarBadgeAgenda(); }catch(e){}
    }

    // Buscar avisos ‚Äî ventana de ¬±4 minutos para no perder el tick
    AgC.filter(a => {
      if(a.estado === 'Completado') return false;
      if(a.notificacion === false) return false;
      if(!a.hora) return false;
      if(a.fecha !== hoy) return false;
      if(_notificadosIds.has(a.id)) return false; // ya avisado
      // Comparar hora con ventana de ¬±4 min
      const [ah, am] = a.hora.split(':').map(Number);
      const minAviso = ah*60 + am;
      const minActual = hh*60 + mm;
      return minActual >= minAviso && minActual <= minAviso + 4;
    }).forEach(a => {
      _notificadosIds.add(a.id); // marcar para no repetir
      lanzarNotificacion(a);
    });
  };

  // Primer check inmediato
  checkear();
  // Luego cada 60 segundos (antes era 30s pero no comprobaba _notificado)
  agendaTimer = setInterval(checkear, 60000);

  // Reactivar checker si la p√°gina vuelve a ser visible (m√≥vil)
  document.addEventListener('visibilitychange', ()=>{
    if(!document.hidden) checkear();
  });
}

// Sobrescribir openModal para agenda
const _origOpenModal = openModal;
// Patch para agenda-badge al abrir modal
document.addEventListener('DOMContentLoaded', ()=>{
  solicitarPermisosNotificacion();
  setTimeout(mostrarBotonNotif, 2000); // mostrar bot√≥n si no hay permisos
  iniciarCheckerAgenda();
});

// ‚ïê‚ïê‚ïê PWA SERVICE WORKER ‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  });
}
</script>

<!-- ‚ïê‚ïê‚ïê MODAL IMPORTAR HOLDED ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="m-importar-holded">
<div class="modal" style="width:780px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">üì§ Importar facturas de compra desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-importar-holded')">√ó</button>
  </div>
  <div class="modal-body">

    <!-- INSTRUCCIONES -->
    <div class="info-box" style="margin-bottom:14px">
      <strong>¬øC√≥mo exportar desde Holded?</strong><br>
      1. Ve a <strong>Gastos ‚Üí Facturas de compra</strong><br>
      2. Filtra por el periodo que quieras importar<br>
      3. Pulsa el <strong>icono ‚¨á Exportar</strong> (arriba derecha) ‚Üí <strong>Excel o CSV</strong><br>
      4. Sube el archivo aqu√≠ abajo
    </div>

    <!-- UPLOAD -->
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
        <input type="file" id="holded-file" accept=".xlsx,.xls,.csv" class="form-input"
          onchange="procesarArchivoHolded()" style="padding:6px">
      </div>
      <div style="flex:1;min-width:200px">
        <label class="form-label">Asignar a proyecto <span style="font-size:10px;color:var(--text-soft)">(opcional ‚Äî puedes cambiar por factura)</span></label>
        <select class="form-input" id="holded-proyecto-default">
          <option value="">‚Äî Sin proyecto por defecto ‚Äî</option>
        </select>
      </div>
    </div>

    <!-- PREVIEW TABLE -->
    <div id="holded-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="holded-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca las que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:320px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="holded-chk-all" onchange="toggleAllHolded(this.checked)" checked style="width:15px;height:15px"></th>
          <th>N¬∫ Factura</th><th>Fecha</th><th>Proveedor</th>
          <th>Concepto</th><th>Base imp.</th><th>IVA</th><th>Total</th>
          <th>Vencimiento</th><th>Estado</th><th>Proyecto</th>
        </tr></thead>
        <tbody id="holded-tbody"></tbody>
      </table></div>

      <!-- ALERTAS -->
      <div id="holded-alertas" style="margin-top:10px"></div>
    </div>

  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-importar-holded')">Cancelar</button>
    <button class="btn btn-primary" id="btn-importar-holded" style="display:none"
      onclick="ejecutarImportHolded()">üì• Importar facturas seleccionadas</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL TRABAJADOR ‚ïê‚ïê‚ïê -->
<div class="overlay" id="m-trabajador">
<div class="modal" style="width:620px">
  <div class="modal-head">
    <div class="modal-title" id="m-trab-title">üë§ Nuevo trabajador</div>
    <button class="modal-close" onclick="closeModal('m-trabajador')">√ó</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="trab-id">
    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)">DATOS PERSONALES</div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Nombre completo *</label>
        <input class="form-input" id="trab-nombre" placeholder="Nombre Apellidos">
      </div>
      <div class="form-group">
        <label class="form-label">DNI / NIE</label>
        <input class="form-input" id="trab-dni" placeholder="12345678A">
      </div>
      <div class="form-group">
        <label class="form-label">Tel√©fono</label>
        <input class="form-input" id="trab-tel" placeholder="600 000 000">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="trab-email" type="email" placeholder="trabajador@email.com">
      </div>
      <div class="form-group fg-full">
        <label class="form-label">Direcci√≥n</label>
        <input class="form-input" id="trab-dir" placeholder="Calle, n√∫mero, ciudad‚Ä¶">
      </div>
      <div class="form-group">
        <label class="form-label">N¬∫ Seg. Social</label>
        <input class="form-input" id="trab-nss" placeholder="000000000000">
      </div>
      <div class="form-group">
        <label class="form-label">IBAN</label>
        <input class="form-input" id="trab-iban" placeholder="ES00 0000 0000 0000 0000 0000">
      </div>
    </div>

    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin:14px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">DATOS LABORALES</div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Categor√≠a profesional</label>
        <select class="form-input" id="trab-categoria">
          <option>Oficial 1¬™</option><option>Oficial 2¬™</option><option>Oficial 3¬™</option>
          <option>Pe√≥n especialista</option><option>Pe√≥n ordinario</option>
          <option>Administrativo</option><option>T√©cnico</option><option>Jefe de obra</option><option>Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Tipo contrato</label>
        <select class="form-input" id="trab-contrato">
          <option>Indefinido</option><option>Temporal</option><option>Obra y servicio</option>
          <option>Pr√°cticas</option><option>Parcial</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Fecha de alta</label>
        <input class="form-input" type="date" id="trab-alta">
      </div>
      <div class="form-group">
        <label class="form-label">Estado</label>
        <select class="form-input" id="trab-estado">
          <option>Activo</option><option>Baja temporal</option><option>Baja definitiva</option>
        </select>
      </div>
    </div>

    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin:14px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">N√ìMINA MENSUAL</div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Salario bruto / mes ‚Ç¨</label>
        <input class="form-input" type="number" id="trab-bruto" step="0.01" placeholder="2000.00" oninput="calcNomina()">
      </div>
      <div class="form-group">
        <label class="form-label">IRPF % (retenci√≥n)</label>
        <input class="form-input" type="number" id="trab-irpf" step="0.1" placeholder="15" value="15" oninput="calcNomina()">
      </div>
      <div class="form-group">
        <label class="form-label">SS trabajador % </label>
        <input class="form-input" type="number" id="trab-ss-trab" step="0.1" placeholder="6.35" value="6.35" oninput="calcNomina()">
      </div>
      <div class="form-group">
        <label class="form-label">SS empresa %</label>
        <input class="form-input" type="number" id="trab-ss-emp" step="0.1" placeholder="30" value="30" oninput="calcNomina()">
      </div>
    </div>

    <!-- Resumen c√°lculo n√≥mina -->
    <div style="background:var(--blue-light);border-radius:8px;padding:12px;margin-top:8px">
      <div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:8px">üìã Resumen n√≥mina calculado</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">Bruto/mes</div>
          <div style="font-weight:700;font-size:14px" id="trab-calc-bruto">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">Neto/mes</div>
          <div style="font-weight:700;font-size:14px;color:var(--green)" id="trab-calc-neto">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">SS empresa/mes</div>
          <div style="font-weight:700;font-size:14px;color:var(--amber)" id="trab-calc-ss-emp">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">Coste empresa/mes</div>
          <div style="font-weight:700;font-size:16px;color:var(--red)" id="trab-calc-total">‚Äî</div>
        </div>
      </div>
    </div>

    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin:14px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">üéÅ PAGA EXTRA</div>
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Importe paga extra ‚Ç¨</label>
        <input class="form-input" type="number" id="trab-paga-extra" step="0.01" placeholder="0.00" oninput="calcNomina()">
      </div>
      <div class="form-group">
        <label class="form-label">N¬∫ pagas extras / a√±o</label>
        <select class="form-input" id="trab-num-pagas" onchange="calcNomina()">
          <option value="0">Sin paga extra</option>
          <option value="1">1 paga extra</option>
          <option value="2" selected>2 pagas extras (verano + navidad)</option>
          <option value="3">3 pagas extras</option>
          <option value="4">4 pagas extras</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">IRPF paga extra %</label>
        <input class="form-input" type="number" id="trab-paga-irpf" step="0.1" placeholder="15" value="15" oninput="calcNomina()">
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end">
        <div style="background:var(--green-soft);border-radius:6px;padding:8px 12px;width:100%">
          <div style="font-size:10px;color:var(--text-soft)">Neto paga extra</div>
          <div style="font-weight:700;font-size:14px;color:var(--green)" id="trab-calc-paga-neto">‚Äî</div>
        </div>
      </div>
    </div>

    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin:14px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">‚≠ê COMPENSACI√ìN POR ACTITUD / BONUS</div>

    <!-- Selector modo -->
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button type="button" id="btn-modo-recurrente" class="btn btn-primary btn-sm" onclick="setModoBonus('recurrente')" style="font-size:11px">üîÅ Recurrente</button>
      <button type="button" id="btn-modo-puntual" class="btn btn-ghost btn-sm" onclick="setModoBonus('puntual')" style="font-size:11px">üìÖ Pagos puntuales</button>
    </div>

    <!-- MODO RECURRENTE -->
    <div id="bonus-modo-recurrente">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Importe compensaci√≥n ‚Ç¨</label>
          <input class="form-input" type="number" id="trab-bonus" step="0.01" placeholder="0.00" oninput="calcNomina()">
        </div>
        <div class="form-group">
          <label class="form-label">Periodicidad</label>
          <select class="form-input" id="trab-bonus-periodo" onchange="calcNomina()">
            <option value="mensual">Mensual (√ó12/a√±o)</option>
            <option value="trimestral">Trimestral (√ó4/a√±o)</option>
            <option value="anual">Anual (√ó1/a√±o)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">IVA compensaci√≥n</label>
          <select class="form-input" id="trab-bonus-iva" onchange="calcNomina()">
            <option value="0">Exento de IVA</option>
            <option value="21">21% IVA</option>
            <option value="10">10% IVA</option>
          </select>
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end">
          <div style="background:var(--amber-soft);border-radius:6px;padding:8px 12px;width:100%">
            <div style="font-size:10px;color:var(--text-soft)">Total compensaci√≥n c/IVA / a√±o</div>
            <div style="font-weight:700;font-size:14px;color:var(--copper)" id="trab-calc-bonus">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODO PAGOS PUNTUALES -->
    <div id="bonus-modo-puntual" style="display:none">
      <div style="background:var(--bg-alt);border-radius:8px;padding:10px;margin-bottom:8px">
        <div style="display:grid;grid-template-columns:2fr 1.2fr 1fr 1fr auto;gap:6px;align-items:end;margin-bottom:6px">
          <div>
            <label class="form-label" style="font-size:10px">Concepto</label>
            <input class="form-input" id="bp-concepto" placeholder="Ej: Bonus verano, Navidad‚Ä¶" style="font-size:12px">
          </div>
          <div>
            <label class="form-label" style="font-size:10px">Fecha pago</label>
            <input class="form-input" type="date" id="bp-fecha" style="font-size:12px">
          </div>
          <div>
            <label class="form-label" style="font-size:10px">Importe ‚Ç¨</label>
            <input class="form-input" type="number" id="bp-importe" step="0.01" placeholder="0.00" style="font-size:12px">
          </div>
          <div>
            <label class="form-label" style="font-size:10px">IVA</label>
            <select class="form-input" id="bp-iva" style="font-size:12px">
              <option value="0">Exento</option>
              <option value="21">21%</option>
              <option value="10">10%</option>
            </select>
          </div>
          <button type="button" class="btn btn-primary btn-sm" onclick="addBonusPago()" style="padding:6px 12px;font-size:12px">Ôºã</button>
        </div>
        <!-- Lista de pagos puntuales -->
        <div id="bp-lista" style="font-size:12px"></div>
      </div>
      <div style="background:var(--amber-soft);border-radius:6px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--text-soft)">Total compensaciones puntuales c/IVA:</span>
        <span style="font-weight:700;font-size:15px;color:var(--copper)" id="trab-calc-bonus-puntual">‚Äî</span>
      </div>
    </div>

    <!-- Resumen total anual -->
    <div style="background:#f0faf4;border:1px solid #c3e6cb;border-radius:8px;padding:12px;margin-top:10px">
      <div style="font-size:11px;font-weight:700;color:var(--green);margin-bottom:8px">üí∂ COSTE TOTAL EMPRESA / A√ëO</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">N√≥minas (12 meses)</div>
          <div style="font-weight:700;font-size:13px" id="trab-calc-anual-nom">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">Pagas extras</div>
          <div style="font-weight:700;font-size:13px" id="trab-calc-anual-pagas">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">Bonus / Compensaciones</div>
          <div style="font-weight:700;font-size:13px;color:var(--copper)" id="trab-calc-anual-bonus">‚Äî</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--text-soft)">COSTE ANUAL TOTAL</div>
          <div style="font-weight:700;font-size:16px;color:var(--red)" id="trab-calc-anual-total">‚Äî</div>
        </div>
      </div>
    </div>

    <div style="font-size:11px;font-weight:700;color:var(--text-soft);text-transform:uppercase;margin:14px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)">NOTAS</div>
    <textarea class="form-input" id="trab-notas" rows="2" placeholder="Observaciones, condiciones especiales‚Ä¶"></textarea>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-trabajador')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveTrabajador()">üíæ Guardar</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL AGENDA ‚ïê‚ïê‚ïê -->
<div class="overlay" id="m-agenda">
<div class="modal" style="width:540px">
  <div class="modal-head">
    <div class="modal-title">üîî Nuevo aviso / Cita</div>
    <button class="modal-close" onclick="closeModal('m-agenda')">√ó</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="ag-id">
    <div class="form-grid">
      <div class="form-group fg-full">
        <label class="form-label">Descripci√≥n *</label>
        <input class="form-input" id="ag-desc" placeholder="Ej: Reuni√≥n con cliente ¬∑ Visita obra ¬∑ Llamada‚Ä¶">
      </div>
      <div class="form-group">
        <label class="form-label">Fecha *</label>
        <input class="form-input" type="date" id="ag-fecha">
      </div>
      <div class="form-group">
        <label class="form-label">Hora aviso</label>
        <input class="form-input" type="time" id="ag-hora" placeholder="HH:MM">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo</label>
        <select class="form-input" id="ag-tipo">
          <option>Reuni√≥n</option>
          <option>Visita obra</option>
          <option>Llamada</option>
          <option>Entrega</option>
          <option>Pago</option>
          <option>Recordatorio</option>
          <option>Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Prioridad</label>
        <select class="form-input" id="ag-prioridad">
          <option value="normal">Normal</option>
          <option value="alta">Alta üî¥</option>
          <option value="baja">Baja</option>
        </select>
      </div>
      <div class="form-group fg-full">
        <label class="form-label">Proyecto (opcional)</label>
        <select class="form-input" id="ag-proyecto">
          <option value="">‚Äî Sin proyecto ‚Äî</option>
        </select>
      </div>
      <div class="form-group fg-full">
        <label class="form-label">Notas</label>
        <textarea class="form-input" id="ag-notas" rows="2" placeholder="Detalles adicionales‚Ä¶"></textarea>
      </div>
      <div class="form-group fg-full">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text-mid)">
          <input type="checkbox" id="ag-notif" checked style="width:16px;height:16px">
          üîî Activar notificaci√≥n cuando llegue la hora
        </label>
        <div style="font-size:11px;color:var(--text-soft);margin-top:4px">
          El navegador/m√≥vil emitir√° un aviso sonoro en la hora indicada. Debes mantener la app abierta o en segundo plano.
        </div>
      </div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-agenda')">Cancelar</button>
    <button class="btn btn-primary" onclick="saveAgenda()">üíæ Guardar aviso</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL IMPORTAR CLIENTES HOLDED ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="m-import-clientes">
<div class="modal" style="width:820px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">üë§ Importar clientes desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-import-clientes')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="info-box" style="margin-bottom:14px">
      <strong>¬øC√≥mo exportar desde Holded?</strong><br>
      Ve a <strong>Contactos ‚Üí Clientes</strong> ¬∑ Pulsa <strong>‚¨á Exportar ‚Üí Excel o CSV</strong>
    </div>
    <div style="margin-bottom:14px">
      <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
      <input type="file" id="cli-holded-file" accept=".xlsx,.xls,.csv" class="form-input"
        onchange="procesarImportClientes()" style="padding:6px">
    </div>
    <div id="cli-import-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="cli-import-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca los que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:340px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="cli-chk-all" onchange="toggleAll('cli-chk',this.checked)" checked style="width:15px;height:15px"></th>
          <th>Nombre</th><th>CIF/NIF</th><th>Tel√©fono</th><th>Email</th><th>Direcci√≥n</th><th>Forma pago</th><th>Estado</th>
        </tr></thead>
        <tbody id="cli-import-tbody"></tbody>
      </table></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeModal('m-import-clientes')">Cancelar</button>
    <button class="btn btn-primary" id="btn-import-clientes" style="display:none"
      onclick="ejecutarImportClientes()">üë§ Importar clientes seleccionados</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL IMPORTAR PROVEEDORES HOLDED ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="m-import-proveedores">
<div class="modal" style="width:820px;max-width:96vw">
  <div class="modal-head">
    <div class="modal-title">üè≠ Importar proveedores desde Holded</div>
    <button class="modal-close" onclick="closeModal('m-import-proveedores')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="info-box" style="margin-bottom:14px">
      <strong>¬øC√≥mo exportar desde Holded?</strong><br>
      Ve a <strong>Contactos ‚Üí Proveedores</strong> ¬∑ Pulsa <strong>‚¨á Exportar ‚Üí Excel o CSV</strong>
    </div>
    <div style="margin-bottom:14px">
      <label class="form-label">Archivo exportado de Holded (.xlsx o .csv)</label>
      <input type="file" id="prov-holded-file" accept=".xlsx,.xls,.csv" class="form-input"
        onchange="procesarImportProveedores()" style="padding:6px">
    </div>
    <div id="prov-import-preview" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div id="prov-import-resumen" style="font-size:13px;font-weight:600;color:var(--navy)"></div>
        <div style="font-size:11px;color:var(--text-soft)">Desmarca los que no quieras importar</div>
      </div>
      <div class="table-wrap" style="max-height:340px;overflow-y:auto"><table>
        <thead><tr>
          <th><input type="checkbox" id="prov-chk-all" onchange="toggleAll('prov-chk',this.checked)" checked style="width:15px;height:15px"></th>
          <th>Nombre</th><th>CIF/NIF</th><th>Tel√©fono</th><th>Email</th><th>Especialidad</th><th>Forma
